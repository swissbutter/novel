<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ê° ìŠ¤íŠœë””ì˜¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#09090b',
                        darkpanel: '#18181b',
                        darkborder: '#27272a',
                    }
                }
            }
        }
    </script>
    <style>
        /* í°íŠ¸ ì •ì˜ ëª©ë¡ */
        @font-face {
            font-family: 'MaruBuri';
            src: url(https://hangeul.pstatic.net/hangeul_static/webfont/MaruBuri/MaruBuri-Regular.woff2);
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'Ridibatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Galmuri14';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2506-1@1.0/Galmuri14.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-display: swap;
        }

        /* í°íŠ¸ í´ë˜ìŠ¤ ê°•ì œ ì ìš© */
        body.font-maruburi, body.font-maruburi * { font-family: 'MaruBuri', serif !important; }
        body.font-Ridibatang, body.font-Ridibatang * { font-family: 'Ridibatang', sans-serif !important; }
        body.font-Galmuri14, body.font-Galmuri14 * { font-family: 'Galmuri14', serif !important; }
        body.font-pretendard, body.font-pretendard * { font-family: 'Pretendard', sans-serif !important; }

        body { background: #f1f5f9; overflow: hidden; user-select: none; transition: background-color 0.3s, color 0.3s; }
        .dark body { background: #242464; color: #e4e4e7; }
        .grid-background { background-color: #f8fafc; background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .dark .grid-background { background-color: #09090b; background-image: linear-gradient(#141416 1px, transparent 1px), linear-gradient(90deg, #141416 1px, transparent 1px); }
        .dot-background { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 1px, transparent 0) !important; background-size: 20px 20px !important; background-position: 0 0; }
        .dark .dot-background { background-color: #09090b; background-image: radial-gradient(#27272a 1px, transparent 0) !important; }
        .canvas-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        .edge-path { fill: none; transition: stroke 0.2s; stroke-linecap: round; stroke-linejoin: round; }
        .edge-hitbox { fill: none; stroke: transparent; stroke-width: 20; cursor: pointer; pointer-events: stroke; }
        .node-glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid #cbd5e1; border-radius: 3px; box-sizing: border-box; }
        .dark .node-glass { background: rgba(39, 39, 42, 0.95); border: 1px solid #52525b; color: #e4e4e7; }
        .node-postit { background-color: #fef9c3; border-radius: 3px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border: 1px solid #fde047; }
        .dark .node-postit { background-color: #4e4932; border: 1px solid #6b654b; color: #e2dfc7; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .zoom-container { transform-origin: 0 0; will-change: transform; transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1); }
        .is-dragging .zoom-container { transition: none; }
        .node-protagonist { outline: 8px solid rgba(37, 99, 235, 0.2); background: #d7e7fc; }
        .dark .node-protagonist { outline: 8px solid rgba(37, 99, 235, 0.2); background: #172554; }
        .node-antagonist { border: 1px solid #c88885; background: #fbdfde; }
        .dark .node-antagonist { border: 1px solid #7f1d1d; background: #450a0a; }
        .node-helper { border: 1px solid #7dcb97; background: #d0f7e2; }
        .dark .node-helper { border: 1px solid #059669; background: #064e3b; }
        .node-event { outline: 4px solid rgba(255, 3, 3, 0.3); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; transition: background 0.2s; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; }
        .dark .custom-scroll:hover::-webkit-scrollbar-thumb { background: #52525b; }
        .editor-paper { max-width: 585px; margin: 40px auto; background: white; min-height: calc(100vh - 80px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); border-radius: 3px; display: flex; flex-direction: column; position: relative; overflow: hidden; transition: background-color 0.3s, max-width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .editor-paper { background: #18181b; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); border: 1px solid #27272a; }
        .editor-title-container { padding: 40px 60px 10px 60px; }
        .editor-textarea { width: 100%; flex: 1; resize: none; outline: none; line-height: 2.2; font-size: 18px; color: #334155; background: transparent; border: none; padding: 20px 60px 60px 60px; }
        .dark .editor-textarea { color: #d4d4d8; }
        .book-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform-style: preserve-3d; }
        .book-spine { background: linear-gradient(90deg, transparent 0%, transparent 20%, rgba(0,0,0,0.1) 100%); }
        .page-bg { background-color: #fdfbf7; background-image: repeating-linear-gradient(transparent, transparent 19px, #e5e7eb 20px); }
        .mention-list { position: fixed; z-index: 1000; background: white; border: 1px solid #e2e8f0; border-radius: 3px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); max-height: 400px; overflow: visible; display: flex; width: 600px; }
        .dark .mention-list { background: #18181b; border-color: #27272a; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .mention-item-active { background-color: #f1f5f9; border-left: 4px solid #4f46e5; }
        .dark .mention-item-active { background-color: #27272a; border-left: 4px solid #6366f1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useMemo, useEffect, memo } = React;
        const { motion, AnimatePresence, Reorder } = window.Motion;

        const CARD_W = 250; 
        const CARD_H = 200;
        const BOOK_COLORS = ['#18181b', '#3c3c3c', '#881337', '#7c2d12', '#424034', '#73734e', '#2e3b36', '#134e4a', '#1e3a8a', '#33272c', '#4c1d95', '#451a03'];

        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        // Icons
        const IconPlus = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
        const IconTrash = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>);
        const IconSettings = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const IconBack = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const IconUpload = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>);
        const IconSave = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>);
        const IconSun = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>);
        const IconMoon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>);
        const IconZen = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/></svg>);
        const IconFont = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>);
        const IconLayout = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /><line x1="10" x2="14" y1="6.5" y2="6.5" /><line x1="10" x2="14" y1="17.5" y2="17.5" /><line x1="6.5" x2="6.5" y1="10" y2="14" /><line x1="17.5" x2="17.5" y1="10" y2="14" /></svg>);

        // Utility
        const getCaretCoordinates = (element, position) => { const div = document.createElement('div'); const style = window.getComputedStyle(element); const props = ['fontFamily', 'fontSize', 'fontWeight', 'lineHeight', 'padding', 'border', 'width', 'boxSizing', 'whiteSpace', 'wordWrap']; props.forEach(prop => div.style[prop] = style[prop]); div.style.position = 'absolute'; div.style.visibility = 'hidden'; div.textContent = element.value.substring(0, position); const span = document.createElement('span'); span.textContent = element.value.substring(position) || '.'; div.appendChild(span); document.body.appendChild(div); const rect = element.getBoundingClientRect(); const coordinates = { top: rect.top + span.offsetTop + element.scrollTop, left: rect.left + span.offsetLeft }; document.body.removeChild(div); return coordinates; };
        const getWordAtPos = (text, pos) => { if (!text) return ""; const left = text.slice(0, pos).search(/[^\s#@]*$/); const right = text.slice(pos).search(/[\s\n\r]/); const word = text.slice(left, right === -1 ? undefined : right + pos); return word.replace(/[#@]/g, '').trim(); };
        const getBezierPath = (x1, y1, x2, y2) => { const dx = x2 - x1; const dy = y2 - y1; const curvature = 0.5; const cx1 = x1 + dx * curvature; const cy1 = y1; const cx2 = x2 - dx * curvature; const cy2 = y2; return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`; };
        const getEdgeTargetPos = (from, to, offset = 12) => { const x1 = from.x + CARD_W / 2; const y1 = from.y + CARD_H / 2; const x2 = to.x + CARD_W / 2; const y2 = to.y + CARD_H / 2; const dx = x2 - x1; const dy = y2 - y1; const angle = Math.atan2(dy, dx); const absCos = Math.abs(Math.cos(angle)); const absSin = Math.abs(Math.sin(angle)); let distance = (CARD_W * absSin <= CARD_H * absCos) ? (CARD_W / 2) / absCos : (CARD_H / 2) / absSin; return { x: x2 - Math.cos(angle) * (distance + offset), y: y2 - Math.sin(angle) * (distance + offset) }; };
        const getRoleBadgeStyle = (role) => { switch(role) { case 'ì£¼ì¸ê³µ': return 'bg-blue-600 dark:bg-blue-800 text-white'; case 'ì ëŒ€ì': return 'bg-red-600 dark:bg-red-800 text-white'; case 'ì¡°ë ¥ì': return 'bg-emerald-600 dark:bg-emerald-800 text-white'; case 'ì¡°ì—°': return 'bg-slate-500 text-white'; case 'ì—‘ìŠ¤íŠ¸ë¼': return 'bg-slate-300 text-slate-600'; default: return 'bg-slate-100 text-slate-500 border border-slate-200'; } };
        const getStatusBadgeStyle = (status) => { switch(status) { case 'ì´ˆê³ ': return 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300'; case 'ìˆ˜ì •': return 'bg-amber-100 text-amber-600 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800'; case 'ì™„ë£Œ': return 'bg-emerald-600 text-white'; default: return 'bg-slate-100 text-slate-400'; } };
        const getSidebarItemAccent = (node) => { 
            if (node.type === 'ì¸ë¬¼') {
                return 'border-l-blue-500 dark:border-l-blue-600';
            } else if (node.type === 'ì‚¬ê±´') {
                return 'border-l-red-500 dark:border-l-red-600';
            } else if (node.type === 'ë©”ëª¨') {
                return 'border-l-amber-500 dark:border-l-amber-600';
            }
            return 'border-l-transparent';
        };
        const getSelectedBorderColor = (node) => {
            if (node.type === 'ì¸ë¬¼') {
                return 'border-blue-500 dark:border-blue-400';
            } else if (node.type === 'ì‚¬ê±´') {
                return 'border-red-500 dark:border-red-400';
            } else if (node.type === 'ë©”ëª¨') {
                return 'border-amber-500 dark:border-amber-400';
            }
            return 'border-indigo-500 dark:border-indigo-400';
        };
        const getStrokeDashArray = (style) => { switch(style) { case 'dashed': return "4, 8"; default: return ""; } };

        // Toast
        const Toast = ({ message, type, onClose }) => (
            <motion.div initial={{ y: 50, opacity: 0, scale: 0.9 }} animate={{ y: 0, opacity: 1, scale: 1 }} exit={{ y: 50, opacity: 0, scale: 0.9 }} className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] flex items-center gap-3 bg-zinc-800 dark:bg-zinc-100 text-white dark:text-zinc-900 px-6 py-3 Galmuri14-full shadow-2xl">
                <span className="text-sm font-bold">{message}</span>
            </motion.div>
        );

        // NodeCard
        const NodeCard = memo(({ node, isTop, isSelected, isDragging, onNodeDragStart, onMouseDown, onMouseUp, onClick, onDoubleClick, onDelete }) => {
            const isIdea = node.type === 'ë©”ëª¨';
            let styleClass = isIdea ? "node-postit" : "node-glass";
            if (node.type === 'ì¸ë¬¼') {
                if (node.data.role === 'ì£¼ì¸ê³µ') styleClass += " node-protagonist";
                else if (node.data.role === 'ì ëŒ€ì') styleClass += " node-antagonist";
                else if (node.data.role === 'ì¡°ë ¥ì') styleClass += " node-helper";
            } else if (node.type === 'ì‚¬ê±´') styleClass += " node-event";

            return (
                <div 
                    onMouseDown={(e) => { if (e.button === 0) onNodeDragStart(e, node.id); onMouseDown(e, node.id); }} 
                    onMouseUp={(e) => onMouseUp(e, node.id)} 
                    onTouchStart={(e) => { if (onTouchStart) onTouchStart(e, node.id); }} 
                    onTouchEnd={(e) => { if (onTouchEnd) onTouchEnd(e, node.id); }} 
                    onClick={(e) => { if (e.detail === 1) { e.stopPropagation(); onClick(node.id); } }} 
                    onDoubleClick={() => onDoubleClick(node.id)} 
                    style={{ zIndex: isTop ? 50 : 10, width: CARD_W, height: CARD_H, transform: `translate(${node.x}px, ${node.y}px)`, position: 'absolute', top: 0, left: 0, willChange: isDragging ? 'transform' : 'auto', touchAction: 'none' }} 
                    className={`flex flex-col cursor-grab active:cursor-grabbing shadow-lg hover:shadow-xl group relative ${styleClass} ${isSelected ? `border-2 ${getSelectedBorderColor(node)}` : ''} ${isDragging ? 'transition-none' : 'transition-all'}`}>
                    <button onClick={(e) => { e.stopPropagation(); if(confirm("ì´ ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) onDelete(node.id); }} className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 Galmuri14-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2 dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-300"><IconTrash className="w-3 h-3" /></button>
                    <div className="w-full h-full flex flex-col overflow-hidden Galmuri14-[inherit]">
                        {!isIdea && <div className={`h-1.5 w-[calc(100%+4px)] -ml-[2px] -mt-[2px] shrink-0 ${node.type === 'ì¸ë¬¼' ? 'bg-blue-600 dark:bg-blue-800' : node.type === 'ì‚¬ê±´' ? 'bg-red-600 dark:bg-red-800' : 'bg-amber-500 dark:bg-amber-700'}`} />}
                        <div className="flex-1 flex flex-col p-4 overflow-hidden pointer-events-none">
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-[10px] font-black uppercase tracking-widest ${isIdea ? 'text-yellow-800 dark:text-yellow-100' : 'text-slate-400 dark:text-zinc-500'}`}>{node.type}</span>
                                {node.type === 'ì¸ë¬¼' && <span className={`text-[9px] font-bold px-2 py-0.5 Galmuri14-[3px] ${getRoleBadgeStyle(node.data.role)}`}>{node.data.role}</span>}
                            </div>
                            <div className={`text-xl font-black truncate mb-1.5 tracking-tight flex items-center ${isIdea ? 'text-slate-950 dark:text-yellow-50' : 'text-slate-900 dark:text-white'}`}>
                                <span className="mr-2 drop-shadow-sm text-2xl">{node.data.emoji || (node.type === 'ì¸ë¬¼' ? 'ğŸ‘¤' : node.type === 'ì‚¬ê±´' ? 'ğŸ”¥' : 'ğŸ’¡')}</span>
                                <span className={`truncate ${node.type === 'ì‚¬ê±´' ? 'text-rose-700 dark:text-rose-400' : ''}`}>{node.label}</span>
                            </div>  
                            {node.type === 'ì¸ë¬¼' && <div className="text-[11px] text-slate-500 dark:text-zinc-400 font-bold mb-2">{node.data.gender} Â· {node.data.age ? `${node.data.age}ì„¸` : 'ë‚˜ì´ ë¯¸ìƒ'} Â· {node.data.job || 'ì§ì—… ì—†ìŒ'} Â· {node.data.race || 'ì¸ê°„'}</div>}
                            {node.type === 'ì‚¬ê±´' && (
                                <div className="text-[11px] text-slate-500 dark:text-zinc-400 font-bold mb-2 truncate">
                                    ğŸ“ {node.data.place || 'ì¥ì†Œ ë¯¸ìƒ'} Â· ğŸ“… {node.data.year || 'ì‹œê¸° ë¯¸ìƒ'}
                                </div>
                            )}
                            <div className={`text-[12px] font-medium leading-tight line-clamp-3 grow ${isIdea ? 'text-slate-700 dark:text-yellow-100/80' : 'text-slate-500 bg-slate-50 p-2 Galmuri14-[3px] border border-slate-100 italic dark:bg-zinc-800/50 dark:border-zinc-700 dark:text-zinc-400'}`}>{node.data.memo || "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>
                        </div>
                    </div>
                </div>
            );
        }, (prevProps, nextProps) => {
            return (
                prevProps.node.id === nextProps.node.id &&
                prevProps.node.x === nextProps.node.x &&
                prevProps.node.y === nextProps.node.y &&
                prevProps.node.label === nextProps.node.label &&
                prevProps.node.data?.emoji === nextProps.node.data?.emoji &&
                prevProps.node.data?.memo === nextProps.node.data?.memo &&
                prevProps.node.data?.role === nextProps.node.data?.role &&
                prevProps.node.data?.gender === nextProps.node.data?.gender &&
                prevProps.node.data?.age === nextProps.node.data?.age &&
                prevProps.node.data?.job === nextProps.node.data?.job &&
                prevProps.node.data?.race === nextProps.node.data?.race &&
                prevProps.node.data?.place === nextProps.node.data?.place &&
                prevProps.node.data?.year === nextProps.node.data?.year &&
                prevProps.isTop === nextProps.isTop &&
                prevProps.isSelected === nextProps.isSelected
            );
        });  // NodeCard ì»´í¬ë„ŒíŠ¸ ë

        // BookCover
        const BookCover = memo(({ book, onClick, onDelete, onEdit }) => {
            return (
                <div className="group perspective-1000 relative" style={{ perspective: '1200px' }} onClick={onClick}>
                    <div className="absolute top-[8px] bottom-[8px] left-0 w-full bg-white shadow-sm transform translate-x-[9px] z-[1] border border-slate-200 opacity-40"></div>
                    <div className="absolute top-[6px] bottom-[6px] left-0 w-full bg-white shadow-sm transform translate-x-[6px] z-[2] border border-slate-200 opacity-70"></div>
                    <div className="absolute top-[4px] bottom-[4px] left-0 w-full bg-white shadow-sm transform translate-x-[3px] z-[3] border border-slate-200 opacity-90"></div>
                    <div className="absolute top-[2px] bottom-[3px] left-[-1px] w-full page-bg shadow-sm transform translate-x-[1px] z-[4] border-l border-slate-200"></div>
                    
                    <motion.div initial={{ rotateY: 0 }} whileHover={{ rotateY: -20 }} transition={{ type: "spring", stiffness: 200, damping: 15 }} className="book-card relative Galmuri14-[3px] shadow-lg cursor-pointer flex flex-col overflow-hidden origin-left z-10 h-full" style={{ backgroundColor: book.color || '#475569', aspectRatio: '2 / 3' }}>
                        <div className="absolute inset-0 book-spine pointer-events-none z-10"></div>
                        <div className="absolute left-0 top-0 bottom-0 w-[15px] bg-black/10 z-10"></div>
                        <div className="flex-1 p-8 flex flex-col relative z-20 text-white">
                            <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-4 border-b border-white/20 pb-2">NOVEL PROJECT</div>
                            <h3 className="text-2xl font-black leading-tight tracking-tight break-keep drop-shadow-md">{book.title}</h3>
                            <div className="mt-2 text-xs opacity-70">{book.author || "ì‘ê°€ ë¯¸ìƒ"}</div>
                            <div className="mt-auto pt-4 space-y-1">
                                <div className="flex items-center gap-2 text-[11px] font-bold opacity-80">
                                    <span className="opacity-60">ë³´ë“œ</span> {book.projects?.filter(p => p.type === 'board').length || 0}
                                    <span className="mx-1 opacity-40">|</span>
                                    <span className="opacity-60">ë¬¸ì„œ</span> {book.projects?.filter(p => p.type === 'doc').length || 0}
                                </div>
                            </div>
                        </div>
                        <div className="absolute bottom-4 right-4 z-30 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(book); }} className="p-2 text-white/40 hover:text-white hover:bg-white/20 Galmuri14-[3px]" title="ìˆ˜ì •"><IconSettings className="w-4 h-4" /></button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(book.id, e); }} className="p-2 text-white/40 hover:text-white hover:bg-white/20 Galmuri14-[3px]" title="ì‚­ì œ"><IconTrash className="w-4 h-4" /></button>
                        </div>
                    </motion.div>
                </div>
            );
        });

        // BookSettingsModal
        const BookSettingsModal = ({ onClose, onConfirm, initialData }) => { 
            const [title, setTitle] = useState(initialData?.title || 'ìƒˆ ì‘í’ˆ'); 
            const [author, setAuthor] = useState(initialData?.author || ''); 
            const [selectedColor, setSelectedColor] = useState(initialData?.color || BOOK_COLORS[0]); 
            
            const handleExportToWord = async () => {
                if (!initialData) return;
                
                // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì²´í¬
                if (!window.docx || !window.JSZip || !window.saveAs) {
                    alert("í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬(docx, jszip, FileSaver)ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    const zip = new JSZip();
                    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;

                    // 1. ë³´ë“œ(Board) ë‚´ë³´ë‚´ê¸°
                    const boardProjects = initialData.projects.filter(p => p.type === 'board');
                    for (const proj of boardProjects) {
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({ text: `${proj.name} - ë³´ë“œ ë°ì´í„°`, heading: HeadingLevel.HEADING_1 }),
                                    ...proj.nodes.flatMap(node => [
                                        new Paragraph({ text: "" }),
                                        new Paragraph({ 
                                            children: [
                                                new TextRun({ text: `${node.data.emoji || 'ğŸ“'} ${node.label}`, bold: true, size: 28 }),
                                                new TextRun({ text: ` [${node.type}]`, size: 20, color: "666666" })
                                            ] 
                                        }),
                                        new Paragraph({ 
                                            text: node.type === 'ì¸ë¬¼' 
                                                ? `ì„±ë³„: ${node.data.gender} / ë‚˜ì´: ${node.data.age || 'ë¯¸ìƒ'} / ì§ì—…: ${node.data.job || 'ì—†ìŒ'}`
                                                : node.type === 'ì‚¬ê±´'
                                                ? `ì¥ì†Œ: ${node.data.place || 'ë¯¸ìƒ'} / ì‹œê¸°: ${node.data.year || 'ë¯¸ìƒ'}`
                                                : "ë©”ëª¨",
                                            italic: true 
                                        }),
                                        new Paragraph({ text: node.data.memo || "ë‚´ìš© ì—†ìŒ" }),
                                        new Paragraph({ text: "--------------------------------------------------" })
                                    ])
                                ]
                            }]
                        });
                        const blob = await Packer.toBlob(doc);
                        zip.file(`ë³´ë“œ_${proj.name.replace(/[\/\*\\\?|:<>"]/g, '_')}.docx`, blob);
                    }

                    // 2. ë¬¸ì„œ(Doc) ë‚´ë³´ë‚´ê¸°
                    const docProjects = initialData.projects.filter(p => p.type === 'doc');
                    for (const proj of docProjects) {
                        const lines = (proj.content || "").split('\n');
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({ text: proj.name, heading: HeadingLevel.HEADING_1 }),
                                    new Paragraph({ text: `ìƒíƒœ: ${proj.status || 'ì´ˆê³ '} / ê³µë°±í¬í•¨ ${proj.content?.length || 0}ì`, spacing: { after: 400 } }),
                                    ...lines.map(line => new Paragraph({ 
                                        children: [new TextRun({ text: line })],
                                        spacing: { line: 360, before: 120 } 
                                    }))
                                ]
                            }]
                        });
                        const blob = await Packer.toBlob(doc);
                        zip.file(`ì›ê³ _${proj.name.replace(/[\/\*\\\?|:<>"]/g, '_')}.docx`, blob);
                    }

                    // 3. ì••ì¶• ë° ì €ì¥
                    const content = await zip.generateAsync({ type: "blob" });
                    window.saveAs(content, `${initialData.title}_word.zip`);

                } catch (e) {
                    console.error(e);
                    alert("íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                }
            };

            const handleSubmit = () => { 
                if (!title.trim()) { alert("ì‘í’ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } 
                onConfirm(title, author, selectedColor); 
            }; 
            
            const handleKeyDown = (e) => { 
                if (e.key === 'Enter') handleSubmit(); 
                if (e.key === 'Escape') onClose(); 
            }; 
            
            return ( 
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}> 
                    <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="bg-white dark:bg-darkpanel p-8 Galmuri14-[3px] shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700" onClick={e => e.stopPropagation()}> 
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100">{initialData ? 'ì‘í’ˆ ì„¤ì • ìˆ˜ì •' : 'ìƒˆ ì‘í’ˆ ë§Œë“¤ê¸°'}</h2> 
                            {initialData && (
                                <button onClick={handleExportToWord} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 transition-colors border border-blue-200 dark:border-blue-800 rounded-sm">
                                    {/* ì›Œë“œ ì•„ì´ì½˜ SVG */}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                        <polyline points="14 2 14 8 20 8" />
                                        <path d="M8 13l1.5 4 1.5-3 1.5 3 1.5-4" />
                                    </svg>
                                    <span className="text-[10px] font-black">Word ì €ì¥</span>
                                </button>
                            )}
                        </div>
                        <div className="mb-4"> 
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì‘í’ˆ ì œëª©</label> 
                            <input autoFocus type="text" value={title} onChange={(e) => setTitle(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 Galmuri14-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ì‘í’ˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" /> 
                        </div> 
                        <div className="mb-6"> 
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì‘ê°€ ì´ë¦„ (í•„ëª…)</label> 
                            <input type="text" value={author} onChange={(e) => setAuthor(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 Galmuri14-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ì‘ê°€ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)" /> 
                        </div> 
                        <div className="mb-8"> 
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">í‘œì§€ ìƒ‰ìƒ</label> 
                            <div className="flex flex-wrap gap-2"> {BOOK_COLORS.map(color => ( <button key={color} onClick={() => setSelectedColor(color)} className={`w-8 h-8 Galmuri14-full shadow-sm transition-transform hover:scale-110 flex items-center justify-center ${selectedColor === color ? 'ring-2 ring-offset-2 ring-indigo-500 dark:ring-offset-darkpanel' : ''}`} style={{ backgroundColor: color }}> {selectedColor === color && <svg className="w-4 h-4 text-white/80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>} </button> ))} </div> 
                        </div> 
                        <div className="flex gap-2"> 
                            <button onClick={onClose} className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 Galmuri14-[3px] transition-colors">ì·¨ì†Œ</button> 
                            <button onClick={handleSubmit} className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black Galmuri14-[3px] shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">{initialData ? 'ì €ì¥í•˜ê¸°' : 'ë§Œë“¤ê¸°'}</button> 
                        </div> 
                    </motion.div> 
                </div> 
            ); 
        };

        // ExportModal ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
        const ExportModal = ({ onClose, onConfirm }) => {
            const now = new Date();
            const defaultFilename = `sagak_studio_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            
            const [filename, setFilename] = useState(defaultFilename);
            const [exportType, setExportType] = useState('json');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');

            const handleSubmit = () => {
                if (!filename.trim()) {
                    alert("íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                
                if (exportType === 'vel') {
                    if (!password) {
                        alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert("ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }
                }
                
                onConfirm(filename, exportType, password);
            };

            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div 
                        initial={{ opacity: 0, scale: 0.9 }} 
                        animate={{ opacity: 1, scale: 1 }} 
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700" 
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">íŒŒì¼ ì €ì¥</h2>

                        {/* íŒŒì¼ëª… + ì €ì¥ í˜•ì‹ (í•œ ì¤„) */}
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">íŒŒì¼ëª…</label>
                            <div className="flex gap-2">
                                <input
                                    autoFocus
                                    type="text"
                                    value={filename}
                                    onChange={(e) => setFilename(e.target.value)}
                                    className="flex-1 p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                    placeholder="íŒŒì¼ëª… ì…ë ¥"
                                />
                                <select
                                    value={exportType}
                                    onChange={(e) => setExportType(e.target.value)}
                                    className="px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors cursor-pointer"
                                >
                                    <option value="json">ì¼ë°˜ (.json)</option>
                                    <option value="vel">ì•”í˜¸í™” (.vel)</option>
                                </select>
                            </div>
                        </div>

                        {/* ì•”í˜¸ ì…ë ¥ (vel ì„ íƒ ì‹œë§Œ í‘œì‹œ) */}
                        {exportType === 'vel' && (
                            <div className="mb-6 space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ì•”í˜¸</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ì•”í˜¸ ì…ë ¥"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ì•”í˜¸ í™•ì¸</label>
                                    <input 
                                        type="password" 
                                        value={passwordConfirm} 
                                        onChange={(e) => setPasswordConfirm(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ì•”í˜¸ ì¬ì…ë ¥"
                                    />
                                </div>
                            </div>
                        )}

                        {/* ë²„íŠ¼ */}
                        <div className="flex gap-2">
                            <button 
                                onClick={onClose}
                                className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button 
                                onClick={handleSubmit}
                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                            >
                                ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // ImportModal
        const ImportModal = ({ onClose, onConfirm, fileData, isEncrypted }) => {
            const [password, setPassword] = useState('');
            const [importMode, setImportMode] = useState('replace'); // 'replace' ë˜ëŠ” 'append'
            const [step, setStep] = useState(isEncrypted ? 'password' : 'mode'); // 'password' ë˜ëŠ” 'mode'
            const [decryptedData, setDecryptedData] = useState(null);

            const handlePasswordSubmit = () => {
                if (!password.trim()) {
                    alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    const bytes = CryptoJS.AES.decrypt(fileData, password);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedText) throw new Error("Decryption failed");
                    const parsed = JSON.parse(decryptedText);
                    setDecryptedData(parsed);
                    setStep('mode');
                } catch (error) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦¬ê±°ë‚˜ ì†ìƒëœ íŒŒì¼ì…ë‹ˆë‹¤.");
                }
            };

            const handleImport = () => {
                const dataToImport = isEncrypted ? decryptedData : JSON.parse(fileData);
                onConfirm(dataToImport, importMode === 'replace');
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (step === 'password') {
                        handlePasswordSubmit();
                    } else {
                        handleImport();
                    }
                }
                if (e.key === 'Escape') onClose();
            };

            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700"
                        onClick={e => e.stopPropagation()}
                    >
                        {step === 'password' ? (
                            <>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">ì•”í˜¸í™”ëœ íŒŒì¼</h2>

                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ì•”í˜¸ ì…ë ¥</label>
                                    <input
                                        autoFocus
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyDown={handleKeyDown}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="íŒŒì¼ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                    />
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button
                                        onClick={handlePasswordSubmit}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                    >
                                        í™•ì¸
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</h2>

                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase">ë¶ˆëŸ¬ì˜¤ê¸° ë°©ì‹</label>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => setImportMode('replace')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                importMode === 'replace'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ë®ì–´ì“°ê¸°</div>
                                            <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ë¥¼ ì‚­ì œí•˜ê³  ë¶ˆëŸ¬ì˜¨ íŒŒì¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤</div>
                                        </button>
                                        <button
                                            onClick={() => setImportMode('append')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                importMode === 'append'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ì¶”ê°€í•˜ê¸°</div>
                                            <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ ë’¤ì— ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤</div>
                                        </button>
                                    </div>
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button
                                        onClick={handleImport}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                    >
                                        ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>
                                </div>
                            </>
                        )}
                    </motion.div>
                </div>
            );
        };

        // FilePanel - ë‚´ë¶€ ì°½ ë°©ì‹ì˜ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° íŒ¨ë„
        const FilePanel = ({ isOpen, mode, onClose, books, onExport, onFileSelect, importData, onConfirmImport }) => {
            const [filename, setFilename] = useState('sagak_backup');
            const [exportType, setExportType] = useState('json');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');
            const [importMode, setImportMode] = useState('replace');
            const [importPassword, setImportPassword] = useState('');
            const [decryptedData, setDecryptedData] = useState(null);
            const [importStep, setImportStep] = useState('select'); // 'select', 'password', 'mode'
            const fileInputRef = useRef(null);

            // íŒ¨ë„ì´ ì—´ë¦´ ë•Œ ìƒíƒœ ì´ˆê¸°í™”
            useEffect(() => {
                if (isOpen) {
                    if (mode === 'save') {
                        setFilename('sagak_backup');
                        setExportType('json');
                        setPassword('');
                        setPasswordConfirm('');
                    } else {
                        setImportStep('select');
                        setImportPassword('');
                        setDecryptedData(null);
                        setImportMode('replace');
                    }
                }
            }, [isOpen, mode]);

            // importDataê°€ ë³€ê²½ë˜ë©´ ì²˜ë¦¬
            useEffect(() => {
                if (importData) {
                    if (importData.isEncrypted) {
                        setImportStep('password');
                    } else {
                        setImportStep('mode');
                    }
                }
            }, [importData]);

            const handleSave = () => {
                if (!filename.trim()) {
                    alert("íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (exportType === 'vel') {
                    if (!password.trim()) {
                        alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert("ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }
                }
                onExport(filename, exportType, password);
                onClose();
            };

            const handleDecrypt = () => {
                if (!importPassword.trim()) {
                    alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                try {
                    const bytes = CryptoJS.AES.decrypt(importData.content, importPassword);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedText) throw new Error("Decryption failed");
                    const parsed = JSON.parse(decryptedText);
                    setDecryptedData(parsed);
                    setImportStep('mode');
                } catch (error) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦¬ê±°ë‚˜ ì†ìƒëœ íŒŒì¼ì…ë‹ˆë‹¤.");
                }
            };

            const handleImport = () => {
                const dataToImport = importData.isEncrypted ? decryptedData : JSON.parse(importData.content);
                onConfirmImport(dataToImport, importMode === 'replace');
                onClose();
            };

            if (!isOpen) return null;

            return (
                <motion.div
                    initial={{ x: '100%' }}
                    animate={{ x: 0 }}
                    exit={{ x: '100%' }}
                    transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                    className="fixed top-0 right-0 h-full w-[420px] bg-white dark:bg-darkpanel shadow-2xl z-[100] flex flex-col border-l border-slate-200 dark:border-zinc-700"
                >
                    {/* í—¤ë” */}
                    <div className="h-16 px-6 flex items-center justify-between border-b border-slate-200 dark:border-zinc-700 shrink-0">
                        <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100">
                            {mode === 'save' ? 'íŒŒì¼ ì €ì¥' : 'íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°'}
                        </h2>
                        <button
                            onClick={onClose}
                            className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 rounded-sm transition-colors"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    {/* ì»¨í…ì¸  */}
                    <div className="flex-1 overflow-y-auto p-6">
                        {mode === 'save' ? (
                            <div className="space-y-6">
                                {/* íŒŒì¼ëª… */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">íŒŒì¼ëª…</label>
                                    <input
                                        type="text"
                                        value={filename}
                                        onChange={(e) => setFilename(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="íŒŒì¼ëª… ì…ë ¥"
                                    />
                                </div>

                                {/* ì €ì¥ í˜•ì‹ */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">ì €ì¥ í˜•ì‹</label>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => setExportType('json')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                exportType === 'json'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ì¼ë°˜ ì €ì¥ (.json)</div>
                                            <div className="text-xs opacity-70">ì•”í˜¸í™” ì—†ì´ ì¼ë°˜ JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥</div>
                                        </button>
                                        <button
                                            onClick={() => setExportType('vel')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                exportType === 'vel'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ì•”í˜¸í™” ì €ì¥ (.vel)</div>
                                            <div className="text-xs opacity-70">ì•”í˜¸ë¥¼ ì„¤ì •í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì €ì¥</div>
                                        </button>
                                    </div>
                                </div>

                                {/* ì•”í˜¸ ì…ë ¥ (vel ì„ íƒ ì‹œ) */}
                                <AnimatePresence>
                                    {exportType === 'vel' && (
                                        <motion.div
                                            initial={{ opacity: 0, height: 0 }}
                                            animate={{ opacity: 1, height: 'auto' }}
                                            exit={{ opacity: 0, height: 0 }}
                                            className="space-y-4 overflow-hidden"
                                        >
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì•”í˜¸</label>
                                                <input
                                                    type="password"
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                    placeholder="ì•”í˜¸ ì…ë ¥"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì•”í˜¸ í™•ì¸</label>
                                                <input
                                                    type="password"
                                                    value={passwordConfirm}
                                                    onChange={(e) => setPasswordConfirm(e.target.value)}
                                                    className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                    placeholder="ì•”í˜¸ ì¬ì…ë ¥"
                                                />
                                            </div>
                                        </motion.div>
                                    )}
                                </AnimatePresence>

                                {/* ì €ì¥ ì •ë³´ */}
                                <div className="p-4 bg-slate-50 dark:bg-zinc-800/50 rounded-sm border border-slate-200 dark:border-zinc-700">
                                    <div className="text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase mb-2">ì €ì¥ ì •ë³´</div>
                                    <div className="text-sm font-medium text-slate-700 dark:text-zinc-300">
                                        <div className="flex justify-between mb-1">
                                            <span>ì´ ì‘í’ˆ ìˆ˜</span>
                                            <span className="font-black">{books.length}ê°œ</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>ì €ì¥ í˜•ì‹</span>
                                            <span className="font-black">{exportType === 'json' ? 'JSON' : 'ì•”í˜¸í™” (VEL)'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {importStep === 'select' && (
                                    <>
                                        <div className="text-center py-10">
                                            <div className="w-20 h-20 mx-auto mb-4 bg-slate-100 dark:bg-zinc-800 rounded-full flex items-center justify-center">
                                                <IconUpload className="w-8 h-8 text-slate-400 dark:text-zinc-500" />
                                            </div>
                                            <p className="text-sm font-bold text-slate-600 dark:text-zinc-400 mb-1">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                            <p className="text-xs text-slate-400 dark:text-zinc-500">.json ë˜ëŠ” .vel íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤</p>
                                        </div>
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                        >
                                            íŒŒì¼ ì„ íƒ
                                        </button>
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) onFileSelect(file);
                                                e.target.value = '';
                                            }}
                                            className="hidden"
                                            accept=".json,.vel"
                                        />
                                    </>
                                )}

                                {importStep === 'password' && (
                                    <>
                                        <div className="text-center py-6">
                                            <div className="w-16 h-16 mx-auto mb-4 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                                                <svg className="w-7 h-7 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                                </svg>
                                            </div>
                                            <p className="text-sm font-black text-slate-700 dark:text-zinc-300 mb-1">ì•”í˜¸í™”ëœ íŒŒì¼</p>
                                            <p className="text-xs text-slate-400 dark:text-zinc-500">íŒŒì¼ì„ ì—´ë ¤ë©´ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì•”í˜¸ ì…ë ¥</label>
                                            <input
                                                type="password"
                                                value={importPassword}
                                                onChange={(e) => setImportPassword(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleDecrypt()}
                                                className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                placeholder="íŒŒì¼ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                                autoFocus
                                            />
                                        </div>
                                        <div className="flex gap-2 pt-2">
                                            <button
                                                onClick={() => setImportStep('select')}
                                                className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                            >
                                                ë‹¤ë¥¸ íŒŒì¼
                                            </button>
                                            <button
                                                onClick={handleDecrypt}
                                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                            >
                                                í™•ì¸
                                            </button>
                                        </div>
                                    </>
                                )}

                                {importStep === 'mode' && (
                                    <>
                                        <div className="text-center py-4">
                                            <div className="w-14 h-14 mx-auto mb-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center">
                                                <svg className="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                            <p className="text-sm font-black text-slate-700 dark:text-zinc-300">íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ</p>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">ë¶ˆëŸ¬ì˜¤ê¸° ë°©ì‹</label>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={() => setImportMode('replace')}
                                                    className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                        importMode === 'replace'
                                                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                            : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                    }`}
                                                >
                                                    <div className="font-black mb-1">ë®ì–´ì“°ê¸°</div>
                                                    <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ë¥¼ ì‚­ì œí•˜ê³  ë¶ˆëŸ¬ì˜¨ íŒŒì¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤</div>
                                                </button>
                                                <button
                                                    onClick={() => setImportMode('append')}
                                                    className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                        importMode === 'append'
                                                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                            : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                    }`}
                                                >
                                                    <div className="font-black mb-1">ì¶”ê°€í•˜ê¸°</div>
                                                    <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ ë’¤ì— ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤</div>
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>

                    {/* í‘¸í„° ë²„íŠ¼ */}
                    <div className="p-6 border-t border-slate-200 dark:border-zinc-700 shrink-0">
                        {mode === 'save' ? (
                            <button
                                onClick={handleSave}
                                className="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-600 dark:hover:bg-indigo-500"
                            >
                                ì €ì¥í•˜ê¸°
                            </button>
                        ) : (
                            importStep === 'mode' && (
                                <button
                                    onClick={handleImport}
                                    className="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-600 dark:hover:bg-indigo-500"
                                >
                                    ë¶ˆëŸ¬ì˜¤ê¸°
                                </button>
                            )
                        )}
                    </div>
                </motion.div>
            );
        };

        // Workspace
        const Workspace = ({ currentBook, onUpdateBook, onExit, showToast }) => {
            const [projects, setProjects] = useState(currentBook.projects || []);
            const [activeProjectId, setActiveProjectId] = useState(currentBook.activeProjectId || (currentBook.projects[0] ? currentBook.projects[0].id : 'default'));
            const [expandedProjects, setExpandedProjects] = useState(currentBook.expandedProjects || (currentBook.projects[0] ? { [currentBook.projects[0].id]: true } : {}));
            const [scale, setScale] = useState(currentBook.scale || 1);
            const [pan, setPan] = useState(currentBook.pan || { x: 0, y: 0 });
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [isZenMode, setIsZenMode] = useState(false); 
            const titleInputRef = useRef(null);
            const workspaceTimerRef = useRef(null);

            // [ì¶”ê°€ëœ ê¸°ëŠ¥] í™”ë©´ ì¤‘ì•™ ë§ì¶¤ í•¨ìˆ˜ (fitToScreen)
            const fitToScreen = useCallback((targetNodes = activeProject?.nodes || []) => {
                if (!targetNodes || targetNodes.length === 0) {
                    setPan({ x: 0, y: 0 });
                    setScale(1);
                    return;
                }
                const minX = Math.min(...targetNodes.map(n => n.x));
                const minY = Math.min(...targetNodes.map(n => n.y));
                const maxX = Math.max(...targetNodes.map(n => n.x)) + CARD_W;
                const maxY = Math.max(...targetNodes.map(n => n.y)) + CARD_H;
                
                const viewportW = containerRef.current.clientWidth;
                const viewportH = containerRef.current.clientHeight;
                const padding = 100;
                
                const scaleX = (viewportW - padding * 2) / (maxX - minX);
                const scaleY = (viewportH - padding * 2) / (maxY - minY);
                
                let newScale = Math.min(Math.max(Math.min(scaleX, scaleY), 0.2), 1.5);
                
                setPan({ 
                    x: (viewportW / 2) - ((minX + maxX) / 2 * newScale), 
                    y: (viewportH / 2) - ((minY + maxY) / 2 * newScale) 
                });
                setScale(newScale);
                showToast("í™”ë©´ì— ë§ê²Œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, [projects, activeProjectId]);

            useEffect(() => { if (isEditingTitle && titleInputRef.current) titleInputRef.current.focus(); }, [isEditingTitle]);
            
            useEffect(() => { 
                if (workspaceTimerRef.current) clearTimeout(workspaceTimerRef.current);
                workspaceTimerRef.current = setTimeout(() => { 
                    onUpdateBook({ ...currentBook, projects, activeProjectId, expandedProjects, scale, pan }); 
                }, 300); 
                return () => { if(workspaceTimerRef.current) clearTimeout(workspaceTimerRef.current); }; 
            }, [projects, activeProjectId, expandedProjects, scale, pan]);

            useEffect(() => {
                const handleZenShortcut = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'j') {
                        e.preventDefault();
                        const current = projects.find(p => p.id === activeProjectId);
                        if (current && current.type === 'doc') {
                            setIsZenMode(prev => !prev);
                            showToast(!isZenMode ? "ì§‘ì¤‘ ëª¨ë“œ í™œì„±í™”" : "ì§‘ì¤‘ ëª¨ë“œ í•´ì œ");
                        }
                    }
                };
                window.addEventListener('keydown', handleZenShortcut);
                return () => window.removeEventListener('keydown', handleZenShortcut);
            }, [activeProjectId, projects, isZenMode, showToast]);

            const [editingProjectId, setEditingProjectId] = useState(null); // eslint-disable-line no-unused-vars
            const [mention, setMention] = useState({ active: false, type: '', search: '', x: 0, y: 0, pos: 0, selectedIndex: 0 });
            const [hoverInfo, setHoverInfo] = useState({ visible: false, node: null, x: 0, y: 0 });
            const textareaRef = useRef(null);
            const containerRef = useRef(null);

            const setSidebarCols = (projectId, cols) => {
                setProjects(prev => prev.map(p => 
                    p.id === projectId ? { ...p, sidebarColumns: cols } : p
                ));
            };

            // ë©˜ì…˜ ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (!mention.active) return;
                    const mentionList = document.querySelector('.mention-list');
                    const isTextAreaClick = e.target === textareaRef.current;
                    if (mentionList && !mentionList.contains(e.target) && !isTextAreaClick) {
                        setMention(prev => ({ ...prev, active: false }));
                    }
                };
                if (mention.active) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [mention.active]);

            const activeProject = useMemo(() => projects.find(p => p.id === activeProjectId) || projects[0], [projects, activeProjectId]);
            
            const nodes = activeProject?.nodes || [];
            const edges = activeProject?.edges || [];
            const allBoardNodes = useMemo(() => projects.filter(p => p.type === 'board').flatMap(p => (p.nodes || []).map(node => ({ ...node, projectName: p.name }))), [projects]);
            const filteredMentionNodes = useMemo(() => { if (!mention.active) return []; return allBoardNodes.filter(n => n.type === (mention.type === '@' ? 'ì¸ë¬¼' : 'ì‚¬ê±´') && (n.label.includes(mention.search) || mention.search === "")); }, [allBoardNodes, mention]);

            const handleSelectProject = (id) => {
                setActiveProjectId(id);
                const target = projects.find(p => p.id === id);
                if (target && target.type !== 'doc') setIsZenMode(false);
            };
            const toggleProjectFolder = (id, e) => { if (e) e.stopPropagation(); setExpandedProjects(prev => ({ ...prev, [id]: !prev[id] })); };
            
            const updateActiveProject = useCallback((nodeUpdater, edgeUpdater) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    return {
                        ...p,
                        nodes: nodeUpdater ? (typeof nodeUpdater === 'function' ? nodeUpdater(p.nodes || []) : nodeUpdater) : (p.nodes || []),
                        edges: edgeUpdater ? (typeof edgeUpdater === 'function' ? edgeUpdater(p.edges || []) : edgeUpdater) : (p.edges || [])
                    };
                }));
            }, [activeProjectId]);

            const updateDocContent = (content) => { setProjects(prev => prev.map(p => p.id === activeProjectId ? { ...p, content } : p)); };

            const [history, setHistory] = useState({ past: [], future: [] });
            const [isPanning, setIsPanning] = useState(false);
            const [draggingNodeId, setDraggingNodeId] = useState(null);
            const [tempEdge, setTempEdge] = useState(null);
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [highlightedNodeId, setHighlightedNodeId] = useState(null);
            const [selectedEdgeId, setSelectedEdgeId] = useState(null);
            const [topNodeId, setTopNodeId] = useState(null);
            const lastMousePos = useRef({ x: 0, y: 0 });
            const hasConnectedRef = useRef(false);

            // ì‚¬ì´ë“œë°” ë…¸ë“œ ë“œë˜ê·¸ìš© ìƒíƒœ
            const [sidebarDrag, setSidebarDrag] = useState({ active: false, nodeId: null, type: null, startIdx: null, currentIdx: null, x: 0, y: 0 });
            const sidebarDragRef = useRef(null);
            const touchStartTimeRef = useRef(0);
            const touchStartPosRef = useRef({ x: 0, y: 0, nodeId: null });
            const longPressTimerRef = useRef(null);
            const touchModeRef = useRef('none'); // 'none' | 'edge' | 'drag'

            const saveHistory = useCallback(() => { setHistory(prev => ({ past: [...prev.past.slice(-19), { projects }], future: [] })); }, [projects]);
            const undo = useCallback(() => { setHistory(prev => { if (prev.past.length === 0) return prev; const previous = prev.past[prev.past.length - 1]; const newPast = prev.past.slice(0, prev.past.length - 1); setProjects(previous.projects); showToast("ì‹¤í–‰ ì·¨ì†Œë¨"); return { past: newPast, future: [{ projects }, ...prev.future] }; }); }, [projects, showToast]);
            
            useEffect(() => { 
                const handleUndoKeyDown = (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); } }; 
                window.addEventListener('keydown', handleUndoKeyDown); 
                return () => window.removeEventListener('keydown', handleUndoKeyDown); 
            }, [undo]);
            
            useEffect(() => { 
                const div = containerRef.current;
                const handleWheel = (e) => { 
                    if (!div || e.target.closest('aside') || (activeProject && activeProject.type === 'doc')) return; 
                    e.preventDefault(); 
                    const rect = div.getBoundingClientRect(); 
                    const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top; 
                    const delta = -e.deltaY * 0.0012; 
                    const newScale = Math.min(Math.max(0.1, scale + delta), 3); 
                    const scaleRatio = newScale / scale; 
                    setPan(prev => ({ x: mouseX - (mouseX - prev.x) * scaleRatio, y: mouseY - (mouseY - prev.y) * scaleRatio })); 
                    setScale(newScale); 
                }; 
                if(div) { 
                    div.addEventListener('wheel', handleWheel, { passive: false }); 
                    return () => div.removeEventListener('wheel', handleWheel); 
                } 
            }, [scale, activeProject]);

            const getCanvasCoords = (clientX, clientY) => { 
                if (!containerRef.current) return {x:0, y:0};
                const rect = containerRef.current.getBoundingClientRect(); 
                return { x: (clientX - rect.left - pan.x) / scale, y: (clientY - rect.top - pan.y) / scale }; 
            };
            const findNode = (id) => nodes.find(n => n.id === id);
            
            const createNewProject = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'board', name: 'ìƒˆ í”„ë¡œì íŠ¸', nodes: [], edges: [], sidebarColumns: 1 }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); setPan({ x: 0, y: 0 }); setScale(1); setIsZenMode(false); };
            const createNewDoc = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'doc', name: 'ìƒˆ ë¬¸ì„œ', content: " ", status: 'ì´ˆê³ ', targetCount: 5000 }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); };
            const deleteProject = (id, e) => { if (e) e.stopPropagation(); if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { saveHistory(); let newProjects = projects.filter(p => p.id !== id); if (newProjects.length === 0) { const dummyId = generateUUID(); newProjects = [{ id: dummyId, type: 'board', name: 'ìƒˆ í”„ë¡œì íŠ¸', nodes: [], edges: [] }]; handleSelectProject(dummyId); } else if (activeProjectId === id) handleSelectProject(newProjects[0].id); setProjects(newProjects); } };
            const handleProjectRename = (id, newName) => { saveHistory(); setProjects(prev => prev.map(p => p.id === id ? { ...p, name: newName } : p)); setEditingProjectId(null); };

            const addNode = (type) => { 
                saveHistory(); 
                const id = generateUUID(); 
                const rect = containerRef.current.getBoundingClientRect(); 
                const center = getCanvasCoords(rect.left + rect.width / 2, rect.top + rect.height / 2); 
                
                const defaultData = type === 'ì¸ë¬¼' 
                    ? { emoji: 'ğŸ‘¤', age: '', gender: 'ë¯¸ì§€ì •', job: '', race: 'ì¸ê°„', role: 'ì¡°ì—°', memo: '' } 
                    : (type === 'ì‚¬ê±´' ? { emoji: 'ğŸ”¥', place: '', year: '', memo: '' } : { emoji: 'ğŸ’¡', memo: '' }); 

                updateActiveProject(prev => [...prev, { id, x: center.x - CARD_W / 2, y: center.y - CARD_H / 2, label: `ìƒˆ ${type}`, type, data: defaultData }]); 
                setTopNodeId(id); 
            };
            const deleteNode = (id) => { saveHistory(); updateActiveProject(prev => prev.filter(n => n.id !== id), prev => prev.filter(e => e.from !== id && e.to !== id)); if (selectedNodeId === id) setSelectedNodeId(null); if (highlightedNodeId === id) setHighlightedNodeId(null); };
            
            const handleReorderNodes = (type, newOrder) => {
                saveHistory();
                updateActiveProject(allNodes => {
                    // ìƒˆ ìˆœì„œì˜ ID ë°°ì—´
                    const newOrderIds = newOrder.map(n => n.id);

                    // í•´ë‹¹ íƒ€ì…ì´ ì•„ë‹Œ ë…¸ë“œë“¤
                    const otherNodes = allNodes.filter(n => n.type !== type);

                    // í•´ë‹¹ íƒ€ì…ì˜ ë…¸ë“œë“¤ì„ ìƒˆ ìˆœì„œë¡œ ì •ë ¬
                    const reorderedNodes = newOrderIds.map(id => allNodes.find(n => n.id === id)).filter(Boolean);

                    // íƒ€ì… ìˆœì„œ ìœ ì§€: ì¸ë¬¼ â†’ ì‚¬ê±´ â†’ ë©”ëª¨
                    const persons = type === 'ì¸ë¬¼' ? reorderedNodes : otherNodes.filter(n => n.type === 'ì¸ë¬¼');
                    const events = type === 'ì‚¬ê±´' ? reorderedNodes : otherNodes.filter(n => n.type === 'ì‚¬ê±´');
                    const memos = type === 'ë©”ëª¨' ? reorderedNodes : otherNodes.filter(n => n.type === 'ë©”ëª¨');

                    return [...persons, ...events, ...memos];
                });
            };

            const handleReorderDocs = (newOrder) => {
                setProjects(prevProjects => {
                    const boards = prevProjects.filter(p => p.type === 'board');
                    const newOrderIds = newOrder.map(p => p.id);
                    const reorderedDocs = newOrderIds.map(id => prevProjects.find(p => p.id === id)).filter(Boolean);
                    return [...boards, ...reorderedDocs];
                });
            };

            // ì‚¬ì´ë“œë°” ê·¸ë¦¬ë“œ ë“œë˜ê·¸ í•¸ë“¤ëŸ¬
            const handleSidebarDragStart = (e, node, type, idx) => {
                e.preventDefault();
                const rect = e.currentTarget.getBoundingClientRect();
                setSidebarDrag({
                    active: true,
                    nodeId: node.id,
                    type,
                    startIdx: idx,
                    currentIdx: idx,
                    x: e.clientX,
                    y: e.clientY,
                    offsetX: e.clientX - rect.left,
                    offsetY: e.clientY - rect.top,
                    width: rect.width,
                    height: rect.height
                });
                sidebarDragRef.current = node;
            };

            const handleSidebarDragMove = useCallback((e) => {
                if (!sidebarDrag.active) return;
                setSidebarDrag(prev => ({ ...prev, x: e.clientX, y: e.clientY }));

                // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
                const elements = document.querySelectorAll(`[data-sidebar-type="${sidebarDrag.type}"]`);
                let closestIdx = sidebarDrag.startIdx;
                let closestDist = Infinity;

                elements.forEach((el, idx) => {
                    const rect = el.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const dist = Math.hypot(e.clientX - centerX, e.clientY - centerY);
                    if (dist < closestDist) {
                        closestDist = dist;
                        closestIdx = idx;
                    }
                });

                if (closestIdx !== sidebarDrag.currentIdx) {
                    setSidebarDrag(prev => ({ ...prev, currentIdx: closestIdx }));
                }
            }, [sidebarDrag.active, sidebarDrag.type, sidebarDrag.startIdx, sidebarDrag.currentIdx]);

            const handleSidebarDragEnd = useCallback(() => {
                if (!sidebarDrag.active) return;

                const { type, startIdx, currentIdx } = sidebarDrag;
                if (startIdx !== currentIdx) {
                    saveHistory();
                    updateActiveProject(allNodes => {
                        const filtered = allNodes.filter(n => n.type === type);
                        const others = allNodes.filter(n => n.type !== type);

                        // ìˆœì„œ ë³€ê²½
                        const newFiltered = [...filtered];
                        const [moved] = newFiltered.splice(startIdx, 1);
                        newFiltered.splice(currentIdx, 0, moved);

                        const persons = type === 'ì¸ë¬¼' ? newFiltered : others.filter(n => n.type === 'ì¸ë¬¼');
                        const events = type === 'ì‚¬ê±´' ? newFiltered : others.filter(n => n.type === 'ì‚¬ê±´');
                        const memos = type === 'ë©”ëª¨' ? newFiltered : others.filter(n => n.type === 'ë©”ëª¨');

                        return [...persons, ...events, ...memos];
                    });
                }

                setSidebarDrag({ active: false, nodeId: null, type: null, startIdx: null, currentIdx: null, x: 0, y: 0 });
                sidebarDragRef.current = null;
            }, [sidebarDrag, saveHistory, updateActiveProject]);

            useEffect(() => {
                if (sidebarDrag.active) {
                    window.addEventListener('mousemove', handleSidebarDragMove);
                    window.addEventListener('mouseup', handleSidebarDragEnd);
                    return () => {
                        window.removeEventListener('mousemove', handleSidebarDragMove);
                        window.removeEventListener('mouseup', handleSidebarDragEnd);
                    };
                }
            }, [sidebarDrag.active, handleSidebarDragMove, handleSidebarDragEnd]);

            const rafIdRef = useRef(null);
            const dragUpdateRef = useRef({ dx: 0, dy: 0, pending: false });
            
            const handleGlobalMouseMove = (e) => { 
                if (activeProject.type === 'doc') return; 
                const dx = e.clientX - lastMousePos.current.x;
                const dy = e.clientY - lastMousePos.current.y; 
                if (isPanning) {
                    setPan(prev => ({ x: prev.x + dx, y: prev.y + dy })); 
                } else if (draggingNodeId) { 
                    dragUpdateRef.current = { dx, dy, pending: true };
                    if (!rafIdRef.current) {
                        rafIdRef.current = requestAnimationFrame(() => {
                            if (dragUpdateRef.current.pending) {
                                const { dx: deltaX, dy: deltaY } = dragUpdateRef.current;
                                updateActiveProject(prev => prev.map(n => n.id === draggingNodeId ? { ...n, x: n.x + (deltaX / scale), y: n.y + (deltaY / scale) } : n)); 
                                dragUpdateRef.current.pending = false;
                            }
                            rafIdRef.current = null;
                        });
                    }
                } 
                if (tempEdge) { 
                    const c = getCanvasCoords(e.clientX, e.clientY); 
                    setTempEdge(prev => ({ ...prev, toX: c.x, toY: c.y })); 
                } 
                lastMousePos.current = { x: e.clientX, y: e.clientY }; 
            };

            const handleGlobalMouseUp = (e) => {
                if (activeProject.type === 'board') {
                    if (rafIdRef.current) {
                        cancelAnimationFrame(rafIdRef.current);
                        rafIdRef.current = null;
                    }
                    if (draggingNodeId) {
                        if (dragUpdateRef.current.pending) {
                            const { dx: deltaX, dy: deltaY } = dragUpdateRef.current;
                            updateActiveProject(prev => prev.map(n => n.id === draggingNodeId ? { ...n, x: n.x + (deltaX / scale), y: n.y + (deltaY / scale) } : n)); 
                            dragUpdateRef.current.pending = false;
                        }
                        saveHistory();
                    }
                    if (tempEdge) {
                        const c = getCanvasCoords(e.clientX, e.clientY);
                        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ìˆëŠ” ë…¸ë“œ ì°¾ê¸° (ì¶œë°œ ë…¸ë“œ ì œì™¸)
                        const targetNode = nodes.find(n =>
                            n.id !== tempEdge.fromId &&
                            c.x >= n.x && c.x <= n.x + CARD_W &&
                            c.y >= n.y && c.y <= n.y + CARD_H
                        );

                        if (targetNode) {
                            // ë‹¤ë¥¸ ë…¸ë“œ ìœ„ì—ì„œ ë†“ìœ¼ë©´ ì—°ê²°
                            saveHistory();
                            updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: targetNode.id, label: 'ê´€ê³„' }]);
                        } else {
                            // ë¹ˆ ê³µê°„ì—ì„œ ë†“ìœ¼ë©´ ìƒˆ ë…¸ë“œ ìƒì„±
                            saveHistory();
                            const fromNode = findNode(tempEdge.fromId);
                            const newNodeId = generateUUID();
                            const defaultData = fromNode.type === 'ì¸ë¬¼'
                                ? { emoji: 'ğŸ‘¤', age: '', gender: 'ë¯¸ì§€ì •', job: '', race: 'ì¸ê°„', role: 'ì¡°ì—°', memo: '' }
                                : (fromNode.type === 'ì‚¬ê±´' ? { emoji: 'ğŸ”¥', place: '', year: '', memo: '' } : { emoji: 'ğŸ’¡', memo: '' });
                            updateActiveProject(prev => [...prev, { id: newNodeId, x: c.x - CARD_W/2, y: c.y - CARD_H/2, label: `ìƒˆ ${fromNode.type}`, type: fromNode.type, data: defaultData }], prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: newNodeId, label: 'ê´€ê³„' }]);
                        }
                    }
                    hasConnectedRef.current = false;
                    setIsPanning(false);
                    setDraggingNodeId(null);
                    setTempEdge(null);
                }
            };

            const handleNodeTouchStart = (e, nodeId) => {
                if (e.touches.length !== 1) return;
                e.preventDefault();
                e.stopPropagation();
                
                const touch = e.touches[0];
                touchStartPosRef.current = { x: touch.clientX, y: touch.clientY, nodeId };
                touchStartTimeRef.current = Date.now();
                lastMousePos.current = { x: touch.clientX, y: touch.clientY };
                touchModeRef.current = 'none';
                
                // ê¸¸ê²Œ í„°ì¹˜ ê°ì§€ (300ms í›„ ë…¸ë“œ ì´ë™ ëª¨ë“œ)
                longPressTimerRef.current = setTimeout(() => {
                    if (touchModeRef.current === 'none') {
                        touchModeRef.current = 'drag';
                        setDraggingNodeId(nodeId);
                        setTopNodeId(nodeId);
                    }
                }, 300);
            };

            const handleNodeTouchEnd = (e, nodeId) => {
                if (longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                    longPressTimerRef.current = null;
                }
                
                if (e.changedTouches.length === 0) return;
                const touch = e.changedTouches[0];
                const touchDuration = Date.now() - touchStartTimeRef.current;
                const moveDistance = Math.sqrt(
                    Math.pow(touch.clientX - touchStartPosRef.current.x, 2) + 
                    Math.pow(touch.clientY - touchStartPosRef.current.y, 2)
                );
                
                // ì§§ê²Œ í„°ì¹˜ í›„ ë“œë˜ê·¸ (ì„  ì—°ê²° ëª¨ë“œ)
                if (touchModeRef.current === 'none' && touchDuration < 300 && moveDistance > 10) {
                    touchModeRef.current = 'edge';
                    const c = getCanvasCoords(touchStartPosRef.current.x, touchStartPosRef.current.y);
                    setTempEdge({ fromId: nodeId, toX: c.x, toY: c.y });
                    lastMousePos.current = { x: touch.clientX, y: touch.clientY };
                } else if (touchModeRef.current === 'edge' && tempEdge) {
                    // ì„  ì—°ê²° ì™„ë£Œ
                    const c = getCanvasCoords(touch.clientX, touch.clientY);
                    const targetNode = nodes.find(n =>
                        n.id !== tempEdge.fromId &&
                        c.x >= n.x && c.x <= n.x + CARD_W &&
                        c.y >= n.y && c.y <= n.y + CARD_H
                    );

                    if (targetNode) {
                        saveHistory();
                        updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: targetNode.id, label: 'ê´€ê³„' }]);
                    } else {
                        saveHistory();
                        const fromNode = findNode(tempEdge.fromId);
                        const newNodeId = generateUUID();
                        const defaultData = fromNode.type === 'ì¸ë¬¼'
                            ? { emoji: 'ğŸ‘¤', age: '', gender: 'ë¯¸ì§€ì •', job: '', race: 'ì¸ê°„', role: 'ì¡°ì—°', memo: '' }
                            : (fromNode.type === 'ì‚¬ê±´' ? { emoji: 'ğŸ”¥', place: '', year: '', memo: '' } : { emoji: 'ğŸ’¡', memo: '' });
                        updateActiveProject(prev => [...prev, { id: newNodeId, x: c.x - CARD_W/2, y: c.y - CARD_H/2, label: `ìƒˆ ${fromNode.type}`, type: fromNode.type, data: defaultData }], prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: newNodeId, label: 'ê´€ê³„' }]);
                    }
                    setTempEdge(null);
                }
                
                touchModeRef.current = 'none';
            };

            const handleDocInput = (e) => { let val = e.target.value; const pos = e.target.selectionStart; if (val === "") { updateDocContent("ã€€"); return; } if (val.length >= 1 && val[0] !== "ã€€" && !e.nativeEvent.isComposing) { val = "ã€€" + val; updateDocContent(val); setTimeout(() => { if(textareaRef.current) textareaRef.current.setSelectionRange(pos + 1, pos + 1); }, 0); return; } const lastChar = val[pos - 1]; if (lastChar === '#' || lastChar === '@') { const coords = getCaretCoordinates(e.target, pos); const totalWidth = 650; const totalHeight = 400; let finalX = coords.left; let finalY = coords.top + 25; if (finalX + totalWidth > window.innerWidth) finalX = window.innerWidth - totalWidth - 20; if (finalY + totalHeight > window.innerHeight) finalY = coords.top - totalHeight - 10; setMention({ active: true, type: lastChar, search: '', x: finalX, y: finalY, pos, selectedIndex: 0 }); } else if (mention.active) { if (lastChar === ' ' || !lastChar || lastChar === '\n') setMention({ ...mention, active: false }); else setMention({ ...mention, search: val.slice(mention.pos, pos), selectedIndex: 0 }); } updateDocContent(val); };
            const insertMention = (node) => { const text = activeProject.content || ""; const before = text.slice(0, mention.pos - 1); const after = text.slice(mention.pos + mention.search.length); const newText = before + node.label + "" + after; updateDocContent(newText); setMention({ ...mention, active: false }); setTimeout(() => textareaRef.current.focus(), 10); };
            const handleDocKeyDown = (e) => { if (e.nativeEvent.isComposing) return; if (mention.active) { if (e.key === 'ArrowDown') { e.preventDefault(); setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex + 1) % filteredMentionNodes.length })); } else if (e.key === 'ArrowUp') { e.preventDefault(); setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex - 1 + filteredMentionNodes.length) % filteredMentionNodes.length })); } else if (e.key === 'Enter') { e.preventDefault(); if (filteredMentionNodes[mention.selectedIndex]) insertMention(filteredMentionNodes[mention.selectedIndex]); } else if (e.key === 'Escape') setMention({ ...mention, active: false }); } else if (e.key === 'Enter') { e.preventDefault(); const start = e.target.selectionStart; const end = e.target.selectionEnd; const value = e.target.value; const newValue = value.substring(0, start) + "\nã€€" + value.substring(end); updateDocContent(newValue); setTimeout(() => { if(textareaRef.current) { textareaRef.current.selectionStart = textareaRef.current.selectionEnd = start + 2; } }, 0); } };
            const handleDocMouseMove = (e) => { if (mention.active) return; const text = activeProject.content || ""; const pos = e.target.selectionStart; const word = getWordAtPos(text, pos); if (word.length > 0) { const found = allBoardNodes.find(n => n.label === word && (n.type === 'ì¸ë¬¼' || n.type === 'ì‚¬ê±´')); if (found) { setHoverInfo({ visible: true, node: found, x: e.clientX, y: e.clientY }); return; } } setHoverInfo({ ...hoverInfo, visible: false }); };

            const handleAutoLayout = useCallback(() => {
                if (!activeProject || activeProject.type !== 'board') return;
                saveHistory();

                const GAP_BETWEEN_GROUPS = 400; // ê·¸ë£¹ ê°„ ê°„ê²©

                // 1. ê·¸ë£¹í•‘
                const groups = {
                    'ì¸ë¬¼': activeProject.nodes.filter(n => n.type === 'ì¸ë¬¼'),
                    'ì‚¬ê±´': activeProject.nodes.filter(n => n.type === 'ì‚¬ê±´'),
                    'ë©”ëª¨': activeProject.nodes.filter(n => n.type !== 'ì¸ë¬¼' && n.type !== 'ì‚¬ê±´')
                };

                // í—¬í¼: íŠ¹ì • ê·¸ë£¹ ë‚´ë¶€ì˜ ì—£ì§€ë“¤ë§Œ ê°€ì ¸ì˜¤ê¸°
                const getInternalEdges = (groupNodes) => {
                    const ids = new Set(groupNodes.map(n => n.id));
                    return activeProject.edges.filter(e => ids.has(e.from) && ids.has(e.to));
                };

                // í—¬í¼: ì¼ë°˜ì ì¸ Dagre ë ˆì´ì•„ì›ƒ (ì‚¬ê±´/ë©”ëª¨ìš©)
                const layoutStandardGroup = (groupNodes, groupEdges) => {
                    if (groupNodes.length === 0) return { nodes: [], width: 0, minX: 0 };
                    const g = new dagre.graphlib.Graph();
                    g.setGraph({ rankdir: 'TB', ranksep: 100, nodesep: 60 });
                    g.setDefaultEdgeLabel(() => ({}));
                    groupNodes.forEach(node => g.setNode(node.id, { width: CARD_W, height: CARD_H }));
                    groupEdges.forEach(edge => g.setEdge(edge.from, edge.to));
                    dagre.layout(g);
                    
                    let minX = Infinity, maxX = -Infinity;
                    const positioned = groupNodes.map(node => {
                        const pos = g.node(node.id);
                        const x = pos.x - CARD_W / 2;
                        const y = pos.y - CARD_H / 2;
                        if (x < minX) minX = x;
                        if (x + CARD_W > maxX) maxX = x + CARD_W;
                        return { ...node, x, y };
                    });
                    // 0ë¶€í„° ì‹œì‘í•˜ë„ë¡ ë³´ì •
                    return { 
                        nodes: positioned.map(n => ({ ...n, x: n.x - minX })), 
                        width: maxX - minX 
                    };
                };

                // =========================================================
                // [í•µì‹¬] ì¸ë¬¼ ê·¸ë£¹ íŠ¹ìˆ˜ ë ˆì´ì•„ì›ƒ (ìƒë‹¨: 1ì´Œ ë…ì‹  / í•˜ë‹¨: íŠ¸ë¦¬)
                // =========================================================
                const layoutPersonGroup = (groupNodes, groupEdges) => {
                    if (groupNodes.length === 0) return { nodes: [], width: 0 };

                    // 1. ì£¼ì¸ê³µ(Root) ì‹ë³„
                    const rootNode = groupNodes.find(n => n.data?.role === 'ì£¼ì¸ê³µ') || groupNodes[0];
                    
                    // 2. ìƒë‹¨ìœ¼ë¡œ ë³´ë‚¼ ë…¸ë“œ(UpNodes)ì™€ í•˜ë‹¨ íŠ¸ë¦¬ë¡œ ë³´ë‚¼ ë…¸ë“œ(DownNodes) ë¶„ë¥˜
                    const upNodes = [];
                    const downNodes = [rootNode]; // ì£¼ì¸ê³µì€ í•˜ë‹¨ íŠ¸ë¦¬ ê³„ì‚°ì˜ ê¸°ì¤€ì ì´ ë¨
                    const downNodeIds = new Set([rootNode.id]);

                    groupNodes.forEach(node => {
                        if (node.id === rootNode.id) return; // ì£¼ì¸ê³µ ì œì™¸

                        // ì´ ë…¸ë“œì˜ ì—°ê²° ê´€ê³„ í™•ì¸
                        const myEdges = groupEdges.filter(e => e.from === node.id || e.to === node.id);
                        const degree = myEdges.length;
                        const isConnectedToRoot = myEdges.some(e => e.from === rootNode.id || e.to === rootNode.id);

                        // ì¡°ê±´: ì£¼ì¸ê³µê³¼ ì—°ê²°ë˜ì–´ ìˆê³ (1ì´Œ), ì—°ê²°ì´ ê·¸ê±° í•˜ë‚˜ë¿(ìì‹ ì—†ìŒ)ì´ë©´ -> ìƒë‹¨
                        if (isConnectedToRoot && degree === 1) {
                            upNodes.push(node);
                        } else {
                            // ê·¸ ì™¸(ìì‹ì´ ìˆê±°ë‚˜, ì£¼ì¸ê³µê³¼ ë©€ê±°ë‚˜ ë“±) -> í•˜ë‹¨ íŠ¸ë¦¬
                            downNodes.push(node);
                            downNodeIds.add(node.id);
                        }
                    });

                    // 3. í•˜ë‹¨ ë…¸ë“œë“¤(ì£¼ì¸ê³µ í¬í•¨)ë§Œ Dagreë¡œ íŠ¸ë¦¬ ì •ë ¬
                    const downEdges = groupEdges.filter(e => downNodeIds.has(e.from) && downNodeIds.has(e.to));
                    
                    // í•˜ë‹¨ íŠ¸ë¦¬ ê³„ì‚°
                    const g = new dagre.graphlib.Graph();
                    g.setGraph({ rankdir: 'TB', ranksep: 120, nodesep: 80 }); // ê°„ê²© ë„‰ë„‰íˆ
                    g.setDefaultEdgeLabel(() => ({}));
                    
                    // ì—­ìˆœìœ¼ë¡œ ë…¸ë“œ ì¶”ê°€ (ìƒˆ ë…¸ë“œê°€ ì™¼ìª½ì— ë°°ì¹˜ë˜ë„ë¡)
                    downNodes.slice().reverse().forEach(n => g.setNode(n.id, { width: CARD_W, height: CARD_H }));
                    downEdges.forEach(e => g.setEdge(e.from, e.to));
                    
                    dagre.layout(g); // ì£¼ì¸ê³µì´ ê°€ì¥ ìœ„ì— ì˜¤ê³ , ìì‹ë“¤ì´ ì•„ë˜ë¡œ ë°°ì¹˜ë¨

                    // 4. ì¢Œí‘œ ì •ë¦¬
                    // í•˜ë‹¨ íŠ¸ë¦¬ ì¢Œí‘œ ì ìš©
                    let minX = Infinity, maxX = -Infinity;
                    let rootPos = { x: 0, y: 0 };

                    const positionedDownNodes = downNodes.map(node => {
                        const pos = g.node(node.id);
                        const x = pos.x - CARD_W / 2;
                        const y = pos.y - CARD_H / 2; // ì£¼ì¸ê³µì´ y=0 ê·¼ì²˜ì— ì˜´

                        if (node.id === rootNode.id) rootPos = { x, y }; // ì£¼ì¸ê³µ ìœ„ì¹˜ ê¸°ì–µ
                        if (x < minX) minX = x;
                        if (x + CARD_W > maxX) maxX = x + CARD_W;
                        
                        return { ...node, x, y };
                    });

                    // 5. ìƒë‹¨ ë…¸ë“œë“¤ ê°•ì œ ë°°ì¹˜ (ì£¼ì¸ê³µ ë¨¸ë¦¬ ìœ„ë¡œ, ì™¼ìª½ë¶€í„° ì¶”ê°€)
                    const positionedUpNodes = [];
                    if (upNodes.length > 0) {
                        const gap = CARD_W + 20;
                        const totalUpWidth = (upNodes.length - 1) * gap;
                        // ì£¼ì¸ê³µì˜ Xì¢Œí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬
                        const startX = rootPos.x + (CARD_W / 2) - (CARD_W / 2) - (totalUpWidth / 2);

                        // ì—­ìˆœìœ¼ë¡œ ë°°ì¹˜ (ìƒˆ ë…¸ë“œê°€ ì™¼ìª½ì— ì¶”ê°€ë˜ë„ë¡)
                        upNodes.slice().reverse().forEach((node, idx) => {
                            positionedUpNodes.push({
                                ...node,
                                x: startX + (idx * gap),
                                y: rootPos.y - 150 - CARD_H // ì£¼ì¸ê³µ ìœ„ë¡œ 150px ë„ìš°ê¸°
                            });

                            // ë²”ìœ„ ê°±ì‹  (ì „ì²´ ë„ˆë¹„ ê³„ì‚°ìš©)
                            const nx = startX + (idx * gap);
                            if (nx < minX) minX = nx;
                            if (nx + CARD_W > maxX) maxX = nx + CARD_W;
                        });
                    }

                    const allPositioned = [...positionedDownNodes, ...positionedUpNodes];

                    // 6. ì „ì²´ ê·¸ë£¹ ì •ê·œí™” (x=0 ë¶€í„° ì‹œì‘í•˜ë„ë¡)
                    return {
                        nodes: allPositioned.map(n => ({ ...n, x: n.x - minX })),
                        width: maxX - minX
                    };
                };


                // --- ì‹¤í–‰ ---

                // 1. ê° ê·¸ë£¹ ë ˆì´ì•„ì›ƒ ê³„ì‚°
                const personResult = layoutPersonGroup(groups['ì¸ë¬¼'], getInternalEdges(groups['ì¸ë¬¼']));
                const eventResult = layoutStandardGroup(groups['ì‚¬ê±´'], getInternalEdges(groups['ì‚¬ê±´']));
                const memoResult = layoutStandardGroup(groups['ë©”ëª¨'], getInternalEdges(groups['ë©”ëª¨']));

                // 2. ê°€ë¡œë¡œ ë‚˜ë€íˆ ë°°ì¹˜ (Offset ì ìš©) - ìˆœì„œ: ì¸ë¬¼ â†’ ì‚¬ê±´ â†’ ë©”ëª¨
                let currentOffset = 0;

                const finalPersonNodes = personResult.nodes.map(n => ({ ...n, x: n.x + currentOffset }));
                if (personResult.nodes.length > 0) currentOffset += personResult.width + GAP_BETWEEN_GROUPS;

                const finalEventNodes = eventResult.nodes.map(n => ({ ...n, x: n.x + currentOffset }));
                if (eventResult.nodes.length > 0) currentOffset += eventResult.width + GAP_BETWEEN_GROUPS;

                const finalMemoNodes = memoResult.nodes.map(n => ({ ...n, x: n.x + currentOffset }));

                // 3. ì—…ë°ì´íŠ¸ (ì›ë˜ ìˆœì„œ ìœ ì§€, ìœ„ì¹˜ë§Œ ë³€ê²½)
                const layoutedNodes = [...finalPersonNodes, ...finalEventNodes, ...finalMemoNodes];
                const positionMap = new Map();
                layoutedNodes.forEach(n => {
                    positionMap.set(n.id, { x: n.x, y: n.y });
                });

                updateActiveProject(prevNodes =>
                    prevNodes.map(n => {
                        const newPos = positionMap.get(n.id);
                        return newPos ? { ...n, x: newPos.x, y: newPos.y } : n;
                    })
                );
                setTimeout(() => fitToScreen(layoutedNodes), 100);

            }, [activeProject, saveHistory, updateActiveProject, showToast, fitToScreen]);


            const activeNode = useMemo(() => nodes.find(n => n.id === selectedNodeId), [nodes, selectedNodeId]);
            const activeEdge = useMemo(() => edges.find(e => e.id === selectedEdgeId), [edges, selectedEdgeId]);
            const visibleNodes = useMemo(() => { 
                if (activeProject?.type !== 'board') return []; 
                const viewportW = window.innerWidth; 
                const viewportH = window.innerHeight; 
                const buffer = 300; 
                const result = [];
                for (let i = 0; i < nodes.length; i++) {
                    const node = nodes[i];
                    const screenX = node.x * scale + pan.x; 
                    const screenY = node.y * scale + pan.y; 
                    const screenW = CARD_W * scale; 
                    const screenH = CARD_H * scale; 
                    if (screenX + screenW + buffer > 0 && screenX - buffer < viewportW && screenY + screenH + buffer > 0 && screenY - buffer < viewportH) {
                        result.push(node);
                    }
                }
                return result;
            }, [nodes, scale, pan, activeProject?.type]);
            const visibleEdges = useMemo(() => { if (activeProject?.type !== 'board') return []; const visibleIds = new Set(visibleNodes.map(n => n.id)); return edges.filter(edge => visibleIds.has(edge.from) || visibleIds.has(edge.to)); }, [edges, visibleNodes, activeProject?.type]);

            const renderProjectItem = (project) => {
                const isActive = activeProjectId === project.id; const isDoc = project.type === 'doc'; const isExpanded = expandedProjects[project.id];
                const cols = project.sidebarColumns || 1;
                const containerClasses = isDoc 
                        ? `transition-all duration-200 border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 ${isActive ? 'bg-white dark:bg-zinc-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}` 
                        : `Galmuri14-[3px] mb-1 transition-all duration-300 ${isActive 
                            ? 'bg-white shadow-md border-2 border-indigo-200 dark:bg-zinc-700 dark:border-indigo-500' 
                            : 'bg-slate-50 border border-slate-200 dark:bg-zinc-800 dark:border-zinc-700' 
                        }`;
                    
                return (
                    <div key={project.id} className={containerClasses}>
                        <div onClick={() => handleSelectProject(project.id)} onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }} className={`flex items-center px-4 cursor-pointer group relative overflow-hidden ${isDoc ? 'h-[30px] py-0' : 'py-2.5'}`}>
                            {isActive && <div className={`absolute left-0 top-0 bottom-0 ${isDoc ? 'w-[3px]' : 'w-1'} bg-indigo-600 dark:bg-indigo-500`} />}
                            <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                <span onClick={(e) => !isDoc && toggleProjectFolder(project.id, e)} className={`${isDoc ? 'text-sm opacity-50' : 'text-base'} shrink-0 dark:text-zinc-300`}>{isDoc ? 'ğŸ“„' : (isExpanded ? 'ğŸ“‚' : 'ğŸ“')}</span>
                                {editingProjectId === project.id ? ( <input autoFocus className="w-full bg-white border border-indigo-400 Galmuri14-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white" defaultValue={project.name} onBlur={(e) => handleProjectRename(project.id, e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)} /> ) : (
                                    <div className="flex items-center min-w-0 flex-1 justify-between">
                                            <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                            {isExpanded && !isDoc && (
                                                <div className="flex items-center gap-0.5 bg-slate-200 dark:bg-zinc-900 p-0.5 rounded-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                    {[1, 2, 3].map(col => (
                                                        <button
                                                            key={col}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setSidebarCols(project.id, col);
                                                            }}
                                                            className={`w-5 h-5 flex items-center justify-center text-[10px] font-black rounded-sm transition-colors ${
                                                                cols === col
                                                                    ? 'bg-white dark:bg-zinc-700 text-indigo-600 dark:text-white shadow-sm'
                                                                    : 'text-slate-400 hover:bg-white/50 dark:text-zinc-500 dark:hover:bg-zinc-700/50'
                                                            }`}
                                                            title={`${col}ì—´ ë³´ê¸°`}
                                                        >
                                                            {col}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="flex items-center shrink-0">
                                                {isDoc && <span className={`text-[8px] font-black px-1.5 py-0.5 Galmuri14-[3px] ${getStatusBadgeStyle(project.status || 'ì´ˆê³ ')}`}>{project.status || 'ì´ˆê³ '}</span>}
                                                <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                            </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        {!isDoc && (
                            <AnimatePresence>
                                {(isExpanded && project.type === 'board') && (
                                    <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} className="overflow-hidden bg-slate-50/30 Galmuri14-b-[3px] border-slate-100 dark:bg-zinc-800/30 dark:border-zinc-700">
                                            <div className="pb-3 px-3 space-y-3 pt-2">
                                                {(() => {
                                                    const cols = project.sidebarColumns || 1;
                                                    return ['ì¸ë¬¼', 'ì‚¬ê±´', 'ë©”ëª¨'].map(type => {
                                                        const filtered = (project.nodes || []).filter(n => n.type === type); if (filtered.length === 0) return null;
                                                        return (
                                                            <div key={type} className="pl-1">
                                                                <div className="text-[9px] font-black text-slate-400 mb-1.5 px-2 uppercase tracking-tighter flex items-center gap-2"><span className="w-1 h-1 bg-slate-300 Galmuri14-[3px] dark:bg-zinc-600"></span>{type}</div>
                                                                {cols === 1 ? (
                                                                    <Reorder.Group axis="y" values={filtered} onReorder={(newOrder) => handleReorderNodes(type, newOrder)} className="space-y-1">
                                                                    {filtered.map(n => (
                                                                        <Reorder.Item
                                                                            key={n.id}
                                                                            value={n}
                                                                            initial={{ opacity: 0 }}
                                                                            animate={{ opacity: 1 }}
                                                                            exit={{ opacity: 0 }}
                                                                            layout
                                                                            layoutId={n.id}
                                                                            dragElastic={1}
                                                                            whileDrag={{ scale: 1.05, boxShadow: '0 10px 25px rgba(0,0,0,0.25)', zIndex: 100 }}
                                                                            transition={{ type: 'spring', stiffness: 400, damping: 30 }}
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleSelectProject(project.id);
                                                                                setHighlightedNodeId(n.id);
                                                                                setPan({
                                                                                    x: -(n.x + CARD_W/2)*scale + (window.innerWidth - 320)/2,
                                                                                    y: -(n.y + CARD_H/2)*scale + window.innerHeight/2
                                                                                });
                                                                            }}
                                                                            onDoubleClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setHighlightedNodeId(null);
                                                                                setSelectedNodeId(n.id);
                                                                            }}
                                                                            className={`group/node py-1.5 px-3 bg-white hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-zinc-600 Galmuri14-[3px] flex items-center justify-between gap-2 cursor-grab active:cursor-grabbing shadow-sm transition-colors border-l-4 dark:bg-zinc-700 dark:border-zinc-600 ${getSidebarItemAccent(n)} ${(highlightedNodeId === n.id || selectedNodeId === n.id) ? `border-2 ${getSelectedBorderColor(n)}` : 'border-2 border-slate-200 dark:border-zinc-600'}`}
                                                                        >
                                                                            <div className="flex items-center gap-2 min-w-0 flex-1">
                                                                                <span className="text-xs shrink-0">{n.data.emoji}</span>
                                                                                <span className="text-[11px] font-bold text-slate-600 truncate dark:text-zinc-300">{n.label}</span>
                                                                            </div>
                                                                            <div className="flex items-center shrink-0">
                                                                                {n.type === 'ì¸ë¬¼' && (
                                                                                    <span className={`text-[8px] font-black px-1.5 py-0.5 Galmuri14-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                                        {n.data.role}
                                                                                    </span>
                                                                                )}
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        if(confirm(`'${n.label}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) deleteNode(n.id);
                                                                                    }}
                                                                                    className="w-0 opacity-0 group-hover/node:w-5 group-hover/node:opacity-100 group-hover/node:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"
                                                                                >
                                                                                    <IconTrash className="w-3 h-3" />
                                                                                </button>
                                                                            </div>
                                                                        </Reorder.Item>
                                                                    ))}
                                                                    </Reorder.Group>
                                                                ) : (
                                                                    <div className={`grid gap-1 ${cols === 3 ? 'grid-cols-3' : cols === 2 ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                                                    {filtered.map(n => (
                                                                        <div
                                                                            key={n.id}
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleSelectProject(project.id);
                                                                                setHighlightedNodeId(n.id);
                                                                                setPan({
                                                                                    x: -(n.x + CARD_W/2)*scale + (window.innerWidth - 320)/2,
                                                                                    y: -(n.y + CARD_H/2)*scale + window.innerHeight/2
                                                                                });
                                                                            }}
                                                                            onDoubleClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setHighlightedNodeId(null);
                                                                                setSelectedNodeId(n.id);
                                                                            }}
                                                                            className={`group/node py-1.5 px-2 bg-white hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-zinc-600 Galmuri14-[3px] flex items-center gap-1.5 cursor-pointer shadow-sm transition-colors border-l-4 dark:bg-zinc-700 dark:border-zinc-600 ${getSidebarItemAccent(n)} ${(highlightedNodeId === n.id || selectedNodeId === n.id) ? `border-2 ${getSelectedBorderColor(n)}` : 'border-2 border-slate-200 dark:border-zinc-600'}`}
                                                                        >
                                                                            <span className="text-xs shrink-0">{n.data.emoji}</span>
                                                                            <span className="text-[10px] font-bold text-slate-600 truncate dark:text-zinc-300 flex-1 min-w-0">{n.label}</span>
                                                                            {cols === 2 && n.type === 'ì¸ë¬¼' && n.data.role && (
                                                                                <span className={`text-[7px] font-black px-1 py-0.5 Galmuri14-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                                    {n.data.role}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                    </div>
                                                                )}
                                                        </div>
                                                    );
                                                });
                                                })()}
                                            </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        )}
                    </div>
                );
            };

            if (!activeProject) return null;

            return (
                <div className={`flex w-screen h-screen no-drag transition-colors duration-500 ${(activeProject.type === 'board') ? 'grid-background' : 'dot-background'} ${(isPanning || draggingNodeId) ? 'is-dragging' : ''}`} onMouseMove={handleGlobalMouseMove} onMouseUp={handleGlobalMouseUp} onTouchMove={handleGlobalTouchMove} onTouchEnd={handleGlobalTouchEnd} onContextMenu={e => e.preventDefault()}>
                    <aside className={`h-full bg-[#f8fafc] border-r border-slate-200 z-[100] flex flex-col shadow-2xl overflow-hidden dark:bg-[#0f0f10] dark:border-zinc-800 transition-all duration-500 ease-in-out ${isZenMode ? 'w-0 -translate-x-full opacity-0' : 'w-80 opacity-100'}`}>
                        
                        <div className="w-full bg-slate-800 border-b border-slate-900 dark:border-#e2e8f0">
                            <button onClick={onExit} className="w-full py-2 px-5 flex items-center gap-3 group transition-all duration-300">
                                <div className="w-4 h-4 Galmuri14-full bg-white/10 flex items-center justify-center group-hover:text-slate-200 transition-all border border-slate-400">
                                    <IconBack className="w-4 h-4 text-slate-400 group-hover:text-slate-200" />
                                </div>
                                <div className="flex flex-col items-start dark:hover:bg-zinc-800/80">
                                    <span className="text-[12px] text-slate-400 tracking-tight group-hover:text-slate-200">ë‚´ ì„œì¬ë¡œ ëŒì•„ê°€ê¸°</span>
                                </div>
                            </button>
                        </div>

                        <div className="px-6 pt-6 pb-5 bg-white dark:bg-[#161618] border-b border-slate-200/60 dark:border-zinc-800/60">
                            <div className="text-left">
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="text-[9px] font-black px-2 py-0.5 bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-500 Galmuri14-[2px] tracking-widest uppercase border border-slate-200/50 dark:border-zinc-700/30">Novel project</span>
                                </div>
                                
                                {isEditingTitle ? ( 
                                    <input 
                                        ref={titleInputRef} 
                                        className="w-full text-2xl font-black text-slate-900 tracking-tighter leading-tight bg-slate-50 p-2 Galmuri14 border-b-2 border-slate-800 outline-none dark:bg-zinc-800 dark:text-white" 
                                        value={currentBook.title} 
                                        onChange={(e) => onUpdateBook({...currentBook, title: e.target.value})} 
                                        onBlur={() => setIsEditingTitle(false)} 
                                        onKeyDown={(e) => e.key === 'Enter' && setIsEditingTitle(false)} 
                                    /> 
                                ) : ( 
                                    <h1 
                                        onDoubleClick={() => setIsEditingTitle(true)} 
                                        className="text-2xl font-black text-slate-800 dark:text-zinc-100 tracking-tighter leading-tight cursor-pointer hover:text-slate-500 dark:hover:text-zinc-400 transition-colors"
                                        title="ë”ë¸”í´ë¦­í•˜ì—¬ ì œëª© ìˆ˜ì •"
                                    >
                                        {currentBook.title}
                                    </h1> 
                                )}
                                
                                <div className="flex items-center gap-2 mt-2 opacity-60"> 
                                    <span className="text-[11px] font-bold text-slate-500 dark:text-zinc-400 tracking-wide">
                                        {currentBook.author || 'ì‘ê°€ ë¯¸ìƒ'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className="p-3 bg-white/50 border-b border-slate-200 flex gap-2 dark:bg-darkpanel/50 dark:border-darkborder">
                            <button onClick={createNewProject} className="flex-1 py-2.5 bg-indigo-600 text-white text-[10px] font-black Galmuri14-[3px] hover:bg-indigo-700 transition-all shadow-md tracking-widest dark:bg-indigo-700 dark:hover:bg-indigo-600">+ ìƒˆ ë³´ë“œ</button>
                            <button onClick={createNewDoc} className="flex-1 py-2.5 bg-slate-800 text-white text-[10px] font-black Galmuri14-[3px] hover:bg-slate-900 transition-all shadow-md tracking-widest dark:bg-zinc-700 dark:hover:bg-zinc-600">+ ìƒˆ ë¬¸ì„œ</button>
                        </div>
                        <div className="flex-1 overflow-y-auto px-3 pt-4 custom-scroll pb-10">
                            <div className="mb-5">
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2 flex items-center gap-2"><span className="w-1.5 h-1.5 bg-indigo-500 Galmuri14-full"></span> ì•„ì´ë””ì–´ ë³´ë“œ</div>
                                <div className="space-y-1">{projects.filter(p => p.type === 'board').map(project => renderProjectItem(project))}</div>
                            </div>
                            <div className="px-2 mb-4"><hr className="border-t border-slate-200 dark:border-zinc-700" /></div>
                            <div>
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2 flex items-center gap-2"><span className="w-1.5 h-1.5 bg-indigo-500 Galmuri14-full"></span> ë¬¸ì„œí•¨</div>
                                <Reorder.Group axis="y" values={projects.filter(p => p.type === 'doc')} onReorder={handleReorderDocs} className="space-y-0 border-t border-slate-200/50 dark:border-zinc-700/50">
                                    {projects.filter(p => p.type === 'doc').map(project => {
                                        const isActive = activeProjectId === project.id;
                                        return (
                                            <Reorder.Item
                                                key={project.id}
                                                value={project}
                                                initial={{ opacity: 0 }}
                                                animate={{ opacity: 1 }}
                                                exit={{ opacity: 0 }}
                                                layout
                                                layoutId={`doc-${project.id}`}
                                                dragElastic={1}
                                                whileDrag={{ scale: 1.05, boxShadow: '0 10px 25px rgba(0,0,0,0.25)', zIndex: 100 }}
                                                transition={{ type: 'spring', stiffness: 400, damping: 30 }}
                                                onClick={() => handleSelectProject(project.id)}
                                                onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }}
                                                className={`border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 cursor-grab active:cursor-grabbing ${isActive ? 'bg-white dark:bg-zinc-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}`}
                                            >
                                                <div className="flex items-center px-4 h-[30px] py-0 group relative overflow-hidden">
                                                    {isActive && <div className="absolute left-0 top-0 bottom-0 w-[3px] bg-indigo-600 dark:bg-indigo-500" />}
                                                    <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                                        <span className="text-sm opacity-50 shrink-0 dark:text-zinc-300">ğŸ“„</span>
                                                        {editingProjectId === project.id ? (
                                                            <input
                                                                autoFocus
                                                                className="w-full bg-white border border-indigo-400 Galmuri14-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white"
                                                                defaultValue={project.name}
                                                                onBlur={(e) => handleProjectRename(project.id, e.target.value)}
                                                                onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                        ) : (
                                                            <div className="flex items-center min-w-0 flex-1 justify-between">
                                                                <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                                                <div className="flex items-center shrink-0">
                                                                    <span className={`text-[8px] font-black px-1.5 py-0.5 Galmuri14-[3px] ${getStatusBadgeStyle(project.status || 'ì´ˆê³ ')}`}>{project.status || 'ì´ˆê³ '}</span>
                                                                    <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </Reorder.Item>
                                        );
                                    })}
                                </Reorder.Group>
                            </div>
                        </div>
                    </aside>

                    <main className={`flex-1 relative overflow-hidden transition-all duration-500 ease-in-out ${activeProject.type === 'board' ? (isPanning ? 'cursor-grabbing' : draggingNodeId ? 'cursor-grabbing' : 'cursor-grab') : ''}`} ref={containerRef} onMouseDown={(e) => { if(activeProject.type === 'board') { lastMousePos.current = { x: e.clientX, y: e.clientY }; if (e.button === 0) setIsPanning(true); } }}>
                        {activeProject.type === 'board' ? (
                            <>
                                <div className="absolute top-6 left-6 z-[80] flex items-center gap-3">
                                    <div className="h-10 px-5 bg-white shadow-lg border border-slate-200 Galmuri14-[3px] flex items-center gap-2 dark:bg-darkpanel dark:border-darkborder dark:text-white"><span className="w-2 h-2 bg-indigo-500 Galmuri14-[3px] animate-pulse"></span><span className="text-xs font-black text-slate-800 uppercase tracking-widest dark:text-zinc-200">{activeProject.name}</span></div>
                                    <div className="flex items-center gap-1 p-1 bg-white Galmuri14-[3px] shadow-lg border border-slate-200 h-10 dark:bg-darkpanel dark:border-darkborder">
                                        <button onClick={() => addNode('ì¸ë¬¼')} className="flex items-center gap-2 h-full px-4 Galmuri14-[3px] hover:bg-indigo-50 text-indigo-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-indigo-400"><div className="w-5 h-5 flex items-center justify-center bg-indigo-500 Galmuri14-[3px] text-white group-hover:scale-110 transition-transform"><IconPlus className="w-3 h-3" /></div><span className="text-[11px] font-black">ì¸ë¬¼</span></button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('ì‚¬ê±´')} className="flex items-center gap-2 h-full px-4 Galmuri14-[3px] hover:bg-rose-50 text-rose-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-rose-400"><div className="w-5 h-5 flex items-center justify-center bg-rose-500 Galmuri14-[3px] text-white group-hover:scale-110 transition-transform"><IconPlus className="w-3 h-3" /></div><span className="text-[11px] font-black">ì‚¬ê±´</span></button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('ë©”ëª¨')} className="flex items-center gap-2 h-full px-4 Galmuri14-[3px] hover:bg-amber-50 text-amber-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-amber-400"><div className="w-5 h-5 flex items-center justify-center bg-amber-500 Galmuri14-[3px] text-white group-hover:scale-110 transition-transform"><IconPlus className="w-3 h-3" /></div><span className="text-[11px] font-black">ë©”ëª¨</span></button>
                                    </div>
                                </div>

                                <div className="absolute bottom-8 right-8 z-[100] flex flex-col bg-white shadow-2xl border border-slate-200 Galmuri14-[3px] overflow-hidden text-slate-600 font-bold dark:bg-darkpanel dark:border-darkborder dark:text-zinc-300">
                                    <button 
                                        onClick={() => handleAutoLayout()} 
                                        className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700 border-b border-slate-100 dark:border-zinc-700"
                                        title="ìë™ ì •ë ¬ (Auto Layout)"
                                    >
                                        <IconLayout className="w-5 h-5 text-slate-500 dark:text-zinc-400" />
                                    </button>
                                    <button 
                                        onClick={() => fitToScreen()} 
                                        className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700 border-b border-slate-100 dark:border-zinc-700"
                                        title="í™”ë©´ ì¤‘ì•™ ë§ì¶¤"
                                    >
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="scale-75">
                                            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                                        </svg>
                                    </button>
                                    <button onClick={() => setScale(prev => Math.min(prev + 0.1, 3))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700">+</button>
                                    <div className="py-2 text-[9px] font-black text-slate-400 border-y border-slate-50 text-center bg-slate-50/50 dark:bg-zinc-800/50 dark:border-zinc-700">{Math.round(scale * 100)}%</div>
                                    <button onClick={() => setScale(prev => Math.max(prev - 0.1, 0.1))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700">-</button>
                                </div>

                                <div className="zoom-container w-full h-full" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}>
                                    <svg className="canvas-svg">
                                        <defs><marker id="arrow-event" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444" /></marker></defs>
                                        {visibleEdges.map(edge => {
                                            const from = findNode(edge.from); const to = findNode(edge.to); if (!from || !to) return null;
                                            let x1 = from.x + CARD_W/2, y1 = from.y + CARD_H/2, x2 = to.x + CARD_W/2, y2 = to.y + CARD_H/2;
                                            const isEventToEvent = from.type === 'ì‚¬ê±´' && to.type === 'ì‚¬ê±´'; 
                                            const isIdeaInvolved = from.type === 'ë©”ëª¨' || to.type === 'ë©”ëª¨';
                                            const isPersonToEvent = (from.type === 'ì¸ë¬¼' && to.type === 'ì‚¬ê±´') || (from.type === 'ì‚¬ê±´' && to.type === 'ì¸ë¬¼');
                                            const isPersonToPerson = from.type === 'ì¸ë¬¼' && to.type === 'ì¸ë¬¼';
                                            let pathData = isEventToEvent ? `M ${x1} ${y1} L ${getEdgeTargetPos(from, to, 12).x} ${getEdgeTargetPos(from, to, 12).y}` : getBezierPath(x1, y1, x2, y2);
                                            let edgeColor = isIdeaInvolved ? "#facc15" : isPersonToEvent ? "#3b82f6" : isPersonToPerson ? "#93c5fd" : "#ef4444";
                                            const strokeWidth = edge.width || (isPersonToEvent ? 12 : isEventToEvent ? 4 : 2);
                                            const strokeDash = edge.style ? getStrokeDashArray(edge.style) : (isIdeaInvolved ? "8, 6" : "");
                                            const labelWidth = Math.max(70, (edge.label || "").length * 10 + 20);
                                            return (
                                                <g key={edge.id}>
                                                    <path d={pathData} className="edge-hitbox" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }} onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); saveHistory(); updateActiveProject(null, prev => prev.filter(ev => ev.id !== edge.id)); }} />
                                                    <path d={pathData} stroke={edgeColor} strokeWidth={strokeWidth} markerEnd={isEventToEvent ? "url(#arrow-event)" : ""} strokeDasharray={strokeDash} className="edge-path opacity-80" />
                                                    {isPersonToPerson && (
                                                        <g className="cursor-pointer pointer-events-auto" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }}>
                                                            <rect x={(x1+x2)/2 - labelWidth/2} y={(y1+y2)/2-12} width={labelWidth} height="24" rx="3" fill="white" stroke={edgeColor} strokeWidth="1.5" className="dark:fill-zinc-800" /><text x={(x1+x2)/2} y={(y1+y2)/2+4} textAnchor="middle" fontSize="11" fontWeight="900" fill="#334155" className="dark:fill-zinc-200">{edge.label}</text>
                                                        </g>
                                                    )}
                                                </g>
                                            );
                                        })}
                                        {tempEdge && <line x1={findNode(tempEdge.fromId).x + CARD_W/2} y1={findNode(tempEdge.fromId).y + CARD_H/2} x2={tempEdge.toX} y2={tempEdge.toY} stroke="#94a3b8" strokeWidth="2" strokeDasharray="4,4" />}
                                    </svg>
                                    {visibleNodes.map(node => (
                                        <NodeCard key={node.id} node={node} isTop={topNodeId === node.id} isSelected={highlightedNodeId === node.id || selectedNodeId === node.id} isDragging={draggingNodeId === node.id} onNodeDragStart={(e, id) => { e.stopPropagation(); setDraggingNodeId(id); setTopNodeId(id); }} onMouseDown={(e, id) => { if (e.button === 2) { const c = getCanvasCoords(e.clientX, e.clientY); setTempEdge({ fromId: id, toX: c.x, toY: c.y }); } }} onMouseUp={(e, id) => { if (tempEdge && id !== tempEdge.fromId) { saveHistory(); hasConnectedRef.current = true; updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: id, label: 'ê´€ê³„' }]); } }} onTouchStart={handleNodeTouchStart} onTouchEnd={handleNodeTouchEnd} onClick={setHighlightedNodeId} onDoubleClick={(id) => { setHighlightedNodeId(null); setSelectedNodeId(id); }} onDelete={deleteNode} />
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div className={`w-full h-full overflow-y-auto custom-scroll transition-all duration-500 ease-in-out ${isZenMode ? 'px-0' : 'px-10'}`}>
                                <div className="fixed top-6 right-10 z-[110] flex gap-2">
                                    <button onClick={() => setIsZenMode(!isZenMode)} className={`flex items-center gap-2 px-4 py-2 Galmuri14-full text-[11px] font-black tracking-widest transition-all shadow-xl border ${isZenMode ? 'bg-indigo-600 text-white border-indigo-500 scale-110 shadow-indigo-500/20' : 'bg-white text-slate-400 border-slate-200 hover:text-indigo-600 dark:bg-zinc-800 dark:border-zinc-700'}`}>
                                        <IconZen className={`w-4 h-4 ${isZenMode ? 'animate-spin' : ''}`} style={{ animationDuration: '3s' }} />
                                        {isZenMode ? 'ì§‘ì¤‘ëª¨ë“œ' : 'ì§‘ì¤‘ëª¨ë“œ'}
                                    </button>
                                </div>
                                <motion.div layout className="editor-paper relative" style={{ boxShadow: isZenMode ? '0 0 0 15px rgba(0,0,0,0.05), 0 20px 50px rgba(0,0,0,0.1)' : '' }}>
                                    <div className="editor-title-container">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest"> {isZenMode ? 'Focus Mode' : 'DOC TITLE'} </span>
                                            <div className={`flex bg-slate-100 p-1 Galmuri14-[3px] gap-1 dark:bg-zinc-700 transition-opacity ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                                {['ì´ˆê³ ', 'ìˆ˜ì •', 'ì™„ë£Œ'].map(status => ( <button key={status} onClick={() => setProjects(prev => prev.map(p => p.id === activeProject.id ? {...p, status} : p))} className={`px-3 py-1 text-[10px] font-black Galmuri14-[3px] transition-all ${(activeProject.status || 'ì´ˆê³ ') === status ? (status === 'ì™„ë£Œ' ? 'bg-emerald-600 text-white' : 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-600 dark:text-indigo-300') : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300'}`}>{status}</button> ))}
                                            </div>
                                        </div>
                                        <input className="w-full text-2xl font-black text-slate-800 outline-none border-b-2 border-slate-100 focus:border-indigo-400 pb-2 transition-all dark:text-zinc-200 dark:border-zinc-700 dark:focus:border-indigo-500 dark:bg-transparent" value={activeProject.name} onChange={(e) => handleProjectRename(activeProject.id, e.target.value)} placeholder="ë¬¸ì„œ ì œëª©" />
                                    </div>
                                    <textarea ref={textareaRef} className="editor-textarea custom-scroll" value={activeProject.content || ""} onChange={handleDocInput} onKeyDown={handleDocKeyDown} onMouseMove={handleDocMouseMove} onMouseOut={() => setHoverInfo({ ...hoverInfo, visible: false })} placeholder="ì´ê³³ì— ì›¹ì†Œì„¤ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”... (@ì¸ë¬¼ ë˜ëŠ” #ì‚¬ê±´ ì…ë ¥)" />
                                    <div className={`px-[40px] pb-10 transition-all duration-500 ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                        <div className="mt-8 pt-4 border-t border-slate-100 flex flex-col gap-3 dark:border-zinc-700">
                                            <div className="flex justify-between items-end text-[10px] font-black tracking-tighter">
                                                <div className="flex gap-4 items-center">
                                                    <div className="flex flex-col gap-1"><span className="text-slate-400 uppercase">Statistics</span><div className="flex gap-3 text-slate-600 dark:text-zinc-400"><span>ê³µë°± í¬í•¨: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").length.toLocaleString()}</b>ì</span><span>ê³µë°± ì œì™¸: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").replace(/\s+/g, '').length.toLocaleString()}</b>ì</span></div></div>
                                                    <div className="w-px h-6 bg-slate-100 mx-2 dark:bg-zinc-700"></div>
                                                    <div className="flex flex-col gap-1"><span className="text-indigo-400 uppercase">Achievement</span><span className="text-[14px] text-indigo-600 italic dark:text-indigo-400">{Math.min(Math.round(((activeProject.content || "").length / (activeProject.targetCount || 5000)) * 100), 100)}%</span></div>
                                                </div>
                                                <div className="flex flex-col items-end gap-1"><span className="text-slate-400 uppercase">Target Goal</span><div className="flex items-center gap-1.5 bg-slate-50 px-2 py-1 Galmuri14-[3px] border border-slate-100 dark:bg-zinc-700 dark:border-zinc-600"><input type="number" className="w-16 bg-transparent outline-none text-right text-slate-700 font-bold dark:text-zinc-300" value={activeProject.targetCount || 5000} onChange={(e) => { const val = parseInt(e.target.value) || 0; setProjects(prev => prev.map(p => p.id === activeProject.id ? {...p, targetCount: val} : p)); }} /><span className="text-slate-400">ì ëª©í‘œ</span></div></div>
                                            </div>
                                            <div className="w-full h-1.5 bg-slate-100 Galmuri14-[3px] overflow-hidden dark:bg-zinc-700"><motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(((activeProject.content || "").length / (activeProject.targetCount || 5000)) * 100, 100)}%`, backgroundColor: (activeProject.content || "").length >= (activeProject.targetCount || 5000) ? "#10b981" : "#4f46e5" }} className="h-full transition-all duration-500 ease-out Galmuri14-[3px]" /></div>
                                        </div>
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </main>

                    <AnimatePresence>
                        {hoverInfo.visible && (
                            <motion.div initial={{ opacity: 0, y: 5 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} style={{ left: hoverInfo.x, top: hoverInfo.y + 20 }} className="fixed z-[1001] bg-white dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 p-3 Galmuri14-[3px] shadow-2xl pointer-events-none min-w-[200px]">
                                <div className="flex items-center gap-2 mb-1"> <span className="text-lg">{hoverInfo.node.data.emoji}</span> <span className="font-black text-slate-800 dark:text-zinc-100">{hoverInfo.node.label}</span> </div>
                                <div className="text-[10px] text-slate-400 font-bold uppercase mb-2">{hoverInfo.node.projectName} Â· {hoverInfo.node.type}</div>
                                
                                {hoverInfo.node.type === 'ì‚¬ê±´' && (
                                    <div className="mb-2 text-[11px] font-bold text-rose-500">
                                        ğŸ“ {hoverInfo.node.data.place || 'ë¯¸ì •'} Â· ğŸ“… {hoverInfo.node.data.year || 'ë¯¸ì •'}
                                    </div>
                                )}

                                <div className="text-[11px] text-slate-600 dark:text-zinc-400 line-clamp-3 leading-relaxed">{hoverInfo.node.data.memo || "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {mention.active && (
                            <div className="mention-list" style={{ top: mention.y, left: mention.x }}>
                                <div className="w-[250px] flex flex-col border-r border-slate-100 dark:border-zinc-700">
                                    <div className="p-2 bg-slate-50 dark:bg-zinc-800 text-[9px] font-black text-slate-400 tracking-widest uppercase border-b border-slate-100 dark:border-zinc-700">List</div>
                                    <div className="flex-1 overflow-y-auto custom-scroll">
                                        {filteredMentionNodes.length > 0 ? filteredMentionNodes.map((node, i) => (
                                            <div key={node.id} 
                                                onClick={() => insertMention(node)} 
                                                onMouseEnter={() => setMention(prev => ({...prev, selectedIndex: i}))}
                                                className={`flex items-center px-3 h-[38px] cursor-pointer transition-colors border-l-4 ${
                                                    mention.selectedIndex === i 
                                                    ? 'mention-item-active' 
                                                    : 'hover:bg-slate-50 dark:hover:bg-zinc-800 border-l-transparent'
                                                }`}
                                            >
                                                {/* ì¢Œì¸¡: ì´ëª¨ì§€ ë° ì´ë¦„ (ë†’ì´ ê³ ì •ìœ¼ë¡œ ì¸í•´ ì„¸ë¡œ ì¤‘ì•™ ìë™ ì •ë ¬) */}
                                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                                    <span className="text-sm shrink-0 leading-none">{node.data.emoji}</span>
                                                    <div className="flex items-baseline gap-2 truncate">
                                                        <span className="font-black text-xs text-slate-800 dark:text-zinc-100 shrink-0">
                                                            {node.label}
                                                        </span>
                                                        <span className="text-[9px] text-slate-400 font-bold truncate opacity-80">
                                                            / {node.projectName}
                                                        </span>
                                                    </div>
                                                </div>

                                                {/* ìš°ì¸¡: ì¸ë¬¼ì¼ ê²½ìš° ë°°ì§€ í‘œì‹œ, ì‚¬ê±´ì¼ ê²½ìš° ë¹ˆ ê³µê°„ ìœ ì§€ (ë†’ì´ ë’¤í‹€ë¦¼ ë°©ì§€) */}
                                                <div className="shrink-0 ml-2 flex items-center h-full">
                                                    {node.type === 'ì¸ë¬¼' ? (
                                                        <span className={`text-[8px] font-black px-1.5 py-0.5 Galmuri14-[2px] rounded-sm shadow-sm leading-none ${getRoleBadgeStyle(node.data.role)}`}>
                                                            {node.data.role}
                                                        </span>
                                                    ) : (
                                                        /* ì‚¬ê±´ì¼ ë•ŒëŠ” ë°°ì§€ê°€ ì—†ì–´ë„ ë†’ì´ë¥¼ ìœ ì§€í•˜ë„ë¡ ë¹ˆ ê³µê°„ í™•ë³´ */
                                                        <div className="w-1 h-4"></div>
                                                    )}
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="p-4 text-[10px] text-slate-400 italic text-center">ê²°ê³¼ ì—†ìŒ</div>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-1 flex flex-col bg-white dark:bg-zinc-900 p-5 overflow-hidden Galmuri14-r-[3px]">
                                    {filteredMentionNodes[mention.selectedIndex] ? (
                                        <>
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className="text-2xl">{filteredMentionNodes[mention.selectedIndex].data.emoji}</span>
                                                <div className="flex items-center gap-2">
                                                    <div className="font-black text-slate-800 dark:text-zinc-100">{filteredMentionNodes[mention.selectedIndex].label}</div>
                                                </div>
                                            </div>
                                            <div className="text-2xs text-slate-500 dark:text-zinc-400 leading-relaxed overflow-y-auto custom-scroll pr-2">
                                                {filteredMentionNodes[mention.selectedIndex].type === 'ì¸ë¬¼' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-indigo-500">
                                                        <span>ì„±ë³„: {filteredMentionNodes[mention.selectedIndex].data.gender}</span>
                                                        <span>ë‚˜ì´: {filteredMentionNodes[mention.selectedIndex].data.age || 'ë¯¸ì •'}</span>
                                                        <span>ì§ì—…: {filteredMentionNodes[mention.selectedIndex].data.job || 'ë¯¸ì •'}</span>
                                                        <span>ì¢…ì¡±: {filteredMentionNodes[mention.selectedIndex].data.race || 'ì¸ê°„'}</span>
                                                    </div>
                                                )}
                                                
                                                {filteredMentionNodes[mention.selectedIndex].type === 'ì‚¬ê±´' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-rose-500">
                                                        <span>ì¥ì†Œ: {filteredMentionNodes[mention.selectedIndex].data.place || 'ë¯¸ì •'}</span>
                                                        <span>ì‹œê¸°: {filteredMentionNodes[mention.selectedIndex].data.year || 'ë¯¸ì •'}</span>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].data.memo || "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}
                                            </div>
                                        </>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center text-slate-300 dark:text-zinc-700 text-xs italic">ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {activeNode && (
                            <>
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="fixed inset-0 bg-black/20 z-[199]"
                                    onClick={() => { setSelectedNodeId(null); setHighlightedNodeId(null); }}
                                />
                                <motion.div
                                    initial={{ x: '100%' }}
                                    animate={{ x: 0 }}
                                    exit={{ x: '100%' }}
                                    transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                                    className="fixed top-0 right-0 h-full w-[420px] bg-white dark:bg-darkpanel shadow-2xl z-[200] flex flex-col border-l border-slate-200 dark:border-zinc-700"
                                >
                                    {/* í—¤ë” */}
                                    <div className="h-16 px-6 flex items-center justify-between border-b border-slate-200 dark:border-zinc-700 shrink-0">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">{activeNode.data.emoji}</span>
                                            <div>
                                                <h2 className="text-sm font-black text-slate-800 dark:text-zinc-100">{activeNode.label}</h2>
                                                <span className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">{activeNode.type} í¸ì§‘</span>
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedNodeId(null)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 rounded-sm transition-colors">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                        </button>
                                    </div>

                                    {/* ì»¨í…ì¸  */}
                                    <div className="flex-1 overflow-y-auto p-6 custom-scroll">
                                        <div className="space-y-5">
                                            {/* ì¸ë¬¼ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì¸ë¬¼' && (
                                                <>
                                                    {/* ì—­í•  + ì´ëª¨ì§€ + ì´ë¦„ */}
                                                    <div className="flex gap-3">
                                                        <div className="w-28">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì—­í• </label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-black text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.role} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, role: e.target.value}} : n))}>
                                                                <option value="ì£¼ì¸ê³µ">ğŸ˜ ì£¼ì¸ê³µ</option>
                                                                <option value="ì¡°ë ¥ì">ğŸ˜ ì¡°ë ¥ì</option>
                                                                <option value="ì ëŒ€ì">ğŸ˜¡ ì ëŒ€ì</option>
                                                                <option value="ì¡°ì—°">ğŸ¤“ ì¡°ì—°</option>
                                                                <option value="ì—‘ìŠ¤íŠ¸ë¼">ğŸ¥¸ ì—‘ìŠ¤íŠ¸ë¼</option>
                                                            </select>
                                                        </div>
                                                        <div className="w-16">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ëª¨ì§€</label>
                                                            <input className="w-full mt-1 px-2 py-2 bg-slate-50 Galmuri14-[3px] text-center text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ë¦„</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-black text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} />
                                                        </div>
                                                    </div>
                                                    {/* ì„±ë³„ + ë‚˜ì´ + ì§ì—… + ì¢…ì¡± */}
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì„±ë³„</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.gender} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, gender: e.target.value}} : n))}>
                                                                <option value="ë‚¨ì">ë‚¨ì</option>
                                                                <option value="ì—¬ì">ì—¬ì</option>
                                                                <option value="ì¤‘ì„±">ì¤‘ì„±</option>
                                                                <option value="ë¯¸ì§€ì •">ë¯¸ì§€ì •</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë‚˜ì´</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.age} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, age: e.target.value}} : n))} placeholder="ë‚˜ì´" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì§ì—…</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.job} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, job: e.target.value}} : n))} placeholder="ì§ì—… ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì¢…ì¡±</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.race || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, race: e.target.value}} : n))} placeholder="ì¢…ì¡± ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ì‚¬ê±´/ë©”ëª¨: ì´ëª¨ì§€ + ì´ë¦„ */}
                                            {activeNode.type !== 'ì¸ë¬¼' && (
                                                <div className="flex gap-3">
                                                    <div className="w-20">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ëª¨ì§€</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] text-center text-xl border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ë¦„</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-black text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} />
                                                    </div>
                                                </div>
                                            )}

                                            {/* ì‚¬ê±´ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì‚¬ê±´' && (
                                                <div className="flex gap-3">
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë°œìƒ ì¥ì†Œ</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.place || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, place: e.target.value}} : n))} placeholder="ì¥ì†Œ ì…ë ¥" />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë°œìƒ ì‹œê¸°</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 Galmuri14-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.year || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, year: e.target.value}} : n))} placeholder="ì‹œê¸°/ì—°ë„ ì…ë ¥" />
                                                    </div>
                                                </div>
                                            )}

                                            {/* ë©”ëª¨ */}
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë©”ëª¨ ë° ì„¸ë¶€ ì„¤ì •</label>
                                                <textarea className="w-full mt-1 h-56 p-4 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all resize-none leading-relaxed dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700" value={activeNode.data.memo} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, memo: e.target.value}} : n))} placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                                            </div>
                                        </div>
                                    </div>

                                    {/* í‘¸í„° */}
                                    <div className="p-6 border-t border-slate-200 dark:border-zinc-700 shrink-0">
                                        <button onClick={() => { saveHistory(); setSelectedNodeId(null); showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"); }} className="w-full py-4 bg-slate-900 text-white font-black hover:bg-indigo-600 transition-all uppercase text-xs tracking-widest Galmuri14-[3px] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500">
                                            ì €ì¥ í›„ ë‹«ê¸°
                                        </button>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {activeEdge && (
                            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-8 Galmuri14-[3px] shadow-2xl w-[420px] relative dark:bg-darkpanel border border-slate-200 dark:border-darkborder">
                                    <button onClick={() => setSelectedEdgeId(null)} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-700 dark:hover:text-zinc-200 transition-colors">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                    </button>
                                    <h2 className="text-sm font-black text-indigo-500 uppercase tracking-widest mb-8 flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-indigo-500 Galmuri14-full"></span> ê´€ê³„ ì„¤ì •
                                    </h2>
                                    <div className="space-y-8">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ê´€ê³„ ë©”ëª¨</label>
                                            <input 
                                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 Galmuri14-[3px] font-bold text-sm outline-none focus:border-indigo-500 focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700/50" 
                                                placeholder="ì˜ˆ: ì—°ì¸, ì ëŒ€ ê´€ê³„, ì¡°ë ¥ì ë“±"
                                                value={activeEdge.label} 
                                                onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, label: e.target.value} : ev))} 
                                            />
                                        </div>
                                        <div className="flex gap-6">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ì„  ì¢…ë¥˜</label>
                                                <select 
                                                    className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 Galmuri14-[3px] font-bold text-xs outline-none cursor-pointer hover:bg-slate-100 transition-colors dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                                                    value={activeEdge.style || 'solid'}
                                                    onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, style: e.target.value} : ev))}
                                                >
                                                    <option value="solid">â”€ ì‹¤ì„  (Solid)</option>
                                                    <option value="dashed">--- ì ì„  (Dashed)</option>
                                                </select>
                                            </div>
                                            <div className="flex-[1.2]">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ì„  êµµê¸°</label>
                                                <div className="flex items-center h-[42px] bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 Galmuri14-[3px] p-1">
                                                    {[2, 4, 6].map(w => (
                                                        <button 
                                                            key={w} 
                                                            onClick={() => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, width: w} : ev))}
                                                            className={`flex-1 h-full flex flex-col items-center justify-center Galmuri14-[2px] transition-all ${ (activeEdge.width || 2) === w ? 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-700 dark:text-indigo-400' : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300' }`}
                                                        >
                                                            <div className="bg-current Galmuri14-full mb-1" style={{ width: w*2, height: 2 }}></div>
                                                            <span className="text-[9px] font-black">{w}px</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => { saveHistory(); setSelectedEdgeId(null); }} 
                                        className="w-full mt-10 py-4 bg-slate-900 text-white font-black Galmuri14-[3px] hover:bg-indigo-600 transition-all uppercase text-[11px] tracking-[0.2em] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500"
                                    >
                                        ì €ì¥ í›„ ë‹«ê¸°
                                    </button>
                                </motion.div>
                            </div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const Library = ({ books, onSelectBook, onCreateBook, onDeleteBook, onUpdateBook, onImport, isDarkMode, toggleDarkMode, fontMode, toggleFont }) => {
            const [modalConfig, setModalConfig] = useState({ isOpen: false, mode: 'create', targetBook: null });

            // FilePanel ìƒíƒœ
            const [filePanel, setFilePanel] = useState({ isOpen: false, mode: 'save' }); // mode: 'save' | 'load'
            const [importData, setImportData] = useState(null);

            const openSavePanel = () => {
                setFilePanel({ isOpen: true, mode: 'save' });
                setImportData(null);
            };

            const openLoadPanel = () => {
                setFilePanel({ isOpen: true, mode: 'load' });
                setImportData(null);
            };

            const closeFilePanel = () => {
                setFilePanel({ isOpen: false, mode: filePanel.mode });
                setImportData(null);
            };

            const handleExportFromPanel = (filename, exportType, password) => {
                const jsonString = JSON.stringify(books);

                if (exportType === 'vel') {
                    // ì•”í˜¸í™” ì €ì¥
                    const encrypted = CryptoJS.AES.encrypt(jsonString, password).toString();
                    const blob = new Blob([encrypted], { type: "text/plain;charset=utf-8" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${filename}.vel`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } else {
                    // ì¼ë°˜ JSON ì €ì¥
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonString);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${filename}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
            };

            const handleFileSelectFromPanel = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    let isEncrypted = false;

                    try {
                        JSON.parse(fileContent);
                        isEncrypted = false;
                    } catch (jsonError) {
                        isEncrypted = true;
                    }

                    setImportData({ content: fileContent, isEncrypted });
                };
                reader.readAsText(file);
            };

            const handleConfirmImportFromPanel = (data, shouldReplace) => {
                if (data && Array.isArray(data)) {
                    onImport(data, shouldReplace);
                } else {
                    alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
                }
            }; 

            // ... ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼ ...
            const handleConfirmModal = (title, author, color) => {
                // (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
                if (modalConfig.mode === 'create') {
                    const newId = generateUUID();
                    const defaultProjectId = generateUUID();
                    const newBook = {
                        id: newId, title, author, color,
                        projects: [{ id: defaultProjectId, type: 'board', name: 'ì•„ì´ë””ì–´ ë³´ë“œ', nodes: [], edges: [] }],
                        activeProjectId: defaultProjectId
                    };
                    onCreateBook(newBook);
                } else {
                    onUpdateBook({ ...modalConfig.targetBook, title, author, color });
                }
                setModalConfig({ isOpen: false, mode: 'create', targetBook: null });
            };

            return (
                <div className="w-screen h-screen flex flex-col bg-[#f1f5f9] dark:bg-darkbg transition-colors duration-300">
                    {modalConfig.isOpen && ( <BookSettingsModal initialData={modalConfig.targetBook} onClose={() => setModalConfig({ isOpen: false, mode: 'create', targetBook: null })} onConfirm={handleConfirmModal} /> )}

                    {/* FilePanel - ë‚´ë¶€ ì°½ */}
                    <AnimatePresence>
                        {filePanel.isOpen && (
                            <>
                                {/* ë°°ê²½ ì˜¤ë²„ë ˆì´ */}
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="fixed inset-0 bg-black/20 z-[99]"
                                    onClick={closeFilePanel}
                                />
                                <FilePanel
                                    isOpen={filePanel.isOpen}
                                    mode={filePanel.mode}
                                    onClose={closeFilePanel}
                                    books={books}
                                    onExport={handleExportFromPanel}
                                    onFileSelect={handleFileSelectFromPanel}
                                    importData={importData}
                                    onConfirmImport={handleConfirmImportFromPanel}
                                />
                            </>
                        )}
                    </AnimatePresence>

                    <header className="h-16 px-8 flex items-center justify-between bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 dark:bg-darkpanel/80 dark:border-darkborder">
                        <div className="flex items-center gap-2"> <div className="w-6 h-6 bg-slate-900 Galmuri14-[3px] dark:bg-zinc-100"></div> <span className="text-lg font-black tracking-tight text-slate-900 dark:text-zinc-100">SAGAK STUDIO</span> </div>
                        <div className="flex items-center gap-3">
                            <button onClick={toggleFont} className="p-2 text-slate-400 hover:text-slate-800 transition-colors bg-slate-100 Galmuri14-[3px] dark:bg-zinc-800 dark:text-zinc-400" title="í°íŠ¸ ë³€ê²½">
                                <IconFont className="w-4 h-4" />
                            </button>
                            <button onClick={toggleDarkMode} className="p-2 text-slate-400 hover:text-slate-800 transition-colors bg-slate-100 Galmuri14-[3px] hover:bg-slate-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:text-zinc-100 dark:hover:bg-zinc-700" title="ë‹¤í¬ ëª¨ë“œ í† ê¸€"> {isDarkMode ? <IconSun className="w-4 h-4" /> : <IconMoon className="w-4 h-4" />} </button>
                            <div className="h-4 w-px bg-slate-300 mx-1 dark:bg-zinc-700"></div>

                            {/* ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ */}
                            <button onClick={openLoadPanel} className={`flex items-center gap-2 px-2 py-2 border text-[11px] font-bold Galmuri14-[3px] transition-all shadow-sm ${filePanel.isOpen && filePanel.mode === 'load' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-700'}`} title="íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°"><IconUpload className="w-3 h-3" /></button>

                            {/* ì €ì¥ ë²„íŠ¼ */}
                            <button onClick={openSavePanel} className={`flex items-center gap-2 px-2 py-2 text-[11px] font-bold Galmuri14-[3px] transition-all shadow-sm ${filePanel.isOpen && filePanel.mode === 'save' ? 'bg-indigo-600 text-white' : 'bg-slate-900 text-white hover:bg-slate-800 dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200'}`} title="ì „ì²´ ì €ì¥"><IconSave className="w-3 h-3" /></button>
                        </div>
                    </header> 
                    <div className="flex-1 overflow-y-auto custom-scroll"> 
                        <div className="max-w-7xl mx-auto p-10 min-h-full flex flex-col">
                            <div className="flex-1">
                                <div className="mb-8 flex items-end justify-between"> 
                                    <div> 
                                        <h2 className="text-3xl font-black text-slate-900 mb-2 dark:text-zinc-100">ë‚´ ì„œì¬</h2> 
                                        <p className="text-sm text-slate-500 font-medium dark:text-zinc-400">ì´ {books.length}ê°œì˜ ì‘í’ˆì´ ìˆìŠµë‹ˆë‹¤.</p> 
                                    </div> 
                                </div> 
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10"> 
                                    {books.map(book => ( <BookCover key={book.id} book={book} onClick={() => onSelectBook(book.id)} onDelete={onDeleteBook} onEdit={(target) => setModalConfig({ isOpen: true, mode: 'edit', targetBook: target })} /> ))} 
                                    <button onClick={() => setModalConfig({ isOpen: true, mode: 'create', targetBook: null })} className="group flex flex-col items-center justify-center gap-4 aspect-[2/3] Galmuri14-[3px] border-2 border-dashed border-slate-300 hover:border-indigo-400 hover:bg-indigo-50 transition-all dark:border-zinc-700 dark:hover:bg-zinc-800/50"> 
                                        <div className="w-12 h-12 Galmuri14-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-all dark:bg-zinc-800 dark:text-zinc-500"> <IconPlus className="w-6 h-6" /> </div> 
                                        <span className="text-sm font-bold text-slate-400 group-hover:text-indigo-600 dark:text-zinc-500 dark:group-hover:text-indigo-400">ìƒˆ ì‘í’ˆ ì¶”ê°€</span> 
                                    </button> 
                                </div> 
                            </div>

                            <footer className="mt-20 pb-6 flex flex-col items-center justify-center gap-1 opacity-30 hover:opacity-100 transition-opacity duration-500">
                                <div className="flex items-center gap-1.5">
                                    <div className="w-3 h-3 bg-slate-400 Galmuri14-[1px] dark:bg-zinc-600 opacity-50"></div>
                                    <span className="text-[10px] font-black tracking-[0.2em] text-slate-500 dark:text-zinc-500 uppercase">
                                        Sagak Studio
                                    </span>
                                </div>
                                <p className="text-[10px] font-bold text-slate-400 dark:text-zinc-600 tracking-wider">
                                    Made by SWISSBUTTER
                                </p>
                            </footer>
                        </div> 
                    </div> 
                </div> 
            ); 
        };

        const App = () => { 
            const [view, setView] = useState('library'); 
            const [books, setBooks] = useState(() => { 
                const saved = localStorage.getItem('sagak_library'); 
                return saved ? JSON.parse(saved) : []; 
            }); 
            const [currentBookId, setCurrentBookId] = useState(null); 
            const [toast, setToast] = useState(null); 
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('theme') === 'dark'); 
            const [fontMode, setFontMode] = useState(() => localStorage.getItem('sagak_font') || 'maruburi');
            const saveTimerRef = useRef(null);
            
            useEffect(() => { 
                if (isDarkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } 
            }, [isDarkMode]); 
            
            const toggleDarkMode = () => setIsDarkMode(prev => !prev); 

            // í°íŠ¸ ë³€ê²½ íš¨ê³¼
            useEffect(() => {
                const fonts = ['font-maruburi', 'font-Ridibatang', 'font-Galmuri14', 'font-pretendard'];
                document.body.classList.remove(...fonts);
                document.body.classList.add(`font-${fontMode}`);
                localStorage.setItem('sagak_font', fontMode);
            }, [fontMode]);

            const toggleFont = () => {
                const modes = ['maruburi', 'Ridibatang', 'Galmuri14', 'pretendard'];
                const nextIndex = (modes.indexOf(fontMode) + 1) % modes.length;
                const nextFont = modes[nextIndex];
                setFontMode(nextFont);
                showToast(`í°íŠ¸ ë³€ê²½: ${nextFont.charAt(0).toUpperCase() + nextFont.slice(1)}`);
            };
            
            useEffect(() => { 
                if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
                saveTimerRef.current = setTimeout(() => {
                    localStorage.setItem('sagak_library', JSON.stringify(books)); 
                }, 1000);
                return () => { if(saveTimerRef.current) clearTimeout(saveTimerRef.current); };
            }, [books]); 
            
            const showToast = useCallback((message, type = 'success') => { 
                setToast({ message, type }); 
                setTimeout(() => setToast(null), 2000); 
            }, []); 
            
            const currentBook = useMemo(() => books.find(b => b.id === currentBookId), [books, currentBookId]); 
            
            const handleUpdateBook = useCallback((updatedBook) => { 
                setBooks(prev => prev.map(b => b.id === updatedBook.id ? updatedBook : b)); 
            }, []); 
            
            return ( 
                <div className="font-sans text-slate-900 bg-[#f1f5f9] min-h-screen dark:bg-darkbg dark:text-zinc-200"> 
                    <AnimatePresence> {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />} </AnimatePresence> 
                    {view === 'library' && ( 
                        <Library 
                            books={books} 
                            onSelectBook={(id) => { setCurrentBookId(id); setView('workspace'); }} 
                            onCreateBook={(newBook) => setBooks([...books, newBook])} 
                            onDeleteBook={(id, e) => { 
                                if (confirm("ì‘í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                                    setBooks(prev => prev.filter(b => b.id !== id)); 
                                    showToast("ì‘í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                                }
                            }}
                            onUpdateBook={handleUpdateBook} 
                            // App ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€
                            onImport={(imported, shouldReplace) => { 
                                if (shouldReplace) {
                                    setBooks(imported); 
                                    showToast("ì„œì¬ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                                } else {
                                    setBooks(prev => [...prev, ...imported]); 
                                    showToast("ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                                }
                            }}
                            isDarkMode={isDarkMode} 
                            toggleDarkMode={toggleDarkMode}
                            fontMode={fontMode}
                            toggleFont={toggleFont}
                        /> 
                    )} 
                    {view === 'workspace' && currentBook && ( 
                        <Workspace currentBook={currentBook} onUpdateBook={handleUpdateBook} onExit={() => setView('library')} showToast={showToast} /> 
                    )} 
                </div> 
            ); 
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
