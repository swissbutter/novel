<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sagak Storm - Creative Thought Engine (Slim 3px)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #f1f5f9; overflow: hidden; user-select: none; }
        .grid-background {
            background-color: #f8fafc;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .canvas-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        .edge-path { fill: none; transition: stroke 0.2s; stroke-linecap: round; }
        .edge-hitbox { fill: none; stroke: transparent; stroke-width: 20; cursor: pointer; pointer-events: stroke; }
        
        /* [ÏàòÏ†ï] Î™®Îì† ÏöîÏÜå ÎùºÏö¥Îìú 3px ÌÜµÏùº */
        .node-glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid #cbd5e1; border-radius: 3px; }
        .node-postit { background-color: #fef9c3; border-radius: 3px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border: 1px solid #fde047; }
        
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .zoom-container { transform-origin: 0 0; will-change: transform; transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1); }
        .is-dragging .zoom-container { transition: none; }
        
        .node-protagonist { border: 4px solid #1560e1; background: #d7e7fc; }
        .node-antagonist { border: 1px solid #c88885; background: #fbdfde; }
        .node-helper { border: 1px solid #7dcb97; background: #d0f7e2; }
        .node-event { border: 2px solid #dc2626; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useMemo, useEffect, memo } = React;
        const { motion, AnimatePresence, Reorder } = window.Motion;

        const CARD_W = 240; 
        const CARD_H = 180;

        const IconPlus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor" className="w-3 h-3">
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        );
        const IconTrash = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor" className="w-3 h-3">
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const getBezierPath = (x1, y1, x2, y2) => {
            const dx = x2 - x1; const dy = y2 - y1;
            const curvature = 0.5; 
            const cx1 = x1 + dx * curvature; const cy1 = y1;
            const cx2 = x2 - dx * curvature; const cy2 = y2;
            return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;
        };

        const getEdgeTargetPos = (from, to, offset = 12) => {
            const x1 = from.x + CARD_W / 2; const y1 = from.y + CARD_H / 2;
            const x2 = to.x + CARD_W / 2;   const y2 = to.y + CARD_H / 2;
            const dx = x2 - x1; const dy = y2 - y1;
            const angle = Math.atan2(dy, dx);
            const absCos = Math.abs(Math.cos(angle)); const absSin = Math.abs(Math.sin(angle));
            let distance = (CARD_W * absSin <= CARD_H * absCos) ? (CARD_W / 2) / absCos : (CARD_H / 2) / absSin;
            return { x: x2 - Math.cos(angle) * (distance + offset), y: y2 - Math.sin(angle) * (distance + offset) };
        };

        const getRoleBadgeStyle = (role) => {
            switch(role) {
                case 'Ï£ºÏù∏Í≥µ': return 'bg-blue-600 text-white';
                case 'Ï†ÅÎåÄÏûê': return 'bg-red-600 text-white';
                case 'Ï°∞Î†•Ïûê': return 'bg-emerald-600 text-white';
                default: return 'bg-slate-100 text-slate-500 border border-slate-200';
            }
        };

        const getSidebarItemAccent = (node) => {
            if (node.type !== 'Ïù∏Î¨º') return 'border-l-transparent';
            switch(node.data.role) {
                case 'Ï£ºÏù∏Í≥µ': return 'border-l-blue-500';
                case 'Ï†ÅÎåÄÏûê': return 'border-l-red-500';
                case 'Ï°∞Î†•Ïûê': return 'border-l-emerald-500';
                default: return 'border-l-slate-300';
            }
        };

        const NodeCard = memo(({ node, isTop, onNodeDragStart, onMouseDown, onMouseUp, onDoubleClick, onDelete }) => {
            const isIdea = node.type === 'Î©îÎ™®';
            let styleClass = isIdea ? "node-postit" : "node-glass";
            if (node.type === 'Ïù∏Î¨º') {
                if (node.data.role === 'Ï£ºÏù∏Í≥µ') styleClass += " node-protagonist";
                else if (node.data.role === 'Ï†ÅÎåÄÏûê') styleClass += " node-antagonist";
                else if (node.data.role === 'Ï°∞Î†•Ïûê') styleClass += " node-helper";
            } else if (node.type === 'ÏÇ¨Í±¥') styleClass += " node-event";

            return (
                <div
                    onMouseDown={(e) => { if (e.button === 0) onNodeDragStart(e, node.id); onMouseDown(e, node.id); }}
                    onMouseUp={(e) => onMouseUp(e, node.id)}
                    onDoubleClick={() => onDoubleClick(node.id)}
                    style={{ 
                        zIndex: isTop ? 50 : 10, 
                        width: CARD_W, 
                        height: CARD_H, 
                        transform: `translate(${node.x}px, ${node.y}px)`, 
                        position: 'absolute', top: 0, left: 0 
                    }}
                    className={`flex flex-col cursor-grab active:cursor-grabbing shadow-lg hover:shadow-xl transition-shadow group relative ${styleClass}`}
                >
                    <button 
                        onClick={(e) => { e.stopPropagation(); if(confirm("Ïù¥ ÎÖ∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) onDelete(node.id); }}
                        className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 rounded-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2"
                    >
                        <IconTrash />
                    </button>

                    <div className="w-full h-full flex flex-col overflow-hidden rounded-[inherit]">
                        {!isIdea && <div className={`h-1.5 w-full shrink-0 ${node.type === 'Ïù∏Î¨º' ? 'bg-blue-600' : node.type === 'ÏÇ¨Í±¥' ? 'bg-red-600' : 'bg-amber-500'}`} />}
                        <div className="flex-1 flex flex-col p-4 overflow-hidden pointer-events-none">
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-[10px] font-black uppercase tracking-widest ${isIdea ? 'text-yellow-800' : 'text-slate-400'}`}>{node.type}</span>
                                {node.type === 'Ïù∏Î¨º' && <span className={`text-[9px] font-bold px-2 py-0.5 rounded-[3px] ${getRoleBadgeStyle(node.data.role)}`}>{node.data.role}</span>}
                            </div>
                            <div className={`text-base font-black truncate mb-1 ${isIdea ? 'text-slate-900' : 'text-slate-800'}`}>
                                <span className="mr-1.5">{node.data.emoji || (node.type === 'Ïù∏Î¨º' ? 'üë§' : node.type === 'ÏÇ¨Í±¥' ? 'üî•' : 'üí°')}</span>
                                {node.label}
                            </div>
                            {node.type === 'Ïù∏Î¨º' && (
                                <div className="text-[11px] text-slate-500 font-bold mb-2">
                                    {node.data.gender} ¬∑ {node.data.age ? `${node.data.age}ÏÑ∏` : 'ÎÇòÏù¥ ÎØ∏ÏÉÅ'} ¬∑ {node.data.job || 'ÏßÅÏóÖ ÏóÜÏùå'}
                                </div>
                            )}
                            <div className={`text-[12px] font-medium leading-tight line-clamp-3 grow ${isIdea ? 'text-slate-700' : 'text-slate-500 bg-slate-50 p-2 rounded-[3px] border border-slate-100 italic'}`}>
                                {node.data.memo || "ÏûëÏÑ±Îêú Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§."}
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        const App = () => {
            const [projects, setProjects] = useState(() => {
                const saved = localStorage.getItem('sagak-storm-projects');
                if (!saved) return [{ id: 'default', name: 'ÏÉà ÌîÑÎ°úÏ†ùÌä∏', nodes: [], edges: [] }];
                return JSON.parse(saved);
            });
            const [activeProjectId, setActiveProjectId] = useState(projects[0].id);
            const [expandedProjects, setExpandedProjects] = useState({ [projects[0].id]: true });
            const [editingProjectId, setEditingProjectId] = useState(null);

            const activeProject = useMemo(() => projects.find(p => p.id === activeProjectId) || projects[0], [projects, activeProjectId]);
            const nodes = activeProject.nodes;
            const edges = activeProject.edges;

            const handleSelectProject = (id) => {
                setActiveProjectId(id);
                setExpandedProjects({ [id]: true });
            };

            const toggleProjectFolder = (id, e) => {
                if (e) e.stopPropagation();
                setExpandedProjects(prev => prev[id] ? {} : { [id]: true });
            };

            const updateActiveProject = useCallback((nodeUpdater, edgeUpdater) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    return {
                        ...p,
                        nodes: nodeUpdater ? nodeUpdater(p.nodes) : p.nodes,
                        edges: edgeUpdater ? edgeUpdater(p.edges) : p.edges
                    };
                }));
            }, [activeProjectId]);

            const fileInputRef = useRef(null);
            const [history, setHistory] = useState({ past: [], future: [] });
            const [scale, setScale] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isPanning, setIsPanning] = useState(false);
            const [draggingNodeId, setDraggingNodeId] = useState(null);
            const [tempEdge, setTempEdge] = useState(null);
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [selectedEdgeId, setSelectedEdgeId] = useState(null);
            const [topNodeId, setTopNodeId] = useState(null);
            const containerRef = useRef(null);
            const lastMousePos = useRef({ x: 0, y: 0 });
            const hasConnectedRef = useRef(false);

            useEffect(() => {
                localStorage.setItem('sagak-storm-projects', JSON.stringify(projects));
            }, [projects]);

            const saveHistory = useCallback(() => {
                setHistory(prev => ({ past: [...prev.past.slice(-19), { projects }], future: [] }));
            }, [projects]);

            const undo = useCallback(() => {
                setHistory(prev => {
                    if (prev.past.length === 0) return prev;
                    const previous = prev.past[prev.past.length - 1];
                    const newPast = prev.past.slice(0, prev.past.length - 1);
                    setProjects(previous.projects);
                    return { past: newPast, future: [{ projects }, ...prev.future] };
                });
            }, [projects]);

            const visibleNodes = useMemo(() => {
                const viewportW = window.innerWidth;
                const viewportH = window.innerHeight;
                const buffer = 300;
                return nodes.filter(node => {
                    const screenX = node.x * scale + pan.x;
                    const screenY = node.y * scale + pan.y;
                    const screenW = CARD_W * scale;
                    const screenH = CARD_H * scale;
                    return (screenX + screenW + buffer > 0 && screenX - buffer < viewportW && screenY + screenH + buffer > 0 && screenY - buffer < viewportH);
                });
            }, [nodes, scale, pan]);

            const visibleEdges = useMemo(() => {
                const visibleIds = new Set(visibleNodes.map(n => n.id));
                return edges.filter(edge => visibleIds.has(edge.from) || visibleIds.has(edge.to));
            }, [edges, visibleNodes]);

            const fitToScreen = useCallback((targetNodes = nodes) => {
                if (!targetNodes || targetNodes.length === 0) return;
                const minX = Math.min(...targetNodes.map(n => n.x));
                const minY = Math.min(...targetNodes.map(n => n.y));
                const maxX = Math.max(...targetNodes.map(n => n.x)) + CARD_W;
                const maxY = Math.max(...targetNodes.map(n => n.y)) + CARD_H;
                const viewportW = containerRef.current.clientWidth;
                const viewportH = containerRef.current.clientHeight;
                const padding = 100;
                const scaleX = (viewportW - padding * 2) / (maxX - minX);
                const scaleY = (viewportH - padding * 2) / (maxY - minY);
                let newScale = Math.min(Math.max(Math.min(scaleX, scaleY), 0.2), 1.5);
                setPan({ x: (viewportW / 2) - ((minX + maxX) / 2 * newScale), y: (viewportH / 2) - ((minY + maxY) / 2 * newScale) });
                setScale(newScale);
            }, [nodes]);

            const handleDownload = () => {
                const data = JSON.stringify(projects, null, 2);
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `sagak_storm_projects_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleLoad = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) { saveHistory(); setProjects(data); handleSelectProject(data[0].id); }
                    } catch (error) { alert("ÌååÏùº Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù"); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            useEffect(() => {
                const handleWheel = (e) => {
                    if (e.target.closest('aside')) return;
                    e.preventDefault();
                    const rect = containerRef.current.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top;
                    const delta = -e.deltaY * 0.0012;
                    const newScale = Math.min(Math.max(0.1, scale + delta), 3);
                    const scaleRatio = newScale / scale;
                    setPan(prev => ({ x: mouseX - (mouseX - prev.x) * scaleRatio, y: mouseY - (mouseY - prev.y) * scaleRatio }));
                    setScale(newScale);
                };
                const div = containerRef.current;
                div.addEventListener('wheel', handleWheel, { passive: false });
                return () => div.removeEventListener('wheel', handleWheel);
            }, [scale]);

            useEffect(() => {
                const handleKeyDown = (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); } };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [undo]);

            useEffect(() => { setTimeout(() => fitToScreen(), 100); }, []);

            const getCanvasCoords = (clientX, clientY) => {
                const rect = containerRef.current.getBoundingClientRect();
                return { x: (clientX - rect.left - pan.x) / scale, y: (clientY - rect.top - pan.y) / scale };
            };

            const findNode = (id) => nodes.find(n => n.id === id);

            const createNewProject = () => {
                const name = prompt("ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
                if (!name) return;
                const newId = crypto.randomUUID();
                saveHistory();
                setProjects(prev => [...prev, { id: newId, name, nodes: [], edges: [] }]);
                handleSelectProject(newId);
                setPan({ x: 0, y: 0 }); setScale(1);
            };

            const deleteProject = (id, e) => {
                if (e) e.stopPropagation();
                if (confirm("Ï†ïÎßê Ïù¥ ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    saveHistory();
                    let newProjects = projects.filter(p => p.id !== id);
                    if (newProjects.length === 0) {
                        const dummyId = crypto.randomUUID();
                        newProjects = [{ id: dummyId, name: 'ÏÉà ÌîÑÎ°úÏ†ùÌä∏', nodes: [], edges: [] }];
                        handleSelectProject(dummyId);
                    } else if (activeProjectId === id) {
                        handleSelectProject(newProjects[0].id);
                    }
                    setProjects(newProjects);
                }
            };

            const handleProjectRename = (id, newName) => {
                saveHistory();
                setProjects(prev => prev.map(p => p.id === id ? { ...p, name: newName } : p));
                setEditingProjectId(null);
            };

            const addNode = (type) => {
                saveHistory();
                const id = crypto.randomUUID();
                const rect = containerRef.current.getBoundingClientRect();
                const center = getCanvasCoords(rect.left + rect.width / 2, rect.top + rect.height / 2);
                const defaultData = type === 'Ïù∏Î¨º' ? { emoji: 'üë§', age: '', gender: 'ÎØ∏ÏßÄÏ†ï', job: '', role: 'Ï°∞Ïó∞', memo: '' } : (type === 'ÏÇ¨Í±¥' ? { emoji: 'üìÆ', memo: '' } : { emoji: 'üí°', memo: '' });
                
                updateActiveProject(prev => [...prev, { id, x: center.x - CARD_W / 2, y: center.y - CARD_H / 2, label: `ÏÉà ${type}`, type, data: defaultData }]);
                setTopNodeId(id);
            };

            const deleteNode = (id) => {
                saveHistory();
                updateActiveProject(
                    prev => prev.filter(n => n.id !== id),
                    prev => prev.filter(e => e.from !== id && e.to !== id)
                );
                if (selectedNodeId === id) setSelectedNodeId(null);
            };

            const handleReorderNodes = (type, newOrderedNodesOfType) => {
                saveHistory();
                updateActiveProject(allNodes => {
                    const otherTypes = allNodes.filter(n => n.type !== type);
                    return [...otherTypes, ...newOrderedNodesOfType];
                });
            };

            const handleGlobalMouseMove = (e) => {
                const dx = e.clientX - lastMousePos.current.x, dy = e.clientY - lastMousePos.current.y;
                if (isPanning) setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                else if (draggingNodeId) {
                    updateActiveProject(prev => prev.map(n => n.id === draggingNodeId ? { ...n, x: n.x + (dx / scale), y: n.y + (dy / scale) } : n));
                }
                if (tempEdge) { const c = getCanvasCoords(e.clientX, e.clientY); setTempEdge(prev => ({ ...prev, toX: c.x, toY: c.y })); }
                lastMousePos.current = { x: e.clientX, y: e.clientY };
            };

            const handleGlobalMouseUp = (e) => {
                if (draggingNodeId) saveHistory();
                if (tempEdge && !hasConnectedRef.current) {
                    saveHistory();
                    const c = getCanvasCoords(e.clientX, e.clientY);
                    const fromNode = findNode(tempEdge.fromId);
                    const newNodeId = crypto.randomUUID();
                    const defaultData = fromNode.type === 'Ïù∏Î¨º' ? { emoji: 'üë§', age: '', gender: 'ÎØ∏ÏßÄÏ†ï', job: '', role: 'Ï°∞Ïó∞', memo: '' } : (fromNode.type === 'ÏÇ¨Í±¥' ? { emoji: 'üö©', memo: '' } : { emoji: 'üí°', memo: '' });
                    
                    updateActiveProject(
                        prev => [...prev, { id: newNodeId, x: c.x - CARD_W/2, y: c.y - CARD_H/2, label: `ÏÉà ${fromNode.type}`, type: fromNode.type, data: defaultData }],
                        prev => [...prev, { id: crypto.randomUUID(), from: tempEdge.fromId, to: newNodeId, label: 'Í¥ÄÍ≥Ñ' }]
                    );
                }
                hasConnectedRef.current = false; setIsPanning(false); setDraggingNodeId(null); setTempEdge(null);
            };

            const activeNode = useMemo(() => nodes.find(n => n.id === selectedNodeId), [nodes, selectedNodeId]);
            const activeEdge = useMemo(() => edges.find(e => e.id === selectedEdgeId), [edges, selectedEdgeId]);

            return (
                <div className={`flex w-screen h-screen no-drag grid-background ${(isPanning || draggingNodeId) ? 'is-dragging' : ''}`} 
                     onMouseMove={handleGlobalMouseMove} onMouseUp={handleGlobalMouseUp} onContextMenu={e => e.preventDefault()}>
                    
                    {/* ÏÇ¨Ïù¥ÎìúÎ∞î */}
                    <aside className="w-80 h-full bg-slate-100 border-r border-slate-200 z-[100] flex flex-col shadow-2xl overflow-hidden">
                        {/* [ÏàòÏ†ï] ÏÉÅÎã® Ï†úÎ™© ÎÜíÏù¥ Ï∂ïÏÜå (pt-8 pb-6 -> pt-5 pb-4) */}
                        <div className="px-5 pt-5 pb-4 bg-white border-b border-slate-200 text-center">
                            <h1 className="text-xl font-black text-slate-900 tracking-tighter leading-none italic">SAGAK STORM</h1>
                            <span className="text-[8px] font-bold text-slate-400 mt-0.5 uppercase tracking-widest">Creative Thought Engine</span>
                        </div>

                        <div className="p-3 bg-white/50 border-b border-slate-200">
                            {/* [ÏàòÏ†ï] Î≤ÑÌäº ÎÜíÏù¥ Ï∂ïÏÜå Î∞è 3px ÎùºÏö¥Îìú */}
                            <button onClick={createNewProject} className="w-full py-2.5 bg-indigo-600 text-white text-[10px] font-black rounded-[3px] hover:bg-indigo-700 transition-all shadow-md tracking-widest">+ NEW PROJECT</button>
                        </div>

                        <div className="flex-1 overflow-y-auto px-3 pt-4 space-y-3 custom-scroll pb-10">
                            {projects.map(project => {
                                const isActive = activeProjectId === project.id;
                                const isExpanded = expandedProjects[project.id];
                                return (
                                    /* [ÏàòÏ†ï] ÎùºÏö¥Îìú 3px Ï†ÅÏö© */
                                    <div key={project.id} className={`rounded-[3px] transition-all duration-300 ${isActive ? 'bg-white shadow-lg border-2 border-indigo-100 ring-1 ring-indigo-50' : 'bg-slate-50 border border-transparent'}`}>
                                        <div 
                                            onClick={() => handleSelectProject(project.id)}
                                            onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }}
                                            /* [ÏàòÏ†ï] ÌîÑÎ°úÏ†ùÌä∏ Î¶¨Ïä§Ìä∏ ÎÜíÏù¥ Ï∂ïÏÜå (p-4 -> py-2.5 px-4) */
                                            className="flex items-center justify-between py-2.5 px-4 cursor-pointer group relative overflow-hidden"
                                        >
                                            {isActive && <div className="absolute left-0 top-0 bottom-0 w-1 bg-indigo-600" />}
                                            <div className="flex items-center gap-3 min-w-0 flex-1 z-10">
                                                <span onClick={(e) => toggleProjectFolder(project.id, e)} className="text-base">
                                                    {isExpanded ? 'üìÇ' : 'üìÅ'}
                                                </span>
                                                {editingProjectId === project.id ? (
                                                    <input 
                                                        autoFocus 
                                                        className="w-full bg-white border-2 border-indigo-400 rounded-[3px] px-1 text-[13px] font-bold outline-none"
                                                        defaultValue={project.name}
                                                        onBlur={(e) => handleProjectRename(project.id, e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)}
                                                    />
                                                ) : (
                                                    <span className={`text-[13px] font-black truncate ${isActive ? 'text-slate-900' : 'text-slate-500'}`}>{project.name}</span>
                                                )}
                                            </div>
                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2 shrink-0 z-10">
                                                <button onClick={(e) => deleteProject(project.id, e)} className="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-[3px] transition-all">
                                                    <IconTrash />
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <AnimatePresence>
                                            {isExpanded && (
                                                <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} className="overflow-hidden bg-slate-50/30 rounded-b-[3px] border-t border-slate-100">
                                                    <div className="pb-3 px-3 space-y-3 pt-2">
                                                        {['Ïù∏Î¨º', 'ÏÇ¨Í±¥', 'Î©îÎ™®'].map(type => {
                                                            const filtered = project.nodes.filter(n => n.type === type);
                                                            if (filtered.length === 0) return null;
                                                            return (
                                                                <div key={type} className="pl-1">
                                                                    <div className="text-[9px] font-black text-slate-400 mb-1.5 px-2 uppercase tracking-tighter flex items-center gap-2">
                                                                        <span className="w-1 h-1 bg-slate-300 rounded-[3px]"></span>
                                                                        {type}
                                                                    </div>
                                                                    <Reorder.Group axis="y" values={filtered} onReorder={(newOrder) => handleReorderNodes(type, newOrder)} className="space-y-1">
                                                                        {filtered.map(n => (
                                                                            <Reorder.Item key={n.id} value={n}
                                                                                 onClick={(e) => { e.stopPropagation(); handleSelectProject(project.id); setPan({ x: -(n.x + CARD_W/2)*scale + (window.innerWidth - 320)/2, y: -(n.y + CARD_H/2)*scale + window.innerHeight/2 }); }}
                                                                                 className={`py-1.5 px-3 bg-white hover:border-indigo-300 border border-slate-200 rounded-[3px] flex items-center justify-between gap-2 cursor-pointer shadow-sm transition-all border-l-4 ${getSidebarItemAccent(n)}`}>
                                                                                <div className="flex items-center gap-2 min-w-0">
                                                                                    <span className="text-xs shrink-0">{n.data.emoji}</span>
                                                                                    <span className="text-[11px] font-bold text-slate-600 truncate">{n.label}</span>
                                                                                </div>
                                                                                {n.type === 'Ïù∏Î¨º' && (
                                                                                    <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                                        {n.data.role}
                                                                                    </span>
                                                                                )}
                                                                            </Reorder.Item>
                                                                        ))}
                                                                    </Reorder.Group>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </motion.div>
                                            )}
                                        </AnimatePresence>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="p-3 bg-white border-t border-slate-200">
                            <input type="file" accept=".json" ref={fileInputRef} onChange={handleLoad} className="hidden" />
                            <div className="flex gap-2">
                                <button onClick={handleDownload} className="flex-1 py-2.5 bg-slate-900 text-white text-[10px] font-black rounded-[3px]">SAVE ALL</button>
                                <button onClick={() => fileInputRef.current.click()} className="flex-1 py-2.5 bg-white border border-slate-300 text-slate-700 text-[10px] font-black rounded-[3px]">LOAD FILE</button>
                            </div>
                        </div>
                    </aside>

                    {/* Î©îÏù∏ Ï∫îÎ≤ÑÏä§ ÏòÅÏó≠ */}
                    <main className={`flex-1 relative overflow-hidden ${isPanning ? 'cursor-grabbing' : draggingNodeId ? 'cursor-grabbing' : 'cursor-grab'}`} 
                          ref={containerRef} onMouseDown={(e) => { lastMousePos.current = { x: e.clientX, y: e.clientY }; if (e.button === 0) setIsPanning(true); }}>
                        
                        <div className="absolute top-6 left-6 z-[80] flex items-center gap-3">
                            <div className="h-10 px-5 bg-white shadow-lg border border-slate-200 rounded-[3px] flex items-center gap-2">
                                <span className="w-2 h-2 bg-indigo-500 rounded-[3px] animate-pulse"></span>
                                <span className="text-xs font-black text-slate-800 uppercase tracking-widest">{activeProject.name}</span>
                            </div>

                            <div className="flex items-center gap-1 p-1 bg-white rounded-[3px] shadow-lg border border-slate-200 h-10">
                                <button onClick={() => addNode('Ïù∏Î¨º')} className="flex items-center gap-2 h-full px-4 rounded-[3px] hover:bg-indigo-50 text-indigo-600 transition-all active:scale-95 group">
                                    <div className="w-5 h-5 flex items-center justify-center bg-indigo-500 rounded-[3px] text-white group-hover:scale-110 transition-transform">
                                        <IconPlus />
                                    </div>
                                    <span className="text-[11px] font-black">Ïù∏Î¨º</span>
                                </button>
                                <div className="w-px h-4 bg-slate-200 mx-0.5"></div>
                                <button onClick={() => addNode('ÏÇ¨Í±¥')} className="flex items-center gap-2 h-full px-4 rounded-[3px] hover:bg-rose-50 text-rose-600 transition-all active:scale-95 group">
                                    <div className="w-5 h-5 flex items-center justify-center bg-rose-500 rounded-[3px] text-white group-hover:scale-110 transition-transform">
                                        <IconPlus />
                                    </div>
                                    <span className="text-[11px] font-black">ÏÇ¨Í±¥</span>
                                </button>
                                <div className="w-px h-4 bg-slate-200 mx-0.5"></div>
                                <button onClick={() => addNode('Î©îÎ™®')} className="flex items-center gap-2 h-full px-4 rounded-[3px] hover:bg-amber-50 text-amber-600 transition-all active:scale-95 group">
                                    <div className="w-5 h-5 flex items-center justify-center bg-amber-500 rounded-[3px] text-white group-hover:scale-110 transition-transform">
                                        <IconPlus />
                                    </div>
                                    <span className="text-[11px] font-black">Î©îÎ™®</span>
                                </button>
                            </div>
                        </div>

                        <div className="absolute bottom-8 right-8 z-[100] flex flex-col bg-white shadow-2xl border border-slate-200 rounded-[3px] overflow-hidden text-slate-600 font-bold">
                            <button onClick={() => fitToScreen()} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 border-b border-slate-100">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="scale-75"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></svg>
                            </button>
                            <button onClick={() => setScale(prev => Math.min(prev + 0.1, 3))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50">+</button>
                            <div className="py-2 text-[9px] font-black text-slate-400 border-y border-slate-50 text-center bg-slate-50/50">{Math.round(scale * 100)}%</div>
                            <button onClick={() => setScale(prev => Math.max(prev - 0.1, 0.1))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50">-</button>
                        </div>

                        <div className="zoom-container w-full h-full" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}>
                            <svg className="canvas-svg">
                                <defs><marker id="arrow-event" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 L 2 5 z" fill="#ef4444" /></marker></defs>
                                {visibleEdges.map(edge => {
                                    const from = findNode(edge.from); const to = findNode(edge.to);
                                    if (!from || !to) return null;
                                    let x1 = from.x + CARD_W/2, y1 = from.y + CARD_H/2, x2 = to.x + CARD_W/2, y2 = to.y + CARD_H/2;
                                    const isEventToEvent = from.type === 'ÏÇ¨Í±¥' && to.type === 'ÏÇ¨Í±¥';
                                    const isIdeaInvolved = from.type === 'Î©îÎ™®' || to.type === 'Î©îÎ™®', isPersonToEvent = (from.type === 'Ïù∏Î¨º' && to.type === 'ÏÇ¨Í±¥') || (from.type === 'ÏÇ¨Í±¥' && to.type === 'Ïù∏Î¨º'), isPersonToPerson = from.type === 'Ïù∏Î¨º' && to.type === 'Ïù∏Î¨º';
                                    let pathData = isEventToEvent ? `M ${x1} ${y1} L ${getEdgeTargetPos(from, to, 12).x} ${getEdgeTargetPos(from, to, 12).y}` : getBezierPath(x1, y1, x2, y2);
                                    let edgeColor = isIdeaInvolved ? "#facc15" : isPersonToEvent ? "#3b82f6" : isPersonToPerson ? "#93c5fd" : "#ef4444", strokeWidth = isPersonToEvent ? "12" : isEventToEvent ? "4" : "2";
                                    const labelWidth = Math.max(70, (edge.label || "").length * 10 + 20);
                                    return (
                                        <g key={edge.id}>
                                            <path d={pathData} className="edge-hitbox" onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); saveHistory(); updateActiveProject(null, prev => prev.filter(ev => ev.id !== edge.id)); }} />
                                            <path d={pathData} stroke={edgeColor} strokeWidth={strokeWidth} markerEnd={isEventToEvent ? "url(#arrow-event)" : ""} strokeDasharray={isIdeaInvolved ? "8, 6" : ""} className="edge-path opacity-80" />
                                            {isPersonToPerson && (
                                                <g className="cursor-pointer pointer-events-auto" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }}>
                                                    <rect x={(x1+x2)/2 - labelWidth/2} y={(y1+y2)/2-12} width={labelWidth} height="24" rx="3" fill="white" stroke={edgeColor} strokeWidth="1.5" /><text x={(x1+x2)/2} y={(y1+y2)/2+4} textAnchor="middle" fontSize="11" fontWeight="900" fill="#334155">{edge.label}</text>
                                                </g>
                                            )}
                                        </g>
                                    );
                                })}
                                {tempEdge && <line x1={findNode(tempEdge.fromId).x + CARD_W/2} y1={findNode(tempEdge.fromId).y + CARD_H/2} x2={tempEdge.toX} y2={tempEdge.toY} stroke="#94a3b8" strokeWidth="2" strokeDasharray="4,4" />}
                            </svg>
                            {visibleNodes.map(node => (
                                <NodeCard key={node.id} node={node} isTop={topNodeId === node.id}
                                    onNodeDragStart={(e, id) => { e.stopPropagation(); setDraggingNodeId(id); setTopNodeId(id); }}
                                    onMouseDown={(e, id) => { if (e.button === 2) { const c = getCanvasCoords(e.clientX, e.clientY); setTempEdge({ fromId: id, toX: c.x, toY: c.y }); } }}
                                    onMouseUp={(e, id) => { if (tempEdge && id !== tempEdge.fromId) { saveHistory(); hasConnectedRef.current = true; updateActiveProject(null, prev => [...prev, { id: crypto.randomUUID(), from: tempEdge.fromId, to: id, label: 'Í¥ÄÍ≥Ñ' }]); } }}
                                    onDoubleClick={setSelectedNodeId}
                                    onDelete={deleteNode} />
                            ))}
                        </div>
                    </main>

                    {/* ÎÖ∏Îìú ÏàòÏ†ï Î™®Îã¨ */}
                    <AnimatePresence>
                        {activeNode && (
                            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-8 rounded-[3px] shadow-2xl w-[500px] relative">
                                    <button onClick={() => setSelectedNodeId(null)} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-[3px] transition-colors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                                    <h2 className="text-xl font-black mb-6 text-slate-800 uppercase tracking-tight">{activeNode.type} ÏÉÅÏÑ∏ ÏÑ§Ï†ï</h2>
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-4 gap-4">
                                            <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">Ïù¥Î™®ÏßÄ</label><input className="p-3 bg-slate-50 rounded-[3px] text-center text-xl font-bold border border-slate-200 outline-none focus:border-blue-500 focus:bg-white transition-all h-[60px]" value={activeNode.data.emoji} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} /></div>
                                            <div className="col-span-3 flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">Ïù¥Î¶Ñ/ÎùºÎ≤®</label><input className="p-3 bg-slate-50 rounded-[3px] font-bold text-xl border border-slate-200 outline-none focus:border-blue-500 focus:bg-white transition-all h-[60px]" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} /></div>
                                        </div>
                                        {activeNode.type === 'Ïù∏Î¨º' && (
                                            <div className="space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">ÏÑ±Î≥Ñ</label><input className="p-3 bg-slate-50 border border-slate-200 rounded-[3px] font-medium outline-none focus:border-blue-500 focus:bg-white transition-all" value={activeNode.data.gender} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, gender: e.target.value}} : n))} /></div>
                                                    <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">ÎÇòÏù¥</label><input className="p-3 bg-slate-50 border border-slate-200 rounded-[3px] font-medium outline-none focus:border-blue-500 focus:bg-white transition-all" value={activeNode.data.age} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, age: e.target.value}} : n))} /></div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">ÏßÅÏóÖ</label><input className="p-3 bg-slate-50 border border-slate-200 rounded-[3px] font-medium outline-none focus:border-blue-500 focus:bg-white transition-all" value={activeNode.data.job} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, job: e.target.value}} : n))} /></div>
                                                    <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">Ïó≠Ìï†Íµ∞</label><select className="p-3 bg-slate-50 border border-slate-200 rounded-[3px] font-bold text-blue-600 outline-none cursor-pointer focus:border-blue-500 focus:bg-white transition-all" value={activeNode.data.role} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, role: e.target.value}} : n))}><option value="Ï£ºÏù∏Í≥µ">‚≠ê Ï£ºÏù∏Í≥µ</option><option value="Ï°∞Î†•Ïûê">ü§ù Ï°∞Î†•Ïûê</option><option value="Ï°∞Ïó∞">üë§ Ï°∞Ïó∞</option><option value="Ï†ÅÎåÄÏûê">üî• Ï†ÅÎåÄÏûê</option><option value="ÏóëÏä§Ìä∏Îùº">‚òÅÔ∏è ÏóëÏä§Ìä∏Îùº</option></select></div>
                                                </div>
                                            </div>
                                        )}
                                        <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1">Î©îÎ™® Î∞è ÏÑ§Ï†ï</label><textarea className="w-full h-32 p-3 bg-slate-50 rounded-[3px] border border-slate-200 text-sm outline-none focus:border-blue-500 focus:bg-white transition-all resize-none" value={activeNode.data.memo} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, memo: e.target.value}} : n))} /></div>
                                    </div>
                                    <div className="flex mt-8">
                                        <button onClick={() => { saveHistory(); setSelectedNodeId(null); }} className="flex-1 py-3 bg-slate-900 text-white font-black hover:bg-slate-800 transition-colors uppercase text-xs tracking-widest rounded-[3px]">Ï†ÄÏû•ÌïòÍ∏∞</button>
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </AnimatePresence>

                    {/* Í¥ÄÍ≥Ñ ÏàòÏ†ï Î™®Îã¨ */}
                    <AnimatePresence>
                        {activeEdge && (
                            <div className="fixed inset-0 z-[210] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
                                <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-6 rounded-[3px] w-80 shadow-2xl border border-slate-200 text-center relative">
                                    <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Í¥ÄÍ≥Ñ ÎÇ¥Ïö© ÏàòÏ†ï</div>
                                    <input className="w-full p-3 bg-slate-50 border border-slate-200 font-bold text-center mb-6 text-slate-700 outline-none focus:border-blue-500 transition-all rounded-[3px]" value={activeEdge.label} onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, label: e.target.value} : ev))} autoFocus />
                                    <button onClick={() => { saveHistory(); setSelectedEdgeId(null); }} className="w-full py-2.5 bg-slate-900 text-white font-black text-xs rounded-[3px] hover:bg-slate-800 transition-colors">ÌôïÏù∏</button>
                                </motion.div>
                            </div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
