<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ê° ìŠ¤íŠœë””ì˜¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#09090b',
                        darkpanel: '#18181b',
                        darkborder: '#27272a',
                    },
                    borderRadius: {
                        'sm': '3px',
                    }
                }
            }
        }
    </script>
    <style>
        @font-face {
            font-family: 'MaruBuri';
            src: url(https://hangeul.pstatic.net/hangeul_static/webfont/MaruBuri/MaruBuri-Regular.woff2);
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'Ridibatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Galmuri14';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2506-1@1.0/Galmuri14.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-display: swap;
        }

        body.font-maruburi,
        body.font-maruburi * {
            font-family: 'MaruBuri', serif !important;
        }

        body.font-Ridibatang,
        body.font-Ridibatang * {
            font-family: 'Ridibatang', sans-serif !important;
        }

        body.font-Galmuri14,
        body.font-Galmuri14 * {
            font-family: 'Galmuri14', serif !important;
        }

        body.font-pretendard,
        body.font-pretendard * {
            font-family: 'Pretendard', sans-serif !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background: #f1f5f9;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }

        #root {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .dark body {
            background: #09090b;
            color: #e4e4e7;
        }

        button:not([class*="rounded-full"]),
        input:not([class*="rounded-full"]),
        select:not([class*="rounded-full"]),
        textarea:not([class*="rounded-full"]),
        div[class*="bg-"]:not([class*="rounded-full"]):not([class*="rounded-none"]),
        div[class*="border"]:not([class*="rounded-full"]):not([class*="rounded-none"]),
        aside:not([class*="rounded-full"]),
        main:not([class*="rounded-full"]),
        section:not([class*="rounded-full"]),
        article:not([class*="rounded-full"]),
        footer:not([class*="rounded-full"]) {
            border-radius: 3px;
        }

        .grid-background {
            background-color: #f8fafc;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .dark .grid-background {
            background-color: #09080B;
            background-image: linear-gradient(#141416 1px, transparent 1px), linear-gradient(90deg, #141416 1px, transparent 1px);
        }

        .dot-background {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 0) !important;
            background-size: 20px 20px !important;
            background-position: 0 0;
        }

        .dark .dot-background {
            background-color: #09080B;
            background-image: radial-gradient(#27272a 1px, transparent 0) !important;
        }

        .canvas-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: visible;
        }

        .edge-path {
            fill: none;
            transition: stroke 0.2s, d 0.15s ease-out;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .edge-hitbox {
            fill: none;
            stroke: transparent;
            stroke-width: 20;
            cursor: pointer;
            pointer-events: stroke;
        }

        .node-glass {
            background: #ffffff;
            backdrop-filter: blur(10px);
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .dark .node-glass {
            background: #1f1f23;
            border: 1px solid #3f3f46;
            color: #fafafa;
        }

        .node-postit {
            background-color: #fef9c3;
            border-radius: 3px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #fde047;
        }

        .dark .node-postit {
            background-color: #3d3a2a;
            border: 1px solid #5a5642;
            color: #f5f3e0;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .zoom-container {
            transform-origin: 0 0;
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .is-dragging .zoom-container {
            transition: none;
        }

        .is-dragging .edge-path {
            transition: none;
        }

        .node-protagonist {
            outline: 8px solid rgba(37, 99, 235, 0.2);
            background: #d7e7fc;
        }

        .dark .node-protagonist {
            outline: 8px solid rgba(37, 99, 235, 0.2);
            background: #172554;
        }

        .node-antagonist {
            border: 1px solid #c88885;
            background: #fbdfde;
        }

        .dark .node-antagonist {
            border: 1px solid #7f1d1d;
            background: #450a0a;
        }

        .node-helper {
            border: 1px solid #7dcb97;
            background: #d0f7e2;
        }

        .dark .node-helper {
            border: 1px solid #059669;
            background: #064e3b;
        }

        .node-event {
            outline: 4px solid rgba(255, 3, 3, 0.3);
        }

        .node-todo-complete {
            outline: 8px solid rgba(34, 211, 238, 0.15);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .custom-scroll:hover::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark .custom-scroll::-webkit-scrollbar-thumb {
            background: #3f3f46;
        }

        .dark .custom-scroll:hover::-webkit-scrollbar-thumb {
            background: #52525b;
        }

        .editor-paper {
            max-width: 585px;
            margin: 40px auto;
            background: white;
            min-height: calc(100vh - 80px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, max-width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-paper.editor-wide {
            max-width: 780px;
        }

        .editor-paper.editor-narrow {
            max-width: 480px;
        }

        .dark .editor-paper {
            background: #18181b;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            border: 1px solid #27272a;
        }

        .editor-title-container {
            padding: 40px 60px 10px 60px;
        }

        .editor-textarea {
            width: 100%;
            flex: 1;
            resize: none;
            outline: none;
            line-height: 2.2;
            font-size: 18px;
            color: #334155;
            background: transparent;
            border: none;
            padding: 20px 60px 60px 60px;
        }

        .dark .editor-textarea {
            color: #d4d4d8;
        }

        .book-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-style: preserve-3d;
        }

        .book-spine {
            background: transparent;
        }

        .page-bg {
            background-color: #fdfbf7;
            background-image: repeating-linear-gradient(transparent, transparent 19px, #e5e7eb 20px);
        }

        .mention-list {
            position: fixed;
            z-index: 1000;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            max-height: 400px;
            overflow: visible;
            display: flex;
            width: 600px;
        }

        .dark .mention-list {
            background: #18181b;
            border-color: #27272a;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .mention-item-active {
            background-color: #f1f5f9;
            border-left: 4px solid #4f46e5;
        }

        .dark .mention-item-active {
            background-color: #27272a;
            border-left: 4px solid #4f46e5;
        }

        .editor-textarea.zen-active {
            padding-bottom: 50vh !important;
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }

        .editor-textarea.zen-active::-webkit-scrollbar {
            display: none !important;
        }

        /* ë¹„êµ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .compare-container {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 0);
            background-size: 20px 20px;
            background-position: 0 0;
        }

        .dark .compare-container {
            background-color: #09080B;
            background-image: radial-gradient(#27272a 1px, transparent 0);
        }

        .compare-container textarea {
            line-height: 2.2;
            color: #334155;
        }

        .dark .compare-container textarea {
            color: #d4d4d8;
        }

        .compare-container .zen-active {
            padding-bottom: 50vh !important;
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }

        .compare-container .zen-active::-webkit-scrollbar {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script id="name-data">
        window.NAME_DB = {
            fantasy: {
                royalty: {
                    m: ["ì•„ì„œ|Arthur", "ìœŒë¦¬ì—„|William", "ë¦¬ì²˜ë“œ|Richard", "ì—ë“œì›Œë“œ|Edward", "ì•Œë ‰ì‚°ë”|Alexander", "ë£¨ì´|Louis", "í—¨ë¦¬|Henry", "í”„ë ˆë°ë¦­|Frederick", "ë ˆì˜¤|Leo", "ë§‰ì‹œë°€ë¦¬ì•ˆ|Maximilian", "í•„ë¦½|Philip", "ì°°ìŠ¤|Charles", "ì¡°ì§€|George", "ì•Œë¼ë¦­|Alaric", "í…Œì˜¤ë„ë¥´|Theodore", "ë°œë ˆë¦¬ìš°ìŠ¤|Valerius", "ì•„ìš°êµ¬ìŠ¤íˆ¬ìŠ¤|Augustus", "ì„¸ë°”ìŠ¤ì°¬|Sebastian", "ìœ¨ë¦¬ìš°ìŠ¤|Julius", "ì¹´ì‹œìš°ìŠ¤|Cassius", "ë°ë¯¸ì•ˆ|Demian", "ë£¨ì‹œì•ˆ|Lucian", "ì•„ë“œë¦¬ì•ˆ|Adrian", "ì¤„ë¦¬ì•ˆ|Julian", "ë² ë„¤ë”•íŠ¸|Benedict", "ì½˜ìŠ¤íƒ„í‹´|Constantine", "ê°€ë¸Œë¦¬ì—˜|Gabriel", "ë¯¸ì¹´ì—˜|Michael", "ë¼íŒŒì—˜|Raphael", "ì˜¤ìŠ¤ì¹´|Oscar", "í´ë¡œë¹„ìŠ¤|Clovis", "ìƒ¤ë¥¼ë§ˆë‰´|Charlemagne", "í”¼í•€|Pepin", "ë¡œíƒ€ë¥´|Lothair", "ì½˜ë¼ë“œ|Conrad", "ì˜¤í† |Otto", "ì§€ê¸°ìŠ¤ë¬¸íŠ¸|Sigismund", "í˜ë¥´ë””ë‚œë“œ|Ferdinand", "ì•Œí°ì†Œ|Alfonso", "í ë¦¬í˜|Felipe", "ì¹´ë¥¼ë¡œìŠ¤|Carlos", "í”„ë€ì‹œìŠ¤|Francis", "ì œì„ìŠ¤|James", "í•´ë¡¤ë“œ|Harold", "ì—ë“œë¬¸ë“œ|Edmund", "ì•¨ë²„íŠ¸|Albert", "ë¹…í„°|Victor", "ë‹ˆì½œë¼ìŠ¤|Nicholas", "ë¸”ë¼ë””ë¯¸ë¥´|Vladimir", "êµ¬ìŠ¤íƒ€í”„|Gustav", "í¬ë¦¬ìŠ¤í‹°ì•ˆ|Christian", "ë ˆì˜¤í´ë“œ|Leopold", "ë£¨ë“œë¹„íˆ|Ludwig", "í”„ë€ì¸ |Franz", "ë£¨ëŒí”„|Rudolf", "ë°œíŠ¸í•´ë¨¸|Waldemar", "ì¹´ì‹œë¯¸ë¥´|Casimir", "ë§ˆí‹°ì•„ìŠ¤|Matthias", "ìŠ¤í…ŒíŒ|Stefan", "ì´ë°˜|Ivan", "ì•„ê²Œì‹¤ë¼ìš°ìŠ¤|Agesilaus", "ë ˆì˜¤ë‹ˆë‹¤ìŠ¤|Leonidas", "í¬ì„¸ë¥´í¬ì„¸ìŠ¤|Xerxes", "ë‹¤ë¦¬ìš°ìŠ¤|Darius", "í‚¤ë£¨ìŠ¤|Cyrus", "íŠ¸ë¼ì•¼ëˆ„ìŠ¤|Trajan", "í•˜ë“œë¦¬ì•„ëˆ„ìŠ¤|Hadrian", "ë§ˆë¥´ì¿ ìŠ¤|Marcus", "ì½¤ëª¨ë‘ìŠ¤|Commodus", "ì…‰í‹°ë¯¸ìš°ìŠ¤|Septimius", "ì¹´ë¼ì¹¼ë¼|Caracalla", "ë””ì˜¤í´ë ˆí‹°ì•„ëˆ„ìŠ¤|Diocletian", "ë°œë Œí‹°ë‹ˆì•ˆ|Valentinian", "í…Œì˜¤ë„ì‹œìš°ìŠ¤|Theodosius", "ìœ ìŠ¤í‹°ë‹ˆì•„ëˆ„ìŠ¤|Justinian", "ë²¨ë¦¬ì‚¬ë¦¬ìš°ìŠ¤|Belisarius", "í—¤ë¼í´ë¦¬ìš°ìŠ¤|Heraclius", "ë°”ì‹¤ë¦¬ìš°ìŠ¤|Basilius", "ë ˆì˜¤|Leo", "ë¡œë§ˆëˆ„ìŠ¤|Romanus", "ì•Œë ‰ì‹œìš°ìŠ¤|Alexius", "ë§ˆëˆ„ì—˜|Manuel", "ì•ˆë“œë¡œë‹ˆì¿ ìŠ¤|Andronicus", "ë³¼ë ˆìŠ¬ë¼í”„|Boleslaw", "ë¯¸ì—ìŠˆì½”|Mieszko", "ë¼ë””ìŠ¬ë¼í”„|Ladislav", "ë²¨ë¼|Bela", "ì´ìŠ¤íŠ¸ë°˜|Istvan", "ì¹¼ë§Œ|Kalman", "ëŸ¬ìš”ìŠˆ|Lajos"],
                    f: ["ì—˜ë¦¬ìë² ìŠ¤|Elizabeth", "ë¹…í† ë¦¬ì•„|Victoria", "ì´ì‚¬ë²¨ë¼|Isabella", "ë§ˆí‹¸ë‹¤|Matilda", "ì•„ë¸ë¼|Adela", "ë² ì•„íŠ¸ë¦¬ìŠ¤|Beatrice", "ìƒ¬ë¡¯|Charlotte", "ì—˜ë ˆë…¸ì–´|Eleanor", "ë§ˆê°€ë ›|Margaret", "ìºì„œë¦°|Catherine", "ì†Œí”¼ì•„|Sophia", "ì•„ë‚˜ìŠ¤íƒ€ìƒ¤|Anastasia", "ì¤„ë¦¬ì•„|Julia", "í´ë¼ìš°ë””ì•„|Claudia", "ë°œë Œí‹°ë‚˜|Valentina", "ì„¸ì‹¤ë¦¬ì•„|Cecilia", "ì˜¤í•„ë¦¬ì•„|Ophelia", "ì½”ë¸ë¦¬ì•„|Cordelia", "ì œë„¤ë¹„ë¸Œ|Genevieve", "ë¡œì˜ë¦°ë“œ|Rosalind", "ë¹„ë¹„ì•ˆ|Vivian", "ì„¸ë¼í”¼ë‚˜|Seraphina", "ì•„ìš°ë ë¦¬ì•„|Aurelia", "ë£¨ì‹œì•„|Lucia", "í—¬ë ˆë‚˜|Helena", "ë‹¤ì´ì•„ë‚˜|Diana", "ì¹´ë°€ë¼|Camilla", "ì˜¤ë¡œë¼|Aurora", "ì‹¤ë¹„ì•„|Sylvia", "ë§ˆë¦¬|Marie", "ì•„ë¸ë¼ì´ë“œ|Adelaide", "ì½˜ìŠ¤íƒ„ìŠ¤|Constance", "ì´ë””ìŠ¤|Edith", "í•„ë¦¬íŒŒ|Philippa", "ì¡°ì•ˆ|Joan", "ì•¤|Anne", "í¬ë¦¬ìŠ¤í‹°ë‚˜|Christina", "ë¹Œí—¬ë¯¸ë‚˜|Wilhelmina", "ì•™íˆ¬ì•„ë„¤íŠ¸|Antoinette", "ì¡°ì„¸í•€|Josephine", "í…Œë ˆì‚¬|Theresa", "ì´ë ˆë„¤|Irene", "ì œë‹ˆì•„|Xenia", "íƒ€í‹°ì•„ë‚˜|Tatiana", "ì˜¬ê°€|Olga", "ì‰ê·¸ë¦¬ë“œ|Ingrid", "ì•„ìŠ¤íŠ¸ë¦¬ë“œ|Astrid", "ë¸Œë¦¬ì§“|Bridget", "ìš°ë¥´ìˆ ë¼|Ursula", "í´ë ˆë©˜íƒ€ì¸|Clementine", "í”Œë¡œë¼|Flora", "ë¸”ë‘ì‰¬|Blanche", "ê°€ë¸Œë¦¬ì—˜ë¼|Gabriella", "ì•Œë ‰ì‚°ë“œë¼|Alexandra", "ìºë¡¤ë¼ì¸|Caroline", "ë£¨ì´ì¦ˆ|Louise", "ì— ë§ˆë‰´ì—˜|Emmanuelle", "ë¹„ì˜¬ë¼|Viola", "ë¯¸ë€ë‹¤|Miranda", "ë¦¬ê±´|Regan", "ì œë…¸ë¹„ì•„|Zenobia", "í´ë ˆì˜¤íŒŒíŠ¸ë¼|Cleopatra", "ë„¤í˜ë¥´í‹°í‹°|Nefertiti", "í•˜íŠ¸ì…‰ìˆ˜íŠ¸|Hatshepsut", "ì•„ê·¸ë¦¬í”¼ë‚˜|Agrippina", "ë©”ì‚´ë¦¬ë‚˜|Messalina", "ì˜¥íƒ€ë¹„ì•„|Octavia", "ë¦¬ë¹„ì•„|Livia", "ë£¨í¬ë ˆì¹˜ì•„|Lucretia", "ë² ë¡œë‹ˆì¹´|Veronica", "ìš°ë¼ë‹ˆì•„|Urania", "ì¹¼ë¦¬ì˜¤í˜|Calliope", "ì—ìš°ë¡œíŒŒ|Europa", "ì•ˆí‹°ê³ ë„¤|Antigone", "ì´ìŠ¤ë©”ë„¤|Ismene", "ì¼ë ‰íŠ¸ë¼|Electra", "ì´í”¼ê²Œë‹ˆì•„|Iphigenia", "ë¼ë¹„ë‹ˆì•„|Lavinia", "ë””ë„|Dido", "ê¸°ë„¤ë¹„ì–´|Guinevere", "ì´ì¡¸ë°|Isolde", "ëª¨ë¥´ê°„|Morgan", "ë‹˜ì—|Nimue", "ì¼ë ˆì¸|Elaine", "ì´ê·¸ë ˆì¸|Igraine", "ëª¨ê°€ì¦ˆ|Morgause", "ê·¸ë¦¬ì ¤ë‹¤|Griselda", "ê³ ë””ë°”|Godiva", "ë¡œì›¨ë‚˜|Rowena", "ì—ì˜¤ìœˆ|Eowyn"],
                    s: ["ë¼ì´ì˜¨í•˜íŠ¸|Lionheart", "ê³¨ë“œë©”ì¸|Goldmane", "ì‹¤ë²„ìœ|Silverthorn", "ë¸”ë™ìš°ë“œ|Blackwood", "ìœˆí„°ë³¸|Winterbourne", "ì„œë¨¸ì…‹|Somerset", "í•˜ì´ìœˆë“œ|Highwind", "ìŠ¤í†°ê°€ë“œ|Stormguard", "ì•„ì´ì–¸ì‚¬ì´ë“œ|Ironside", "ë¡œì¦ˆë¸”ëŸ¬ë“œ|Roseblood", "í‚¹ìŠ¤ë² ì¸|Kingsbane", "ë¡œì—´|Royal", "í¬ë¼ìš´|Crown", "ë°œë£¨ì•„|Valois", "íŠœë”|Tudor", "í•˜ë…¸ë²„|Hanover", "ìœˆì €|Windsor", "ë­ì¹´ìŠ¤í„°|Lancaster", "ìš”í¬|York", "ìŠ¤íŠœì–´íŠ¸|Stuart", "ë¶€ë¥´ë´‰|Bourbon", "í•©ìŠ¤ë¶€ë¥´í¬|Habsburg", "ë©”ë””ì¹˜|Medici", "ë¡œë§ˆë…¸í”„|Romanov", "í˜¸ì—”ì´ë ˆë¥¸|Hohenzollern", "ì‚¬ë³´ì´|Savoy", "ê·¸ë¦¬ë§ë””|Grimaldi", "ì˜¤ë Œì§€|Orange", "ë‚˜ì†Œ|Nassau", "ë£©ì…ˆë¶€ë¥´í¬|Luxembourg", "ì„ íŒŒì´ì–´|Sunfire", "ë¬¸ìœ„ìŠ¤í¼|Moonwhisper", "ìŠ¤íƒ€í´|Starfall", "ë˜ì‹œì»¤|Dawnseeker", "ë‚˜ì´íŠ¸ì…°ì´ë“œ|Nightshade", "ë ˆì´ë¸ìŠ¤í¬ë¡œí”„íŠ¸|Ravenscroft", "ì• ì‰¬ë‹¤ìš´|Ashdown", "ìœ|Thorne", "ìŠ¤í„¸ë§|Sterling", "í¬ë¡¬ì›°|Cromwell", "ì‹±í´ë ˆì–´|Sinclair", "ëª½ê³ ë©”ë¦¬|Montgomery", "í•˜ì›Œë“œ|Howard", "í¼ì‹œ|Percy", "ë„¤ë¹Œ|Neville", "ë³´í¼íŠ¸|Beaufort", "ëª¨í‹°ë¨¸|Mortimer", "ìŠ¤íƒ ë¦¬|Stanley", "íƒˆë´‡|Talbot", "í—¤ì´ìŠ¤íŒ…ìŠ¤|Hastings", "ë²„í‚¹ì—„|Buckingham", "ë² ë“œí¬ë“œ|Bedford", "í´ë¼ë ŒìŠ¤|Clarence", "ê¸€ë¡œìŠ¤í„°|Gloucester", "ì¼„íŠ¸|Kent", "ì½˜ì›”|Cornwall", "ì›¨ì¼ì¦ˆ|Wales", "ì•Œë°”ë‹ˆ|Albany", "ë¡œìŠ¤|Ross", "ë§ˆì¹˜|March", "ë“œë˜ê³¤í•˜íŠ¸|Dragonheart", "í”¼ë‹‰ìŠ¤ìœ™|Phoenixwing", "ê·¸ë¦¬í•€í´ë¡œ|Griffinclaw", "ìœ ë‹ˆì½˜í˜¼|Unicornhorn", "ìŠ¤íƒ€ê²Œì´ì €|Stargazer", "ì„ ë¼ì´ë”|Sunrider", "ë¬¸ì›Œì»¤|Moonwalker", "ìŠ¤ì¹´ì´ë³¸|Skyborn", "ì–´ìŠ¤ì…°ì´ì»¤|Earthshaker", "ì”¨ì›Œì»¤|Seawalker", "í”„ë¡œìŠ¤íŠ¸ë³¸|Frostborn", "í”Œë ˆì„í•˜íŠ¸|Flameheart", "ì¬ë”ë¡œë“œ|Thunderlord", "ìŠ¤í†°ë¸Œë§ì–´|Stormbringer", "ìœˆë“œëŸ¬ë„ˆ|Windrunner", "ëˆë¸Œë§ì–´|Dawnbringer", "ë”ìŠ¤í¬ì›Œì»¤|Duskwalker", "ë‚˜ì´íŠ¸í´|Nightfall", "ë°ì´ë¸Œë ˆì´í¬|Daybreak", "ë¼ì´íŠ¸ë¸Œë§ì–´|Lightbringer", "ì„€ë„ìš°í—Œí„°|Shadowhunter", "ë¸”ëŸ¬ë“œë¬¸|Bloodmoon", "ì‹¤ë²„ë¬¸|Silvermoon", "ê³¨ë“ ì„ |Goldensun", "ì•„ì´ì–¸í¬ì§€|Ironforge", "ìŠ¤í‹¸ê°€ë“œ|Steelguard", "ìŠ¤í†¤ì›”|Stonewall", "ìš°ë“œì›Œë“œ|Woodward", "ë¦¬ë²„ì†¡|Riversong", "ë ˆì´í¬ë·°|Lakeview"]
                },
                knight: {
                    m: ["ëœìŠ¤|Lance", "ê°€ì›¨ì¸|Gawain", "í¼ì‹œë²Œ|Percival", "íŠ¸ë¦¬ìŠ¤íƒ„|Tristan", "í—¥í† ë¥´|Hector", "ì•„í‚¬ë ˆìŠ¤|Achilles", "ë¡¤ë‘|Roland", "ì˜¬ë¦¬ë²„|Oliver", "ì œë¼ë“œ|Gerard", "ë³¼ë“œìœˆ|Baldwin", "ê³ ë“œí”„ë¦¬|Godfrey", "ë ˆì´ëª¬ë“œ|Raymond", "íƒ„í¬ë ˆë“œ|Tancred", "ë³´ì—ëª½|Bohemond", "ë¡œë²„íŠ¸|Robert", "ê°€ì´|Guy", "ì‹œëª¬|Simon", "íœ´|Hugh", "ì œí”„ë¦¬|Geoffrey", "ìŠ¤í…ŒíŒ|Stephen", "ë¡œì €|Roger", "ìœŒí„°|Walter", "ê¸¸ë²„íŠ¸|Gilbert", "ë²„ë‚˜ë“œ|Bernard", "ì•„ë†€ë“œ|Arnold", "ë ˆì˜¤íŒŒë“œ|Leopard", "ìš¸í”„|Wolf", "ë² ì–´|Bear", "í˜¸í¬|Hawk", "íŒ”ì½˜|Falcon", "ì¼„ë“œë¦­|Kendrick", "ë¡œë°ë¦­|Roderick", "ì„¸ë“œë¦­|Cedric", "í…Œì˜¤ë„ë¦­|Theodoric", "ë ˆì˜¤í”„ë¦­|Leofric", "ìš¸í”„ë¦­|Wulfric", "ì—ë°œíŠ¸|Ewald", "ê²Œë¥´í•˜ë¥´íŠ¸|Gerhardt", "í•˜ë¥´íŠ¸ë¬´íŠ¸|Hartmut", "ë¼ì´ë„ˆ|Rainer", "í´ì»¤|Volker", "ê±´í„°|Gunther", "í•˜ê²|Hagen", "ì§€ê·¸í”„ë¦¬ë“œ|Siegfried", "ë””íŠ¸ë¦¬íˆ|Dietrich", "íë°ë¸Œë€íŠ¸|Hildebrand", "ì¼€ì¸|Kane", "ë“œë ˆì´í¬|Drake", "ê·¸ë¦¬í•€|Griffin", "ë ‰ìŠ¤|Rex", "ë§‰ì‹œë¬´ìŠ¤|Maximus", "íƒ€ì´íˆ¬ìŠ¤|Titus", "ë§ˆë¥´ì¿ ìŠ¤|Marcus", "ë£¨í‚¤ìš°ìŠ¤|Lucius", "í”Œë¼ë¹„ìš°ìŠ¤|Flavius", "ë°œë ˆë¦¬ì•ˆ|Valerian", "ì˜¤ë¦¬ì˜¨|Orion", "ì•„ì•½ìŠ¤|Ajax", "ì œì´ìŠ¨|Jason", "í—¤ë¼í´ë ˆìŠ¤|Hercules", "ê°¤ëŸ¬í•´ë“œ|Galahad", "ë³´ì–´ìŠ¤|Bors", "ë² ë””ë¹„ì–´|Bedivere", "ì¼€ì´|Kay", "ê°€ë ˆìŠ¤|Gareth", "ê°€í—¤ë¦¬ìŠ¤|Gaheris", "íŒ”ë¡œë¯¸ë°ìŠ¤|Palomides", "ì‚¬í”¼ë¥´|Safir", "ì„¸ê·¸ì™€ë¦¬ë°ìŠ¤|Segwarides", "ë‹¤ì´ë‚˜ë‹¨|Dinadan", "ë‹¤ê³ ë„·|Dagonet", "ëª¨í™€íŠ¸|Morholt", "ë¼ëª¨ë½|Lamorak", "í ë¦¬ë…¸ì–´|Pellinore", "ì•„ê·¸ë¼ë² ì¸|Agravain", "ëª¨ë“œë ˆë“œ|Mordred", "í† ë¥´|Tor", "ì—‘í„°|Ector", "ë¼ì´ì–¸|Lionel", "ë£¨ì¹¸|Lucan", "ë¹„ìš”ë¥¸|Bjorn", "ë¼ê·¸ë‚˜|Ragnar", "ë¡¤ë¡œ|Rollo", "ì•„ì´ë°”|Ivar", "ì—ë¦­|Erik", "í•˜ë„ë“œ|Harald", "ìŠ¤ë²¤|Sven", "í¬ëˆ„íŠ¸|Cnut", "ë ˆì´í”„|Leif", "ì†Œë¦°|Thorin"],
                    f: ["ì”|Jeanne", "ë¸Œë¦¬|Bree", "ì¹´ì‚°ë“œë¼|Cassandra", "ë°œí‚¤ë¦¬|Valkyrie", "ì•„í…Œë‚˜|Athena", "ë²¨ë¡œë‚˜|Bellona", "ì¹´ë°€ë¼|Camilla", "ë¸Œë˜ë“œë¼ë§Œí…Œ|Bradamante", "ë§ˆë¥´í”¼ì‚¬|Marpissa", "í´ë¡œë¦°ë‹¤|Clorinda", "ë¸Œë£¬íë°|Brunhilde", "ì‹œê·¸ë£¬|Sigrun", "ë¡œì¦ˆ|Rose", "ë¦´ë¦¬|Lily", "ì•„ì´ë¦¬ìŠ¤|Iris", "ë°”ì´ì˜¬ë ›|Violet", "ì¬ìŠ¤ë¯¼|Jasmine", "ë°ì´ì§€|Daisy", "í¬í”¼|Poppy", "í™€ë¦¬|Holly", "ì•„ì´ë¹„|Ivy", "í—¤ì´ì ¤|Hazel", "ìœŒë¡œìš°|Willow", "ë¡œì™„|Rowan", "ì•„ìŠ¤íœ|Aspen", "ê·¸ì›¬|Gwen", "ê¸°ë„¤ë¹„ì–´|Guinevere", "ëª¨ê±´|Morgan", "ë§ˆí‹¸ë‹¤|Matilda", "ì•„ê·¸ë„¤ìŠ¤|Agnes", "ë² ì•„íŠ¸ë¦­ìŠ¤|Beatrix", "ê±°íŠ¸ë£¨ë“œ|Gertrude", "í—¤ë“œìœ…|Hedwig", "ì•ˆë“œë¡œë©”ë‹¤|Andromeda", "ì•„ë¥´í…Œë¯¸ì‹œì•„|Artemisia", "ì œë…¸ë¹„ì•„|Zenobia", "ë¶€ë””ì¹´|Boudicca", "íˆí´ë¦¬íƒ€|Hippolyta", "íœí…Œì‹¤ë ˆì´ì•„|Penthesilea", "ì•„íƒˆë€íƒ€|Atalanta", "ìŠ¤ì¹´ì•„í•˜|Scathach", "ì´ì¡¸ë°|Isolde", "ë°œë Œì‹œì•„|Valencia", "ë¹…í† ë¦¬ì•„|Victoria", "ì•Œë ‰ì‹œì•„|Alexia", "ì•ˆë“œë ˆì•„|Andrea", "ì—ë¦¬ì¹´|Erica", "í”„ë ˆë°ë¦¬ì¹´|Frederica", "ë ˆì˜¤ë‚˜|Leona", "ë§ˆë¥´í‹°ë‚˜|Martina", "ë‹ˆì½œ|Nicole", "í•„ë¦¬íŒŒ|Philippa", "ìŠ¤í…ŒíŒŒë‹ˆ|Stephanie", "í…Œì˜¤ë„ë¼|Theodora", "ë¹Œë§ˆ|Wilma", "ë¸Œë¦¬í† ë§ˆíŠ¸|Britomart", "ì•ˆí‹°ì˜¤í˜|Antiope", "ë©œë¼ë‹ˆí˜|Melanippe", "ì˜¤íŠ¸ë ˆë¼|Otrera", "íƒˆë ˆìŠ¤íŠ¸ë¦¬ìŠ¤|Thalestris", "ë¯¸ë¦¬ë‚˜|Myrina", "ë¦¬ì‹œí˜|Lysippe", "íˆí´ë¦¬í…Œ|Hippolyte", "ëŒí˜í† |Lampeto", "ë§ˆë¥´í˜ì‹œì•„|Marpesia", "ì˜¤ë¦¬í‹°ì•„|Orithyia", "ì‹œë…¸í˜|Sinope", "í…Œë¥´ëª¨ë„ì‚¬|Thermodosa", "ë°œë¼ìŠ¤ì¹´|Valasca", "ë¸”ë Œë‹¤|Blenda", "ë¼ê²Œë¥´íƒ€|Lagertha", "í—¤ë¥´ë³´ë¥´|Hervor", "ë¸Œë¥€íë“œ|Brynhildr", "ì‹œê·¸ë“œë¦¬íŒŒ|Sigrdrifa", "ìŠ¤ë°”ë°”|Svava", "ì˜¬ë£¬|Olrun", "ì•Œë¹„íŠ¸|Alvitr", "í˜ë¼ë“œêµ°|Hladgunnr", "í—¤ë¥´ì•¼|Herja", "ë¯¸ìŠ¤íŠ¸|Mist", "ìŠ¤ì¿¨ë“œ|Skuld", "ë‘ê·¸ë¦¬ë“œ|Randgrid", "ê³¤ë‘˜|Gondul", "ê²Œì¼ë¢°êµ´|Geirskogul", "ìŠ¤í¬ë¢°êµ´|Skogul"],
                    s: ["ì•„ì´ì–¸|Iron", "ìŠ¤í‹¸|Steel", "ì‰´ë“œ|Shield", "ì†Œë“œ|Sword", "ë¸”ë ˆì´ë“œ|Blade", "ìŠ¤í”¼ì–´|Spear", "ëœìŠ¤|Lance", "ì•¡ìŠ¤|Axe", "í•´ë¨¸|Hammer", "ë©”ì´ìŠ¤|Mace", "ë³´ìš°|Bow", "ì• ë¡œìš°|Arrow", "ëŒ€ê±°|Dagger", "ë‚˜ì´í”„|Knife", "ê°€ë“œ|Guard", "ì„¼í‹°ë„¬|Sentinel", "ì›Œë“ |Warden", "í‚¤í¼|Keeper", "í”„ë¡œí…í„°|Protector", "ë””íœë”|Defender", "ì±”í”¼ì–¸|Champion", "ì›Œë¦¬ì–´|Warrior", "íŒŒì´í„°|Fighter", "ì†”ì €|Soldier", "ë‚˜ì´íŠ¸|Knight", "íŒ”ë¼ë”˜|Paladin", "í¬ë£¨ì„¸ì´ë”|Crusader", "í…œí”ŒëŸ¬|Templar", "ë ˆì¸ì €|Ranger", "ìŠ¤ì¹´ìš°íŠ¸|Scout", "ìŠ¤íŠ¸ë¡±|Strong", "ë³¼ë“œ|Bold", "ë¸Œë ˆì´ë¸Œ|Brave", "í‚¨|Keen", "ìŠ¤ìœ„í”„íŠ¸|Swift", "ìƒ¤í”„|Sharp", "í•˜ë“œ|Hard", "í„°í”„|Tough", "ëŸ¬í”„|Rough", "ì™€ì¼ë“œ|Wild", "ííŠ¸|Hilt", "í¼ë©œ|Pommel", "ì—ì§€|Edge", "í¬ì¸íŠ¸|Point", "í—¬ë¦„|Helm", "ê±´í‹€ë¦¿|Gauntlet", "ê·¸ë¦¬ë¸Œ|Greave", "ë©”ì¼|Mail", "í”Œë ˆì´íŠ¸|Plate", "ìŠ¤íŠ¸ë¼ì´í¬|Strike", "ë°°í‹€|Battle", "ì›Œ|War", "íŒŒì´íŠ¸|Fight", "ë“€ì–¼|Duel", "ì»´ë±ƒ|Combat", "ë¹…í† ë¦¬|Victory", "ê¸€ë¡œë¦¬|Glory", "ì•„ë„ˆ|Honor", "ë°œëŸ¬|Valor", "ì»¤ë¦¬ì§€|Courage", "ìŠ¤íŠ¸ë¡±í™€ë“œ|Stronghold", "ë±…ê°€ë“œ|Vanguard", "ë¶ˆì›Œí¬|Bulwark", "ë¨íŒŒíŠ¸|Rampart", "ë°”ìŠ¤í‹°ì˜¨|Bastion", "ì‹œíƒ€ë¸|Citadel", "í¬íŠ¸ë¦¬ìŠ¤|Fortress", "í‚µ|Keep", "íƒ€ì›Œ|Tower", "ì›”|Wall", "ê²Œì´íŠ¸|Gate", "ë¸Œë¦¿ì§€|Bridge", "ëª¨íŠ¸|Moat", "ë“œë¡œìš°ë¸Œë¦¿ì§€|Drawbridge", "í¬íŠ¸ì»¬ë¦¬ìŠ¤|Portcullis", "ì• ë¡œìš°í—¤ë“œ|Arrowhead", "ìŠ¤í”¼ì–´í¬ì¸íŠ¸|Spearpoint", "ë¸”ë ˆì´ë“œì—ì§€|Bladeedge", "ì†Œë“œííŠ¸|Swordhilt", "ì‹¤ë“œë°°ì‰¬|Shieldbash", "ì•„ë¨¸|Armor", "í€´ë¼ìŠ¤|Cuirass", "ë°”ì´ì €|Visor", "ë§¨í‹€|Mantle", "ì¼€ì´í”„|Cape", "í´ë¡|Cloak", "ë°°ë„ˆ|Banner", "í”Œë˜ê·¸|Flag", "ìŠ¤íƒ ë‹¤ë“œ|Standard", "íœë˜íŠ¸|Pennant"]
                },
                wizard: {
                    m: ["ë©€ë¦°|Merlin", "ì•Œë²„ìŠ¤|Albus", "ë§¤ê·¸ë„ˆìŠ¤|Magnus", "ì½”ë¥´ë„¬ë¦¬ìš°ìŠ¤|Cornelius", "ë°œíƒ€ìë¥´|Balthazar", "ì¹´ìŠ¤í¼|Casper", "ë©œí‚¤ì˜¤ë¥´|Melchior", "ì•„ë¥´í‚¤ë©”ë°ìŠ¤|Archimedes", "í”¼íƒ€ê³ ë¼ìŠ¤|Pythagoras", "ìœ í´ë¦¬ë“œ|Euclid", "í”Œë¼í†¤|Plato", "ì•„ë¦¬ìŠ¤í† í…”ë ˆìŠ¤|Aristotle", "ì†Œí¬ë¼í…ŒìŠ¤|Socrates", "í—¤ë¥´ë©”ìŠ¤|Hermes", "ì˜¤ë”˜|Odin", "ë¡œí‚¤|Loki", "í† ë¥´|Thor", "ì œìš°ìŠ¤|Zeus", "í¬ì„¸ì´ëˆ|Poseidon", "í•˜ë°ìŠ¤|Hades", "ì•„í´ë¡œ|Apollo", "ë””ì˜¤ë‹ˆì†ŒìŠ¤|Dionysus", "ì•„ë ˆìŠ¤|Ares", "í—¤íŒŒì´ìŠ¤í† ìŠ¤|Hephaestus", "í¬ë¡œë…¸ìŠ¤|Chronos", "ìš°ë¼ë…¸ìŠ¤|Uranus", "ê°€ì´ì•„|Gaia", "íƒ€ì´íƒ„|Titan", "ê¸°ê°„í…ŒìŠ¤|Gigantes", "ì‚¬ì´í´ë¡­ìŠ¤|Cyclops", "í”„ë¡œìŠ¤í˜ë¡œ|Prospero", "íŒŒìš°ìŠ¤íŠ¸|Faust", "ì†”ë¡œëª¬|Solomon", "ì‚¬ì´ë¨¼|Simon", "ë©”ì´ê±°ìŠ¤|Magus", "ì„¸ì´ì§€|Sage", "ì‹œì–´|Seer", "ì˜¤ë¼í´|Oracle", "í”„ë¡œí•|Prophet", "ë””ë°”ì´ë„ˆ|Diviner", "ì•„ì´ì˜¬ë¡œìŠ¤|Aeolus", "ë³´ë ˆì•„ìŠ¤|Boreas", "ë…¸íˆ¬ìŠ¤|Notus", "ì œí”¼ë¡œìŠ¤|Zephyrus", "íˆí˜ë¦¬ì˜¨|Hyperion", "ì´ì•„í˜íˆ¬ìŠ¤|Iapetus", "ì½”ì´ì˜¤ìŠ¤|Coeus", "í¬ë¦¬ìš°ìŠ¤|Crius", "ì˜¤ì¼€ì•„ë…¸ìŠ¤|Oceanus", "í…Œí‹°ìŠ¤|Tethys", "ë„¤ë ˆìš°ìŠ¤|Nereus", "í”„ë¡œí…Œìš°ìŠ¤|Proteus", "íŠ¸ë¦¬í†¤|Triton", "ì•„í‹€ë¼ìŠ¤|Atlas", "í”„ë¡œë©”í…Œìš°ìŠ¤|Prometheus", "ì—í”¼ë©”í…Œìš°ìŠ¤|Epimetheus", "í—¬ë¦¬ì˜¤ìŠ¤|Helios", "ì…€ë ˆë„¤|Selene", "ì—ì˜¤ìŠ¤|Eos", "ì•„ìŠ¤íŠ¸ë¼ì´ì˜¤ìŠ¤|Astraeus", "ì¡°ì‹œëª¨ìŠ¤|Zosimos", "ìë¹„ë¥´|Jabir", "íŒŒë¼ì¼ˆìˆ˜ìŠ¤|Paracelsus", "ì•„ê·¸ë¦¬íŒŒ|Agrippa", "ì¡´ë””|Dee", "ì¼ˆë¦¬|Kelly", "í”Œë¼ë©œ|Flamel", "ë¡œì  í¬ë¡œì´ì¸ |Rosencreutz", "ì•„ë¸Œë¼ì¹´ë‹¤ë¸Œë¼|Abra", "í˜¸ì»¤ìŠ¤|Hocus", "í¬ì»¤ìŠ¤|Pocus", "ì•Œì¼€ë¯¸ìŠ¤íŠ¸|Alchemist", "ë„¤í¬ë¡œë§¨ì„œ|Necromancer", "ì„œë¨¸ë„ˆ|Summoner", "ì»¨ì €ëŸ¬|Conjurer", "ì¸ì±ˆí„°|Enchanter", "ì¼ë£¨ì…”ë‹ˆìŠ¤íŠ¸|Illusionist", "íŠ¸ëœìŠ¤ë®¤í„°|Transmuter", "ì•±ì €ëŸ¬|Abjurer", "ì¸ë³´ì»¤|Invoker", "ì´ë³´ì»¤|Evoker", "íƒˆë ˆìŠ¤|Thales", "ì•„ë‚™ì‹œë§Œë“œë¡œìŠ¤|Anaximander", "ì•„ë‚™ì‹œë©”ë„¤ìŠ¤|Anaximenes", "í—¤ë¼í´ë ˆì´í† ìŠ¤|Heraclitus", "íŒŒë¥´ë©”ë‹ˆë°ìŠ¤|Parmenides", "ì— í˜ë„í´ë ˆìŠ¤|Empedocles", "ì•„ë‚™ì‚¬ê³ ë¼ìŠ¤|Anaxagoras", "ë°ëª¨í¬ë¦¬í† ìŠ¤|Democritus", "ì—í”¼ì¿ ë¡œìŠ¤|Epicurus"],
                    f: ["ëª¨ë¥´ê°€ë‚˜|Morgana", "í‚¤ë¥´ì¼€|Circe", "ë©”ë°ì´ì•„|Medea", "í—¤ì¹´í…Œ|Hecate", "ì‹œë¹Œ|Sybil", "ì¹´ì‚°ë“œë¼|Cassandra", "í”¼í‹°ì•„|Pythia", "ë‹¤í”„ë„¤|Daphne", "ì—ì½”|Echo", "ë‚˜ë¥´í‚¤ì†ŒìŠ¤|Narcissus", "í”„ë¦¬ì•¼|Freyja", "ì´ë‘”|Idun", "ìŠ¤ì¹´ë””|Skadi", "í—¬|Hel", "ì‹œí”„|Sif", "í”„ë¦¬ê·¸|Frigg", "ë‚œë‚˜|Nanna", "ì—ì´ë¥´|Eir", "ê²Œí”¼ì˜¨|Gefion", "í’€ë¼|Fulla", "ì‚¬ê°€|Saga", "ì‹œê¸´|Sigyn", "ë…¸ë¥¸|Norn", "ë°œí‚¤ë¦¬|Valkyrie", "ì—˜í”„|Elf", "í˜ì–´ë¦¬|Fairy", "í”½ì‹œ|Pixie", "ë‹˜í”„|Nymph", "ë“œë¼ì´ì–´ë“œ|Dryad", "ì„¸ì´ë Œ|Siren", "ë©”ë‘ì‚¬|Medusa", "ìŠ¤í…ë…¸|Stheno", "ì—ìš°ë¦¬ì•Œë ˆ|Euryale", "ê³ ë¥´ê³¤|Gorgon", "í•˜í”¼|Harpy", "ìŠ¤í•‘í¬ìŠ¤|Sphinx", "í‚¤ë©”ë¼|Chimera", "íˆë“œë¼|Hydra", "ë¼ë¯¸ì•„|Lamia", "ì—í‚¤ë“œë‚˜|Echidna", "í”Œë¡œë¼|Flora", "íŒŒìš°ë‚˜|Fauna", "í—¤ìŠ¤í‹°ì•„|Hestia", "ë°ë©”í…Œë¥´|Demeter", "í˜ë¥´ì„¸í¬ë„¤|Persephone", "ë ˆì•„|Rhea", "í…Œë¯¸ìŠ¤|Themis", "ë¯€ë„¤ëª¨ì‹œë„¤|Mnemosyne", "í¬ì´ë² |Phoebe", "í…Œì´ì•„|Theia", "ì¹¼ë¦¬ì˜¤í˜|Calliope", "í´ë¦¬ì˜¤|Clio", "ì—ë¼í† |Erato", "ì—ìš°í…Œë¥´í˜|Euterpe", "ë©œí¬ë©”ë„¤|Melpomene", "í´ë¦¬í˜ë‹ˆì•„|Polyhymnia", "í…Œë¥´í”„ì‹œì½”ë ˆ|Terpsichore", "íƒˆë¦¬ì•„|Thalia", "ìš°ë¼ë‹ˆì•„|Urania", "ë„¤ë©”ì‹œìŠ¤|Nemesis", "ì‹œë¹Œë¼|Sibylla", "ë³¼ë°”|Volva", "ì„¸ì´ì¦ˆ|Seidr", "íŒŒì‹œíŒŒì—|Pasiphae", "ì•„ë¦¬ì•„ë“œë„¤|Ariadne", "íŒŒì´ë“œë¼|Phaedra", "í”„ë¡œí¬ë¦¬ìŠ¤|Prokris", "í•„ë¡œë©œë¼|Philomela", "í”„ë¡œí¬ë„¤|Procne", "ì•Œí‚¤ì˜¤ë„¤|Alcyone", "ì¼€ì´ë¦­ìŠ¤|Ceyx", "ì´ì˜¤|Io", "ì„¸ë©œë ˆ|Semele", "ë‹¤ë‚˜ì—|Danae", "ë ˆë‹¤|Leda", "ì•Œí¬ë©”ë„¤|Alcmene", "ì´ì˜¤ì¹´ìŠ¤í…Œ|Jocasta", "ì•ˆë“œë¡œë§ˆì¼€|Andromache", "í—¤ì¿ ë°”|Hecuba", "í´ë¦­ì„¸ë‚˜|Polyxena", "í¬ë ˆìš°ì‚¬|Creusa", "ì´í”¼ê²Œë„¤ì´ì•„|Iphigeneia", "ì—˜ë ‰íŠ¸ë¼|Electra", "í´ë¦¬íƒ€ì„ë„¤ìŠ¤íŠ¸ë¼|Clytemnestra", "ì•„íŠ¸ë¡œí¬ìŠ¤|Atropos", "ë¼ì¼€ì‹œìŠ¤|Lachesis", "í´ë¡œí† |Clotho", "í‹°ì‹œí¬ë„¤|Tisiphone", "ë©”ê°€ë¼|Megaera", "ì•Œë ‰í† |Alecto"],
                    s: ["ìŠ¤íƒ€|Star", "ë¬¸|Moon", "ì„ |Sun", "ìŠ¤ì¹´ì´|Sky", "í´ë¼ìš°ë“œ|Cloud", "ë ˆì¸|Rain", "ìŠ¤ë…¸ìš°|Snow", "ìœˆë“œ|Wind", "ìŠ¤í†°|Storm", "ì¬ë”|Thunder", "ë¼ì´íŠ¸ë‹|Lightning", "íŒŒì´ì–´|Fire", "ì›Œí„°|Water", "ì•„ì´ìŠ¤|Ice", "ì–´ìŠ¤|Earth", "ë„¤ì´ì²˜|Nature", "ë¼ì´í”„|Life", "ë°ìŠ¤|Death", "ìŠ¤í”¼ë¦¿|Spirit", "ì†Œìš¸|Soul", "ë§ˆì¸ë“œ|Mind", "íƒ€ì„|Time", "ìŠ¤í˜ì´ìŠ¤|Space", "ë³´ì´ë“œ|Void", "ì¹´ì˜¤ìŠ¤|Chaos", "ì˜¤ë”|Order", "ë¡œì§|Logic", "ë§¤ì§|Magic", "ë¯¸ìŠ¤í‹±|Mystic", "ì•„ì¼€ì¸|Arcane", "ì½”ë©§|Comet", "ì•„ìŠ¤í…Œë¡œì´ë“œ|Asteroid", "ë©”í…Œì˜¤|Meteor", "ê°¤ëŸ­ì‹œ|Galaxy", "ë„¤ë·¸ë¼|Nebula", "ì½”ìŠ¤ëª¨ìŠ¤|Cosmos", "ìœ ë‹ˆë²„ìŠ¤|Universe", "ì›”ë“œ|World", "í”Œë˜ë‹›|Planet", "í”Œë ˆì¸|Plane", "ë””ë©˜ì…˜|Dimension", "ë ë¦„|Realm", "ì¡´|Zone", "ì—ì–´ë¦¬ì–´|Area", "ë¦¬ì „|Region", "ìŠ¤í |Spell", "ì°¸|Charm", "í—¥ìŠ¤|Hex", "ì»¤ìŠ¤|Curse", "ì›Œë“œ|Ward", "ë£¬|Rune", "ì‹œê¸¸|Sigil", "ê¸€ë¦¬í”„|Glyph", "ë§ˆí¬|Mark", "ì‚¬ì¸|Sign", "ì˜¤ë¼|Aura", "ë§ˆë‚˜|Mana", "ì—í…Œë¥´|Ether", "ì—ì„¼ìŠ¤|Essence", "ì—˜ë¦¬ë¨¼íŠ¸|Element", "ìŠ¤íƒ€ë¼ì´íŠ¸|Starlight", "ë¬¸ë¼ì´íŠ¸|Moonlight", "ì„ ë¼ì´íŠ¸|Sunlight", "ìŠ¤íƒ€ë”ìŠ¤íŠ¸|Stardust", "ë¬¸ë”ìŠ¤íŠ¸|Moondust", "ì„ ë”ìŠ¤íŠ¸|Sundust", "ìŠ¤íƒ€íŒŒì´ì–´|Starfire", "ë¬¸íŒŒì´ì–´|Moonfire", "ì„ íŒŒì´ì–´|Sunfire", "ìŠ¤íƒ€ìƒ¤ì¸|Starshine", "ë¬¸ë¹”|Moonbeam", "ì„ ë¹”|Sunbeam", "ìŠ¤íƒ€í´|Starfall", "ë¬¸ë¼ì´ì¦ˆ|Moonrise", "ì„ ë¼ì´ì¦ˆ|Sunrise", "ìŠ¤íƒ€ì›Œì¹˜|Starwatch", "ë¬¸ì›Œì¹˜|Moonwatch", "ì„ ì›Œì¹˜|Sunwatch", "íŠ¸ì™€ì¼ë¼ì‡|Twilight", "ë”ìŠ¤í¬|Dusk", "ë˜|Dawn", "ë¯¸ë“œë‚˜ì‡|Midnight", "ëˆˆ|Noon", "ì´í´ë¦½ìŠ¤|Eclipse", "ì†”ìŠ¤í‹°ìŠ¤|Solstice", "ì´ì¿¼ë…¹ìŠ¤|Equinox", "í˜¸ë¼ì´ì¦Œ|Horizon", "ì œë‹ˆìŠ¤|Zenith", "ë‚˜ë””ë¥´|Nadir", "ì˜¤ë¡œë¼|Aurora"]
                },
                commoner: {
                    m: ["ì¡´|John", "ì œì„ìŠ¤|James", "í†°|Tom", "ì­|Jack", "ë¹Œ|Bill", "ë°¥|Bob", "ìƒ˜|Sam", "ëŒ„|Dan", "í´|Paul", "ë§ˆí¬|Mark", "ë£¨í¬|Luke", "ë§¤íŠœ|Matthew", "í”¼í„°|Peter", "ì•¤ë“œë¥˜|Andrew", "í•„ë¦½|Philip", "í† ë§ˆìŠ¤|Thomas", "ì¡°ì…‰|Joseph", "ì°°ìŠ¤|Charles", "ë°ì´ë¹„ë“œ|David", "ë¦¬ì°¨ë“œ|Richard", "ë¡œë²„íŠ¸|Robert", "ìœŒë¦¬ì—„|William", "ì¡°ì§€|George", "ì—ë“œì›Œë“œ|Edward", "í—¨ë¦¬|Henry", "í”„ë­í¬|Frank", "í•´ë¦¬|Harry", "ìŠ¤í‹°ë¸Œ|Steve", "ì•„ë‹´|Adam", "ë²¤|Ben", "ì œì´ì½¥|Jacob", "ë§ˆì´í´|Michael", "ì¡°ìŠˆì•„|Joshua", "ë‹¤ë‹ˆì—˜|Daniel", "í¬ë¦¬ìŠ¤í† í¼|Christopher", "ì•ˆì†Œë‹ˆ|Anthony", "ë„ë„ë“œ|Donald", "ì¼€ë„¤ìŠ¤|Kenneth", "ìŠ¤í‹°ë¸|Steven", "ë¸Œë¼ì´ì–¸|Brian", "ë¡œë‚ ë“œ|Ronald", "ì¼€ë¹ˆ|Kevin", "ì œì´ìŠ¨|Jason", "ì œí”„ë¦¬|Jeffrey", "ë¼ì´ì–¸|Ryan", "ê²Œë¦¬|Gary", "ë‹ˆì½œë¼ìŠ¤|Nicholas", "ì—ë¦­|Eric", "ì¡°ë‚˜ë‹¨|Jonathan", "ì €ìŠ¤í‹´|Justin", "ìŠ¤ì½§|Scott", "ë¸Œëœë“ |Brandon", "ë²¤ìë¯¼|Benjamin", "ì‚¬ë¬´ì—˜|Samuel", "ê·¸ë ˆê³ ë¦¬|Gregory", "ì•Œë ‰ì‚°ë”|Alexander", "íŒ¨íŠ¸ë¦­|Patrick", "ë ˆì´ëª¬ë“œ|Raymond", "ë°ë‹ˆìŠ¤|Dennis", "ì œë¦¬|Jerry", "ë„í”„|Ralph", "ë¡œì €|Roger", "ë¡œì´|Roy", "ëŸ¬ì…€|Russell", "ì„¸ìŠ¤|Seth", "ì‰ì¸|Shane", "ìˆ€|Shawn", "ì‚¬ì´ë¨¼|Simon", "ìŠ¤íœì„œ|Spencer", "ìŠ¤íƒ ë¦¬|Stanley", "ìŠ¤íŠœì–´íŠ¸|Stuart", "í…Œë“œ|Ted", "í…Œë¦¬|Terry", "íŒ€|Tim", "í‹°ëª¨ì‹œ|Timothy", "í† ë¹„|Toby", "í† ë“œ|Todd", "í† ë‹ˆ|Tony", "ë¹ˆì„¼íŠ¸|Vincent", "ì›¨ì¸|Wayne", "ë”ê¸€ë¼ìŠ¤|Douglas", "ìœ ì§„|Eugene", "ë¡œë ŒìŠ¤|Lawrence", "ê°€ë¸Œë¦¬ì—˜|Gabriel", "ì˜¤ìŠ¤í‹´|Austin", "ì¹¼|Carl", "í¬ë¦¬ìŠ¤|Chris", "ì¹´ë©”ë¡ |Cameron", "ì½”ë„ˆ|Connor", "ì¼€ì¼ëŸ½|Caleb"],
                    f: ["ë©”ë¦¬|Mary", "ì•ˆë‚˜|Anna", "ì— ë§ˆ|Emma", "ì‚¬ë¼|Sarah", "ì—˜ë¦¬ìŠ¤|Alice", "ë£¨ì‹œ|Lucy", "ê·¸ë ˆì´ìŠ¤|Grace", "ë¡œì¦ˆ|Rose", "ë¦´ë¦¬|Lily", "ì œì¸|Jane", "ì¼€ì´íŠ¸|Kate", "ì¤„ë¦¬|Julie", "ì—ì´ë¯¸|Amy", "ë¦¬ì‚¬|Lisa", "ë² í‹°|Betty", "í—¬ë Œ|Helen", "ë„ë¡œì‹œ|Dorothy", "ë§ˆê°€ë ›|Margaret", "ë£¨ìŠ¤|Ruth", "í´ë¼ë¼|Clara", "ì—ë°€ë¦¬|Emily", "ì†Œí”¼|Sophie", "ë¯¸ì•„|Mia", "í´ë¡œì´|Chloe", "ì•„ë¦¬ì•„|Aria", "ì¡°ì´|Zoe", "ë…¸ë¼|Nora", "ì•„ì´ë¹„|Ivy", "ë£¨ë‚˜|Luna", "ë²¨ë¼|Bella", "íŒ¨íŠ¸ë¦¬ìƒ¤|Patricia", "ì œë‹ˆí¼|Jennifer", "ë¦°ë‹¤|Linda", "ì—˜ë¦¬ìë² ìŠ¤|Elizabeth", "ë°”ë°”ë¼|Barbara", "ìˆ˜ì”|Susan", "ì œì‹œì¹´|Jessica", "ì¹´ë Œ|Karen", "ë‚¸ì‹œ|Nancy", "ì‚°ë“œë¼|Sandra", "ì• ìŠë¦¬|Ashley", "í‚´ë²Œë¦¬|Kimberly", "ë„ë‚˜|Donna", "ë¯¸ì…¸|Michelle", "ìºë¡¤|Carol", "ì•„ë§Œë‹¤|Amanda", "ë©œë¦¬ì‚¬|Melissa", "ë°ë³´ë¼|Deborah", "ìŠ¤í…ŒíŒŒë‹ˆ|Stephanie", "ë ˆë² ì¹´|Rebecca", "ë¡œë¼|Laura", "ìƒ¤ë¡ |Sharon", "ì‹ ì‹œì•„|Cynthia", "ìºìŠ¬ë¦°|Kathleen", "ì…œë¦¬|Shirley", "ì—ì´ë¯¸|Amy", "ì•ˆì ¤ë¼|Angela", "ë¸Œë Œë‹¤|Brenda", "íŒŒë©œë¼|Pamela", "ë‹ˆì½œ|Nicole", "ìƒë¦¬|Sally", "ì‚¬ë§Œë‹¤|Samantha", "ì‚¬ìƒ¤|Sasha", "ìŠ¤ì¹¼ë ›|Scarlett", "ì…€ë ˆë‚˜|Selena", "ì„¸ë ˆë‚˜|Serena", "ì„€ë„Œ|Shannon", "ì‰´ë¼|Sheila", "ì‰ë¦¬|Sherry", "ì‹¤ë¹„ì•„|Silvia", "ì‹œëª¬|Simone", "ì†Œë‹ˆì•„|Sonia", "ìŠ¤í…Œì´ì‹œ|Stacy", "ìŠ¤í…”ë¼|Stella", "ìˆ˜|Sue", "ìˆ˜ì”|Suzanne", "í‹°ë‚˜|Tina", "íŠ¸ë ˆì´ì‹œ|Tracy", "ë°”ë„¤ì‚¬|Vanessa", "ì›¬ë””|Wendy", "ì´ë³¸|Yvonne", "ì˜¤ë“œë¦¬|Audrey", "ë¹„ë²Œë¦¬|Beverly", "ë‹¤ì´ì•¤|Diane", "ì—ë¸”ë¦°|Evelyn", "ê¸€ë¡œë¦¬ì•„|Gloria", "í—¤ì´ì¦|Hazel", "ì£¼ë””|Judy", "ë£¨ì´ìŠ¤|Lois", "ë§ˆì‚¬|Martha"],
                    s: ["ìŠ¤ë¯¸ìŠ¤|Smith", "ë°€ëŸ¬|Miller", "ë² ì´ì»¤|Baker", "ì¿¡|Cook", "í”¼ì…”|Fisher", "í—Œí„°|Hunter", "ì¹´íœí„°|Carpenter", "í…Œì¼ëŸ¬|Taylor", "ìœ„ë²„|Weaver", "í„°ë„ˆ|Turner", "ì¿ í¼|Cooper", "ë©”ì´ìŠ¨|Mason", "í¬í„°|Potter", "ë°”ë²„|Barber", "ê°€ë“œë„ˆ|Gardner", "íŒŒë¨¸|Farmer", "ì…°í¼ë“œ|Shepherd", "ì¹´í„°|Carter", "ë¼ì´íŠ¸|Wright", "ì›Œì»¤|Walker", "í™€|Hall", "í|Hill", "ìš°ë“œ|Wood", "ê·¸ë¦°|Green", "ë¸Œë¼ìš´|Brown", "í™”ì´íŠ¸|White", "ë¸”ë™|Black", "ë¡±|Long", "ì‡¼íŠ¸|Short", "ì˜|Young", "í”Œë ˆì²˜|Fletcher", "ì†Œì´ì–´|Sawyer", "íƒœë„ˆ|Tanner", "ë¸Œë£¨ì–´|Brewer", "ìŠ¬ë ˆì´í„°|Slater", "ëŒ€ì²˜|Thatcher", "ì±ˆë“¤ëŸ¬|Chandler", "ì½œë¦¬ì–´|Collier", "ì›¹ìŠ¤í„°|Webster", "ìŠ¤ì¿ ë„ˆ|Schooner", "ì›¨ì´ë„ˆ|Wainer", "íŒŒì»¤|Parker", "ë¸Œë£©|Brook", "ë¦¬ë²„|River", "ë ˆì´í¬|Lake", "í°ë“œ|Pond", "í’€|Pool", "ì›°|Well", "ìŠ¤í”„ë§|Spring", "ìŠ¤íŠ¸ë¦¼|Stream", "í¬ë ˆìŠ¤íŠ¸|Forest", "ê·¸ë¡œë¸Œ|Grove", "ì˜¤ì°¨ë“œ|Orchard", "ê°€ë“ |Garden", "íŒŒí¬|Park", "ë©”ë„ìš°|Meadow", "í•„ë“œ|Field", "ë¬´ì–´|Moor", "íˆìŠ¤|Heath", "ë§ˆì‰¬|Marsh", "í”Œë¼ìš°ë§¨|Ploughman", "í—ˆì¦ˆë§¨|Herdsman", "íŒŒìš¸ëŸ¬|Fowler", "í¬ë ˆìŠ¤í„°|Forester", "ì¡°ì´ë„ˆ|Joiner", "íœ ë¼ì´íŠ¸|Wheelwright", "ì›¨ì¸ë¼ì´íŠ¸|Wainwright", "ì¹´íŠ¸ë¼ì´íŠ¸|Cartwright", "ë¨¸ì„œ|Mercer", "ë“œë ˆì´í¼|Draper", "ìŠ¤í‚¨ë„ˆ|Skinner", "ìƒˆë“¤ëŸ¬|Saddler", "ìŠˆë©”ì´ì»¤|Shoemaker", "ì½”ë¸”ëŸ¬|Cobbler", "ì•„ì´ì–¸|Iron", "ìŠ¤í†¤|Stone", "ë¸Œë¦­|Brick", "ì• ì‰¬|Ash", "ë²„ì¹˜|Birch", "ì˜¤í¬|Oak", "ì—˜ë¦„|Elm", "íŒŒì¸|Pine", "ë©”ì´í”Œ|Maple", "ì‹œë”|Cedar", "ìœ|Thorn", "ë² ë¦¬|Berry", "ë¶€ì‹œ|Bush", "í—¤ì§€|Hedge", "ë°˜ìŠ¤|Barnes", "ë¸Œë¦¿ì§€ìŠ¤|Bridges"]
                },
                servant: {
                    m: ["í•|Pip", "ë•|Dob", "í‚¤í¼|Kiper", "ë‹ˆëª¨|Nimo", "í† ë¹„|Toby", "ë¡œë¹ˆ|Robin", "í½|Puck", "ë°”ë‹ˆ|Barney", "í…Œë””|Teddy", "ë¹Œë¦¬|Billy", "ì§€ë¯¸|Jimmy", "í‹°ë¯¸|Timmy", "í† ë¯¸|Tommy", "ë°”ë¹„|Bobby", "ë² ë‹ˆ|Benny", "ë¦¬í‚¤|Ricky", "ë¯¸í‚¤|Micky", "ë‹ˆí‚¤|Nicky", "ë¹„í‚¤|Vicky", "ì½”ì½”|Coco", "ëª¨ëª¨|Momo", "í† í† |Toto", "ë£¨ë£¨|Lulu", "í˜í˜|Pepe", "í¬í¬|Popo", "ì¹©|Chip", "ìŠ¤í‚µ|Skip", "í”Œë¦½|Flip", "íŠ¸ë¦½|Trip", "ë‹™|Nip", "ì‹­|Sip", "ë”¥|Dip", "ë¦½|Lip", "í™|Hip", "íŒ|Tip", "ë¹ˆ|Bean", "ë„›|Nut", "ì‹œë“œ|Seed", "ì½˜|Corn", "ë¼ì´ìŠ¤|Rice", "ì˜¤íŠ¸|Oat", "ìœ„íŠ¸|Wheat", "ë¼ì´|Rye", "ë°œë¦¬|Barley", "ëª°íŠ¸|Malt", "ì¿ í‚¤|Cookie", "í¬ë˜ì»¤|Cracker", "ë¨¸í•€|Muffin", "ë„ë„›|Donut", "ë² ì´ê¸€|Bagel", "ë²ˆ|Bun", "ë¡¤|Roll", "íƒ€íŠ¸|Tart", "íŒŒì´|Pie", "ì¼€ì´í¬|Cake", "ë¹•|Bip", "ë°¥|Bop", "ë¹”|Bim", "ë°¤|Bam", "ë´„|Bom", "ë²•|Bub", "ë¹•|Bib", "ë°¥|Bab", "ë±|Beb", "í|Pup", "íŒ|Pop", "í©|Pep", "íŒ¹|Pap", "ë¤|Dum", "ë””|Dee", "ë‘|Doo", "ë‹¤|Dah", "ì•¼|Yah", "ìš”|Yo", "ìœ |Yu", "ì™€|Wa", "ì›Œ|Wo", "ìœ„|We", "ì§€|Zi", "ì£¼|Zu", "ì œ|Ze", "ì|Za", "ê¸°|Gi", "êµ¬|Gu", "ê°œ|Ga"],
                    f: ["ë¯¸ë¯¸|Mimi", "ë‚˜ë‚˜|Nana", "ë¦¬ë¦¬|Lili", "ìŠˆìŠˆ|Shushu", "ì¹˜ì¹˜|Chichi", "ì½”ì½”|Coco", "ë¹„ë¹„|Bibi", "ë¼ë¼|Lala", "ë””ë””|Didi", "í‚¤í‚¤|Kiki", "í‹°í‹°|Titi", "ì§€ì§€|Gigi", "í”¼í”¼|Pipi", "ë©”ë©”|Meme", "ë„¤ë„¤|Nene", "ë¡œë¡œ|Roro", "ì†Œì†Œ|Soso", "ìš”ìš”|Yoyo", "ì£¼ì£¼|Juju", "ì°¨ì°¨|Chacha", "ì¹´ì¹´|Kaka", "íƒ€íƒ€|Tata", "íŒŒíŒŒ|Papa", "í•˜í•˜|Haha", "í˜¸í˜¸|Hoho", "í”¼í”¼|Fifi", "ì‹œì‹œ|Sisi", "ë¹„ë¹„|Vivi", "ë¦¬ë¦¬|Riri", "ì§€ì§€|Zizi", "ë² ë² |Bebe", "ì„¸ì„¸|Cece", "ë°ë°|Dede", "í‚¤í‚¤|Kiki", "ë¯¸ë¯¸|Mimi", "ë¡œì¦ˆ|Rose", "ë¦´ë¦¬|Lily", "ë°ì´ì§€|Daisy", "íŠ¤ë¦½|Tulip", "íŒ¬ì§€|Pansy", "í”¼ì˜¤ë‹ˆ|Peony", "ì˜¤í‚¤ë“œ|Orchid", "ë¡œí„°ìŠ¤|Lotus", "ì¬ìŠ¤ë¯¼|Jasmine", "ì•„ì´ë¦¬ìŠ¤|Iris", "ë°”ì´ì˜¬ë ›|Violet", "í¬í”¼|Poppy", "ë©”ë¦¬ê³¨ë“œ|Marigold", "í™€ë¦¬|Holly", "ì•„ì´ë¹„|Ivy", "í€|Fern", "ëª¨ìŠ¤|Moss", "í´ë¡œë²„|Clover", "ë¯¼íŠ¸|Mint", "ë°”ì§ˆ|Basil", "íŒŒíŒŒ|Fafa", "í‘¸í‘¸|Fufu", "í˜í˜|Fefe", "ì‚¬ì‚¬|Sasa", "ìˆ˜ìˆ˜|Susu", "ì„¸ì„¸|Sese", "ë°”ë°”|Vava", "ë¶€ë¶€|Vuvu", "ë² ë² |Veve", "ìì|Zaza", "ì£¼ì£¼|Zuzu", "ì œì œ|Zeze", "ë‚˜ë‚˜|Nona", "ë‹ˆë‚˜|Nina", "ëˆ„ëˆ„|Nunu", "ë„¤ë„¤|Nene", "ë§ˆë§ˆ|Mama", "ë¬´ë¬´|Mumu", "ë©”ë©”|Meme", "ë¼ë¼|Lara", "ë£¨ë£¨|Lulu", "ë ˆë ˆ|Lele", "ì¹´ì¹´|Kaka", "ì¿ ì¿ |Kuku", "ì¼€ì¼€|Keke", "íƒ€íƒ€|Tata", "íˆ¬íˆ¬|Tutu", "í…Œí…Œ|Tete", "ì™€ì™€|Wawa", "ìš°ìš°|Wuwu"],
                    s: ["(ì„± ì—†ìŒ)|", "(ì„± ì—†ìŒ)|", "(ì„± ì—†ìŒ)|", "(ì„± ì—†ìŒ)|", "(ì„± ì—†ìŒ)|", "í’‹|Foot", "í•¸ë“œ|Hand", "ì•„ì´|Eye", "ì´ì–´|Ear", "ë…¸ì¦ˆ|Nose", "ë§ˆìš°ìŠ¤|Mouth", "í—¤ë“œ|Head", "ì•”|Arm", "ë ˆê·¸|Leg", "í•‘ê±°|Finger", "í† |Toe", "ë°”ë””|Body", "ë°±|Back", "ë²¨ë¦¬|Belly", "í—¤ì–´|Hair", "ìŠ¤í‚¨|Skin", "ë³¸|Bone", "ë¸”ëŸ¬ë“œ|Blood", "í•˜íŠ¸|Heart", "ë§ˆì¸ë“œ|Mind", "í˜ë¸”|Pebble", "ìŠ¤í†¤|Stone", "ë½|Rock", "ìƒŒë“œ|Sand", "ë”ìŠ¤íŠ¸|Dust", "ë”íŠ¸|Dirt", "ë¨¸ë“œ|Mud", "í´ë ˆì´|Clay", "ì‹¤íŠ¸|Silt", "ë¡œì•”|Loam", "ê·¸ë˜ë¸”|Gravel", "ë³¼ë”|Boulder", "ë¸Œë¦­|Brick", "íƒ€ì¼|Tile", "ìŠ¬ë ˆì´íŠ¸|Slate", "ìš°ë“œ|Wood", "ë¡œê·¸|Log", "ìŠ¤í‹±|Stick", "ë¸Œëœì¹˜|Branch", "íŠ¸ìœ„ê·¸|Twig", "ë¦¬í”„|Leaf", "ë£¨íŠ¸|Root", "ë°”í¬|Bark", "ìŠ¤í…œ|Stem", "ìœ|Thorn", "ì”¨ë“œ|Seed", "ë„›|Nut", "ì‰˜|Shell", "í—ˆìŠ¤í¬|Husk", "í•„|Peel", "í¬ëŸ¼|Crumb", "ìŠ¤í™|Speck", "ë‹·|Dot", "ëª¨íŠ¸|Mote", "í”Œë ‰|Fleck", "ë¹„íŠ¸|Bit", "ìŠ¤í¬ë©|Scrap", "ìƒ¤ë“œ|Shard", "ì¹©|Chip", "í”„ë˜ê·¸ë¨¼íŠ¸|Fragment", "í”¼ìŠ¤|Piece", "íŒŒíŠ¸|Part", "í¬ì…˜|Portion", "ì„¹ì…˜|Section", "ìŠ¬ë¼ì´ìŠ¤|Slice", "ì²­í¬|Chunk", "ëŸ¼í”„|Lump", "í´ëŸ¼í”„|Clump", "ì™€ë“œ|Wad", "í—í¬|Hunk", "ë“œë¡­|Drop", "ë¹„ë“œ|Bead", "ë¸”ë¡­|Blob", "ê¸€ë¡­|Glob", "ëŒ€ì‰¬|Dash", "í•€ì¹˜|Pinch", "ìŠ¤ë¯¸ì „|Smidgen", "íŠ¸ë ˆì´ìŠ¤|Trace", "íŒíŠ¸|Hint", "ìœ„ìŠ¤í¼|Whisper"]
                }
            },
            wuxia: {
                noble: {
                    m: ["ì²­ëª…", "ë°±ìš´", "ë¬´ì§„", "ììš´", "íƒœì„", "ì²œìš°", "ëª…ìš´", "ì§„ì²œ", "í˜¸ì—°", "ìƒí˜„", "ìš´ë£¡", "í˜„ì§„", "ë„í˜„", "ë¬¸ê¸°", "í•™ê·œ", "ì†Œìœ ", "ê±´ì˜", "ì‹œìš´", "ê·œí™”", "ë‹¨ìš°", "ì²­ìš´", "ìœ ì„±", "ë¹„ì²œ", "ë¬´ê²½", "í˜„ë„", "ìí•˜", "ì¼ì²­", "ì†Œë°±", "ìš´ì—½", "ì²œê¸°", "í˜•ìš´", "ì§€í•™", "í˜„ë¬´", "ì²­í—ˆ", "ë¬´ì˜", "ì§„ìš°", "ê²½ìˆ˜", "íƒœì‚°", "ìš´ì¤‘", "í˜¸ì˜", "ì²œê´‘", "ë‚™ìš´", "ì‹œí˜„", "ê·œì—°", "ë°±ì²œ", "ì†¡ìš´", "í•™ì§„", "ìœ ë„", "í˜„ì„±", "ì§„í˜", "ìš´í˜„", "ìƒì›", "ìˆ˜í˜„", "ê²½ìš´", "ë„ì›", "ë¬´ê·¹", "ì²­ëŒ", "í™”ìš´", "ì§„ëª…", "ì²œìœ„"],
                    f: ["ì†Œì—°", "í™”ë¦°", "ì²­ì•„", "ìœ ë€", "ë°±ì„¤", "ìë ¹", "ëª…ì£¼", "ì„¤í™”", "ì˜ˆë¦°", "ìœ í™”", "ë¹™ì˜ˆ", "ì†Œí–¥", "ì±„ë ¹", "ì€ì„¤", "ìˆ˜ë ¨", "í™ë ¨", "ë‹¨ì˜", "ë¯¸ë ¹", "ì†Œì›”", "ìí•˜", "ì—°í¬", "ì„œì—°", "ë¹„ë€", "ì•„ì˜", "ì²­ì¡°", "ìœ ë¦¬", "ê°€ì„", "ì„¤ì§€", "í™”ì˜", "ë‚œí–¥", "ì˜¥ë ¨", "ìˆ˜ì•„", "ì§€ì„ ", "í˜œì§„", "ë‚˜ì˜", "ìš°í¬", "ì†Œì„ ", "ë¹„ì—°", "í˜„ì£¼", "ì›”í¬", "ê¸ˆì„ ", "ì±„ìš´", "ì†Œìœ ", "ëª…í•˜", "ì§„ì£¼", "ì„¤í¬", "ìš´ë ¹", "ì²­ìœ ", "í•˜ëŠ˜", "ì€í•˜"],
                    s: ["ë‚¨ê¶", "ì œê°ˆ", "ëª¨ìš©", "í™©ë³´", "ì‚¬ë§ˆ", "ë…ê³ ", "ì„ ìš°", "ìƒê´€", "êµ¬ì–‘", "ì•¼ìœ¨", "ê³µì†", "ì„œë¬¸", "ë™ë°©", "í—Œì›", "í•˜í›„", "ìš°ë¬¸", "ë°±ë¦¬", "ë¶ê¶", "ìë§", "ë‹¨ëª©", "ì§„", "ë°±", "ì´", "ì™•", "ìœ ", "ì¥", "ìš´", "í’", "ë‡Œ", "ì„", "í•œ", "ì¡°", "ì†¡", "ì •", "ì–‘", "í•˜", "ì˜¤", "ì„œ", "ìœ¤", "ê°•", "ê³ ", "ì›", "ê³½", "ì£¼", "ì±„"]
                },
                villain: {
                    m: ["í˜ˆë¹„", "ì²œì•…", "ë¬´ê²°", "ê´‘í˜„", "íŒ¨ì²œ", "ë§ˆë ¹", "ë…ì‹¬", "ì‚´í˜¼", "ê´‘ë§ˆ", "ì—¼ë¼", "í‘ì£¼", "ì‚¬ì‹ ", "íŒŒì²œ", "ë©¸í˜¼", "ê·€ì˜", "ì•…ì‚´", "í˜ˆí’", "ë§ˆì§„", "ë…ìˆ˜", "ì”ì›”", "íŒ¨ì™•", "ì²œì‚´", "ê·¹ë„", "í‘ë£¡", "ì‚¬í˜ˆ", "ë¬´ëª…", "ê·€ë©´", "ë‡Œì˜¥", "ê´‘ë„", "ìŒë§ˆ", "í˜ˆë‘", "ì ìš´", "í˜¼ì„¸", "ë‹¨ì£„", "ì•¼ì°¨", "ìˆ˜ë¼", "ì°¸ê²©", "ë©¸ì²œ", "í‰ìˆ˜", "ì‚¬íŒ¨", "ë…ë£¡", "ë¬´í˜ˆ", "ì‚´ê²", "ì²œë§ˆ", "ì§€ì˜¥", "í­ì—¼", "ê´´ìˆ˜", "ì°¸í˜ˆ", "í™˜ë§ˆ", "í˜ˆê´‘"],
                    f: ["í™ë ¨", "ìš”í™”", "í‘ì¡°", "ë§¤êµ¬", "ë…í¬", "ì‚¬ë…€", "í˜ˆë§¤", "ìŒí¬", "ë§ˆì„¤", "ììš”", "ë¹„ì›”", "ì²œìš”", "ì—¼í¬", "ì ë ¨", "ê·€ë¹„", "ë…ë€", "ì•¼í¬", "ìœ ëª…", "ì‚´í¬", "í‘ì ‘", "í˜ˆí¬", "ëª½ë§ˆ", "í™˜í¬", "ì ˆì˜", "ë§ˆì˜ˆ", "ì†Œì‚´", "ìŒë ¹", "ì í™”", "ìš”ë€", "ë¬´ì—¼", "ë¹„ì‚¬", "í˜ˆì£¼", "ë…ì—°", "ì•”í–¥", "ì‚¬ë ¹", "í‘ë ¨", "ê´´í¬", "ì°¸ì•„", "ë©¸í™”", "ì£¼ë€"],
                    s: ["ë§ˆ", "ë…ê³ ", "ìŒ", "ì‚¬", "ì²œ", "í˜ˆ", "ì¥", "í‘", "ë°°", "ì—¼", "ê·€", "ì•¼", "í­", "ì‚´", "ë‡Œ", "ë¬µ", "ê²¬", "ë‚˜", "ë°©", "ìœ„", "ë‹¹", "íŒ½", "ì„¤", "ê¸ˆ", "ì „", "ë°˜", "ì‹œ", "ê°", "ë™", "ì•…", "í˜•", "ëª½", "ì¢Œ", "ìš°", "í‘œ", "ì–‘", "ëª…"]
                },
                warrior: {
                    m: ["ë¹„ë£¡", "ì¼ë„", "ë¬´ì§„", "ê´‘í˜„", "ì² ì‹¬", "ë‹¨ìš°", "ê²€ì§„", "ì†Œë£¡", "íƒœì‚°", "ë¬´ë¹„", "ê²€í•œ", "ë„ì „", "ê´‘ë„", "ì² ì‚°", "í’ì§„", "í•œìˆ˜", "ê³ ê²€", "ë‚­ì²œ", "ë²½ì‚°", "ì·¨ì„ ", "ë‹¨ìš´", "ê²€ë§ˆ", "íŒ¨ë„", "ë¬´ìƒ", "ìœ í˜‘", "ì§„ê²€", "ì²œí˜¸", "ì§ˆí’", "ë²ˆê°œ", "ë¬´ì‹", "ì² ìš°", "ê°•ì² ", "í˜¸ê±¸", "ìš©ë¹„", "ë°±í˜¸", "ì²­ë£¡", "ë¹„ê²€", "ë‹¨ì›”", "ë¬´ì‹ ", "ê³ ì˜", "í•œë¹„", "ì²œë‘", "ì›”í’", "ì í˜¸", "ë‡Œì „", "ì¾Œê²€", "í™˜ê²€", "ë¬´ì •", "ì ë£¡", "í’ìš´"],
                    f: ["ê²€í¬", "ë¬´ì˜", "ë¹„ì—°", "ì±„ë ¹", "ì›”ì˜", "ì†Œì›”", "ì€ì„¤", "ë¯¸ë ¹", "ë‹¨ì˜", "ì†Œí–¥", "ëª…ì›”", "ì²­ì„¤", "í•œì›”", "ìœ ì„±", "ë¹„ë ¹", "ê²€í–¥", "ë¬´ë€", "ì„¤ê²€", "ì²­í–¥", "ì€ë¹„", "ë¹„í™”", "ì›”í•˜", "ë‹¨ì‹¬", "ì—°ë¬´", "í˜¸ì—°", "ì§„ì•„", "ì„¤ë€", "ì²­ë¹™", "ì—¬í˜‘", "ë¹„ë‹¨", "ìš´ê²€", "í–¥ë¬´", "ì†Œí˜‘", "ìì˜", "í˜œê²€", "ë¬´ì†Œ", "ì›”ì•„", "ì²­ë ¨", "ë¹„ì·¨", "ë‹¨í–¥"],
                    s: ["ê³½", "í•˜", "í•œ", "ì„", "ì°¨", "ê³ ", "ì„", "ì£¼", "ì–‘", "í‘œ", "ì„¤", "í™", "ë°°", "ì „", "ë…¸", "ë¬¸", "ë°©", "ì„±", "ì˜¤", "ìœ¡", "ì§€", "í—ˆ", "í˜„", "ì¶”", "ë‹¨", "ë¬µ", "ê³µ", "ê°", "íƒ", "ìœ„", "ëª¨", "í¸", "êµ­", "ì–´", "ìš©", "ë‚¨", "ë¹„", "ë„"]
                }
            },
            korean: {
                modern: {
                    m: ["ë¯¼ì¤€", "ì„œì¤€", "ë„ìœ¤", "ì˜ˆì¤€", "ì‹œìš°", "í•˜ì¤€", "ì§€í˜¸", "ì£¼ì›", "ì§€í›„", "ì¤€ìš°", "ì¤€ì„œ", "ë„í˜„", "ê±´ìš°", "í˜„ìš°", "ìš°ì§„", "ì§€í›ˆ", "ì„ ìš°", "ìœ ì¤€", "ì„œì§„", "ì—°ìš°", "ì€ìš°", "ë¯¼ì¬", "í˜„ì¤€", "ì‹œìœ¤", "ì •ìš°", "ì´ì¤€", "ìŠ¹ìš°", "ìœ¤ìš°", "ì§€í™˜", "ì§€ìš°", "ìŠ¹í˜„", "ìœ ì°¬", "ì¤€í˜", "ìˆ˜í˜¸", "ìŠ¹ë¯¼", "ì‹œí›„", "ì§„ìš°", "ë¯¼ì„±", "ì¤€ì˜", "ìˆ˜í˜„", "ì§€ì›", "ì´ì•ˆ", "ì¬ìœ¤", "ì‹œí˜„", "íƒœìœ¤", "í•œê²°", "ì§€ì•ˆ", "ë™í˜„", "ìœ¤í˜¸", "ì‹œì›", "ì€ì°¬", "ì‹œì˜¨", "ë¯¼ìš°", "ì¬ì›", "ë¯¼ê·œ", "ì§€í•œ", "ì„œìš°", "ì€í˜¸", "ì¬ë¯¼", "ë¯¼ì°¬", "ìš°ì£¼", "ìš°ë¹ˆ", "í•˜ìœ¨", "ì¤€í˜¸", "ì§€ìœ¨", "ì„±ë¯¼", "ìŠ¹ì¤€", "í•˜ì§„", "ì„±í˜„", "ì¬í˜„", "í˜„ì„œ", "ë¯¼í˜¸", "íƒœë¯¼", "ì˜ˆì„±", "ì§€ì„±", "ì§€ë¯¼", "ìœ¤ì¬", "íƒœí˜„", "ë¯¼í˜", "í•˜ëŒ", "ë„í›ˆ", "ì´ë“ ", "ì§€ì˜¤", "ê°•ë¯¼", "ì§€ì™„", "íƒœì¤€", "ì¤€ì„±", "í•˜ë‘", "ìŠ¹ì›", "ë„ì˜", "í˜„ìˆ˜", "ì •í˜„", "ìŠ¹í˜¸", "ë„ìœ¨", "ì‹œìœ¨", "ì„±ë¹ˆ", "ìš°í˜„", "ì‹œí›ˆ", "ë¯¼ì„œ", "ì„œìœ¨", "ê±´í¬", "ì‹œì™„", "ì£¼í™˜", "ë¼ì˜¨", "ì›ì¤€", "ë¯¼ìˆ˜", "ì •í›ˆ", "íƒœì˜¤", "í˜„ë¯¼", "ìŠ¹ìœ¤", "ë™í•˜", "ë¯¼ê¸°", "ì¬í•˜", "ì£¼ì˜", "ë„ê²½", "ì„œí›„", "ë‹¨ìš°", "ê²½ë¯¼", "ë¯¼ê±´", "í˜„ì„±", "ì‹œí™˜", "ì‹œì•ˆ", "ë„ì›", "ì •í›„", "ê°€ì˜¨", "ì˜¨ìœ ", "ìŠ¹ë¹ˆ", "ì •ì›", "í˜¸ì¤€", "íƒœí›ˆ", "ì¬ì¤€", "ì¬í›ˆ", "íƒœì˜", "ì„¸í˜„", "ë™ê±´", "ì—°ì¤€", "íƒœê²½", "ë„ì¤€", "ìœ ê±´", "ë²”ì¤€", "í•˜ì˜¨", "ì°¬ì˜", "íƒœìœ¨", "í˜„ì§„", "ì¬ì˜", "ì˜ì¤€", "ì„±ìœ¤", "í•˜ìœ¤", "í˜„ìŠ¹", "ì£¼í˜", "ìƒí˜„", "ì°¬ìš°", "ì§€í˜", "ì„¸ì¤€", "ìŠ¹í›ˆ", "í•˜ëŠ˜", "ìŠ¹ì¬", "ë™ìœ¤", "ìš°ì„±", "ê±´í˜¸", "íƒœí˜¸", "ì°¬í¬", "ìœ¤ì°¬", "ìœ¤í›„", "ì„±í›ˆ", "ìœ ì•ˆ", "ì§€ìš´", "ì—°í˜¸", "ìˆ˜ë¯¼", "ì„œí˜¸", "ìœ í˜„", "ë™ìš±", "ìŠ¹ì°¬", "ë„ê²¸", "íƒœìš°", "ê·œë¹ˆ", "í˜„í˜¸", "ì£¼í•œ", "ì„œì›", "ì¬ìš°", "í˜„ë¹ˆ", "ì¬í¬", "ìˆ˜í˜", "ì£¼ì™„", "ìœ ì§„", "íš¨ì¤€", "ìš°ì°¬", "ì‹œí—Œ", "ì£¼í˜„", "ì¤€ì„", "ì€ìœ¨", "ì¬í˜", "ë™ìš°", "ì„ í˜¸", "í˜•ì¤€", "ì´í•œ", "ì„±ìš°", "ìƒìœ¤", "ë„ì§„", "ìš°ì˜"],
                    f: ["ì„œì—°", "ë¯¼ì„œ", "ì§€ìš°", "ì„œìœ¤", "í•˜ì€", "ì§€ì•ˆ", "ìˆ˜ì•„", "í•˜ë¦°", "ìœ ë‚˜", "ì„œì•„", "ì±„ì›", "ì§€ìœ ", "ë‹¤ì¸", "ì˜ˆì€", "ìˆ˜ë¹ˆ", "ì‹œì•„", "ì†Œìœ¨", "ì•„ë¦°", "ë‹¤ì€", "ë‚˜ì€", "ìœ ì§„", "ì§€ì›", "ì˜ˆë¦°", "ì§€ì€", "ìˆ˜ì§„", "ì€ì§€", "ë¯¼ì§€", "ìœ¤ì•„", "ì±„ì€", "ê°€ì€", "ì„œí˜„", "ì˜ˆì§„", "ì„œì˜", "ì§€ë¯¼", "ì˜ˆì›", "ìœ¤ì„œ", "ì†Œìœ¤", "ì§€í˜„", "í•˜ìœ¤", "ì€ìš°", "í˜„ì§€", "ì±„ìš°", "ì˜ˆì§€", "ì‹œì€", "ë¯¼ì£¼", "ë‹¤ì—°", "ì—°ìš°", "ìˆ˜ë¯¼", "ì±„ì•„", "ë‹¤ì˜¨", "ì§€ì•„", "ì‹œí˜„", "ì£¼í•˜", "ìŠ¹ì—°", "ì„œì§„", "ì„œì€", "ë‚˜ìœ¤", "ì±„ì—°", "ì˜ˆë‚˜", "ë¯¼ì±„", "ë‹¤í˜„", "ê°€ìœ¤", "í•˜ìœ¨", "ì •ì›", "íƒœí¬", "ë„ì—°", "ì‹œì—°", "ì„œìœ¨", "ì€ì„œ", "ì˜ˆë¹ˆ", "ì§€ìœ¤", "ë‚˜ì—°", "ì˜ˆë¦¼", "ì—°ì„œ", "í•˜ì˜", "ìˆ˜í˜„", "ê·œë¦¬", "ì•„ì¸", "ì€ì±„", "ì£¼ì•„", "ì†Œì€", "ì„œìš°", "ìœ ì£¼", "ìœ¤ì§€", "ë‹¤ì†œ", "ì†Œë¯¼", "ì§€ì˜¨", "ì‚¬ë‘", "ì˜ˆì„œ", "ì±„ì›", "ìœ ë¹ˆ", "ê°€ì˜¨", "ì§€ì•ˆ", "ì„¤ì•„", "ìˆ˜ì•„", "ì´ì„œ", "ì´ìˆ˜", "ì´ì•ˆ", "ì´ë¹ˆ", "ì´í˜„", "ë‚˜ì€", "í•˜ì˜¨", "í•˜ì§„", "ì£¼ì€", "ì±„ë¯¼", "ì±„ë¹ˆ", "ì±„ì´", "ì±„ìœ¤", "ì±„ìœ¨", "ì±„ì€", "íƒœë¦¬", "íƒœë¦°", "íƒœì—°", "íƒœì€", "íƒœì´", "íƒœì¸", "íƒœí¬", "í•˜ëŠ˜", "í•˜ë‚˜", "í•˜ë£¨", "í•˜ë¦¬", "í•˜ë¯¼", "í•˜ì„œ", "í•˜ì†”", "í•˜ì—°", "í•˜ì˜", "í•˜ì˜¨", "í•˜ìœ¤", "í•˜ì€", "í•˜ì§„", "í•œë‚˜", "í•œë³„", "í•œë¹„", "í•œì†”", "í•œì´", "í•´ë‚˜", "í•´ë¦°", "í•´ìˆ˜", "í•´ì˜¨", "í•´ìœ¤", "í•´ì¸", "í˜„ì„œ", "í˜„ìˆ˜", "í˜„ì•„", "í˜„ì˜", "í˜„ìœ ", "í˜„ì£¼", "í˜„ì§€", "í˜œë‚˜", "í˜œë¦°", "í˜œë¯¼", "í˜œë¹ˆ", "í˜œì„œ", "í˜œìˆ˜", "í˜œì—°", "í˜œì˜", "í˜œì›", "í˜œìœ¤", "í˜œì¸", "í˜œì£¼"],
                    s: ["ê¹€", "ì´", "ë°•", "ì •", "ìµœ", "ì¡°", "ê°•", "ìœ¤", "ì¥", "ì„", "ì‹ ", "ìœ ", "í•œ", "ì˜¤", "ì„œ", "ì „", "ê¶Œ", "í™©", "ì•ˆ", "ì†¡", "í™", "ì–‘", "ê³ ", "ë¬¸", "ì†", "ë°°", "ë°±", "í—ˆ", "ë…¸", "ë‚¨", "ì‹¬", "í•˜", "ì£¼", "êµ¬", "ê³½", "ì„±", "ì°¨", "ìš°", "ì§„", "ë¯¼", "ë¥˜", "ë‚˜", "ì§€", "ì—„", "ë³€", "ì±„", "ì›", "ë°©", "ì²œ", "ê³µ", "í˜„", "í•¨", "ì—¬", "ì—¼", "ì„", "ì¶”", "ë„", "ì†Œ", "ì„¤", "ì„ ", "ë§ˆ", "ê¸¸", "ì—°", "ìœ„", "í‘œ", "ëª…", "ê¸°", "ë°˜", "ë¼", "ì™•", "ê¸ˆ", "ì˜¥", "ìœ¡", "ì¸", "ë§¹", "ì œ", "ëª¨", "íƒ", "êµ­", "ì–´", "ê²½", "ì€", "í¸", "ìš©", "ì˜ˆ", "ë´‰", "ì‚¬", "ë¶€", "ê°€", "ë³µ", "íƒœ", "ëª©", "í˜•", "í”¼", "ë‘", "ê°", "í˜¸", "ì œê°ˆ", "ë‚¨ê¶", "ë…ê³ ", "ì„ ìš°", "í™©ë³´"]
                },
                classic: {
                    m: ["ì˜ìˆ˜", "ì˜í˜¸", "ì˜ì‹", "ì˜ì² ", "ì •ìˆ˜", "ì •í˜¸", "ì •ì‹", "ì •í›ˆ", "ì„±ìˆ˜", "ì„±í˜¸", "ì„±í›ˆ", "ì„±ì§„", "ì² ìˆ˜", "ì² í˜¸", "ì² ë¯¼", "ë¯¼ìˆ˜", "ë¯¼í˜¸", "ë¯¼ì² ", "ë§Œìˆ˜", "ë™ìˆ˜", "ë™í˜„", "ë™í›ˆ", "ì§„ìˆ˜", "ì§„í˜¸", "ì¤€í˜¸", "ì¤€ìˆ˜", "ê´‘ìˆ˜", "ê´‘í˜¸", "ìƒí›ˆ", "ìƒìš°", "ìƒì² ", "ë³‘ì² ", "ë³‘ìˆ˜", "ì¬í˜¸", "ì¬ì„", "ê²½ìˆ˜", "ì¢…ìˆ˜", "ì¢…í˜¸", "ì¢…í›ˆ", "ëª…ìˆ˜", "ëª…í˜¸", "í˜„ìˆ˜", "í˜„ìš°", "í˜„ì² ", "ê¸°ìˆ˜", "ê¸°ì² ", "ì„ìˆ˜", "ì„í˜¸"],
                    f: ["ì˜í¬", "ì˜ìˆ™", "ì˜ì", "ì˜ìˆœ", "ì •ìˆ™", "ì •í¬", "ì •ìˆœ", "ì •ì", "ìˆœì", "ìˆœí¬", "ìˆœì •", "ë¯¸ìˆ™", "ë¯¸ê²½", "ë¯¸ì˜", "ë¯¸ì", "ë¯¸í¬", "ê²½ìˆ™", "ê²½í¬", "ê²½ì", "ê²½ìˆœ", "í˜œì", "í˜œìˆ™", "í˜œê²½", "í˜œì˜", "í˜œì •", "í¬ì", "í¬ìˆ™", "í¬ê²½", "í¬ì •", "ìˆ™ì", "ìˆ™í¬", "ëª…ì", "ëª…ìˆ™", "ëª…í¬", "í˜„ìˆ™", "í˜„ì •", "í˜„ì£¼", "í˜„í¬", "ì€ì£¼", "ì€ì˜", "ì€ìˆ™", "ì€ê²½", "ì€í¬", "ì§€ì˜", "ì§€ìˆ™", "ì§€í˜„", "ì§€í˜œ", "ìˆ˜ì§„"],
                    s: ["ê¹€", "ì´", "ë°•", "ìµœ", "ì •", "ê°•", "ì¡°", "ìœ¤", "ì¥", "ì„", "í•œ", "ì˜¤", "ì„œ", "ì „", "ê¶Œ", "í™©", "ì•ˆ", "ì†¡", "í™", "ì–‘", "ê³ ", "ë¬¸", "ì†", "ë°°", "ë°±", "í—ˆ", "ìœ ", "ë‚¨", "ì‹¬", "ë…¸"]
                }
            }
        };
        window.NAME_ROLES = {
            fantasy: [
                { id: 'royalty', text: 'ğŸ‘‘ ì™•ì¡± / ê³ ìœ„ ê·€ì¡±' },
                { id: 'knight', text: 'âš”ï¸ ê¸°ì‚¬ / ì „ì‚¬' },
                { id: 'wizard', text: 'âœ¨ ë§ˆë²•ì‚¬ / í˜„ì' },
                { id: 'commoner', text: 'ğŸ”¨ í‰ë¯¼ / ìƒì¸' },
                { id: 'servant', text: 'ğŸ§¹ í•˜ì¸ / í¬ë¦¬ì²˜' }
            ],
            wuxia: [
                { id: 'noble', text: 'ğŸ¯ ëª…ë¬¸ ì„¸ê°€ / ì •íŒŒ' },
                { id: 'villain', text: 'ğŸ˜ˆ ì‚¬íŒŒ / ë§ˆêµ' },
                { id: 'warrior', text: 'ğŸ—¡ï¸ ë‚­ì¸ / í˜‘ê°' }
            ],
            korean: [
                { id: 'modern', text: 'ğŸ“± í˜„ëŒ€ì  / íŠ¸ë Œë””' },
                { id: 'classic', text: 'ğŸ“º ì „í†µì  / ì¤‘í›„í•¨' }
            ]
        };
    </script>

    <script type="text/babel">
        const { useState, useCallback, useRef, useMemo, useEffect, memo } = React;
        const { motion, AnimatePresence, Reorder } = window.Motion;
        const CARD_W = 250;
        const CARD_H = 200;
        const FONT_DISPLAY_NAMES = {
            maruburi: "ë§ˆë£¨ë¶€ë¦¬",
            Ridibatang: "ë¦¬ë””ë°”íƒ•",
            Galmuri14: "ê°ˆë¬´ë¦¬14",
            pretendard: "í”„ë¦¬í…ë‹¤ë“œ"
        };
        const BOOK_COLORS = [
            '#1c1917', '#44403c', '#78716c', '#9f1239', '#be4d67', '#c2724c',
            '#a3703c', '#8b7355', '#5c6d4a', '#4a766e', '#3d6a73', '#456b8a',
            '#4a5d7a', '#5b5d8a', '#6b5b7a', '#7a5b6d', '#8c6478', '#6d5c5c'
        ];
        const NAME_DB = window.NAME_DB;
        const NAME_ROLES = window.NAME_ROLES;
        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
        const IconPlus = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14" /><path d="M12 5v14" /></svg>);
        const IconTrash = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></svg>);
        const IconSettings = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>);
        const IconBack = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>);
        const IconUpload = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>);
        const IconSave = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg>);
        const IconSun = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5" /><path d="M12 1v2" /><path d="M12 21v2" /><path d="M4.22 4.22l1.42 1.42" /><path d="M18.36 18.36l1.42 1.42" /><path d="M1 12h2" /><path d="M21 12h2" /><path d="M4.22 19.78l1.42-1.42" /><path d="M18.36 5.64l1.42-1.42" /></svg>);
        const IconMoon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></svg>);
        const IconZen = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" /></svg>);
        const IconFont = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7" /><line x1="9" y1="20" x2="15" y2="20" /><line x1="12" y1="4" x2="12" y2="20" /></svg>);
        const IconFileText = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></svg>);
        const IconLayout = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /><line x1="10" x2="14" y1="6.5" y2="6.5" /><line x1="10" x2="14" y1="17.5" y2="17.5" /><line x1="6.5" x2="6.5" y1="10" y2="14" /><line x1="17.5" x2="17.5" y1="10" y2="14" /></svg>);
        const getCaretCoordinates = (element, position) => { const div = document.createElement('div'); const style = window.getComputedStyle(element); const props = ['fontFamily', 'fontSize', 'fontWeight', 'lineHeight', 'padding', 'border', 'width', 'boxSizing', 'whiteSpace', 'wordWrap']; props.forEach(prop => div.style[prop] = style[prop]); div.style.position = 'absolute'; div.style.visibility = 'hidden'; div.textContent = element.value.substring(0, position); const span = document.createElement('span'); span.textContent = element.value.substring(position) || '.'; div.appendChild(span); document.body.appendChild(div); const rect = element.getBoundingClientRect(); const coordinates = { top: rect.top + span.offsetTop + element.scrollTop, left: rect.left + span.offsetLeft }; document.body.removeChild(div); return coordinates; };
        const getWordAtPos = (text, pos) => { if (!text) return ""; const left = text.slice(0, pos).search(/[^\s#@]*$/); const right = text.slice(pos).search(/[\s\n\r]/); const word = text.slice(left, right === -1 ? undefined : right + pos); return word.replace(/[#@]/g, '').trim(); };
        const getBezierPath = (x1, y1, x2, y2) => { const dx = x2 - x1; const dy = y2 - y1; const curvature = 0.5; const cx1 = x1 + dx * curvature; const cy1 = y1; const cx2 = x2 - dx * curvature; const cy2 = y2; return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`; };
        const getEdgeTargetPos = (from, to, offset = 12) => { const x1 = from.x + CARD_W / 2; const y1 = from.y + CARD_H / 2; const x2 = to.x + CARD_W / 2; const y2 = to.y + CARD_H / 2; const dx = x2 - x1; const dy = y2 - y1; const angle = Math.atan2(dy, dx); const absCos = Math.abs(Math.cos(angle)); const absSin = Math.abs(Math.sin(angle)); let distance = (CARD_W * absSin <= CARD_H * absCos) ? (CARD_W / 2) / absCos : (CARD_H / 2) / absSin; return { x: x2 - Math.cos(angle) * (distance + offset), y: y2 - Math.sin(angle) * (distance + offset) }; };
        const getRoleBadgeStyle = (role) => { switch (role) { case 'ì£¼ì¸ê³µ': return 'bg-blue-600 dark:bg-blue-800 text-white'; case 'ì ëŒ€ì': return 'bg-red-600 dark:bg-red-800 text-white'; case 'ì¡°ë ¥ì': return 'bg-emerald-600 dark:bg-emerald-800 text-white'; case 'ì¡°ì—°': return 'bg-slate-500 text-white'; case 'ì—‘ìŠ¤íŠ¸ë¼': return 'bg-slate-300 text-slate-600'; default: return 'bg-slate-100 text-slate-500 border border-slate-200'; } };
        const getStatusBadgeStyle = (status) => { switch (status) { case 'ì´ˆê³ ': return 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300'; case 'ìˆ˜ì •': return 'bg-amber-100 text-amber-600 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800'; case 'ì™„ë£Œ': return 'bg-emerald-600 text-white'; default: return 'bg-slate-100 text-slate-400'; } };
        // ë…¸ë“œ íƒ€ì…ë³„ ìƒ‰ìƒ ì •ì˜
        const NODE_TYPE_COLORS = {
            'ì¸ë¬¼': { sidebar: 'border-l-blue-500 dark:border-l-blue-400', selected: 'border-blue-500 dark:border-blue-400', bar: 'bg-blue-600 dark:bg-blue-600', text: 'text-blue-600 dark:text-blue-400', bg: 'bg-blue-500', hover: 'hover:bg-blue-50 dark:hover:bg-blue-950/50' },
            'ì‚¬ê±´': { sidebar: 'border-l-red-500 dark:border-l-red-400', selected: 'border-red-500 dark:border-red-400', bar: 'bg-red-600 dark:bg-red-600', text: 'text-red-600 dark:text-red-400', bg: 'bg-red-500', hover: 'hover:bg-red-50 dark:hover:bg-red-950/50' },
            'ë©”ëª¨': { sidebar: 'border-l-amber-500 dark:border-l-amber-400', selected: 'border-amber-500 dark:border-amber-400', bar: 'bg-amber-500 dark:bg-amber-600', text: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-500', hover: 'hover:bg-amber-50 dark:hover:bg-amber-950/50' },
            'ì¥ì†Œ': { sidebar: 'border-l-emerald-500 dark:border-l-emerald-400', selected: 'border-emerald-500 dark:border-emerald-400', bar: 'bg-emerald-600 dark:bg-emerald-600', text: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-500', hover: 'hover:bg-emerald-50 dark:hover:bg-emerald-950/50' },
            'ì•„ì´í…œ': { sidebar: 'border-l-purple-500 dark:border-l-purple-400', selected: 'border-purple-500 dark:border-purple-400', bar: 'bg-purple-600 dark:bg-purple-600', text: 'text-purple-600 dark:text-purple-400', bg: 'bg-purple-500', hover: 'hover:bg-purple-50 dark:hover:bg-purple-950/50' },
            'ì„¸ë ¥': { sidebar: 'border-l-orange-500 dark:border-l-orange-400', selected: 'border-orange-500 dark:border-orange-400', bar: 'bg-orange-600 dark:bg-orange-600', text: 'text-orange-600 dark:text-orange-400', bg: 'bg-orange-500', hover: 'hover:bg-orange-50 dark:hover:bg-orange-950/50' },
            'ë³µì„ ': { sidebar: 'border-l-pink-500 dark:border-l-pink-400', selected: 'border-pink-500 dark:border-pink-400', bar: 'bg-pink-600 dark:bg-pink-600', text: 'text-pink-600 dark:text-pink-400', bg: 'bg-pink-500', hover: 'hover:bg-pink-50 dark:hover:bg-pink-950/50' },
            'íƒ€ì„ë¼ì¸': { sidebar: 'border-l-teal-500 dark:border-l-teal-400', selected: 'border-teal-500 dark:border-teal-400', bar: 'bg-teal-600 dark:bg-teal-600', text: 'text-teal-600 dark:text-teal-400', bg: 'bg-teal-500', hover: 'hover:bg-teal-50 dark:hover:bg-teal-950/50' },
            'ì„¤ì •': { sidebar: 'border-l-indigo-500 dark:border-l-indigo-400', selected: 'border-indigo-500 dark:border-indigo-400', bar: 'bg-indigo-600 dark:bg-indigo-600', text: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-500', hover: 'hover:bg-indigo-50 dark:hover:bg-indigo-950/50' },
            'ëŒ€ì‚¬': { sidebar: 'border-l-sky-500 dark:border-l-sky-400', selected: 'border-sky-500 dark:border-sky-400', bar: 'bg-sky-600 dark:bg-sky-600', text: 'text-sky-600 dark:text-sky-400', bg: 'bg-sky-500', hover: 'hover:bg-sky-50 dark:hover:bg-sky-950/50' },
            'ê°ˆë“±': { sidebar: 'border-l-rose-500 dark:border-l-rose-400', selected: 'border-rose-500 dark:border-rose-400', bar: 'bg-rose-600 dark:bg-rose-600', text: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-500', hover: 'hover:bg-rose-50 dark:hover:bg-rose-950/50' },
            'í• ì¼': { sidebar: 'border-l-cyan-500 dark:border-l-cyan-400', selected: 'border-cyan-500 dark:border-cyan-400', bar: 'bg-cyan-600 dark:bg-cyan-600', text: 'text-cyan-600 dark:text-cyan-400', bg: 'bg-cyan-500', hover: 'hover:bg-cyan-50 dark:hover:bg-cyan-950/50' },
            'ê·¸ë£¹': { sidebar: 'border-l-slate-500 dark:border-l-slate-400', selected: 'border-slate-500 dark:border-slate-400', bar: 'bg-slate-600 dark:bg-slate-600', text: 'text-slate-600 dark:text-slate-400', bg: 'bg-slate-500', hover: 'hover:bg-slate-50 dark:hover:bg-slate-800/50' }
        };
        // ë…¸ë“œ íƒ€ì…ë³„ ê¸°ë³¸ ì´ëª¨ì§€
        const NODE_TYPE_EMOJIS = {
            'ì¸ë¬¼': 'ğŸ‘¤', 'ì‚¬ê±´': 'ğŸ”¥', 'ë©”ëª¨': 'ğŸ’¡', 'ì¥ì†Œ': 'ğŸ“', 'ì•„ì´í…œ': 'ğŸ',
            'ì„¸ë ¥': 'âš”ï¸', 'ë³µì„ ': 'ğŸ£', 'íƒ€ì„ë¼ì¸': 'â°', 'ì„¤ì •': 'ğŸ“š', 'ëŒ€ì‚¬': 'ğŸ’¬', 'ê°ˆë“±': 'âš¡', 'í• ì¼': 'âœ…', 'ê·¸ë£¹': 'ğŸ“'
        };
        const getSidebarItemAccent = (node) => {
            return NODE_TYPE_COLORS[node.type]?.sidebar || 'border-l-transparent';
        };
        const getSelectedBorderColor = (node) => {
            return NODE_TYPE_COLORS[node.type]?.selected || 'border-indigo-500 dark:border-indigo-600';
        };
        const getNodeBarColor = (node) => {
            return NODE_TYPE_COLORS[node.type]?.bar || 'bg-slate-500 dark:bg-slate-700';
        };
        const getStrokeDashArray = (style, width) => {
            const w = width || 2;
            switch (style) {
                case 'dashed': return `${w * 2}, ${w * 2}`;
                case 'dotted': return `0, ${w * 2}`;
                default: return "";
            }
        };

        // Toast
        const Toast = ({ message, type, onClose }) => (
            <motion.div initial={{ y: 50, opacity: 0, scale: 0.9 }} animate={{ y: 0, opacity: 1, scale: 1 }} exit={{ y: 50, opacity: 0, scale: 0.9 }} className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] flex items-center gap-3 bg-zinc-800 dark:bg-zinc-100 text-white dark:text-zinc-900 px-6 py-3 rounded-full shadow-2xl">
                <span className="text-sm font-bold">{message}</span>
            </motion.div>
        );

        // PomodoroTimer
        const PomodoroTimer = ({
            minutes, setMinutes,
            seconds, setSeconds,
            isActive, setIsActive,
            initialTotal, setInitialTotal,
            remaining, setRemaining,
            isSetting, setIsSetting,
            showToast
        }) => {
            const start = () => {
                if (remaining <= 0) return;
                setIsActive(true);
            };
            const stop = () => setIsActive(false);
            const reset = () => {
                setIsActive(false);
                setRemaining(initialTotal);
            };

            const handleSetTime = () => {
                const total = minutes * 60 + seconds;
                if (total > 0) {
                    setInitialTotal(total);
                    setRemaining(total);
                    setIsSetting(false);
                } else {
                    showToast("ì‹œê°„ì„ ì„¤ì •í•˜ì„¸ìš”", "error");
                }
            };

            const format = (s) => {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            };

            return (
                <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -10 }}
                    className="bg-white dark:bg-darkpanel border border-slate-200 dark:border-zinc-700 rounded-xl shadow-2xl overflow-hidden w-52 mt-2 pointer-events-auto"
                >
                    <div className="p-4">
                        <div className="flex items-center justify-between mb-3">
                            <span className="text-[12px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
                                <span className="w-1.5 h-1.5 bg-indigo-700 rounded-full animate-pulse"></span>
                                ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸
                            </span>
                            <button onClick={() => setIsSetting(!isSetting)} className="p-1.5 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-full transition-colors text-slate-400 hover:text-indigo-600">
                                <IconSettings className="w-3.5 h-3.5" />
                            </button>
                        </div>

                        {isSetting ? (
                            <div className="space-y-4 py-1">
                                <div className="flex gap-3">
                                    <div className="flex-1">
                                        <label className="text-[9px] font-black text-slate-400 block mb-1.5 uppercase">ë¶„</label>
                                        <input type="number" value={minutes} onChange={e => setMinutes(parseInt(e.target.value) || 0)} className="w-full p-2 text-sm font-black bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded outline-none focus:border-indigo-500 dark:text-zinc-200" />
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-[9px] font-black text-slate-400 block mb-1.5 uppercase">ì´ˆ</label>
                                        <input type="number" value={seconds} onChange={e => setSeconds(parseInt(e.target.value) || 0)} className="w-full p-2 text-sm font-black bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded outline-none focus:border-indigo-500 dark:text-zinc-200" />
                                    </div>
                                </div>
                                <button onClick={handleSetTime} className="w-full py-2.5 bg-slate-900 dark:bg-indigo-600 text-white text-[11px] font-black rounded hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-500/20">ì ìš©í•˜ê¸°</button>
                            </div>
                        ) : (
                            <>
                                <div className="relative w-32 h-32 mx-auto my-2">
                                    <svg viewBox="0 0 100 100" className="w-full h-full -rotate-90">
                                        {/* Background Circle */}
                                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-100 dark:text-zinc-800" />

                                        {/* Time Wedge (Elapsed) */}
                                        <circle
                                            cx="50" cy="50" r="22.5"
                                            fill="none"
                                            stroke="#ef4444"
                                            strokeWidth="45"
                                            strokeDasharray={2 * Math.PI * 22.5}
                                            style={{
                                                strokeDashoffset: (2 * Math.PI * 22.5) * (remaining / initialTotal),
                                                transition: isActive ? 'stroke-dashoffset 1s linear' : 'none',
                                            }}
                                            className="opacity-80"
                                        />

                                        {/* Ticks */}
                                        {[...Array(12)].map((_, i) => (
                                            <line
                                                key={i}
                                                x1="50" y1="10" x2="50" y2="15"
                                                transform={`rotate(${i * 30} 50 50)`}
                                                stroke="currentColor"
                                                strokeWidth="1"
                                                className="text-slate-300 dark:text-zinc-600"
                                            />
                                        ))}
                                    </svg>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                                        <span className="text-xs font-black text-slate-800 dark:text-zinc-100 font-mono bg-white/80 dark:bg-zinc-900/80 px-2 py-0.5 rounded-full shadow-sm border border-slate-100 dark:border-zinc-700 pointer-events-none">
                                            {format(remaining)}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex gap-2 justify-center mt-4">
                                    <button
                                        onClick={() => isActive ? stop() : start()}
                                        className={`flex-1 py-2.5 rounded-lg font-black text-[11px] transition-all tracking-widest ${isActive ? 'bg-amber-50 text-amber-600 hover:bg-amber-100 dark:bg-amber-900/20' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-500/20'}`}
                                    >
                                        {isActive ? "ë©ˆì¶¤" : "ì‹œì‘"}
                                    </button>
                                    <button onClick={reset} className="px-3.5 py-2.5 bg-slate-100 dark:bg-zinc-800 text-slate-400 hover:text-red-500 rounded-lg transition-colors border border-slate-200 dark:border-zinc-700">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </motion.div>
            );
        };

        // NodeCard - ë…¸ë“œ íƒ€ì…ë³„ ì„œë¸Œë¼ì¸ ë Œë”ë§
        const getNodeSubline = (node) => {
            switch (node.type) {
                case 'ì¸ë¬¼': return `${node.data.gender} Â· ${node.data.age ? `${node.data.age}ì„¸` : 'ë‚˜ì´ ë¯¸ìƒ'} Â· ${node.data.job || 'ì§ì—… ì—†ìŒ'}`;
                case 'ì‚¬ê±´': return `ğŸ“ ${node.data.place || 'ì¥ì†Œ ë¯¸ìƒ'} Â· ğŸ“… ${node.data.year || 'ì‹œê¸° ë¯¸ìƒ'}`;
                case 'ì¥ì†Œ': return `ğŸŒ ${node.data.region || 'ì§€ì—­ ë¯¸ìƒ'} Â· ğŸŒ¤ï¸ ${node.data.climate || 'ê¸°í›„ ë¯¸ìƒ'}`;
                case 'ì•„ì´í…œ': return `ğŸ“¦ ${node.data.category || 'ì¼ë°˜'} Â· â­ ${node.data.rarity || 'ë³´í†µ'}`;
                case 'ì„¸ë ¥': return `ğŸ‘‘ ${node.data.leader || 'ë¦¬ë” ë¯¸ìƒ'} Â· ğŸ° ${node.data.territory || 'ì˜ì—­ ë¯¸ìƒ'}`;
                case 'ë³µì„ ': return `ğŸ“– ${node.data.chapter || 'ì¥ ë¯¸ìƒ'} Â· ${node.data.status === 'íšŒìˆ˜ë¨' ? 'âœ… íšŒìˆ˜ë¨' : 'ğŸ”„ ë¯¸íšŒìˆ˜'}`;
                case 'íƒ€ì„ë¼ì¸': return `ğŸ“… ${node.data.date || 'ë‚ ì§œ ë¯¸ìƒ'} Â· ğŸ›ï¸ ${node.data.era || 'ì‹œëŒ€ ë¯¸ìƒ'}`;
                case 'ì„¤ì •': return `ğŸ“‚ ${node.data.category || 'ì„¸ê³„ê´€'} Â· ğŸ“ ${node.data.scope || 'ë²”ìœ„ ë¯¸ìƒ'}`;
                case 'ëŒ€ì‚¬': return `ğŸ—£ï¸ ${node.data.speaker || 'í™”ì ë¯¸ìƒ'} Â· ğŸ’­ ${node.data.emotion || 'ê°ì • ë¯¸ìƒ'}`;
                case 'ê°ˆë“±': return `âš”ï¸ ${node.data.parties || 'ë‹¹ì‚¬ì ë¯¸ìƒ'} Â· ${node.data.status === 'í•´ê²°ë¨' ? 'âœ… í•´ê²°ë¨' : 'ğŸ”¥ ì§„í–‰ì¤‘'}`;
                case 'í• ì¼': {
                    const items = node.data.items || [];
                    const done = items.filter(i => i.done).length;
                    return `ğŸ“‹ ${done}/${items.length} ì™„ë£Œ Â· ${done === items.length && items.length > 0 ? 'ğŸ‰ ì™„ë£Œë¨' : 'ğŸ”¥ ì§„í–‰ì¤‘'}`;
                }
                case 'ê·¸ë£¹': return `ğŸ“ ${node.data.childNodes?.length || 0}ê°œ í•­ëª©`;
                default: return '';
            }
        };
        // ë…¸ë“œ íƒ€ì…ë³„ ë±ƒì§€ ë Œë”ë§ (ìµœìƒìœ„ ì˜µì…˜ì€ ë¹¨ê°„ìƒ‰)
        const getNodeBadge = (node) => {
            const topTierStyle = 'bg-red-600 text-white'; // ìµœìƒìœ„ ì˜µì…˜ ë¹¨ê°„ìƒ‰
            switch (node.type) {
                case 'ì¸ë¬¼': return node.data.role ? { text: node.data.role, style: getRoleBadgeStyle(node.data.role) } : null;
                case 'ë³µì„ ': return { text: node.data.status || 'ë¯¸íšŒìˆ˜', style: node.data.status === 'íšŒìˆ˜ë¨' ? 'bg-emerald-600 text-white' : 'bg-pink-100 text-pink-600 dark:bg-pink-900/30 dark:text-pink-400' };
                case 'ê°ˆë“±': return { text: node.data.status || 'ì§„í–‰ì¤‘', style: node.data.status === 'í•´ê²°ë¨' ? 'bg-emerald-600 text-white' : node.data.status === 'ê²©í™”' ? topTierStyle : 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400' };
                case 'ì•„ì´í…œ': return node.data.rarity ? { text: node.data.rarity, style: (node.data.rarity === 'ì „ì„¤' || node.data.rarity === 'ìœ ì¼') ? topTierStyle : node.data.rarity === 'ì˜ì›…' ? 'bg-amber-500 text-white' : node.data.rarity === 'í¬ê·€' ? 'bg-purple-500 text-white' : node.data.rarity === 'ê³ ê¸‰' ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300' } : null;
                case 'íƒ€ì„ë¼ì¸': return node.data.importance ? { text: node.data.importance, style: node.data.importance === 'í•µì‹¬' ? topTierStyle : node.data.importance === 'ì¤‘ìš”' ? 'bg-teal-600 text-white' : 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300' } : null;
                default: return null;
            }
        };
        const NodeCard = ({ node, isTop, isSelected, isDragging, onMouseDown, onMouseUp, onDoubleClick, onDelete, onClick, onUpdateNode }) => {
            const isIdea = node.type === 'ë©”ëª¨';
            const isGroup = node.type === 'ê·¸ë£¹';
            const isTodo = node.type === 'í• ì¼';
            let styleClass = isIdea ? "node-postit" : isGroup ? "node-glass" : isTodo ? "" : "node-glass";

            // ì¸ë¬¼ íƒ€ì… íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼
            if (node.type === 'ì¸ë¬¼') {
                if (node.data.role === 'ì£¼ì¸ê³µ') styleClass += " node-protagonist";
                else if (node.data.role === 'ì ëŒ€ì') styleClass += " node-antagonist";
                else if (node.data.role === 'ì¡°ë ¥ì') styleClass += " node-helper";
            } else if (node.type === 'ì‚¬ê±´') styleClass += " node-event";
            else if (isTodo) {
                styleClass += " border border-cyan-300 bg-cyan-100 dark:bg-[#0c1e24] dark:border-cyan-900 shadow-sm rounded-[3px]";
                // ëª¨ë“  í•­ëª©ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                const items = node.data.items || [];
                if (items.length > 0 && items.every(i => i.done)) {
                    styleClass += " node-todo-complete";
                }
            }

            // ê·¸ë£¹ ë…¸ë“œ íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼
            if (isGroup) {
                styleClass += " border-2 border-dashed";
            }

            const subline = getNodeSubline(node);
            const badge = getNodeBadge(node);

            // íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ í•¸ë“¤ëŸ¬
            const handleToggleTodo = (itemId) => {
                const newItems = (node.data.items || []).map(item => 
                    item.id === itemId ? { ...item, done: !item.done } : item
                );
                onUpdateNode(node.id, { items: newItems });
            };

            const handleDeleteTodo = (itemId) => {
                const newItems = (node.data.items || []).filter(item => item.id !== itemId);
                onUpdateNode(node.id, { items: newItems });
            };

            const handleAddTodo = (e) => {
                if (e.key === 'Enter' && !e.nativeEvent.isComposing && e.target.value.trim()) {
                    const newItem = {
                        id: generateUUID(),
                        text: e.target.value.trim(),
                        done: false
                    };
                    onUpdateNode(node.id, { items: [...(node.data.items || []), newItem] });
                    e.target.value = '';
                }
            };

            return (
                <div onMouseDown={(e) => onMouseDown(e, node.id)} onMouseUp={(e) => onMouseUp(e, node.id)} onClick={(e) => { if (onClick && e.detail === 1) { e.stopPropagation(); onClick(e, node.id); } }} onDoubleClick={() => onDoubleClick(node.id)} style={{ zIndex: isTop ? 50 : (isGroup ? 5 : 10), width: CARD_W, height: isTodo ? 'auto' : CARD_H, minHeight: isTodo ? CARD_H : 'auto', transform: `translate(${node.x}px, ${node.y}px)`, position: 'absolute', top: 0, left: 0, transition: isDragging ? 'none' : 'transform 0.15s ease-out, box-shadow 0.2s', ...(isGroup && node.data.color ? { borderColor: node.data.color } : {}) }} className={`flex flex-col cursor-grab active:cursor-grabbing shadow-lg hover:shadow-xl group relative ${styleClass} ${isSelected ? `border-2 ${getSelectedBorderColor(node)}` : ''}`}>
                    <button onClick={(e) => { e.stopPropagation(); if (confirm("ì´ ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) onDelete(node.id); }} className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 rounded-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2 dark:bg-zinc-800 dark:border-zinc-600 dark:text-zinc-400 dark:hover:bg-red-600"><IconTrash className="w-3 h-3" /></button>
                    <div className={`w-full flex flex-col rounded-[inherit] ${isTodo ? '' : 'h-full overflow-hidden'}`}>
                        {(!isIdea && !isTodo) && <div className={`h-1.5 w-[calc(100%+4px)] -ml-[2px] -mt-[2px] shrink-0 ${getNodeBarColor(node)}`} />}
                        <div className={`flex-1 flex flex-col p-4 pointer-events-none ${isTodo ? '' : 'overflow-hidden'}`}>
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-[10px] font-black uppercase tracking-widest ${isIdea ? 'text-yellow-800 dark:text-yellow-100' : 'text-slate-400 dark:text-zinc-50'}`}>{isIdea ? (node.data.category || 'ë©”ëª¨') : node.type}</span>
                                {badge && <span className={`text-[9px] font-bold px-2 py-0.5 rounded-[3px] ${badge.style}`}>{badge.text}</span>}
                            </div>
                            <div className={`${isTodo ? 'text-lg' : 'text-xl'} font-black truncate mb-1.5 tracking-tight flex items-center ${isIdea ? 'text-slate-950 dark:text-yellow-50' : 'text-slate-900 dark:text-white'}`}>
                                <span className="mr-2 drop-shadow-sm text-2xl">{node.data.emoji || NODE_TYPE_EMOJIS[node.type] || 'ğŸ“'}</span>
                                <span className={`truncate ${node.type === 'ì‚¬ê±´' ? 'text-rose-700 dark:text-rose-400' : node.type === 'ê°ˆë“±' ? 'text-rose-600 dark:text-rose-400' : ''}`}>{node.label}</span>
                            </div>
                            {subline && <div className={`${isTodo ? 'text-sm' : 'text-[11px]'} text-slate-500 dark:text-zinc-400 font-bold mb-2 truncate`}>{subline}</div>}
                            
                            {isTodo ? (
                                <div className="flex-1 pointer-events-auto pr-1">
                                    <div className="space-y-1 pb-2">
                                        {(node.data.items || []).map(item => (
                                            <div key={item.id} className="flex items-center gap-2 group/item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={item.done} 
                                                    onChange={() => handleToggleTodo(item.id)}
                                                    onMouseDown={e => e.stopPropagation()}
                                                    className="w-3 h-3 rounded-sm border-slate-300 text-cyan-600 focus:ring-cyan-500 cursor-pointer"
                                                />
                                                <span className={`text-base flex-1 break-words ${item.done ? 'line-through text-slate-400 dark:text-zinc-500' : 'text-slate-700 dark:text-zinc-300'}`}>{item.text}</span>
                                            </div>
                                        ))}
                                        {(node.data.items || []).length === 0 && (
                                            <div className="text-[10px] text-slate-400 text-center py-2 italic">ë”ë¸”í´ë¦­í•˜ì—¬ í•  ì¼ ì¶”ê°€</div>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <div className={`text-[12px] font-medium leading-tight line-clamp-3 grow ${isIdea ? 'text-slate-700 dark:text-yellow-100/80' : 'text-slate-500 bg-slate-50 p-2 rounded-[3px] border border-slate-100 italic dark:bg-zinc-900/60 dark:border-zinc-700/50 dark:text-zinc-400'}`}>{node.data.memo || "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };  // NodeCard ì»´í¬ë„ŒíŠ¸ ë

        // GroupNode - ê·¸ë£¹ ì˜ì—­ ë…¸ë“œ
        const GroupNode = ({ node, isSelected, isDragging, onMouseDown, onDoubleClick, onDelete, onResize }) => {
            const width = node.data.width || 400;
            const height = node.data.height || 300;
            const color = node.data.color || '#94a3b8';
            const [isResizing, setIsResizing] = useState(false);
            const resizeStartRef = useRef({ x: 0, y: 0, width: 0, height: 0 });
            const resizeHandlersRef = useRef({ move: null, end: null });

            // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
            useEffect(() => {
                return () => {
                    if (resizeHandlersRef.current.move) {
                        document.removeEventListener('mousemove', resizeHandlersRef.current.move);
                    }
                    if (resizeHandlersRef.current.end) {
                        document.removeEventListener('mouseup', resizeHandlersRef.current.end);
                    }
                };
            }, []);

            const handleResizeStart = (e, corner) => {
                e.stopPropagation();
                e.preventDefault();
                setIsResizing(true);
                resizeStartRef.current = { x: e.clientX, y: e.clientY, width, height };

                const handleResizeMove = (moveEvent) => {
                    moveEvent.preventDefault();
                    const scale = window.currentScale || 1;
                    const dx = (moveEvent.clientX - resizeStartRef.current.x) / scale;
                    const dy = (moveEvent.clientY - resizeStartRef.current.y) / scale;
                    let newWidth = resizeStartRef.current.width;
                    let newHeight = resizeStartRef.current.height;

                    if (corner.includes('e')) newWidth = Math.max(200, resizeStartRef.current.width + dx);
                    if (corner.includes('s')) newHeight = Math.max(150, resizeStartRef.current.height + dy);

                    onResize(node.id, newWidth, newHeight);
                };

                const handleResizeEnd = () => {
                    setIsResizing(false);
                    document.removeEventListener('mousemove', handleResizeMove);
                    document.removeEventListener('mouseup', handleResizeEnd);
                    resizeHandlersRef.current = { move: null, end: null };
                };

                // refì— í•¸ë“¤ëŸ¬ ì €ì¥ (cleanupìš©)
                resizeHandlersRef.current = { move: handleResizeMove, end: handleResizeEnd };

                document.addEventListener('mousemove', handleResizeMove);
                document.addEventListener('mouseup', handleResizeEnd);
            };

            return (
                <div
                    onMouseDown={(e) => {
                        if (e.target.classList.contains('resize-handle')) return;
                        onMouseDown(e, node.id);
                    }}
                    onDoubleClick={() => onDoubleClick(node.id)}
                    style={{
                        zIndex: 1,
                        width: width,
                        height: height,
                        transform: `translate(${node.x}px, ${node.y}px)`,
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        borderColor: color,
                        backgroundColor: `${color}15`,
                        transition: (isResizing || isDragging) ? 'none' : 'transform 0.15s ease-out, box-shadow 0.2s',
                    }}
                    className={`cursor-grab active:cursor-grabbing group border-2 border-dashed rounded-[3px] ${isSelected ? 'border-solid shadow-lg' : ''}`}
                >
                    {/* ì‚­ì œ ë²„íŠ¼ */}
                    <button
                        onClick={(e) => { e.stopPropagation(); if (confirm("ì´ ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) onDelete(node.id); }}
                        className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 rounded-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2 dark:bg-zinc-800 dark:border-zinc-600 dark:text-zinc-400 dark:hover:bg-red-600"
                    >
                        <IconTrash className="w-3 h-3" />
                    </button>

                    {/* ì¢Œì¸¡ ìƒë‹¨ ì œëª© */}
                    <div
                        className="absolute top-6 left-8 flex items-center gap-1.5 pointer-events-none"
                        style={{ color: color }}
                    >
                        <span className="opacity-70" style={{ fontSize: '40px' }}>{node.data.emoji || 'ğŸ“'}</span>
                        <span className="text-xl font-black opacity-50" style={{ fontSize: '40px' }}>{node.label}</span>
                        {node.data.memo && <span className="font-bold opacity-40 ml-3" style={{ fontSize: '20px' }}>{node.data.memo}</span>}
                    </div>

                    {/* í¬ê¸° ì¡°ì ˆ í•¸ë“¤ - ìš°í•˜ë‹¨ */}
                    <div
                        className="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize opacity-0 group-hover:opacity-100 transition-opacity"
                        onMouseDown={(e) => handleResizeStart(e, 'se')}
                        style={{ backgroundColor: color }}
                    />
                    {/* í¬ê¸° ì¡°ì ˆ í•¸ë“¤ - ìš°ì¸¡ */}
                    <div
                        className="resize-handle absolute top-1/2 right-0 w-2 h-8 -translate-y-1/2 cursor-e-resize opacity-0 group-hover:opacity-100 transition-opacity rounded-l-sm"
                        onMouseDown={(e) => handleResizeStart(e, 'e')}
                        style={{ backgroundColor: color }}
                    />
                    {/* í¬ê¸° ì¡°ì ˆ í•¸ë“¤ - í•˜ë‹¨ */}
                    <div
                        className="resize-handle absolute bottom-0 left-1/2 w-8 h-2 -translate-x-1/2 cursor-s-resize opacity-0 group-hover:opacity-100 transition-opacity rounded-t-sm"
                        onMouseDown={(e) => handleResizeStart(e, 's')}
                        style={{ backgroundColor: color }}
                    />
                </div>
            );
        };

        // BookCover
        const BookCover = memo(({ book, onClick, onDelete, onEdit, isDragging, isDropTarget, dragHandleProps }) => {
            return (
                <div
                    className={`group perspective-1000 relative transition-transform duration-200 ${isDragging ? 'scale-105 z-50' : ''} ${isDropTarget ? 'scale-95' : ''}`}
                    style={{ perspective: '1200px' }}
                    onClick={onClick}
                >
                    <div className="absolute top-[8px] bottom-[8px] left-0 w-full bg-white shadow-sm transform translate-x-[9px] z-[1] border border-slate-200 opacity-40"></div>
                    <div className="absolute top-[6px] bottom-[6px] left-0 w-full bg-white shadow-sm transform translate-x-[6px] z-[2] border border-slate-200 opacity-70"></div>
                    <div className="absolute top-[4px] bottom-[4px] left-0 w-full bg-white shadow-sm transform translate-x-[3px] z-[3] border border-slate-200 opacity-90"></div>
                    <div className="absolute top-[2px] bottom-[3px] left-[-1px] w-full page-bg shadow-sm transform translate-x-[1px] z-[4] border-l border-slate-200"></div>

                    <motion.div initial={{ rotateY: 0 }} whileHover={(isDragging || isDropTarget) ? {} : { rotateY: -20 }} transition={{ type: "spring", stiffness: 200, damping: 15 }} className={`book-card relative rounded-[3px] shadow-lg cursor-pointer flex flex-col origin-left z-10 h-full backdrop-blur-sm ${isDragging ? 'shadow-2xl ring-2 ring-indigo-400' : ''}`} style={{ backgroundColor: (book.color || '#475569') + 'd9', aspectRatio: '2 / 3', outline: isDropTarget ? '2px dotted #818cf8' : 'none', outlineOffset: '-2px', opacity: isDropTarget ? 0.7 : 1 }}>
                        <div className="absolute inset-0 book-spine pointer-events-none z-10"></div>
                        <div className="absolute left-0 top-0 bottom-0 w-[15px] bg-black/10 z-10"></div>
                        <div className="absolute inset-0 bg-gradient-to-br from-white/8 via-transparent to-black/5 z-15 pointer-events-none rounded-[3px]"></div>
                        <div className="flex-1 p-8 flex flex-col relative z-20 text-white">
                            <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-4 border-b border-white/20 pb-2">NOVEL PROJECT</div>
                            <h3 className="text-xl font-black leading-tight tracking-tight break-keep drop-shadow-md">{book.title}</h3>
                            <div className="mt-2 text-xs opacity-70">{book.author || "ì‘ê°€ ë¯¸ìƒ"}</div>
                            <div className="mt-auto pt-4 space-y-1">
                                <div className="flex items-center gap-2 text-[11px] font-bold opacity-80">
                                    <span className="opacity-60">ë³´ë“œ</span> {book.projects?.filter(p => p.type === 'board').length || 0}
                                    <span className="mx-1 opacity-40">|</span>
                                    <span className="opacity-60">ë¬¸ì„œ</span> {book.projects?.filter(p => p.type === 'doc').length || 0}
                                </div>
                            </div>
                        </div>
                        <div className="absolute bottom-4 right-4 z-30 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200">
                            <div {...dragHandleProps} onClick={(e) => e.stopPropagation()} className="p-2 text-white/40 hover:text-white hover:bg-white/20 rounded-[3px] cursor-grab active:cursor-grabbing" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">
                                <svg className="w-4 h-4" viewBox="0 0 16 16" fill="currentColor">
                                    <circle cx="5" cy="3" r="1.5" /><circle cx="11" cy="3" r="1.5" />
                                    <circle cx="5" cy="8" r="1.5" /><circle cx="11" cy="8" r="1.5" />
                                    <circle cx="5" cy="13" r="1.5" /><circle cx="11" cy="13" r="1.5" />
                                </svg>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); onEdit(book); }} className="p-2 text-white/40 hover:text-white hover:bg-white/20 rounded-[3px]" title="ìˆ˜ì •"><IconSettings className="w-4 h-4" /></button>
                        </div>
                    </motion.div>
                </div>
            );
        }, (prevProps, nextProps) => {
            return (
                prevProps.book.id === nextProps.book.id &&
                prevProps.book.title === nextProps.book.title &&
                prevProps.book.author === nextProps.book.author &&
                prevProps.book.color === nextProps.book.color &&
                prevProps.book.projects?.length === nextProps.book.projects?.length &&
                prevProps.isDragging === nextProps.isDragging &&
                prevProps.isDropTarget === nextProps.isDropTarget
            );
        });

        // BookSettingsModal
        const BookSettingsModal = ({ onClose, onConfirm, initialData, onDelete }) => {
            const [title, setTitle] = useState(initialData?.title || 'ìƒˆ ì‘í’ˆ');
            const [author, setAuthor] = useState(initialData?.author || '');
            const [selectedColor, setSelectedColor] = useState(initialData?.color || BOOK_COLORS[0]);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deleteInput, setDeleteInput] = useState('');

            const handleExportToWord = async () => {
                if (!initialData) return;

                // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì²´í¬
                if (!window.docx || !window.JSZip || !window.saveAs) {
                    alert("í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬(docx, jszip, FileSaver)ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    const zip = new JSZip();
                    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;

                    // 1. ë³´ë“œ(Board) ë‚´ë³´ë‚´ê¸°
                    const boardProjects = initialData.projects.filter(p => p.type === 'board');
                    for (const proj of boardProjects) {
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({ text: `${proj.name} - ë³´ë“œ ë°ì´í„°`, heading: HeadingLevel.HEADING_1 }),
                                    ...proj.nodes.flatMap(node => [
                                        new Paragraph({ text: "" }),
                                        new Paragraph({
                                            children: [
                                                new TextRun({ text: `${node.data.emoji || 'ğŸ“'} ${node.label}`, bold: true, size: 28 }),
                                                new TextRun({ text: ` [${node.type}]`, size: 20, color: "666666" })
                                            ]
                                        }),
                                        new Paragraph({
                                            text: (() => {
                                                switch (node.type) {
                                                    case 'ì¸ë¬¼': return `ì„±ë³„: ${node.data.gender} / ë‚˜ì´: ${node.data.age || 'ë¯¸ìƒ'} / ì§ì—…: ${node.data.job || 'ì—†ìŒ'}`;
                                                    case 'ì‚¬ê±´': return `ì¥ì†Œ: ${node.data.place || 'ë¯¸ìƒ'} / ì‹œê¸°: ${node.data.year || 'ë¯¸ìƒ'}`;
                                                    case 'ì¥ì†Œ': return `ì§€ì—­: ${node.data.region || 'ë¯¸ìƒ'} / ê¸°í›„: ${node.data.climate || 'ë¯¸ìƒ'}`;
                                                    case 'ì•„ì´í…œ': return `ë¶„ë¥˜: ${node.data.category || 'ì¼ë°˜'} / í¬ê·€ë„: ${node.data.rarity || 'ë³´í†µ'} / ì†Œìœ ì: ${node.data.owner || 'ì—†ìŒ'}`;
                                                    case 'ì„¸ë ¥': return `ë¦¬ë”: ${node.data.leader || 'ë¯¸ìƒ'} / ì˜ì—­: ${node.data.territory || 'ë¯¸ìƒ'}`;
                                                    case 'ë³µì„ ': return `ë“±ì¥: ${node.data.chapter || 'ë¯¸ìƒ'} / ìƒíƒœ: ${node.data.status || 'ë¯¸íšŒìˆ˜'}`;
                                                    case 'íƒ€ì„ë¼ì¸': return `ì‹œì : ${node.data.date || 'ë¯¸ìƒ'} / ì‹œëŒ€: ${node.data.era || 'ë¯¸ìƒ'}`;
                                                    case 'ì„¤ì •': return `ë¶„ë¥˜: ${node.data.category || 'ì„¸ê³„ê´€'} / ë²”ìœ„: ${node.data.scope || 'ë¯¸ìƒ'}`;
                                                    case 'ëŒ€ì‚¬': return `í™”ì: ${node.data.speaker || 'ë¯¸ìƒ'} / ê°ì •: ${node.data.emotion || 'ë¯¸ìƒ'}`;
                                                    case 'ê°ˆë“±': return `ë‹¹ì‚¬ì: ${node.data.parties || 'ë¯¸ìƒ'} / ìƒíƒœ: ${node.data.status || 'ì§„í–‰ì¤‘'}`;
                                                    case 'í• ì¼': {
                                                        const items = node.data.items || [];
                                                        const done = items.filter(i => i.done).length;
                                                        return `ì§„í–‰ë¥ : ${done}/${items.length} (${items.length > 0 ? Math.round(done/items.length*100) : 0}%)`;
                                                    }
                                                    case 'ê·¸ë£¹': return `í•˜ìœ„ ë…¸ë“œ: ${node.data.childNodes?.length || 0}ê°œ`;
                                                    default: return "ë©”ëª¨";
                                                }
                                            })(),
                                            italic: true
                                        }),
                                        // í• ì¼ ëª©ë¡ ìƒì„¸ ì¶œë ¥
                                        ...(node.type === 'í• ì¼' && node.data.items && node.data.items.length > 0 ? [
                                            new Paragraph({ text: "<í• ì¼ ëª©ë¡>", bold: true, spacing: { before: 100 } }),
                                            ...node.data.items.map(item => new Paragraph({ 
                                                text: `${item.done ? 'â˜‘' : 'â˜'} ${item.text}`,
                                                bullet: { level: 0 }
                                            }))
                                        ] : []),
                                        new Paragraph({ text: node.data.memo || "ë‚´ìš© ì—†ìŒ" }),
                                        new Paragraph({ text: "--------------------------------------------------" })
                                    ])
                                ]
                            }]
                        });
                        const blob = await Packer.toBlob(doc);
                        zip.file(`ë³´ë“œ_${proj.name.replace(/[\/\*\\\?|:<>"]/g, '_')}.docx`, blob);
                    }

                    // 2. ë¬¸ì„œ(Doc) ë‚´ë³´ë‚´ê¸°
                    const docProjects = initialData.projects.filter(p => p.type === 'doc');
                    for (const proj of docProjects) {
                        const lines = (proj.content || "").split('\n');
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({ text: proj.name, heading: HeadingLevel.HEADING_1 }),
                                    new Paragraph({ text: `ìƒíƒœ: ${proj.status || 'ì´ˆê³ '} / ê³µë°±í¬í•¨ ${proj.content?.length || 0}ì`, spacing: { after: 200 } }),
                                    // ì‹œë†‰ì‹œìŠ¤ ì¶”ê°€
                                    ...(proj.synopsis ? [
                                        new Paragraph({ text: "<ì‹œë†‰ì‹œìŠ¤>", heading: HeadingLevel.HEADING_3, spacing: { before: 200, after: 100 } }),
                                        new Paragraph({ text: proj.synopsis, spacing: { after: 400 } }),
                                        new Paragraph({ text: "--------------------------------------------------", spacing: { after: 400 } })
                                    ] : []),
                                    ...lines.map(line => new Paragraph({
                                        children: [new TextRun({ text: line })],
                                        spacing: { line: 360, before: 120 }
                                    }))
                                ]
                            }]
                        });
                        const blob = await Packer.toBlob(doc);
                        zip.file(`ì›ê³ _${proj.name.replace(/[\/\*\\\?|:<>"]/g, '_')}.docx`, blob);
                    }

                    // 3. ì••ì¶• ë° ì €ì¥
                    const content = await zip.generateAsync({ type: "blob" });
                    window.saveAs(content, `${initialData.title}_word.zip`);

                } catch (e) {
                    console.error(e);
                    alert("íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                }
            };

            const handleSubmit = () => {
                if (!title.trim()) { alert("ì‘í’ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                onConfirm(title, author, selectedColor);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSubmit();
                if (e.key === 'Escape') onClose();
            };

            return showDeleteConfirm ? (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={() => { setShowDeleteConfirm(false); setDeleteInput(''); }}>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel p-6 rounded-[3px] shadow-2xl w-[350px] border border-red-200 dark:border-red-800"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-center gap-3 mb-4">
                            <div className="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                                <IconTrash className="w-5 h-5 text-red-600 dark:text-red-400" />
                            </div>
                            <div>
                                <h3 className="text-base font-black text-slate-800 dark:text-zinc-100">ì‘í’ˆ ì‚­ì œ</h3>
                                <p className="text-xs text-slate-500 dark:text-zinc-400">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <p className="text-sm text-slate-600 dark:text-zinc-300 mb-4">
                            <span className="font-bold text-slate-800 dark:text-zinc-100">"{initialData?.title}"</span> ì‘í’ˆì„ ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ì— <span className="font-black text-red-600 dark:text-red-400">ì‚­ì œ</span>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                        </p>
                        <input
                            type="text"
                            value={deleteInput}
                            onChange={(e) => setDeleteInput(e.target.value)}
                            className="w-full p-3 mb-4 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-red-500 transition-colors"
                            placeholder="ì‚­ì œ"
                            autoFocus
                        />
                        <div className="flex gap-2">
                            <button
                                onClick={() => { setShowDeleteConfirm(false); setDeleteInput(''); }}
                                className="flex-1 py-2.5 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-[3px] transition-colors"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button
                                onClick={() => { if (deleteInput === 'ì‚­ì œ') { onDelete(initialData.id); onClose(); } }}
                                disabled={deleteInput !== 'ì‚­ì œ'}
                                className={`flex-1 py-2.5 text-xs font-black rounded-[3px] transition-colors ${deleteInput === 'ì‚­ì œ' ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-slate-200 dark:bg-zinc-700 text-slate-400 dark:text-zinc-500 cursor-not-allowed'}`}
                            >
                                ì‚­ì œí•˜ê¸°
                            </button>
                        </div>
                    </motion.div>
                </div>
            ) : (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="bg-white dark:bg-darkpanel p-8 rounded-[3px] shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100">{initialData ? 'ì‘í’ˆ ì„¤ì • ìˆ˜ì •' : 'ìƒˆ ì‘í’ˆ ë§Œë“¤ê¸°'}</h2>
                            {initialData && (
                                <div className="flex items-center gap-2">
                                    <button onClick={handleExportToWord} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 transition-colors border border-blue-200 dark:border-blue-800 rounded-sm">
                                        {/* ì›Œë“œ ì•„ì´ì½˜ SVG */}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                            <polyline points="14 2 14 8 20 8" />
                                            <path d="M8 13l1.5 4 1.5-3 1.5 3 1.5-4" />
                                        </svg>
                                        <span className="text-[10px] font-black">Word ì €ì¥</span>
                                    </button>
                                    <button onClick={() => setShowDeleteConfirm(true)} className="flex items-center gap-1.5 px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/30 dark:text-red-400 transition-colors border border-red-200 dark:border-red-800 rounded-sm">
                                        <IconTrash className="w-3.5 h-3.5" />
                                        <span className="text-[10px] font-black">ì‚­ì œ</span>
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì‘í’ˆ ì œëª©</label>
                            <input autoFocus type="text" value={title} onChange={(e) => setTitle(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ì‘í’ˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                        </div>
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì‘ê°€ ì´ë¦„ (í•„ëª…)</label>
                            <input type="text" value={author} onChange={(e) => setAuthor(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ì‘ê°€ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)" />
                        </div>
                        <div className="mb-8">
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">í‘œì§€ ìƒ‰ìƒ</label>
                            <div className="flex flex-wrap gap-2"> {BOOK_COLORS.map(color => (<button key={color} onClick={() => setSelectedColor(color)} className={`w-8 h-8 rounded-[3px] shadow-sm transition-transform hover:scale-110 flex items-center justify-center ${selectedColor === color ? 'ring-2 ring-offset-2 ring-indigo-500 dark:ring-offset-darkpanel' : ''}`} style={{ backgroundColor: color }}> {selectedColor === color && <svg className="w-4 h-4 text-white/80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>} </button>))} </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-[3px] transition-colors">ì·¨ì†Œ</button>
                            <button onClick={handleSubmit} className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-[3px] shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">{initialData ? 'ì €ì¥í•˜ê¸°' : 'ë§Œë“¤ê¸°'}</button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // ExportModal ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
        const ExportModal = ({ onClose, onConfirm }) => {
            const now = new Date();
            const defaultFilename = `sagak_studio_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;

            const [filename, setFilename] = useState(defaultFilename);
            const [exportType, setExportType] = useState('json');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');

            const handleSubmit = () => {
                if (!filename.trim()) {
                    alert("íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                if (exportType === 'vel') {
                    if (!password) {
                        alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert("ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }
                }

                onConfirm(filename, exportType, password);
            };

            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700"
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">íŒŒì¼ ì €ì¥</h2>
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">íŒŒì¼ëª…</label>
                            <div className="flex gap-2">
                                <input
                                    autoFocus
                                    type="text"
                                    value={filename}
                                    onChange={(e) => setFilename(e.target.value)}
                                    className="flex-1 p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                    placeholder="íŒŒì¼ëª… ì…ë ¥"
                                />
                                <select
                                    value={exportType}
                                    onChange={(e) => setExportType(e.target.value)}
                                    className="px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors cursor-pointer"
                                >
                                    <option value="json">ì¼ë°˜ (.json)</option>
                                    <option value="vel">ì•”í˜¸í™” (.vel)</option>
                                </select>
                            </div>
                        </div>
                        {exportType === 'vel' && (
                            <div className="mb-6 space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ì•”í˜¸</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ì•”í˜¸ ì…ë ¥"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ì•”í˜¸ í™•ì¸</label>
                                    <input
                                        type="password"
                                        value={passwordConfirm}
                                        onChange={(e) => setPasswordConfirm(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ì•”í˜¸ ì¬ì…ë ¥"
                                    />
                                </div>
                            </div>
                        )}
                        <div className="flex gap-2">
                            <button
                                onClick={onClose}
                                className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button
                                onClick={handleSubmit}
                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                            >
                                ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        const NameGenerator = ({ onConfirm, onClose, settings, onSettingsChange }) => {
            // ë¶€ëª¨ë¡œë¶€í„° ë°›ì€ settingsê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ì‚¬ìš©
            const [genre, setGenre] = useState(settings?.genre || 'korean');
            const [role, setRole] = useState(settings?.role || 'modern');
            const [gender, setGender] = useState(settings?.gender || 'random');
            const [generatedName, setGeneratedName] = useState(null);

            // ì„¤ì •ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë¶€ëª¨(Workspace)ì— ì €ì¥ (ê¸°ì–µí•˜ê¸°)
            useEffect(() => {
                if (onSettingsChange) {
                    onSettingsChange({ genre, role, gender });
                }
            }, [genre, role, gender, onSettingsChange]);

            const handleGenerate = () => {
                const dataSet = NAME_DB[genre][role];
                if (!dataSet) return;

                let targetGender = gender;
                if (targetGender === 'random') {
                    targetGender = Math.random() < 0.5 ? 'm' : 'f';
                }

                const nameList = targetGender === 'm' ? dataSet.m : dataSet.f;
                const surnameList = dataSet.s;

                const rawName = nameList[Math.floor(Math.random() * nameList.length)];
                const rawSurname = surnameList[Math.floor(Math.random() * surnameList.length)];

                let fullName = "";

                if (genre === 'fantasy') {
                    const [krName, enName] = rawName.split('|');
                    const [krSur, enSur] = rawSurname.split('|');
                    if (krSur === "(ì„± ì—†ìŒ)") {
                        fullName = `${krName} (${enName})`;
                    } else {
                        fullName = `${krName} ${krSur} (${enName} ${enSur})`;
                    }
                } else if (genre === 'wuxia') {
                    const krName = rawName.split('|')[0];
                    const krSur = rawSurname.split('|')[0];
                    fullName = `${krSur}${krName}`;
                } else {
                    fullName = `${rawSurname}${rawName}`;
                }
                setGeneratedName(fullName);
            };

            // ì¥ë¥´ ë³€ê²½ í•¸ë“¤ëŸ¬ (ì¥ë¥´ë¥¼ ë°”ê¿€ ë•Œë§Œ ì—­í• ì„ ì²« ë²ˆì§¸ í•­ëª©ìœ¼ë¡œ ì´ˆê¸°í™”)
            const handleGenreChange = (e) => {
                const newGenre = e.target.value;
                setGenre(newGenre);

                // ì¥ë¥´ê°€ ë°”ë€Œë©´ í•´ë‹¹ ì¥ë¥´ì˜ ì²« ë²ˆì§¸ ì—­í• ë¡œ ìë™ ë³€ê²½
                if (NAME_ROLES[newGenre] && NAME_ROLES[newGenre].length > 0) {
                    setRole(NAME_ROLES[newGenre][0].id);
                }
            };

            useEffect(() => {
                if (!generatedName) handleGenerate();
            }, []);

            return (
                <motion.div
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: 'auto' }}
                    exit={{ opacity: 0, height: 0 }}
                    className="mt-4 border-t border-slate-200 dark:border-zinc-700 pt-4 overflow-hidden"
                >
                    <div className="bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-[3px] border border-slate-200 dark:border-zinc-700 mb-3">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-[11px] font-black text-slate-500 uppercase tracking-widest dark:text-zinc-400">ğŸ² ì´ë¦„ ìƒì„±ê¸°</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mb-3">
                            {/* onChange í•¸ë“¤ëŸ¬ êµì²´ */}
                            <select value={genre} onChange={handleGenreChange} className="p-2 text-xs font-bold rounded-[3px] border border-slate-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 outline-none">
                                <option value="korean">ğŸ™ï¸ í˜„ëŒ€ í•œêµ­</option>
                                <option value="fantasy">âš”ï¸ íŒíƒ€ì§€</option>
                                <option value="wuxia">ğŸ‰ ë¬´í˜‘</option>
                            </select>
                            <select value={gender} onChange={(e) => setGender(e.target.value)} className="p-2 text-xs font-bold rounded-[3px] border border-slate-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 outline-none">
                                <option value="random">ğŸ² ì„±ë³„ ëœë¤</option>
                                <option value="m">â€â™‚ï¸ ë‚¨ì„±</option>
                                <option value="f">â€â™€ï¸ ì—¬ì„±</option>
                            </select>
                            <select value={role} onChange={(e) => setRole(e.target.value)} className="col-span-2 p-2 text-xs font-bold rounded-[3px] border border-slate-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 outline-none">
                                {NAME_ROLES[genre].map(r => (
                                    <option key={r.id} value={r.id}>{r.text}</option>
                                ))}
                            </select>
                        </div>

                        <div
                            onClick={() => generatedName && onConfirm(generatedName)}
                            className="bg-white dark:bg-zinc-700 p-3 rounded-[3px] border border-dashed border-indigo-300 dark:border-zinc-500 text-center cursor-pointer hover:bg-indigo-50 dark:hover:bg-zinc-600 transition-colors group relative"
                        >
                            <div className="text-sm font-black text-slate-800 dark:text-white break-keep leading-snug">
                                {generatedName || "ìƒì„± ì¤‘..."}
                            </div>
                            <div className="text-[9px] text-indigo-400 dark:text-indigo-300 font-bold mt-1 opacity-0 group-hover:opacity-100 transition-opacity">í´ë¦­í•˜ì—¬ ì ìš©</div>
                        </div>

                        <button onClick={handleGenerate} className="w-full mt-2 py-2 bg-indigo-600 text-white text-xs font-black rounded-[3px] shadow-sm hover:bg-indigo-700 transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">
                            ìƒˆë¡œìš´ ì´ë¦„ ìƒì„±
                        </button>
                    </div>
                </motion.div>
            );
        };

        const ImportModal = ({ onClose, onConfirm, fileData, isEncrypted }) => {
            const [password, setPassword] = useState('');
            const [importMode, setImportMode] = useState('replace'); // 'replace' ë˜ëŠ” 'append'
            const [step, setStep] = useState(isEncrypted ? 'password' : 'mode'); // 'password' ë˜ëŠ” 'mode'
            const [decryptedData, setDecryptedData] = useState(null);

            const handlePasswordSubmit = () => {
                if (!password.trim()) {
                    alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                try {
                    const bytes = CryptoJS.AES.decrypt(fileData, password);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedText) throw new Error("Decryption failed");
                    const parsed = JSON.parse(decryptedText);
                    setDecryptedData(parsed);
                    setStep('mode');
                } catch (error) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦¬ê±°ë‚˜ ì†ìƒëœ íŒŒì¼ì…ë‹ˆë‹¤.");
                }
            };

            const handleImport = () => {
                const dataToImport = isEncrypted ? decryptedData : JSON.parse(fileData);
                onConfirm(dataToImport, importMode === 'replace');
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (step === 'password') {
                        handlePasswordSubmit();
                    } else {
                        handleImport();
                    }
                }
                if (e.key === 'Escape') onClose();
            };

            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700"
                        onClick={e => e.stopPropagation()}
                    >
                        {step === 'password' ? (
                            <>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">ì•”í˜¸í™”ëœ íŒŒì¼</h2>

                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ì•”í˜¸ ì…ë ¥</label>
                                    <input
                                        autoFocus
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyDown={handleKeyDown}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="íŒŒì¼ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                    />
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button
                                        onClick={handlePasswordSubmit}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                    >
                                        í™•ì¸
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</h2>

                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase">ë¶ˆëŸ¬ì˜¤ê¸° ë°©ì‹</label>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => setImportMode('replace')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${importMode === 'replace'
                                                ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                }`}
                                        >
                                            <div className="font-black mb-1">ë®ì–´ì“°ê¸°</div>
                                            <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ë¥¼ ì‚­ì œí•˜ê³  ë¶ˆëŸ¬ì˜¨ íŒŒì¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤</div>
                                        </button>
                                        <button
                                            onClick={() => setImportMode('append')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${importMode === 'append'
                                                ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                }`}
                                        >
                                            <div className="font-black mb-1">ì¶”ê°€í•˜ê¸°</div>
                                            <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ ë’¤ì— ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤</div>
                                        </button>
                                    </div>
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button
                                        onClick={handleImport}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                    >
                                        ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>
                                </div>
                            </>
                        )}
                    </motion.div>
                </div>
            );
        };

        // FilePanel - ë‚´ë¶€ ì°½ ë°©ì‹ì˜ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° íŒ¨ë„
        const FilePanel = ({ isOpen, mode, onClose, books, onExport, onFileSelect, importData, onConfirmImport }) => {
            const [filename, setFilename] = useState('sagak_backup');
            const [exportType, setExportType] = useState('json');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');
            const [importMode, setImportMode] = useState('replace');
            const [importPassword, setImportPassword] = useState('');
            const [decryptedData, setDecryptedData] = useState(null);
            const [importStep, setImportStep] = useState('select'); // 'select', 'password', 'mode'
            const fileInputRef = useRef(null);

            // íŒ¨ë„ì´ ì—´ë¦´ ë•Œ ìƒíƒœ ì´ˆê¸°í™”
            useEffect(() => {
                if (isOpen) {
                    if (mode === 'save') {
                        setFilename('sagak_backup');
                        setExportType('json');
                        setPassword('');
                        setPasswordConfirm('');
                    } else {
                        setImportStep('select');
                        setImportPassword('');
                        setDecryptedData(null);
                        setImportMode('replace');
                    }
                }
            }, [isOpen, mode]);

            // importDataê°€ ë³€ê²½ë˜ë©´ ì²˜ë¦¬
            useEffect(() => {
                if (importData) {
                    if (importData.isEncrypted) {
                        setImportStep('password');
                    } else {
                        setImportStep('mode');
                    }
                }
            }, [importData]);

            const handleSave = () => {
                if (!filename.trim()) {
                    alert("íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (exportType === 'vel') {
                    if (!password.trim()) {
                        alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert("ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }
                }
                onExport(filename, exportType, password);
                onClose();
            };

            const handleDecrypt = () => {
                if (!importPassword.trim()) {
                    alert("ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                try {
                    const bytes = CryptoJS.AES.decrypt(importData.content, importPassword);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedText) throw new Error("Decryption failed");
                    const parsed = JSON.parse(decryptedText);
                    setDecryptedData(parsed);
                    setImportStep('mode');
                } catch (error) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦¬ê±°ë‚˜ ì†ìƒëœ íŒŒì¼ì…ë‹ˆë‹¤.");
                }
            };

            const handleImport = () => {
                const dataToImport = importData.isEncrypted ? decryptedData : JSON.parse(importData.content);
                onConfirmImport(dataToImport, importMode === 'replace');
                onClose();
            };

            if (!isOpen) return null;

            return (
                <motion.div
                    initial={{ x: '100%' }}
                    animate={{ x: 0 }}
                    exit={{ x: '100%' }}
                    transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                    className="fixed top-0 right-0 h-full w-[420px] bg-white dark:bg-darkpanel shadow-2xl z-[100] flex flex-col border-l border-slate-200 dark:border-zinc-700"
                >
                    <div className="h-16 px-6 flex items-center justify-between border-b border-slate-200 dark:border-zinc-700 shrink-0">
                        <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100">
                            {mode === 'save' ? 'íŒŒì¼ ì €ì¥' : 'íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°'}
                        </h2>
                        <button
                            onClick={onClose}
                            className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 rounded-sm transition-colors"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                <path d="M18 6L6 18M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6">
                        {mode === 'save' ? (
                            <div className="space-y-6">
                                {/* íŒŒì¼ëª… */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">íŒŒì¼ëª…</label>
                                    <input
                                        type="text"
                                        value={filename}
                                        onChange={(e) => setFilename(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="íŒŒì¼ëª… ì…ë ¥"
                                    />
                                </div>

                                {/* ì €ì¥ í˜•ì‹ */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">ì €ì¥ í˜•ì‹</label>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => setExportType('json')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${exportType === 'json'
                                                ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                }`}
                                        >
                                            <div className="font-black mb-1">ì¼ë°˜ ì €ì¥ (.json)</div>
                                            <div className="text-xs opacity-70">ì•”í˜¸í™” ì—†ì´ ì¼ë°˜ JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥</div>
                                        </button>
                                        <button
                                            onClick={() => setExportType('vel')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${exportType === 'vel'
                                                ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                }`}
                                        >
                                            <div className="font-black mb-1">ì•”í˜¸í™” ì €ì¥ (.vel)</div>
                                            <div className="text-xs opacity-70">ì•”í˜¸ë¥¼ ì„¤ì •í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì €ì¥</div>
                                        </button>
                                    </div>
                                </div>

                                {/* ì•”í˜¸ ì…ë ¥ (vel ì„ íƒ ì‹œ) */}
                                <AnimatePresence>
                                    {exportType === 'vel' && (
                                        <motion.div
                                            initial={{ opacity: 0, height: 0 }}
                                            animate={{ opacity: 1, height: 'auto' }}
                                            exit={{ opacity: 0, height: 0 }}
                                            className="space-y-4 overflow-hidden"
                                        >
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì•”í˜¸</label>
                                                <input
                                                    type="password"
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                    placeholder="ì•”í˜¸ ì…ë ¥"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì•”í˜¸ í™•ì¸</label>
                                                <input
                                                    type="password"
                                                    value={passwordConfirm}
                                                    onChange={(e) => setPasswordConfirm(e.target.value)}
                                                    className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                    placeholder="ì•”í˜¸ ì¬ì…ë ¥"
                                                />
                                            </div>
                                        </motion.div>
                                    )}
                                </AnimatePresence>

                                <div className="p-4 bg-slate-50 dark:bg-zinc-800/50 rounded-sm border border-slate-200 dark:border-zinc-700">
                                    <div className="text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase mb-2">ì €ì¥ ì •ë³´</div>
                                    <div className="text-sm font-medium text-slate-700 dark:text-zinc-300">
                                        <div className="flex justify-between mb-1">
                                            <span>ì´ ì‘í’ˆ ìˆ˜</span>
                                            <span className="font-black">{books.length}ê°œ</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>ì €ì¥ í˜•ì‹</span>
                                            <span className="font-black">{exportType === 'json' ? 'JSON' : 'ì•”í˜¸í™” (VEL)'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {importStep === 'select' && (
                                    <>
                                        <div className="text-center py-10">
                                            <div className="w-20 h-20 mx-auto mb-4 bg-slate-100 dark:bg-zinc-800 rounded-full flex items-center justify-center">
                                                <IconUpload className="w-8 h-8 text-slate-400 dark:text-zinc-500" />
                                            </div>
                                            <p className="text-sm font-bold text-slate-600 dark:text-zinc-400 mb-1">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                            <p className="text-xs text-slate-400 dark:text-zinc-500">.json ë˜ëŠ” .vel íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤</p>
                                        </div>
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                        >
                                            íŒŒì¼ ì„ íƒ
                                        </button>
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) onFileSelect(file);
                                                e.target.value = '';
                                            }}
                                            className="hidden"
                                            accept=".json,.vel"
                                        />
                                    </>
                                )}

                                {importStep === 'password' && (
                                    <>
                                        <div className="text-center py-6">
                                            <div className="w-16 h-16 mx-auto mb-4 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                                                <svg className="w-7 h-7 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                                </svg>
                                            </div>
                                            <p className="text-sm font-black text-slate-700 dark:text-zinc-300 mb-1">ì•”í˜¸í™”ëœ íŒŒì¼</p>
                                            <p className="text-xs text-slate-400 dark:text-zinc-500">íŒŒì¼ì„ ì—´ë ¤ë©´ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì•”í˜¸ ì…ë ¥</label>
                                            <input
                                                type="password"
                                                value={importPassword}
                                                onChange={(e) => setImportPassword(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleDecrypt()}
                                                className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                placeholder="íŒŒì¼ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                                autoFocus
                                            />
                                        </div>
                                        <div className="flex gap-2 pt-2">
                                            <button
                                                onClick={() => setImportStep('select')}
                                                className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                            >
                                                ë‹¤ë¥¸ íŒŒì¼
                                            </button>
                                            <button
                                                onClick={handleDecrypt}
                                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                            >
                                                í™•ì¸
                                            </button>
                                        </div>
                                    </>
                                )}

                                {importStep === 'mode' && (
                                    <>
                                        <div className="text-center py-4">
                                            <div className="w-14 h-14 mx-auto mb-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center">
                                                <svg className="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                            <p className="text-sm font-black text-slate-700 dark:text-zinc-300">íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ</p>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">ë¶ˆëŸ¬ì˜¤ê¸° ë°©ì‹</label>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={() => setImportMode('replace')}
                                                    className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${importMode === 'replace'
                                                        ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                        : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                        }`}
                                                >
                                                    <div className="font-black mb-1">ë®ì–´ì“°ê¸°</div>
                                                    <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ë¥¼ ì‚­ì œí•˜ê³  ë¶ˆëŸ¬ì˜¨ íŒŒì¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤</div>
                                                </button>
                                                <button
                                                    onClick={() => setImportMode('append')}
                                                    className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${importMode === 'append'
                                                        ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                        : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                        }`}
                                                >
                                                    <div className="font-black mb-1">ì¶”ê°€í•˜ê¸°</div>
                                                    <div className="text-xs opacity-70">ê¸°ì¡´ ì„œì¬ ë’¤ì— ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤</div>
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="p-6 border-t border-slate-200 dark:border-zinc-700 shrink-0">
                        {mode === 'save' ? (
                            <button
                                onClick={handleSave}
                                className="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-600 dark:hover:bg-indigo-500"
                            >
                                ì €ì¥í•˜ê¸°
                            </button>
                        ) : (
                            importStep === 'mode' && (
                                <button
                                    onClick={handleImport}
                                    className="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-600 dark:hover:bg-indigo-500"
                                >
                                    ë¶ˆëŸ¬ì˜¤ê¸°
                                </button>
                            )
                        )}
                    </div>
                </motion.div>
            );
        };

        // Workspace
        const IconHistory = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v5h5" /><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8" /><path d="M12 7v5l4 2" /></svg>);


        // HistoryManager Modal
        const HistoryManager = ({ doc, onClose, onRestore, onSnapshot, onDelete }) => {
            const [selectedSnapshot, setSelectedSnapshot] = useState(null);
            const [isInputOpen, setIsInputOpen] = useState(false);
            const [deleteTargetId, setDeleteTargetId] = useState(null); // ì‚­ì œ ëŒ€ìƒ ID ìƒíƒœ ì¶”ê°€
            const [memoInput, setMemoInput] = useState('');
            const history = doc.history || [];

            const handleSnapshot = () => {
                onSnapshot(memoInput);
                setIsInputOpen(false);
                setMemoInput('');
            };

            const handleDeleteConfirm = () => {
                if (deleteTargetId) {
                    onDelete(deleteTargetId);
                    if (selectedSnapshot?.id === deleteTargetId) setSelectedSnapshot(null);
                    setDeleteTargetId(null);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onClose}></div>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel w-[710px] h-[450px] rounded-xl shadow-2xl flex flex-col overflow-hidden relative z-10 border border-slate-200 dark:border-zinc-700"
                    >
                        {/* ë©”ëª¨ ì…ë ¥ ëª¨ë‹¬ */}
                        <AnimatePresence>
                            {isInputOpen && (
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="absolute inset-0 z-50 flex items-center justify-center bg-black/10 backdrop-blur-[2px]"
                                    onClick={() => setIsInputOpen(false)}
                                >
                                    <motion.div
                                        initial={{ scale: 0.9, opacity: 0 }}
                                        animate={{ scale: 1, opacity: 1 }}
                                        exit={{ scale: 0.9, opacity: 0 }}
                                        className="bg-white dark:bg-zinc-800 p-5 rounded-lg shadow-2xl border border-slate-200 dark:border-zinc-700 w-80"
                                        onClick={e => e.stopPropagation()}
                                    >
                                        <h3 className="text-sm font-black text-slate-800 dark:text-zinc-100 mb-3">ìŠ¤ëƒ…ìƒ· ë©”ëª¨</h3>
                                        <input
                                            autoFocus
                                            type="text"
                                            className="w-full p-3 bg-slate-50 dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded text-sm font-medium mb-4 outline-none focus:border-indigo-500 dark:text-zinc-200"
                                            placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)"
                                            value={memoInput}
                                            onChange={e => setMemoInput(e.target.value)}
                                            onKeyDown={e => {
                                                if (e.key === 'Enter' && !e.nativeEvent.isComposing) {
                                                    e.preventDefault();
                                                    handleSnapshot();
                                                }
                                            }}
                                        />
                                        <div className="flex gap-2">
                                            <button onClick={() => setIsInputOpen(false)} className="flex-1 py-2 text-xs font-bold text-slate-500 hover:bg-slate-100 dark:text-zinc-400 dark:hover:bg-zinc-700 rounded">ì·¨ì†Œ</button>
                                            <button onClick={handleSnapshot} className="flex-1 py-2 text-xs font-bold bg-indigo-600 text-white hover:bg-indigo-700 rounded shadow-sm">ì €ì¥í•˜ê¸°</button>
                                        </div>
                                    </motion.div>
                                </motion.div>
                            )}
                        </AnimatePresence>

                        {/* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ */}
                        <AnimatePresence>
                            {deleteTargetId && (
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="absolute inset-0 z-50 flex items-center justify-center bg-black/10 backdrop-blur-[2px]"
                                    onClick={() => setDeleteTargetId(null)}
                                >
                                    <motion.div
                                        initial={{ scale: 0.9, opacity: 0 }}
                                        animate={{ scale: 1, opacity: 1 }}
                                        exit={{ scale: 0.9, opacity: 0 }}
                                        className="bg-white dark:bg-zinc-800 p-5 rounded-lg shadow-2xl border border-red-200 dark:border-red-900 w-72"
                                        onClick={e => e.stopPropagation()}
                                    >
                                        <div className="flex flex-col items-center text-center mb-4">
                                            <div className="w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-3 text-red-500">
                                                <IconTrash className="w-5 h-5" />
                                            </div>
                                            <h3 className="text-sm font-black text-slate-800 dark:text-zinc-100 mb-1">ê¸°ë¡ ì‚­ì œ</h3>
                                            <p className="text-xs text-slate-500 dark:text-zinc-400">ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br/>ì‚­ì œëœ ê¸°ë¡ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setDeleteTargetId(null)} className="flex-1 py-2 text-xs font-bold text-slate-500 hover:bg-slate-100 dark:text-zinc-400 dark:hover:bg-zinc-700 rounded">ì·¨ì†Œ</button>
                                            <button onClick={handleDeleteConfirm} className="flex-1 py-2 text-xs font-bold bg-red-600 text-white hover:bg-red-700 rounded shadow-sm">ì‚­ì œí•˜ê¸°</button>
                                        </div>
                                    </motion.div>
                                </motion.div>
                            )}
                        </AnimatePresence>

                        <div className="p-5 border-b border-slate-100 dark:border-zinc-700 flex justify-between items-center bg-slate-50/50 dark:bg-zinc-800/50">
                            <div>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 flex items-center gap-2">
                                    <IconHistory className="w-5 h-5 text-indigo-500" />
                                    ë¬¸ì„œ íˆìŠ¤í† ë¦¬
                                </h2>
                                <p className="text-xs text-slate-500 dark:text-zinc-400 mt-1">
                                    ìŠ¤ëƒ…ìƒ·ì„ ìƒì„±í•˜ê±°ë‚˜ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 20ê°œ ì €ì¥)
                                </p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => { setMemoInput(''); setIsInputOpen(true); }}
                                    className="px-3 py-1.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-400 dark:hover:bg-indigo-900/50 rounded text-xs font-bold transition-colors flex items-center gap-1"
                                >
                                    <IconPlus className="w-3 h-3" />
                                    í˜„ì¬ ìƒíƒœ ìŠ¤ëƒ…ìƒ·
                                </button>
                                <button onClick={onClose} className="p-2 text-slate-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded transition-colors">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-1 overflow-hidden">
                            {/* ë¯¸ë¦¬ë³´ê¸° ë° ë³µì› (ì™¼ìª½) */}
                            <div className="flex-1 flex flex-col bg-white dark:bg-darkpanel">
                                {selectedSnapshot ? (
                                    <>
                                        <div className="p-3 border-b border-slate-100 dark:border-zinc-700 flex justify-between items-center bg-slate-50/30 dark:bg-zinc-800/20">
                                            <span className="text-xs font-bold text-slate-500">
                                                {new Date(selectedSnapshot.timestamp).toLocaleString()} ë²„ì „ ë¯¸ë¦¬ë³´ê¸°
                                            </span>
                                            <button
                                                onClick={() => {
                                                    if (confirm("í˜„ì¬ ë‚´ìš©ì„ ì´ ë²„ì „ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                                        onRestore(selectedSnapshot);
                                                        onClose();
                                                    }
                                                }}
                                                className="px-4 py-1.5 bg-slate-800 hover:bg-indigo-600 text-white text-xs font-bold rounded shadow-lg shadow-indigo-500/10 transition-all flex items-center gap-2"
                                            >
                                                <IconHistory className="w-3 h-3" />
                                                ì´ ë²„ì „ìœ¼ë¡œ ë³µì›í•˜ê¸°
                                            </button>
                                        </div>
                                        <textarea
                                            readOnly
                                            className="flex-1 w-full p-8 resize-none outline-none text-slate-600 dark:text-zinc-300 leading-loose custom-scroll bg-transparent"
                                            value={selectedSnapshot.content}
                                            style={{ fontSize: '15px' }}
                                        />
                                    </>
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-slate-300 dark:text-zinc-600 gap-3">
                                        <IconHistory className="w-12 h-12 opacity-50" />
                                        <span className="text-sm">ì˜¤ë¥¸ìª½ ëª©ë¡ì—ì„œ ë²„ì „ì„ ì„ íƒí•˜ì—¬ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”</span>
                                    </div>
                                )}
                            </div>

                            {/* íˆìŠ¤í† ë¦¬ ëª©ë¡ (ì˜¤ë¥¸ìª½) */}
                            <div className="w-64 border-l border-slate-100 dark:border-zinc-700 overflow-y-auto custom-scroll bg-slate-50/30 dark:bg-zinc-900/30">
                                {history.length === 0 ? (
                                    <div className="p-8 text-center text-slate-400 text-xs">
                                        ì €ì¥ëœ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.
                                    </div>
                                ) : (
                                    <div className="p-2 space-y-1">
                                        {[...history].reverse().map((snap) => (
                                            <div
                                                key={snap.id}
                                                onClick={() => setSelectedSnapshot(snap)}
                                                className={`group relative p-3 rounded-[3px] cursor-pointer transition-all border ${selectedSnapshot?.id === snap.id ? 'bg-white dark:bg-zinc-800 border-indigo-200 dark:border-indigo-900 shadow-sm' : 'border-transparent hover:bg-white dark:hover:bg-zinc-800 hover:shadow-sm'}`}
                                            >
                                                <div className="flex items-center mb-1.5">
                                                    <span className="text-[10px] font-bold text-slate-500 dark:text-zinc-400 bg-slate-100 dark:bg-zinc-700 px-1.5 py-0.5 rounded">
                                                        {new Date(snap.timestamp).toLocaleString([], { year: '2-digit', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                                    </span>
                                                </div>
                                                <div className="text-xs font-medium text-slate-700 dark:text-zinc-300 line-clamp-2 leading-relaxed mb-1.5">
                                                    {snap.summary || "ë‚´ìš© ì—†ìŒ"}
                                                </div>
                                                <div className="text-[9px] text-slate-400 text-right font-medium">
                                                    {snap.content.length.toLocaleString()}ì
                                                </div>
                                                
                                                {/* ì‚­ì œ ë²„íŠ¼ (í˜¸ë²„ ì‹œ í‘œì‹œ) */}
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setDeleteTargetId(snap.id);
                                                    }}
                                                    className="absolute top-2 right-2 p-1.5 text-slate-400 hover:text-red-500 rounded shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
                                                    title="ê¸°ë¡ ì‚­ì œ"
                                                >
                                                    <IconTrash className="w-3 h-3" />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </motion.div>
                </div>
            );
        };

        const Workspace = ({ currentBook, onUpdateBook, onExit, showToast, isDarkMode, toggleDarkMode, fontMode, toggleFont, focusPosition, setFocusPosition, defaultTargetCount, setDefaultTargetCount, editorWidth, editorFontSize, showDocWordCount, setShowDocWordCount, enableHistory, setEnableHistory }) => {
            const [projects, setProjects] = useState(currentBook.projects || []);
            const [trash, setTrash] = useState(currentBook.trash || []); // íœ´ì§€í†µ
            const [isTrashOpen, setIsTrashOpen] = useState(false); // íœ´ì§€í†µ ì—´ë¦¼ ìƒíƒœ
            const [activeProjectId, setActiveProjectId] = useState(currentBook.activeProjectId || (currentBook.projects[0] ? currentBook.projects[0].id : 'default'));
            const [expandedProjects, setExpandedProjects] = useState(currentBook.expandedProjects || (currentBook.projects[0] ? { [currentBook.projects[0].id]: true } : {}));
            const [scale, setScale] = useState(currentBook.scale || 1);
            const [pan, setPan] = useState(currentBook.pan || { x: 0, y: 0 });
            const panAnimationRef = useRef(null);
            const [isZenMode, setIsZenMode] = useState(false);
            const [isPomodoroOpen, setIsPomodoroOpen] = useState(false);
            const [showSystemSettings, setShowSystemSettings] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showSynopsisModal, setShowSynopsisModal] = useState(false);
            const [openStatusDropdownId, setOpenStatusDropdownId] = useState(null);
            const [corkboardMode, setCorkboardMode] = useState(false);

            const [mention, setMention] = useState({ active: false, type: null, search: '', x: 0, y: 0, pos: 0, selectedIndex: 0 });
            const [showNodeDropdown, setShowNodeDropdown] = useState(false);
            const [compareMode, setCompareMode] = useState(false);
            const [compareDocIds, setCompareDocIds] = useState([null, null]);
            const [activeComparePane, setActiveComparePane] = useState(0);
            const [editingProjectId, setEditingProjectId] = useState(null);
            const [corkboardEditingId, setCorkboardEditingId] = useState(null);
            const textareaRef = useRef(null);
            const [pomoMinutes, setPomoMinutes] = useState(25);
            const [pomoSeconds, setPomoSeconds] = useState(0);
            const [isPomoActive, setIsPomoActive] = useState(false);
            const [pomoInitialTotal, setPomoInitialTotal] = useState(25 * 60);
            const [pomoRemaining, setPomoRemaining] = useState(25 * 60);
            const [isPomoSetting, setIsPomoSetting] = useState(false);
            const [isNameGenOpen, setIsNameGenOpen] = useState(false);
            const [nameGenSettings, setNameGenSettings] = useState(null);
            const [todoInput, setTodoInput] = useState('');
            const [docFilter, setDocFilter] = useState(null);
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const titleInputRef = useRef(null);
            const isDraggingSplitter = useRef(false);
            const [isSplitterDragging, setIsSplitterDragging] = useState(false);
            const [splitRatio, setSplitRatio] = useState(50);
            const containerRef = useRef(null);
            const nodeDropdownRef = useRef(null);
            const compareTextareaRefs = useRef([null, null]);

            const renderStatusSelector = (doc) => {
                const isOpen = openStatusDropdownId === doc.id;
                const currentStatus = doc.status || 'ì´ˆê³ ';
                
                return (
                    <div 
                        className={`relative z-50 flex items-center p-1 transition-all duration-300 ease-[cubic-bezier(0.25,0.1,0.25,1)] ${isZenMode && !isOpen ? 'opacity-10 hover:opacity-100' : 'opacity-100'}`}
                        onClick={(e) => {
                            e.stopPropagation();
                            if (!isOpen) setOpenStatusDropdownId(doc.id);
                            else setOpenStatusDropdownId(null);
                        }}
                    >
                        {['ì´ˆê³ ', 'ìˆ˜ì •', 'ì™„ë£Œ'].map(status => {
                            const isActive = currentStatus === status;
                            const show = isActive || isOpen;
                            
                            return (
                                <div 
                                    key={status}
                                    className={`transition-all duration-300 ease-[cubic-bezier(0.25,0.1,0.25,1)] overflow-hidden ${show ? 'max-w-[60px] opacity-100 mx-0.5' : 'max-w-0 opacity-0 mx-0'}`}
                                >
                                    <button 
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (isOpen) {
                                                setProjects(prev => prev.map(p => p.id === doc.id ? { ...p, status } : p));
                                                setOpenStatusDropdownId(null);
                                            } else {
                                                setOpenStatusDropdownId(doc.id);
                                            }
                                        }} 
                                        className={`px-3 py-1 text-[10px] font-black rounded-[3px] transition-all whitespace-nowrap ${
                                            isActive 
                                            ? (status === 'ì™„ë£Œ' ? 'bg-emerald-600 text-white shadow-sm' : status === 'ìˆ˜ì •' ? 'bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400 border border-amber-200 dark:border-amber-800' : 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-700 dark:text-indigo-300 border border-slate-200 dark:border-zinc-600') 
                                            : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300'
                                        }`}
                                    >
                                        {status}
                                    </button>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            const scrollTargetRef = useRef(0);
            const scrollAnimRef = useRef(null);
            const scrollLockRef = useRef(false);
            const getCaretCoordinates = (element, position) => {
                const div = document.createElement('div');
                const style = window.getComputedStyle(element);
                const props = ['fontFamily', 'fontSize', 'fontWeight', 'lineHeight', 'padding', 'border', 'width', 'boxSizing', 'whiteSpace', 'wordWrap'];
                props.forEach(prop => div.style[prop] = style[prop]);
                div.style.position = 'absolute';
                div.style.visibility = 'hidden';
                div.textContent = element.value.substring(0, position);
                const span = document.createElement('span');
                span.textContent = element.value.substring(position) || '.';
                div.appendChild(span);
                document.body.appendChild(div);
                const rect = element.getBoundingClientRect();
                const coordinates = { top: rect.top + span.offsetTop + element.scrollTop, left: rect.left + span.offsetLeft };
                document.body.removeChild(div);
                return coordinates;
            };

            const updateFocusScroll = useCallback(() => {
                if (!isZenMode || scrollLockRef.current) return;

                const textarea = compareMode
                    ? compareTextareaRefs.current[activeComparePane]
                    : textareaRef.current;

                if (!textarea) return;

                const coords = getCaretCoordinates(textarea, textarea.selectionStart);
                const rect = textarea.getBoundingClientRect();
                const contentOffsetTop = coords.top - rect.top - textarea.scrollTop;
                const targetScroll = contentOffsetTop - (textarea.clientHeight * focusPosition);

                const currentDiff = Math.abs(targetScroll - scrollTargetRef.current);
                if (currentDiff > 30) {
                    scrollTargetRef.current = targetScroll;
                }
            }, [isZenMode, compareMode, activeComparePane, focusPosition]);

            useEffect(() => {
                if (!isZenMode) {
                    if (scrollAnimRef.current) cancelAnimationFrame(scrollAnimRef.current);
                    return;
                }

                // Zen ëª¨ë“œ ì§„ì… ì‹œ í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¡œ ì´ˆê¸°í™”
                const textarea = compareMode
                    ? compareTextareaRefs.current[activeComparePane]
                    : textareaRef.current;
                if (textarea) {
                    scrollTargetRef.current = textarea.scrollTop;
                }

                // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ëª©í‘œ ìœ„ì¹˜ ê³„ì‚°
                setTimeout(() => {
                    updateFocusScroll();
                }, 100);

                const loop = () => {
                    const textarea = compareMode
                        ? compareTextareaRefs.current[activeComparePane]
                        : textareaRef.current;

                    if (textarea && !scrollLockRef.current) {
                        const current = textarea.scrollTop;
                        const target = scrollTargetRef.current;
                        const diff = target - current;

                        if (Math.abs(diff) > 3) {
                            textarea.scrollTop = current + diff * 0.12;
                        }
                    }
                    scrollAnimRef.current = requestAnimationFrame(loop);
                };

                loop();
                return () => cancelAnimationFrame(scrollAnimRef.current);
            }, [isZenMode, updateFocusScroll, compareMode, activeComparePane]);

            const animateViewport = useCallback((targetPan, targetScale) => {
                if (panAnimationRef.current) cancelAnimationFrame(panAnimationRef.current);
                
                const startPan = { ...pan };
                const startScale = scale;
                const startTime = performance.now();
                const duration = 500;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = t => t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                    
                    const t = ease(progress);
                    
                    setPan({
                        x: startPan.x + (targetPan.x - startPan.x) * t,
                        y: startPan.y + (targetPan.y - startPan.y) * t
                    });
                    
                    if (targetScale !== undefined) {
                        setScale(startScale + (targetScale - startScale) * t);
                    }

                    if (progress < 1) {
                        panAnimationRef.current = requestAnimationFrame(animate);
                    }
                };
                
                panAnimationRef.current = requestAnimationFrame(animate);
            }, [pan, scale]);

            useEffect(() => {
                let interval = null;
                if (isPomoActive && pomoRemaining > 0) {
                    interval = setInterval(() => {
                        setPomoRemaining(prev => {
                            if (prev <= 1) {
                                setIsPomoActive(false);
                                showToast("ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! â˜•", "success");
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                } else if (pomoRemaining === 0) {
                    setIsPomoActive(false);
                }
                return () => clearInterval(interval);
            }, [isPomoActive, pomoRemaining, showToast]);

            // íˆìŠ¤í† ë¦¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤
            const createSnapshot = useCallback((docId, memo) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== docId) return p;
                    const newHistory = [
                        ...(p.history || []),
                        {
                            id: generateUUID(),
                            timestamp: Date.now(),
                            content: p.content || "",
                            summary: memo || ((p.content || "").slice(0, 50) + ((p.content || "").length > 50 ? "..." : ""))
                        }
                    ];
                    // ìµœëŒ€ 20ê°œ ìœ ì§€
                    if (newHistory.length > 20) newHistory.shift();
                    return { ...p, history: newHistory };
                }));
                showToast("ìŠ¤ëƒ…ìƒ·ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, [showToast]);

            const restoreSnapshot = useCallback((snapshot) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;

                    // ë³µì› ì „ í˜„ì¬ ìƒíƒœë„ ìë™ ìŠ¤ëƒ…ìƒ· (ì‹¤ìˆ˜ ë°©ì§€)
                    const currentHistory = p.history || [];
                    const autoSnapshot = {
                        id: generateUUID(),
                        timestamp: Date.now(),
                        content: p.content || "",
                        summary: "ë³µì› ì „ ìë™ ì €ì¥: " + ((p.content || "").slice(0, 30) || "ë‚´ìš© ì—†ìŒ")
                    };
                    const newHistory = [...currentHistory, autoSnapshot];
                    if (newHistory.length > 20) newHistory.shift();

                    return { ...p, content: snapshot.content, history: newHistory };
                }));
                showToast("ì„ íƒí•œ ë²„ì „ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, [activeProjectId, showToast]);

            const deleteSnapshot = useCallback((snapshotId) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    const newHistory = (p.history || []).filter(h => h.id !== snapshotId);
                    return { ...p, history: newHistory };
                }));
                showToast("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, [activeProjectId, showToast]);


            const setSidebarCols = (projectId, cols) => {
                setProjects(prev => prev.map(p =>
                    p.id === projectId ? { ...p, sidebarColumns: cols } : p
                ));
            };

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (!mention.active) return;
                    const mentionList = document.querySelector('.mention-list');
                    const isTextAreaClick = e.target === textareaRef.current;
                    if (mentionList && !mentionList.contains(e.target) && !isTextAreaClick) {
                        setMention(prev => ({ ...prev, active: false }));
                    }
                };
                if (mention.active) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [mention.active]);

            useEffect(() => {
                const handleDropdownClickOutside = (e) => {
                    if (showNodeDropdown && !e.target.closest('.relative')) {
                        setShowNodeDropdown(false);
                    }
                    if (openStatusDropdownId && !e.target.closest('.relative.z-50')) {
                        setOpenStatusDropdownId(null);
                    }
                };
                if (showNodeDropdown || openStatusDropdownId) {
                    document.addEventListener('mousedown', handleDropdownClickOutside);
                }
                return () => document.removeEventListener('mousedown', handleDropdownClickOutside);
            }, [showNodeDropdown, openStatusDropdownId]);

            // Auto-save to parent component
            useEffect(() => {
                onUpdateBook({
                    ...currentBook,
                    projects,
                    trash,
                    activeProjectId,
                    expandedProjects,
                    scale,
                    pan
                });
            }, [projects, trash, activeProjectId, expandedProjects, scale, pan]);

            const activeProject = useMemo(() => projects.find(p => p.id === activeProjectId) || projects[0], [projects, activeProjectId]);

            const nodes = activeProject?.nodes || [];
            
            const fitToScreen = useCallback((nodesToFit = nodes) => {
                if (!nodesToFit || nodesToFit.length === 0) return;
                
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                nodesToFit.forEach(node => {
                    const w = node.type === 'ê·¸ë£¹' ? (node.data.width || 400) : CARD_W;
                    let h = CARD_H;
                    if (node.type === 'ê·¸ë£¹') {
                        h = node.data.height || 300;
                    } else if (node.type === 'í• ì¼') {
                        // í• ì¼ ë…¸ë“œëŠ” ë†’ì´ê°€ ê°€ë³€ì ì´ë¯€ë¡œ, í•­ëª© ìˆ˜ì— ë”°ë¼ ëŒ€ëµì ìœ¼ë¡œ ê³„ì‚°í•˜ê±°ë‚˜ ë„‰ë„‰í•˜ê²Œ ì¡ìŒ
                        // ê¸°ë³¸ í—¤ë” + íŒ¨ë”©(60px) + í•­ëª©ë‹¹ ë†’ì´(24px) + ì…ë ¥ì°½(30px) + ì—¬ìœ ë¶„
                        const itemsHeight = (node.data.items || []).length * 24 + 100; 
                        h = Math.max(CARD_H, itemsHeight);
                    }

                    minX = Math.min(minX, node.x);
                    maxX = Math.max(maxX, node.x + w);
                    minY = Math.min(minY, node.y);
                    maxY = Math.max(maxY, node.y + h);
                });

                const contentW = maxX - minX;
                const contentH = maxY - minY;
                
                const containerEl = containerRef.current;
                const containerW = containerEl ? containerEl.clientWidth : window.innerWidth;
                const containerH = containerEl ? containerEl.clientHeight : window.innerHeight;
                
                const padding = 100;
                const scaleX = (containerW - padding * 2) / contentW;
                const scaleY = (containerH - padding * 2) / contentH;
                
                // Use Math.min(scaleX, scaleY) to ensure both dimensions fit.
                // Clamp the result between 0.05 (to allow zooming out for huge boards) and 1.5.
                const newScale = Math.min(Math.max(Math.min(scaleX, scaleY), 0.05), 1.5);

                const centerX = minX + contentW / 2;
                const centerY = minY + contentH / 2;
                
                const targetPan = {
                    x: containerW / 2 - centerX * newScale,
                    y: containerH / 2 - centerY * newScale
                };
                
                animateViewport(targetPan, newScale);
            }, [nodes, animateViewport]);

            const edges = activeProject?.edges || [];
            const allBoardNodes = useMemo(() => projects.filter(p => p.type === 'board').flatMap(p => (p.nodes || []).map(node => ({ ...node, projectName: p.name, projectId: p.id }))), [projects]);
            const filteredMentionNodes = useMemo(() => { 
                if (!mention.active) return []; 
                return allBoardNodes.filter(n => {
                    const targetType = mention.type === '@' ? 'ì¸ë¬¼' : mention.type === '#' ? 'ì‚¬ê±´' : mention.type === '$' ? 'ë©”ëª¨' : mention.type === '%' ? 'í• ì¼' : 'ë©”ëª¨';
                    return n.type === targetType && (n.label.includes(mention.search) || mention.search === "");
                }); 
            }, [allBoardNodes, mention]);

            const handleToggleTodoInMention = (projectId, nodeId, itemId) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== projectId) return p;
                    return {
                        ...p,
                        nodes: p.nodes.map(n => {
                            if (n.id !== nodeId) return n;
                            const newItems = (n.data.items || []).map(item => 
                                item.id === itemId ? { ...item, done: !item.done } : item
                            );
                            return { ...n, data: { ...n.data, items: newItems } };
                        })
                    };
                }));
            };

            const handleSelectProject = (id, e) => {
                const target = projects.find(p => p.id === id);

                // Shift+í´ë¦­ìœ¼ë¡œ ë¬¸ì„œ ë¹„êµ ëª¨ë“œ í™œì„±í™” (doc íƒ€ì…ë§Œ)
                if (e && e.shiftKey && target && target.type === 'doc') {
                    if (!compareMode) {
                        // í˜„ì¬ í™œì„± ë¬¸ì„œê°€ docì´ë©´ ë¹„êµ ëª¨ë“œ ì‹œì‘
                        const currentDoc = projects.find(p => p.id === activeProjectId);
                        if (currentDoc && currentDoc.type === 'doc' && activeProjectId !== id) {
                            setCompareMode(true);
                            setCompareDocIds([activeProjectId, id]);
                            setActiveComparePane(1);
                            return;
                        } else if (!currentDoc || currentDoc.type !== 'doc') {
                            // í˜„ì¬ê°€ docì´ ì•„ë‹ˆë©´ ì„ íƒí•œ ë¬¸ì„œë¥¼ ì™¼ìª½ì— ë°°ì¹˜í•˜ê³  ë‹¤ìŒ ì„ íƒ ëŒ€ê¸°
                            setActiveProjectId(id);
                            return;
                        }
                    } else {
                        // ì´ë¯¸ ë¹„êµ ëª¨ë“œ ì¤‘ì´ë©´ í™œì„± íŒ¨ë„ì˜ ë¬¸ì„œ êµì²´
                        setCompareDocIds(prev => {
                            const newIds = [...prev];
                            newIds[activeComparePane] = id;
                            return newIds;
                        });
                        showToast("ë¬¸ì„œê°€ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤");
                        return;
                    }
                }

                // ë¹„êµ ëª¨ë“œ ì¢…ë£Œ (ì¼ë°˜ í´ë¦­ ì‹œ)
                if (compareMode) {
                    setCompareMode(false);
                    setCompareDocIds([null, null]);
                    setIsZenMode(false);
                }

                setActiveProjectId(id);
                if (target && target.type !== 'doc') setIsZenMode(false);
                setIsTrashOpen(false);
                setCorkboardMode(false); // Disable corkboard mode
                // í”„ë¡œì íŠ¸ ì „í™˜ ì‹œ ì„ íƒ ìƒíƒœ ë° ì„ì‹œ ìƒíƒœ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ê´€ë¦¬)
                setSelectedNodeIds(new Set());
                setSelectedNodeId(null);
                setSelectedEdgeId(null);
                setTempEdge(null);
            };

            // ë¹„êµ ëª¨ë“œ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ESC: ì¢…ë£Œ, Tab: íŒ¨ë„ ì „í™˜)
            useEffect(() => {
                if (!compareMode) return;
                const handleCompareKeydown = (e) => {
                    if (e.key === 'Escape') {
                        setCompareMode(false);
                        setCompareDocIds([null, null]);
                        setIsZenMode(false);
                        showToast("ë¹„êµ ëª¨ë“œ ì¢…ë£Œ");
                    } else if (e.key === 'Tab' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        setCompareDocIds(prev => [prev[1], prev[0]]);
                    }
                };
                window.addEventListener('keydown', handleCompareKeydown);
                return () => window.removeEventListener('keydown', handleCompareKeydown);
            }, [compareMode, activeComparePane]);
            const toggleProjectFolder = (id, e) => { if (e) e.stopPropagation(); setExpandedProjects(prev => ({ ...prev, [id]: !prev[id] })); };

            const updateActiveProject = useCallback((nodeUpdater, edgeUpdater) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    return {
                        ...p,
                        nodes: nodeUpdater ? (typeof nodeUpdater === 'function' ? nodeUpdater(p.nodes || []) : nodeUpdater) : (p.nodes || []),
                        edges: edgeUpdater ? (typeof edgeUpdater === 'function' ? edgeUpdater(p.edges || []) : edgeUpdater) : (p.edges || [])
                    };
                }));
            }, [activeProjectId]);

            const updateDocContent = (content) => { const finalContent = (!content || content.trim() === '') ? 'ã€€' : content; setProjects(prev => prev.map(p => p.id === activeProjectId ? { ...p, content: finalContent } : p)); if (!content || content.trim() === '') { requestAnimationFrame(() => { if (textareaRef.current) { textareaRef.current.setSelectionRange(1, 1); } }); } };

            // ë¹„êµ ëª¨ë“œìš© ë¬¸ì„œ ë‚´ìš© ì—…ë°ì´íŠ¸
            const updateCompareDocContent = (docId, content) => {
                const finalContent = (!content || content.trim() === '') ? 'ã€€' : content;
                setProjects(prev => prev.map(p => p.id === docId ? { ...p, content: finalContent } : p));
            };

            // ë¹„êµ ëª¨ë“œìš© í”„ë¡œì íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const getCompareDoc = (index) => {
                const docId = compareDocIds[index];
                return projects.find(p => p.id === docId) || null;
            };

            // ë¶„í• ì„  ë“œë˜ê·¸ í•¸ë“¤ëŸ¬ - DOM ì§ì ‘ ì¡°ì‘ìœ¼ë¡œ ì‹¤ì‹œê°„ ë°˜ì‘
            const splitterRafId = useRef(null);
            const compareContainerRef = useRef(null);

            const handleSplitterMouseDown = (e) => {
                e.preventDefault();
                isDraggingSplitter.current = true;
                setIsSplitterDragging(true);
                compareContainerRef.current = document.querySelector('.compare-container');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            };

            useEffect(() => {
                if (!compareMode) return;

                const handleMouseMove = (e) => {
                    if (!isDraggingSplitter.current || !compareContainerRef.current) return;

                    // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ì·¨ì†Œ
                    if (splitterRafId.current) {
                        cancelAnimationFrame(splitterRafId.current);
                    }

                    // requestAnimationFrameìœ¼ë¡œ ì‹¤ì‹œê°„ DOM ì—…ë°ì´íŠ¸
                    splitterRafId.current = requestAnimationFrame(() => {
                        const rect = compareContainerRef.current.getBoundingClientRect();
                        const newRatio = Math.max(20, Math.min(80, ((e.clientX - rect.left) / rect.width) * 100));

                        // DOM ì§ì ‘ ì¡°ì‘ìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜
                        const leftPane = compareContainerRef.current.children[0];
                        const rightPane = compareContainerRef.current.children[2];
                        if (leftPane && rightPane) {
                            leftPane.style.width = `${newRatio}%`;
                            rightPane.style.width = `${100 - newRatio}%`;
                        }

                        // stateë„ ì—…ë°ì´íŠ¸ (ë‚˜ì¤‘ì— ë™ê¸°í™”ìš©)
                        setSplitRatio(newRatio);
                    });
                };

                const handleMouseUp = () => {
                    if (splitterRafId.current) {
                        cancelAnimationFrame(splitterRafId.current);
                    }
                    isDraggingSplitter.current = false;
                    setIsSplitterDragging(false);
                    compareContainerRef.current = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                };

                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [compareMode]);

            const [history, setHistory] = useState({ past: [], future: [] });
            const [isPanning, setIsPanning] = useState(false);
            const [draggingNodeId, setDraggingNodeId] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0, nodeIds: new Set() }); // ë“œë˜ê·¸ ì¤‘ ì˜¤í”„ì…‹
            const [tempEdge, setTempEdge] = useState(null);
            const [selectedNodeId, setSelectedNodeId] = useState(null); // For modal
            const [selectedNodeIds, setSelectedNodeIds] = useState(new Set()); // For multi-select
            const [selectedEdgeId, setSelectedEdgeId] = useState(null);
            const [topNodeId, setTopNodeId] = useState(null);
            const [marquee, setMarquee] = useState(null); // For selection rectangle

            const lastMousePos = useRef({ x: 0, y: 0 });
            const hasConnectedRef = useRef(false);
            const [sidebarDrag, setSidebarDrag] = useState({ active: false, nodeId: null, type: null, startIdx: null, currentIdx: null, x: 0, y: 0 });
            const sidebarDragRef = useRef(null);
            const isMarqueeSelectingRef = useRef(false);
            const selectedNodeIdsRef = useRef(selectedNodeIds);

            const saveHistory = useCallback(() => { setHistory(prev => ({ past: [...prev.past.slice(-19), { projects }], future: [] })); }, [projects]);
            const undo = useCallback(() => { setHistory(prev => { if (prev.past.length === 0) return prev; const previous = prev.past[prev.past.length - 1]; const newPast = prev.past.slice(0, prev.past.length - 1); setProjects(previous.projects); showToast("ì‹¤í–‰ ì·¨ì†Œë¨"); return { past: newPast, future: [{ projects }, ...prev.future] }; }); }, [projects, showToast]);

            useEffect(() => { selectedNodeIdsRef.current = selectedNodeIds; }, [selectedNodeIds]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNodeIds.size > 0) {
                        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                        e.preventDefault();
                        if (confirm(`${selectedNodeIds.size}ê°œì˜ ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            saveHistory();
                            updateActiveProject(
                                prevNodes => prevNodes.filter(n => !selectedNodeIds.has(n.id)),
                                prevEdges => prevEdges.filter(edge => !selectedNodeIds.has(edge.from) && !selectedNodeIds.has(edge.to))
                            );
                            setSelectedNodeIds(new Set());
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedNodeIds, saveHistory, updateActiveProject]);

            useEffect(() => {
                const handleUndoKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        e.preventDefault(); undo();
                    }
                };
                window.addEventListener('keydown', handleUndoKeyDown);
                return () => window.removeEventListener('keydown', handleUndoKeyDown);
            }, [undo]);

            useEffect(() => {
                const handleZenModeKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
                        e.preventDefault();
                        if (activeProject && activeProject.type === 'doc') {
                            setIsZenMode(prev => !prev);
                        }
                    }
                };
                window.addEventListener('keydown', handleZenModeKeyDown);
                return () => window.removeEventListener('keydown', handleZenModeKeyDown);
            }, [activeProject]);

            useEffect(() => {
                const div = containerRef.current;
                const handleWheel = (e) => {
                    if (!div || e.target.closest('aside') || (activeProject && activeProject.type === 'doc') || corkboardMode) return;
                    e.preventDefault(); // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì¤Œ ë°©ì§€

                    const rect = div.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;

                    // ì¤Œ ì†ë„ ì¡°ì ˆ (íŠ¸ë™íŒ¨ë“œ ë“± ê°ì•ˆ)
                    const delta = -e.deltaY * 0.001;

                    // ì¤Œ ë²”ìœ„ ì œí•œ (0.1 ~ 3.0 -> 0.2 ~ 5.0 ì •ë„ê°€ ì ë‹¹)
                    const newScale = Math.min(Math.max(0.2, scale + delta), 5);

                    const scaleRatio = newScale / scale;
                    setPan(prev => ({
                        x: mouseX - (mouseX - prev.x) * scaleRatio,
                        y: mouseY - (mouseY - prev.y) * scaleRatio
                    }));
                    setScale(newScale);
                };
                if (div) {
                    div.addEventListener('wheel', handleWheel, { passive: false });
                    return () => div.removeEventListener('wheel', handleWheel);
                }
            }, [scale, activeProject, corkboardMode]);

            const getCanvasCoords = (clientX, clientY) => {
                if (!containerRef.current) return { x: 0, y: 0 };
                const rect = containerRef.current.getBoundingClientRect();
                return { x: (clientX - rect.left - pan.x) / scale, y: (clientY - rect.top - pan.y) / scale };
            };
            // ë“œë˜ê·¸ ì¤‘ ì˜¤í”„ì…‹ì´ ì ìš©ëœ ë…¸ë“œ ìœ„ì¹˜ ë°˜í™˜
            const findNode = (id) => {
                const node = nodes.find(n => n.id === id);
                if (!node) return null;
                if (draggingNodeId && dragOffset.nodeIds.has(id)) {
                    return { ...node, x: node.x + dragOffset.x, y: node.y + dragOffset.y };
                }
                return node;
            };

            const createNewProject = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'board', name: 'ìƒˆ ë³´ë“œ', nodes: [], edges: [], sidebarColumns: 1 }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); setPan({ x: 0, y: 0 }); setScale(1); setIsZenMode(false); setIsTrashOpen(false); };
            const createNewDoc = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'doc', name: 'ìƒˆ ë¬¸ì„œ', content: 'ã€€', history: [], status: 'ì´ˆê³ ', targetCount: defaultTargetCount }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); setIsTrashOpen(false); };

            // íœ´ì§€í†µìœ¼ë¡œ ì´ë™
            const deleteProject = (id, e) => {
                if (e) e.stopPropagation();
                const projectToDelete = projects.find(p => p.id === id);
                if (!projectToDelete) return;

                saveHistory();
                setTrash(prev => [...prev, { ...projectToDelete, deletedAt: Date.now() }]);

                let newProjects = projects.filter(p => p.id !== id);
                if (newProjects.length === 0) {
                    const dummyId = generateUUID();
                    newProjects = [{ id: dummyId, type: 'board', name: 'ìƒˆ í”„ë¡œì íŠ¸', nodes: [], edges: [] }];
                    handleSelectProject(dummyId);
                } else if (activeProjectId === id) {
                    handleSelectProject(newProjects[0].id);
                }
                setProjects(newProjects);
                showToast("íœ´ì§€í†µìœ¼ë¡œ ì´ë™ë¨");
            };

            // íœ´ì§€í†µì—ì„œ ë³µì›
            const restoreFromTrash = (id) => {
                const itemToRestore = trash.find(p => p.id === id);
                if (!itemToRestore) return;

                const { deletedAt, ...restoredProject } = itemToRestore;
                setProjects(prev => [...prev, restoredProject]);
                setTrash(prev => prev.filter(p => p.id !== id));
                showToast("ë³µì›ë¨");
            };

            // íœ´ì§€í†µì—ì„œ ì™„ì „ ì‚­ì œ
            const permanentDelete = (id) => {
                if (confirm("ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                    setTrash(prev => prev.filter(p => p.id !== id));
                    showToast("ì™„ì „íˆ ì‚­ì œë¨");
                }
            };

            // íœ´ì§€í†µ ë¹„ìš°ê¸°
            const emptyTrash = () => {
                if (trash.length === 0) return;
                if (confirm(`íœ´ì§€í†µì˜ ${trash.length}ê°œ í•­ëª©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setTrash([]);
                    showToast("íœ´ì§€í†µ ë¹„ì›€");
                }
            };
            const handleProjectRename = (id, newName) => { saveHistory(); setProjects(prev => prev.map(p => p.id === id ? { ...p, name: newName } : p)); setEditingProjectId(null); };

            const getDefaultNodeData = (type) => {
                switch (type) {
                    case 'ì¸ë¬¼': return { emoji: 'ğŸ‘¤', age: '', gender: 'ë¯¸ì§€ì •', job: '', race: 'ì¸ê°„', role: 'ì¡°ì—°', memo: '' };
                    case 'ì‚¬ê±´': return { emoji: 'ğŸ”¥', place: '', year: '', memo: '' };
                    case 'ë©”ëª¨': return { emoji: 'ğŸ’¡', category: 'ë©”ëª¨', memo: '' };
                    case 'ì¥ì†Œ': return { emoji: 'ğŸ“', region: '', climate: '', description: '', memo: '' };
                    case 'ì•„ì´í…œ': return { emoji: 'ğŸ', category: 'ì¼ë°˜', rarity: 'ë³´í†µ', owner: '', effect: '', memo: '' };
                    case 'ì„¸ë ¥': return { emoji: 'âš”ï¸', leader: '', members: '', territory: '', goal: '', memo: '' };
                    case 'ë³µì„ ': return { emoji: 'ğŸ£', chapter: '', status: 'ë¯¸íšŒìˆ˜', hint: '', reveal: '', memo: '' };
                    case 'íƒ€ì„ë¼ì¸': return { emoji: 'â°', date: '', era: '', importance: 'ë³´í†µ', memo: '' };
                    case 'ì„¤ì •': return { emoji: 'ğŸ“š', category: 'ì„¸ê³„ê´€', scope: '', memo: '' };
                    case 'ëŒ€ì‚¬': return { emoji: 'ğŸ’¬', speaker: '', situation: '', emotion: '', memo: '' };
                    case 'ê°ˆë“±': return { emoji: 'âš¡', parties: '', cause: '', status: 'ì§„í–‰ì¤‘', resolution: '', memo: '' };
                    case 'í• ì¼': return { emoji: 'âœ…', items: [], memo: '' };
                    case 'ê·¸ë£¹': return { emoji: 'ğŸ“', color: '#94a3b8', width: 400, height: 300, childNodes: [], memo: '' };
                    default: return { emoji: 'ğŸ“', memo: '' };
                }
            };
            const addNode = (type) => {
                saveHistory();
                const id = generateUUID();
                const rect = containerRef.current.getBoundingClientRect();
                const center = getCanvasCoords(rect.left + rect.width / 2, rect.top + rect.height / 2);

                const defaultData = getDefaultNodeData(type);

                updateActiveProject(prev => [...prev, { id, x: center.x - CARD_W / 2, y: center.y - CARD_H / 2, label: `ìƒˆ ${type}`, type, data: defaultData }]);
                setTopNodeId(id);
            };
            const deleteNode = (id) => {
                saveHistory();

                updateActiveProject(
                    // 1. ë…¸ë“œ ëª©ë¡ ì—…ë°ì´íŠ¸
                    prevNodes => {
                        // ì‚­ì œ ëŒ€ìƒ ë…¸ë“œ ì œê±°
                        const filtered = prevNodes.filter(n => n.id !== id);

                        // [ì¶”ê°€ëœ ë¡œì§] ë‚¨ì€ ë…¸ë“œë“¤ ì¤‘ 'ê·¸ë£¹' ë…¸ë“œ ë‚´ë¶€ì— ì‚­ì œëœ IDê°€ ìˆë‹¤ë©´ ì œê±°
                        return filtered.map(node => {
                            if (node.type === 'ê·¸ë£¹' && node.data.childNodes && node.data.childNodes.includes(id)) {
                                return {
                                    ...node,
                                    data: {
                                        ...node.data,
                                        childNodes: node.data.childNodes.filter(childId => childId !== id)
                                    }
                                };
                            }
                            return node;
                        });
                    },
                    // 2. ì—£ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ê³¼ ë™ì¼)
                    prevEdges => prevEdges.filter(e => e.from !== id && e.to !== id)
                );

                if (selectedNodeId === id) setSelectedNodeId(null);
                setSelectedNodeIds(prev => { const next = new Set(prev); next.delete(id); return next; });
            };

            const resizeGroupNode = (id, width, height) => {
                updateActiveProject(prev => prev.map(n =>
                    n.id === id ? { ...n, data: { ...n.data, width, height } } : n
                ));
            };

            const ALL_NODE_TYPES = ['ì¸ë¬¼', 'ì‚¬ê±´', 'ë©”ëª¨', 'ì¥ì†Œ', 'ì•„ì´í…œ', 'ì„¸ë ¥', 'ë³µì„ ', 'íƒ€ì„ë¼ì¸', 'ì„¤ì •', 'ëŒ€ì‚¬', 'ê°ˆë“±', 'í• ì¼', 'ê·¸ë£¹'];
            const handleReorderNodes = (type, newOrder) => {
                saveHistory();
                updateActiveProject(allNodes => {
                    const newOrderIds = newOrder.map(n => n.id);
                    const reorderedNodes = newOrderIds.map(id => allNodes.find(n => n.id === id)).filter(Boolean);

                    // ê° íƒ€ì…ë³„ë¡œ ë…¸ë“œ ë¶„ë¦¬
                    const nodesByType = {};
                    ALL_NODE_TYPES.forEach(t => {
                        nodesByType[t] = type === t ? reorderedNodes : allNodes.filter(n => n.type === t);
                    });

                    // ëª¨ë“  íƒ€ì…ì˜ ë…¸ë“œë¥¼ ìˆœì„œëŒ€ë¡œ í•©ì¹¨
                    return ALL_NODE_TYPES.flatMap(t => nodesByType[t]);
                });
            };

            const handleReorderBoards = (newOrder) => {
                saveHistory();
                setProjects(prevProjects => {
                    const docs = prevProjects.filter(p => p.type === 'doc');
                    const newOrderIds = newOrder.map(p => p.id);
                    const reorderedBoards = newOrderIds.map(id => prevProjects.find(p => p.id === id)).filter(Boolean);
                    return [...reorderedBoards, ...docs];
                });
            };

            const handleReorderDocs = (newOrder) => {
                setProjects(prevProjects => {
                    const boards = prevProjects.filter(p => p.type === 'board');
                    const newOrderIds = newOrder.map(p => p.id);
                    const reorderedDocs = newOrderIds.map(id => prevProjects.find(p => p.id === id)).filter(Boolean);
                    return [...boards, ...reorderedDocs];
                });
            };

            // ì‚¬ì´ë“œë°” ê·¸ë¦¬ë“œ ë“œë˜ê·¸ í•¸ë“¤ëŸ¬
            const handleSidebarDragStart = (e, node, type, idx) => {
                e.preventDefault();
                const rect = e.currentTarget.getBoundingClientRect();
                setSidebarDrag({
                    active: true,
                    nodeId: node.id,
                    type,
                    startIdx: idx,
                    currentIdx: idx,
                    x: e.clientX,
                    y: e.clientY,
                    offsetX: e.clientX - rect.left,
                    offsetY: e.clientY - rect.top,
                    width: rect.width,
                    height: rect.height
                });
                sidebarDragRef.current = node;
            };

            const handleSidebarDragMove = useCallback((e) => {
                if (!sidebarDrag.active) return;
                setSidebarDrag(prev => ({ ...prev, x: e.clientX, y: e.clientY }));

                // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
                const elements = document.querySelectorAll(`[data-sidebar-type="${sidebarDrag.type}"]`);
                let closestIdx = sidebarDrag.startIdx;
                let closestDist = Infinity;

                elements.forEach((el, idx) => {
                    const rect = el.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const dist = Math.hypot(e.clientX - centerX, e.clientY - centerY);
                    if (dist < closestDist) {
                        closestDist = dist;
                        closestIdx = idx;
                    }
                });

                if (closestIdx !== sidebarDrag.currentIdx) {
                    setSidebarDrag(prev => ({ ...prev, currentIdx: closestIdx }));
                }
            }, [sidebarDrag.active, sidebarDrag.type, sidebarDrag.startIdx, sidebarDrag.currentIdx]);

            const handleSidebarDragEnd = useCallback(() => {
                if (!sidebarDrag.active) return;

                const { type, startIdx, currentIdx } = sidebarDrag;
                if (startIdx !== currentIdx) {
                    saveHistory();
                    updateActiveProject(allNodes => {
                        const filtered = allNodes.filter(n => n.type === type);
                        const others = allNodes.filter(n => n.type !== type);

                        // ìˆœì„œ ë³€ê²½
                        const newFiltered = [...filtered];
                        const [moved] = newFiltered.splice(startIdx, 1);
                        newFiltered.splice(currentIdx, 0, moved);

                        const persons = type === 'ì¸ë¬¼' ? newFiltered : others.filter(n => n.type === 'ì¸ë¬¼');
                        const events = type === 'ì‚¬ê±´' ? newFiltered : others.filter(n => n.type === 'ì‚¬ê±´');
                        const memos = type === 'ë©”ëª¨' ? newFiltered : others.filter(n => n.type === 'ë©”ëª¨');

                        return [...persons, ...events, ...memos];
                    });
                }

                setSidebarDrag({ active: false, nodeId: null, type: null, startIdx: null, currentIdx: null, x: 0, y: 0 });
                sidebarDragRef.current = null;
            }, [sidebarDrag, saveHistory, updateActiveProject]);

            useEffect(() => {
                if (sidebarDrag.active) {
                    window.addEventListener('mousemove', handleSidebarDragMove);
                    window.addEventListener('mouseup', handleSidebarDragEnd);
                    return () => {
                        window.removeEventListener('mousemove', handleSidebarDragMove);
                        window.removeEventListener('mouseup', handleSidebarDragEnd);
                    };
                }
            }, [sidebarDrag.active, handleSidebarDragMove, handleSidebarDragEnd]);

            // 1. Workspace ì»´í¬ë„ŒíŠ¸ ìƒë‹¨(ref ì„ ì–¸ë¶€)ì— rAFìš© ref ì¶”ê°€
            const rAF = useRef(null);
            const latestMousePos = useRef({ x: 0, y: 0 });

            const isPanningRef = useRef(isPanning);
            const draggingNodeIdRef = useRef(draggingNodeId);
            const scaleRef = useRef(scale);
            const tempEdgeRef = useRef(tempEdge);
            const nodesRef = useRef(nodes);
            const dragOffsetRef = useRef({ x: 0, y: 0, nodeIds: new Set() });

            useEffect(() => { isPanningRef.current = isPanning; }, [isPanning]);
            useEffect(() => { draggingNodeIdRef.current = draggingNodeId; }, [draggingNodeId]);
            useEffect(() => { scaleRef.current = scale; window.currentScale = scale; }, [scale]);
            useEffect(() => { tempEdgeRef.current = tempEdge; }, [tempEdge]);
            useEffect(() => { nodesRef.current = nodes; }, [nodes]);

            // 2. handleGlobalMouseMove í•¨ìˆ˜ êµì²´
            const handleGlobalMouseMove = (e) => {
                if (activeProject.type === 'doc') return;

                const currentX = e.clientX;
                const currentY = e.clientY;
                const dx = currentX - lastMousePos.current.x;
                const dy = currentY - lastMousePos.current.y;

                if (isMarqueeSelectingRef.current && marquee) {
                    const currentCoords = getCanvasCoords(currentX, currentY);
                    setMarquee(prev => {
                        const x = Math.min(prev.startX, currentCoords.x);
                        const y = Math.min(prev.startY, currentCoords.y);
                        const width = Math.abs(currentCoords.x - prev.startX);
                        const height = Math.abs(currentCoords.y - prev.startY);
                        return { ...prev, x, y, width, height };
                    });
                } else if (isPanningRef.current) {
                    setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                } else if (draggingNodeIdRef.current) {
                    const scaleFactor = 1 / scaleRef.current;
                    const dragId = draggingNodeIdRef.current;
                    const deltaX = dx * scaleFactor;
                    const deltaY = dy * scaleFactor;
                    const selectedIds = selectedNodeIdsRef.current;

                    // ì´ë™í•  ë…¸ë“œ ID ì§‘í•©ì„ ë¯¸ë¦¬ ê³„ì‚° (ì²« í”„ë ˆì„ì—ì„œë§Œ)
                    let nodesToMove = dragOffsetRef.current.nodeIds;
                    if (nodesToMove.size === 0) {
                        nodesToMove = new Set();
                        const currentNodes = nodes;

                        // ì¬ê·€ì ìœ¼ë¡œ ê·¸ë£¹ì˜ ëª¨ë“  ìì‹ ë…¸ë“œ ìˆ˜ì§‘
                        const collectAllChildren = (nodeId, nodesList) => {
                            nodesToMove.add(nodeId);
                            const node = nodesList.find(n => n.id === nodeId);
                            if (node?.type === 'ê·¸ë£¹' && node.data.childNodes) {
                                node.data.childNodes.forEach(childId => {
                                    if (!nodesToMove.has(childId)) {
                                        collectAllChildren(childId, nodesList);
                                    }
                                });
                            }
                        };

                        const draggedNode = currentNodes.find(n => n.id === dragId);
                        const isGroupDrag = draggedNode?.type === 'ê·¸ë£¹';

                        if (selectedIds.has(dragId) && selectedIds.size > 1) {
                            selectedIds.forEach(id => nodesToMove.add(id));
                        } else if (isGroupDrag) {
                            collectAllChildren(dragId, currentNodes);
                        } else {
                            nodesToMove.add(dragId);
                        }
                        dragOffsetRef.current.nodeIds = nodesToMove;
                    }

                    // ì˜¤í”„ì…‹ ëˆ„ì 
                    const newOffsetX = dragOffsetRef.current.x + deltaX;
                    const newOffsetY = dragOffsetRef.current.y + deltaY;
                    dragOffsetRef.current = { x: newOffsetX, y: newOffsetY, nodeIds: nodesToMove };
                    setDragOffset({ x: newOffsetX, y: newOffsetY, nodeIds: nodesToMove });
                }

                if (tempEdgeRef.current) {
                    const c = getCanvasCoords(currentX, currentY);
                    setTempEdge(prev => ({ ...prev, toX: c.x, toY: c.y }));
                }

                lastMousePos.current = { x: currentX, y: currentY };
            };

            const handleGlobalMouseUp = (e) => {
                if (activeProject.type === 'board') {
                    if (isMarqueeSelectingRef.current && marquee) {
                        const marqueeRect = { x: marquee.x, y: marquee.y, x2: marquee.x + marquee.width, y2: marquee.y + marquee.height };
                        const nodesInMarquee = nodes.filter(node => {
                            const nodeRect = { x: node.x, y: node.y, x2: node.x + CARD_W, y2: node.y + CARD_H };
                            return nodeRect.x < marqueeRect.x2 && nodeRect.x2 > marqueeRect.x && nodeRect.y < marqueeRect.y2 && nodeRect.y2 > marqueeRect.y;
                        });

                        if (e.shiftKey) {
                            setSelectedNodeIds(prev => {
                                const newSet = new Set(prev);
                                nodesInMarquee.forEach(node => newSet.add(node.id));
                                selectedNodeIdsRef.current = newSet;
                                return newSet;
                            });
                        } else {
                            const newSet = new Set(nodesInMarquee.map(n => n.id));
                            setSelectedNodeIds(newSet);
                            selectedNodeIdsRef.current = newSet;
                        }
                    }

                    isMarqueeSelectingRef.current = false;
                    setMarquee(null);

                    // ë…¸ë“œ ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ìœ„ì¹˜ ì €ì¥ ë° ê·¸ë£¹ ì˜ì—­ ì²´í¬
                    if (draggingNodeId) {
                        const offset = dragOffsetRef.current;
                        const movedNodeIds = offset.nodeIds;

                        // ì˜¤í”„ì…‹ì´ ìˆìœ¼ë©´ ì‹¤ì œ ìœ„ì¹˜ ì €ì¥
                        if (offset.x !== 0 || offset.y !== 0) {
                            saveHistory();
                            updateActiveProject(prevNodes => prevNodes.map(n =>
                                movedNodeIds.has(n.id) ? { ...n, x: n.x + offset.x, y: n.y + offset.y } : n
                            ));
                        }

                        // ì˜¤í”„ì…‹ ì´ˆê¸°í™”
                        dragOffsetRef.current = { x: 0, y: 0, nodeIds: new Set() };
                        setDragOffset({ x: 0, y: 0, nodeIds: new Set() });

                        // ì´ë™ëœ ëª¨ë“  ë…¸ë“œë“¤ì— ëŒ€í•´ ê·¸ë£¹ ì²´í¬ (ê·¸ë£¹ ë…¸ë“œëŠ” ì œì™¸)
                        movedNodeIds.forEach(mId => {
                            const mNode = nodes.find(n => n.id === mId);
                            if (mNode && mNode.type !== 'ê·¸ë£¹') {
                                const nodeCenterX = mNode.x + offset.x + CARD_W / 2;
                                const nodeCenterY = mNode.y + offset.y + CARD_H / 2;

                                const currentParentGroup = nodes.find(n => n.type === 'ê·¸ë£¹' && n.id !== mId && n.data.childNodes?.includes(mId));
                                const groupNodes = nodes.filter(n => n.type === 'ê·¸ë£¹');
                                let targetGroup = null;

                                for (const group of groupNodes) {
                                    const gx = group.x + (movedNodeIds.has(group.id) ? offset.x : 0);
                                    const gy = group.y + (movedNodeIds.has(group.id) ? offset.y : 0);
                                    const gw = group.data.width || 400;
                                    const gh = group.data.height || 300;

                                    if (nodeCenterX >= gx && nodeCenterX <= gx + gw &&
                                        nodeCenterY >= gy && nodeCenterY <= gy + gh) {
                                        targetGroup = group;
                                        break;
                                    }
                                }

                                // ê·¸ë£¹ ìƒíƒœ ë³€ê²½ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                                if (currentParentGroup?.id !== targetGroup?.id) {
                                    updateActiveProject(prevNodes => prevNodes.map(n => {
                                        // ê¸°ì¡´ ê·¸ë£¹ì—ì„œ ì œê±°
                                        if (currentParentGroup && n.id === currentParentGroup.id) {
                                            return { ...n, data: { ...n.data, childNodes: (n.data.childNodes || []).filter(id => id !== mId) } };
                                        }
                                        // ìƒˆ ê·¸ë£¹ì— ì¶”ê°€
                                        if (targetGroup && n.id === targetGroup.id) {
                                            if (!n.data.childNodes?.includes(mId)) {
                                                return { ...n, data: { ...n.data, childNodes: [...(n.data.childNodes || []), mId] } };
                                            }
                                        }
                                        return n;
                                    }));
                                }
                            }
                        });
                    }
                    if (tempEdge && !hasConnectedRef.current) {
                        const c = getCanvasCoords(e.clientX, e.clientY);
                        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ìˆëŠ” ë…¸ë“œ ì°¾ê¸° (ì¶œë°œ ë…¸ë“œ ì œì™¸)
                        const targetNode = nodes.find(n =>
                            n.id !== tempEdge.fromId &&
                            c.x >= n.x && c.x <= n.x + CARD_W &&
                            c.y >= n.y && c.y <= n.y + CARD_H
                        );

                        if (targetNode) {
                            const edgeExists = edges.some(e =>
                                (e.from === tempEdge.fromId && e.to === targetNode.id) ||
                                (e.from === targetNode.id && e.to === tempEdge.fromId)
                            );
                            if (edgeExists) {
                            } else {
                                saveHistory();
                                const fromNode = findNode(tempEdge.fromId);
                                const edgeLabel = '';
                                updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: targetNode.id, label: edgeLabel }]);
                            }
                        } else {
                            const fromNode = findNode(tempEdge.fromId);
                            if (fromNode) {
                                saveHistory();
                                const newNodeId = generateUUID();
                                const defaultData = getDefaultNodeData(fromNode.type);
                                const edgeLabel = '';
                                updateActiveProject(prev => [...prev, { id: newNodeId, x: c.x - CARD_W / 2, y: c.y - CARD_H / 2, label: `ìƒˆ ${fromNode.type}`, type: fromNode.type, data: defaultData }], prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: newNodeId, label: edgeLabel }]);
                            }
                        }
                    }
                    hasConnectedRef.current = false;
                    setIsPanning(false);
                    setDraggingNodeId(null);
                    setTempEdge(null);
                }
            };

            const handleDocInput = (e) => {
                const inputType = e.nativeEvent.inputType;
                let val = e.target.value;
                let pos = e.target.selectionStart;
                const lastChar = val[pos - 1];

                // ì¤„ë°”ê¿ˆ ì‹œ ìë™ ë“¤ì—¬ì“°ê¸° (ë¬¸ë‹¨ ì²«ì¤„ ë„ìš°ê¸°)
                if (inputType === 'insertLineBreak') {
                    const indent = 'ã€€'; // ê³µë°±ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ ë“¤ì—¬ì“°ê¸°
                    const scrollTop = e.target.scrollTop; // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
                    val = val.slice(0, pos) + indent + val.slice(pos);

                    updateDocContent(val);
                    requestAnimationFrame(() => {
                        if (textareaRef.current) {
                            textareaRef.current.scrollTop = scrollTop; // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µêµ¬
                            textareaRef.current.setSelectionRange(pos + indent.length, pos + indent.length);
                            // ì—”í„° ì…ë ¥ ì§í›„ ìŠ¤í¬ë¡¤ ëª©í‘œ ê°±ì‹ 
                            if (isZenMode) {
                                updateFocusScroll();
                            }
                        }
                    });
                    return;
                }

                if (inputType === 'insertFromPaste') {
                    if (mention.active) {
                        const currentSearch = val.slice(mention.pos, pos);
                        if (/[\s\n]/.test(currentSearch)) {
                            setMention({ ...mention, active: false });
                        } else {
                            setMention({ ...mention, search: currentSearch, selectedIndex: 0 });
                        }
                    }
                    updateDocContent(val);
                    return;
                }

                if (lastChar === '#' || lastChar === '@' || lastChar === '$' || lastChar === '%') {
                    const coords = getCaretCoordinates(e.target, pos);
                    const rect = e.target.getBoundingClientRect();
                    const visualY = coords.top - (e.target.scrollTop * 2);

                    let finalX, finalY;

                    if (isZenMode) {
                        finalX = Math.max(rect.left + 20, rect.left + coords.left - 610);
                        finalY = visualY + 20;
                    } else {
                        finalX = coords.left;
                        finalY = visualY + 25;
                    }

                    const menuWidth = 600;
                    const menuHeight = 400;

                    if (finalX + menuWidth > window.innerWidth) finalX = window.innerWidth - menuWidth - 20;
                    if (!isZenMode && (finalY + menuHeight > window.innerHeight)) {
                        finalY = visualY - menuHeight - 10;
                    }

                    setMention({ active: true, type: lastChar, search: '', x: finalX, y: finalY, pos, selectedIndex: 0 });

                } else if (mention.active) {
                    const currentSearch = val.slice(mention.pos, pos);
                    if (!lastChar || /[\s\n]/.test(lastChar) || pos < mention.pos) {
                        setMention({ ...mention, active: false });
                    } else {
                        setMention({ ...mention, search: currentSearch, selectedIndex: 0 });
                    }
                }

                updateDocContent(val);
            };

            const insertMention = (node) => {
                const text = activeProject.content || "";
                const before = text.slice(0, mention.pos - 1);
                const after = text.slice(mention.pos + mention.search.length);
                const insertedText = node.label + "";
                const newText = before + insertedText + after;
                updateDocContent(newText);
                setMention({ ...mention, active: false });
                const newCursorPos = before.length + insertedText.length;
                requestAnimationFrame(() => {
                    if (textareaRef.current) {
                        textareaRef.current.focus();
                        textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
                        if (typeof updateFocusScroll === 'function') {
                            updateFocusScroll();
                        }
                    }
                });
            };

            const handleDocKeyDown = (e) => {
                if (e.nativeEvent.isComposing) return;

                if (mention.active) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex + 1) % filteredMentionNodes.length }));
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex - 1 + filteredMentionNodes.length) % filteredMentionNodes.length }));
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (filteredMentionNodes[mention.selectedIndex]) insertMention(filteredMentionNodes[mention.selectedIndex]);
                    } else if (e.key === 'Escape') {
                        setMention({ ...mention, active: false });
                    }
                }
            };

            const handleAutoLayout = useCallback(() => {
                if (!window.dagre) {
                    showToast("ì •ë ¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "error");
                    return;
                }
                if (!activeProject || activeProject.type !== 'board') return;
                saveHistory();

                const GAP_BETWEEN_GROUPS = 400;

                const groups = {
                    'ì¸ë¬¼': activeProject.nodes.filter(n => n.type === 'ì¸ë¬¼'),
                    'ì‚¬ê±´': activeProject.nodes.filter(n => n.type === 'ì‚¬ê±´'),
                    'ë©”ëª¨': activeProject.nodes.filter(n => n.type === 'ë©”ëª¨'),
                    'ì¥ì†Œ': activeProject.nodes.filter(n => n.type === 'ì¥ì†Œ'),
                    'ì•„ì´í…œ': activeProject.nodes.filter(n => n.type === 'ì•„ì´í…œ'),
                    'ì„¸ë ¥': activeProject.nodes.filter(n => n.type === 'ì„¸ë ¥'),
                    'ë³µì„ ': activeProject.nodes.filter(n => n.type === 'ë³µì„ '),
                    'íƒ€ì„ë¼ì¸': activeProject.nodes.filter(n => n.type === 'íƒ€ì„ë¼ì¸'),
                    'ì„¤ì •': activeProject.nodes.filter(n => n.type === 'ì„¤ì •'),
                    'ëŒ€ì‚¬': activeProject.nodes.filter(n => n.type === 'ëŒ€ì‚¬'),
                    'ê°ˆë“±': activeProject.nodes.filter(n => n.type === 'ê°ˆë“±'),
                    'í• ì¼': activeProject.nodes.filter(n => n.type === 'í• ì¼'),
                    'ê·¸ë£¹': activeProject.nodes.filter(n => n.type === 'ê·¸ë£¹')
                };

                const getInternalEdges = (groupNodes) => {
                    const ids = new Set(groupNodes.map(n => n.id));
                    return activeProject.edges.filter(e => ids.has(e.from) && ids.has(e.to));
                };

                const layoutGroup = (groupNodes, groupEdges) => {
                    if (groupNodes.length === 0) return { nodes: [], width: 0, height: 0 };
                    const g = new dagre.graphlib.Graph();
                    g.setGraph({ rankdir: 'TB', ranksep: 100, nodesep: 60 });
                    g.setDefaultEdgeLabel(() => ({}));
                    groupNodes.forEach(node => g.setNode(node.id, { width: CARD_W, height: CARD_H }));
                    groupEdges.forEach(edge => g.setEdge(edge.from, edge.to));
                    dagre.layout(g);

                    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                    const positioned = groupNodes.map(node => {
                        const pos = g.node(node.id);
                        const x = pos.x - CARD_W / 2;
                        const y = pos.y - CARD_H / 2;
                        if (x < minX) minX = x;
                        if (x + CARD_W > maxX) maxX = x + CARD_W;
                        if (y < minY) minY = y;
                        if (y + CARD_H > maxY) maxY = y + CARD_H;
                        return { ...node, x, y };
                    });
                    return {
                        nodes: positioned.map(n => ({ ...n, x: n.x - minX, y: n.y - minY })),
                        width: maxX - minX,
                        height: maxY - minY
                    };
                };

                // ê° íƒ€ì…ë³„ ë ˆì´ì•„ì›ƒ
                const results = {};
                Object.keys(groups).forEach(type => {
                    results[type] = layoutGroup(groups[type], getInternalEdges(groups[type]));
                });

                // Row 1: ì¸ë¬¼, ì‚¬ê±´, ë©”ëª¨, í• ì¼
                const ROW_GAP = 100;
                let row1X = 0;
                let row1Height = 0;

                const finalNodes = [];

                ['ì¸ë¬¼', 'ì‚¬ê±´', 'ë©”ëª¨', 'í• ì¼'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row1X, y: n.y }));
                        row1X += results[type].width + GAP_BETWEEN_GROUPS;
                        row1Height = Math.max(row1Height, results[type].height);
                    }
                });

                // Row 2: ì¥ì†Œ, ì„¸ë ¥, ì„¤ì •
                let row2X = 0;
                let row2Y = row1Height + ROW_GAP;
                let row2Height = 0;

                ['ì¥ì†Œ', 'ì„¸ë ¥', 'ì„¤ì •'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row2X, y: n.y + row2Y }));
                        row2X += results[type].width + GAP_BETWEEN_GROUPS;
                        row2Height = Math.max(row2Height, results[type].height);
                    }
                });

                // Row 3: ë³µì„ , íƒ€ì„ë¼ì¸, ëŒ€ì‚¬, ê°ˆë“±
                let row3X = 0;
                let row3Y = row2Y + row2Height + ROW_GAP;
                let row3Height = 0;

                ['ë³µì„ ', 'íƒ€ì„ë¼ì¸', 'ëŒ€ì‚¬', 'ê°ˆë“±'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row3X, y: n.y + row3Y }));
                        row3X += results[type].width + GAP_BETWEEN_GROUPS;
                        row3Height = Math.max(row3Height, results[type].height);
                    }
                });

                // Row 4: ì•„ì´í…œ
                let row4X = 0;
                let row4Y = row3Y + row3Height + ROW_GAP;

                ['ì•„ì´í…œ'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row4X, y: n.y + row4Y }));
                        row4X += results[type].width + GAP_BETWEEN_GROUPS;
                    }
                });

                // ê·¸ë£¹ ë…¸ë“œëŠ” ëŒ€ê°ì„ ìœ¼ë¡œ ê²¹ì³ì„œ ë°°ì¹˜
                const DIAGONAL_OFFSET = 50;
                let groupX = row4X + GAP_BETWEEN_GROUPS;
                let groupY = row4Y;
                results['ê·¸ë£¹'].nodes.forEach((n, idx) => {
                    finalNodes.push({ ...n, x: groupX + idx * DIAGONAL_OFFSET, y: groupY + idx * DIAGONAL_OFFSET });
                });

                const positionMap = new Map();
                finalNodes.forEach(n => positionMap.set(n.id, { x: n.x, y: n.y }));

                // ìë™ ì •ë ¬ ì‹œ ëª¨ë“  ê·¸ë£¹ ë…¸ë“œì˜ childNodes ì´ˆê¸°í™”
                updateActiveProject(prevNodes =>
                    prevNodes.map(n => {
                        const newPos = positionMap.get(n.id);
                        if (n.type === 'ê·¸ë£¹') {
                            // ê·¸ë£¹ ë…¸ë“œëŠ” childNodes ì´ˆê¸°í™”
                            return newPos
                                ? { ...n, x: newPos.x, y: newPos.y, data: { ...n.data, childNodes: [] } }
                                : { ...n, data: { ...n.data, childNodes: [] } };
                        }
                        return newPos ? { ...n, x: newPos.x, y: newPos.y } : n;
                    })
                );

                setTimeout(() => fitToScreen(finalNodes), 100);

            }, [activeProject, saveHistory, updateActiveProject, fitToScreen]);


            const activeNode = useMemo(() => nodes.find(n => n.id === selectedNodeId), [nodes, selectedNodeId]);
            const activeEdge = useMemo(() => edges.find(e => e.id === selectedEdgeId), [edges, selectedEdgeId]);

            // ë“œë˜ê·¸ ì¤‘ì¸ ë…¸ë“œì— ì˜¤í”„ì…‹ ì ìš©
            const getDisplayNodes = () => {
                if (!draggingNodeId || (dragOffset.x === 0 && dragOffset.y === 0)) return nodes;
                return nodes.map(n =>
                    dragOffset.nodeIds.has(n.id)
                        ? { ...n, x: n.x + dragOffset.x, y: n.y + dragOffset.y }
                        : n
                );
            };
            const displayNodes = getDisplayNodes();

            const visibleNodes = (() => {
                if (activeProject?.type !== 'board') return [];
                if (isPanning || draggingNodeId) {
                    return displayNodes;
                }

                const viewportW = window.innerWidth;
                const viewportH = window.innerHeight;
                const buffer = 300;

                return displayNodes.filter(node => {
                    const screenX = node.x * scale + pan.x;
                    const screenY = node.y * scale + pan.y;
                    const nodeW = node.type === 'ê·¸ë£¹' ? (node.data.width || 400) : CARD_W;
                    const nodeH = node.type === 'ê·¸ë£¹' ? (node.data.height || 300) : CARD_H;
                    return (
                        screenX > -nodeW * scale - buffer &&
                        screenX < viewportW + buffer &&
                        screenY > -nodeH * scale - buffer &&
                        screenY < viewportH + buffer
                    );
                });
            })();

            const visibleGroupNodes = visibleNodes.filter(n => n.type === 'ê·¸ë£¹');
            const visibleRegularNodes = visibleNodes.filter(n => n.type !== 'ê·¸ë£¹');
            // ì—£ì§€ëŠ” nodesì—ì„œ ì§ì ‘ ì°¸ì¡°í•˜ì—¬ ë™ê¸°í™” ë¬¸ì œ í•´ê²°
            const visibleEdges = (() => { if (activeProject?.type !== 'board') return []; const nodeIds = new Set(nodes.map(n => n.id)); return edges.filter(edge => nodeIds.has(edge.from) && nodeIds.has(edge.to)); })();

            const renderProjectItem = (project) => {
                const isActive = !isTrashOpen && activeProjectId === project.id; const isDoc = project.type === 'doc'; const isExpanded = expandedProjects[project.id];
                const cols = project.sidebarColumns || 1;
                const containerClasses = isDoc
                    ? `transition-all duration-200 border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 ${isActive ? 'bg-white dark:bg-zinc-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}`
                    : `rounded-[3px] mb-1 transition-all duration-300 ${isActive
                        ? 'bg-white shadow-md border-2 border-indigo-200 dark:bg-zinc-700 dark:border-indigo-500'
                        : 'bg-slate-50 border border-slate-200 dark:bg-zinc-800 dark:border-zinc-700'
                    }`;

                const projectContent = (
                    <div className={containerClasses}>
                        <div onClick={(e) => handleSelectProject(project.id, e)} onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }} className={`flex items-center px-4 cursor-pointer group relative overflow-hidden ${isDoc ? 'h-[30px] py-0' : 'py-1.5'}`}>
                            {isActive && <div className={`absolute left-0 top-0 bottom-0 ${isDoc ? 'w-[3px]' : 'w-1'} bg-indigo-600 dark:bg-indigo-500`} />}
                            <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                <span onClick={(e) => !isDoc && toggleProjectFolder(project.id, e)} className={`${isDoc ? 'text-sm opacity-50' : 'text-base'} shrink-0 dark:text-zinc-300`}>{isDoc ? 'ğŸ“„' : (isExpanded ? 'ğŸ“‚' : 'ğŸ“')}</span>
                                {editingProjectId === project.id ? (<input autoFocus className="w-full bg-white border border-indigo-400 rounded-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white" defaultValue={project.name} onBlur={(e) => handleProjectRename(project.id, e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)} />) : (
                                    <div className="flex items-center min-w-0 flex-1 justify-between">
                                        <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                        {isExpanded && !isDoc && (
                                            <div className="flex items-center gap-0.5 bg-slate-200 dark:bg-zinc-900 p-0.5 rounded-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                {[1, 2, 3, 4].map(col => (
                                                    <button
                                                        key={col}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setSidebarCols(project.id, col);
                                                        }}
                                                        className={`w-5 h-5 flex items-center justify-center text-[10px] font-black rounded-sm transition-colors ${cols === col
                                                            ? 'bg-white dark:bg-zinc-700 text-indigo-600 dark:text-white shadow-sm'
                                                            : 'text-slate-400 hover:bg-white/50 dark:text-zinc-500 dark:hover:bg-zinc-700/50'
                                                            }`}
                                                        title={`${col}ì—´ ë³´ê¸°`}
                                                    >
                                                        {col}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                        <div className="flex items-center shrink-0">
                                            {isDoc && <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] ${getStatusBadgeStyle(project.status || 'ì´ˆê³ ')}`}>{project.status || 'ì´ˆê³ '}</span>}
                                            <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        {!isDoc && (
                            (isExpanded && project.type === 'board') && (
                                <div className="overflow-hidden bg-slate-50/30 rounded-b-[3px] border-slate-100 dark:bg-zinc-800/30 dark:border-zinc-700">
                                    <div className="pb-3 px-3 space-y-3 pt-2">                                                {(() => {
                                        const cols = project.sidebarColumns || 1;
                                        return ALL_NODE_TYPES.map(type => {
                                            const filtered = (project.nodes || []).filter(n => n.type === type); if (filtered.length === 0) return null;
                                            return (
                                                <div key={type} className="pl-1">
                                                    <div className="text-[9px] font-black text-slate-400 mb-1.5 px-2 uppercase tracking-tighter flex items-center gap-2"><span className="w-1 h-1 bg-slate-300 rounded-[3px] dark:bg-zinc-600"></span>{type}</div>
                                                    {cols === 1 ? (
                                                        <Reorder.Group axis="y" values={filtered} onReorder={(newOrder) => handleReorderNodes(type, newOrder)} className="space-y-1">
                                                            {filtered.map(n => (
                                                                <Reorder.Item
                                                                    key={n.id}
                                                                    value={n}
                                                                    dragElastic={0.5}
                                                                    transition={{ type: "tween", duration: 0.15 }}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        handleSelectProject(project.id);
                                                                        setSelectedNodeIds(new Set([n.id]));
                                                                        animateViewport({
                                                                            x: -(n.x + CARD_W / 2) * scale + (window.innerWidth - 320) / 2,
                                                                            y: -(n.y + CARD_H / 2) * scale + window.innerHeight / 2
                                                                        }, scale);
                                                                    }}
                                                                    onDoubleClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setSelectedNodeIds(new Set());
                                                                        setSelectedNodeId(n.id);
                                                                    }}
                                                                    className={`group/node py-1.5 px-3 bg-white hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-zinc-700/80 rounded-[3px] flex items-center justify-between gap-2 cursor-grab active:cursor-grabbing shadow-sm transition-colors border-l-4 dark:bg-zinc-800/90 dark:border-zinc-700 ${getSidebarItemAccent(n)} ${(selectedNodeIds.has(n.id) || selectedNodeId === n.id) ? `border-2 ${getSelectedBorderColor(n)}` : 'border-2 border-slate-200 dark:border-zinc-700'}`}
                                                                >
                                                                    <div className="flex items-center gap-2 min-w-0 flex-1">
                                                                        <span className="text-xs shrink-0">{n.data.emoji}</span>
                                                                        <span className="text-[11px] font-bold text-slate-600 truncate dark:text-zinc-300">{n.label}</span>
                                                                    </div>
                                                                    <div className="flex items-center shrink-0">
                                                                        {n.type === 'ì¸ë¬¼' && (
                                                                            <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                                {n.data.role}
                                                                            </span>
                                                                        )}
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                if (confirm(`'${n.label}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) deleteNode(n.id);
                                                                            }}
                                                                            className="w-0 opacity-0 group-hover/node:w-5 group-hover/node:opacity-100 group-hover/node:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"
                                                                        >
                                                                            <IconTrash className="w-3 h-3" />
                                                                        </button>
                                                                    </div>
                                                                </Reorder.Item>
                                                            ))}
                                                        </Reorder.Group>
                                                    ) : (
                                                        <div className={`grid gap-1 ${cols === 4 ? 'grid-cols-4' : cols === 3 ? 'grid-cols-3' : cols === 2 ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                                            {filtered.map(n => (
                                                                <div
                                                                    key={n.id}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        handleSelectProject(project.id);
                                                                        setSelectedNodeIds(new Set([n.id]));
                                                                        animateViewport({
                                                                            x: -(n.x + CARD_W / 2) * scale + (window.innerWidth - 320) / 2,
                                                                            y: -(n.y + CARD_H / 2) * scale + window.innerHeight / 2
                                                                        }, scale);
                                                                    }}
                                                                    onDoubleClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setSelectedNodeIds(new Set());
                                                                        setSelectedNodeId(n.id);
                                                                    }}
                                                                    className={`group/node py-1.5 px-2 bg-white hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-zinc-700/80 rounded-[3px] flex items-center gap-1.5 cursor-pointer shadow-sm transition-colors border-l-4 dark:bg-zinc-800/90 dark:border-zinc-700 ${getSidebarItemAccent(n)} ${(selectedNodeIds.has(n.id) || selectedNodeId === n.id) ? `border-2 ${getSelectedBorderColor(n)}` : 'border-2 border-slate-200 dark:border-zinc-700'}`}
                                                                >
                                                                    {cols !== 4 && <span className="text-xs shrink-0">{n.data.emoji}</span>}
                                                                    <span className={`font-bold text-slate-600 truncate dark:text-zinc-300 flex-1 min-w-0 ${cols === 4 ? 'text-[9px]' : 'text-[10px]'}`}>{n.label}</span>
                                                                    {cols === 2 && n.type === 'ì¸ë¬¼' && n.data.role && (
                                                                        <span className={`text-[7px] font-black px-1 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                            {n.data.role}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        });
                                    })()}
                                    </div>
                                </div>
                            )
                        )}
                    </div>
                );

                if (isDoc) {
                    return projectContent;
                }

                return (
                    <Reorder.Item
                        key={project.id}
                        value={project}
                        dragElastic={0}
                        transition={{ duration: 0 }}
                        className="cursor-grab active:cursor-grabbing"
                    >
                        {projectContent}
                    </Reorder.Item>
                );
            };

            if (!activeProject) return null;

            return (
                <div className={`flex w-screen h-screen no-drag transition-colors duration-500 ${isTrashOpen ? 'bg-[#f8fafc] dark:bg-[#09080B]' : (activeProject.type === 'board' ? 'grid-background' : 'dot-background')} ${(isPanning || draggingNodeId) ? 'is-dragging' : ''}`} onMouseMove={handleGlobalMouseMove} onMouseUp={handleGlobalMouseUp} onContextMenu={e => e.preventDefault()}>
                    {showSystemSettings && (
                        <SystemSettingsModal
                            onClose={() => setShowSystemSettings(false)}
                            isDarkMode={isDarkMode}
                            toggleDarkMode={toggleDarkMode}
                            fontMode={fontMode}
                            toggleFont={toggleFont}
                            activeProject={activeProject}
                            onUpdateProject={(updated) => {
                                setProjects(prev => prev.map(p => p.id === updated.id ? updated : p));
                            }}
                            focusPosition={focusPosition}
                            setFocusPosition={setFocusPosition}
                            defaultTargetCount={defaultTargetCount}
                            setDefaultTargetCount={setDefaultTargetCount}
                            editorWidth={editorWidth}
                            setEditorWidth={setEditorWidth}
                            editorFontSize={editorFontSize}
                            setEditorFontSize={setEditorFontSize}
                            showDocWordCount={showDocWordCount}
                            setShowDocWordCount={setShowDocWordCount}
                            enableHistory={enableHistory}
                            setEnableHistory={setEnableHistory}
                        />
                    )}
                    <aside className={`h-full bg-[#f5f5f5] border-r border-slate-200 z-[100] flex flex-col shadow-2xl overflow-hidden dark:bg-[#141417] dark:border-zinc-700/50 transition-all duration-500 ease-in-out ${isZenMode ? 'w-0 -translate-x-full opacity-0' : 'w-80 opacity-100'
                        }`} style={{ borderRadius: 0 }}>

                        <div className="w-full bg-slate-800 rounded-none">
                            <div
                                onClick={onExit}
                                className="w-full py-2 px-5 flex items-center gap-3 transition-all duration-300 cursor-pointer hover:bg-slate-700"
                            >
                                <div className="w-4 h-4 bg-white/10 flex items-center justify-center transition-all">
                                    <IconBack className="w-4 h-4 text-slate-400" />
                                </div>
                                <div className="flex flex-col items-start">
                                    <span className="text-[12px] text-slate-400 tracking-tight">ë‚´ ì„œì¬ë¡œ ëŒì•„ê°€ê¸°</span>
                                </div>
                            </div>
                        </div>

                        <div
                            className="px-6 pt-6 pb-5 border-b border-slate-200/60 dark:border-zinc-800/60"
                            style={{
                                backgroundColor: isDarkMode ? `${currentBook.color}12` : `${currentBook.color}22`,
                            }}
                        >
                            <div className="text-left">
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="text-[9px] font-black px-2 py-0.5 bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-500 rounded-[2px] tracking-widest uppercase border border-slate-200/50 dark:border-zinc-700/30">Novel project</span>
                                </div>

                                <h1 className="text-xl font-black text-slate-800 dark:text-zinc-100 tracking-tighter leading-tight">
                                    {currentBook.title}
                                </h1>

                                <div className="flex items-center gap-2 mt-2 opacity-60">
                                    <span className="text-[11px] font-bold text-slate-500 dark:text-zinc-400 tracking-wide">
                                        {currentBook.author || 'ì‘ê°€ ë¯¸ìƒ'}
                                    </span>
                                </div>
                            </div>
                        </div>


                        <div className="flex-1 overflow-y-auto px-3 pt-4 custom-scroll pb-10">
                                                                <div className="mb-5">
                                                            <div className="flex items-center justify-between mb-3 px-2">
                                                                <div 
                                                                    onClick={() => {
                                                                        const firstBoard = projects.find(p => p.type === 'board');
                                                                        if (firstBoard) {
                                                                            handleSelectProject(firstBoard.id);
                                                                            setCorkboardMode(false);
                                                                        }
                                                                    }}
                                                                    className={`text-[9px] font-black px-2 py-0.5 rounded-[2px] tracking-widest uppercase border flex items-center gap-2 cursor-pointer transition-colors ${activeProject?.type === 'board' && !corkboardMode && !isTrashOpen ? 'bg-indigo-50 text-indigo-600 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/50' : 'bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-500 border-slate-200/50 dark:border-zinc-700/30 hover:bg-slate-200 dark:hover:bg-zinc-700'}`}
                                                                >
                                                                    <span className={`w-1.5 h-1.5 rounded-full ${activeProject?.type === 'board' && !corkboardMode && !isTrashOpen ? 'bg-indigo-500 animate-pulse' : 'bg-slate-400'}`}></span> ì•„ì´ë””ì–´ ë³´ë“œ ({projects.filter(p => p.type === 'board').length})
                                                                </div>
                                                                <button onClick={createNewProject} className="text-slate-400 hover:text-indigo-600 transition-colors" title="ìƒˆ ë³´ë“œ ì¶”ê°€">
                                                                    <IconPlus className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                            <Reorder.Group axis="y" values={projects.filter(p => p.type === 'board')} onReorder={handleReorderBoards} className="space-y-1">
                                                                {projects.filter(p => p.type === 'board').map(project => renderProjectItem(project))}
                                                            </Reorder.Group>
                                                        </div>
                                                                                    <div>
                                                                                        <div className="flex items-center justify-between mb-3 px-2 group h-7">
                                                                                                                                <div className="flex gap-1">
                                                                                                                                                                                                                                                                                                                                            <div 
                                                                                                                                                                                                                                                                                                                                                onClick={() => {
                                                                                                                                                                                                                                                                                                                                                    const firstDoc = projects.find(p => p.type === 'doc');
                                                                                                                                                                                                                                                                                                                                                    if (firstDoc) {
                                                                                                                                                                                                                                                                                                                                                        handleSelectProject(firstDoc.id);
                                                                                                                                                                                                                                                                                                                                                        setCorkboardMode(false);
                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                }}
                                                                                                                                                                                                                                                                                                                                                className={`text-[9px] font-black px-2 py-0.5 rounded-[2px] tracking-widest uppercase border flex items-center gap-2 cursor-pointer transition-colors ${(activeProject?.type === 'doc' || compareMode) && !corkboardMode && !isTrashOpen ? 'bg-indigo-50 text-indigo-600 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/50' : 'bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-500 border-slate-200/50 dark:border-zinc-700/30 hover:bg-slate-200 dark:hover:bg-zinc-700'}`}
                                                                                                                                                                                                                                                                                                                                                title="ë¬¸ì„œí•¨"
                                                                                                                                                                                                                                                                                                                                            >
                                                                                                                                                                                                                                                                                                                                                <span className={`w-1.5 h-1.5 rounded-full ${(activeProject?.type === 'doc' || compareMode) && !corkboardMode && !isTrashOpen ? 'bg-indigo-500 animate-pulse' : 'bg-slate-400'}`}></span>
                                                                                                                                                                                                                                                                                                                                                {compareMode ? 'ë¹„êµ ëª¨ë“œ' : `ë¬¸ì„œí•¨ (${projects.filter(p => p.type === 'doc').length})`}
                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                            <div 
                                                                                                                                                                                                                                                                                                                                                onClick={() => { setCorkboardMode(true); setCompareMode(false); setActiveProjectId(null); }}                                                                                                                                            className={`text-[9px] font-black px-2 py-0.5 rounded-[2px] tracking-widest uppercase border flex items-center gap-2 cursor-pointer transition-colors ${corkboardMode ? 'bg-amber-50 text-amber-600 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800 hover:bg-amber-100 dark:hover:bg-amber-900/50' : 'bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-500 border-slate-200/50 dark:border-zinc-700/30 hover:bg-slate-200 dark:hover:bg-zinc-700'}`}
                                                                                                                                                                                                                                                                                                                                                title="ì½”ë¥´í¬ ë³´ë“œ ëª¨ë“œ"
                                                                                                                                                                                                                                                                                                                                            >
                                                                                                                                                                                                                                                                                                                                                ì½”ë¥´í¬ë³´ë“œ
                                                                                                                                                                                                                                                                                                                                            </div>                                                                                            </div>                                    <div className="flex items-center gap-1">
                                        {/* ë¬¸ì„œ í•„í„° ë²„íŠ¼ (íšŒìƒ‰/ê²€ì€ ë°°ê²½ ìŠ¤íƒ€ì¼) */}
                                        <div className="w-0 group-hover:w-[95px] overflow-hidden transition-all duration-500 ease-in-out">
                                            <div className="flex items-center gap-0.5 bg-slate-200 dark:bg-zinc-900 p-0.5 rounded-sm min-w-[95px] opacity-0 translate-x-8 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-500">
                                                {['ì´ˆê³ ', 'ìˆ˜ì •', 'ì™„ë£Œ'].map(filter => (
                                                    <button
                                                        key={filter}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setDocFilter(prev => prev === filter ? null : filter);
                                                        }}
                                                        className={`shrink-0 px-1.5 py-0.5 text-[9px] font-black rounded-sm transition-colors whitespace-nowrap ${docFilter === filter
                                                            ? (filter === 'ì™„ë£Œ' ? 'bg-emerald-600 text-white shadow-sm' :
                                                                filter === 'ìˆ˜ì •' ? 'bg-amber-100 text-amber-600 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800' :
                                                                    'bg-white text-slate-600 dark:bg-zinc-700 dark:text-zinc-300 shadow-sm')
                                                            : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-white'
                                                            }`}
                                                    >
                                                        {filter}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <button onClick={createNewDoc} className="text-slate-400 hover:text-indigo-600 transition-colors shrink-0" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€">
                                            <IconPlus className="w-4 h-4" />
                                        </button>
                                    </div>                                </div>
                                <Reorder.Group axis="y" values={projects.filter(p => p.type === 'doc')} onReorder={handleReorderDocs} className="space-y-0 border-t border-slate-200/50 dark:border-zinc-700/50">
                                    {projects.filter(p => p.type === 'doc').filter(p => docFilter === null || (p.status || 'ì´ˆê³ ') === docFilter).map(project => {
                                        const isActive = !isTrashOpen && activeProjectId === project.id;
                                        return (
                                            <Reorder.Item
                                                key={project.id}
                                                value={project}
                                                initial={{ opacity: 0 }}
                                                animate={{ opacity: 1 }}
                                                exit={{ opacity: 0 }}
                                                layoutId={`doc-${project.id}`}
                                                dragElastic={0.5}
                                                transition={{ type: "tween", duration: 0.15 }}
                                                whileDrag={{ scale: 1.02, boxShadow: '0 5px 15px rgba(0,0,0,0.1)', zIndex: 100 }}
                                                onClick={(e) => handleSelectProject(project.id, e)}
                                                onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }}
                                                className={`border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 cursor-grab active:cursor-grabbing ${isActive ? 'bg-white dark:bg-zinc-700' : (compareMode && compareDocIds.includes(project.id)) ? 'bg-indigo-50 dark:bg-indigo-900/20 ring-1 ring-indigo-300 dark:ring-indigo-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}`}
                                            >
                                                <div className="flex items-center px-4 h-[30px] py-0 group relative overflow-hidden">
                                                    {isActive && <div className="absolute left-0 top-0 bottom-0 w-[3px] bg-indigo-600 dark:bg-indigo-500" />}
                                                    <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                                        <span className="text-sm opacity-50 shrink-0 dark:text-zinc-300">ğŸ“„</span>
                                                        {editingProjectId === project.id ? (
                                                            <input
                                                                autoFocus
                                                                className="w-full bg-white border border-indigo-400 rounded-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white"
                                                                defaultValue={project.name}
                                                                onBlur={(e) => handleProjectRename(project.id, e.target.value)}
                                                                onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                        ) : (
                                                            <div className="flex items-center min-w-0 flex-1 justify-between">
                                                                <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                                                {showDocWordCount && <span className="text-[10px] text-slate-400/90 dark:text-zinc-500/90 font-medium shrink-0 mr-1.5">{(project.content || '').length.toLocaleString()}ì</span>}
                                                                <div className="flex items-center shrink-0">
                                                                    <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] ${getStatusBadgeStyle(project.status || 'ì´ˆê³ ')}`}>{project.status || 'ì´ˆê³ '}</span>
                                                                    <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </Reorder.Item>
                                        );
                                    })}
                                </Reorder.Group>
                            </div>
                                                </div>
                                                                        {/* íœ´ì§€í†µ ë²„íŠ¼ - í•˜ë‹¨ ê³ ì • */}
                                                                        <div className="shrink-0 border-t border-slate-200 dark:border-zinc-700 bg-white dark:bg-[#161618]">
                                                                            <button
                                                                                onClick={() => { setIsTrashOpen(true); setCorkboardMode(false); setActiveProjectId(null); }}
                                                                                className={`w-full px-5 py-2 flex items-center justify-between transition-colors ${isTrashOpen ? 'bg-slate-100 dark:bg-zinc-700' : 'hover:bg-slate-100 dark:hover:bg-zinc-800'}`}
                                                                            >
                                                                                <div className="flex items-center gap-2 text-slate-500 dark:text-zinc-400">
                                                                                    <IconTrash className="w-4 h-4" />
                                                                                    <span className="text-[11px] font-bold">íœ´ì§€í†µ</span>
                                                                                    {trash.length > 0 && (
                                                                                        <span className="text-[9px] bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 px-1.5 py-0.5 rounded-full font-bold">{trash.length}</span>
                                                                                    )}
                                                                                </div>
                                                                                <svg className="w-3 h-3 text-slate-400 dark:text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                            </aside>
                        
                                            <main
                                                className={`flex-1 relative overflow-hidden transition-all duration-500 ease-in-out ${activeProject?.type === 'board' ? (isPanning || isMarqueeSelectingRef.current ? 'cursor-grabbing' : draggingNodeId ? 'cursor-grabbing' : 'cursor-grab') : ''}`}
                                                ref={containerRef}
                                                onMouseDown={(e) => {
                                                    if (activeProject?.type === 'board' && !corkboardMode) {
                                                        if (rAF.current) { cancelAnimationFrame(rAF.current); rAF.current = null; }
                                                        lastMousePos.current = { x: e.clientX, y: e.clientY };
                                                        latestMousePos.current = { x: e.clientX, y: e.clientY };
                        
                                                        if (e.shiftKey && e.button === 0) {
                                                            isMarqueeSelectingRef.current = true;
                                                            const startCoords = getCanvasCoords(e.clientX, e.clientY);
                                                            setMarquee({ x: startCoords.x, y: startCoords.y, width: 0, height: 0, startX: startCoords.x, startY: startCoords.y });
                                                        } else if (e.button === 0) {
                                                            setIsPanning(true);
                                                            if (!e.shiftKey) {
                                                                setSelectedNodeIds(new Set());
                                                                setSelectedNodeId(null);
                                                            }
                                                        }
                                                    }
                                                }}
                                            >
                                                {/* ìƒë‹¨ ê³µí†µ ë„êµ¬ (íƒ€ì´ë¨¸, ì§‘ì¤‘ëª¨ë“œ) */}
                                                <div className="fixed top-6 right-10 z-[110] flex flex-col items-end gap-2 pointer-events-none">
                                                    <div className="flex items-center gap-2 pointer-events-auto">
                                                        <button
                                                            onClick={() => setIsPomodoroOpen(!isPomodoroOpen)}
                                                            className={`flex items-center justify-center w-8 h-8 rounded-full shadow-xl border transition-all ${isPomodoroOpen ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-white border-slate-200 hover:border-indigo-300 dark:bg-zinc-800 dark:border-zinc-700'}`}
                                                            title="ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸"
                                                        >
                                                            {!isPomodoroOpen && isPomoActive ? (
                                                                <div className="relative w-6 h-6">
                                                                    <svg viewBox="0 0 100 100" className="w-full h-full -rotate-90">
                                                                        {/* Background */}
                                                                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-100 dark:text-zinc-700" />
                        
                                                                        {/* Red Wedge */}
                                                                        <circle
                                                                            cx="50" cy="50" r="22.5"
                                                                            fill="none"
                                                                            stroke="#ef4444"
                                                                            strokeWidth="45"
                                                                            strokeDasharray={2 * Math.PI * 22.5}
                                                                            style={{
                                                                                strokeDashoffset: (2 * Math.PI * 22.5) * (pomoRemaining / pomoInitialTotal),
                                                                                transition: isPomoActive ? 'stroke-dashoffset 1s linear' : 'none',
                                                                            }}
                                                                            className="opacity-90"
                                                                        />
                                                                    </svg>
                                                                </div>
                                                            ) : (
                                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={isPomodoroOpen ? 'text-white' : 'text-slate-400'}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
                                                            )}
                                                        </button>
                                                        <div className={`flex items-center rounded-full shadow-xl border transition-all ${isZenMode ? 'bg-indigo-600 border-indigo-500 shadow-indigo-500/20' : 'bg-white text-slate-400 border-slate-200 hover:text-indigo-600 dark:bg-zinc-800 dark:border-zinc-700'}`}>
                                                            <button
                                                                onClick={() => {
                                                                    setIsZenMode(!isZenMode);
                                                                }}
                                                                className={`flex items-center justify-center gap-2 h-8 w-8 rounded-full text-[12px] font-black tracking-widest transition-all ${isZenMode ? 'text-white' : 'text-slate-400 hover:text-indigo-600'}`}
                                                                title={compareMode ? "í˜„ì¬ í™œì„± íŒ¨ë„ ì§‘ì¤‘ ëª¨ë“œ" : "ì§‘ì¤‘ ëª¨ë“œ (Ctrl+J)"}
                                                            >
                                                                <IconZen className={`w-4 h-4 ${isZenMode ? 'animate-spin' : ''}`} style={{ animationDuration: '3s' }} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <AnimatePresence>
                                                        {isPomodoroOpen && (
                                                            <PomodoroTimer
                                                                minutes={pomoMinutes} setMinutes={setPomoMinutes}
                                                                seconds={pomoSeconds} setSeconds={setPomoSeconds}
                                                                isActive={isPomoActive} setIsActive={setIsPomoActive}
                                                                initialTotal={pomoInitialTotal} setInitialTotal={setPomoInitialTotal}
                                                                remaining={pomoRemaining} setRemaining={setPomoRemaining}
                                                                isSetting={isPomoSetting} setIsSetting={setIsPomoSetting}
                                                                showToast={showToast}
                                                            />
                                                        )}
                                                    </AnimatePresence>
                                                </div>
                        
                                                                                                {corkboardMode ? (
                        
                                                                                                    /* ì½”ë¥´í¬ë³´ë“œ ëª¨ë“œ ë·° */
                        
                                                                                                    <div 
                        
                                                                                                        className="w-full h-full overflow-y-auto custom-scroll p-10 dot-background"
                        
                                                                                                        onWheel={(e) => e.stopPropagation()}
                        
                                                                                                    >
                        
                                                                                                        <div className="max-w-7xl mx-auto py-12">
                        
                                                                                                            {/* í—¤ë” */}
                        
                                                                                                            <div className="flex items-center justify-between mb-8">
                        
                                                                                                                <div className="flex items-center gap-4">
                        
                                                                                                                    <div className="w-14 h-14 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center">
                        
                                                                                                                        <span className="text-2xl">ğŸ“Œ</span>
                        
                                                                                                                    </div>
                        
                                                                                                                    <div>
                        
                                                                                                                        <h2 className="text-2xl font-black text-slate-800 dark:text-zinc-100">ì½”ë¥´í¬ ë³´ë“œ</h2>
                        
                                                                                                                        <span className="text-sm text-slate-400 dark:text-zinc-500">{projects.filter(p => p.type === 'doc').length}ê°œ ë¬¸ì„œ</span>
                        
                                                                                                                    </div>
                        
                                                                                                                </div>
                        
                                                                                                                <button
                        
                                                                                                                    onClick={createNewDoc}
                        
                                                                                                                    className="px-5 py-2.5 text-[11px] font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/40 dark:text-indigo-400 rounded-lg transition-colors border border-indigo-200 dark:border-indigo-800 flex items-center gap-2"
                        
                                                                                                                >
                        
                                                                                                                    <IconPlus className="w-4 h-4" />
                        
                                                                                                                    ìƒˆ ë¬¸ì„œ
                        
                                                                                                                </button>
                        
                                                                                                            </div>
                        
                                                                                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        
                                                                                                                {projects.filter(p => p.type === 'doc').map((doc) => (
                        
                                                                                                                    <motion.div
                        
                                                                                                                        key={doc.id}
                        
                                                                                                                        layoutId={`corkboard-${doc.id}`}
                        
                                                                                                                        className="bg-white dark:bg-zinc-800 rounded-lg shadow-md border border-slate-200 dark:border-zinc-700 p-2 flex flex-col h-[300px] hover:shadow-xl transition-all"
                        
                                                                                                                        onWheel={(e) => {
                        
                                                                                                                            const el = e.currentTarget.querySelector('textarea');
                        
                                                                                                                            if (el && el.scrollHeight > el.clientHeight) {
                        
                                                                                                                                e.stopPropagation();
                        
                                                                                                                            }
                        
                                                                                                                        }}
                        
                                                                                                                    >
                        
                                                                                                                        <div className="flex items-center justify-between mb-2 border-b border-slate-100 dark:border-zinc-700 pb-2">
                        
                                                                                                                            <div className="flex items-center gap-2 flex-1 min-w-0 mr-2">
                        
                                                                                                                                <span className="text-lg shrink-0">ğŸ“„</span>
                        
                                                                                                                                {corkboardEditingId === doc.id ? (
                                                                                                                                    <input
                                                                                                                                        autoFocus
                                                                                                                                        type="text"
                                                                                                                                        className="w-full bg-slate-50 border border-indigo-400 rounded-[3px] px-1 text-sm font-black outline-none dark:bg-zinc-700 dark:text-white"
                                                                                                                                        defaultValue={doc.name}
                                                                                                                                        onBlur={(e) => { setProjects(prev => prev.map(p => p.id === doc.id ? { ...p, name: e.target.value } : p)); setCorkboardEditingId(null); }}
                                                                                                                                        onKeyDown={(e) => { if (e.key === 'Enter') { setProjects(prev => prev.map(p => p.id === doc.id ? { ...p, name: e.target.value } : p)); setCorkboardEditingId(null); } }}
                                                                                                                                        onClick={(e) => e.stopPropagation()}
                                                                                                                                    />
                                                                                                                                ) : (
                                                                                                                                    <span
                                                                                                                                        onDoubleClick={() => setCorkboardEditingId(doc.id)}
                                                                                                                                        className="font-black text-slate-800 dark:text-zinc-100 truncate text-sm cursor-pointer hover:text-slate-500 dark:hover:text-zinc-400 transition-colors"
                                                                                                                                        title="ë”ë¸”í´ë¦­í•˜ì—¬ ì œëª© ìˆ˜ì •"
                                                                                                                                    >
                                                                                                                                        {doc.name}
                                                                                                                                    </span>
                                                                                                                                )}
                        
                                                                                                                            </div>
                        
                                                                                                                            <span className={`text-[9px] font-black px-2 py-0.5 rounded-[2px] shrink-0 ${getStatusBadgeStyle(doc.status)}`}>{doc.status || 'ì´ˆê³ '}</span>
                        
                                                                                                                        </div>
                        
                                                                                                                        <div className="flex-1 overflow-hidden mb-2 relative -mr-2">

                                                                                                                            <textarea

                                                                                                                                className="w-full h-full resize-none outline-none text-sm text-slate-600 dark:text-zinc-300 leading-relaxed bg-transparent border-none pr-2 placeholder:italic custom-scroll"
                        
                                                                                                                                placeholder="ì‹œë†‰ì‹œìŠ¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        
                                                                                                                                value={doc.synopsis || ''}
                        
                                                                                                                                onChange={(e) => setProjects(prev => prev.map(p => p.id === doc.id ? { ...p, synopsis: e.target.value } : p))}
                        
                                                                                                                                onMouseDown={(e) => e.stopPropagation()} 
                        
                                                                                                                                onWheel={(e) => {
                        
                                                                                                                                    const el = e.currentTarget;
                        
                                                                                                                                    if (el.scrollHeight > el.clientHeight) {
                        
                                                                                                                                        e.stopPropagation();
                        
                                                                                                                                    }
                        
                                                                                                                                }}
                        
                                                                                                                            />
                        
                                                                                                                        </div>
                        
                                                                                                                        <div className="pt-2 border-t border-slate-100 dark:border-zinc-700 flex justify-between items-center text-[10px] text-slate-400 dark:text-zinc-500">
                        
                                                                                                                            <span>{(doc.content || "").length.toLocaleString()}ì</span>
                        
                                                                                                                            <button 
                        
                                                                                                                                onClick={(e) => {
                        
                                                                                                                                    e.stopPropagation();
                        
                                                                                                                                    setCorkboardMode(false);
                        
                                                                                                                                    handleSelectProject(doc.id);
                        
                                                                                                                                }}
                        
                                                                                                                                className="hover:text-indigo-600 dark:hover:text-indigo-400 font-bold transition-colors"
                        
                                                                                                                            >
                        
                                                                                                                                ë°”ë¡œê°€ê¸° â†’
                        
                                                                                                                            </button>
                        
                                                                                                                        </div>
                        
                                                                                                                    </motion.div>
                        
                                                                                                                ))}
                        
                                                                                                            </div>
                        
                                                                                                        </div>
                        
                                                                                                    </div>
                        
                                                                                                ) : isTrashOpen ? (
                                                                                                                    /* íœ´ì§€í†µ ë©”ì¸ ë·° */
                                                                                                                    <div className="w-full h-full overflow-y-auto custom-scroll p-10 bg-slate-100 dark:bg-zinc-950">
                                                                                                                        <div className="max-w-7xl mx-auto py-12">
                                                                                                                            {/* í—¤ë” */}
                                                                                                                            <div className="flex items-center justify-between mb-8">
                                                                                                                                <div className="flex items-center gap-4">
                                                                                                                                    <div className="w-14 h-14 bg-red-50 dark:bg-red-900/20 rounded-xl flex items-center justify-center">
                                                                                                                                        <IconTrash className="w-7 h-7 text-red-500" />
                                                                                                                                    </div>
                                            <div>
                                                <h2 className="text-2xl font-black text-slate-800 dark:text-zinc-100">íœ´ì§€í†µ</h2>
                                                <span className="text-sm text-slate-400 dark:text-zinc-500">{trash.length}ê°œ í•­ëª©</span>
                                            </div>
                                        </div>
                                        {trash.length > 0 && (
                                            <button
                                                onClick={emptyTrash}
                                                className="px-5 py-2.5 text-[11px] font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors border border-red-200 dark:border-red-800"
                                            >
                                                íœ´ì§€í†µ ë¹„ìš°ê¸°
                                            </button>
                                        )}
                                    </div>

                                    {/* ì»¨í…ì¸  - ì¹´ë“œ í˜•ì‹ */}
                                    {trash.length === 0 ? (
                                        <div className="h-[400px] flex flex-col items-center justify-center text-slate-400 dark:text-zinc-500">
                                            <IconTrash className="w-20 h-20 mb-6 opacity-20" />
                                            <p className="text-xl font-bold mb-2">íœ´ì§€í†µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</p>
                                            <p className="text-sm">ì‚­ì œëœ ë³´ë“œì™€ ë¬¸ì„œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                                            {trash.map(item => (
                                                <motion.div
                                                    key={item.id}
                                                    initial={{ opacity: 0 }}
                                                    animate={{ opacity: 1 }}
                                                    exit={{ opacity: 0 }}
                                                    transition={{ duration: 0.15 }}
                                                    className="group bg-white dark:bg-zinc-800 rounded-lg p-3 border border-slate-200 dark:border-zinc-700 hover:border-slate-300 dark:hover:border-zinc-600 hover:shadow-lg transition-all"
                                                >
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div className="flex items-center gap-2.5 min-w-0 flex-1">
                                                            <div className={`w-9 h-9 rounded-lg flex items-center justify-center text-base shrink-0 ${item.type === 'board' ? 'bg-indigo-100 dark:bg-indigo-900/30' : 'bg-emerald-100 dark:bg-emerald-900/30'}`}>
                                                                {item.type === 'board' ? 'ğŸ“‹' : 'ğŸ“„'}
                                                            </div>
                                                            <div className="min-w-0 flex-1">
                                                                <div className="flex justify-between items-start gap-2">
                                                                    <h3 className="font-bold text-sm text-slate-800 dark:text-zinc-100 truncate flex-1">{item.name}</h3>
                                                                    <span className="text-[12px] text-slate-400 dark:text-zinc-500 font-black shrink-0 mt-0.5 uppercase">
                                                                        {item.type === 'board' ? `${item.nodes?.length || 0} ë…¸ë“œ` : `${(item.content || '').length.toLocaleString()} ì`}
                                                                    </span>
                                                                </div>
                                                                <span className="text-[9px] text-slate-400 dark:text-zinc-500 uppercase font-bold block mt-0.5">
                                                                    {item.type === 'board' ? 'ë³´ë“œ' : 'ë¬¸ì„œ'}
                                                                    {item.deletedAt && ` Â· ${new Date(item.deletedAt).toLocaleString('ko-KR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true })}`}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* ì•¡ì…˜ ë²„íŠ¼ */}
                                                    <div className="flex gap-2 pt-2 border-t border-slate-50 dark:border-zinc-700/50">
                                                        <button
                                                            onClick={() => restoreFromTrash(item.id)}
                                                            className="flex-1 py-1.5 px-3 text-[10px] font-bold text-emerald-600 bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-900/20 dark:hover:bg-emerald-900/40 dark:text-emerald-400 rounded-md transition-colors flex items-center justify-center gap-1.5"
                                                        >
                                                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                                            </svg>
                                                            ë³µì›
                                                        </button>
                                                        <button
                                                            onClick={() => permanentDelete(item.id)}
                                                            className="py-1.5 px-3 text-[10px] font-bold text-red-500 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400 rounded-md transition-colors"
                                                            title="ì™„ì „ ì‚­ì œ"
                                                        >
                                                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </motion.div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : activeProject.type === 'board' ? (
                            <>
                                <div className="absolute top-6 left-6 z-[80] flex items-center gap-3" onMouseDown={(e) => e.stopPropagation()}>
                                    <div className="h-10 px-5 bg-white shadow-lg border border-slate-200 rounded-[3px] flex items-center gap-2 dark:bg-darkpanel dark:border-darkborder dark:text-white">
                                        <span className="w-2 h-2 bg-indigo-500 rounded-[3px] animate-pulse"></span>
                                        <span className="text-xs font-black text-slate-800 uppercase tracking-widest dark:text-zinc-200">{activeProject.name}</span>
                                    </div>
                                    <div className="flex items-center gap-1 p-1 bg-white rounded-[3px] shadow-lg border border-slate-200 h-10 dark:bg-darkpanel dark:border-darkborder">
                                        <button onClick={() => addNode('ì¸ë¬¼')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-blue-50 text-blue-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-blue-400" title="ì¸ë¬¼ ì¶”ê°€">
                                            <span className="text-sm">ğŸ‘¤</span>
                                            <span className="text-[10px] font-black hidden sm:inline">ì¸ë¬¼</span>
                                        </button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('ì‚¬ê±´')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-red-50 text-red-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-red-400" title="ì‚¬ê±´ ì¶”ê°€">
                                            <span className="text-sm">ğŸ”¥</span>
                                            <span className="text-[10px] font-black hidden sm:inline">ì‚¬ê±´</span>
                                        </button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('ë©”ëª¨')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-amber-50 text-amber-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-amber-400" title="ë©”ëª¨ ì¶”ê°€">
                                            <span className="text-sm">ğŸ’¡</span>
                                            <span className="text-[10px] font-black hidden sm:inline">ë©”ëª¨</span>
                                        </button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('í• ì¼')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-cyan-50 text-cyan-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-cyan-400" title="í• ì¼ ì¶”ê°€">
                                            <span className="text-sm">âœ…</span>
                                            <span className="text-[10px] font-black hidden sm:inline">í• ì¼</span>
                                        </button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <div className="relative" ref={nodeDropdownRef}>
                                            <button onClick={() => setShowNodeDropdown(!showNodeDropdown)} className="flex items-center gap-1 h-full px-3 rounded-[3px] hover:bg-slate-100 text-slate-600 transition-all active:scale-95 dark:hover:bg-zinc-700 dark:text-slate-400" title="ë” ë§ì€ ë…¸ë“œ ì¶”ê°€">
                                                <span className="text-sm">â•</span>
                                                <span className="text-[10px] font-black hidden sm:inline">ë”ë³´ê¸°</span>
                                                <svg className={`w-3 h-3 transition-transform ${showNodeDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </button>
                                            {showNodeDropdown && (
                                                <div className="absolute top-full left-0 mt-1 bg-white rounded-[3px] shadow-xl border border-slate-200 py-1 min-w-[140px] z-[200] dark:bg-darkpanel dark:border-darkborder">
                                                    <button onClick={() => { addNode('ì¥ì†Œ'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-emerald-50 text-emerald-600 transition-all dark:hover:bg-zinc-700 dark:text-emerald-400">
                                                        <span className="text-sm">ğŸ“</span>
                                                        <span className="text-[11px] font-bold">ì¥ì†Œ</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ì•„ì´í…œ'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-purple-50 text-purple-600 transition-all dark:hover:bg-zinc-700 dark:text-purple-400">
                                                        <span className="text-sm">ğŸ</span>
                                                        <span className="text-[11px] font-bold">ì•„ì´í…œ</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ì„¸ë ¥'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-orange-50 text-orange-600 transition-all dark:hover:bg-zinc-700 dark:text-orange-400">
                                                        <span className="text-sm">âš”ï¸</span>
                                                        <span className="text-[11px] font-bold">ì„¸ë ¥</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ë³µì„ '); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-pink-50 text-pink-600 transition-all dark:hover:bg-zinc-700 dark:text-pink-400">
                                                        <span className="text-sm">ğŸ£</span>
                                                        <span className="text-[11px] font-bold">ë³µì„ </span>
                                                    </button>
                                                    <button onClick={() => { addNode('íƒ€ì„ë¼ì¸'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-teal-50 text-teal-600 transition-all dark:hover:bg-zinc-700 dark:text-teal-400">
                                                        <span className="text-sm">â°</span>
                                                        <span className="text-[11px] font-bold">íƒ€ì„ë¼ì¸</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ì„¤ì •'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-indigo-50 text-indigo-600 transition-all dark:hover:bg-zinc-700 dark:text-indigo-400">
                                                        <span className="text-sm">ğŸ“š</span>
                                                        <span className="text-[11px] font-bold">ì„¤ì •</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ëŒ€ì‚¬'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-sky-50 text-sky-600 transition-all dark:hover:bg-zinc-700 dark:text-sky-400">
                                                        <span className="text-sm">ğŸ’¬</span>
                                                        <span className="text-[11px] font-bold">ëŒ€ì‚¬</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ê°ˆë“±'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-rose-50 text-rose-600 transition-all dark:hover:bg-zinc-700 dark:text-rose-400">
                                                        <span className="text-sm">âš¡</span>
                                                        <span className="text-[11px] font-bold">ê°ˆë“±</span>
                                                    </button>
                                                    <button onClick={() => { addNode('ê·¸ë£¹'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-100 text-slate-600 transition-all dark:hover:bg-zinc-700 dark:text-slate-400">
                                                        <span className="text-sm">ğŸ“</span>
                                                        <span className="text-[11px] font-bold">ê·¸ë£¹</span>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div
                                    onMouseDown={(e) => e.stopPropagation()}
                                    className="absolute bottom-8 right-8 z-[100] flex flex-col gap-2 font-bold dark:text-zinc-300">
                                    <button
                                        onClick={() => handleAutoLayout()}
                                        className="w-11 h-11 flex items-center justify-center bg-white hover:bg-slate-50 dark:bg-darkpanel dark:hover:bg-zinc-700 shadow-xl border border-slate-200 dark:border-zinc-700 rounded-[3px] transition-all"
                                        title="ìë™ ì •ë ¬ (Auto Layout)"
                                    >
                                        <IconLayout className="w-5 h-5 text-slate-500 dark:text-zinc-400" />
                                    </button>
                                    <button
                                        onClick={() => fitToScreen()}
                                        className="w-11 h-11 flex items-center justify-center bg-white hover:bg-slate-50 dark:bg-darkpanel dark:hover:bg-zinc-700 shadow-xl border border-slate-200 dark:border-zinc-700 rounded-[3px] transition-all"
                                        title="í™”ë©´ ì¤‘ì•™ ë§ì¶¤"
                                    >
                                        {/* ì•„ì´ì½˜ SVG ìƒëµ */}
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="scale-75 text-slate-500 dark:text-zinc-400">
                                            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                                        </svg>
                                    </button>
                                </div>

                                <div className="zoom-container w-full h-full" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}>
                                    <svg className="canvas-svg">
                                        <defs><marker id="arrow-event" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444" /></marker></defs>
                                        {visibleEdges.map(edge => {
                                            const from = findNode(edge.from); const to = findNode(edge.to); if (!from || !to) return null;
                                            let x1 = from.x + CARD_W / 2, y1 = from.y + CARD_H / 2, x2 = to.x + CARD_W / 2, y2 = to.y + CARD_H / 2;
                                            const coreTypes = ['ì¸ë¬¼', 'ì‚¬ê±´', 'ë©”ëª¨'];
                                            const isCoreType = (type) => coreTypes.includes(type);
                                            const isEventToEvent = from.type === 'ì‚¬ê±´' && to.type === 'ì‚¬ê±´';
                                            const isIdeaInvolved = from.type === 'ë©”ëª¨' || to.type === 'ë©”ëª¨';
                                            const isPersonToEvent = (from.type === 'ì¸ë¬¼' && to.type === 'ì‚¬ê±´') || (from.type === 'ì‚¬ê±´' && to.type === 'ì¸ë¬¼');
                                            const isPersonToPerson = from.type === 'ì¸ë¬¼' && to.type === 'ì¸ë¬¼';
                                            const isSameType = from.type === to.type;

                                            // ë…¸ë“œ íƒ€ì…ë³„ ê³ ìœ  ìƒ‰ìƒ (hex)
                                            const typeColors = {
                                                'ì¥ì†Œ': '#10b981', 'ì•„ì´í…œ': '#a855f7', 'ì„¸ë ¥': '#f97316',
                                                'ë³µì„ ': '#ec4899', 'íƒ€ì„ë¼ì¸': '#14b8a6', 'ì„¤ì •': '#6366f1',
                                                'ëŒ€ì‚¬': '#0ea5e9', 'ê°ˆë“±': '#f43f5e', 'ê·¸ë£¹': '#64748b'
                                            };

                                            // ì—£ì§€ ìƒ‰ìƒ ê²°ì • ë¡œì§
                                            let edgeColor;
                                            if (isCoreType(from.type) && isCoreType(to.type)) {
                                                // ê¸°ì¡´ ì¸ë¬¼/ì‚¬ê±´/ë©”ëª¨ ì—°ê²° ë¡œì§ ìœ ì§€
                                                edgeColor = isIdeaInvolved ? "#facc15" : isPersonToEvent ? "#3b82f6" : isPersonToPerson ? "#93c5fd" : "#ef4444";
                                            } else if (!isCoreType(from.type) && !isCoreType(to.type)) {
                                                // ë‘˜ ë‹¤ ìƒˆ íƒ€ì…ì¼ ê²½ìš°
                                                if (isSameType) {
                                                    edgeColor = typeColors[from.type] || "#64748b";
                                                } else {
                                                    edgeColor = "#94a3b8"; // íšŒìƒ‰
                                                }
                                            } else {
                                                // ê¸°ì¡´ íƒ€ì…ê³¼ ìƒˆ íƒ€ì… ê°„ ì—°ê²°
                                                edgeColor = "#94a3b8"; // íšŒìƒ‰
                                            }

                                            let pathData = isEventToEvent ? `M ${x1} ${y1} L ${getEdgeTargetPos(from, to, 12).x} ${getEdgeTargetPos(from, to, 12).y}` : getBezierPath(x1, y1, x2, y2);
                                            const strokeWidth = edge.width || (isPersonToEvent ? 12 : isEventToEvent ? 4 : isSameType && !isCoreType(from.type) ? 3 : 2);
                                            const strokeDash = edge.style ? getStrokeDashArray(edge.style, strokeWidth) : (isIdeaInvolved ? "8, 6" : "");
                                            const labelWidth = Math.max(70, (edge.label || "").length * 10 + 20);
                                            const showLabel = true;
                                            return (
                                                <g key={edge.id}>
                                                    <path d={pathData} className="edge-hitbox" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }} onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); saveHistory(); updateActiveProject(null, prev => prev.filter(ev => ev.id !== edge.id)); }} />
                                                    {edge.style === 'double' ? (
                                                        <>
                                                            <path d={pathData} stroke={edgeColor} strokeWidth={strokeWidth * 3} markerEnd={isEventToEvent ? "url(#arrow-event)" : ""} className="edge-path opacity-80" />
                                                            <path d={pathData} stroke={isDarkMode ? '#09080B' : '#f8fafc'} strokeWidth={strokeWidth} className="edge-path" />
                                                        </>
                                                    ) : (
                                                        <path d={pathData} stroke={edgeColor} strokeWidth={strokeWidth} markerEnd={isEventToEvent ? "url(#arrow-event)" : ""} strokeDasharray={strokeDash} className="edge-path opacity-80" />
                                                    )}
                                                    {showLabel && edge.label && (
                                                        <g className="cursor-pointer pointer-events-auto" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }}>
                                                            <rect x={(x1 + x2) / 2 - labelWidth / 2} y={(y1 + y2) / 2 - 16} width={labelWidth} height="32" rx="4" fill="white" stroke={edgeColor} strokeWidth="1.5" className="dark:fill-zinc-800" /><text x={(x1 + x2) / 2} y={(y1 + y2) / 2 + 5} textAnchor="middle" fontSize="14" fontWeight="900" fill="#334155" className="dark:fill-zinc-200">{edge.label}</text>
                                                        </g>
                                                    )}
                                                </g>
                                            );
                                        })}
                                        {tempEdge && findNode(tempEdge.fromId) && <line x1={findNode(tempEdge.fromId).x + CARD_W / 2} y1={findNode(tempEdge.fromId).y + CARD_H / 2} x2={tempEdge.toX} y2={tempEdge.toY} stroke="#94a3b8" strokeWidth="2" strokeDasharray="4,4" />}
                                    </svg>
                                    {marquee && (
                                        <div
                                            className="absolute border-2 border-dashed border-blue-500 bg-blue-500/10 dark:bg-blue-400/10 dark:border-blue-400 pointer-events-none"
                                            style={{
                                                left: marquee.x,
                                                top: marquee.y,
                                                width: marquee.width,
                                                height: marquee.height,
                                                zIndex: 999
                                            }}
                                        />
                                    )}

                                    {/* ê·¸ë£¹ ë…¸ë“œ ë¨¼ì € ë Œë”ë§ (ë’¤ì— ë°°ì¹˜) */}
                                    {visibleGroupNodes.map(node => (
                                        <GroupNode key={node.id} node={node} isSelected={selectedNodeIds.has(node.id) || selectedNodeId === node.id} isDragging={draggingNodeId && (selectedNodeIds.has(node.id) || draggingNodeId === node.id || dragOffset.nodeIds.has(node.id))} onMouseDown={(e, id) => { e.stopPropagation(); if (rAF.current) { cancelAnimationFrame(rAF.current); rAF.current = null; } lastMousePos.current = { x: e.clientX, y: e.clientY }; latestMousePos.current = { x: e.clientX, y: e.clientY }; if (e.button === 0) { if (e.shiftKey) { setSelectedNodeIds(prev => { const newSet = new Set(prev); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); selectedNodeIdsRef.current = newSet; return newSet; }); return; } if (!selectedNodeIds.has(id)) { const newSet = new Set([id]); setSelectedNodeIds(newSet); selectedNodeIdsRef.current = newSet; } setDraggingNodeId(id); } }} onDoubleClick={(id) => { setSelectedNodeIds(new Set()); setSelectedNodeId(id); }} onDelete={deleteNode} onResize={resizeGroupNode} />
                                    ))}
                                    {/* ì¼ë°˜ ë…¸ë“œ ë‚˜ì¤‘ì— ë Œë”ë§ (ì•ì— ë°°ì¹˜) */}
                                    {visibleRegularNodes.map(node => (
                                        <NodeCard
                                            key={node.id}
                                            node={node}
                                            isTop={topNodeId === node.id}
                                            isSelected={selectedNodeIds.has(node.id) || selectedNodeId === node.id}
                                            isDragging={draggingNodeId && (selectedNodeIds.has(node.id) || draggingNodeId === node.id || dragOffset.nodeIds.has(node.id))}
                                            onClick={(e, id) => { if (!e.shiftKey) setSelectedNodeIds(new Set([id])); }}
                                            onUpdateNode={(id, data) => updateActiveProject(prev => prev.map(n => n.id === id ? { ...n, data: { ...n.data, ...data } } : n))}
                                            onMouseDown={(e, id) => {
                                                e.stopPropagation();
                                                if (rAF.current) { cancelAnimationFrame(rAF.current); rAF.current = null; }
                                                lastMousePos.current = { x: e.clientX, y: e.clientY };
                                                latestMousePos.current = { x: e.clientX, y: e.clientY };
                                                if (e.button === 0) {
                                                    if (e.shiftKey) {
                                                        setSelectedNodeIds(prev => { const newSet = new Set(prev); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); selectedNodeIdsRef.current = newSet; return newSet; });
                                                        return;
                                                    }
                                                    if (!selectedNodeIds.has(id)) { const newSet = new Set([id]); setSelectedNodeIds(newSet); selectedNodeIdsRef.current = newSet; }
                                                    setDraggingNodeId(id);
                                                    setTopNodeId(id);
                                                } else if (e.button === 2) {
                                                    const node = findNode(id);
                                                    if (node) { setTempEdge({ fromId: id, toX: node.x + CARD_W / 2, toY: node.y + CARD_H / 2 }); }
                                                }
                                            }}
                                            onMouseUp={(e, id) => {
                                                if (tempEdge && id !== tempEdge.fromId) {
                                                    const edgeExists = edges.some(e => (e.from === tempEdge.fromId && e.to === id) || (e.from === id && e.to === tempEdge.fromId));
                                                    if (!edgeExists) {
                                                        saveHistory();
                                                        hasConnectedRef.current = true;
                                                        updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: id, label: '' }]);
                                                    }
                                                }
                                            }}
                                            onDoubleClick={(id) => { setSelectedNodeIds(new Set()); setSelectedNodeId(id); }}
                                            onDelete={deleteNode}
                                        />
                                    ))}
                                </div>
                            </>
                        ) : compareMode && compareDocIds[0] && compareDocIds[1] ? (
                            /* ë¬¸ì„œ ë¹„êµ ëª¨ë“œ UI - ì›ë³¸ editor-paper ë””ìì¸ ìœ ì§€ */
                            <div className="compare-container w-full h-full flex relative">
                                {/* ì™¼ìª½ íŒ¨ë„ */}
                                <div
                                    className={`h-full overflow-y-auto custom-scroll ${isSplitterDragging ? '' : 'transition-all duration-500 ease-in-out'} ${isZenMode ? (activeComparePane === 0 ? 'px-0' : 'w-0 overflow-hidden opacity-0') : 'px-6'}`}
                                    style={{ width: isZenMode ? (activeComparePane === 0 ? '100%' : '0%') : `${splitRatio}%` }}
                                    onClick={() => setActiveComparePane(0)}
                                >
                                    {(() => {
                                        const doc = getCompareDoc(0);
                                        if (!doc) return null;
                                        return (
                                            <motion.div className={`editor-paper relative ${editorWidth === 'wide' ? 'editor-wide' : editorWidth === 'narrow' ? 'editor-narrow' : ''}`}>
                                                <div className="editor-title-container">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{isZenMode && activeComparePane === 0 ? 'Focus Mode' : 'DOC TITLE'}</span>
                                                        {renderStatusSelector(doc)}
                                                    </div>
                                                    <input
                                                        className="w-full text-2xl font-black text-slate-800 outline-none border-b-2 border-slate-100 focus:border-indigo-400 pb-2 transition-all dark:text-zinc-200 dark:border-zinc-700 dark:focus:border-indigo-500 dark:bg-transparent"
                                                        value={doc.name}
                                                        onChange={(e) => setProjects(prev => prev.map(p => p.id === doc.id ? { ...p, name: e.target.value } : p))}
                                                        placeholder="ë¬¸ì„œ ì œëª©"
                                                    />
                                                </div>
                                                <textarea
                                                    ref={el => compareTextareaRefs.current[0] = el}
                                                    className={`editor-textarea custom-scroll ${isZenMode && activeComparePane === 0 ? 'zen-active' : ''}`}
                                                    style={{ fontSize: `${editorFontSize}px` }}
                                                    value={doc.content || ""}
                                                    onChange={(e) => { updateCompareDocContent(doc.id, e.target.value); updateFocusScroll(); }}
                                                    onFocus={() => setActiveComparePane(0)}
                                                    onClick={() => updateFocusScroll()}
                                                    onKeyUp={() => updateFocusScroll()}
                                                    placeholder="ì´ê³³ì— ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”... (@ì¸ë¬¼ / #ì‚¬ê±´ / $ë©”ëª¨ ì…ë ¥)"
                                                />
                                                <div className={`px-[40px] pb-10 transition-all duration-500 ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                                    <div className="mt-8 pt-4 border-t border-slate-100 flex flex-col gap-3 dark:border-zinc-700">
                                                        <div className="flex justify-between items-end text-[10px] font-black tracking-tighter">
                                                            <div className="flex gap-4 items-center">
                                                                <div className="flex flex-col gap-1"><span className="text-slate-400 uppercase">Statistics</span><div className="flex gap-3 text-slate-600 dark:text-zinc-400"><span>ê³µë°± í¬í•¨: <b className="text-slate-900 dark:text-zinc-200">{(doc.content || "").length.toLocaleString()}</b>ì</span><span>ê³µë°± ì œì™¸: <b className="text-slate-900 dark:text-zinc-200">{(doc.content || "").replace(/\s+/g, '').length.toLocaleString()}</b>ì</span></div></div>
                                                                <div className="w-px h-6 bg-slate-100 mx-2 dark:bg-zinc-700"></div>
                                                                <div className="flex flex-col gap-1"><span className="text-indigo-400 uppercase">Achievement</span><span className="text-[14px] text-indigo-600 italic dark:text-indigo-400">{Math.min(Math.round(((doc.content || "").length / defaultTargetCount) * 100), 100)}%</span></div>
                                                            </div>
                                                            <div className="flex flex-col items-end gap-1">
                                                                <span className="text-slate-400 uppercase">Target Goal</span>
                                                                <div className="text-slate-600 dark:text-zinc-400 text-[14px] font-black">
                                                                    <span><b className="text-slate-900 dark:text-zinc-200">{defaultTargetCount.toLocaleString()}</b>ì</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="w-full h-1.5 bg-slate-100 rounded-[3px] overflow-hidden dark:bg-zinc-700">
                                                            <motion.div
                                                                initial={{ width: 0 }}
                                                                animate={{ width: `${Math.min(((doc.content || "").length / defaultTargetCount) * 100, 100)}%` }}
                                                                style={{ backgroundColor: (doc.content || "").length >= defaultTargetCount ? "#10b981" : "#4f46e5" }}
                                                                className="h-full transition-all duration-500 ease-out rounded-[3px]"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            </motion.div>
                                        );
                                    })()}
                                </div>

                                {/* ë¶„í• ì„  (ì§‘ì¤‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ) */}
                                {!isZenMode && (
                                    <div
                                        className="w-1 h-full cursor-col-resize bg-slate-300 dark:bg-zinc-600 hover:bg-indigo-400 dark:hover:bg-indigo-500 transition-colors flex items-center justify-center group shrink-0 rounded-none"
                                        onMouseDown={handleSplitterMouseDown}
                                    >
                                        <div className="w-1 h-12 bg-slate-400 dark:bg-zinc-500 group-hover:bg-white rounded-full transition-colors"></div>
                                    </div>
                                )}

                                {/* ì˜¤ë¥¸ìª½ íŒ¨ë„ */}
                                <div
                                    className={`h-full overflow-y-auto custom-scroll ${isSplitterDragging ? '' : 'transition-all duration-500 ease-in-out'} ${isZenMode ? (activeComparePane === 1 ? 'px-0' : 'w-0 overflow-hidden opacity-0') : 'px-6'}`}
                                    style={{ width: isZenMode ? (activeComparePane === 1 ? '100%' : '0%') : `${100 - splitRatio}%` }}
                                    onClick={() => setActiveComparePane(1)}
                                >
                                    {(() => {
                                        const doc = getCompareDoc(1);
                                        if (!doc) return null;
                                        return (
                                            <motion.div className={`editor-paper relative ${editorWidth === 'wide' ? 'editor-wide' : editorWidth === 'narrow' ? 'editor-narrow' : ''}`}>
                                                <div className="editor-title-container">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{isZenMode && activeComparePane === 1 ? 'Focus Mode' : 'DOC TITLE'}</span>
                                                        {renderStatusSelector(doc)}
                                                    </div>
                                                    <input
                                                        className="w-full text-2xl font-black text-slate-800 outline-none border-b-2 border-slate-100 focus:border-indigo-400 pb-2 transition-all dark:text-zinc-200 dark:border-zinc-700 dark:focus:border-indigo-500 dark:bg-transparent"
                                                        value={doc.name}
                                                        onChange={(e) => setProjects(prev => prev.map(p => p.id === doc.id ? { ...p, name: e.target.value } : p))}
                                                        placeholder="ë¬¸ì„œ ì œëª©"
                                                    />
                                                </div>
                                                <textarea
                                                    ref={el => compareTextareaRefs.current[1] = el}
                                                    className={`editor-textarea custom-scroll ${isZenMode && activeComparePane === 1 ? 'zen-active' : ''}`}
                                                    style={{ fontSize: `${editorFontSize}px` }}
                                                    value={doc.content || ""}
                                                    onChange={(e) => { updateCompareDocContent(doc.id, e.target.value); updateFocusScroll(); }}
                                                    onFocus={() => setActiveComparePane(1)}
                                                    onClick={() => updateFocusScroll()}
                                                    onKeyUp={() => updateFocusScroll()}
                                                    placeholder="ì´ê³³ì— ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”... (@ì¸ë¬¼ / #ì‚¬ê±´ / $ë©”ëª¨ ì…ë ¥)"
                                                />
                                                <div className={`px-[40px] pb-10 transition-all duration-500 ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                                    <div className="mt-8 pt-4 border-t border-slate-100 flex flex-col gap-3 dark:border-zinc-700">
                                                        <div className="flex justify-between items-end text-[10px] font-black tracking-tighter">
                                                            <div className="flex gap-4 items-center">
                                                                <div className="flex flex-col gap-1"><span className="text-slate-400 uppercase">Statistics</span><div className="flex gap-3 text-slate-600 dark:text-zinc-400"><span>ê³µë°± í¬í•¨: <b className="text-slate-900 dark:text-zinc-200">{(doc.content || "").length.toLocaleString()}</b>ì</span><span>ê³µë°± ì œì™¸: <b className="text-slate-900 dark:text-zinc-200">{(doc.content || "").replace(/\s+/g, '').length.toLocaleString()}</b>ì</span></div></div>
                                                                <div className="w-px h-6 bg-slate-100 mx-2 dark:bg-zinc-700"></div>
                                                                <div className="flex flex-col gap-1"><span className="text-indigo-400 uppercase">Achievement</span><span className="text-[14px] text-indigo-600 italic dark:text-indigo-400">{Math.min(Math.round(((doc.content || "").length / defaultTargetCount) * 100), 100)}%</span></div>
                                                            </div>
                                                            <div className="flex flex-col items-end gap-1">
                                                                <span className="text-slate-400 uppercase">Target Goal</span>
                                                                <div className="text-slate-600 dark:text-zinc-400 text-[14px] font-black">
                                                                    <span><b className="text-slate-900 dark:text-zinc-200">{defaultTargetCount.toLocaleString()}</b>ì</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="w-full h-1.5 bg-slate-100 rounded-[3px] overflow-hidden dark:bg-zinc-700">
                                                            <motion.div
                                                                initial={{ width: 0 }}
                                                                animate={{ width: `${Math.min(((doc.content || "").length / defaultTargetCount) * 100, 100)}%` }}
                                                                style={{ backgroundColor: (doc.content || "").length >= defaultTargetCount ? "#10b981" : "#4f46e5" }}
                                                                className="h-full transition-all duration-500 ease-out rounded-[3px]"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            </motion.div>
                                        );
                                    })()}
                                </div>
                            </div>
                        ) : (
                        <div className={`w-full h-full overflow-y-auto custom-scroll transition-all duration-500 ease-in-out ${isZenMode ? 'px-0' : 'px-10'}`}>
                            <motion.div className={`editor-paper relative ${editorWidth === 'wide' ? 'editor-wide' : editorWidth === 'narrow' ? 'editor-narrow' : ''}`} style={{ boxShadow: isZenMode ? '0 0 0 15px rgba(0,0,0,0.05), 0 20px 50px rgba(0,0,0,0.1)' : '' }}>
                                <div className="editor-title-container">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest"> {isZenMode ? 'Focus Mode' : 'DOC TITLE'} </span>
                                        <div className="flex gap-1">
                                            <button
                                                onClick={() => setShowSynopsisModal(true)}
                                                className={`p-1 transition-all ${isZenMode ? 'opacity-10 hover:opacity-100' : ''} text-slate-400 hover:text-indigo-600 dark:text-zinc-500 dark:hover:text-indigo-400`}
                                                title="ì‹œë†‰ì‹œìŠ¤"
                                            >
                                                <IconFileText className="w-4 h-4" />
                                            </button>
                                            {renderStatusSelector(activeProject)}
                                        </div>
                                    </div>
                                    <input className="w-full text-2xl font-black text-slate-800 outline-none border-b-2 border-slate-100 focus:border-indigo-400 pb-2 transition-all dark:text-zinc-200 dark:border-zinc-700 dark:focus:border-indigo-500 dark:bg-transparent" value={activeProject.name} onChange={(e) => handleProjectRename(activeProject.id, e.target.value)} placeholder="ë¬¸ì„œ ì œëª©" />
                                </div>
                                <textarea
                                    ref={textareaRef}
                                    // [ì¤‘ìš”] zen-active í´ë˜ìŠ¤ ì¡°ê±´ë¶€ ì ìš©
                                    className={`editor-textarea custom-scroll ${isZenMode ? 'zen-active' : ''}`}
                                    style={{ fontSize: `${editorFontSize}px` }}
                                    value={activeProject.content || ""}
                                    onChange={(e) => {
                                        handleDocInput(e);
                                        updateFocusScroll();
                                    }}
                                    onKeyDown={(e) => {
                                        handleDocKeyDown(e);
                                        if (e.key === 'Enter' || e.key === 'Backspace') requestAnimationFrame(updateFocusScroll);
                                    }}
                                    onClick={() => updateFocusScroll()}
                                    onKeyUp={() => updateFocusScroll()}
                                    placeholder="ì´ê³³ì— ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”... (@ì¸ë¬¼ / #ì‚¬ê±´ / $ë©”ëª¨ ì…ë ¥)"
                                />
                                <div className={`px-[40px] pb-10 transition-all duration-500 ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                    <div className="mt-8 pt-4 border-t border-slate-100 flex flex-col gap-3 dark:border-zinc-700">
                                                        <div className="flex justify-between items-end text-[10px] font-black tracking-tighter">
                                            <div className="flex gap-4 items-center">
                                                <div className="flex flex-col gap-1"><span className="text-slate-400 uppercase">Statistics</span><div className="flex gap-3 text-slate-600 dark:text-zinc-400"><span>ê³µë°± í¬í•¨: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").length.toLocaleString()}</b>ì</span><span>ê³µë°± ì œì™¸: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").replace(/\s+/g, '').length.toLocaleString()}</b>ì</span></div></div>
                                                <div className="w-px h-6 bg-slate-100 mx-2 dark:bg-zinc-700"></div>
                                                <div className="flex flex-col gap-1"><span className="text-indigo-400 uppercase">Achievement</span><span className="text-[14px] text-indigo-600 italic dark:text-indigo-400">{Math.min(Math.round(((activeProject.content || "").length / defaultTargetCount) * 100), 100)}%</span></div>
                                            </div>
                                            <div className="flex flex-col items-end gap-1">
                                                <span className="text-slate-400 uppercase">Target Goal</span>
                                                <div className="text-slate-600 dark:text-zinc-400 text-[14px] font-black">
                                                    <span><b className="text-slate-900 dark:text-zinc-200">{defaultTargetCount.toLocaleString()}</b>ì</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="w-full h-1.5 bg-slate-100 rounded-[3px] overflow-hidden dark:bg-zinc-700">
                                            <motion.div
                                                initial={{ width: 0 }}
                                                animate={{ width: `${Math.min(((activeProject.content || "").length / defaultTargetCount) * 100, 100)}%` }}
                                                style={{ backgroundColor: (activeProject.content || "").length >= defaultTargetCount ? "#10b981" : "#4f46e5" }}
                                                className="h-full transition-all duration-500 ease-out rounded-[3px]"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </motion.div>
                        </div>
                        )}
                        {/* Floating History Button for Single Doc View */}
                        {!isTrashOpen && activeProject.type === 'doc' && !compareMode && !isZenMode && !corkboardMode && enableHistory && (
                            <button
                                onClick={() => setShowHistoryModal(true)}
                                className="absolute bottom-8 right-8 z-[100] h-7 px-2.5 bg-white dark:bg-zinc-800 shadow-xl border border-slate-200 dark:border-zinc-700 rounded-[3px] flex items-center gap-1.5 text-slate-500 dark:text-zinc-400 font-bold hover:text-indigo-600 dark:hover:text-indigo-400 hover:border-indigo-200 transition-all text-[10px]"
                            >
                                <IconHistory className="w-3 h-3" />
                                <span>ê¸°ë¡ {activeProject.history?.length > 0 ? `(${activeProject.history.length})` : ''}</span>
                            </button>
                        )}
                    </main>

                    {/* íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */}
                    {showHistoryModal && activeProject && activeProject.type === 'doc' && (
                        <HistoryManager
                            doc={activeProject}
                            onClose={() => setShowHistoryModal(false)}
                            onRestore={restoreSnapshot}
                            onSnapshot={(memo) => createSnapshot(activeProject.id, memo)}
                            onDelete={deleteSnapshot}
                        />
                    )}

                    {/* ì‹œë†‰ì‹œìŠ¤ ëª¨ë‹¬ */}
                    <AnimatePresence>
                        {showSynopsisModal && activeProject && (
                            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                                <motion.div 
                                    initial={{ opacity: 0 }} 
                                    animate={{ opacity: 1 }} 
                                    exit={{ opacity: 0 }} 
                                    className="absolute inset-0 bg-black/50 backdrop-blur-sm" 
                                    onClick={() => setShowSynopsisModal(false)} 
                                />
                                <motion.div
                                    initial={{ opacity: 0, scale: 0.95 }}
                                    animate={{ opacity: 1, scale: 1 }}
                                    exit={{ opacity: 0, scale: 0.95 }}
                                    className="bg-white dark:bg-darkpanel w-[600px] h-[500px] rounded-xl shadow-2xl flex flex-col overflow-hidden relative z-10 border border-slate-200 dark:border-zinc-700"
                                >
                                    <div className="px-5 py-3 border-b border-slate-100 dark:border-zinc-700 flex justify-between items-center bg-slate-50/50 dark:bg-zinc-800/50">
                                        <h2 className="text-sm font-black text-slate-800 dark:text-zinc-100 flex items-center gap-2">
                                            ğŸ“ ì‹œë†‰ì‹œìŠ¤
                                        </h2>
                                        <div className="flex items-center gap-2">
                                            <button 
                                                onClick={() => { setShowSynopsisModal(false); setCorkboardMode(true); }}
                                                className="px-3 py-1.5 bg-amber-50 text-amber-600 hover:bg-amber-100 dark:bg-amber-900/30 dark:text-amber-400 dark:hover:bg-amber-900/50 rounded text-xs font-bold transition-colors"
                                            >
                                                ì½”ë¥´í¬ ë³´ë“œë¡œ ê°€ê¸°
                                            </button>
                                            <button onClick={() => setShowSynopsisModal(false)} className="p-1.5 text-slate-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded transition-colors">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="flex-1 p-0 flex flex-col">
                                        <textarea 
                                            className="flex-1 w-full p-8 resize-none outline-none text-slate-600 dark:text-zinc-300 leading-loose custom-scroll bg-transparent text-base"
                                            placeholder="ì‹œë†‰ì‹œìŠ¤ë‚˜ ê°œìš”ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."
                                            value={activeProject.synopsis || ''}
                                            onChange={(e) => setProjects(prev => prev.map(p => p.id === activeProject.id ? { ...p, synopsis: e.target.value } : p))}
                                        />
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {mention.active && (
                            <div className="mention-list" style={{ top: mention.y, left: mention.x }}>
                                <div className="w-[250px] flex flex-col border-r border-slate-100 dark:border-zinc-700">
                                    <div className="p-2 bg-slate-50 dark:bg-zinc-800 text-[9px] font-black text-slate-400 tracking-widest uppercase border-b border-slate-100 dark:border-zinc-700">
                                        {mention.type === '@' ? 'ìºë¦­í„° ë¦¬ìŠ¤íŠ¸' : mention.type === '#' ? 'ì‚¬ê±´ ë¦¬ìŠ¤íŠ¸' : mention.type === '$' ? 'ë©”ëª¨ ë¦¬ìŠ¤íŠ¸' : 'TO-DO ë¦¬ìŠ¤íŠ¸'}
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scroll">
                                        {filteredMentionNodes.length > 0 ? filteredMentionNodes.map((node, i) => (
                                            <div key={node.id}
                                                onClick={() => insertMention(node)}
                                                onMouseEnter={() => setMention(prev => ({ ...prev, selectedIndex: i }))}
                                                className={`flex items-center px-3 h-[38px] cursor-pointer transition-colors border-l-4 ${mention.selectedIndex === i
                                                    ? 'mention-item-active'
                                                    : 'hover:bg-slate-50 dark:hover:bg-zinc-800 border-l-transparent'
                                                    }`}
                                            >
                                                {/* ì¢Œì¸¡: ì´ëª¨ì§€ ë° ì´ë¦„ (ë†’ì´ ê³ ì •ìœ¼ë¡œ ì¸í•´ ì„¸ë¡œ ì¤‘ì•™ ìë™ ì •ë ¬) */}
                                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                                    <span className="text-sm shrink-0 leading-none">{node.data.emoji}</span>
                                                    <div className="flex items-baseline gap-2 truncate">
                                                        <span className="font-black text-xs text-slate-800 dark:text-zinc-100 shrink-0">
                                                            {node.label}
                                                        </span>
                                                        <span className="text-[9px] text-slate-400 font-bold truncate opacity-80">
                                                            / {node.projectName}
                                                        </span>
                                                    </div>
                                                </div>

                                                {/* ìš°ì¸¡: ì¸ë¬¼ì¼ ê²½ìš° ë°°ì§€ í‘œì‹œ, ì‚¬ê±´ì¼ ê²½ìš° ë¹ˆ ê³µê°„ ìœ ì§€ (ë†’ì´ ë’¤í‹€ë¦¼ ë°©ì§€) */}
                                                <div className="shrink-0 ml-2 flex items-center h-full">
                                                    {node.type === 'ì¸ë¬¼' ? (
                                                        <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[2px] rounded-sm shadow-sm leading-none ${getRoleBadgeStyle(node.data.role)}`}>
                                                            {node.data.role}
                                                        </span>
                                                    ) : node.type === 'í• ì¼' && (node.data.items || []).length > 0 && (node.data.items || []).every(i => i.done) ? (
                                                        <span className="text-[8px] font-black px-1.5 py-0.5 rounded-[2px] bg-cyan-100 text-cyan-600 dark:bg-cyan-900/30 dark:text-cyan-400">
                                                            ì™„ë£Œ
                                                        </span>
                                                    ) : (
                                                        /* ì‚¬ê±´ì¼ ë•ŒëŠ” ë°°ì§€ê°€ ì—†ì–´ë„ ë†’ì´ë¥¼ ìœ ì§€í•˜ë„ë¡ ë¹ˆ ê³µê°„ í™•ë³´ */
                                                        <div className="w-1 h-4"></div>
                                                    )}
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="p-4 text-[10px] text-slate-400 italic text-center">ê²°ê³¼ ì—†ìŒ</div>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-1 flex flex-col bg-white dark:bg-[#1a1a1d] p-5 overflow-hidden rounded-r-[3px]">
                                    {filteredMentionNodes[mention.selectedIndex] ? (
                                        <>
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className="text-2xl">{filteredMentionNodes[mention.selectedIndex].data.emoji}</span>
                                                <div className="flex items-center gap-2">
                                                    <div className="font-black text-slate-800 dark:text-zinc-100">{filteredMentionNodes[mention.selectedIndex].label}</div>
                                                </div>
                                            </div>
                                            <div className="text-2xs text-slate-500 dark:text-zinc-400 leading-relaxed overflow-y-auto custom-scroll pr-2">
                                                {filteredMentionNodes[mention.selectedIndex].type === 'ì¸ë¬¼' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-indigo-500">
                                                        <span>ì„±ë³„: {filteredMentionNodes[mention.selectedIndex].data.gender}</span>
                                                        <span>ë‚˜ì´: {filteredMentionNodes[mention.selectedIndex].data.age || 'ë¯¸ì •'}</span>
                                                        <span>ì§ì—…: {filteredMentionNodes[mention.selectedIndex].data.job || 'ë¯¸ì •'}</span>
                                                        <span>ì¢…ì¡±: {filteredMentionNodes[mention.selectedIndex].data.race || 'ì¸ê°„'}</span>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].type === 'ì‚¬ê±´' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-rose-500">
                                                        <span>ì¥ì†Œ: {filteredMentionNodes[mention.selectedIndex].data.place || 'ë¯¸ì •'}</span>
                                                        <span>ì‹œê¸°: {filteredMentionNodes[mention.selectedIndex].data.year || 'ë¯¸ì •'}</span>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].type === 'ë©”ëª¨' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-amber-500">
                                                        <span>ğŸ“ {filteredMentionNodes[mention.selectedIndex].data.category || 'ë©”ëª¨'}</span>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].type === 'í• ì¼' && (
                                                    <div className="mb-2 pb-2">
                                                        <div className="text-[12px] font-bold uppercase text-cyan-500 mb-2">âœ… í• ì¼ ëª©ë¡</div>
                                                        <div className="space-y-1">
                                                            {(filteredMentionNodes[mention.selectedIndex].data.items || []).map(item => (
                                                                <div key={item.id} className="flex items-center gap-2">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={item.done}
                                                                        onChange={() => handleToggleTodoInMention(filteredMentionNodes[mention.selectedIndex].projectId, filteredMentionNodes[mention.selectedIndex].id, item.id)}
                                                                        className="w-3 h-3 rounded-sm border-slate-300 text-cyan-600 focus:ring-cyan-500 cursor-pointer"
                                                                    />
                                                                    <span className={`text-xs ${item.done ? 'text-slate-400 line-through' : 'text-slate-700 dark:text-zinc-300'}`}>
                                                                        {item.text}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                            {(filteredMentionNodes[mention.selectedIndex].data.items || []).length === 0 && (
                                                                <div className="text-xs text-slate-400 italic">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].data.memo || (filteredMentionNodes[mention.selectedIndex].type !== 'í• ì¼' ? "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤." : "")}
                                            </div>
                                        </>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center text-slate-300 dark:text-zinc-700 text-xs italic">ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {activeNode && (
                            <>
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="fixed inset-0 bg-black/20 z-[199]"
                                    onClick={() => { setSelectedNodeId(null); }}
                                />
                                <motion.div
                                    initial={{ x: '100%' }}
                                    animate={{ x: 0 }}
                                    exit={{ x: '100%' }}
                                    transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                                    className="fixed top-0 right-0 h-full w-[420px] bg-white dark:bg-darkpanel shadow-2xl z-[200] flex flex-col border-l border-slate-200 dark:border-zinc-700"
                                >
                                    {/* í—¤ë” */}
                                    <div className="h-16 px-6 flex items-center justify-between border-b border-slate-200 dark:border-zinc-700 shrink-0">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">{activeNode.data.emoji}</span>
                                            <div>
                                                <h2 className="text-sm font-black text-slate-800 dark:text-zinc-100">{activeNode.label}</h2>
                                                <span className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">{activeNode.type} í¸ì§‘</span>
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedNodeId(null)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 rounded-sm transition-colors">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12" /></svg>
                                        </button>
                                    </div>

                                    {/* ì»¨í…ì¸  */}
                                    <div className="flex-1 overflow-y-auto p-6 custom-scroll">
                                        <div className="space-y-5">
                                            {/* ì¸ë¬¼ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì¸ë¬¼' && (
                                                <>
                                                    {/* 1ì—´: ì´ëª¨ì§€ / ì´ë¦„ / ì£¼ì‚¬ìœ„ */}
                                                    <div className="flex gap-3">
                                                        <div className="w-14">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ëª¨ì§€</label>
                                                            <input className="w-full mt-1 px-2 py-2 bg-slate-50 rounded-[3px] text-center text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji || (activeNode.type === 'ê·¸ë£¹' ? 'ğŸ“' : '')} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, emoji: e.target.value } } : n))} />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ë¦„</label>
                                                            <div className="flex gap-1">
                                                                <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, label: e.target.value } : n))} />
                                                                <button
                                                                    onClick={() => setIsNameGenOpen(!isNameGenOpen)}
                                                                    className={`mt-1 w-[42px] h-[42px] flex items-center justify-center rounded-[3px] border transition-colors ${isNameGenOpen ? 'bg-indigo-100 border-indigo-300 text-indigo-600 dark:bg-indigo-900/50 dark:border-indigo-700 dark:text-indigo-400' : 'bg-slate-50 border-slate-200 text-slate-400 hover:text-indigo-500 hover:border-indigo-300 dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-500 dark:hover:text-zinc-300'}`}
                                                                    title="ì´ë¦„ ìƒì„±ê¸° ì—´ê¸°"
                                                                >
                                                                    ğŸ²
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* 2ì—´: ì—­í•  / ì„±ë³„ / ë‚˜ì´ */}
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì—­í• </label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.role} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, role: e.target.value } } : n))}>
                                                                <option value="ì£¼ì¸ê³µ">ğŸ˜ ì£¼ì¸ê³µ</option>
                                                                <option value="ì¡°ë ¥ì">ğŸ˜ ì¡°ë ¥ì</option>
                                                                <option value="ì ëŒ€ì">ğŸ˜¡ ì ëŒ€ì</option>
                                                                <option value="ì¡°ì—°">ğŸ¤“ ì¡°ì—°</option>
                                                                <option value="ì—‘ìŠ¤íŠ¸ë¼">ğŸ¥¸ ì—‘ìŠ¤íŠ¸ë¼</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì„±ë³„</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.gender} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, gender: e.target.value } } : n))}>
                                                                <option value="ë‚¨ì">ë‚¨ì</option>
                                                                <option value="ì—¬ì">ì—¬ì</option>
                                                                <option value="ì¤‘ì„±">ì¤‘ì„±</option>
                                                                <option value="ë¯¸ì§€ì •">ë¯¸ì§€ì •</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë‚˜ì´</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.age} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, age: e.target.value } } : n))} placeholder="ë‚˜ì´" />
                                                        </div>
                                                    </div>

                                                    {/* 3ì—´: ì§ì—… / ì¢…ì¡± */}
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì§ì—…</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.job} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, job: e.target.value } } : n))} placeholder="ì§ì—… ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì¢…ì¡±</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.race || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, race: e.target.value } } : n))} placeholder="ì¢…ì¡± ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ì‚¬ê±´/ë©”ëª¨: ì´ëª¨ì§€ + ì´ë¦„ */}
                                            {activeNode.type !== 'ì¸ë¬¼' && (
                                                <div className="flex gap-3">
                                                    <div className="w-20">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ëª¨ì§€</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] text-center text-xl border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji || (activeNode.type === 'ê·¸ë£¹' ? 'ğŸ“' : '')} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, emoji: e.target.value } } : n))} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ë¦„</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, label: e.target.value } : n))} />
                                                    </div>
                                                </div>
                                            )}

                                            {/* ë©”ëª¨ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ë©”ëª¨' && (
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë¶„ë¥˜</label>
                                                    <div className="flex flex-wrap gap-1.5 mt-1">
                                                        {['ë©”ëª¨', 'ì¥ì†Œ', 'ì•„ì´í…œ', 'ì„¸ë ¥', 'ë³µì„ ', 'íƒ€ì„ë¼ì¸', 'ì„¤ì •', 'ëŒ€ì‚¬', 'ê°ˆë“±'].map(cat => (
                                                            <button key={cat} onClick={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, category: cat } } : n))} className={`px-3 py-1.5 rounded-[3px] text-xs font-bold transition-all ${(activeNode.data.category || 'ë©”ëª¨') === cat ? 'bg-amber-500 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200 dark:bg-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-600'}`}>{cat}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* ì‚¬ê±´ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì‚¬ê±´' && (
                                                <div className="flex gap-3">
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë°œìƒ ì¥ì†Œ</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.place || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, place: e.target.value } } : n))} placeholder="ì¥ì†Œ ì…ë ¥" />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë°œìƒ ì‹œê¸°</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.year || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, year: e.target.value } } : n))} placeholder="ì‹œê¸°/ì—°ë„ ì…ë ¥" />
                                                    </div>
                                                </div>
                                            )}

                                            {/* ì¥ì†Œ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì¥ì†Œ' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì§€ì—­/ìœ„ì¹˜</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.region || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, region: e.target.value } } : n))} placeholder="ì§€ì—­ ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ê¸°í›„/í™˜ê²½</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.climate || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, climate: e.target.value } } : n))} placeholder="ê¸°í›„/í™˜ê²½ ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì¥ì†Œ ì„¤ëª…</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.description || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, description: e.target.value } } : n))} placeholder="ì¥ì†Œì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…" />
                                                    </div>
                                                </>
                                            )}

                                            {/* ì•„ì´í…œ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì•„ì´í…œ' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë¶„ë¥˜</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.category || 'ì¼ë°˜'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, category: e.target.value } } : n))}>
                                                                <option value="ì¼ë°˜">ì¼ë°˜</option>
                                                                <option value="ë¬´ê¸°">ë¬´ê¸°</option>
                                                                <option value="ë°©ì–´êµ¬">ë°©ì–´êµ¬</option>
                                                                <option value="ì¥ì‹ êµ¬">ì¥ì‹ êµ¬</option>
                                                                <option value="ì†Œëª¨í’ˆ">ì†Œëª¨í’ˆ</option>
                                                                <option value="ì¬ë£Œ">ì¬ë£Œ</option>
                                                                <option value="ì—´ì‡ /ë„êµ¬">ì—´ì‡ /ë„êµ¬</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">í¬ê·€ë„</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.rarity || 'ë³´í†µ'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, rarity: e.target.value } } : n))}>
                                                                <option value="ë³´í†µ">ë³´í†µ</option>
                                                                <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                                                                <option value="í¬ê·€">í¬ê·€</option>
                                                                <option value="ì˜ì›…">ì˜ì›…</option>
                                                                <option value="ì „ì„¤">ì „ì„¤</option>
                                                                <option value="ìœ ì¼">ìœ ì¼</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì†Œìœ ì</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.owner || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, owner: e.target.value } } : n))} placeholder="ì†Œìœ ì ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">íš¨ê³¼/ëŠ¥ë ¥</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.effect || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, effect: e.target.value } } : n))} placeholder="íš¨ê³¼/ëŠ¥ë ¥ ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ì„¸ë ¥ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì„¸ë ¥' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë¦¬ë”/ìˆ˜ì¥</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.leader || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, leader: e.target.value } } : n))} placeholder="ë¦¬ë” ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì˜ì—­/ë³¸ê±°ì§€</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.territory || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, territory: e.target.value } } : n))} placeholder="ì˜ì—­ ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì£¼ìš” êµ¬ì„±ì›</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.members || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, members: e.target.value } } : n))} placeholder="ì£¼ìš” êµ¬ì„±ì› ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ëª©í‘œ/ì´ë…</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.goal || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, goal: e.target.value } } : n))} placeholder="ëª©í‘œ/ì´ë… ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ë³µì„  ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ë³µì„ ' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë“±ì¥ ì¥/íšŒì°¨</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.chapter || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, chapter: e.target.value } } : n))} placeholder="ì¥/íšŒì°¨ ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ìƒíƒœ</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.status || 'ë¯¸íšŒìˆ˜'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, status: e.target.value } } : n))}>
                                                                <option value="ë¯¸íšŒìˆ˜">ğŸ”„ ë¯¸íšŒìˆ˜</option>
                                                                <option value="ì§„í–‰ì¤‘">ğŸ”¥ ì§„í–‰ì¤‘</option>
                                                                <option value="íšŒìˆ˜ë¨">âœ… íšŒìˆ˜ë¨</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">íŒíŠ¸/ë³µì„  ë‚´ìš©</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.hint || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, hint: e.target.value } } : n))} placeholder="ë³µì„  ë‚´ìš© ì…ë ¥" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">íšŒìˆ˜ ê³„íš</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.reveal || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, reveal: e.target.value } } : n))} placeholder="íšŒìˆ˜ ê³„íš ì…ë ¥" />
                                                    </div>
                                                </>
                                            )}

                                            {/* íƒ€ì„ë¼ì¸ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'íƒ€ì„ë¼ì¸' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë‚ ì§œ/ì‹œì </label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.date || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, date: e.target.value } } : n))} placeholder="ë‚ ì§œ/ì‹œì  ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì‹œëŒ€/ë°°ê²½</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.era || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, era: e.target.value } } : n))} placeholder="ì‹œëŒ€/ë°°ê²½ ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì¤‘ìš”ë„</label>
                                                        <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.importance || 'ë³´í†µ'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, importance: e.target.value } } : n))}>
                                                            <option value="ë‚®ìŒ">ë‚®ìŒ</option>
                                                            <option value="ë³´í†µ">ë³´í†µ</option>
                                                            <option value="ì¤‘ìš”">ì¤‘ìš”</option>
                                                            <option value="í•µì‹¬">í•µì‹¬</option>
                                                        </select>
                                                    </div>
                                                </>
                                            )}

                                            {/* ì„¤ì • ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ì„¤ì •' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë¶„ë¥˜</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.category || 'ì„¸ê³„ê´€'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, category: e.target.value } } : n))}>
                                                                <option value="ì„¸ê³„ê´€">ì„¸ê³„ê´€</option>
                                                                <option value="ë§ˆë²•ì²´ê³„">ë§ˆë²•ì²´ê³„</option>
                                                                <option value="ì¢…ì¡±">ì¢…ì¡±</option>
                                                                <option value="ì—­ì‚¬">ì—­ì‚¬</option>
                                                                <option value="ë¬¸í™”">ë¬¸í™”</option>
                                                                <option value="ê·œì¹™">ê·œì¹™</option>
                                                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì ìš© ë²”ìœ„</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.scope || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, scope: e.target.value } } : n))} placeholder="ì ìš© ë²”ìœ„ ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ëŒ€ì‚¬ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ëŒ€ì‚¬' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">í™”ì</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.speaker || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, speaker: e.target.value } } : n))} placeholder="í™”ì ì…ë ¥" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ê°ì •/í†¤</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emotion || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, emotion: e.target.value } } : n))} placeholder="ê°ì •/í†¤ ì…ë ¥" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ìƒí™©/ë§¥ë½</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.situation || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, situation: e.target.value } } : n))} placeholder="ìƒí™©/ë§¥ë½ ì…ë ¥" />
                                                    </div>
                                                </>
                                            )}

                                            {/* ê°ˆë“± ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ê°ˆë“±' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ê°ˆë“± ë‹¹ì‚¬ì</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.parties || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, parties: e.target.value } } : n))} placeholder="ë‹¹ì‚¬ì ì…ë ¥ (ì˜ˆ: A vs B)" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ìƒíƒœ</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.status || 'ì§„í–‰ì¤‘'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, status: e.target.value } } : n))}>
                                                                <option value="ì ì¬ì ">ğŸ”µ ì ì¬ì </option>
                                                                <option value="ì§„í–‰ì¤‘">ğŸ”¥ ì§„í–‰ì¤‘</option>
                                                                <option value="ê²©í™”">ğŸ’¥ ê²©í™”</option>
                                                                <option value="í•´ê²°ë¨">âœ… í•´ê²°ë¨</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ê°ˆë“± ì›ì¸</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.cause || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, cause: e.target.value } } : n))} placeholder="ê°ˆë“± ì›ì¸ ì…ë ¥" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">í•´ê²° ë°©ì•ˆ</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.resolution || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, resolution: e.target.value } } : n))} placeholder="í•´ê²° ë°©ì•ˆ ì…ë ¥" />
                                                    </div>
                                                </>
                                            )}

                                            {/* ê·¸ë£¹ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'ê·¸ë£¹' && (
                                                <>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë©”ëª¨</label>
                                                        <input type="text" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.memo || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, memo: e.target.value } } : n))} placeholder="ê·¸ë£¹ ë©”ëª¨..." />
                                                    </div>
                                                    <div className="flex gap-4">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë„ˆë¹„</label>
                                                            <input type="number" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.width || 400} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, width: Math.max(200, parseInt(e.target.value) || 200) } } : n))} min="200" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë†’ì´</label>
                                                            <input type="number" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.height || 300} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, height: Math.max(150, parseInt(e.target.value) || 150) } } : n))} min="150" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ê·¸ë£¹ ìƒ‰ìƒ</label>
                                                        <div className="flex gap-2 mt-2 flex-wrap">
                                                            {['#94a3b8', '#6366f1', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899'].map(color => (
                                                                <button key={color} onClick={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, color } } : n))} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${activeNode.data.color === color ? 'border-slate-800 dark:border-white scale-110' : 'border-transparent'}`} style={{ backgroundColor: color }} />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">í¬í•¨ëœ ë…¸ë“œ ({(activeNode.data.childNodes || []).length}ê°œ)</label>
                                                        <div className="mt-2 max-h-70 overflow-y-auto bg-slate-50 border border-slate-200 rounded-[3px] dark:bg-zinc-800 dark:border-zinc-700">
                                                            {(activeNode.data.childNodes || []).length === 0 ? (
                                                                <div className="p-4 text-center text-slate-400 text-xs">í¬í•¨ëœ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                                            ) : (
                                                                <div className="divide-y divide-slate-200 dark:divide-zinc-700">
                                                                    {(activeNode.data.childNodes || []).map(childId => {
                                                                        const childNode = nodes.find(n => n.id === childId);
                                                                        if (!childNode) return null;
                                                                        return (
                                                                            <div key={childId} className="flex items-center gap-2 px-3 py-2 hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors">
                                                                                <span className="text-lg">{childNode.data.emoji || 'ğŸ“„'}</span>
                                                                                <span className="flex-1 text-sm font-medium text-slate-700 dark:text-zinc-300 truncate">{childNode.label}</span>
                                                                                <span className="text-[10px] px-2 py-0.5 bg-slate-200 dark:bg-zinc-600 rounded text-slate-500 dark:text-zinc-400">{childNode.type}</span>
                                                                                <button
                                                                                    onClick={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, childNodes: (n.data.childNodes || []).filter(id => id !== childId) } } : n))}
                                                                                    className="p-1 text-slate-400 hover:text-red-500 transition-colors"
                                                                                    title="ê·¸ë£¹ì—ì„œ ì œê±°"
                                                                                >
                                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12" /></svg>
                                                                                </button>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* í• ì¼ ì „ìš© í•„ë“œ */}
                                            {activeNode.type === 'í• ì¼' && (
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">í•  ì¼ ëª©ë¡</label>
                                                    <div className="flex gap-2 mt-1">
                                                        <input 
                                                            type="text" 
                                                            placeholder="+ í•  ì¼ ì¶”ê°€" 
                                                            className="flex-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all rounded-[3px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200"
                                                            value={todoInput}
                                                            onChange={(e) => setTodoInput(e.target.value)}
                                                            onKeyDown={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    if (e.nativeEvent.isComposing) return;
                                                                    e.preventDefault();
                                                                    if (todoInput.trim()) {
                                                                        const newItem = { id: generateUUID(), text: todoInput.trim(), done: false };
                                                                        updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, items: [...(n.data.items || []), newItem] } } : n));
                                                                        setTodoInput('');
                                                                    }
                                                                }
                                                            }}
                                                        />
                                                        <button 
                                                            onClick={() => {
                                                                if (todoInput.trim()) {
                                                                    const newItem = { id: generateUUID(), text: todoInput.trim(), done: false };
                                                                    updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, items: [...(n.data.items || []), newItem] } } : n));
                                                                    setTodoInput('');
                                                                }
                                                            }}
                                                            className="px-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-[3px] transition-colors"
                                                        >
                                                            ì¶”ê°€
                                                        </button>
                                                    </div>
                                                    <div className="mt-2 space-y-1">
                                                        {(activeNode.data.items || []).map(item => (
                                                            <div key={item.id} className="flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-[3px] border border-slate-100 dark:bg-zinc-800/50 dark:border-zinc-700 group">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={item.done} 
                                                                    onChange={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, items: n.data.items.map(i => i.id === item.id ? { ...i, done: !i.done } : i) } } : n))}
                                                                    className="w-4 h-4 rounded-sm border-slate-300 text-cyan-600 focus:ring-cyan-500 cursor-pointer"
                                                                />
                                                                <span className={`text-sm flex-1 truncate ${item.done ? 'line-through text-slate-400 dark:text-zinc-500' : 'text-slate-700 dark:text-zinc-200'}`}>{item.text}</span>
                                                                <button 
                                                                    onClick={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, items: n.data.items.filter(i => i.id !== item.id) } } : n))}
                                                                    className="text-slate-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
                                                                >
                                                                    <IconTrash className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        ))}
                                                        {(activeNode.data.items || []).length === 0 && (
                                                            <div className="text-xs text-slate-400 text-center py-4 italic">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}

                                            {/* ë©”ëª¨ (í• ì¼, ê·¸ë£¹ ì œì™¸) */}
                                            {activeNode.type !== 'ê·¸ë£¹' && activeNode.type !== 'í• ì¼' && (
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë©”ëª¨ ë° ì„¸ë¶€ ì„¤ì •</label>
                                                    <textarea className="w-full mt-1 h-56 p-4 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all resize-none leading-relaxed dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700" value={activeNode.data.memo} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, data: { ...n.data, memo: e.target.value } } : n))} placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                                                    <AnimatePresence>
                                                        {activeNode.type === 'ì¸ë¬¼' && isNameGenOpen && (
                                                            <NameGenerator
                                                                onClose={() => setIsNameGenOpen(false)}
                                                                onConfirm={(name) => {
                                                                    updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? { ...n, label: name } : n));
                                                                }}
                                                                settings={nameGenSettings}
                                                                onSettingsChange={setNameGenSettings}
                                                            />
                                                        )}
                                                    </AnimatePresence>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="p-6 border-t border-slate-200 dark:border-zinc-700 shrink-0">
                                        <button onClick={() => { saveHistory(); setSelectedNodeId(null); showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"); }} className="w-full py-4 bg-slate-900 text-white font-black hover:bg-indigo-600 transition-all uppercase text-xs tracking-widest rounded-[3px] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500">
                                            ì €ì¥ í›„ ë‹«ê¸°
                                        </button>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {activeEdge && (
                            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-8 rounded-[3px] shadow-2xl w-[420px] relative dark:bg-darkpanel border border-slate-200 dark:border-darkborder">
                                    <button onClick={() => setSelectedEdgeId(null)} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-700 dark:hover:text-zinc-200 transition-colors">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12" /></svg>
                                    </button>
                                    <h2 className="text-sm font-black text-indigo-500 uppercase tracking-widest mb-8 flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> ê´€ê³„ì„  ì„¤ì •
                                    </h2>
                                    <div className="space-y-8">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ë©”ëª¨</label>
                                            <input
                                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-[3px] font-bold text-sm outline-none focus:border-indigo-500 focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700/50"
                                                value={activeEdge.label}
                                                onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? { ...ev, label: e.target.value } : ev))}
                                            />
                                        </div>
                                        <div className="flex gap-6">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ì„  ì¢…ë¥˜</label>
                                                <select
                                                    className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-[3px] font-bold text-xs outline-none cursor-pointer hover:bg-slate-100 transition-colors dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                                                    value={activeEdge.style || 'solid'}
                                                    onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? { ...ev, style: e.target.value } : ev))}
                                                >
                                                    <option value="solid">â”€ ì‹¤ì„  (Solid)</option>
                                                    <option value="dotted">Â·Â·Â· ì ì„  (Dotted)</option>
                                                    <option value="dashed">--- íŒŒì„  (Dashed)</option>
                                                    <option value="double">â•â• ì´ì¤‘ì„  (Double)</option>
                                                </select>
                                            </div>
                                            <div className="flex-[1.2]">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ì„  êµµê¸°</label>
                                                <div className="flex items-center h-[42px] bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] p-1">
                                                    {[2, 4, 6].map(w => (
                                                        <button
                                                            key={w}
                                                            onClick={() => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? { ...ev, width: w } : ev))}
                                                            className={`flex-1 h-full flex flex-col items-center justify-center rounded-[2px] transition-all ${(activeEdge.width || 2) === w ? 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-700 dark:text-indigo-400' : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300'}`}
                                                        >
                                                            <div className="bg-current rounded-full mb-1" style={{ width: w * 2, height: 2 }}></div>
                                                            <span className="text-[9px] font-black">{w}px</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => { saveHistory(); setSelectedEdgeId(null); }}
                                        className="w-full mt-10 py-4 bg-slate-900 text-white font-black rounded-[3px] hover:bg-indigo-600 transition-all uppercase text-[11px] tracking-[0.2em] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500"
                                    >
                                        ì €ì¥ í›„ ë‹«ê¸°
                                    </button>
                                </motion.div>
                            </div>
                        )}
                    </AnimatePresence>

                </div >
            );
        };

        const SystemSettingsModal = ({ onClose, isDarkMode, toggleDarkMode, fontMode, toggleFont, activeProject, onUpdateProject, focusPosition, setFocusPosition, defaultTargetCount, setDefaultTargetCount, editorWidth, setEditorWidth, editorFontSize, setEditorFontSize, showDocWordCount, setShowDocWordCount, enableHistory, setEnableHistory }) => {
            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-center justify-between mb-8">
                            <h2 className="text-xl font-black text-slate-800 dark:text-zinc-100 flex items-center gap-2">
                                <IconSettings className="w-5 h-5 text-indigo-500" />
                                ì‹œìŠ¤í…œ ì„¤ì •
                            </h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-200 transition-colors">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12" /></svg>
                            </button>
                        </div>

                        <div className="space-y-10">
                            {/* ì™¸ê´€ ì„¤ì • ì„¹ì…˜ */}
                            <section>
                                <div className="grid grid-cols-[1fr_auto_1fr] gap-6 items-center">
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm font-black text-slate-700 dark:text-zinc-200">í…Œë§ˆ</div>
                                        <button
                                            onClick={toggleDarkMode}
                                            className={`w-24 flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-sm font-black text-[10px] transition-all ${isDarkMode ? 'bg-zinc-800 text-zinc-300 border border-zinc-700' : 'bg-white text-slate-600 border border-slate-200 shadow-sm'}`}
                                        >
                                            {isDarkMode ? <><IconMoon className="w-3 h-3" /> ë‹¤í¬</> : <><IconSun className="w-3 h-3" /> ë¼ì´íŠ¸</>}
                                        </button>
                                    </div>
                                    <div className="w-px h-4 bg-slate-200 dark:bg-zinc-700"></div>
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm font-black text-slate-700 dark:text-zinc-200">í°íŠ¸</div>
                                        <button
                                            onClick={toggleFont}
                                            className="w-24 flex items-center justify-center gap-1.5 px-3 py-1.5 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-sm font-black text-[10px] hover:bg-indigo-100 transition-all dark:bg-indigo-900/30 dark:text-indigo-400 dark:border-indigo-800"
                                        >
                                            <IconFont className="w-3 h-3" />
                                            {FONT_DISPLAY_NAMES[fontMode] || fontMode}
                                        </button>
                                    </div>
                                </div>
                            </section>

                            {/* í¸ì§‘ê¸° ì„¤ì • ì„¹ì…˜ */}
                            <section>
                                <div className="flex items-center justify-between mb-5 border-b border-slate-100 dark:border-zinc-800 pb-2">
                                    <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Editor Settings</h3>
                                    <button
                                        onClick={() => {
                                            setEditorWidth('default');
                                            setEditorFontSize(18);
                                            setDefaultTargetCount(5000);
                                            setFocusPosition(0.5);
                                            setShowDocWordCount(false);
                                            setEnableHistory(false);
                                        }}
                                        className="text-slate-400 hover:text-indigo-500 transition-colors"
                                        title="ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”"
                                    >
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>
                                    </button>
                                </div>
                                <div className="space-y-7">
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm font-black text-slate-700 dark:text-zinc-200">ì—ë””í„° ë„ˆë¹„</div>
                                        <div className="flex gap-1.5">
                                            {[
                                                { value: 'narrow', label: 'ì¢ìŒ' },
                                                { value: 'default', label: 'ê¸°ë³¸' },
                                                { value: 'wide', label: 'ë„“ìŒ' }
                                            ].map(opt => (
                                                <button
                                                    key={opt.value}
                                                    onClick={() => setEditorWidth(opt.value)}
                                                    className={`px-3 py-1.5 rounded-sm text-[11px] font-black transition-all ${editorWidth === opt.value ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200 dark:bg-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-600'}`}
                                                >
                                                    {opt.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-[1fr_auto_1fr] gap-6 items-center">
                                        <div className="flex items-center justify-between">
                                            <div className="text-sm font-black text-slate-700 dark:text-zinc-200">ê¸€ì í¬ê¸°</div>
                                            <div className="flex items-center gap-1">
                                                <input
                                                    type="number"
                                                    className="w-12 px-1 py-1 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-sm font-black text-[10px] text-right outline-none focus:border-indigo-500 text-slate-800 dark:text-white [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                                    value={editorFontSize}
                                                    onChange={(e) => setEditorFontSize(parseInt(e.target.value) || 18)}
                                                />
                                                <span className="text-[9px] font-black text-slate-400">PX</span>
                                            </div>
                                        </div>
                                        <div className="w-px h-4 bg-slate-200 dark:bg-zinc-700"></div>
                                        <div className="flex items-center justify-between">
                                            <div className="text-sm font-black text-slate-700 dark:text-zinc-200">ëª©í‘œ ììˆ˜</div>
                                            <div className="flex items-center gap-1">
                                                <input
                                                    type="number"
                                                    className="w-16 px-1 py-1 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-sm font-black text-[10px] text-right outline-none focus:border-indigo-500 text-slate-800 dark:text-white [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                                    value={defaultTargetCount || 5000}
                                                    onChange={(e) => setDefaultTargetCount(parseInt(e.target.value) || 0)}
                                                />
                                                <span className="text-[9px] font-black text-slate-400">ì</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-[1fr_auto_1fr] gap-6 items-center">
                                        <div className="flex items-center justify-between">
                                            <div className="text-sm font-black text-slate-700 dark:text-zinc-200">ë¦¬ìŠ¤íŠ¸ ê¸€ììˆ˜ í‘œì‹œ</div>
                                            <button
                                                onClick={() => setShowDocWordCount(!showDocWordCount)}
                                                className={`w-10 h-5 rounded-full transition-all relative shrink-0 ${showDocWordCount ? 'bg-indigo-600' : 'bg-slate-300 dark:bg-zinc-600'}`}
                                            >
                                                <div className={`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform ${showDocWordCount ? 'left-5' : 'left-0.5'}`} />
                                            </button>
                                        </div>
                                        <div className="w-px h-4 bg-slate-200 dark:bg-zinc-700"></div>
                                        <div className="flex items-center justify-between">
                                            <div className="text-sm font-black text-slate-700 dark:text-zinc-200">íˆìŠ¤í† ë¦¬ ê¸°ëŠ¥</div>
                                            <button
                                                onClick={() => setEnableHistory(!enableHistory)}
                                                className={`w-10 h-5 rounded-full transition-all relative shrink-0 ${enableHistory ? 'bg-indigo-600' : 'bg-slate-300 dark:bg-zinc-600'}`}
                                            >
                                                <div className={`absolute top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform ${enableHistory ? 'left-5' : 'left-0.5'}`} />
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="flex justify-between items-end">
                                            <div>
                                                <div className="text-sm font-black text-slate-700 dark:text-zinc-200">ì§‘ì¤‘ ëª¨ë“œ í¬ì»¤ìŠ¤ ë†’ì´</div>
                                            </div>
                                            <span className="text-xs font-black text-indigo-600 dark:text-indigo-400">{Math.round(focusPosition * 100)}%</span>
                                        </div>
                                        <input
                                            type="range"
                                            min="0.1"
                                            max="0.9"
                                            step="0.05"
                                            value={focusPosition}
                                            onChange={(e) => setFocusPosition(parseFloat(e.target.value))}
                                            className="w-full h-1.5 bg-slate-100 dark:bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                        />
                                        <div className="flex justify-between text-[9px] font-bold text-slate-400 uppercase tracking-tighter">
                                            <span>ìƒë‹¨</span>
                                            <span>ì¤‘ì•™ (50%)</span>
                                            <span>í•˜ë‹¨</span>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <div className="mt-10 pt-6 border-t border-slate-100 dark:border-zinc-800">
                            <button
                                onClick={onClose}
                                className="w-full py-3 bg-slate-900 hover:bg-indigo-600 text-white text-xs font-black rounded-sm shadow-md transition-all uppercase tracking-[0.2em] dark:bg-indigo-600 dark:hover:bg-indigo-500"
                            >
                                ì €ì¥ ë° ë‹«ê¸°
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        const Library = ({ books, onSelectBook, onCreateBook, onDeleteBook, onUpdateBook, onImport, onReorderBooks, isDarkMode, toggleDarkMode, fontMode, toggleFont, focusPosition, setFocusPosition, defaultTargetCount, setDefaultTargetCount, editorWidth, setEditorWidth, editorFontSize, setEditorFontSize, showDocWordCount, setShowDocWordCount, enableHistory, setEnableHistory }) => {
            const [modalConfig, setModalConfig] = useState({ isOpen: false, mode: 'create', targetBook: null });
            const [showSystemSettings, setShowSystemSettings] = useState(false);
            
            const quote = useMemo(() => {
                const quotes = [
                    { "author": "ì–´ë‹ˆìŠ¤íŠ¸ í—¤ë°ì›¨ì´", "quote": "ëª¨ë“  ì´ˆê³ ëŠ” ì“°ë ˆê¸°ë‹¤." },
                    { "author": "ì•ˆí†¤ ì²´í˜¸í”„", "quote": "ë‹¬ì´ ë¹›ë‚œë‹¤ê³  ë§í•˜ì§€ ë§ê³ , ê¹¨ì§„ ìœ ë¦¬ ì¡°ê°ì— ë¹„ì¹˜ëŠ” ë¹›ì„ ë³´ì—¬ì¤˜ë¼." },
                    { "author": "í”„ë€ì¸  ì¹´í”„ì¹´", "quote": "ì±…ì€ ìš°ë¦¬ ë‚´ë©´ì˜ ì–¼ì–´ë¶™ì€ ë°”ë‹¤ë¥¼ ê¹¨ëŠ” ë„ë¼ì—¬ì•¼ í•œë‹¤." },
                    { "author": "ì¡°ë”” í”¼ì½œíŠ¸", "quote": "ë‚˜ìœ ê¸€ì€ ê³ ì¹  ìˆ˜ ìˆì§€ë§Œ, ë¹ˆ í˜ì´ì§€ëŠ” ê³ ì¹  ìˆ˜ ì—†ë‹¤." },
                    { "author": "í† ë‹ˆ ëª¨ë¦¬ìŠ¨", "quote": "ì½ê³  ì‹¶ì€ ì±…ì´ ìˆëŠ”ë° ì•„ì§ ì“°ì´ì§€ ì•Šì•˜ë‹¤ë©´, ë‹¹ì‹ ì´ ì§ì ‘ ì¨ì•¼ í•œë‹¤." },
                    { "author": "ì»¤íŠ¸ ë³´ë‹ˆê²ƒ", "quote": "ë‚¯ì„  ì‚¬ëŒì˜ ì‹œê°„ì„ ë‚­ë¹„í•˜ì§€ ì•Šë„ë¡ ê¸€ì„ ì¨ë¼." },
                    { "author": "ì•¤ ë¼ëª¨íŠ¸", "quote": "ì¸ìƒì´ ê°ˆì§€ìë¡œ ë¹„í‹€ê±°ë¦¬ê±°ë‚˜ ë§ˆêµ¬ ì§“ë°Ÿí ë•Œ ì¡°ì°¨ ê·¸ ëª¨ë“  ìƒí™©ì´ ê´€ì°°ì˜ ëŒ€ìƒì´ ëœë‹¤." },
                    { "author": "í”Œë˜ë„ˆë¦¬ ì˜¤ì½”ë„ˆ", "quote": "ì‘ê°€ëŠ” ê´€ì°°í•˜ëŠ” ì‚¬ëŒì´ë‹¤. ëˆˆì•ì˜ ì„¸ìƒì„ ì •ì§í•˜ê²Œ ì‘ì‹œí•˜ëŠ” ë²•ë¶€í„° ë°°ì›Œë¼." },
                    { "author": "ë¬´ë¼ì¹´ë¯¸ í•˜ë£¨í‚¤", "quote": "ê¸€ì“°ê¸°ëŠ” ìê¸° ìì‹ ì„ í–¥í•œ ì •ì§í•œ ë…¸ë™ì´ë‹¤." },
                    { "author": "ì­ í•˜íŠ¸", "quote": "ìœ„ëŒ€í•œ ë¬¸ì¥ì˜ ì‹ í™”ëŠ” ì—†ë‹¤. ê¸€ì“°ê¸°ëŠ” ë§ˆìˆ ì´ ì•„ë‹ˆë¼ ê¸°ìˆ ì´ë‹¤." },
                    { "author": "ì• ê±°ì‚¬ í¬ë¦¬ìŠ¤í‹°", "quote": "ì„¤ê±°ì§€ë¥¼ í•˜ë‹¤ê°€ ìµœê³ ì˜ ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥¸ë‹¤." },
                    { "author": "ë„í”„ ì™ˆë„ ì—ë¨¸ìŠ¨", "quote": "ìì‹ ì˜ ìƒê°ì„ ë¯¿ëŠ” ê²ƒ, ê·¸ê²ƒì´ ì²œì¬ì„±ì´ë‹¤." },
                    { "author": "E.B. í™”ì´íŠ¸", "quote": "ê¸€ì„ ì“°ëŠ” ê²ƒì€ ë¯¿ìŒì˜ í–‰ìœ„ì´ì§€, ìš”ë ¹ì˜ í–‰ìœ„ê°€ ì•„ë‹ˆë‹¤." },
                    { "author": "ì¥ í´ ì‚¬ë¥´íŠ¸ë¥´", "quote": "ê¸€ì“°ê¸°ëŠ” ì„¸ê³„ì— ì§ˆë¬¸ì„ ë˜ì§€ëŠ” ë°©ì‹ì´ë‹¤." },
                    { "author": "ë¸”ë¼ë””ë¯¸ë¥´ ë‚˜ë³´ì½”í”„", "quote": "ìµœê³ ì˜ ì‘ê°€ëŠ” ë§ˆë²•ì‚¬ë‹¤." },
                    { "author": "í‘œë„ë¥´ ë„ìŠ¤í† ì˜™ìŠ¤í‚¤", "quote": "ì‘ê°€ëŠ” ì˜í˜¼ì˜ í•´ë¶€í•™ìë‹¤." },
                    { "author": "ìŠ¤í‹°ë¸ í‚¹", "quote": "ë§ì´ ì½ê³ , ë§ì´ ì¨ë¼. ì§€ë¦„ê¸¸ì€ ì—†ë‹¤." },
                    { "author": "ë¯¸ì•¼ìí‚¤ í•˜ì•¼ì˜¤", "quote": "íŒíƒ€ì§€ì—ëŠ” ë¦¬ì–¼ë¦¬í‹°ê°€ í•„ìš”í•˜ê³ , ë¦¬ì–¼ë¦¬í‹°ì—ëŠ” íŒíƒ€ì§€ê°€ í•„ìš”í•˜ë‹¤." },
                    { "author": "ìŠ¤í‹°ë¸ í‚¹", "quote": "ì—¬ëŸ¬ë¶„ì´ í•´ì•¼ í•  ì¼ì€ ë‚ ë§ˆë‹¤ ì‘ì—…ì„ í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ë®¤ì¦ˆì—ê²Œ ì•Œë ¤ì£¼ëŠ” ê²ƒì´ë‹¤." },
                    { "author": "ì•¨ëŸ° ë¬´ì–´", "quote": "ì˜ˆìˆ ì€ ì‚¬ëŒë“¤ì˜ ì¸ì‹ì„ ë°”ê¾¸ëŠ” ìœ ì¼í•œ ë„êµ¬ë‹¤." },
                    { "author": "ì›”íŠ¸ íœ˜íŠ¸ë¨¼", "quote": "ë‹¨ìˆœí•¨ì€ ëª¨ë“  ì˜ˆìˆ ì˜ ë§ˆì§€ë§‰ ë‹¨ê³„ë‹¤." },
                    { "author": "ì œì„ìŠ¤ ë””í‚¤", "quote": "ê¸€ì„ ì“°ëŠ” ê²ƒì€ ì–´ë‘  ì†ì—ì„œ ë¹›ì„ ì°¾ëŠ” ê³¼ì •ì´ë‹¤." },
                    { "author": "ì¡°ì•ˆ ë””ë””ì˜¨", "quote": "ë‚´ê°€ ë¬´ìŠ¨ ìƒê°ì„ í•˜ëŠ”ì§€ ì•Œê¸° ìœ„í•´ ë‚˜ëŠ” ê¸€ì„ ì“´ë‹¤." },
                    { "author": "ì‘ì ë¯¸ìƒ", "quote": "ì‘í’ˆì€ ì„¸ê³„ì— ëŒ€í•œ ì‘ê°€ì˜ ë…¼ë¬¸ì´ë‹¤." },
                    { "author": "ì•¤ ë¼ëª¨íŠ¸", "quote": "ì™„ë²½ì£¼ì˜ëŠ” ë‹¹ì‹ ì˜ ê¸€ì“°ê¸°ë¥¼ ë§ì¹˜ê³ , ì°½ì¡°ì„±ê³¼ ì¥ë‚œê¸°ì™€ ìƒëª…ë ¥ì„ ë°©í•´í•œë‹¤." },
                    { "author": "ì•¤ ë¼ëª¨íŠ¸", "quote": "ì¢‹ì€ ê¸€ì“°ê¸°ëŠ” ì§„ì‹¤ì„ ë§í•˜ëŠ” ê²ƒì´ë‹¤." }
                ];
                return quotes[Math.floor(Math.random() * quotes.length)];
            }, []);

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìƒíƒœ
            const [dragState, setDragState] = useState({ draggingId: null, overId: null });
            const dragDataRef = useRef({ draggingId: null, overId: null });

            const handleDragStart = (e, bookId) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', bookId);
                dragDataRef.current = { draggingId: bookId, overId: null };
                setTimeout(() => {
                    setDragState({ draggingId: bookId, overId: null });
                }, 0);
            };

            const handleDragOver = (e, overId) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (dragDataRef.current.draggingId && dragDataRef.current.draggingId !== overId) {
                    if (dragDataRef.current.overId !== overId) {
                        dragDataRef.current.overId = overId;
                        setDragState(prev => ({ ...prev, overId }));
                    }
                }
            };

            const handleDrop = (e, dropId) => {
                e.preventDefault();
                const dragId = e.dataTransfer.getData('text/plain') || dragDataRef.current.draggingId;

                if (dragId && dropId && dragId !== dropId) {
                    const dragIndex = books.findIndex(b => b.id === dragId);
                    const dropIndex = books.findIndex(b => b.id === dropId);

                    if (dragIndex !== -1 && dropIndex !== -1) {
                        const newBooks = [...books];
                        const [removed] = newBooks.splice(dragIndex, 1);
                        newBooks.splice(dropIndex, 0, removed);
                        onReorderBooks(newBooks);
                    }
                }
                dragDataRef.current = { draggingId: null, overId: null };
                setDragState({ draggingId: null, overId: null });
            };

            const handleDragEnd = () => {
                dragDataRef.current = { draggingId: null, overId: null };
                setDragState({ draggingId: null, overId: null });
            };

            // FilePanel ìƒíƒœ
            const [filePanel, setFilePanel] = useState({ isOpen: false, mode: 'save' }); // mode: 'save' | 'load'
            const [importData, setImportData] = useState(null);

            const openSavePanel = () => {
                setFilePanel({ isOpen: true, mode: 'save' });
                setImportData(null);
            };

            const openLoadPanel = () => {
                setFilePanel({ isOpen: true, mode: 'load' });
                setImportData(null);
            };

            const closeFilePanel = () => {
                setFilePanel({ isOpen: false, mode: filePanel.mode });
                setImportData(null);
            };

            const handleExportFromPanel = (filename, exportType, password) => {
                const jsonString = JSON.stringify(books);

                if (exportType === 'vel') {
                    // ì•”í˜¸í™” ì €ì¥
                    const encrypted = CryptoJS.AES.encrypt(jsonString, password).toString();
                    const blob = new Blob([encrypted], { type: "text/plain;charset=utf-8" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${filename}.vel`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } else {
                    // ì¼ë°˜ JSON ì €ì¥
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonString);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${filename}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
            };

            const handleFileSelectFromPanel = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    let isEncrypted = false;

                    try {
                        JSON.parse(fileContent);
                        isEncrypted = false;
                    } catch (jsonError) {
                        isEncrypted = true;
                    }

                    setImportData({ content: fileContent, isEncrypted });
                };
                reader.readAsText(file);
            };

            const handleConfirmImportFromPanel = (data, shouldReplace) => {
                if (data && Array.isArray(data)) {
                    onImport(data, shouldReplace);
                } else {
                    alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
                }
            };

            // ... ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼ ...
            const handleConfirmModal = (title, author, color) => {
                // (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
                if (modalConfig.mode === 'create') {
                    const newId = generateUUID();
                    const defaultProjectId = generateUUID();
                    const newBook = {
                        id: newId, title, author, color,
                        projects: [{ id: defaultProjectId, type: 'board', name: 'ìƒˆ ë³´ë“œ', nodes: [], edges: [] }],
                        activeProjectId: defaultProjectId
                    };
                    onCreateBook(newBook);
                } else {
                    onUpdateBook({ ...modalConfig.targetBook, title, author, color });
                }
                setModalConfig({ isOpen: false, mode: 'create', targetBook: null });
            };

            // í†µê³„ ê³„ì‚°
            const stats = useMemo(() => {
                let totalChars = 0;
                let totalDocs = 0;
                let totalNodes = 0;
                let completedDocs = 0;

                books.forEach(book => {
                    (book.projects || []).forEach(project => {
                        if (project.type === 'doc') {
                            totalDocs++;
                            totalChars += (project.content || '').length;
                            if (project.status === 'ì™„ë£Œ') completedDocs++;
                        } else if (project.type === 'board') {
                            totalNodes += (project.nodes || []).length;
                        }
                    });
                });

                return { totalChars, totalDocs, totalNodes, completedDocs };
            }, [books]);

            // ì‹œê°„ëŒ€ë³„ ì¸ì‚¬ë§
            const greeting = useMemo(() => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 12) return { text: 'ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”', emoji: 'ğŸŒ…', sub: 'ì˜¤ëŠ˜ë„ ì¢‹ì€ ê¸€ì´ íƒ„ìƒí•˜ê¸¸' };
                if (hour >= 12 && hour < 17) return { text: 'ì¢‹ì€ ì˜¤í›„ì˜ˆìš”', emoji: 'â˜€ï¸', sub: 'ì ì‹œ ì»¤í”¼ í•œ ì” ì–´ë– ì„¸ìš”?' };
                if (hour >= 17 && hour < 21) return { text: 'ì¢‹ì€ ì €ë…ì´ì—ìš”', emoji: 'ğŸŒ†', sub: 'ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í–ˆì–´ìš”' };
                return { text: 'ê³ ìš”í•œ ë°¤ì´ì—ìš”', emoji: 'ğŸŒ™', sub: 'ì•¼í–‰ì„± ì‘ê°€ë‹˜, ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”' };
            }, []);

            return (
                <div className="w-screen h-screen flex flex-col transition-colors duration-500 bg-slate-100 dark:bg-zinc-950">
                    {modalConfig.isOpen && (<BookSettingsModal initialData={modalConfig.targetBook} onClose={() => setModalConfig({ isOpen: false, mode: 'create', targetBook: null })} onConfirm={handleConfirmModal} onDelete={onDeleteBook} />)}
                    {showSystemSettings && (
                        <SystemSettingsModal
                            onClose={() => setShowSystemSettings(false)}
                            isDarkMode={isDarkMode}
                            toggleDarkMode={toggleDarkMode}
                            fontMode={fontMode}
                            toggleFont={toggleFont}
                            focusPosition={focusPosition}
                            setFocusPosition={setFocusPosition}
                            defaultTargetCount={defaultTargetCount}
                            setDefaultTargetCount={setDefaultTargetCount}
                            editorWidth={editorWidth}
                            setEditorWidth={setEditorWidth}
                            editorFontSize={editorFontSize}
                            setEditorFontSize={setEditorFontSize}
                            showDocWordCount={showDocWordCount}
                            setShowDocWordCount={setShowDocWordCount}
                            enableHistory={enableHistory}
                            setEnableHistory={setEnableHistory}
                        />
                    )}

                    {/* FilePanel - ë‚´ë¶€ ì°½ */}
                    <AnimatePresence>
                        {filePanel.isOpen && (
                            <>
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="fixed inset-0 bg-black/20 z-[99]"
                                    onClick={closeFilePanel}
                                />
                                <FilePanel
                                    isOpen={filePanel.isOpen}
                                    mode={filePanel.mode}
                                    onClose={closeFilePanel}
                                    books={books}
                                    onExport={handleExportFromPanel}
                                    onFileSelect={handleFileSelectFromPanel}
                                    importData={importData}
                                    onConfirmImport={handleConfirmImportFromPanel}
                                />
                            </>
                        )}
                    </AnimatePresence>

                    {/* í—¤ë” */}
                    <header className="h-14 px-8 flex items-center justify-between bg-white dark:bg-zinc-900 sticky top-0 z-50 border-b border-slate-200 dark:border-zinc-800">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-sm flex items-center justify-center shadow-lg">
                                <span className="text-white text-sm">S</span>
                            </div>
                            <div>
                                <span className="text-base font-black tracking-tight text-slate-800 dark:text-zinc-100">ì‚¬ê° ìŠ¤íŠœë””ì˜¤</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-1.5">
                            <button
                                onClick={() => setShowSystemSettings(true)}
                                className={`w-8 h-8 flex items-center justify-center rounded-sm transition-all ${showSystemSettings ? 'bg-indigo-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700'}`}
                                title="ì‹œìŠ¤í…œ ì„¤ì •"
                            >
                                <IconSettings className="w-4 h-4" />
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto custom-scroll">
                        {/* ë©”ì¸ ì½˜í…ì¸  */}
                        <div className="max-w-7xl mx-auto px-10 pt-12 pb-8">
                            {/* ì¸ì‚¬ë§ */}
                            <motion.div
                                initial={{ opacity: 0, y: 20 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="mb-8 flex items-end justify-between"
                            >
                                <div className="flex items-center gap-4">
                                    <span className="text-3xl">{greeting.emoji}</span>
                                    <div>
                                        <h1 className="text-2xl font-black text-slate-800 dark:text-zinc-100 tracking-tight">{greeting.text}</h1>
                                        <p className="text-slate-500 dark:text-zinc-500 text-sm">{greeting.sub}</p>
                                    </div>
                                </div>
                                {quote && (
                                    <div className="text-right max-w-md hidden md:block pb-1">
                                        <p className="text-[13px] font-bold text-slate-600 dark:text-zinc-400 italic">"{quote.quote}"</p>
                                        <p className="text-[10px] text-slate-400 dark:text-zinc-500 mt-1 font-black uppercase tracking-wider">- {quote.author}</p>
                                    </div>
                                )}
                            </motion.div>

                            {/* í†µê³„ ì¹´ë“œ */}
                            <motion.div
                                initial={{ opacity: 0, y: 20 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ delay: 0.1 }}
                                className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10"
                            >
                                <div className="bg-white dark:bg-zinc-900 rounded-lg p-4 border border-slate-200 dark:border-zinc-800">
                                    <div className="text-slate-400 dark:text-zinc-500 text-[10px] font-bold uppercase tracking-widest mb-1">ì´ ì‘í’ˆìˆ˜</div>
                                    <div className="text-2xl font-black text-slate-800 dark:text-zinc-100">{books.length}</div>
                                    <div className="text-slate-400 dark:text-zinc-500 text-xs mt-0.5">í¸ì˜ ì†Œì„¤</div>
                                </div>
                                <div className="bg-white dark:bg-zinc-900 rounded-lg p-4 border border-slate-200 dark:border-zinc-800">
                                    <div className="text-slate-400 dark:text-zinc-500 text-[10px] font-bold uppercase tracking-widest mb-1">ì´ ê¸€ììˆ˜</div>
                                    <div className="text-2xl font-black text-slate-800 dark:text-zinc-100">{stats.totalChars.toLocaleString()}</div>
                                    <div className="text-slate-400 dark:text-zinc-500 text-xs mt-0.5">ìë¥¼ ì¼ì–´ìš”</div>
                                </div>
                                <div className="bg-white dark:bg-zinc-900 rounded-lg p-4 border border-slate-200 dark:border-zinc-800">
                                    <div className="text-slate-400 dark:text-zinc-500 text-[10px] font-bold uppercase tracking-widest mb-1">ì•„ì´ë””ì–´</div>
                                    <div className="text-2xl font-black text-slate-800 dark:text-zinc-100">{stats.totalNodes}</div>
                                    <div className="text-slate-400 dark:text-zinc-500 text-xs mt-0.5">ê°œì˜ ë…¸ë“œ</div>
                                </div>
                                <div className="bg-white dark:bg-zinc-900 rounded-lg p-4 border border-slate-200 dark:border-zinc-800">
                                    <div className="text-slate-400 dark:text-zinc-500 text-[10px] font-bold uppercase tracking-widest mb-1">ì™„ë£Œëœ ì›ê³ </div>
                                    <div className="text-2xl font-black text-slate-800 dark:text-zinc-100">{stats.completedDocs}</div>
                                    <div className="text-slate-400 dark:text-zinc-500 text-xs mt-0.5">/ {stats.totalDocs} ë¬¸ì„œ</div>
                                </div>
                            </motion.div>

                            {/* ì±…ì¥ ì„¹ì…˜ */}
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-3">
                                    <div className="w-1 h-6 bg-indigo-500 rounded-full"></div>
                                    <h2 className="text-lg font-bold text-slate-700 dark:text-zinc-200">ë‚´ ì„œì¬</h2>
                                    <span className="text-xs font-bold text-slate-400 dark:text-zinc-500 bg-slate-100 dark:bg-zinc-800 px-2 py-1 rounded-[3px]">{books.length}ê¶Œ</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={openSavePanel} className={`h-8 px-3 flex items-center gap-1.5 rounded-sm transition-all text-sm font-medium ${filePanel.isOpen && filePanel.mode === 'save' ? 'bg-indigo-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700'}`} title="ì „ì²´ ì €ì¥"><IconSave className="w-4 h-4" />ì €ì¥í•˜ê¸°</button>
                                    <button onClick={openLoadPanel} className={`h-8 px-3 flex items-center gap-1.5 rounded-sm transition-all text-sm font-medium ${filePanel.isOpen && filePanel.mode === 'load' ? 'bg-indigo-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700'}`} title="íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°"><IconUpload className="w-4 h-4" />ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                {books.map((book, index) => (
                                    <motion.div
                                        key={book.id}
                                        initial={{ opacity: 0, y: 20 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        transition={{ delay: index * 0.05 }}
                                        onDragOver={(e) => handleDragOver(e, book.id)}
                                        onDrop={(e) => handleDrop(e, book.id)}
                                        className="relative"
                                    >
                                        <BookCover
                                            book={book}
                                            onClick={() => !dragState.draggingId && onSelectBook(book.id)}
                                            onDelete={onDeleteBook}
                                            onEdit={(target) => setModalConfig({ isOpen: true, mode: 'edit', targetBook: target })}
                                            isDragging={dragState.draggingId === book.id}
                                            isDropTarget={dragState.overId === book.id && dragState.draggingId !== book.id}
                                            dragHandleProps={{
                                                draggable: true,
                                                onDragStart: (e) => handleDragStart(e, book.id),
                                                onDragEnd: handleDragEnd
                                            }}
                                        />
                                    </motion.div>
                                ))}

                                {/* ìƒˆ ì‘í’ˆ ì¶”ê°€ ë²„íŠ¼ */}
                                <motion.button
                                    initial={{ opacity: 0, y: 20 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ delay: books.length * 0.05 }}
                                    onClick={() => setModalConfig({ isOpen: true, mode: 'create', targetBook: null })}
                                    className="group flex flex-col items-center justify-center gap-4 aspect-[2/3] rounded-lg border-2 border-dashed border-slate-300 dark:border-zinc-700 hover:border-indigo-400 dark:hover:border-indigo-500 hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-all duration-300"
                                >
                                    <div className="w-14 h-14 rounded-[3px] bg-slate-100 dark:bg-zinc-800 flex items-center justify-center text-slate-400 dark:text-zinc-500 group-hover:bg-indigo-500 group-hover:text-white transition-all duration-300">
                                        <IconPlus className="w-6 h-6" />
                                    </div>
                                    <div className="text-center">
                                        <span className="block text-sm font-bold text-slate-500 dark:text-zinc-400 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">ìƒˆ ì‘í’ˆ ì‹œì‘í•˜ê¸°</span>
                                        <span className="block text-[10px] font-medium text-slate-400 dark:text-zinc-500 mt-1">í´ë¦­í•˜ì—¬ ì¶”ê°€</span>
                                    </div>
                                </motion.button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('library');
            const [books, setBooks] = useState(() => {
                try {
                    const saved = localStorage.getItem('sagak_library');
                    if (!saved) return [];
                    const parsed = JSON.parse(saved);
                    return Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    console.error('localStorage ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    return [];
                }
            });
            const [currentBookId, setCurrentBookId] = useState(null);
            const [toast, setToast] = useState(null);
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [fontMode, setFontMode] = useState(() => localStorage.getItem('sagak_font') || 'maruburi');
            const [focusPosition, setFocusPosition] = useState(() => parseFloat(localStorage.getItem('sagak_focus_pos')) || 0.5);
            const [defaultTargetCount, setDefaultTargetCount] = useState(() => parseInt(localStorage.getItem('sagak_default_goal')) || 5000);
            const [editorWidth, setEditorWidth] = useState(() => localStorage.getItem('sagak_editor_width') || 'default');
            const [editorFontSize, setEditorFontSize] = useState(() => parseInt(localStorage.getItem('sagak_editor_fontsize')) || 18);
            const [showDocWordCount, setShowDocWordCount] = useState(() => localStorage.getItem('sagak_show_doc_wordcount') !== 'false');
            const [enableHistory, setEnableHistory] = useState(() => localStorage.getItem('sagak_enable_history') !== 'false');
            const saveTimerRef = useRef(null);

            useEffect(() => {
                if (isDarkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            }, [isDarkMode]);

            // ì„¤ì •ê°’ë“¤ ì €ì¥
            useEffect(() => {
                localStorage.setItem('sagak_focus_pos', focusPosition);
                localStorage.setItem('sagak_default_goal', defaultTargetCount);
                localStorage.setItem('sagak_editor_width', editorWidth);
                localStorage.setItem('sagak_editor_fontsize', editorFontSize);
                localStorage.setItem('sagak_show_doc_wordcount', showDocWordCount);
                localStorage.setItem('sagak_enable_history', enableHistory);
            }, [focusPosition, defaultTargetCount, editorWidth, editorFontSize, showDocWordCount, enableHistory]);

            const toggleDarkMode = () => setIsDarkMode(prev => !prev);

            // í°íŠ¸ ë³€ê²½ íš¨ê³¼
            useEffect(() => {
                const fonts = ['font-maruburi', 'font-Ridibatang', 'font-Galmuri14', 'font-pretendard'];
                document.body.classList.remove(...fonts);
                document.body.classList.add(`font-${fontMode}`);
                localStorage.setItem('sagak_font', fontMode);
            }, [fontMode]);

            const toggleFont = () => {
                const modes = ['maruburi', 'Ridibatang', 'Galmuri14', 'pretendard'];
                const nextIndex = (modes.indexOf(fontMode) + 1) % modes.length;
                const nextFont = modes[nextIndex];
                setFontMode(nextFont);
                showToast(`í°íŠ¸ ë³€ê²½: ${FONT_DISPLAY_NAMES[nextFont]}`);
            };

            useEffect(() => {
                if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
                saveTimerRef.current = setTimeout(() => {
                    try {
                        localStorage.setItem('sagak_library', JSON.stringify(books));
                    } catch (e) {
                        console.error('ì €ì¥ ì‹¤íŒ¨:', e);
                        showToast("ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ë°±ì—…í•´ ì£¼ì„¸ìš”.", "error");
                    }
                }, 1000);
                return () => { if (saveTimerRef.current) clearTimeout(saveTimerRef.current); };
            }, [books]);

            const showToast = useCallback((message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 2000);
            }, []);

            const currentBook = useMemo(() => books.find(b => b.id === currentBookId), [books, currentBookId]);

            const handleUpdateBook = useCallback((updatedBook) => {
                setBooks(prev => prev.map(b => b.id === updatedBook.id ? updatedBook : b));
            }, []);

            const handleReorderBooks = useCallback((newBooks) => {
                setBooks(newBooks);
            }, []);

            return (
                <div className={`w-full font-pretendard antialiased text-slate-800 flex flex-col ${isDarkMode ? 'dark' : ''} ${fontMode}`} style={{ height: '100%' }}>                    <AnimatePresence> {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />} </AnimatePresence>
                    {view === 'library' && (
                        <Library
                            books={books}
                            onSelectBook={(id) => { setCurrentBookId(id); setView('workspace'); }}
                            onCreateBook={(newBook) => setBooks([...books, newBook])}
                            onDeleteBook={(id) => {
                                setBooks(prev => prev.filter(b => b.id !== id));
                                showToast("ì‘í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            }}
                            onUpdateBook={handleUpdateBook}
                            onReorderBooks={handleReorderBooks}
                            onImport={(imported, shouldReplace) => {
                                if (shouldReplace) {
                                    setBooks(imported);
                                    showToast("ì„œì¬ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                                } else {
                                    setBooks(prev => [...prev, ...imported]);
                                    showToast("ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                                }
                            }}
                            isDarkMode={isDarkMode}
                            toggleDarkMode={toggleDarkMode}
                            fontMode={fontMode}
                            toggleFont={toggleFont}
                            focusPosition={focusPosition}
                            setFocusPosition={setFocusPosition}
                            defaultTargetCount={defaultTargetCount}
                            setDefaultTargetCount={setDefaultTargetCount}
                            editorWidth={editorWidth}
                            setEditorWidth={setEditorWidth}
                            editorFontSize={editorFontSize}
                            setEditorFontSize={setEditorFontSize}
                            showDocWordCount={showDocWordCount}
                            setShowDocWordCount={setShowDocWordCount}
                            enableHistory={enableHistory}
                            setEnableHistory={setEnableHistory}
                        />
                    )}
                    {view === 'workspace' && currentBook && (
                        <Workspace
                            currentBook={currentBook}
                            onUpdateBook={handleUpdateBook}
                            onExit={() => setView('library')}
                            showToast={showToast}
                            isDarkMode={isDarkMode}
                            toggleDarkMode={toggleDarkMode}
                            fontMode={fontMode}
                            toggleFont={toggleFont}
                            focusPosition={focusPosition}
                            setFocusPosition={setFocusPosition}
                            defaultTargetCount={defaultTargetCount}
                            setDefaultTargetCount={setDefaultTargetCount}
                            editorWidth={editorWidth}
                            editorFontSize={editorFontSize}
                            showDocWordCount={showDocWordCount}
                            setShowDocWordCount={setShowDocWordCount}
                            enableHistory={enableHistory}
                            setEnableHistory={setEnableHistory}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
