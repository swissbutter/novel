
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÇ¨Í∞Å Ïä§ÌäúÎîîÏò§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#09090b',
                        darkpanel: '#18181b',
                        darkborder: '#27272a',
                    },
                    borderRadius: {
                        'sm': '3px',
                    }
                }
            }
        }
    </script>
    <style>
        @font-face {
            font-family: 'MaruBuri';
            src: url(https://hangeul.pstatic.net/hangeul_static/webfont/MaruBuri/MaruBuri-Regular.woff2);
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'Ridibatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Galmuri14';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2506-1@1.0/Galmuri14.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-display: swap;
        }
        body.font-maruburi, body.font-maruburi * { font-family: 'MaruBuri', serif !important; }
        body.font-Ridibatang, body.font-Ridibatang * { font-family: 'Ridibatang', sans-serif !important; }
        body.font-Galmuri14, body.font-Galmuri14 * { font-family: 'Galmuri14', serif !important; }
        body.font-pretendard, body.font-pretendard * { font-family: 'Pretendard', sans-serif !important; }

        body { background: #f1f5f9; overflow: hidden; user-select: none; transition: background-color 0.3s, color 0.3s; }
        .dark body { background: #09090b; color: #e4e4e7; }
        button:not([class*="rounded-full"]), input:not([class*="rounded-full"]), select:not([class*="rounded-full"]), textarea:not([class*="rounded-full"]),
        div[class*="bg-"]:not([class*="rounded-full"]):not([class*="rounded-none"]),
        div[class*="border"]:not([class*="rounded-full"]):not([class*="rounded-none"]),
        aside:not([class*="rounded-full"]), main:not([class*="rounded-full"]),
        section:not([class*="rounded-full"]), article:not([class*="rounded-full"]),
        footer:not([class*="rounded-full"]) {
            border-radius: 3px;
        }
        .grid-background { background-color: #f8fafc; background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .dark .grid-background { background-color: #09080B; background-image: linear-gradient(#141416 1px, transparent 1px), linear-gradient(90deg, #141416 1px, transparent 1px); }
        .dot-background { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 1px, transparent 0) !important; background-size: 20px 20px !important; background-position: 0 0; }
        .dark .dot-background { background-color: #09080B; background-image: radial-gradient(#27272a 1px, transparent 0) !important; }
        .canvas-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        .edge-path { fill: none; transition: stroke 0.2s, d 0.15s ease-out; stroke-linecap: round; stroke-linejoin: round; }
        .edge-hitbox { fill: none; stroke: transparent; stroke-width: 20; cursor: pointer; pointer-events: stroke; }
        .node-glass { background: #ffffff; backdrop-filter: blur(10px); border: 1px solid #cbd5e1; border-radius: 3px; box-sizing: border-box; }
        .dark .node-glass { background: #1f1f23; border: 1px solid #3f3f46; color: #fafafa; }
        .node-postit { background-color: #fef9c3; border-radius: 3px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border: 1px solid #fde047; }
        .dark .node-postit { background-color: #3d3a2a; border: 1px solid #5a5642; color: #f5f3e0; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .zoom-container { 
            transform-origin: 0 0; 
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0); 
        }
        .is-dragging .zoom-container { transition: none; }
        .is-dragging .edge-path { transition: none; }
        .node-protagonist { outline: 8px solid rgba(37, 99, 235, 0.2); background: #d7e7fc; }
        .dark .node-protagonist { outline: 8px solid rgba(37, 99, 235, 0.2); background: #172554; }
        .node-antagonist { border: 1px solid #c88885; background: #fbdfde; }
        .dark .node-antagonist { border: 1px solid #7f1d1d; background: #450a0a; }
        .node-helper { border: 1px solid #7dcb97; background: #d0f7e2; }
        .dark .node-helper { border: 1px solid #059669; background: #064e3b; }
        .node-event { outline: 4px solid rgba(255, 3, 3, 0.3); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; transition: background 0.2s; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; }
        .dark .custom-scroll:hover::-webkit-scrollbar-thumb { background: #52525b; }
        .editor-paper { max-width: 585px; margin: 40px auto; background: white; min-height: calc(100vh - 80px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); border-radius: 3px; display: flex; flex-direction: column; position: relative; overflow: hidden; transition: background-color 0.3s, max-width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .editor-paper { background: #18181b; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); border: 1px solid #27272a; }
        .editor-title-container { padding: 40px 60px 10px 60px; }
        .editor-textarea { width: 100%; flex: 1; resize: none; outline: none; line-height: 2.2; font-size: 18px; color: #334155; background: transparent; border: none; padding: 20px 60px 60px 60px; }
        .dark .editor-textarea { color: #d4d4d8; }
        .book-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform-style: preserve-3d; }
        .book-spine { background: linear-gradient(90deg, transparent 0%, transparent 20%, rgba(0,0,0,0.1) 100%); }
        .page-bg { background-color: #fdfbf7; background-image: repeating-linear-gradient(transparent, transparent 19px, #e5e7eb 20px); }
        .mention-list { position: fixed; z-index: 1000; background: white; border: 1px solid #e2e8f0; border-radius: 3px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); max-height: 400px; overflow: visible; display: flex; width: 600px; }
        .dark .mention-list { background: #18181b; border-color: #27272a; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .mention-item-active { background-color: #f1f5f9; border-left: 4px solid #4f46e5; }
        .dark .mention-item-active { background-color: #27272a; border-left: 4px solid #4f46e5; }
        .editor-textarea.zen-active {
            padding-bottom: 50vh !important;
            -ms-overflow-style: none !important; 
            scrollbar-width: none !important; 
        }
        .editor-textarea.zen-active::-webkit-scrollbar {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useMemo, useEffect, memo } = React;
        const { motion, AnimatePresence, Reorder } = window.Motion;
        const CARD_W = 250; 
        const CARD_H = 200;
        const BOOK_COLORS = ['#18181b', '#3c3c3c', '#881337', '#7c2d12', '#424034', '#73734e', '#2e3b36', '#134e4a', '#1e3a8a', '#33272c', '#4c1d95', '#451a03'];
        const NAME_DB = {
            fantasy: {
                royalty: {
                    m: ["ÏïÑÏÑú|Arthur", "ÏúåÎ¶¨ÏóÑ|William", "Î¶¨Ï≤òÎìú|Richard", "ÏóêÎìúÏõåÎìú|Edward", "ÏïåÎ†âÏÇ∞Îçî|Alexander", "Î£®Ïù¥|Louis", "Ìó®Î¶¨|Henry", "ÌîÑÎ†àÎç∞Î¶≠|Frederick", "Î†àÏò§|Leo", "ÎßâÏãúÎ∞ÄÎ¶¨Ïïà|Maximilian", "ÌïÑÎ¶Ω|Philip", "Ï∞∞Ïä§|Charles", "Ï°∞ÏßÄ|George", "ÏïåÎùºÎ¶≠|Alaric", "ÌÖåÏò§ÎèÑÎ•¥|Theodore", "Î∞úÎ†àÎ¶¨Ïö∞Ïä§|Valerius", "ÏïÑÏö∞Íµ¨Ïä§Ìà¨Ïä§|Augustus", "ÏÑ∏Î∞îÏä§Ï∞¨|Sebastian", "Ïú®Î¶¨Ïö∞Ïä§|Julius", "Ïπ¥ÏãúÏö∞Ïä§|Cassius", "Îç∞ÎØ∏Ïïà|Demian", "Î£®ÏãúÏïà|Lucian", "ÏïÑÎìúÎ¶¨Ïïà|Adrian", "Ï§ÑÎ¶¨Ïïà|Julian", "Î≤†ÎÑ§ÎîïÌä∏|Benedict", "ÏΩòÏä§ÌÉÑÌã¥|Constantine", "Í∞ÄÎ∏åÎ¶¨Ïóò|Gabriel", "ÎØ∏Ïπ¥Ïóò|Michael", "ÎùºÌååÏóò|Raphael", "Ïò§Ïä§Ïπ¥|Oscar", "ÌÅ¥Î°úÎπÑÏä§|Clovis", "ÏÉ§Î•ºÎßàÎâ¥|Charlemagne", "ÌîºÌïÄ|Pepin", "Î°úÌÉÄÎ•¥|Lothair", "ÏΩòÎùºÎìú|Conrad", "Ïò§ÌÜ†|Otto", "ÏßÄÍ∏∞Ïä§Î¨∏Ìä∏|Sigismund", "ÌéòÎ•¥ÎîîÎÇúÎìú|Ferdinand", "ÏïåÌè∞ÏÜå|Alfonso", "Ìé†Î¶¨Ìéò|Felipe", "Ïπ¥Î•ºÎ°úÏä§|Carlos", "ÌîÑÎûÄÏãúÏä§|Francis", "Ï†úÏûÑÏä§|James", "Ìï¥Î°§Îìú|Harold", "ÏóêÎìúÎ¨∏Îìú|Edmund", "Ïï®Î≤ÑÌä∏|Albert", "ÎπÖÌÑ∞|Victor", "ÎãàÏΩúÎùºÏä§|Nicholas", "Î∏îÎùºÎîîÎØ∏Î•¥|Vladimir", "Íµ¨Ïä§ÌÉÄÌîÑ|Gustav", "ÌÅ¨Î¶¨Ïä§Ìã∞Ïïà|Christian", "Î†àÏò§Ìè¥Îìú|Leopold", "Î£®ÎìúÎπÑÌûà|Ludwig", "ÌîÑÎûÄÏ∏†|Franz", "Î£®ÎèåÌîÑ|Rudolf", "Î∞úÌä∏Ìï¥Î®∏|Waldemar", "Ïπ¥ÏãúÎØ∏Î•¥|Casimir", "ÎßàÌã∞ÏïÑÏä§|Matthias", "Ïä§ÌÖåÌåê|Stefan", "Ïù¥Î∞ò|Ivan", "ÏïÑÍ≤åÏã§ÎùºÏö∞Ïä§|Agesilaus", "Î†àÏò§ÎãàÎã§Ïä§|Leonidas", "ÌÅ¨ÏÑ∏Î•¥ÌÅ¨ÏÑ∏Ïä§|Xerxes", "Îã§Î¶¨Ïö∞Ïä§|Darius", "ÌÇ§Î£®Ïä§|Cyrus", "Ìä∏ÎùºÏïºÎàÑÏä§|Trajan", "ÌïòÎìúÎ¶¨ÏïÑÎàÑÏä§|Hadrian", "ÎßàÎ•¥Ïø†Ïä§|Marcus", "ÏΩ§Î™®ÎëêÏä§|Commodus", "ÏÖâÌã∞ÎØ∏Ïö∞Ïä§|Septimius", "Ïπ¥ÎùºÏπºÎùº|Caracalla", "ÎîîÏò§ÌÅ¥Î†àÌã∞ÏïÑÎàÑÏä§|Diocletian", "Î∞úÎ†åÌã∞ÎãàÏïà|Valentinian", "ÌÖåÏò§ÎèÑÏãúÏö∞Ïä§|Theodosius", "Ïú†Ïä§Ìã∞ÎãàÏïÑÎàÑÏä§|Justinian", "Î≤®Î¶¨ÏÇ¨Î¶¨Ïö∞Ïä§|Belisarius", "Ìó§ÎùºÌÅ¥Î¶¨Ïö∞Ïä§|Heraclius", "Î∞îÏã§Î¶¨Ïö∞Ïä§|Basilius", "Î†àÏò§|Leo", "Î°úÎßàÎàÑÏä§|Romanus", "ÏïåÎ†âÏãúÏö∞Ïä§|Alexius", "ÎßàÎàÑÏóò|Manuel", "ÏïàÎìúÎ°úÎãàÏø†Ïä§|Andronicus", "Î≥ºÎ†àÏä¨ÎùºÌîÑ|Boleslaw", "ÎØ∏ÏóêÏäàÏΩî|Mieszko", "ÎùºÎîîÏä¨ÎùºÌîÑ|Ladislav", "Î≤®Îùº|Bela", "Ïù¥Ïä§Ìä∏Î∞ò|Istvan", "ÏπºÎßå|Kalman", "Îü¨ÏöîÏäà|Lajos"],
                    f: ["ÏóòÎ¶¨ÏûêÎ≤†Ïä§|Elizabeth", "ÎπÖÌÜ†Î¶¨ÏïÑ|Victoria", "Ïù¥ÏÇ¨Î≤®Îùº|Isabella", "ÎßàÌã∏Îã§|Matilda", "ÏïÑÎç∏Îùº|Adela", "Î≤†ÏïÑÌä∏Î¶¨Ïä§|Beatrice", "ÏÉ¨Î°Ø|Charlotte", "ÏóòÎ†àÎÖ∏Ïñ¥|Eleanor", "ÎßàÍ∞ÄÎ†õ|Margaret", "Ï∫êÏÑúÎ¶∞|Catherine", "ÏÜåÌîºÏïÑ|Sophia", "ÏïÑÎÇòÏä§ÌÉÄÏÉ§|Anastasia", "Ï§ÑÎ¶¨ÏïÑ|Julia", "ÌÅ¥ÎùºÏö∞ÎîîÏïÑ|Claudia", "Î∞úÎ†åÌã∞ÎÇò|Valentina", "ÏÑ∏Ïã§Î¶¨ÏïÑ|Cecilia", "Ïò§ÌïÑÎ¶¨ÏïÑ|Ophelia", "ÏΩîÎç∏Î¶¨ÏïÑ|Cordelia", "Ï†úÎÑ§ÎπÑÎ∏å|Genevieve", "Î°úÏûòÎ¶∞Îìú|Rosalind", "ÎπÑÎπÑÏïà|Vivian", "ÏÑ∏ÎùºÌîºÎÇò|Seraphina", "ÏïÑÏö∞Î†êÎ¶¨ÏïÑ|Aurelia", "Î£®ÏãúÏïÑ|Lucia", "Ìó¨Î†àÎÇò|Helena", "Îã§Ïù¥ÏïÑÎÇò|Diana", "Ïπ¥Î∞ÄÎùº|Camilla", "Ïò§Î°úÎùº|Aurora", "Ïã§ÎπÑÏïÑ|Sylvia", "ÎßàÎ¶¨|Marie", "ÏïÑÎç∏ÎùºÏù¥Îìú|Adelaide", "ÏΩòÏä§ÌÉÑÏä§|Constance", "Ïù¥ÎîîÏä§|Edith", "ÌïÑÎ¶¨Ìåå|Philippa", "Ï°∞Ïïà|Joan", "Ïï§|Anne", "ÌÅ¨Î¶¨Ïä§Ìã∞ÎÇò|Christina", "ÎπåÌó¨ÎØ∏ÎÇò|Wilhelmina", "ÏïôÌà¨ÏïÑÎÑ§Ìä∏|Antoinette", "Ï°∞ÏÑ∏ÌïÄ|Josephine", "ÌÖåÎ†àÏÇ¨|Theresa", "Ïù¥Î†àÎÑ§|Irene", "Ï†úÎãàÏïÑ|Xenia", "ÌÉÄÌã∞ÏïÑÎÇò|Tatiana", "Ïò¨Í∞Ä|Olga", "ÏûâÍ∑∏Î¶¨Îìú|Ingrid", "ÏïÑÏä§Ìä∏Î¶¨Îìú|Astrid", "Î∏åÎ¶¨Ïßì|Bridget", "Ïö∞Î•¥Ïà†Îùº|Ursula", "ÌÅ¥Î†àÎ©òÌÉÄÏù∏|Clementine", "ÌîåÎ°úÎùº|Flora", "Î∏îÎûëÏâ¨|Blanche", "Í∞ÄÎ∏åÎ¶¨ÏóòÎùº|Gabriella", "ÏïåÎ†âÏÇ∞ÎìúÎùº|Alexandra", "Ï∫êÎ°§ÎùºÏù∏|Caroline", "Î£®Ïù¥Ï¶à|Louise", "Ïó†ÎßàÎâ¥Ïóò|Emmanuelle", "ÎπÑÏò¨Îùº|Viola", "ÎØ∏ÎûÄÎã§|Miranda", "Î¶¨Í±¥|Regan", "Ï†úÎÖ∏ÎπÑÏïÑ|Zenobia", "ÌÅ¥Î†àÏò§ÌååÌä∏Îùº|Cleopatra", "ÎÑ§ÌéòÎ•¥Ìã∞Ìã∞|Nefertiti", "ÌïòÌä∏ÏÖâÏàòÌä∏|Hatshepsut", "ÏïÑÍ∑∏Î¶¨ÌîºÎÇò|Agrippina", "Î©îÏÇ¥Î¶¨ÎÇò|Messalina", "Ïò•ÌÉÄÎπÑÏïÑ|Octavia", "Î¶¨ÎπÑÏïÑ|Livia", "Î£®ÌÅ¨Î†àÏπòÏïÑ|Lucretia", "Î≤†Î°úÎãàÏπ¥|Veronica", "Ïö∞ÎùºÎãàÏïÑ|Urania", "ÏπºÎ¶¨Ïò§Ìéò|Calliope", "ÏóêÏö∞Î°úÌåå|Europa", "ÏïàÌã∞Í≥†ÎÑ§|Antigone", "Ïù¥Ïä§Î©îÎÑ§|Ismene", "ÏùºÎ†âÌä∏Îùº|Electra", "Ïù¥ÌîºÍ≤åÎãàÏïÑ|Iphigenia", "ÎùºÎπÑÎãàÏïÑ|Lavinia", "ÎîîÎèÑ|Dido", "Í∏∞ÎÑ§ÎπÑÏñ¥|Guinevere", "Ïù¥Ï°∏Îç∞|Isolde", "Î™®Î•¥Í∞Ñ|Morgan", "ÎãòÏóê|Nimue", "ÏùºÎ†àÏù∏|Elaine", "Ïù¥Í∑∏Î†àÏù∏|Igraine", "Î™®Í∞ÄÏ¶à|Morgause", "Í∑∏Î¶¨Ï†§Îã§|Griselda", "Í≥†ÎîîÎ∞î|Godiva", "Î°úÏõ®ÎÇò|Rowena", "ÏóêÏò§Ïúà|Eowyn"],
                    s: ["ÎùºÏù¥Ïò®ÌïòÌä∏|Lionheart", "Í≥®ÎìúÎ©îÏù∏|Goldmane", "Ïã§Î≤ÑÏèú|Silverthorn", "Î∏îÎûôÏö∞Îìú|Blackwood", "ÏúàÌÑ∞Î≥∏|Winterbourne", "ÏÑúÎ®∏ÏÖã|Somerset", "ÌïòÏù¥ÏúàÎìú|Highwind", "Ïä§ÌÜ∞Í∞ÄÎìú|Stormguard", "ÏïÑÏù¥Ïñ∏ÏÇ¨Ïù¥Îìú|Ironside", "Î°úÏ¶àÎ∏îÎü¨Îìú|Roseblood", "ÌÇπÏä§Î≤†Ïù∏|Kingsbane", "Î°úÏó¥|Royal", "ÌÅ¨ÎùºÏö¥|Crown", "Î∞úÎ£®ÏïÑ|Valois", "ÌäúÎçî|Tudor", "ÌïòÎÖ∏Î≤Ñ|Hanover", "ÏúàÏ†Ä|Windsor", "Îû≠Ïπ¥Ïä§ÌÑ∞|Lancaster", "ÏöîÌÅ¨|York", "Ïä§ÌäúÏñ¥Ìä∏|Stuart", "Î∂ÄÎ•¥Î¥â|Bourbon", "Ìï©Ïä§Î∂ÄÎ•¥ÌÅ¨|Habsburg", "Î©îÎîîÏπò|Medici", "Î°úÎßàÎÖ∏ÌîÑ|Romanov", "Ìò∏ÏóîÏ¥êÎ†àÎ•∏|Hohenzollern", "ÏÇ¨Î≥¥Ïù¥|Savoy", "Í∑∏Î¶¨ÎßêÎîî|Grimaldi", "Ïò§Î†åÏßÄ|Orange", "ÎÇòÏÜå|Nassau", "Î£©ÏÖàÎ∂ÄÎ•¥ÌÅ¨|Luxembourg", "ÏÑ†ÌååÏù¥Ïñ¥|Sunfire", "Î¨∏ÏúÑÏä§Ìçº|Moonwhisper", "Ïä§ÌÉÄÌè¥|Starfall", "ÎçòÏãúÏª§|Dawnseeker", "ÎÇòÏù¥Ìä∏ÏÖ∞Ïù¥Îìú|Nightshade", "Î†àÏù¥Î∏êÏä§ÌÅ¨Î°úÌîÑÌä∏|Ravenscroft", "Ïï†Ïâ¨Îã§Ïö¥|Ashdown", "Ïèú|Thorne", "Ïä§ÌÑ∏ÎßÅ|Sterling", "ÌÅ¨Î°¨Ïõ∞|Cromwell", "Ïã±ÌÅ¥Î†àÏñ¥|Sinclair", "Î™ΩÍ≥†Î©îÎ¶¨|Montgomery", "ÌïòÏõåÎìú|Howard", "ÌçºÏãú|Percy", "ÎÑ§Îπå|Neville", "Î≥¥ÌçºÌä∏|Beaufort", "Î™®Ìã∞Î®∏|Mortimer", "Ïä§ÌÉ†Î¶¨|Stanley", "ÌÉàÎ¥á|Talbot", "Ìó§Ïù¥Ïä§ÌåÖÏä§|Hastings", "Î≤ÑÌÇπÏóÑ|Buckingham", "Î≤†ÎìúÌè¨Îìú|Bedford", "ÌÅ¥ÎùºÎ†åÏä§|Clarence", "Í∏ÄÎ°úÏä§ÌÑ∞|Gloucester", "ÏºÑÌä∏|Kent", "ÏΩòÏõî|Cornwall", "Ïõ®ÏùºÏ¶à|Wales", "ÏïåÎ∞îÎãà|Albany", "Î°úÏä§|Ross", "ÎßàÏπò|March", "ÎìúÎûòÍ≥§ÌïòÌä∏|Dragonheart", "ÌîºÎãâÏä§Ïúô|Phoenixwing", "Í∑∏Î¶¨ÌïÄÌÅ¥Î°ú|Griffinclaw", "Ïú†ÎãàÏΩòÌòº|Unicornhorn", "Ïä§ÌÉÄÍ≤åÏù¥Ï†Ä|Stargazer", "ÏÑ†ÎùºÏù¥Îçî|Sunrider", "Î¨∏ÏõåÏª§|Moonwalker", "Ïä§Ïπ¥Ïù¥Î≥∏|Skyborn", "Ïñ¥Ïä§ÏÖ∞Ïù¥Ïª§|Earthshaker", "Ïî®ÏõåÏª§|Seawalker", "ÌîÑÎ°úÏä§Ìä∏Î≥∏|Frostborn", "ÌîåÎ†àÏûÑÌïòÌä∏|Flameheart", "Ïç¨ÎçîÎ°úÎìú|Thunderlord", "Ïä§ÌÜ∞Î∏åÎßÅÏñ¥|Stormbringer", "ÏúàÎìúÎü¨ÎÑà|Windrunner", "ÎèàÎ∏åÎßÅÏñ¥|Dawnbringer", "ÎçîÏä§ÌÅ¨ÏõåÏª§|Duskwalker", "ÎÇòÏù¥Ìä∏Ìè¥|Nightfall", "Îç∞Ïù¥Î∏åÎ†àÏù¥ÌÅ¨|Daybreak", "ÎùºÏù¥Ìä∏Î∏åÎßÅÏñ¥|Lightbringer", "ÏÑÄÎèÑÏö∞ÌóåÌÑ∞|Shadowhunter", "Î∏îÎü¨ÎìúÎ¨∏|Bloodmoon", "Ïã§Î≤ÑÎ¨∏|Silvermoon", "Í≥®Îì†ÏÑ†|Goldensun", "ÏïÑÏù¥Ïñ∏Ìè¨ÏßÄ|Ironforge", "Ïä§Ìã∏Í∞ÄÎìú|Steelguard", "Ïä§ÌÜ§Ïõî|Stonewall", "Ïö∞ÎìúÏõåÎìú|Woodward", "Î¶¨Î≤ÑÏÜ°|Riversong", "Î†àÏù¥ÌÅ¨Î∑∞|Lakeview"]
                },
                knight: {
                    m: ["ÎûúÏä§|Lance", "Í∞ÄÏõ®Ïù∏|Gawain", "ÌçºÏãúÎ≤å|Percival", "Ìä∏Î¶¨Ïä§ÌÉÑ|Tristan", "Ìó•ÌÜ†Î•¥|Hector", "ÏïÑÌÇ¨Î†àÏä§|Achilles", "Î°§Îûë|Roland", "Ïò¨Î¶¨Î≤Ñ|Oliver", "Ï†úÎùºÎìú|Gerard", "Î≥ºÎìúÏúà|Baldwin", "Í≥†ÎìúÌîÑÎ¶¨|Godfrey", "Î†àÏù¥Î™¨Îìú|Raymond", "ÌÉÑÌÅ¨Î†àÎìú|Tancred", "Î≥¥ÏóêÎ™Ω|Bohemond", "Î°úÎ≤ÑÌä∏|Robert", "Í∞ÄÏù¥|Guy", "ÏãúÎ™¨|Simon", "Ìú¥|Hugh", "Ï†úÌîÑÎ¶¨|Geoffrey", "Ïä§ÌÖåÌåê|Stephen", "Î°úÏ†Ä|Roger", "ÏúåÌÑ∞|Walter", "Í∏∏Î≤ÑÌä∏|Gilbert", "Î≤ÑÎÇòÎìú|Bernard", "ÏïÑÎÜÄÎìú|Arnold", "Î†àÏò§ÌååÎìú|Leopard", "Ïö∏ÌîÑ|Wolf", "Î≤†Ïñ¥|Bear", "Ìò∏ÌÅ¨|Hawk", "ÌåîÏΩò|Falcon", "ÏºÑÎìúÎ¶≠|Kendrick", "Î°úÎç∞Î¶≠|Roderick", "ÏÑ∏ÎìúÎ¶≠|Cedric", "ÌÖåÏò§ÎèÑÎ¶≠|Theodoric", "Î†àÏò§ÌîÑÎ¶≠|Leofric", "Ïö∏ÌîÑÎ¶≠|Wulfric", "ÏóêÎ∞úÌä∏|Ewald", "Í≤åÎ•¥ÌïòÎ•¥Ìä∏|Gerhardt", "ÌïòÎ•¥Ìä∏Î¨¥Ìä∏|Hartmut", "ÎùºÏù¥ÎÑà|Rainer", "Ìè¥Ïª§|Volker", "Í±¥ÌÑ∞|Gunther", "ÌïòÍ≤ê|Hagen", "ÏßÄÍ∑∏ÌîÑÎ¶¨Îìú|Siegfried", "ÎîîÌä∏Î¶¨Ìûà|Dietrich", "ÌûêÎç∞Î∏åÎûÄÌä∏|Hildebrand", "ÏºÄÏù∏|Kane", "ÎìúÎ†àÏù¥ÌÅ¨|Drake", "Í∑∏Î¶¨ÌïÄ|Griffin", "Î†âÏä§|Rex", "ÎßâÏãúÎ¨¥Ïä§|Maximus", "ÌÉÄÏù¥Ìà¨Ïä§|Titus", "ÎßàÎ•¥Ïø†Ïä§|Marcus", "Î£®ÌÇ§Ïö∞Ïä§|Lucius", "ÌîåÎùºÎπÑÏö∞Ïä§|Flavius", "Î∞úÎ†àÎ¶¨Ïïà|Valerian", "Ïò§Î¶¨Ïò®|Orion", "ÏïÑÏïΩÏä§|Ajax", "Ï†úÏù¥Ïä®|Jason", "Ìó§ÎùºÌÅ¥Î†àÏä§|Hercules", "Í∞§Îü¨Ìï¥Îìú|Galahad", "Î≥¥Ïñ¥Ïä§|Bors", "Î≤†ÎîîÎπÑÏñ¥|Bedivere", "ÏºÄÏù¥|Kay", "Í∞ÄÎ†àÏä§|Gareth", "Í∞ÄÌó§Î¶¨Ïä§|Gaheris", "ÌåîÎ°úÎØ∏Îç∞Ïä§|Palomides", "ÏÇ¨ÌîºÎ•¥|Safir", "ÏÑ∏Í∑∏ÏôÄÎ¶¨Îç∞Ïä§|Segwarides", "Îã§Ïù¥ÎÇòÎã®|Dinadan", "Îã§Í≥†ÎÑ∑|Dagonet", "Î™®ÌôÄÌä∏|Morholt", "ÎùºÎ™®ÎùΩ|Lamorak", "Ìé†Î¶¨ÎÖ∏Ïñ¥|Pellinore", "ÏïÑÍ∑∏ÎùºÎ≤†Ïù∏|Agravain", "Î™®ÎìúÎ†àÎìú|Mordred", "ÌÜ†Î•¥|Tor", "ÏóëÌÑ∞|Ector", "ÎùºÏù¥Ïñ∏|Lionel", "Î£®Ïπ∏|Lucan", "ÎπÑÏöîÎ•∏|Bjorn", "ÎùºÍ∑∏ÎÇò|Ragnar", "Î°§Î°ú|Rollo", "ÏïÑÏù¥Î∞î|Ivar", "ÏóêÎ¶≠|Erik", "ÌïòÎûÑÎìú|Harald", "Ïä§Î≤§|Sven", "ÌÅ¨ÎàÑÌä∏|Cnut", "Î†àÏù¥ÌîÑ|Leif", "ÏÜåÎ¶∞|Thorin"],
                    f: ["Ïûî|Jeanne", "Î∏åÎ¶¨|Bree", "Ïπ¥ÏÇ∞ÎìúÎùº|Cassandra", "Î∞úÌÇ§Î¶¨|Valkyrie", "ÏïÑÌÖåÎÇò|Athena", "Î≤®Î°úÎÇò|Bellona", "Ïπ¥Î∞ÄÎùº|Camilla", "Î∏åÎûòÎìúÎùºÎßåÌÖå|Bradamante", "ÎßàÎ•¥ÌîºÏÇ¨|Marpissa", "ÌÅ¥Î°úÎ¶∞Îã§|Clorinda", "Î∏åÎ£¨ÌûêÎç∞|Brunhilde", "ÏãúÍ∑∏Î£¨|Sigrun", "Î°úÏ¶à|Rose", "Î¶¥Î¶¨|Lily", "ÏïÑÏù¥Î¶¨Ïä§|Iris", "Î∞îÏù¥Ïò¨Î†õ|Violet", "Ïû¨Ïä§ÎØº|Jasmine", "Îç∞Ïù¥ÏßÄ|Daisy", "Ìè¨Ìîº|Poppy", "ÌôÄÎ¶¨|Holly", "ÏïÑÏù¥ÎπÑ|Ivy", "Ìó§Ïù¥Ï†§|Hazel", "ÏúåÎ°úÏö∞|Willow", "Î°úÏôÑ|Rowan", "ÏïÑÏä§Ìéú|Aspen", "Í∑∏Ïõ¨|Gwen", "Í∏∞ÎÑ§ÎπÑÏñ¥|Guinevere", "Î™®Í±¥|Morgan", "ÎßàÌã∏Îã§|Matilda", "ÏïÑÍ∑∏ÎÑ§Ïä§|Agnes", "Î≤†ÏïÑÌä∏Î¶≠Ïä§|Beatrix", "Í±∞Ìä∏Î£®Îìú|Gertrude", "Ìó§ÎìúÏúÖ|Hedwig", "ÏïàÎìúÎ°úÎ©îÎã§|Andromeda", "ÏïÑÎ•¥ÌÖåÎØ∏ÏãúÏïÑ|Artemisia", "Ï†úÎÖ∏ÎπÑÏïÑ|Zenobia", "Î∂ÄÎîîÏπ¥|Boudicca", "ÌûàÌè¥Î¶¨ÌÉÄ|Hippolyta", "ÌéúÌÖåÏã§Î†àÏù¥ÏïÑ|Penthesilea", "ÏïÑÌÉàÎûÄÌÉÄ|Atalanta", "Ïä§Ïπ¥ÏïÑÌïò|Scathach", "Ïù¥Ï°∏Îç∞|Isolde", "Î∞úÎ†åÏãúÏïÑ|Valencia", "ÎπÖÌÜ†Î¶¨ÏïÑ|Victoria", "ÏïåÎ†âÏãúÏïÑ|Alexia", "ÏïàÎìúÎ†àÏïÑ|Andrea", "ÏóêÎ¶¨Ïπ¥|Erica", "ÌîÑÎ†àÎç∞Î¶¨Ïπ¥|Frederica", "Î†àÏò§ÎÇò|Leona", "ÎßàÎ•¥Ìã∞ÎÇò|Martina", "ÎãàÏΩú|Nicole", "ÌïÑÎ¶¨Ìåå|Philippa", "Ïä§ÌÖåÌååÎãà|Stephanie", "ÌÖåÏò§ÎèÑÎùº|Theodora", "ÎπåÎßà|Wilma", "Î∏åÎ¶¨ÌÜ†ÎßàÌä∏|Britomart", "ÏïàÌã∞Ïò§Ìéò|Antiope", "Î©úÎùºÎãàÌéò|Melanippe", "Ïò§Ìä∏Î†àÎùº|Otrera", "ÌÉàÎ†àÏä§Ìä∏Î¶¨Ïä§|Thalestris", "ÎØ∏Î¶¨ÎÇò|Myrina", "Î¶¨ÏãúÌéò|Lysippe", "ÌûàÌè¥Î¶¨ÌÖå|Hippolyte", "ÎûåÌéòÌÜ†|Lampeto", "ÎßàÎ•¥ÌéòÏãúÏïÑ|Marpesia", "Ïò§Î¶¨Ìã∞ÏïÑ|Orithyia", "ÏãúÎÖ∏Ìéò|Sinope", "ÌÖåÎ•¥Î™®ÎèÑÏÇ¨|Thermodosa", "Î∞úÎùºÏä§Ïπ¥|Valasca", "Î∏îÎ†åÎã§|Blenda", "ÎùºÍ≤åÎ•¥ÌÉÄ|Lagertha", "Ìó§Î•¥Î≥¥Î•¥|Hervor", "Î∏åÎ•ÄÌûêÎìú|Brynhildr", "ÏãúÍ∑∏ÎìúÎ¶¨Ìåå|Sigrdrifa", "Ïä§Î∞îÎ∞î|Svava", "Ïò¨Î£¨|Olrun", "ÏïåÎπÑÌä∏|Alvitr", "ÌùòÎùºÎìúÍµ∞|Hladgunnr", "Ìó§Î•¥Ïïº|Herja", "ÎØ∏Ïä§Ìä∏|Mist", "Ïä§Ïø®Îìú|Skuld", "ÎûëÍ∑∏Î¶¨Îìú|Randgrid", "Í≥§Îëò|Gondul", "Í≤åÏùºÎ¢∞Íµ¥|Geirskogul", "Ïä§ÌÅ¨Î¢∞Íµ¥|Skogul"],
                    s: ["ÏïÑÏù¥Ïñ∏|Iron", "Ïä§Ìã∏|Steel", "Ïâ¥Îìú|Shield", "ÏÜåÎìú|Sword", "Î∏îÎ†àÏù¥Îìú|Blade", "Ïä§ÌîºÏñ¥|Spear", "ÎûúÏä§|Lance", "Ïï°Ïä§|Axe", "Ìï¥Î®∏|Hammer", "Î©îÏù¥Ïä§|Mace", "Î≥¥Ïö∞|Bow", "Ïï†Î°úÏö∞|Arrow", "ÎåÄÍ±∞|Dagger", "ÎÇòÏù¥ÌîÑ|Knife", "Í∞ÄÎìú|Guard", "ÏÑºÌã∞ÎÑ¨|Sentinel", "ÏõåÎì†|Warden", "ÌÇ§Ìçº|Keeper", "ÌîÑÎ°úÌÖçÌÑ∞|Protector", "ÎîîÌéúÎçî|Defender", "Ï±îÌîºÏñ∏|Champion", "ÏõåÎ¶¨Ïñ¥|Warrior", "ÌååÏù¥ÌÑ∞|Fighter", "ÏÜîÏ†Ä|Soldier", "ÎÇòÏù¥Ìä∏|Knight", "ÌåîÎùºÎîò|Paladin", "ÌÅ¨Î£®ÏÑ∏Ïù¥Îçî|Crusader", "ÌÖúÌîåÎü¨|Templar", "Î†àÏù∏Ï†Ä|Ranger", "Ïä§Ïπ¥Ïö∞Ìä∏|Scout", "Ïä§Ìä∏Î°±|Strong", "Î≥ºÎìú|Bold", "Î∏åÎ†àÏù¥Î∏å|Brave", "ÌÇ®|Keen", "Ïä§ÏúÑÌîÑÌä∏|Swift", "ÏÉ§ÌîÑ|Sharp", "ÌïòÎìú|Hard", "ÌÑ∞ÌîÑ|Tough", "Îü¨ÌîÑ|Rough", "ÏôÄÏùºÎìú|Wild", "ÌûêÌä∏|Hilt", "ÌèºÎ©ú|Pommel", "ÏóêÏßÄ|Edge", "Ìè¨Ïù∏Ìä∏|Point", "Ìó¨Î¶Ñ|Helm", "Í±¥ÌãÄÎ¶ø|Gauntlet", "Í∑∏Î¶¨Î∏å|Greave", "Î©îÏùº|Mail", "ÌîåÎ†àÏù¥Ìä∏|Plate", "Ïä§Ìä∏ÎùºÏù¥ÌÅ¨|Strike", "Î∞∞ÌãÄ|Battle", "Ïõå|War", "ÌååÏù¥Ìä∏|Fight", "ÎìÄÏñº|Duel", "Ïª¥Î±É|Combat", "ÎπÖÌÜ†Î¶¨|Victory", "Í∏ÄÎ°úÎ¶¨|Glory", "ÏïÑÎÑà|Honor", "Î∞úÎü¨|Valor", "Ïª§Î¶¨ÏßÄ|Courage", "Ïä§Ìä∏Î°±ÌôÄÎìú|Stronghold", "Î±ÖÍ∞ÄÎìú|Vanguard", "Î∂àÏõåÌÅ¨|Bulwark", "Îû®ÌååÌä∏|Rampart", "Î∞îÏä§Ìã∞Ïò®|Bastion", "ÏãúÌÉÄÎç∏|Citadel", "Ìè¨Ìä∏Î¶¨Ïä§|Fortress", "ÌÇµ|Keep", "ÌÉÄÏõå|Tower", "Ïõî|Wall", "Í≤åÏù¥Ìä∏|Gate", "Î∏åÎ¶øÏßÄ|Bridge", "Î™®Ìä∏|Moat", "ÎìúÎ°úÏö∞Î∏åÎ¶øÏßÄ|Drawbridge", "Ìè¨Ìä∏Ïª¨Î¶¨Ïä§|Portcullis", "Ïï†Î°úÏö∞Ìó§Îìú|Arrowhead", "Ïä§ÌîºÏñ¥Ìè¨Ïù∏Ìä∏|Spearpoint", "Î∏îÎ†àÏù¥ÎìúÏóêÏßÄ|Bladeedge", "ÏÜåÎìúÌûêÌä∏|Swordhilt", "Ïã§ÎìúÎ∞∞Ïâ¨|Shieldbash", "ÏïÑÎ®∏|Armor", "ÌÄ¥ÎùºÏä§|Cuirass", "Î∞îÏù¥Ï†Ä|Visor", "Îß®ÌãÄ|Mantle", "ÏºÄÏù¥ÌîÑ|Cape", "ÌÅ¥Î°ù|Cloak", "Î∞∞ÎÑà|Banner", "ÌîåÎûòÍ∑∏|Flag", "Ïä§ÌÉ†Îã§Îìú|Standard", "ÌéúÎçòÌä∏|Pennant"]
                },
                wizard: {
                    m: ["Î©ÄÎ¶∞|Merlin", "ÏïåÎ≤ÑÏä§|Albus", "Îß§Í∑∏ÎÑàÏä§|Magnus", "ÏΩîÎ•¥ÎÑ¨Î¶¨Ïö∞Ïä§|Cornelius", "Î∞úÌÉÄÏûêÎ•¥|Balthazar", "Ïπ¥Ïä§Ìçº|Casper", "Î©úÌÇ§Ïò§Î•¥|Melchior", "ÏïÑÎ•¥ÌÇ§Î©îÎç∞Ïä§|Archimedes", "ÌîºÌÉÄÍ≥†ÎùºÏä§|Pythagoras", "Ïú†ÌÅ¥Î¶¨Îìú|Euclid", "ÌîåÎùºÌÜ§|Plato", "ÏïÑÎ¶¨Ïä§ÌÜ†ÌÖîÎ†àÏä§|Aristotle", "ÏÜåÌÅ¨ÎùºÌÖåÏä§|Socrates", "Ìó§Î•¥Î©îÏä§|Hermes", "Ïò§Îîò|Odin", "Î°úÌÇ§|Loki", "ÌÜ†Î•¥|Thor", "Ï†úÏö∞Ïä§|Zeus", "Ìè¨ÏÑ∏Ïù¥Îèà|Poseidon", "ÌïòÎç∞Ïä§|Hades", "ÏïÑÌè¥Î°ú|Apollo", "ÎîîÏò§ÎãàÏÜåÏä§|Dionysus", "ÏïÑÎ†àÏä§|Ares", "Ìó§ÌååÏù¥Ïä§ÌÜ†Ïä§|Hephaestus", "ÌÅ¨Î°úÎÖ∏Ïä§|Chronos", "Ïö∞ÎùºÎÖ∏Ïä§|Uranus", "Í∞ÄÏù¥ÏïÑ|Gaia", "ÌÉÄÏù¥ÌÉÑ|Titan", "Í∏∞Í∞ÑÌÖåÏä§|Gigantes", "ÏÇ¨Ïù¥ÌÅ¥Î°≠Ïä§|Cyclops", "ÌîÑÎ°úÏä§ÌéòÎ°ú|Prospero", "ÌååÏö∞Ïä§Ìä∏|Faust", "ÏÜîÎ°úÎ™¨|Solomon", "ÏÇ¨Ïù¥Î®º|Simon", "Î©îÏù¥Í±∞Ïä§|Magus", "ÏÑ∏Ïù¥ÏßÄ|Sage", "ÏãúÏñ¥|Seer", "Ïò§ÎùºÌÅ¥|Oracle", "ÌîÑÎ°úÌïè|Prophet", "ÎîîÎ∞îÏù¥ÎÑà|Diviner", "ÏïÑÏù¥Ïò¨Î°úÏä§|Aeolus", "Î≥¥Î†àÏïÑÏä§|Boreas", "ÎÖ∏Ìà¨Ïä§|Notus", "Ï†úÌîºÎ°úÏä§|Zephyrus", "ÌûàÌéòÎ¶¨Ïò®|Hyperion", "Ïù¥ÏïÑÌéòÌà¨Ïä§|Iapetus", "ÏΩîÏù¥Ïò§Ïä§|Coeus", "ÌÅ¨Î¶¨Ïö∞Ïä§|Crius", "Ïò§ÏºÄÏïÑÎÖ∏Ïä§|Oceanus", "ÌÖåÌã∞Ïä§|Tethys", "ÎÑ§Î†àÏö∞Ïä§|Nereus", "ÌîÑÎ°úÌÖåÏö∞Ïä§|Proteus", "Ìä∏Î¶¨ÌÜ§|Triton", "ÏïÑÌãÄÎùºÏä§|Atlas", "ÌîÑÎ°úÎ©îÌÖåÏö∞Ïä§|Prometheus", "ÏóêÌîºÎ©îÌÖåÏö∞Ïä§|Epimetheus", "Ìó¨Î¶¨Ïò§Ïä§|Helios", "ÏÖÄÎ†àÎÑ§|Selene", "ÏóêÏò§Ïä§|Eos", "ÏïÑÏä§Ìä∏ÎùºÏù¥Ïò§Ïä§|Astraeus", "Ï°∞ÏãúÎ™®Ïä§|Zosimos", "ÏûêÎπÑÎ•¥|Jabir", "ÌååÎùºÏºàÏàòÏä§|Paracelsus", "ÏïÑÍ∑∏Î¶¨Ìåå|Agrippa", "Ï°¥Îîî|Dee", "ÏºàÎ¶¨|Kelly", "ÌîåÎùºÎ©ú|Flamel", "Î°úÏ††ÌÅ¨Î°úÏù¥Ï∏†|Rosencreutz", "ÏïÑÎ∏åÎùºÏπ¥Îã§Î∏åÎùº|Abra", "Ìò∏Ïª§Ïä§|Hocus", "Ìè¨Ïª§Ïä§|Pocus", "ÏïåÏºÄÎØ∏Ïä§Ìä∏|Alchemist", "ÎÑ§ÌÅ¨Î°úÎß®ÏÑú|Necromancer", "ÏÑúÎ®∏ÎÑà|Summoner", "Ïª®Ï†ÄÎü¨|Conjurer", "Ïù∏Ï±àÌÑ∞|Enchanter", "ÏùºÎ£®ÏÖîÎãàÏä§Ìä∏|Illusionist", "Ìä∏ÎûúÏä§ÎÆ§ÌÑ∞|Transmuter", "Ïï±Ï†ÄÎü¨|Abjurer", "Ïù∏Î≥¥Ïª§|Invoker", "Ïù¥Î≥¥Ïª§|Evoker", "ÌÉàÎ†àÏä§|Thales", "ÏïÑÎÇôÏãúÎßåÎìúÎ°úÏä§|Anaximander", "ÏïÑÎÇôÏãúÎ©îÎÑ§Ïä§|Anaximenes", "Ìó§ÎùºÌÅ¥Î†àÏù¥ÌÜ†Ïä§|Heraclitus", "ÌååÎ•¥Î©îÎãàÎç∞Ïä§|Parmenides", "Ïó†ÌéòÎèÑÌÅ¥Î†àÏä§|Empedocles", "ÏïÑÎÇôÏÇ¨Í≥†ÎùºÏä§|Anaxagoras", "Îç∞Î™®ÌÅ¨Î¶¨ÌÜ†Ïä§|Democritus", "ÏóêÌîºÏø†Î°úÏä§|Epicurus"],
                    f: ["Î™®Î•¥Í∞ÄÎÇò|Morgana", "ÌÇ§Î•¥ÏºÄ|Circe", "Î©îÎç∞Ïù¥ÏïÑ|Medea", "Ìó§Ïπ¥ÌÖå|Hecate", "ÏãúÎπå|Sybil", "Ïπ¥ÏÇ∞ÎìúÎùº|Cassandra", "ÌîºÌã∞ÏïÑ|Pythia", "Îã§ÌîÑÎÑ§|Daphne", "ÏóêÏΩî|Echo", "ÎÇòÎ•¥ÌÇ§ÏÜåÏä§|Narcissus", "ÌîÑÎ¶¨Ïïº|Freyja", "Ïù¥Îëî|Idun", "Ïä§Ïπ¥Îîî|Skadi", "Ìó¨|Hel", "ÏãúÌîÑ|Sif", "ÌîÑÎ¶¨Í∑∏|Frigg", "ÎÇúÎÇò|Nanna", "ÏóêÏù¥Î•¥|Eir", "Í≤åÌîºÏò®|Gefion", "ÌíÄÎùº|Fulla", "ÏÇ¨Í∞Ä|Saga", "ÏãúÍ∏¥|Sigyn", "ÎÖ∏Î•∏|Norn", "Î∞úÌÇ§Î¶¨|Valkyrie", "ÏóòÌîÑ|Elf", "ÌéòÏñ¥Î¶¨|Fairy", "ÌîΩÏãú|Pixie", "ÎãòÌîÑ|Nymph", "ÎìúÎùºÏù¥Ïñ¥Îìú|Dryad", "ÏÑ∏Ïù¥Î†å|Siren", "Î©îÎëêÏÇ¨|Medusa", "Ïä§ÌÖêÎÖ∏|Stheno", "ÏóêÏö∞Î¶¨ÏïåÎ†à|Euryale", "Í≥†Î•¥Í≥§|Gorgon", "ÌïòÌîº|Harpy", "Ïä§ÌïëÌÅ¨Ïä§|Sphinx", "ÌÇ§Î©îÎùº|Chimera", "ÌûàÎìúÎùº|Hydra", "ÎùºÎØ∏ÏïÑ|Lamia", "ÏóêÌÇ§ÎìúÎÇò|Echidna", "ÌîåÎ°úÎùº|Flora", "ÌååÏö∞ÎÇò|Fauna", "Ìó§Ïä§Ìã∞ÏïÑ|Hestia", "Îç∞Î©îÌÖåÎ•¥|Demeter", "ÌéòÎ•¥ÏÑ∏Ìè¨ÎÑ§|Persephone", "Î†àÏïÑ|Rhea", "ÌÖåÎØ∏Ïä§|Themis", "ÎØÄÎÑ§Î™®ÏãúÎÑ§|Mnemosyne", "Ìè¨Ïù¥Î≤†|Phoebe", "ÌÖåÏù¥ÏïÑ|Theia", "ÏπºÎ¶¨Ïò§Ìéò|Calliope", "ÌÅ¥Î¶¨Ïò§|Clio", "ÏóêÎùºÌÜ†|Erato", "ÏóêÏö∞ÌÖåÎ•¥Ìéò|Euterpe", "Î©úÌè¨Î©îÎÑ§|Melpomene", "Ìè¥Î¶¨ÌûòÎãàÏïÑ|Polyhymnia", "ÌÖåÎ•¥ÌîÑÏãúÏΩîÎ†à|Terpsichore", "ÌÉàÎ¶¨ÏïÑ|Thalia", "Ïö∞ÎùºÎãàÏïÑ|Urania", "ÎÑ§Î©îÏãúÏä§|Nemesis", "ÏãúÎπåÎùº|Sibylla", "Î≥ºÎ∞î|Volva", "ÏÑ∏Ïù¥Ï¶à|Seidr", "ÌååÏãúÌååÏóê|Pasiphae", "ÏïÑÎ¶¨ÏïÑÎìúÎÑ§|Ariadne", "ÌååÏù¥ÎìúÎùº|Phaedra", "ÌîÑÎ°úÌÅ¨Î¶¨Ïä§|Prokris", "ÌïÑÎ°úÎ©úÎùº|Philomela", "ÌîÑÎ°úÌÅ¨ÎÑ§|Procne", "ÏïåÌÇ§Ïò§ÎÑ§|Alcyone", "ÏºÄÏù¥Î¶≠Ïä§|Ceyx", "Ïù¥Ïò§|Io", "ÏÑ∏Î©úÎ†à|Semele", "Îã§ÎÇòÏóê|Danae", "Î†àÎã§|Leda", "ÏïåÌÅ¨Î©îÎÑ§|Alcmene", "Ïù¥Ïò§Ïπ¥Ïä§ÌÖå|Jocasta", "ÏïàÎìúÎ°úÎßàÏºÄ|Andromache", "Ìó§Ïø†Î∞î|Hecuba", "Ìè¥Î¶≠ÏÑ∏ÎÇò|Polyxena", "ÌÅ¨Î†àÏö∞ÏÇ¨|Creusa", "Ïù¥ÌîºÍ≤åÎÑ§Ïù¥ÏïÑ|Iphigeneia", "ÏóòÎ†âÌä∏Îùº|Electra", "ÌÅ¥Î¶¨ÌÉÄÏûÑÎÑ§Ïä§Ìä∏Îùº|Clytemnestra", "ÏïÑÌä∏Î°úÌè¨Ïä§|Atropos", "ÎùºÏºÄÏãúÏä§|Lachesis", "ÌÅ¥Î°úÌÜ†|Clotho", "Ìã∞ÏãúÌè¨ÎÑ§|Tisiphone", "Î©îÍ∞ÄÎùº|Megaera", "ÏïåÎ†âÌÜ†|Alecto"],
                    s: ["Ïä§ÌÉÄ|Star", "Î¨∏|Moon", "ÏÑ†|Sun", "Ïä§Ïπ¥Ïù¥|Sky", "ÌÅ¥ÎùºÏö∞Îìú|Cloud", "Î†àÏù∏|Rain", "Ïä§ÎÖ∏Ïö∞|Snow", "ÏúàÎìú|Wind", "Ïä§ÌÜ∞|Storm", "Ïç¨Îçî|Thunder", "ÎùºÏù¥Ìä∏Îãù|Lightning", "ÌååÏù¥Ïñ¥|Fire", "ÏõåÌÑ∞|Water", "ÏïÑÏù¥Ïä§|Ice", "Ïñ¥Ïä§|Earth", "ÎÑ§Ïù¥Ï≤ò|Nature", "ÎùºÏù¥ÌîÑ|Life", "Îç∞Ïä§|Death", "Ïä§ÌîºÎ¶ø|Spirit", "ÏÜåÏö∏|Soul", "ÎßàÏù∏Îìú|Mind", "ÌÉÄÏûÑ|Time", "Ïä§ÌéòÏù¥Ïä§|Space", "Î≥¥Ïù¥Îìú|Void", "Ïπ¥Ïò§Ïä§|Chaos", "Ïò§Îçî|Order", "Î°úÏßÅ|Logic", "Îß§ÏßÅ|Magic", "ÎØ∏Ïä§Ìã±|Mystic", "ÏïÑÏºÄÏù∏|Arcane", "ÏΩîÎ©ß|Comet", "ÏïÑÏä§ÌÖåÎ°úÏù¥Îìú|Asteroid", "Î©îÌÖåÏò§|Meteor", "Í∞§Îü≠Ïãú|Galaxy", "ÎÑ§Î∑∏Îùº|Nebula", "ÏΩîÏä§Î™®Ïä§|Cosmos", "Ïú†ÎãàÎ≤ÑÏä§|Universe", "ÏõîÎìú|World", "ÌîåÎûòÎãõ|Planet", "ÌîåÎ†àÏù∏|Plane", "ÎîîÎ©òÏÖò|Dimension", "Î†êÎ¶Ñ|Realm", "Ï°¥|Zone", "ÏóêÏñ¥Î¶¨Ïñ¥|Area", "Î¶¨Ï†Ñ|Region", "Ïä§Ìé†|Spell", "Ï∞∏|Charm", "Ìó•Ïä§|Hex", "Ïª§Ïä§|Curse", "ÏõåÎìú|Ward", "Î£¨|Rune", "ÏãúÍ∏∏|Sigil", "Í∏ÄÎ¶¨ÌîÑ|Glyph", "ÎßàÌÅ¨|Mark", "ÏÇ¨Ïù∏|Sign", "Ïò§Îùº|Aura", "ÎßàÎÇò|Mana", "ÏóêÌÖåÎ•¥|Ether", "ÏóêÏÑºÏä§|Essence", "ÏóòÎ¶¨Î®ºÌä∏|Element", "Ïä§ÌÉÄÎùºÏù¥Ìä∏|Starlight", "Î¨∏ÎùºÏù¥Ìä∏|Moonlight", "ÏÑ†ÎùºÏù¥Ìä∏|Sunlight", "Ïä§ÌÉÄÎçîÏä§Ìä∏|Stardust", "Î¨∏ÎçîÏä§Ìä∏|Moondust", "ÏÑ†ÎçîÏä§Ìä∏|Sundust", "Ïä§ÌÉÄÌååÏù¥Ïñ¥|Starfire", "Î¨∏ÌååÏù¥Ïñ¥|Moonfire", "ÏÑ†ÌååÏù¥Ïñ¥|Sunfire", "Ïä§ÌÉÄÏÉ§Ïù∏|Starshine", "Î¨∏Îπî|Moonbeam", "ÏÑ†Îπî|Sunbeam", "Ïä§ÌÉÄÌè¥|Starfall", "Î¨∏ÎùºÏù¥Ï¶à|Moonrise", "ÏÑ†ÎùºÏù¥Ï¶à|Sunrise", "Ïä§ÌÉÄÏõåÏπò|Starwatch", "Î¨∏ÏõåÏπò|Moonwatch", "ÏÑ†ÏõåÏπò|Sunwatch", "Ìä∏ÏôÄÏùºÎùºÏûá|Twilight", "ÎçîÏä§ÌÅ¨|Dusk", "Îçò|Dawn", "ÎØ∏ÎìúÎÇòÏûá|Midnight", "Îàà|Noon", "Ïù¥ÌÅ¥Î¶ΩÏä§|Eclipse", "ÏÜîÏä§Ìã∞Ïä§|Solstice", "Ïù¥ÏøºÎÖπÏä§|Equinox", "Ìò∏ÎùºÏù¥Ï¶å|Horizon", "Ï†úÎãàÏä§|Zenith", "ÎÇòÎîîÎ•¥|Nadir", "Ïò§Î°úÎùº|Aurora"]
                },
                commoner: {
                    m: ["Ï°¥|John", "Ï†úÏûÑÏä§|James", "ÌÜ∞|Tom", "Ïû≠|Jack", "Îπå|Bill", "Î∞•|Bob", "ÏÉò|Sam", "ÎåÑ|Dan", "Ìè¥|Paul", "ÎßàÌÅ¨|Mark", "Î£®ÌÅ¨|Luke", "Îß§Ìäú|Matthew", "ÌîºÌÑ∞|Peter", "Ïï§ÎìúÎ•ò|Andrew", "ÌïÑÎ¶Ω|Philip", "ÌÜ†ÎßàÏä§|Thomas", "Ï°∞ÏÖâ|Joseph", "Ï∞∞Ïä§|Charles", "Îç∞Ïù¥ÎπÑÎìú|David", "Î¶¨Ï∞®Îìú|Richard", "Î°úÎ≤ÑÌä∏|Robert", "ÏúåÎ¶¨ÏóÑ|William", "Ï°∞ÏßÄ|George", "ÏóêÎìúÏõåÎìú|Edward", "Ìó®Î¶¨|Henry", "ÌîÑÎû≠ÌÅ¨|Frank", "Ìï¥Î¶¨|Harry", "Ïä§Ìã∞Î∏å|Steve", "ÏïÑÎã¥|Adam", "Î≤§|Ben", "Ï†úÏù¥ÏΩ•|Jacob", "ÎßàÏù¥ÌÅ¥|Michael", "Ï°∞ÏäàÏïÑ|Joshua", "Îã§ÎãàÏóò|Daniel", "ÌÅ¨Î¶¨Ïä§ÌÜ†Ìçº|Christopher", "ÏïàÏÜåÎãà|Anthony", "ÎèÑÎÑêÎìú|Donald", "ÏºÄÎÑ§Ïä§|Kenneth", "Ïä§Ìã∞Î∏ê|Steven", "Î∏åÎùºÏù¥Ïñ∏|Brian", "Î°úÎÇ†Îìú|Ronald", "ÏºÄÎπà|Kevin", "Ï†úÏù¥Ïä®|Jason", "Ï†úÌîÑÎ¶¨|Jeffrey", "ÎùºÏù¥Ïñ∏|Ryan", "Í≤åÎ¶¨|Gary", "ÎãàÏΩúÎùºÏä§|Nicholas", "ÏóêÎ¶≠|Eric", "Ï°∞ÎÇòÎã®|Jonathan", "Ï†ÄÏä§Ìã¥|Justin", "Ïä§ÏΩß|Scott", "Î∏åÎûúÎì†|Brandon", "Î≤§ÏûêÎØº|Benjamin", "ÏÇ¨Î¨¥Ïóò|Samuel", "Í∑∏Î†àÍ≥†Î¶¨|Gregory", "ÏïåÎ†âÏÇ∞Îçî|Alexander", "Ìå®Ìä∏Î¶≠|Patrick", "Î†àÏù¥Î™¨Îìú|Raymond", "Îç∞ÎãàÏä§|Dennis", "Ï†úÎ¶¨|Jerry", "ÎûÑÌîÑ|Ralph", "Î°úÏ†Ä|Roger", "Î°úÏù¥|Roy", "Îü¨ÏÖÄ|Russell", "ÏÑ∏Ïä§|Seth", "ÏâêÏù∏|Shane", "ÏàÄ|Shawn", "ÏÇ¨Ïù¥Î®º|Simon", "Ïä§ÌéúÏÑú|Spencer", "Ïä§ÌÉ†Î¶¨|Stanley", "Ïä§ÌäúÏñ¥Ìä∏|Stuart", "ÌÖåÎìú|Ted", "ÌÖåÎ¶¨|Terry", "ÌåÄ|Tim", "Ìã∞Î™®Ïãú|Timothy", "ÌÜ†ÎπÑ|Toby", "ÌÜ†Îìú|Todd", "ÌÜ†Îãà|Tony", "ÎπàÏÑºÌä∏|Vincent", "Ïõ®Ïù∏|Wayne", "ÎçîÍ∏ÄÎùºÏä§|Douglas", "Ïú†ÏßÑ|Eugene", "Î°úÎ†åÏä§|Lawrence", "Í∞ÄÎ∏åÎ¶¨Ïóò|Gabriel", "Ïò§Ïä§Ìã¥|Austin", "Ïπº|Carl", "ÌÅ¨Î¶¨Ïä§|Chris", "Ïπ¥Î©îÎ°†|Cameron", "ÏΩîÎÑà|Connor", "ÏºÄÏùºÎüΩ|Caleb"],
                    f: ["Î©îÎ¶¨|Mary", "ÏïàÎÇò|Anna", "Ïó†Îßà|Emma", "ÏÇ¨Îùº|Sarah", "ÏóòÎ¶¨Ïä§|Alice", "Î£®Ïãú|Lucy", "Í∑∏Î†àÏù¥Ïä§|Grace", "Î°úÏ¶à|Rose", "Î¶¥Î¶¨|Lily", "Ï†úÏù∏|Jane", "ÏºÄÏù¥Ìä∏|Kate", "Ï§ÑÎ¶¨|Julie", "ÏóêÏù¥ÎØ∏|Amy", "Î¶¨ÏÇ¨|Lisa", "Î≤†Ìã∞|Betty", "Ìó¨Î†å|Helen", "ÎèÑÎ°úÏãú|Dorothy", "ÎßàÍ∞ÄÎ†õ|Margaret", "Î£®Ïä§|Ruth", "ÌÅ¥ÎùºÎùº|Clara", "ÏóêÎ∞ÄÎ¶¨|Emily", "ÏÜåÌîº|Sophie", "ÎØ∏ÏïÑ|Mia", "ÌÅ¥Î°úÏù¥|Chloe", "ÏïÑÎ¶¨ÏïÑ|Aria", "Ï°∞Ïù¥|Zoe", "ÎÖ∏Îùº|Nora", "ÏïÑÏù¥ÎπÑ|Ivy", "Î£®ÎÇò|Luna", "Î≤®Îùº|Bella", "Ìå®Ìä∏Î¶¨ÏÉ§|Patricia", "Ï†úÎãàÌçº|Jennifer", "Î¶∞Îã§|Linda", "ÏóòÎ¶¨ÏûêÎ≤†Ïä§|Elizabeth", "Î∞îÎ∞îÎùº|Barbara", "ÏàòÏûî|Susan", "Ï†úÏãúÏπ¥|Jessica", "Ïπ¥Î†å|Karen", "ÎÇ∏Ïãú|Nancy", "ÏÇ∞ÎìúÎùº|Sandra", "Ïï†ÏäêÎ¶¨|Ashley", "ÌÇ¥Î≤åÎ¶¨|Kimberly", "ÎèÑÎÇò|Donna", "ÎØ∏ÏÖ∏|Michelle", "Ï∫êÎ°§|Carol", "ÏïÑÎßåÎã§|Amanda", "Î©úÎ¶¨ÏÇ¨|Melissa", "Îç∞Î≥¥Îùº|Deborah", "Ïä§ÌÖåÌååÎãà|Stephanie", "Î†àÎ≤†Ïπ¥|Rebecca", "Î°úÎùº|Laura", "ÏÉ§Î°†|Sharon", "Ïã†ÏãúÏïÑ|Cynthia", "Ï∫êÏä¨Î¶∞|Kathleen", "ÏÖúÎ¶¨|Shirley", "ÏóêÏù¥ÎØ∏|Amy", "ÏïàÏ†§Îùº|Angela", "Î∏åÎ†åÎã§|Brenda", "ÌååÎ©úÎùº|Pamela", "ÎãàÏΩú|Nicole", "ÏÉêÎ¶¨|Sally", "ÏÇ¨ÎßåÎã§|Samantha", "ÏÇ¨ÏÉ§|Sasha", "Ïä§ÏπºÎ†õ|Scarlett", "ÏÖÄÎ†àÎÇò|Selena", "ÏÑ∏Î†àÎÇò|Serena", "ÏÑÄÎÑå|Shannon", "Ïâ¥Îùº|Sheila", "ÏâêÎ¶¨|Sherry", "Ïã§ÎπÑÏïÑ|Silvia", "ÏãúÎ™¨|Simone", "ÏÜåÎãàÏïÑ|Sonia", "Ïä§ÌÖåÏù¥Ïãú|Stacy", "Ïä§ÌÖîÎùº|Stella", "Ïàò|Sue", "ÏàòÏûî|Suzanne", "Ìã∞ÎÇò|Tina", "Ìä∏Î†àÏù¥Ïãú|Tracy", "Î∞îÎÑ§ÏÇ¨|Vanessa", "Ïõ¨Îîî|Wendy", "Ïù¥Î≥∏|Yvonne", "Ïò§ÎìúÎ¶¨|Audrey", "ÎπÑÎ≤åÎ¶¨|Beverly", "Îã§Ïù¥Ïï§|Diane", "ÏóêÎ∏îÎ¶∞|Evelyn", "Í∏ÄÎ°úÎ¶¨ÏïÑ|Gloria", "Ìó§Ïù¥Ï¶ê|Hazel", "Ï£ºÎîî|Judy", "Î£®Ïù¥Ïä§|Lois", "ÎßàÏÇ¨|Martha"],
                    s: ["Ïä§ÎØ∏Ïä§|Smith", "Î∞ÄÎü¨|Miller", "Î≤†Ïù¥Ïª§|Baker", "Ïø°|Cook", "ÌîºÏÖî|Fisher", "ÌóåÌÑ∞|Hunter", "Ïπ¥ÌéúÌÑ∞|Carpenter", "ÌÖåÏùºÎü¨|Taylor", "ÏúÑÎ≤Ñ|Weaver", "ÌÑ∞ÎÑà|Turner", "Ïø†Ìçº|Cooper", "Î©îÏù¥Ïä®|Mason", "Ìè¨ÌÑ∞|Potter", "Î∞îÎ≤Ñ|Barber", "Í∞ÄÎìúÎÑà|Gardner", "ÌååÎ®∏|Farmer", "ÏÖ∞ÌçºÎìú|Shepherd", "Ïπ¥ÌÑ∞|Carter", "ÎùºÏù¥Ìä∏|Wright", "ÏõåÏª§|Walker", "ÌôÄ|Hall", "Ìûê|Hill", "Ïö∞Îìú|Wood", "Í∑∏Î¶∞|Green", "Î∏åÎùºÏö¥|Brown", "ÌôîÏù¥Ìä∏|White", "Î∏îÎûô|Black", "Î°±|Long", "ÏáºÌä∏|Short", "ÏòÅ|Young", "ÌîåÎ†àÏ≤ò|Fletcher", "ÏÜåÏù¥Ïñ¥|Sawyer", "ÌÉúÎÑà|Tanner", "Î∏åÎ£®Ïñ¥|Brewer", "Ïä¨Î†àÏù¥ÌÑ∞|Slater", "ÎåÄÏ≤ò|Thatcher", "Ï±àÎì§Îü¨|Chandler", "ÏΩúÎ¶¨Ïñ¥|Collier", "ÏõπÏä§ÌÑ∞|Webster", "Ïä§Ïø†ÎÑà|Schooner", "Ïõ®Ïù¥ÎÑà|Wainer", "ÌååÏª§|Parker", "Î∏åÎ£©|Brook", "Î¶¨Î≤Ñ|River", "Î†àÏù¥ÌÅ¨|Lake", "Ìè∞Îìú|Pond", "ÌíÄ|Pool", "Ïõ∞|Well", "Ïä§ÌîÑÎßÅ|Spring", "Ïä§Ìä∏Î¶º|Stream", "Ìè¨Î†àÏä§Ìä∏|Forest", "Í∑∏Î°úÎ∏å|Grove", "Ïò§Ï∞®Îìú|Orchard", "Í∞ÄÎì†|Garden", "ÌååÌÅ¨|Park", "Î©îÎèÑÏö∞|Meadow", "ÌïÑÎìú|Field", "Î¨¥Ïñ¥|Moor", "ÌûàÏä§|Heath", "ÎßàÏâ¨|Marsh", "ÌîåÎùºÏö∞Îß®|Ploughman", "ÌóàÏ¶àÎß®|Herdsman", "ÌååÏö∏Îü¨|Fowler", "Ìè¨Î†àÏä§ÌÑ∞|Forester", "Ï°∞Ïù¥ÎÑà|Joiner", "Ìú†ÎùºÏù¥Ìä∏|Wheelwright", "Ïõ®Ïù∏ÎùºÏù¥Ìä∏|Wainwright", "Ïπ¥Ìä∏ÎùºÏù¥Ìä∏|Cartwright", "Î®∏ÏÑú|Mercer", "ÎìúÎ†àÏù¥Ìçº|Draper", "Ïä§ÌÇ®ÎÑà|Skinner", "ÏÉàÎì§Îü¨|Saddler", "ÏäàÎ©îÏù¥Ïª§|Shoemaker", "ÏΩîÎ∏îÎü¨|Cobbler", "ÏïÑÏù¥Ïñ∏|Iron", "Ïä§ÌÜ§|Stone", "Î∏åÎ¶≠|Brick", "Ïï†Ïâ¨|Ash", "Î≤ÑÏπò|Birch", "Ïò§ÌÅ¨|Oak", "ÏóòÎ¶Ñ|Elm", "ÌååÏù∏|Pine", "Î©îÏù¥Ìîå|Maple", "ÏãúÎçî|Cedar", "Ïèú|Thorn", "Î≤†Î¶¨|Berry", "Î∂ÄÏãú|Bush", "Ìó§ÏßÄ|Hedge", "Î∞òÏä§|Barnes", "Î∏åÎ¶øÏßÄÏä§|Bridges"]
                },
                servant: {
                    m: ["Ìïç|Pip", "Îèï|Dob", "ÌÇ§Ìçº|Kiper", "ÎãàÎ™®|Nimo", "ÌÜ†ÎπÑ|Toby", "Î°úÎπà|Robin", "ÌçΩ|Puck", "Î∞îÎãà|Barney", "ÌÖåÎîî|Teddy", "ÎπåÎ¶¨|Billy", "ÏßÄÎØ∏|Jimmy", "Ìã∞ÎØ∏|Timmy", "ÌÜ†ÎØ∏|Tommy", "Î∞îÎπÑ|Bobby", "Î≤†Îãà|Benny", "Î¶¨ÌÇ§|Ricky", "ÎØ∏ÌÇ§|Micky", "ÎãàÌÇ§|Nicky", "ÎπÑÌÇ§|Vicky", "ÏΩîÏΩî|Coco", "Î™®Î™®|Momo", "ÌÜ†ÌÜ†|Toto", "Î£®Î£®|Lulu", "ÌéòÌéò|Pepe", "Ìè¨Ìè¨|Popo", "Ïπ©|Chip", "Ïä§ÌÇµ|Skip", "ÌîåÎ¶Ω|Flip", "Ìä∏Î¶Ω|Trip", "Îãô|Nip", "Ïã≠|Sip", "Îî•|Dip", "Î¶Ω|Lip", "Ìûô|Hip", "ÌåÅ|Tip", "Îπà|Bean", "ÎÑõ|Nut", "ÏãúÎìú|Seed", "ÏΩò|Corn", "ÎùºÏù¥Ïä§|Rice", "Ïò§Ìä∏|Oat", "ÏúÑÌä∏|Wheat", "ÎùºÏù¥|Rye", "Î∞úÎ¶¨|Barley", "Î™∞Ìä∏|Malt", "Ïø†ÌÇ§|Cookie", "ÌÅ¨ÎûòÏª§|Cracker", "Î®∏ÌïÄ|Muffin", "ÎèÑÎÑõ|Donut", "Î≤†Ïù¥Í∏Ä|Bagel", "Î≤à|Bun", "Î°§|Roll", "ÌÉÄÌä∏|Tart", "ÌååÏù¥|Pie", "ÏºÄÏù¥ÌÅ¨|Cake", "Îπï|Bip", "Î∞•|Bop", "Îπî|Bim", "Î∞§|Bam", "Î¥Ñ|Bom", "Î≤ï|Bub", "Îπï|Bib", "Î∞•|Bab", "Î±Å|Beb", "Ìéç|Pup", "Ìåù|Pop", "Ìé©|Pep", "Ìåπ|Pap", "Îç§|Dum", "Îîî|Dee", "Îëê|Doo", "Îã§|Dah", "Ïïº|Yah", "Ïöî|Yo", "Ïú†|Yu", "ÏôÄ|Wa", "Ïõå|Wo", "ÏúÑ|We", "ÏßÄ|Zi", "Ï£º|Zu", "Ï†ú|Ze", "Ïûê|Za", "Í∏∞|Gi", "Íµ¨|Gu", "Í∞ú|Ga"],
                    f: ["ÎØ∏ÎØ∏|Mimi", "ÎÇòÎÇò|Nana", "Î¶¨Î¶¨|Lili", "ÏäàÏäà|Shushu", "ÏπòÏπò|Chichi", "ÏΩîÏΩî|Coco", "ÎπÑÎπÑ|Bibi", "ÎùºÎùº|Lala", "ÎîîÎîî|Didi", "ÌÇ§ÌÇ§|Kiki", "Ìã∞Ìã∞|Titi", "ÏßÄÏßÄ|Gigi", "ÌîºÌîº|Pipi", "Î©îÎ©î|Meme", "ÎÑ§ÎÑ§|Nene", "Î°úÎ°ú|Roro", "ÏÜåÏÜå|Soso", "ÏöîÏöî|Yoyo", "Ï£ºÏ£º|Juju", "Ï∞®Ï∞®|Chacha", "Ïπ¥Ïπ¥|Kaka", "ÌÉÄÌÉÄ|Tata", "ÌååÌåå|Papa", "ÌïòÌïò|Haha", "Ìò∏Ìò∏|Hoho", "ÌîºÌîº|Fifi", "ÏãúÏãú|Sisi", "ÎπÑÎπÑ|Vivi", "Î¶¨Î¶¨|Riri", "ÏßÄÏßÄ|Zizi", "Î≤†Î≤†|Bebe", "ÏÑ∏ÏÑ∏|Cece", "Îç∞Îç∞|Dede", "ÌÇ§ÌÇ§|Kiki", "ÎØ∏ÎØ∏|Mimi", "Î°úÏ¶à|Rose", "Î¶¥Î¶¨|Lily", "Îç∞Ïù¥ÏßÄ|Daisy", "Ìä§Î¶Ω|Tulip", "Ìå¨ÏßÄ|Pansy", "ÌîºÏò§Îãà|Peony", "Ïò§ÌÇ§Îìú|Orchid", "Î°úÌÑ∞Ïä§|Lotus", "Ïû¨Ïä§ÎØº|Jasmine", "ÏïÑÏù¥Î¶¨Ïä§|Iris", "Î∞îÏù¥Ïò¨Î†õ|Violet", "Ìè¨Ìîº|Poppy", "Î©îÎ¶¨Í≥®Îìú|Marigold", "ÌôÄÎ¶¨|Holly", "ÏïÑÏù¥ÎπÑ|Ivy", "ÌéÄ|Fern", "Î™®Ïä§|Moss", "ÌÅ¥Î°úÎ≤Ñ|Clover", "ÎØºÌä∏|Mint", "Î∞îÏßà|Basil", "ÌååÌåå|Fafa", "Ìë∏Ìë∏|Fufu", "ÌéòÌéò|Fefe", "ÏÇ¨ÏÇ¨|Sasa", "ÏàòÏàò|Susu", "ÏÑ∏ÏÑ∏|Sese", "Î∞îÎ∞î|Vava", "Î∂ÄÎ∂Ä|Vuvu", "Î≤†Î≤†|Veve", "ÏûêÏûê|Zaza", "Ï£ºÏ£º|Zuzu", "Ï†úÏ†ú|Zeze", "ÎÇòÎÇò|Nona", "ÎãàÎÇò|Nina", "ÎàÑÎàÑ|Nunu", "ÎÑ§ÎÑ§|Nene", "ÎßàÎßà|Mama", "Î¨¥Î¨¥|Mumu", "Î©îÎ©î|Meme", "ÎùºÎùº|Lara", "Î£®Î£®|Lulu", "Î†àÎ†à|Lele", "Ïπ¥Ïπ¥|Kaka", "Ïø†Ïø†|Kuku", "ÏºÄÏºÄ|Keke", "ÌÉÄÌÉÄ|Tata", "Ìà¨Ìà¨|Tutu", "ÌÖåÌÖå|Tete", "ÏôÄÏôÄ|Wawa", "Ïö∞Ïö∞|Wuwu"],
                    s: ["(ÏÑ± ÏóÜÏùå)|", "(ÏÑ± ÏóÜÏùå)|", "(ÏÑ± ÏóÜÏùå)|", "(ÏÑ± ÏóÜÏùå)|", "(ÏÑ± ÏóÜÏùå)|", "Ìíã|Foot", "Ìï∏Îìú|Hand", "ÏïÑÏù¥|Eye", "Ïù¥Ïñ¥|Ear", "ÎÖ∏Ï¶à|Nose", "ÎßàÏö∞Ïä§|Mouth", "Ìó§Îìú|Head", "Ïïî|Arm", "Î†àÍ∑∏|Leg", "ÌïëÍ±∞|Finger", "ÌÜ†|Toe", "Î∞îÎîî|Body", "Î∞±|Back", "Î≤®Î¶¨|Belly", "Ìó§Ïñ¥|Hair", "Ïä§ÌÇ®|Skin", "Î≥∏|Bone", "Î∏îÎü¨Îìú|Blood", "ÌïòÌä∏|Heart", "ÎßàÏù∏Îìú|Mind", "ÌéòÎ∏î|Pebble", "Ïä§ÌÜ§|Stone", "ÎùΩ|Rock", "ÏÉåÎìú|Sand", "ÎçîÏä§Ìä∏|Dust", "ÎçîÌä∏|Dirt", "Î®∏Îìú|Mud", "ÌÅ¥Î†àÏù¥|Clay", "Ïã§Ìä∏|Silt", "Î°úÏïî|Loam", "Í∑∏ÎûòÎ∏î|Gravel", "Î≥ºÎçî|Boulder", "Î∏åÎ¶≠|Brick", "ÌÉÄÏùº|Tile", "Ïä¨Î†àÏù¥Ìä∏|Slate", "Ïö∞Îìú|Wood", "Î°úÍ∑∏|Log", "Ïä§Ìã±|Stick", "Î∏åÎûúÏπò|Branch", "Ìä∏ÏúÑÍ∑∏|Twig", "Î¶¨ÌîÑ|Leaf", "Î£®Ìä∏|Root", "Î∞îÌÅ¨|Bark", "Ïä§ÌÖú|Stem", "Ïèú|Thorn", "Ïî®Îìú|Seed", "ÎÑõ|Nut", "Ïâò|Shell", "ÌóàÏä§ÌÅ¨|Husk", "ÌïÑ|Peel", "ÌÅ¨Îüº|Crumb", "Ïä§Ìéô|Speck", "Îã∑|Dot", "Î™®Ìä∏|Mote", "ÌîåÎ†â|Fleck", "ÎπÑÌä∏|Bit", "Ïä§ÌÅ¨Îû©|Scrap", "ÏÉ§Îìú|Shard", "Ïπ©|Chip", "ÌîÑÎûòÍ∑∏Î®ºÌä∏|Fragment", "ÌîºÏä§|Piece", "ÌååÌä∏|Part", "Ìè¨ÏÖò|Portion", "ÏÑπÏÖò|Section", "Ïä¨ÎùºÏù¥Ïä§|Slice", "Ï≤≠ÌÅ¨|Chunk", "ÎüºÌîÑ|Lump", "ÌÅ¥ÎüºÌîÑ|Clump", "ÏôÄÎìú|Wad", "ÌóùÌÅ¨|Hunk", "ÎìúÎ°≠|Drop", "ÎπÑÎìú|Bead", "Î∏îÎ°≠|Blob", "Í∏ÄÎ°≠|Glob", "ÎåÄÏâ¨|Dash", "ÌïÄÏπò|Pinch", "Ïä§ÎØ∏Ï†Ñ|Smidgen", "Ìä∏Î†àÏù¥Ïä§|Trace", "ÌûåÌä∏|Hint", "ÏúÑÏä§Ìçº|Whisper"]
                }
            },
            wuxia: {
                noble: {
                    m: ["Ï≤≠Î™Ö", "Î∞±Ïö¥", "Î¨¥ÏßÑ", "ÏûêÏö¥", "ÌÉúÏùÑ", "Ï≤úÏö∞", "Î™ÖÏö¥", "ÏßÑÏ≤ú", "Ìò∏Ïó∞", "ÏÉÅÌòÑ", "Ïö¥Î£°", "ÌòÑÏßÑ", "ÎèÑÌòÑ", "Î¨∏Í∏∞", "ÌïôÍ∑ú", "ÏÜåÏú†", "Í±¥ÏòÅ", "ÏãúÏö¥", "Í∑úÌôî", "Îã®Ïö∞", "Ï≤≠Ïö¥", "Ïú†ÏÑ±", "ÎπÑÏ≤ú", "Î¨¥Í≤Ω", "ÌòÑÎèÑ", "ÏûêÌïò", "ÏùºÏ≤≠", "ÏÜåÎ∞±", "Ïö¥ÏóΩ", "Ï≤úÍ∏∞", "ÌòïÏö¥", "ÏßÄÌïô", "ÌòÑÎ¨¥", "Ï≤≠Ìóà", "Î¨¥ÏòÅ", "ÏßÑÏö∞", "Í≤ΩÏàò", "ÌÉúÏÇ∞", "Ïö¥Ï§ë", "Ìò∏ÏòÅ", "Ï≤úÍ¥ë", "ÎÇôÏö¥", "ÏãúÌòÑ", "Í∑úÏó∞", "Î∞±Ï≤ú", "ÏÜ°Ïö¥", "ÌïôÏßÑ", "Ïú†ÎèÑ", "ÌòÑÏÑ±", "ÏßÑÌòÅ", "Ïö¥ÌòÑ", "ÏÉÅÏõê", "ÏàòÌòÑ", "Í≤ΩÏö¥", "ÎèÑÏõê", "Î¨¥Í∑π", "Ï≤≠Îûå", "ÌôîÏö¥", "ÏßÑÎ™Ö", "Ï≤úÏúÑ"],
                    f: ["ÏÜåÏó∞", "ÌôîÎ¶∞", "Ï≤≠ÏïÑ", "Ïú†ÎûÄ", "Î∞±ÏÑ§", "ÏûêÎ†π", "Î™ÖÏ£º", "ÏÑ§Ìôî", "ÏòàÎ¶∞", "Ïú†Ìôî", "ÎπôÏòà", "ÏÜåÌñ•", "Ï±ÑÎ†π", "ÏùÄÏÑ§", "ÏàòÎ†®", "ÌôçÎ†®", "Îã®ÏòÅ", "ÎØ∏Î†π", "ÏÜåÏõî", "ÏûêÌïò", "Ïó∞Ìù¨", "ÏÑúÏó∞", "ÎπÑÎûÄ", "ÏïÑÏòÅ", "Ï≤≠Ï°∞", "Ïú†Î¶¨", "Í∞ÄÏùÑ", "ÏÑ§ÏßÄ", "ÌôîÏòÅ", "ÎÇúÌñ•", "Ïò•Î†®", "ÏàòÏïÑ", "ÏßÄÏÑ†", "ÌòúÏßÑ", "ÎÇòÏòÅ", "Ïö∞Ìù¨", "ÏÜåÏÑ†", "ÎπÑÏó∞", "ÌòÑÏ£º", "ÏõîÌù¨", "Í∏àÏÑ†", "Ï±ÑÏö¥", "ÏÜåÏú†", "Î™ÖÌïò", "ÏßÑÏ£º", "ÏÑ§Ìù¨", "Ïö¥Î†π", "Ï≤≠Ïú†", "ÌïòÎäò", "ÏùÄÌïò"],
                    s: ["ÎÇ®Í∂Å", "Ï†úÍ∞à", "Î™®Ïö©", "Ìô©Î≥¥", "ÏÇ¨Îßà", "ÎèÖÍ≥†", "ÏÑ†Ïö∞", "ÏÉÅÍ¥Ä", "Íµ¨Ïñë", "ÏïºÏú®", "Í≥µÏÜê", "ÏÑúÎ¨∏", "ÎèôÎ∞©", "ÌóåÏõê", "ÌïòÌõÑ", "Ïö∞Î¨∏", "Î∞±Î¶¨", "Î∂ÅÍ∂Å", "ÏûêÎßê", "Îã®Î™©", "ÏßÑ", "Î∞±", "Ïù¥", "Ïôï", "Ïú†", "Ïû•", "Ïö¥", "Ìíç", "Îáå", "ÏûÑ", "Ìïú", "Ï°∞", "ÏÜ°", "Ï†ï", "Ïñë", "Ìïò", "Ïò§", "ÏÑú", "Ïú§", "Í∞ï", "Í≥†", "Ïõê", "Í≥Ω", "Ï£º", "Ï±Ñ"]
                },
                villain: {
                    m: ["ÌòàÎπÑ", "Ï≤úÏïÖ", "Î¨¥Í≤∞", "Í¥ëÌòÑ", "Ìå®Ï≤ú", "ÎßàÎ†π", "ÎèÖÏã¨", "ÏÇ¥Ìòº", "Í¥ëÎßà", "ÏóºÎùº", "ÌùëÏ£º", "ÏÇ¨Ïã†", "ÌååÏ≤ú", "Î©∏Ìòº", "Í∑ÄÏòÅ", "ÏïÖÏÇ¥", "ÌòàÌíç", "ÎßàÏßÑ", "ÎèÖÏàò", "ÏûîÏõî", "Ìå®Ïôï", "Ï≤úÏÇ¥", "Í∑πÎèÑ", "ÌùëÎ£°", "ÏÇ¨Ìòà", "Î¨¥Î™Ö", "Í∑ÄÎ©¥", "ÎáåÏò•", "Í¥ëÎèÑ", "ÏùåÎßà", "ÌòàÎûë", "Ï†ÅÏö¥", "ÌòºÏÑ∏", "Îã®Ï£Ñ", "ÏïºÏ∞®", "ÏàòÎùº", "Ï∞∏Í≤©", "Î©∏Ï≤ú", "ÌùâÏàò", "ÏÇ¨Ìå®", "ÎèÖÎ£°", "Î¨¥Ìòà", "ÏÇ¥Í≤Å", "Ï≤úÎßà", "ÏßÄÏò•", "Ìè≠Ïóº", "Í¥¥Ïàò", "Ï∞∏Ìòà", "ÌôòÎßà", "ÌòàÍ¥ë"],
                    f: ["ÌôçÎ†®", "ÏöîÌôî", "ÌùëÏ°∞", "Îß§Íµ¨", "ÎèÖÌù¨", "ÏÇ¨ÎÖÄ", "ÌòàÎß§", "ÏùåÌù¨", "ÎßàÏÑ§", "ÏûêÏöî", "ÎπÑÏõî", "Ï≤úÏöî", "ÏóºÌù¨", "Ï†ÅÎ†®", "Í∑ÄÎπÑ", "ÎèÖÎûÄ", "ÏïºÌù¨", "Ïú†Î™Ö", "ÏÇ¥Ìù¨", "ÌùëÏ†ë", "ÌòàÌù¨", "Î™ΩÎßà", "ÌôòÌù¨", "Ï†àÏòÅ", "ÎßàÏòà", "ÏÜåÏÇ¥", "ÏùåÎ†π", "Ï†ÅÌôî", "ÏöîÎûÄ", "Î¨¥Ïóº", "ÎπÑÏÇ¨", "ÌòàÏ£º", "ÎèÖÏó∞", "ÏïîÌñ•", "ÏÇ¨Î†π", "ÌùëÎ†®", "Í¥¥Ìù¨", "Ï∞∏ÏïÑ", "Î©∏Ìôî", "Ï£ºÎûÄ"],
                    s: ["Îßà", "ÎèÖÍ≥†", "Ïùå", "ÏÇ¨", "Ï≤ú", "Ìòà", "Ïû•", "Ìùë", "Î∞∞", "Ïóº", "Í∑Ä", "Ïïº", "Ìè≠", "ÏÇ¥", "Îáå", "Î¨µ", "Í≤¨", "ÎÇò", "Î∞©", "ÏúÑ", "Îãπ", "ÌåΩ", "ÏÑ§", "Í∏à", "Ï†Ñ", "Î∞ò", "Ïãú", "Í∞ê", "Îèô", "ÏïÖ", "Ìòï", "Î™Ω", "Ï¢å", "Ïö∞", "Ìëú", "Ïñë", "Î™Ö"]
                },
                warrior: {
                    m: ["ÎπÑÎ£°", "ÏùºÎèÑ", "Î¨¥ÏßÑ", "Í¥ëÌòÑ", "Ï≤†Ïã¨", "Îã®Ïö∞", "Í≤ÄÏßÑ", "ÏÜåÎ£°", "ÌÉúÏÇ∞", "Î¨¥ÎπÑ", "Í≤ÄÌïú", "ÎèÑÏ†Ñ", "Í¥ëÎèÑ", "Ï≤†ÏÇ∞", "ÌíçÏßÑ", "ÌïúÏàò", "Í≥†Í≤Ä", "ÎÇ≠Ï≤ú", "Î≤ΩÏÇ∞", "Ï∑®ÏÑ†", "Îã®Ïö¥", "Í≤ÄÎßà", "Ìå®ÎèÑ", "Î¨¥ÏÉÅ", "Ïú†Ìòë", "ÏßÑÍ≤Ä", "Ï≤úÌò∏", "ÏßàÌíç", "Î≤àÍ∞ú", "Î¨¥Ïãù", "Ï≤†Ïö∞", "Í∞ïÏ≤†", "Ìò∏Í±∏", "Ïö©ÎπÑ", "Î∞±Ìò∏", "Ï≤≠Î£°", "ÎπÑÍ≤Ä", "Îã®Ïõî", "Î¨¥Ïã†", "Í≥†ÏòÅ", "ÌïúÎπÑ", "Ï≤úÎûë", "ÏõîÌíç", "Ï†ÅÌò∏", "ÎáåÏ†Ñ", "ÏæåÍ≤Ä", "ÌôòÍ≤Ä", "Î¨¥Ï†ï", "Ïû†Î£°", "ÌíçÏö¥"],
                    f: ["Í≤ÄÌù¨", "Î¨¥ÏòÅ", "ÎπÑÏó∞", "Ï±ÑÎ†π", "ÏõîÏòÅ", "ÏÜåÏõî", "ÏùÄÏÑ§", "ÎØ∏Î†π", "Îã®ÏòÅ", "ÏÜåÌñ•", "Î™ÖÏõî", "Ï≤≠ÏÑ§", "ÌïúÏõî", "Ïú†ÏÑ±", "ÎπÑÎ†π", "Í≤ÄÌñ•", "Î¨¥ÎûÄ", "ÏÑ§Í≤Ä", "Ï≤≠Ìñ•", "ÏùÄÎπÑ", "ÎπÑÌôî", "ÏõîÌïò", "Îã®Ïã¨", "Ïó∞Î¨¥", "Ìò∏Ïó∞", "ÏßÑÏïÑ", "ÏÑ§ÎûÄ", "Ï≤≠Îπô", "Ïó¨Ìòë", "ÎπÑÎã®", "Ïö¥Í≤Ä", "Ìñ•Î¨¥", "ÏÜåÌòë", "ÏûêÏòÅ", "ÌòúÍ≤Ä", "Î¨¥ÏÜå", "ÏõîÏïÑ", "Ï≤≠Î†®", "ÎπÑÏ∑®", "Îã®Ìñ•"],
                    s: ["Í≥Ω", "Ìïò", "Ìïú", "ÏûÑ", "Ï∞®", "Í≥†", "ÏÑù", "Ï£º", "Ïñë", "Ìëú", "ÏÑ§", "Ìôç", "Î∞∞", "Ï†Ñ", "ÎÖ∏", "Î¨∏", "Î∞©", "ÏÑ±", "Ïò§", "Ïú°", "ÏßÄ", "Ìóà", "ÌòÑ", "Ï∂î", "Îã®", "Î¨µ", "Í≥µ", "Í∞ê", "ÌÉÅ", "ÏúÑ", "Î™®", "Ìé∏", "Íµ≠", "Ïñ¥", "Ïö©", "ÎÇ®", "ÎπÑ", "ÎèÑ"]
                }
            },
            korean: {
                modern: {
                    m: ["ÎØºÏ§Ä", "ÏÑúÏ§Ä", "ÎèÑÏú§", "ÏòàÏ§Ä", "ÏãúÏö∞", "ÌïòÏ§Ä", "ÏßÄÌò∏", "Ï£ºÏõê", "ÏßÄÌõÑ", "Ï§ÄÏö∞", "Ï§ÄÏÑú", "ÎèÑÌòÑ", "Í±¥Ïö∞", "ÌòÑÏö∞", "Ïö∞ÏßÑ", "ÏßÄÌõà", "ÏÑ†Ïö∞", "Ïú†Ï§Ä", "ÏÑúÏßÑ", "Ïó∞Ïö∞", "ÏùÄÏö∞", "ÎØºÏû¨", "ÌòÑÏ§Ä", "ÏãúÏú§", "Ï†ïÏö∞", "Ïù¥Ï§Ä", "ÏäπÏö∞", "Ïú§Ïö∞", "ÏßÄÌôò", "ÏßÄÏö∞", "ÏäπÌòÑ", "Ïú†Ï∞¨", "Ï§ÄÌòÅ", "ÏàòÌò∏", "ÏäπÎØº", "ÏãúÌõÑ", "ÏßÑÏö∞", "ÎØºÏÑ±", "Ï§ÄÏòÅ", "ÏàòÌòÑ", "ÏßÄÏõê", "Ïù¥Ïïà", "Ïû¨Ïú§", "ÏãúÌòÑ", "ÌÉúÏú§", "ÌïúÍ≤∞", "ÏßÄÏïà", "ÎèôÌòÑ", "Ïú§Ìò∏", "ÏãúÏõê", "ÏùÄÏ∞¨", "ÏãúÏò®", "ÎØºÏö∞", "Ïû¨Ïõê", "ÎØºÍ∑ú", "ÏßÄÌïú", "ÏÑúÏö∞", "ÏùÄÌò∏", "Ïû¨ÎØº", "ÎØºÏ∞¨", "Ïö∞Ï£º", "Ïö∞Îπà", "ÌïòÏú®", "Ï§ÄÌò∏", "ÏßÄÏú®", "ÏÑ±ÎØº", "ÏäπÏ§Ä", "ÌïòÏßÑ", "ÏÑ±ÌòÑ", "Ïû¨ÌòÑ", "ÌòÑÏÑú", "ÎØºÌò∏", "ÌÉúÎØº", "ÏòàÏÑ±", "ÏßÄÏÑ±", "ÏßÄÎØº", "Ïú§Ïû¨", "ÌÉúÌòÑ", "ÎØºÌòÅ", "ÌïòÎûå", "ÎèÑÌõà", "Ïù¥Îì†", "ÏßÄÏò§", "Í∞ïÎØº", "ÏßÄÏôÑ", "ÌÉúÏ§Ä", "Ï§ÄÏÑ±", "ÌïòÎûë", "ÏäπÏõê", "ÎèÑÏòÅ", "ÌòÑÏàò", "Ï†ïÌòÑ", "ÏäπÌò∏", "ÎèÑÏú®", "ÏãúÏú®", "ÏÑ±Îπà", "Ïö∞ÌòÑ", "ÏãúÌõà", "ÎØºÏÑú", "ÏÑúÏú®", "Í±¥Ìù¨", "ÏãúÏôÑ", "Ï£ºÌôò", "ÎùºÏò®", "ÏõêÏ§Ä", "ÎØºÏàò", "Ï†ïÌõà", "ÌÉúÏò§", "ÌòÑÎØº", "ÏäπÏú§", "ÎèôÌïò", "ÎØºÍ∏∞", "Ïû¨Ìïò", "Ï£ºÏòÅ", "ÎèÑÍ≤Ω", "ÏÑúÌõÑ", "Îã®Ïö∞", "Í≤ΩÎØº", "ÎØºÍ±¥", "ÌòÑÏÑ±", "ÏãúÌôò", "ÏãúÏïà", "ÎèÑÏõê", "Ï†ïÌõÑ", "Í∞ÄÏò®", "Ïò®Ïú†", "ÏäπÎπà", "Ï†ïÏõê", "Ìò∏Ï§Ä", "ÌÉúÌõà", "Ïû¨Ï§Ä", "Ïû¨Ìõà", "ÌÉúÏòÅ", "ÏÑ∏ÌòÑ", "ÎèôÍ±¥", "Ïó∞Ï§Ä", "ÌÉúÍ≤Ω", "ÎèÑÏ§Ä", "Ïú†Í±¥", "Î≤îÏ§Ä", "ÌïòÏò®", "Ï∞¨ÏòÅ", "ÌÉúÏú®", "ÌòÑÏßÑ", "Ïû¨ÏòÅ", "ÏòÅÏ§Ä", "ÏÑ±Ïú§", "ÌïòÏú§", "ÌòÑÏäπ", "Ï£ºÌòÅ", "ÏÉÅÌòÑ", "Ï∞¨Ïö∞", "ÏßÄÌòÅ", "ÏÑ∏Ï§Ä", "ÏäπÌõà", "ÌïòÎäò", "ÏäπÏû¨", "ÎèôÏú§", "Ïö∞ÏÑ±", "Í±¥Ìò∏", "ÌÉúÌò∏", "Ï∞¨Ìù¨", "Ïú§Ï∞¨", "Ïú§ÌõÑ", "ÏÑ±Ìõà", "Ïú†Ïïà", "ÏßÄÏö¥", "Ïó∞Ìò∏", "ÏàòÎØº", "ÏÑúÌò∏", "Ïú†ÌòÑ", "ÎèôÏö±", "ÏäπÏ∞¨", "ÎèÑÍ≤∏", "ÌÉúÏö∞", "Í∑úÎπà", "ÌòÑÌò∏", "Ï£ºÌïú", "ÏÑúÏõê", "Ïû¨Ïö∞", "ÌòÑÎπà", "Ïû¨Ìù¨", "ÏàòÌòÅ", "Ï£ºÏôÑ", "Ïú†ÏßÑ", "Ìö®Ï§Ä", "Ïö∞Ï∞¨", "ÏãúÌóå", "Ï£ºÌòÑ", "Ï§ÄÏÑù", "ÏùÄÏú®", "Ïû¨ÌòÅ", "ÎèôÏö∞", "ÏÑ†Ìò∏", "ÌòïÏ§Ä", "Ïù¥Ìïú", "ÏÑ±Ïö∞", "ÏÉÅÏú§", "ÎèÑÏßÑ", "Ïö∞ÏòÅ"],
                    f: ["ÏÑúÏó∞", "ÎØºÏÑú", "ÏßÄÏö∞", "ÏÑúÏú§", "ÌïòÏùÄ", "ÏßÄÏïà", "ÏàòÏïÑ", "ÌïòÎ¶∞", "Ïú†ÎÇò", "ÏÑúÏïÑ", "Ï±ÑÏõê", "ÏßÄÏú†", "Îã§Ïù∏", "ÏòàÏùÄ", "ÏàòÎπà", "ÏãúÏïÑ", "ÏÜåÏú®", "ÏïÑÎ¶∞", "Îã§ÏùÄ", "ÎÇòÏùÄ", "Ïú†ÏßÑ", "ÏßÄÏõê", "ÏòàÎ¶∞", "ÏßÄÏùÄ", "ÏàòÏßÑ", "ÏùÄÏßÄ", "ÎØºÏßÄ", "Ïú§ÏïÑ", "Ï±ÑÏùÄ", "Í∞ÄÏùÄ", "ÏÑúÌòÑ", "ÏòàÏßÑ", "ÏÑúÏòÅ", "ÏßÄÎØº", "ÏòàÏõê", "Ïú§ÏÑú", "ÏÜåÏú§", "ÏßÄÌòÑ", "ÌïòÏú§", "ÏùÄÏö∞", "ÌòÑÏßÄ", "Ï±ÑÏö∞", "ÏòàÏßÄ", "ÏãúÏùÄ", "ÎØºÏ£º", "Îã§Ïó∞", "Ïó∞Ïö∞", "ÏàòÎØº", "Ï±ÑÏïÑ", "Îã§Ïò®", "ÏßÄÏïÑ", "ÏãúÌòÑ", "Ï£ºÌïò", "ÏäπÏó∞", "ÏÑúÏßÑ", "ÏÑúÏùÄ", "ÎÇòÏú§", "Ï±ÑÏó∞", "ÏòàÎÇò", "ÎØºÏ±Ñ", "Îã§ÌòÑ", "Í∞ÄÏú§", "ÌïòÏú®", "Ï†ïÏõê", "ÌÉúÌù¨", "ÎèÑÏó∞", "ÏãúÏó∞", "ÏÑúÏú®", "ÏùÄÏÑú", "ÏòàÎπà", "ÏßÄÏú§", "ÎÇòÏó∞", "ÏòàÎ¶º", "Ïó∞ÏÑú", "ÌïòÏòÅ", "ÏàòÌòÑ", "Í∑úÎ¶¨", "ÏïÑÏù∏", "ÏùÄÏ±Ñ", "Ï£ºÏïÑ", "ÏÜåÏùÄ", "ÏÑúÏö∞", "Ïú†Ï£º", "Ïú§ÏßÄ", "Îã§ÏÜú", "ÏÜåÎØº", "ÏßÄÏò®", "ÏÇ¨Îûë", "ÏòàÏÑú", "Ï±ÑÏõê", "Ïú†Îπà", "Í∞ÄÏò®", "ÏßÄÏïà", "ÏÑ§ÏïÑ", "ÏàòÏïÑ", "Ïù¥ÏÑú", "Ïù¥Ïàò", "Ïù¥Ïïà", "Ïù¥Îπà", "Ïù¥ÌòÑ", "ÎÇòÏùÄ", "ÌïòÏò®", "ÌïòÏßÑ", "Ï£ºÏùÄ", "Ï±ÑÎØº", "Ï±ÑÎπà", "Ï±ÑÏù¥", "Ï±ÑÏú§", "Ï±ÑÏú®", "Ï±ÑÏùÄ", "ÌÉúÎ¶¨", "ÌÉúÎ¶∞", "ÌÉúÏó∞", "ÌÉúÏùÄ", "ÌÉúÏù¥", "ÌÉúÏù∏", "ÌÉúÌù¨", "ÌïòÎäò", "ÌïòÎÇò", "ÌïòÎ£®", "ÌïòÎ¶¨", "ÌïòÎØº", "ÌïòÏÑú", "ÌïòÏÜî", "ÌïòÏó∞", "ÌïòÏòÅ", "ÌïòÏò®", "ÌïòÏú§", "ÌïòÏùÄ", "ÌïòÏßÑ", "ÌïúÎÇò", "ÌïúÎ≥Ñ", "ÌïúÎπÑ", "ÌïúÏÜî", "ÌïúÏù¥", "Ìï¥ÎÇò", "Ìï¥Î¶∞", "Ìï¥Ïàò", "Ìï¥Ïò®", "Ìï¥Ïú§", "Ìï¥Ïù∏", "ÌòÑÏÑú", "ÌòÑÏàò", "ÌòÑÏïÑ", "ÌòÑÏòÅ", "ÌòÑÏú†", "ÌòÑÏ£º", "ÌòÑÏßÄ", "ÌòúÎÇò", "ÌòúÎ¶∞", "ÌòúÎØº", "ÌòúÎπà", "ÌòúÏÑú", "ÌòúÏàò", "ÌòúÏó∞", "ÌòúÏòÅ", "ÌòúÏõê", "ÌòúÏú§", "ÌòúÏù∏", "ÌòúÏ£º"],
                    s: ["ÍπÄ", "Ïù¥", "Î∞ï", "Ï†ï", "Ïµú", "Ï°∞", "Í∞ï", "Ïú§", "Ïû•", "ÏûÑ", "Ïã†", "Ïú†", "Ìïú", "Ïò§", "ÏÑú", "Ï†Ñ", "Í∂å", "Ìô©", "Ïïà", "ÏÜ°", "Ìôç", "Ïñë", "Í≥†", "Î¨∏", "ÏÜê", "Î∞∞", "Î∞±", "Ìóà", "ÎÖ∏", "ÎÇ®", "Ïã¨", "Ìïò", "Ï£º", "Íµ¨", "Í≥Ω", "ÏÑ±", "Ï∞®", "Ïö∞", "ÏßÑ", "ÎØº", "Î•ò", "ÎÇò", "ÏßÄ", "ÏóÑ", "Î≥Ä", "Ï±Ñ", "Ïõê", "Î∞©", "Ï≤ú", "Í≥µ", "ÌòÑ", "Ìï®", "Ïó¨", "Ïóº", "ÏÑù", "Ï∂î", "ÎèÑ", "ÏÜå", "ÏÑ§", "ÏÑ†", "Îßà", "Í∏∏", "Ïó∞", "ÏúÑ", "Ìëú", "Î™Ö", "Í∏∞", "Î∞ò", "Îùº", "Ïôï", "Í∏à", "Ïò•", "Ïú°", "Ïù∏", "Îßπ", "Ï†ú", "Î™®", "ÌÉÅ", "Íµ≠", "Ïñ¥", "Í≤Ω", "ÏùÄ", "Ìé∏", "Ïö©", "Ïòà", "Î¥â", "ÏÇ¨", "Î∂Ä", "Í∞Ä", "Î≥µ", "ÌÉú", "Î™©", "Ìòï", "Ìîº", "Îëê", "Í∞ê", "Ìò∏", "Ï†úÍ∞à", "ÎÇ®Í∂Å", "ÎèÖÍ≥†", "ÏÑ†Ïö∞", "Ìô©Î≥¥"]
                },
                classic: {
                    m: ["ÏòÅÏàò", "ÏòÅÌò∏", "ÏòÅÏãù", "ÏòÅÏ≤†", "Ï†ïÏàò", "Ï†ïÌò∏", "Ï†ïÏãù", "Ï†ïÌõà", "ÏÑ±Ïàò", "ÏÑ±Ìò∏", "ÏÑ±Ìõà", "ÏÑ±ÏßÑ", "Ï≤†Ïàò", "Ï≤†Ìò∏", "Ï≤†ÎØº", "ÎØºÏàò", "ÎØºÌò∏", "ÎØºÏ≤†", "ÎßåÏàò", "ÎèôÏàò", "ÎèôÌòÑ", "ÎèôÌõà", "ÏßÑÏàò", "ÏßÑÌò∏", "Ï§ÄÌò∏", "Ï§ÄÏàò", "Í¥ëÏàò", "Í¥ëÌò∏", "ÏÉÅÌõà", "ÏÉÅÏö∞", "ÏÉÅÏ≤†", "Î≥ëÏ≤†", "Î≥ëÏàò", "Ïû¨Ìò∏", "Ïû¨ÏÑù", "Í≤ΩÏàò", "Ï¢ÖÏàò", "Ï¢ÖÌò∏", "Ï¢ÖÌõà", "Î™ÖÏàò", "Î™ÖÌò∏", "ÌòÑÏàò", "ÌòÑÏö∞", "ÌòÑÏ≤†", "Í∏∞Ïàò", "Í∏∞Ï≤†", "ÏÑùÏàò", "ÏÑùÌò∏"],
                    f: ["ÏòÅÌù¨", "ÏòÅÏàô", "ÏòÅÏûê", "ÏòÅÏàú", "Ï†ïÏàô", "Ï†ïÌù¨", "Ï†ïÏàú", "Ï†ïÏûê", "ÏàúÏûê", "ÏàúÌù¨", "ÏàúÏ†ï", "ÎØ∏Ïàô", "ÎØ∏Í≤Ω", "ÎØ∏ÏòÅ", "ÎØ∏Ïûê", "ÎØ∏Ìù¨", "Í≤ΩÏàô", "Í≤ΩÌù¨", "Í≤ΩÏûê", "Í≤ΩÏàú", "ÌòúÏûê", "ÌòúÏàô", "ÌòúÍ≤Ω", "ÌòúÏòÅ", "ÌòúÏ†ï", "Ìù¨Ïûê", "Ìù¨Ïàô", "Ìù¨Í≤Ω", "Ìù¨Ï†ï", "ÏàôÏûê", "ÏàôÌù¨", "Î™ÖÏûê", "Î™ÖÏàô", "Î™ÖÌù¨", "ÌòÑÏàô", "ÌòÑÏ†ï", "ÌòÑÏ£º", "ÌòÑÌù¨", "ÏùÄÏ£º", "ÏùÄÏòÅ", "ÏùÄÏàô", "ÏùÄÍ≤Ω", "ÏùÄÌù¨", "ÏßÄÏòÅ", "ÏßÄÏàô", "ÏßÄÌòÑ", "ÏßÄÌòú", "ÏàòÏßÑ"],
                    s: ["ÍπÄ", "Ïù¥", "Î∞ï", "Ïµú", "Ï†ï", "Í∞ï", "Ï°∞", "Ïú§", "Ïû•", "ÏûÑ", "Ìïú", "Ïò§", "ÏÑú", "Ï†Ñ", "Í∂å", "Ìô©", "Ïïà", "ÏÜ°", "Ìôç", "Ïñë", "Í≥†", "Î¨∏", "ÏÜê", "Î∞∞", "Î∞±", "Ìóà", "Ïú†", "ÎÇ®", "Ïã¨", "ÎÖ∏"]
                }
            }
        };
        const NAME_ROLES = {
            fantasy: [
                {id: 'royalty', text: 'üëë ÏôïÏ°± / Í≥†ÏúÑ Í∑ÄÏ°±'},
                {id: 'knight', text: '‚öîÔ∏è Í∏∞ÏÇ¨ / Ï†ÑÏÇ¨'},
                {id: 'wizard', text: '‚ú® ÎßàÎ≤ïÏÇ¨ / ÌòÑÏûê'},
                {id: 'commoner', text: 'üî® ÌèâÎØº / ÏÉÅÏù∏'},
                {id: 'servant', text: 'üßπ ÌïòÏù∏ / ÌÅ¨Î¶¨Ï≤ò'}
            ],
            wuxia: [
                {id: 'noble', text: 'üèØ Î™ÖÎ¨∏ ÏÑ∏Í∞Ä / Ï†ïÌåå'},
                {id: 'villain', text: 'üòà ÏÇ¨Ìåå / ÎßàÍµê'},
                {id: 'warrior', text: 'üó°Ô∏è ÎÇ≠Ïù∏ / ÌòëÍ∞ù'}
            ],
            korean: [
                {id: 'modern', text: 'üì± ÌòÑÎåÄÏ†Å / Ìä∏Î†åÎîî'},
                {id: 'classic', text: 'üì∫ Ï†ÑÌÜµÏ†Å / Ï§ëÌõÑÌï®'}
            ]
        };
        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
        const IconPlus = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
        const IconTrash = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>);
        const IconSettings = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>);
        const IconBack = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const IconUpload = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>);
        const IconSave = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>);
        const IconSun = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>);
        const IconMoon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>);
        const IconZen = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/></svg>);
        const IconFont = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>);
        const IconLayout = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /><line x1="10" x2="14" y1="6.5" y2="6.5" /><line x1="10" x2="14" y1="17.5" y2="17.5" /><line x1="6.5" x2="6.5" y1="10" y2="14" /><line x1="17.5" x2="17.5" y1="10" y2="14" /></svg>);
        const getCaretCoordinates = (element, position) => { const div = document.createElement('div'); const style = window.getComputedStyle(element); const props = ['fontFamily', 'fontSize', 'fontWeight', 'lineHeight', 'padding', 'border', 'width', 'boxSizing', 'whiteSpace', 'wordWrap']; props.forEach(prop => div.style[prop] = style[prop]); div.style.position = 'absolute'; div.style.visibility = 'hidden'; div.textContent = element.value.substring(0, position); const span = document.createElement('span'); span.textContent = element.value.substring(position) || '.'; div.appendChild(span); document.body.appendChild(div); const rect = element.getBoundingClientRect(); const coordinates = { top: rect.top + span.offsetTop + element.scrollTop, left: rect.left + span.offsetLeft }; document.body.removeChild(div); return coordinates; };
        const getWordAtPos = (text, pos) => { if (!text) return ""; const left = text.slice(0, pos).search(/[^\s#@]*$/); const right = text.slice(pos).search(/[\s\n\r]/); const word = text.slice(left, right === -1 ? undefined : right + pos); return word.replace(/[#@]/g, '').trim(); };
        const getBezierPath = (x1, y1, x2, y2) => { const dx = x2 - x1; const dy = y2 - y1; const curvature = 0.5; const cx1 = x1 + dx * curvature; const cy1 = y1; const cx2 = x2 - dx * curvature; const cy2 = y2; return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`; };
        const getEdgeTargetPos = (from, to, offset = 12) => { const x1 = from.x + CARD_W / 2; const y1 = from.y + CARD_H / 2; const x2 = to.x + CARD_W / 2; const y2 = to.y + CARD_H / 2; const dx = x2 - x1; const dy = y2 - y1; const angle = Math.atan2(dy, dx); const absCos = Math.abs(Math.cos(angle)); const absSin = Math.abs(Math.sin(angle)); let distance = (CARD_W * absSin <= CARD_H * absCos) ? (CARD_W / 2) / absCos : (CARD_H / 2) / absSin; return { x: x2 - Math.cos(angle) * (distance + offset), y: y2 - Math.sin(angle) * (distance + offset) }; };
        const getRoleBadgeStyle = (role) => { switch(role) { case 'Ï£ºÏù∏Í≥µ': return 'bg-blue-600 dark:bg-blue-800 text-white'; case 'Ï†ÅÎåÄÏûê': return 'bg-red-600 dark:bg-red-800 text-white'; case 'Ï°∞Î†•Ïûê': return 'bg-emerald-600 dark:bg-emerald-800 text-white'; case 'Ï°∞Ïó∞': return 'bg-slate-500 text-white'; case 'ÏóëÏä§Ìä∏Îùº': return 'bg-slate-300 text-slate-600'; default: return 'bg-slate-100 text-slate-500 border border-slate-200'; } };
        const getStatusBadgeStyle = (status) => { switch(status) { case 'Ï¥àÍ≥†': return 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300'; case 'ÏàòÏ†ï': return 'bg-amber-100 text-amber-600 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800'; case 'ÏôÑÎ£å': return 'bg-emerald-600 text-white'; default: return 'bg-slate-100 text-slate-400'; } };
        // ÎÖ∏Îìú ÌÉÄÏûÖÎ≥Ñ ÏÉâÏÉÅ Ï†ïÏùò
        const NODE_TYPE_COLORS = {
            'Ïù∏Î¨º': { sidebar: 'border-l-blue-500 dark:border-l-blue-400', selected: 'border-blue-500 dark:border-blue-400', bar: 'bg-blue-600 dark:bg-blue-600', text: 'text-blue-600 dark:text-blue-400', bg: 'bg-blue-500', hover: 'hover:bg-blue-50 dark:hover:bg-blue-950/50' },
            'ÏÇ¨Í±¥': { sidebar: 'border-l-red-500 dark:border-l-red-400', selected: 'border-red-500 dark:border-red-400', bar: 'bg-red-600 dark:bg-red-600', text: 'text-red-600 dark:text-red-400', bg: 'bg-red-500', hover: 'hover:bg-red-50 dark:hover:bg-red-950/50' },
            'Î©îÎ™®': { sidebar: 'border-l-amber-500 dark:border-l-amber-400', selected: 'border-amber-500 dark:border-amber-400', bar: 'bg-amber-500 dark:bg-amber-600', text: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-500', hover: 'hover:bg-amber-50 dark:hover:bg-amber-950/50' },
            'Ïû•ÏÜå': { sidebar: 'border-l-emerald-500 dark:border-l-emerald-400', selected: 'border-emerald-500 dark:border-emerald-400', bar: 'bg-emerald-600 dark:bg-emerald-600', text: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-500', hover: 'hover:bg-emerald-50 dark:hover:bg-emerald-950/50' },
            'ÏïÑÏù¥ÌÖú': { sidebar: 'border-l-purple-500 dark:border-l-purple-400', selected: 'border-purple-500 dark:border-purple-400', bar: 'bg-purple-600 dark:bg-purple-600', text: 'text-purple-600 dark:text-purple-400', bg: 'bg-purple-500', hover: 'hover:bg-purple-50 dark:hover:bg-purple-950/50' },
            'ÏÑ∏Î†•': { sidebar: 'border-l-orange-500 dark:border-l-orange-400', selected: 'border-orange-500 dark:border-orange-400', bar: 'bg-orange-600 dark:bg-orange-600', text: 'text-orange-600 dark:text-orange-400', bg: 'bg-orange-500', hover: 'hover:bg-orange-50 dark:hover:bg-orange-950/50' },
            'Î≥µÏÑ†': { sidebar: 'border-l-pink-500 dark:border-l-pink-400', selected: 'border-pink-500 dark:border-pink-400', bar: 'bg-pink-600 dark:bg-pink-600', text: 'text-pink-600 dark:text-pink-400', bg: 'bg-pink-500', hover: 'hover:bg-pink-50 dark:hover:bg-pink-950/50' },
            'ÌÉÄÏûÑÎùºÏù∏': { sidebar: 'border-l-teal-500 dark:border-l-teal-400', selected: 'border-teal-500 dark:border-teal-400', bar: 'bg-teal-600 dark:bg-teal-600', text: 'text-teal-600 dark:text-teal-400', bg: 'bg-teal-500', hover: 'hover:bg-teal-50 dark:hover:bg-teal-950/50' },
            'ÏÑ§Ï†ï': { sidebar: 'border-l-indigo-500 dark:border-l-indigo-400', selected: 'border-indigo-500 dark:border-indigo-400', bar: 'bg-indigo-600 dark:bg-indigo-600', text: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-500', hover: 'hover:bg-indigo-50 dark:hover:bg-indigo-950/50' },
            'ÎåÄÏÇ¨': { sidebar: 'border-l-sky-500 dark:border-l-sky-400', selected: 'border-sky-500 dark:border-sky-400', bar: 'bg-sky-600 dark:bg-sky-600', text: 'text-sky-600 dark:text-sky-400', bg: 'bg-sky-500', hover: 'hover:bg-sky-50 dark:hover:bg-sky-950/50' },
            'Í∞àÎì±': { sidebar: 'border-l-rose-500 dark:border-l-rose-400', selected: 'border-rose-500 dark:border-rose-400', bar: 'bg-rose-600 dark:bg-rose-600', text: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-500', hover: 'hover:bg-rose-50 dark:hover:bg-rose-950/50' },
            'Í∑∏Î£π': { sidebar: 'border-l-slate-500 dark:border-l-slate-400', selected: 'border-slate-500 dark:border-slate-400', bar: 'bg-slate-600 dark:bg-slate-600', text: 'text-slate-600 dark:text-slate-400', bg: 'bg-slate-500', hover: 'hover:bg-slate-50 dark:hover:bg-slate-800/50' }
        };
        // ÎÖ∏Îìú ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏ Ïù¥Î™®ÏßÄ
        const NODE_TYPE_EMOJIS = {
            'Ïù∏Î¨º': 'üë§', 'ÏÇ¨Í±¥': 'üî•', 'Î©îÎ™®': 'üí°', 'Ïû•ÏÜå': 'üìç', 'ÏïÑÏù¥ÌÖú': 'üéÅ',
            'ÏÑ∏Î†•': '‚öîÔ∏è', 'Î≥µÏÑ†': 'üé£', 'ÌÉÄÏûÑÎùºÏù∏': '‚è∞', 'ÏÑ§Ï†ï': 'üìö', 'ÎåÄÏÇ¨': 'üí¨', 'Í∞àÎì±': '‚ö°', 'Í∑∏Î£π': 'üìÅ'
        };
        const getSidebarItemAccent = (node) => {
            return NODE_TYPE_COLORS[node.type]?.sidebar || 'border-l-transparent';
        };
        const getSelectedBorderColor = (node) => {
            return NODE_TYPE_COLORS[node.type]?.selected || 'border-indigo-500 dark:border-indigo-600';
        };
        const getNodeBarColor = (node) => {
            return NODE_TYPE_COLORS[node.type]?.bar || 'bg-slate-500 dark:bg-slate-700';
        };
        const getStrokeDashArray = (style) => { switch(style) { case 'dashed': return "4, 8"; default: return ""; } };

        // Toast
        const Toast = ({ message, type, onClose }) => (
            <motion.div initial={{ y: 50, opacity: 0, scale: 0.9 }} animate={{ y: 0, opacity: 1, scale: 1 }} exit={{ y: 50, opacity: 0, scale: 0.9 }} className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] flex items-center gap-3 bg-zinc-800 dark:bg-zinc-100 text-white dark:text-zinc-900 px-6 py-3 rounded-full shadow-2xl">
                <span className="text-sm font-bold">{message}</span>
            </motion.div>
        );

        // NodeCard - ÎÖ∏Îìú ÌÉÄÏûÖÎ≥Ñ ÏÑúÎ∏åÎùºÏù∏ Î†åÎçîÎßÅ
        const getNodeSubline = (node) => {
            switch(node.type) {
                case 'Ïù∏Î¨º': return `${node.data.gender} ¬∑ ${node.data.age ? `${node.data.age}ÏÑ∏` : 'ÎÇòÏù¥ ÎØ∏ÏÉÅ'} ¬∑ ${node.data.job || 'ÏßÅÏóÖ ÏóÜÏùå'}`;
                case 'ÏÇ¨Í±¥': return `üìç ${node.data.place || 'Ïû•ÏÜå ÎØ∏ÏÉÅ'} ¬∑ üìÖ ${node.data.year || 'ÏãúÍ∏∞ ÎØ∏ÏÉÅ'}`;
                case 'Ïû•ÏÜå': return `üåç ${node.data.region || 'ÏßÄÏó≠ ÎØ∏ÏÉÅ'} ¬∑ üå§Ô∏è ${node.data.climate || 'Í∏∞ÌõÑ ÎØ∏ÏÉÅ'}`;
                case 'ÏïÑÏù¥ÌÖú': return `üì¶ ${node.data.category || 'ÏùºÎ∞ò'} ¬∑ ‚≠ê ${node.data.rarity || 'Î≥¥ÌÜµ'}`;
                case 'ÏÑ∏Î†•': return `üëë ${node.data.leader || 'Î¶¨Îçî ÎØ∏ÏÉÅ'} ¬∑ üè∞ ${node.data.territory || 'ÏòÅÏó≠ ÎØ∏ÏÉÅ'}`;
                case 'Î≥µÏÑ†': return `üìñ ${node.data.chapter || 'Ïû• ÎØ∏ÏÉÅ'} ¬∑ ${node.data.status === 'ÌöåÏàòÎê®' ? '‚úÖ ÌöåÏàòÎê®' : 'üîÑ ÎØ∏ÌöåÏàò'}`;
                case 'ÌÉÄÏûÑÎùºÏù∏': return `üìÖ ${node.data.date || 'ÎÇ†Ïßú ÎØ∏ÏÉÅ'} ¬∑ üèõÔ∏è ${node.data.era || 'ÏãúÎåÄ ÎØ∏ÏÉÅ'}`;
                case 'ÏÑ§Ï†ï': return `üìÇ ${node.data.category || 'ÏÑ∏Í≥ÑÍ¥Ä'} ¬∑ üìè ${node.data.scope || 'Î≤îÏúÑ ÎØ∏ÏÉÅ'}`;
                case 'ÎåÄÏÇ¨': return `üó£Ô∏è ${node.data.speaker || 'ÌôîÏûê ÎØ∏ÏÉÅ'} ¬∑ üí≠ ${node.data.emotion || 'Í∞êÏ†ï ÎØ∏ÏÉÅ'}`;
                case 'Í∞àÎì±': return `‚öîÔ∏è ${node.data.parties || 'ÎãπÏÇ¨Ïûê ÎØ∏ÏÉÅ'} ¬∑ ${node.data.status === 'Ìï¥Í≤∞Îê®' ? '‚úÖ Ìï¥Í≤∞Îê®' : 'üî• ÏßÑÌñâÏ§ë'}`;
                case 'Í∑∏Î£π': return `üìÅ ${node.data.childNodes?.length || 0}Í∞ú Ìï≠Î™©`;
                default: return '';
            }
        };
        // ÎÖ∏Îìú ÌÉÄÏûÖÎ≥Ñ Î±ÉÏßÄ Î†åÎçîÎßÅ (ÏµúÏÉÅÏúÑ ÏòµÏÖòÏùÄ Îπ®Í∞ÑÏÉâ)
        const getNodeBadge = (node) => {
            const topTierStyle = 'bg-red-600 text-white'; // ÏµúÏÉÅÏúÑ ÏòµÏÖò Îπ®Í∞ÑÏÉâ
            switch(node.type) {
                case 'Ïù∏Î¨º': return node.data.role ? { text: node.data.role, style: getRoleBadgeStyle(node.data.role) } : null;
                case 'Î≥µÏÑ†': return { text: node.data.status || 'ÎØ∏ÌöåÏàò', style: node.data.status === 'ÌöåÏàòÎê®' ? 'bg-emerald-600 text-white' : 'bg-pink-100 text-pink-600 dark:bg-pink-900/30 dark:text-pink-400' };
                case 'Í∞àÎì±': return { text: node.data.status || 'ÏßÑÌñâÏ§ë', style: node.data.status === 'Ìï¥Í≤∞Îê®' ? 'bg-emerald-600 text-white' : node.data.status === 'Í≤©Ìôî' ? topTierStyle : 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400' };
                case 'ÏïÑÏù¥ÌÖú': return node.data.rarity ? { text: node.data.rarity, style: (node.data.rarity === 'Ï†ÑÏÑ§' || node.data.rarity === 'Ïú†Ïùº') ? topTierStyle : node.data.rarity === 'ÏòÅÏõÖ' ? 'bg-amber-500 text-white' : node.data.rarity === 'Ìù¨Í∑Ä' ? 'bg-purple-500 text-white' : node.data.rarity === 'Í≥†Í∏â' ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300' } : null;
                case 'ÌÉÄÏûÑÎùºÏù∏': return node.data.importance ? { text: node.data.importance, style: node.data.importance === 'ÌïµÏã¨' ? topTierStyle : node.data.importance === 'Ï§ëÏöî' ? 'bg-teal-600 text-white' : 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300' } : null;
                default: return null;
            }
        };
        const NodeCard = ({ node, isTop, isSelected, isDragging, onMouseDown, onMouseUp, onDoubleClick, onDelete, onClick }) => {
            const isIdea = node.type === 'Î©îÎ™®';
            const isGroup = node.type === 'Í∑∏Î£π';
            let styleClass = isIdea ? "node-postit" : isGroup ? "node-glass" : "node-glass";

            // Ïù∏Î¨º ÌÉÄÏûÖ ÌäπÏàò Ïä§ÌÉÄÏùº
            if (node.type === 'Ïù∏Î¨º') {
                if (node.data.role === 'Ï£ºÏù∏Í≥µ') styleClass += " node-protagonist";
                else if (node.data.role === 'Ï†ÅÎåÄÏûê') styleClass += " node-antagonist";
                else if (node.data.role === 'Ï°∞Î†•Ïûê') styleClass += " node-helper";
            } else if (node.type === 'ÏÇ¨Í±¥') styleClass += " node-event";

            // Í∑∏Î£π ÎÖ∏Îìú ÌäπÏàò Ïä§ÌÉÄÏùº
            if (isGroup) {
                styleClass += " border-2 border-dashed";
            }

            const subline = getNodeSubline(node);
            const badge = getNodeBadge(node);

            return (
                <div onMouseDown={(e) => onMouseDown(e, node.id)} onMouseUp={(e) => onMouseUp(e, node.id)} onClick={(e) => { if (onClick && e.detail === 1) { e.stopPropagation(); onClick(e, node.id); } }} onDoubleClick={() => onDoubleClick(node.id)} style={{ zIndex: isTop ? 50 : (isGroup ? 5 : 10), width: CARD_W, height: CARD_H, transform: `translate(${node.x}px, ${node.y}px)`, position: 'absolute', top: 0, left: 0, transition: isDragging ? 'none' : 'transform 0.15s ease-out, box-shadow 0.2s', ...(isGroup && node.data.color ? { borderColor: node.data.color } : {}) }} className={`flex flex-col cursor-grab active:cursor-grabbing shadow-lg hover:shadow-xl group relative ${styleClass} ${isSelected ? `border-2 ${getSelectedBorderColor(node)}` : ''}`}>
                    <button onClick={(e) => { e.stopPropagation(); if(confirm("Ïù¥ ÎÖ∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) onDelete(node.id); }} className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 rounded-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2 dark:bg-zinc-800 dark:border-zinc-600 dark:text-zinc-400 dark:hover:bg-red-600"><IconTrash className="w-3 h-3" /></button>
                    <div className="w-full h-full flex flex-col overflow-hidden rounded-[inherit]">
                        {!isIdea && <div className={`h-1.5 w-[calc(100%+4px)] -ml-[2px] -mt-[2px] shrink-0 ${getNodeBarColor(node)}`} />}
                        <div className="flex-1 flex flex-col p-4 overflow-hidden pointer-events-none">
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-[10px] font-black uppercase tracking-widest ${isIdea ? 'text-yellow-800 dark:text-yellow-100' : 'text-slate-400 dark:text-zinc-500'}`}>{node.type}</span>
                                {badge && <span className={`text-[9px] font-bold px-2 py-0.5 rounded-[3px] ${badge.style}`}>{badge.text}</span>}
                            </div>
                            <div className={`text-xl font-black truncate mb-1.5 tracking-tight flex items-center ${isIdea ? 'text-slate-950 dark:text-yellow-50' : 'text-slate-900 dark:text-white'}`}>
                                <span className="mr-2 drop-shadow-sm text-2xl">{node.data.emoji || NODE_TYPE_EMOJIS[node.type] || 'üìù'}</span>
                                <span className={`truncate ${node.type === 'ÏÇ¨Í±¥' ? 'text-rose-700 dark:text-rose-400' : node.type === 'Í∞àÎì±' ? 'text-rose-600 dark:text-rose-400' : ''}`}>{node.label}</span>
                            </div>
                            {subline && <div className="text-[11px] text-slate-500 dark:text-zinc-400 font-bold mb-2 truncate">{subline}</div>}
                            <div className={`text-[12px] font-medium leading-tight line-clamp-3 grow ${isIdea ? 'text-slate-700 dark:text-yellow-100/80' : 'text-slate-500 bg-slate-50 p-2 rounded-[3px] border border-slate-100 italic dark:bg-zinc-900/60 dark:border-zinc-700/50 dark:text-zinc-400'}`}>{node.data.memo || "ÏûëÏÑ±Îêú Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§."}</div>
                        </div>
                    </div>
                </div>
            );
        };  // NodeCard Ïª¥Ìè¨ÎÑåÌä∏ ÎÅù

        // GroupNode - Í∑∏Î£π ÏòÅÏó≠ ÎÖ∏Îìú
        const GroupNode = ({ node, isSelected, isDragging, onMouseDown, onDoubleClick, onDelete, onResize }) => {
            const width = node.data.width || 400;
            const height = node.data.height || 300;
            const color = node.data.color || '#94a3b8';
            const [isResizing, setIsResizing] = useState(false);
            const resizeStartRef = useRef({ x: 0, y: 0, width: 0, height: 0 });

            const handleResizeStart = (e, corner) => {
                e.stopPropagation();
                e.preventDefault();
                setIsResizing(true);
                resizeStartRef.current = { x: e.clientX, y: e.clientY, width, height };

                const handleResizeMove = (moveEvent) => {
                    moveEvent.preventDefault();
                    const scale = window.currentScale || 1;
                    const dx = (moveEvent.clientX - resizeStartRef.current.x) / scale;
                    const dy = (moveEvent.clientY - resizeStartRef.current.y) / scale;
                    let newWidth = resizeStartRef.current.width;
                    let newHeight = resizeStartRef.current.height;

                    if (corner.includes('e')) newWidth = Math.max(200, resizeStartRef.current.width + dx);
                    if (corner.includes('s')) newHeight = Math.max(150, resizeStartRef.current.height + dy);

                    onResize(node.id, newWidth, newHeight);
                };

                const handleResizeEnd = () => {
                    setIsResizing(false);
                    document.removeEventListener('mousemove', handleResizeMove);
                    document.removeEventListener('mouseup', handleResizeEnd);
                };

                document.addEventListener('mousemove', handleResizeMove);
                document.addEventListener('mouseup', handleResizeEnd);
            };

            return (
                <div
                    onMouseDown={(e) => {
                        if (e.target.classList.contains('resize-handle')) return;
                        onMouseDown(e, node.id);
                    }}
                    onDoubleClick={() => onDoubleClick(node.id)}
                    style={{
                        zIndex: 1,
                        width: width,
                        height: height,
                        transform: `translate(${node.x}px, ${node.y}px)`,
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        borderColor: color,
                        backgroundColor: `${color}15`,
                        transition: (isResizing || isDragging) ? 'none' : 'transform 0.15s ease-out, box-shadow 0.2s',
                    }}
                    className={`cursor-grab active:cursor-grabbing group border-2 border-dashed rounded-[3px] ${isSelected ? 'border-solid shadow-lg' : ''}`}
                >
                    {/* ÏÇ≠Ï†ú Î≤ÑÌäº */}
                    <button
                        onClick={(e) => { e.stopPropagation(); if(confirm("Ïù¥ Í∑∏Î£πÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) onDelete(node.id); }}
                        className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 rounded-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2 dark:bg-zinc-800 dark:border-zinc-600 dark:text-zinc-400 dark:hover:bg-red-600"
                    >
                        <IconTrash className="w-3 h-3" />
                    </button>

                    {/* Ï¢åÏ∏° ÏÉÅÎã® Ï†úÎ™© */}
                    <div
                        className="absolute top-6 left-8 flex items-center gap-1.5 pointer-events-none"
                        style={{ color: color }}
                    >
                        <span className="opacity-70" style={{ fontSize: '40px' }}>{node.data.emoji || 'üìÅ'}</span>
                        <span className="text-xl font-black opacity-50" style={{ fontSize: '40px' }}>{node.label}</span>
                        {node.data.memo && <span className="font-bold opacity-40 ml-3" style={{ fontSize: '20px' }}>{node.data.memo}</span>}
                    </div>

                    {/* ÌÅ¨Í∏∞ Ï°∞Ï†à Ìï∏Îì§ - Ïö∞ÌïòÎã® */}
                    <div
                        className="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize opacity-0 group-hover:opacity-100 transition-opacity"
                        onMouseDown={(e) => handleResizeStart(e, 'se')}
                        style={{ backgroundColor: color }}
                    />
                    {/* ÌÅ¨Í∏∞ Ï°∞Ï†à Ìï∏Îì§ - Ïö∞Ï∏° */}
                    <div
                        className="resize-handle absolute top-1/2 right-0 w-2 h-8 -translate-y-1/2 cursor-e-resize opacity-0 group-hover:opacity-100 transition-opacity rounded-l-sm"
                        onMouseDown={(e) => handleResizeStart(e, 'e')}
                        style={{ backgroundColor: color }}
                    />
                    {/* ÌÅ¨Í∏∞ Ï°∞Ï†à Ìï∏Îì§ - ÌïòÎã® */}
                    <div
                        className="resize-handle absolute bottom-0 left-1/2 w-8 h-2 -translate-x-1/2 cursor-s-resize opacity-0 group-hover:opacity-100 transition-opacity rounded-t-sm"
                        onMouseDown={(e) => handleResizeStart(e, 's')}
                        style={{ backgroundColor: color }}
                    />
                </div>
            );
        };

        // BookCover
        const BookCover = memo(({ book, onClick, onDelete, onEdit }) => {
            return (
                <div className="group perspective-1000 relative" style={{ perspective: '1200px' }} onClick={onClick}>
                    <div className="absolute top-[8px] bottom-[8px] left-0 w-full bg-white shadow-sm transform translate-x-[9px] z-[1] border border-slate-200 opacity-40"></div>
                    <div className="absolute top-[6px] bottom-[6px] left-0 w-full bg-white shadow-sm transform translate-x-[6px] z-[2] border border-slate-200 opacity-70"></div>
                    <div className="absolute top-[4px] bottom-[4px] left-0 w-full bg-white shadow-sm transform translate-x-[3px] z-[3] border border-slate-200 opacity-90"></div>
                    <div className="absolute top-[2px] bottom-[3px] left-[-1px] w-full page-bg shadow-sm transform translate-x-[1px] z-[4] border-l border-slate-200"></div>
                    
                    <motion.div initial={{ rotateY: 0 }} whileHover={{ rotateY: -20 }} transition={{ type: "spring", stiffness: 200, damping: 15 }} className="book-card relative rounded-[3px] shadow-lg cursor-pointer flex flex-col overflow-hidden origin-left z-10 h-full" style={{ backgroundColor: book.color || '#475569', aspectRatio: '2 / 3' }}>
                        <div className="absolute inset-0 book-spine pointer-events-none z-10"></div>
                        <div className="absolute left-0 top-0 bottom-0 w-[15px] bg-black/10 z-10"></div>
                        <div className="flex-1 p-8 flex flex-col relative z-20 text-white">
                            <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-4 border-b border-white/20 pb-2">NOVEL PROJECT</div>
                            <h3 className="text-2xl font-black leading-tight tracking-tight break-keep drop-shadow-md">{book.title}</h3>
                            <div className="mt-2 text-xs opacity-70">{book.author || "ÏûëÍ∞Ä ÎØ∏ÏÉÅ"}</div>
                            <div className="mt-auto pt-4 space-y-1">
                                <div className="flex items-center gap-2 text-[11px] font-bold opacity-80">
                                    <span className="opacity-60">Î≥¥Îìú</span> {book.projects?.filter(p => p.type === 'board').length || 0}
                                    <span className="mx-1 opacity-40">|</span>
                                    <span className="opacity-60">Î¨∏ÏÑú</span> {book.projects?.filter(p => p.type === 'doc').length || 0}
                                </div>
                            </div>
                        </div>
                        <div className="absolute bottom-4 right-4 z-30 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(book); }} className="p-2 text-white/40 hover:text-white hover:bg-white/20 rounded-[3px]" title="ÏàòÏ†ï"><IconSettings className="w-4 h-4" /></button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(book.id, e); }} className="p-2 text-white/40 hover:text-white hover:bg-white/20 rounded-[3px]" title="ÏÇ≠Ï†ú"><IconTrash className="w-4 h-4" /></button>
                        </div>
                    </motion.div>
                </div>
            );
        }, (prevProps, nextProps) => {
            return (
                prevProps.book.id === nextProps.book.id &&
                prevProps.book.title === nextProps.book.title &&
                prevProps.book.author === nextProps.book.author &&
                prevProps.book.color === nextProps.book.color &&
                prevProps.book.projects?.length === nextProps.book.projects?.length
            );
        });

        // BookSettingsModal
        const BookSettingsModal = ({ onClose, onConfirm, initialData }) => { 
            const [title, setTitle] = useState(initialData?.title || 'ÏÉà ÏûëÌíà'); 
            const [author, setAuthor] = useState(initialData?.author || ''); 
            const [selectedColor, setSelectedColor] = useState(initialData?.color || BOOK_COLORS[0]); 
            
            const handleExportToWord = async () => {
                if (!initialData) return;
                
                // ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú Ï≤¥ÌÅ¨
                if (!window.docx || !window.JSZip || !window.saveAs) {
                    alert("ÌïÑÏàò ÎùºÏù¥Î∏åÎü¨Î¶¨(docx, jszip, FileSaver)Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò ÏÉàÎ°úÍ≥†Ïπ® Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }

                try {
                    const zip = new JSZip();
                    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;

                    // 1. Î≥¥Îìú(Board) ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                    const boardProjects = initialData.projects.filter(p => p.type === 'board');
                    for (const proj of boardProjects) {
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({ text: `${proj.name} - Î≥¥Îìú Îç∞Ïù¥ÌÑ∞`, heading: HeadingLevel.HEADING_1 }),
                                    ...proj.nodes.flatMap(node => [
                                        new Paragraph({ text: "" }),
                                        new Paragraph({ 
                                            children: [
                                                new TextRun({ text: `${node.data.emoji || 'üìç'} ${node.label}`, bold: true, size: 28 }),
                                                new TextRun({ text: ` [${node.type}]`, size: 20, color: "666666" })
                                            ] 
                                        }),
                                        new Paragraph({
                                            text: (() => {
                                                switch(node.type) {
                                                    case 'Ïù∏Î¨º': return `ÏÑ±Î≥Ñ: ${node.data.gender} / ÎÇòÏù¥: ${node.data.age || 'ÎØ∏ÏÉÅ'} / ÏßÅÏóÖ: ${node.data.job || 'ÏóÜÏùå'}`;
                                                    case 'ÏÇ¨Í±¥': return `Ïû•ÏÜå: ${node.data.place || 'ÎØ∏ÏÉÅ'} / ÏãúÍ∏∞: ${node.data.year || 'ÎØ∏ÏÉÅ'}`;
                                                    case 'Ïû•ÏÜå': return `ÏßÄÏó≠: ${node.data.region || 'ÎØ∏ÏÉÅ'} / Í∏∞ÌõÑ: ${node.data.climate || 'ÎØ∏ÏÉÅ'}`;
                                                    case 'ÏïÑÏù¥ÌÖú': return `Î∂ÑÎ•ò: ${node.data.category || 'ÏùºÎ∞ò'} / Ìù¨Í∑ÄÎèÑ: ${node.data.rarity || 'Î≥¥ÌÜµ'} / ÏÜåÏú†Ïûê: ${node.data.owner || 'ÏóÜÏùå'}`;
                                                    case 'ÏÑ∏Î†•': return `Î¶¨Îçî: ${node.data.leader || 'ÎØ∏ÏÉÅ'} / ÏòÅÏó≠: ${node.data.territory || 'ÎØ∏ÏÉÅ'}`;
                                                    case 'Î≥µÏÑ†': return `Îì±Ïû•: ${node.data.chapter || 'ÎØ∏ÏÉÅ'} / ÏÉÅÌÉú: ${node.data.status || 'ÎØ∏ÌöåÏàò'}`;
                                                    case 'ÌÉÄÏûÑÎùºÏù∏': return `ÏãúÏ†ê: ${node.data.date || 'ÎØ∏ÏÉÅ'} / ÏãúÎåÄ: ${node.data.era || 'ÎØ∏ÏÉÅ'}`;
                                                    case 'ÏÑ§Ï†ï': return `Î∂ÑÎ•ò: ${node.data.category || 'ÏÑ∏Í≥ÑÍ¥Ä'} / Î≤îÏúÑ: ${node.data.scope || 'ÎØ∏ÏÉÅ'}`;
                                                    case 'ÎåÄÏÇ¨': return `ÌôîÏûê: ${node.data.speaker || 'ÎØ∏ÏÉÅ'} / Í∞êÏ†ï: ${node.data.emotion || 'ÎØ∏ÏÉÅ'}`;
                                                    case 'Í∞àÎì±': return `ÎãπÏÇ¨Ïûê: ${node.data.parties || 'ÎØ∏ÏÉÅ'} / ÏÉÅÌÉú: ${node.data.status || 'ÏßÑÌñâÏ§ë'}`;
                                                    case 'Í∑∏Î£π': return `ÌïòÏúÑ ÎÖ∏Îìú: ${node.data.childNodes?.length || 0}Í∞ú`;
                                                    default: return "Î©îÎ™®";
                                                }
                                            })(),
                                            italic: true
                                        }),
                                        new Paragraph({ text: node.data.memo || "ÎÇ¥Ïö© ÏóÜÏùå" }),
                                        new Paragraph({ text: "--------------------------------------------------" })
                                    ])
                                ]
                            }]
                        });
                        const blob = await Packer.toBlob(doc);
                        zip.file(`Î≥¥Îìú_${proj.name.replace(/[\/\*\\\?|:<>"]/g, '_')}.docx`, blob);
                    }

                    // 2. Î¨∏ÏÑú(Doc) ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                    const docProjects = initialData.projects.filter(p => p.type === 'doc');
                    for (const proj of docProjects) {
                        const lines = (proj.content || "").split('\n');
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({ text: proj.name, heading: HeadingLevel.HEADING_1 }),
                                    new Paragraph({ text: `ÏÉÅÌÉú: ${proj.status || 'Ï¥àÍ≥†'} / Í≥µÎ∞±Ìè¨Ìï® ${proj.content?.length || 0}Ïûê`, spacing: { after: 400 } }),
                                    ...lines.map(line => new Paragraph({ 
                                        children: [new TextRun({ text: line })],
                                        spacing: { line: 360, before: 120 } 
                                    }))
                                ]
                            }]
                        });
                        const blob = await Packer.toBlob(doc);
                        zip.file(`ÏõêÍ≥†_${proj.name.replace(/[\/\*\\\?|:<>"]/g, '_')}.docx`, blob);
                    }

                    // 3. ÏïïÏ∂ï Î∞è Ï†ÄÏû•
                    const content = await zip.generateAsync({ type: "blob" });
                    window.saveAs(content, `${initialData.title}_word.zip`);

                } catch (e) {
                    console.error(e);
                    alert("ÌååÏùº ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message);
                }
            };

            const handleSubmit = () => { 
                if (!title.trim()) { alert("ÏûëÌíà Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; } 
                onConfirm(title, author, selectedColor); 
            }; 
            
            const handleKeyDown = (e) => { 
                if (e.key === 'Enter') handleSubmit(); 
                if (e.key === 'Escape') onClose(); 
            }; 
            
            return ( 
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}> 
                    <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="bg-white dark:bg-darkpanel p-8 rounded-[3px] shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700" onClick={e => e.stopPropagation()}> 
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100">{initialData ? 'ÏûëÌíà ÏÑ§Ï†ï ÏàòÏ†ï' : 'ÏÉà ÏûëÌíà ÎßåÎì§Í∏∞'}</h2> 
                            {initialData && (
                                <button onClick={handleExportToWord} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 transition-colors border border-blue-200 dark:border-blue-800 rounded-sm">
                                    {/* ÏõåÎìú ÏïÑÏù¥ÏΩò SVG */}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                        <polyline points="14 2 14 8 20 8" />
                                        <path d="M8 13l1.5 4 1.5-3 1.5 3 1.5-4" />
                                    </svg>
                                    <span className="text-[10px] font-black">Word Ï†ÄÏû•</span>
                                </button>
                            )}
                        </div>
                        <div className="mb-4"> 
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ÏûëÌíà Ï†úÎ™©</label> 
                            <input autoFocus type="text" value={title} onChange={(e) => setTitle(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ÏûëÌíà Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" /> 
                        </div> 
                        <div className="mb-6"> 
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ÏûëÍ∞Ä Ïù¥Î¶Ñ (ÌïÑÎ™Ö)</label> 
                            <input type="text" value={author} onChange={(e) => setAuthor(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ÏûëÍ∞ÄÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉù)" /> 
                        </div> 
                        <div className="mb-8"> 
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">ÌëúÏßÄ ÏÉâÏÉÅ</label> 
                            <div className="flex flex-wrap gap-2"> {BOOK_COLORS.map(color => ( <button key={color} onClick={() => setSelectedColor(color)} className={`w-8 h-8 rounded-full shadow-sm transition-transform hover:scale-110 flex items-center justify-center ${selectedColor === color ? 'ring-2 ring-offset-2 ring-indigo-500 dark:ring-offset-darkpanel' : ''}`} style={{ backgroundColor: color }}> {selectedColor === color && <svg className="w-4 h-4 text-white/80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>} </button> ))} </div> 
                        </div> 
                        <div className="flex gap-2"> 
                            <button onClick={onClose} className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-[3px] transition-colors">Ï∑®ÏÜå</button> 
                            <button onClick={handleSubmit} className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-[3px] shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">{initialData ? 'Ï†ÄÏû•ÌïòÍ∏∞' : 'ÎßåÎì§Í∏∞'}</button> 
                        </div> 
                    </motion.div> 
                </div> 
            ); 
        };

        // ExportModal Ïª¥Ìè¨ÎÑåÌä∏ Ï∂îÍ∞Ä
        const ExportModal = ({ onClose, onConfirm }) => {
            const now = new Date();
            const defaultFilename = `sagak_studio_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            
            const [filename, setFilename] = useState(defaultFilename);
            const [exportType, setExportType] = useState('json');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');

            const handleSubmit = () => {
                if (!filename.trim()) {
                    alert("ÌååÏùºÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                
                if (exportType === 'vel') {
                    if (!password) {
                        alert("ÏïîÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert("ÏïîÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
                        return;
                    }
                }
                
                onConfirm(filename, exportType, password);
            };

            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div 
                        initial={{ opacity: 0, scale: 0.9 }} 
                        animate={{ opacity: 1, scale: 1 }} 
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700" 
                        onClick={e => e.stopPropagation()}
                    >
                        <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">ÌååÏùº Ï†ÄÏû•</h2>
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ÌååÏùºÎ™Ö</label>
                            <div className="flex gap-2">
                                <input
                                    autoFocus
                                    type="text"
                                    value={filename}
                                    onChange={(e) => setFilename(e.target.value)}
                                    className="flex-1 p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                    placeholder="ÌååÏùºÎ™Ö ÏûÖÎ†•"
                                />
                                <select
                                    value={exportType}
                                    onChange={(e) => setExportType(e.target.value)}
                                    className="px-4 py-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors cursor-pointer"
                                >
                                    <option value="json">ÏùºÎ∞ò (.json)</option>
                                    <option value="vel">ÏïîÌò∏Ìôî (.vel)</option>
                                </select>
                            </div>
                        </div>
                        {exportType === 'vel' && (
                            <div className="mb-6 space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ÏïîÌò∏</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ÏïîÌò∏ ÏûÖÎ†•"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ÏïîÌò∏ ÌôïÏù∏</label>
                                    <input 
                                        type="password" 
                                        value={passwordConfirm} 
                                        onChange={(e) => setPasswordConfirm(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ÏïîÌò∏ Ïû¨ÏûÖÎ†•"
                                    />
                                </div>
                            </div>
                        )}
                        <div className="flex gap-2">
                            <button 
                                onClick={onClose}
                                className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                            >
                                Ï∑®ÏÜå
                            </button>
                            <button 
                                onClick={handleSubmit}
                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                            >
                                Ï†ÄÏû•ÌïòÍ∏∞
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

       const NameGenerator = ({ onConfirm, onClose, settings, onSettingsChange }) => {
            // Î∂ÄÎ™®Î°úÎ∂ÄÌÑ∞ Î∞õÏùÄ settingsÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ Ï¥àÍ∏∞Í∞íÏúºÎ°ú ÏÇ¨Ïö©
            const [genre, setGenre] = useState(settings?.genre || 'korean');
            const [role, setRole] = useState(settings?.role || 'modern');
            const [gender, setGender] = useState(settings?.gender || 'random');
            const [generatedName, setGeneratedName] = useState(null);

            // ÏÑ§Ï†ïÏù¥ Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Î∂ÄÎ™®(Workspace)Ïóê Ï†ÄÏû• (Í∏∞ÏñµÌïòÍ∏∞)
            useEffect(() => {
                if (onSettingsChange) {
                    onSettingsChange({ genre, role, gender });
                }
            }, [genre, role, gender]);

            const handleGenerate = () => {
                const dataSet = NAME_DB[genre][role];
                if (!dataSet) return;

                let targetGender = gender;
                if (targetGender === 'random') {
                    targetGender = Math.random() < 0.5 ? 'm' : 'f';
                }

                const nameList = targetGender === 'm' ? dataSet.m : dataSet.f;
                const surnameList = dataSet.s;

                const rawName = nameList[Math.floor(Math.random() * nameList.length)];
                const rawSurname = surnameList[Math.floor(Math.random() * surnameList.length)];

                let fullName = "";

                if (genre === 'fantasy') {
                    const [krName, enName] = rawName.split('|');
                    const [krSur, enSur] = rawSurname.split('|');
                    if (krSur === "(ÏÑ± ÏóÜÏùå)") {
                        fullName = `${krName} (${enName})`;
                    } else {
                        fullName = `${krName} ${krSur} (${enName} ${enSur})`;
                    }
                } else if (genre === 'wuxia') {
                    const krName = rawName.split('|')[0];
                    const krSur = rawSurname.split('|')[0];
                    fullName = `${krSur}${krName}`;
                } else {
                    fullName = `${rawSurname}${rawName}`;
                }
                setGeneratedName(fullName);
            };

            // Ïû•Î•¥ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨ (Ïû•Î•¥Î•º Î∞îÍøÄ ÎïåÎßå Ïó≠Ìï†ÏùÑ Ï≤´ Î≤àÏß∏ Ìï≠Î™©ÏúºÎ°ú Ï¥àÍ∏∞Ìôî)
            const handleGenreChange = (e) => {
                const newGenre = e.target.value;
                setGenre(newGenre);
                
                // Ïû•Î•¥Í∞Ä Î∞îÎÄåÎ©¥ Ìï¥Îãπ Ïû•Î•¥Ïùò Ï≤´ Î≤àÏß∏ Ïó≠Ìï†Î°ú ÏûêÎèô Î≥ÄÍ≤Ω
                if (NAME_ROLES[newGenre] && NAME_ROLES[newGenre].length > 0) {
                    setRole(NAME_ROLES[newGenre][0].id);
                }
            };

            useEffect(() => {
                if(!generatedName) handleGenerate();
            }, []);

            return (
                <motion.div 
                    initial={{ opacity: 0, height: 0 }} 
                    animate={{ opacity: 1, height: 'auto' }} 
                    exit={{ opacity: 0, height: 0 }}
                    className="mt-4 border-t border-slate-200 dark:border-zinc-700 pt-4 overflow-hidden"
                >
                    <div className="bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-[3px] border border-slate-200 dark:border-zinc-700 mb-3">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-[11px] font-black text-slate-500 uppercase tracking-widest dark:text-zinc-400">üé≤ Ïù¥Î¶Ñ ÏÉùÏÑ±Í∏∞</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-2 mb-3">
                            {/* onChange Ìï∏Îì§Îü¨ ÍµêÏ≤¥ */}
                            <select value={genre} onChange={handleGenreChange} className="p-2 text-xs font-bold rounded-[3px] border border-slate-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 outline-none">
                                <option value="korean">üèôÔ∏è ÌòÑÎåÄ ÌïúÍµ≠</option>
                                <option value="fantasy">‚öîÔ∏è ÌåêÌÉÄÏßÄ</option>
                                <option value="wuxia">üêâ Î¨¥Ìòë</option>
                            </select>
                            <select value={gender} onChange={(e) => setGender(e.target.value)} className="p-2 text-xs font-bold rounded-[3px] border border-slate-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 outline-none">
                                <option value="random">üé≤ ÏÑ±Î≥Ñ ÎûúÎç§</option>
                                <option value="m">‚Äç‚ôÇÔ∏è ÎÇ®ÏÑ±</option>
                                <option value="f">‚Äç‚ôÄÔ∏è Ïó¨ÏÑ±</option>
                            </select>
                            <select value={role} onChange={(e) => setRole(e.target.value)} className="col-span-2 p-2 text-xs font-bold rounded-[3px] border border-slate-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 outline-none">
                                {NAME_ROLES[genre].map(r => (
                                    <option key={r.id} value={r.id}>{r.text}</option>
                                ))}
                            </select>
                        </div>

                        <div 
                            onClick={() => generatedName && onConfirm(generatedName)}
                            className="bg-white dark:bg-zinc-700 p-3 rounded-[3px] border border-dashed border-indigo-300 dark:border-zinc-500 text-center cursor-pointer hover:bg-indigo-50 dark:hover:bg-zinc-600 transition-colors group relative"
                        >
                            <div className="text-sm font-black text-slate-800 dark:text-white break-keep leading-snug">
                                {generatedName || "ÏÉùÏÑ± Ï§ë..."}
                            </div>
                            <div className="text-[9px] text-indigo-400 dark:text-indigo-300 font-bold mt-1 opacity-0 group-hover:opacity-100 transition-opacity">ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ÅÏö©</div>
                        </div>

                        <button onClick={handleGenerate} className="w-full mt-2 py-2 bg-indigo-600 text-white text-xs font-black rounded-[3px] shadow-sm hover:bg-indigo-700 transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">
                            ÏÉàÎ°úÏö¥ Ïù¥Î¶Ñ ÏÉùÏÑ±
                        </button>
                    </div>
                </motion.div>
            );
        };

        const ImportModal = ({ onClose, onConfirm, fileData, isEncrypted }) => {
            const [password, setPassword] = useState('');
            const [importMode, setImportMode] = useState('replace'); // 'replace' ÎòêÎäî 'append'
            const [step, setStep] = useState(isEncrypted ? 'password' : 'mode'); // 'password' ÎòêÎäî 'mode'
            const [decryptedData, setDecryptedData] = useState(null);

            const handlePasswordSubmit = () => {
                if (!password.trim()) {
                    alert("ÏïîÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }

                try {
                    const bytes = CryptoJS.AES.decrypt(fileData, password);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedText) throw new Error("Decryption failed");
                    const parsed = JSON.parse(decryptedText);
                    setDecryptedData(parsed);
                    setStep('mode');
                } catch (error) {
                    alert("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ¶¨Í±∞ÎÇò ÏÜêÏÉÅÎêú ÌååÏùºÏûÖÎãàÎã§.");
                }
            };

            const handleImport = () => {
                const dataToImport = isEncrypted ? decryptedData : JSON.parse(fileData);
                onConfirm(dataToImport, importMode === 'replace');
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (step === 'password') {
                        handlePasswordSubmit();
                    } else {
                        handleImport();
                    }
                }
                if (e.key === 'Escape') onClose();
            };

            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}>
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-darkpanel p-8 rounded-sm shadow-2xl w-[450px] border border-slate-200 dark:border-zinc-700"
                        onClick={e => e.stopPropagation()}
                    >
                        {step === 'password' ? (
                            <>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">ÏïîÌò∏ÌôîÎêú ÌååÏùº</h2>

                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase">ÏïîÌò∏ ÏûÖÎ†•</label>
                                    <input
                                        autoFocus
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyDown={handleKeyDown}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ÌååÏùº ÏïîÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                    />
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                    >
                                        Ï∑®ÏÜå
                                    </button>
                                    <button
                                        onClick={handlePasswordSubmit}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                    >
                                        ÌôïÏù∏
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">ÌååÏùº Î∂àÎü¨Ïò§Í∏∞</h2>

                                <div className="mb-6">
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase">Î∂àÎü¨Ïò§Í∏∞ Î∞©Ïãù</label>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => setImportMode('replace')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                importMode === 'replace'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ÎçÆÏñ¥Ïì∞Í∏∞</div>
                                            <div className="text-xs opacity-70">Í∏∞Ï°¥ ÏÑúÏû¨Î•º ÏÇ≠Ï†úÌïòÍ≥† Î∂àÎü¨Ïò® ÌååÏùºÎ°ú ÎåÄÏ≤¥Ìï©ÎãàÎã§</div>
                                        </button>
                                        <button
                                            onClick={() => setImportMode('append')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                importMode === 'append'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">Ï∂îÍ∞ÄÌïòÍ∏∞</div>
                                            <div className="text-xs opacity-70">Í∏∞Ï°¥ ÏÑúÏû¨ Îí§Ïóê Î∂àÎü¨Ïò® ÌååÏùºÏùÑ Ï∂îÍ∞ÄÌï©ÎãàÎã§</div>
                                        </button>
                                    </div>
                                </div>

                                <div className="flex gap-2">
                                    <button
                                        onClick={onClose}
                                        className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                    >
                                        Ï∑®ÏÜå
                                    </button>
                                    <button
                                        onClick={handleImport}
                                        className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                    >
                                        Î∂àÎü¨Ïò§Í∏∞
                                    </button>
                                </div>
                            </>
                        )}
                    </motion.div>
                </div>
            );
        };

        // FilePanel - ÎÇ¥Î∂Ä Ï∞Ω Î∞©ÏãùÏùò Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ Ìå®ÎÑê
        const FilePanel = ({ isOpen, mode, onClose, books, onExport, onFileSelect, importData, onConfirmImport }) => {
            const [filename, setFilename] = useState('sagak_backup');
            const [exportType, setExportType] = useState('json');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');
            const [importMode, setImportMode] = useState('replace');
            const [importPassword, setImportPassword] = useState('');
            const [decryptedData, setDecryptedData] = useState(null);
            const [importStep, setImportStep] = useState('select'); // 'select', 'password', 'mode'
            const fileInputRef = useRef(null);

            // Ìå®ÎÑêÏù¥ Ïó¥Î¶¥ Îïå ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            useEffect(() => {
                if (isOpen) {
                    if (mode === 'save') {
                        setFilename('sagak_backup');
                        setExportType('json');
                        setPassword('');
                        setPasswordConfirm('');
                    } else {
                        setImportStep('select');
                        setImportPassword('');
                        setDecryptedData(null);
                        setImportMode('replace');
                    }
                }
            }, [isOpen, mode]);

            // importDataÍ∞Ä Î≥ÄÍ≤ΩÎêòÎ©¥ Ï≤òÎ¶¨
            useEffect(() => {
                if (importData) {
                    if (importData.isEncrypted) {
                        setImportStep('password');
                    } else {
                        setImportStep('mode');
                    }
                }
            }, [importData]);

            const handleSave = () => {
                if (!filename.trim()) {
                    alert("ÌååÏùºÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                if (exportType === 'vel') {
                    if (!password.trim()) {
                        alert("ÏïîÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    if (password !== passwordConfirm) {
                        alert("ÏïîÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
                        return;
                    }
                }
                onExport(filename, exportType, password);
                onClose();
            };

            const handleDecrypt = () => {
                if (!importPassword.trim()) {
                    alert("ÏïîÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                try {
                    const bytes = CryptoJS.AES.decrypt(importData.content, importPassword);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedText) throw new Error("Decryption failed");
                    const parsed = JSON.parse(decryptedText);
                    setDecryptedData(parsed);
                    setImportStep('mode');
                } catch (error) {
                    alert("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ¶¨Í±∞ÎÇò ÏÜêÏÉÅÎêú ÌååÏùºÏûÖÎãàÎã§.");
                }
            };

            const handleImport = () => {
                const dataToImport = importData.isEncrypted ? decryptedData : JSON.parse(importData.content);
                onConfirmImport(dataToImport, importMode === 'replace');
                onClose();
            };

            if (!isOpen) return null;

            return (
                <motion.div
                    initial={{ x: '100%' }}
                    animate={{ x: 0 }}
                    exit={{ x: '100%' }}
                    transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                    className="fixed top-0 right-0 h-full w-[420px] bg-white dark:bg-darkpanel shadow-2xl z-[100] flex flex-col border-l border-slate-200 dark:border-zinc-700"
                >
                    <div className="h-16 px-6 flex items-center justify-between border-b border-slate-200 dark:border-zinc-700 shrink-0">
                        <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100">
                            {mode === 'save' ? 'ÌååÏùº Ï†ÄÏû•' : 'ÌååÏùº Î∂àÎü¨Ïò§Í∏∞'}
                        </h2>
                        <button
                            onClick={onClose}
                            className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 rounded-sm transition-colors"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6">
                        {mode === 'save' ? (
                            <div className="space-y-6">
                                {/* ÌååÏùºÎ™Ö */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ÌååÏùºÎ™Ö</label>
                                    <input
                                        type="text"
                                        value={filename}
                                        onChange={(e) => setFilename(e.target.value)}
                                        className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                        placeholder="ÌååÏùºÎ™Ö ÏûÖÎ†•"
                                    />
                                </div>

                                {/* Ï†ÄÏû• ÌòïÏãù */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">Ï†ÄÏû• ÌòïÏãù</label>
                                    <div className="space-y-2">
                                        <button
                                            onClick={() => setExportType('json')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                exportType === 'json'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ÏùºÎ∞ò Ï†ÄÏû• (.json)</div>
                                            <div className="text-xs opacity-70">ÏïîÌò∏Ìôî ÏóÜÏù¥ ÏùºÎ∞ò JSON ÌòïÏãùÏúºÎ°ú Ï†ÄÏû•</div>
                                        </button>
                                        <button
                                            onClick={() => setExportType('vel')}
                                            className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                exportType === 'vel'
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                    : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                            }`}
                                        >
                                            <div className="font-black mb-1">ÏïîÌò∏Ìôî Ï†ÄÏû• (.vel)</div>
                                            <div className="text-xs opacity-70">ÏïîÌò∏Î•º ÏÑ§Ï†ïÌïòÏó¨ ÏïàÏ†ÑÌïòÍ≤å Ï†ÄÏû•</div>
                                        </button>
                                    </div>
                                </div>

                                {/* ÏïîÌò∏ ÏûÖÎ†• (vel ÏÑ†ÌÉù Ïãú) */}
                                <AnimatePresence>
                                    {exportType === 'vel' && (
                                        <motion.div
                                            initial={{ opacity: 0, height: 0 }}
                                            animate={{ opacity: 1, height: 'auto' }}
                                            exit={{ opacity: 0, height: 0 }}
                                            className="space-y-4 overflow-hidden"
                                        >
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ÏïîÌò∏</label>
                                                <input
                                                    type="password"
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                    placeholder="ÏïîÌò∏ ÏûÖÎ†•"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ÏïîÌò∏ ÌôïÏù∏</label>
                                                <input
                                                    type="password"
                                                    value={passwordConfirm}
                                                    onChange={(e) => setPasswordConfirm(e.target.value)}
                                                    className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                    placeholder="ÏïîÌò∏ Ïû¨ÏûÖÎ†•"
                                                />
                                            </div>
                                        </motion.div>
                                    )}
                                </AnimatePresence>

                                <div className="p-4 bg-slate-50 dark:bg-zinc-800/50 rounded-sm border border-slate-200 dark:border-zinc-700">
                                    <div className="text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase mb-2">Ï†ÄÏû• Ï†ïÎ≥¥</div>
                                    <div className="text-sm font-medium text-slate-700 dark:text-zinc-300">
                                        <div className="flex justify-between mb-1">
                                            <span>Ï¥ù ÏûëÌíà Ïàò</span>
                                            <span className="font-black">{books.length}Í∞ú</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>Ï†ÄÏû• ÌòïÏãù</span>
                                            <span className="font-black">{exportType === 'json' ? 'JSON' : 'ÏïîÌò∏Ìôî (VEL)'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {importStep === 'select' && (
                                    <>
                                        <div className="text-center py-10">
                                            <div className="w-20 h-20 mx-auto mb-4 bg-slate-100 dark:bg-zinc-800 rounded-full flex items-center justify-center">
                                                <IconUpload className="w-8 h-8 text-slate-400 dark:text-zinc-500" />
                                            </div>
                                            <p className="text-sm font-bold text-slate-600 dark:text-zinc-400 mb-1">ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
                                            <p className="text-xs text-slate-400 dark:text-zinc-500">.json ÎòêÎäî .vel ÌååÏùºÏùÑ ÏßÄÏõêÌï©ÎãàÎã§</p>
                                        </div>
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                        >
                                            ÌååÏùº ÏÑ†ÌÉù
                                        </button>
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) onFileSelect(file);
                                                e.target.value = '';
                                            }}
                                            className="hidden"
                                            accept=".json,.vel"
                                        />
                                    </>
                                )}

                                {importStep === 'password' && (
                                    <>
                                        <div className="text-center py-6">
                                            <div className="w-16 h-16 mx-auto mb-4 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                                                <svg className="w-7 h-7 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                                </svg>
                                            </div>
                                            <p className="text-sm font-black text-slate-700 dark:text-zinc-300 mb-1">ÏïîÌò∏ÌôîÎêú ÌååÏùº</p>
                                            <p className="text-xs text-slate-400 dark:text-zinc-500">ÌååÏùºÏùÑ Ïó¥Î†§Î©¥ ÏïîÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ÏïîÌò∏ ÏûÖÎ†•</label>
                                            <input
                                                type="password"
                                                value={importPassword}
                                                onChange={(e) => setImportPassword(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleDecrypt()}
                                                className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-sm text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors"
                                                placeholder="ÌååÏùº ÏïîÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                autoFocus
                                            />
                                        </div>
                                        <div className="flex gap-2 pt-2">
                                            <button
                                                onClick={() => setImportStep('select')}
                                                className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-sm transition-colors"
                                            >
                                                Îã§Î•∏ ÌååÏùº
                                            </button>
                                            <button
                                                onClick={handleDecrypt}
                                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-sm shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600"
                                            >
                                                ÌôïÏù∏
                                            </button>
                                        </div>
                                    </>
                                )}

                                {importStep === 'mode' && (
                                    <>
                                        <div className="text-center py-4">
                                            <div className="w-14 h-14 mx-auto mb-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center">
                                                <svg className="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                            <p className="text-sm font-black text-slate-700 dark:text-zinc-300">ÌååÏùº Ï§ÄÎπÑ ÏôÑÎ£å</p>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">Î∂àÎü¨Ïò§Í∏∞ Î∞©Ïãù</label>
                                            <div className="space-y-2">
                                                <button
                                                    onClick={() => setImportMode('replace')}
                                                    className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                        importMode === 'replace'
                                                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                            : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                    }`}
                                                >
                                                    <div className="font-black mb-1">ÎçÆÏñ¥Ïì∞Í∏∞</div>
                                                    <div className="text-xs opacity-70">Í∏∞Ï°¥ ÏÑúÏû¨Î•º ÏÇ≠Ï†úÌïòÍ≥† Î∂àÎü¨Ïò® ÌååÏùºÎ°ú ÎåÄÏ≤¥Ìï©ÎãàÎã§</div>
                                                </button>
                                                <button
                                                    onClick={() => setImportMode('append')}
                                                    className={`w-full p-4 rounded-sm border-2 font-bold text-sm transition-all text-left ${
                                                        importMode === 'append'
                                                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
                                                            : 'border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300'
                                                    }`}
                                                >
                                                    <div className="font-black mb-1">Ï∂îÍ∞ÄÌïòÍ∏∞</div>
                                                    <div className="text-xs opacity-70">Í∏∞Ï°¥ ÏÑúÏû¨ Îí§Ïóê Î∂àÎü¨Ïò® ÌååÏùºÏùÑ Ï∂îÍ∞ÄÌï©ÎãàÎã§</div>
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="p-6 border-t border-slate-200 dark:border-zinc-700 shrink-0">
                        {mode === 'save' ? (
                            <button
                                onClick={handleSave}
                                className="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-600 dark:hover:bg-indigo-500"
                            >
                                Ï†ÄÏû•ÌïòÍ∏∞
                            </button>
                        ) : (
                            importStep === 'mode' && (
                                <button
                                    onClick={handleImport}
                                    className="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white font-black text-sm rounded-sm shadow-md transition-colors dark:bg-indigo-600 dark:hover:bg-indigo-500"
                                >
                                    Î∂àÎü¨Ïò§Í∏∞
                                </button>
                            )
                        )}
                    </div>
                </motion.div>
            );
        };

        // Workspace
        const Workspace = ({ currentBook, onUpdateBook, onExit, showToast }) => {
            const [projects, setProjects] = useState(currentBook.projects || []);
            const [activeProjectId, setActiveProjectId] = useState(currentBook.activeProjectId || (currentBook.projects[0] ? currentBook.projects[0].id : 'default'));
            const [expandedProjects, setExpandedProjects] = useState(currentBook.expandedProjects || (currentBook.projects[0] ? { [currentBook.projects[0].id]: true } : {}));
            const [scale, setScale] = useState(currentBook.scale || 1);
            const [pan, setPan] = useState(currentBook.pan || { x: 0, y: 0 });
            const panAnimationRef = useRef(null);
            
            // ÌÜµÌï© Î∑∞Ìè¨Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò (Pan + Scale)
            const animateViewport = useCallback((targetPan, targetScale, duration = 600) => {
                if (panAnimationRef.current) cancelAnimationFrame(panAnimationRef.current);
                
                const startPan = { ...pan };
                const startScale = scale;
                const startTime = performance.now();
                
                // Quintic ease-out for smoother motion
                const easeOutQuint = (t) => 1 - Math.pow(1 - t, 5);

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = easeOutQuint(progress);

                    setPan({
                        x: startPan.x + (targetPan.x - startPan.x) * easedProgress,
                        y: startPan.y + (targetPan.y - startPan.y) * easedProgress
                    });
                    
                    if (targetScale !== undefined && targetScale !== null) {
                        setScale(startScale + (targetScale - startScale) * easedProgress);
                    }

                    if (progress < 1) {
                        panAnimationRef.current = requestAnimationFrame(animate);
                    } else {
                        panAnimationRef.current = null;
                    }
                };
                panAnimationRef.current = requestAnimationFrame(animate);
            }, [pan, scale]);

            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [isZenMode, setIsZenMode] = useState(false); 
            const titleInputRef = useRef(null);
            const workspaceTimerRef = useRef(null);
            const [isNameGenOpen, setIsNameGenOpen] = useState(false); // Ïù¥Î¶Ñ ÏÉùÏÑ±Í∏∞ ÌÜ†Í∏Ä ÏÉÅÌÉú
            const [nameGenSettings, setNameGenSettings] = useState({ genre: 'korean', role: 'modern', gender: 'random' });
            const [showNodeDropdown, setShowNodeDropdown] = useState(false); // Ï∂îÍ∞Ä ÎÖ∏Îìú ÎìúÎ°≠Îã§Ïö¥
            const nodeDropdownRef = useRef(null);
            useEffect(() => {
                if (!showNodeDropdown) return;
                const handleClickOutside = (e) => {
                    if (nodeDropdownRef.current && !nodeDropdownRef.current.contains(e.target)) {
                        setShowNodeDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showNodeDropdown]);

            const fitToScreen = useCallback((targetNodes = activeProject?.nodes || []) => {
                if (!targetNodes || targetNodes.length === 0) {
                    animateViewport({ x: 0, y: 0 }, 1);
                    return;
                }
                const minX = Math.min(...targetNodes.map(n => n.x));
                const minY = Math.min(...targetNodes.map(n => n.y));
                const maxX = Math.max(...targetNodes.map(n => n.x)) + CARD_W;
                const maxY = Math.max(...targetNodes.map(n => n.y)) + CARD_H;
                
                const viewportW = containerRef.current.clientWidth;
                const viewportH = containerRef.current.clientHeight;
                const padding = 100;
                
                const scaleX = (viewportW - padding * 2) / (maxX - minX);
                const scaleY = (viewportH - padding * 2) / (maxY - minY);
                
                let newScale = Math.min(Math.max(Math.min(scaleX, scaleY), 0.2), 1.5);
                
                const newPan = { 
                    x: (viewportW / 2) - ((minX + maxX) / 2 * newScale), 
                    y: (viewportH / 2) - ((minY + maxY) / 2 * newScale) 
                };

                animateViewport(newPan, newScale);
                showToast("ÌôîÎ©¥Ïóê ÎßûÍ≤å Ï°∞Ï†ïÎêòÏóàÏäµÎãàÎã§.");
            }, [projects, activeProjectId, animateViewport, showToast]);

            useEffect(() => { if (isEditingTitle && titleInputRef.current) titleInputRef.current.focus(); }, [isEditingTitle]);
            
            useEffect(() => { 
                if (workspaceTimerRef.current) clearTimeout(workspaceTimerRef.current);
                workspaceTimerRef.current = setTimeout(() => { 
                    onUpdateBook({ ...currentBook, projects, activeProjectId, expandedProjects, scale, pan }); 
                }, 300); 
                return () => { if(workspaceTimerRef.current) clearTimeout(workspaceTimerRef.current); }; 
            }, [projects, activeProjectId, expandedProjects, scale, pan]);

            const scrollTargetRef = useRef(0);
            const scrollAnimRef = useRef(null);

            const updateFocusScroll = useCallback(() => {
                if (!isZenMode || !textareaRef.current) return;
                
                const textarea = textareaRef.current;
                const coords = getCaretCoordinates(textarea, textarea.selectionStart);
                const rect = textarea.getBoundingClientRect();
                const contentOffsetTop = coords.top - rect.top - textarea.scrollTop;
                const targetScroll = contentOffsetTop - (textarea.clientHeight * 0.6);
                
                scrollTargetRef.current = targetScroll;
            }, [isZenMode]);

            useEffect(() => {
                if (!isZenMode) {
                    if (scrollAnimRef.current) cancelAnimationFrame(scrollAnimRef.current);
                    return;
                }

                updateFocusScroll();

                const loop = () => {
                    if (textareaRef.current) {
                        const current = textareaRef.current.scrollTop;
                        const target = scrollTargetRef.current;
                        const diff = target - current;

                        if (Math.abs(diff) > 1) {
                            textareaRef.current.scrollTop = current + diff * 0.1;
                        }
                    }
                    scrollAnimRef.current = requestAnimationFrame(loop);
                };
                
                loop();
                return () => cancelAnimationFrame(scrollAnimRef.current);
            }, [isZenMode, updateFocusScroll]);

            useEffect(() => {
                const handleZenShortcut = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'j') {
                        e.preventDefault();
                        const current = projects.find(p => p.id === activeProjectId);
                        if (current && current.type === 'doc') {
                            setIsZenMode(prev => !prev);
                            showToast(!isZenMode ? "ÏßëÏ§ë Î™®Îìú ÌôúÏÑ±Ìôî" : "ÏßëÏ§ë Î™®Îìú Ìï¥Ï†ú");
                        }
                    }
                };
                window.addEventListener('keydown', handleZenShortcut);
                return () => window.removeEventListener('keydown', handleZenShortcut);
            }, [activeProjectId, projects, isZenMode, showToast]);

            const [editingProjectId, setEditingProjectId] = useState(null);
            const [mention, setMention] = useState({ active: false, type: '', search: '', x: 0, y: 0, pos: 0, selectedIndex: 0 });
            const [hoverInfo, setHoverInfo] = useState({ visible: false, node: null, x: 0, y: 0 });
            const textareaRef = useRef(null);
            const containerRef = useRef(null);

            const setSidebarCols = (projectId, cols) => {
                setProjects(prev => prev.map(p => 
                    p.id === projectId ? { ...p, sidebarColumns: cols } : p
                ));
            };

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (!mention.active) return;
                    const mentionList = document.querySelector('.mention-list');
                    const isTextAreaClick = e.target === textareaRef.current;
                    if (mentionList && !mentionList.contains(e.target) && !isTextAreaClick) {
                        setMention(prev => ({ ...prev, active: false }));
                    }
                };
                if (mention.active) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [mention.active]);

            useEffect(() => {
                const handleDropdownClickOutside = (e) => {
                    if (!showNodeDropdown) return;
                    if (!e.target.closest('.relative')) {
                        setShowNodeDropdown(false);
                    }
                };
                if (showNodeDropdown) {
                    document.addEventListener('mousedown', handleDropdownClickOutside);
                }
                return () => document.removeEventListener('mousedown', handleDropdownClickOutside);
            }, [showNodeDropdown]);

            const activeProject = useMemo(() => projects.find(p => p.id === activeProjectId) || projects[0], [projects, activeProjectId]);
            
            const nodes = activeProject?.nodes || [];
            const edges = activeProject?.edges || [];
            const allBoardNodes = useMemo(() => projects.filter(p => p.type === 'board').flatMap(p => (p.nodes || []).map(node => ({ ...node, projectName: p.name }))), [projects]);
            const filteredMentionNodes = useMemo(() => { if (!mention.active) return []; return allBoardNodes.filter(n => n.type === (mention.type === '@' ? 'Ïù∏Î¨º' : mention.type === '#' ? 'ÏÇ¨Í±¥' : 'Î©îÎ™®') && (n.label.includes(mention.search) || mention.search === "")); }, [allBoardNodes, mention]);

            const handleSelectProject = (id) => {
                setActiveProjectId(id);
                const target = projects.find(p => p.id === id);
                if (target && target.type !== 'doc') setIsZenMode(false);
            };
            const toggleProjectFolder = (id, e) => { if (e) e.stopPropagation(); setExpandedProjects(prev => ({ ...prev, [id]: !prev[id] })); };
            
            const updateActiveProject = useCallback((nodeUpdater, edgeUpdater) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    return {
                        ...p,
                        nodes: nodeUpdater ? (typeof nodeUpdater === 'function' ? nodeUpdater(p.nodes || []) : nodeUpdater) : (p.nodes || []),
                        edges: edgeUpdater ? (typeof edgeUpdater === 'function' ? edgeUpdater(p.edges || []) : edgeUpdater) : (p.edges || [])
                    };
                }));
            }, [activeProjectId]);

            const updateDocContent = (content) => { setProjects(prev => prev.map(p => p.id === activeProjectId ? { ...p, content } : p)); };

            const [history, setHistory] = useState({ past: [], future: [] });
            const [isPanning, setIsPanning] = useState(false);
            const [draggingNodeId, setDraggingNodeId] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0, nodeIds: new Set() }); // ÎìúÎûòÍ∑∏ Ï§ë Ïò§ÌîÑÏÖã
            const [tempEdge, setTempEdge] = useState(null);
            const [selectedNodeId, setSelectedNodeId] = useState(null); // For modal
            const [selectedNodeIds, setSelectedNodeIds] = useState(new Set()); // For multi-select
            const [selectedEdgeId, setSelectedEdgeId] = useState(null);
            const [topNodeId, setTopNodeId] = useState(null);
            const [marquee, setMarquee] = useState(null); // For selection rectangle

            const lastMousePos = useRef({ x: 0, y: 0 });
            const hasConnectedRef = useRef(false);
            const [sidebarDrag, setSidebarDrag] = useState({ active: false, nodeId: null, type: null, startIdx: null, currentIdx: null, x: 0, y: 0 });
            const sidebarDragRef = useRef(null);
            const isMarqueeSelectingRef = useRef(false);
            const selectedNodeIdsRef = useRef(selectedNodeIds);

            const saveHistory = useCallback(() => { setHistory(prev => ({ past: [...prev.past.slice(-19), { projects }], future: [] })); }, [projects]);
            const undo = useCallback(() => { setHistory(prev => { if (prev.past.length === 0) return prev; const previous = prev.past[prev.past.length - 1]; const newPast = prev.past.slice(0, prev.past.length - 1); setProjects(previous.projects); showToast("Ïã§Ìñâ Ï∑®ÏÜåÎê®"); return { past: newPast, future: [{ projects }, ...prev.future] }; }); }, [projects, showToast]);
            
            useEffect(() => { selectedNodeIdsRef.current = selectedNodeIds; }, [selectedNodeIds]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNodeIds.size > 0) {
                        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                        e.preventDefault();
                        if (confirm(`${selectedNodeIds.size}Í∞úÏùò ÎÖ∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                            saveHistory();
                            updateActiveProject(
                                prevNodes => prevNodes.filter(n => !selectedNodeIds.has(n.id)),
                                prevEdges => prevEdges.filter(edge => !selectedNodeIds.has(edge.from) && !selectedNodeIds.has(edge.to))
                            );
                            setSelectedNodeIds(new Set());
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedNodeIds, saveHistory, updateActiveProject]);

            useEffect(() => {
                const handleUndoKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        e.preventDefault(); undo();
                    }
                };
                window.addEventListener('keydown', handleUndoKeyDown);
                return () => window.removeEventListener('keydown', handleUndoKeyDown);
            }, [undo]);
            
            useEffect(() => { 
                const div = containerRef.current;
                const handleWheel = (e) => { 
                    if (!div || e.target.closest('aside') || (activeProject && activeProject.type === 'doc')) return; 
                    e.preventDefault(); // Î∏åÎùºÏö∞Ï†Ä Í∏∞Î≥∏ Ï§å Î∞©ÏßÄ
                    
                    const rect = div.getBoundingClientRect(); 
                    const mouseX = e.clientX - rect.left; 
                    const mouseY = e.clientY - rect.top; 
                    
                    // Ï§å ÏÜçÎèÑ Ï°∞Ï†à (Ìä∏ÎûôÌå®Îìú Îì± Í∞êÏïà)
                    const delta = -e.deltaY * 0.001; 
                    
                    // Ï§å Î≤îÏúÑ Ï†úÌïú (0.1 ~ 3.0 -> 0.2 ~ 5.0 Ï†ïÎèÑÍ∞Ä Ï†ÅÎãπ)
                    const newScale = Math.min(Math.max(0.2, scale + delta), 5); 
                    
                    const scaleRatio = newScale / scale; 
                    setPan(prev => ({ 
                        x: mouseX - (mouseX - prev.x) * scaleRatio, 
                        y: mouseY - (mouseY - prev.y) * scaleRatio 
                    })); 
                    setScale(newScale); 
                };
                if(div) { 
                    div.addEventListener('wheel', handleWheel, { passive: false }); 
                    return () => div.removeEventListener('wheel', handleWheel); 
                } 
            }, [scale, activeProject]);

            const getCanvasCoords = (clientX, clientY) => { 
                if (!containerRef.current) return {x:0, y:0};
                const rect = containerRef.current.getBoundingClientRect(); 
                return { x: (clientX - rect.left - pan.x) / scale, y: (clientY - rect.top - pan.y) / scale }; 
            };
            // ÎìúÎûòÍ∑∏ Ï§ë Ïò§ÌîÑÏÖãÏù¥ Ï†ÅÏö©Îêú ÎÖ∏Îìú ÏúÑÏπò Î∞òÌôò
            const findNode = (id) => {
                const node = nodes.find(n => n.id === id);
                if (!node) return null;
                if (draggingNodeId && dragOffset.nodeIds.has(id)) {
                    return { ...node, x: node.x + dragOffset.x, y: node.y + dragOffset.y };
                }
                return node;
            };
            
            const createNewProject = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'board', name: 'ÏÉà Î≥¥Îìú', nodes: [], edges: [], sidebarColumns: 1 }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); setPan({ x: 0, y: 0 }); setScale(1); setIsZenMode(false); };
            const createNewDoc = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'doc', name: 'ÏÉà Î¨∏ÏÑú', content: " ", status: 'Ï¥àÍ≥†', targetCount: 5000 }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); };
            const deleteProject = (id, e) => { if (e) e.stopPropagation(); if (confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { saveHistory(); let newProjects = projects.filter(p => p.id !== id); if (newProjects.length === 0) { const dummyId = generateUUID(); newProjects = [{ id: dummyId, type: 'board', name: 'ÏÉà ÌîÑÎ°úÏ†ùÌä∏', nodes: [], edges: [] }]; handleSelectProject(dummyId); } else if (activeProjectId === id) handleSelectProject(newProjects[0].id); setProjects(newProjects); } };
            const handleProjectRename = (id, newName) => { saveHistory(); setProjects(prev => prev.map(p => p.id === id ? { ...p, name: newName } : p)); setEditingProjectId(null); };

            const getDefaultNodeData = (type) => {
                switch(type) {
                    case 'Ïù∏Î¨º': return { emoji: 'üë§', age: '', gender: 'ÎØ∏ÏßÄÏ†ï', job: '', race: 'Ïù∏Í∞Ñ', role: 'Ï°∞Ïó∞', memo: '' };
                    case 'ÏÇ¨Í±¥': return { emoji: 'üî•', place: '', year: '', memo: '' };
                    case 'Î©îÎ™®': return { emoji: 'üí°', memo: '' };
                    case 'Ïû•ÏÜå': return { emoji: 'üìç', region: '', climate: '', description: '', memo: '' };
                    case 'ÏïÑÏù¥ÌÖú': return { emoji: 'üéÅ', category: 'ÏùºÎ∞ò', rarity: 'Î≥¥ÌÜµ', owner: '', effect: '', memo: '' };
                    case 'ÏÑ∏Î†•': return { emoji: '‚öîÔ∏è', leader: '', members: '', territory: '', goal: '', memo: '' };
                    case 'Î≥µÏÑ†': return { emoji: 'üé£', chapter: '', status: 'ÎØ∏ÌöåÏàò', hint: '', reveal: '', memo: '' };
                    case 'ÌÉÄÏûÑÎùºÏù∏': return { emoji: '‚è∞', date: '', era: '', importance: 'Î≥¥ÌÜµ', memo: '' };
                    case 'ÏÑ§Ï†ï': return { emoji: 'üìö', category: 'ÏÑ∏Í≥ÑÍ¥Ä', scope: '', memo: '' };
                    case 'ÎåÄÏÇ¨': return { emoji: 'üí¨', speaker: '', situation: '', emotion: '', memo: '' };
                    case 'Í∞àÎì±': return { emoji: '‚ö°', parties: '', cause: '', status: 'ÏßÑÌñâÏ§ë', resolution: '', memo: '' };
                    case 'Í∑∏Î£π': return { emoji: 'üìÅ', color: '#94a3b8', width: 400, height: 300, childNodes: [], memo: '' };
                    default: return { emoji: 'üìù', memo: '' };
                }
            };
            const addNode = (type) => {
                saveHistory();
                const id = generateUUID();
                const rect = containerRef.current.getBoundingClientRect();
                const center = getCanvasCoords(rect.left + rect.width / 2, rect.top + rect.height / 2);

                const defaultData = getDefaultNodeData(type);

                updateActiveProject(prev => [...prev, { id, x: center.x - CARD_W / 2, y: center.y - CARD_H / 2, label: `ÏÉà ${type}`, type, data: defaultData }]);
                setTopNodeId(id);
            };
            const deleteNode = (id) => { 
                saveHistory(); 
                
                updateActiveProject(
                    // 1. ÎÖ∏Îìú Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                    prevNodes => {
                        // ÏÇ≠Ï†ú ÎåÄÏÉÅ ÎÖ∏Îìú Ï†úÍ±∞
                        const filtered = prevNodes.filter(n => n.id !== id);
                        
                        // [Ï∂îÍ∞ÄÎêú Î°úÏßÅ] ÎÇ®ÏùÄ ÎÖ∏ÎìúÎì§ Ï§ë 'Í∑∏Î£π' ÎÖ∏Îìú ÎÇ¥Î∂ÄÏóê ÏÇ≠Ï†úÎêú IDÍ∞Ä ÏûàÎã§Î©¥ Ï†úÍ±∞
                        return filtered.map(node => {
                            if (node.type === 'Í∑∏Î£π' && node.data.childNodes && node.data.childNodes.includes(id)) {
                                return {
                                    ...node,
                                    data: {
                                        ...node.data,
                                        childNodes: node.data.childNodes.filter(childId => childId !== id)
                                    }
                                };
                            }
                            return node;
                        });
                    }, 
                    // 2. Ïó£ÏßÄ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ (Í∏∞Ï°¥Í≥º ÎèôÏùº)
                    prevEdges => prevEdges.filter(e => e.from !== id && e.to !== id)
                ); 
                
                if (selectedNodeId === id) setSelectedNodeId(null); 
                setSelectedNodeIds(prev => { const next = new Set(prev); next.delete(id); return next; }); 
            };

            const resizeGroupNode = (id, width, height) => {
                updateActiveProject(prev => prev.map(n =>
                    n.id === id ? { ...n, data: { ...n.data, width, height } } : n
                ));
            };

            const ALL_NODE_TYPES = ['Ïù∏Î¨º', 'ÏÇ¨Í±¥', 'Î©îÎ™®', 'Ïû•ÏÜå', 'ÏïÑÏù¥ÌÖú', 'ÏÑ∏Î†•', 'Î≥µÏÑ†', 'ÌÉÄÏûÑÎùºÏù∏', 'ÏÑ§Ï†ï', 'ÎåÄÏÇ¨', 'Í∞àÎì±', 'Í∑∏Î£π'];
            const handleReorderNodes = (type, newOrder) => {
                saveHistory();
                updateActiveProject(allNodes => {
                    const newOrderIds = newOrder.map(n => n.id);
                    const reorderedNodes = newOrderIds.map(id => allNodes.find(n => n.id === id)).filter(Boolean);

                    // Í∞Å ÌÉÄÏûÖÎ≥ÑÎ°ú ÎÖ∏Îìú Î∂ÑÎ¶¨
                    const nodesByType = {};
                    ALL_NODE_TYPES.forEach(t => {
                        nodesByType[t] = type === t ? reorderedNodes : allNodes.filter(n => n.type === t);
                    });

                    // Î™®Îì† ÌÉÄÏûÖÏùò ÎÖ∏ÎìúÎ•º ÏàúÏÑúÎåÄÎ°ú Ìï©Ïπ®
                    return ALL_NODE_TYPES.flatMap(t => nodesByType[t]);
                });
            };

            const handleReorderBoards = (newOrder) => {
                saveHistory();
                setProjects(prevProjects => {
                    const docs = prevProjects.filter(p => p.type === 'doc');
                    const newOrderIds = newOrder.map(p => p.id);
                    const reorderedBoards = newOrderIds.map(id => prevProjects.find(p => p.id === id)).filter(Boolean);
                    return [...reorderedBoards, ...docs];
                });
            };

            const handleReorderDocs = (newOrder) => {
                setProjects(prevProjects => {
                    const boards = prevProjects.filter(p => p.type === 'board');
                    const newOrderIds = newOrder.map(p => p.id);
                    const reorderedDocs = newOrderIds.map(id => prevProjects.find(p => p.id === id)).filter(Boolean);
                    return [...boards, ...reorderedDocs];
                });
            };

            // ÏÇ¨Ïù¥ÎìúÎ∞î Í∑∏Î¶¨Îìú ÎìúÎûòÍ∑∏ Ìï∏Îì§Îü¨
            const handleSidebarDragStart = (e, node, type, idx) => {
                e.preventDefault();
                const rect = e.currentTarget.getBoundingClientRect();
                setSidebarDrag({
                    active: true,
                    nodeId: node.id,
                    type,
                    startIdx: idx,
                    currentIdx: idx,
                    x: e.clientX,
                    y: e.clientY,
                    offsetX: e.clientX - rect.left,
                    offsetY: e.clientY - rect.top,
                    width: rect.width,
                    height: rect.height
                });
                sidebarDragRef.current = node;
            };

            const handleSidebarDragMove = useCallback((e) => {
                if (!sidebarDrag.active) return;
                setSidebarDrag(prev => ({ ...prev, x: e.clientX, y: e.clientY }));

                // ÌòÑÏû¨ ÎßàÏö∞Ïä§ ÏúÑÏπòÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎìúÎ°≠ ÌÉÄÍ≤ü Ï∞æÍ∏∞
                const elements = document.querySelectorAll(`[data-sidebar-type="${sidebarDrag.type}"]`);
                let closestIdx = sidebarDrag.startIdx;
                let closestDist = Infinity;

                elements.forEach((el, idx) => {
                    const rect = el.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const dist = Math.hypot(e.clientX - centerX, e.clientY - centerY);
                    if (dist < closestDist) {
                        closestDist = dist;
                        closestIdx = idx;
                    }
                });

                if (closestIdx !== sidebarDrag.currentIdx) {
                    setSidebarDrag(prev => ({ ...prev, currentIdx: closestIdx }));
                }
            }, [sidebarDrag.active, sidebarDrag.type, sidebarDrag.startIdx, sidebarDrag.currentIdx]);

            const handleSidebarDragEnd = useCallback(() => {
                if (!sidebarDrag.active) return;

                const { type, startIdx, currentIdx } = sidebarDrag;
                if (startIdx !== currentIdx) {
                    saveHistory();
                    updateActiveProject(allNodes => {
                        const filtered = allNodes.filter(n => n.type === type);
                        const others = allNodes.filter(n => n.type !== type);

                        // ÏàúÏÑú Î≥ÄÍ≤Ω
                        const newFiltered = [...filtered];
                        const [moved] = newFiltered.splice(startIdx, 1);
                        newFiltered.splice(currentIdx, 0, moved);

                        const persons = type === 'Ïù∏Î¨º' ? newFiltered : others.filter(n => n.type === 'Ïù∏Î¨º');
                        const events = type === 'ÏÇ¨Í±¥' ? newFiltered : others.filter(n => n.type === 'ÏÇ¨Í±¥');
                        const memos = type === 'Î©îÎ™®' ? newFiltered : others.filter(n => n.type === 'Î©îÎ™®');

                        return [...persons, ...events, ...memos];
                    });
                }

                setSidebarDrag({ active: false, nodeId: null, type: null, startIdx: null, currentIdx: null, x: 0, y: 0 });
                sidebarDragRef.current = null;
            }, [sidebarDrag, saveHistory, updateActiveProject]);

            useEffect(() => {
                if (sidebarDrag.active) {
                    window.addEventListener('mousemove', handleSidebarDragMove);
                    window.addEventListener('mouseup', handleSidebarDragEnd);
                    return () => {
                        window.removeEventListener('mousemove', handleSidebarDragMove);
                        window.removeEventListener('mouseup', handleSidebarDragEnd);
                    };
                }
            }, [sidebarDrag.active, handleSidebarDragMove, handleSidebarDragEnd]);

            // 1. Workspace Ïª¥Ìè¨ÎÑåÌä∏ ÏÉÅÎã®(ref ÏÑ†Ïñ∏Î∂Ä)Ïóê rAFÏö© ref Ï∂îÍ∞Ä
            const rAF = useRef(null);
            const latestMousePos = useRef({ x: 0, y: 0 });
            
            const isPanningRef = useRef(isPanning);
            const draggingNodeIdRef = useRef(draggingNodeId);
            const scaleRef = useRef(scale);
            const tempEdgeRef = useRef(tempEdge);
            const nodesRef = useRef(nodes);
            const dragOffsetRef = useRef({ x: 0, y: 0, nodeIds: new Set() });

            useEffect(() => { isPanningRef.current = isPanning; }, [isPanning]);
            useEffect(() => { draggingNodeIdRef.current = draggingNodeId; }, [draggingNodeId]);
            useEffect(() => { scaleRef.current = scale; window.currentScale = scale; }, [scale]);
            useEffect(() => { tempEdgeRef.current = tempEdge; }, [tempEdge]);
            useEffect(() => { nodesRef.current = nodes; }, [nodes]);

            // 2. handleGlobalMouseMove Ìï®Ïàò ÍµêÏ≤¥
            const handleGlobalMouseMove = (e) => {
                if (activeProject.type === 'doc') return;

                const currentX = e.clientX;
                const currentY = e.clientY;
                const dx = currentX - lastMousePos.current.x;
                const dy = currentY - lastMousePos.current.y;

                if (isMarqueeSelectingRef.current && marquee) {
                    const currentCoords = getCanvasCoords(currentX, currentY);
                    setMarquee(prev => {
                        const x = Math.min(prev.startX, currentCoords.x);
                        const y = Math.min(prev.startY, currentCoords.y);
                        const width = Math.abs(currentCoords.x - prev.startX);
                        const height = Math.abs(currentCoords.y - prev.startY);
                        return { ...prev, x, y, width, height };
                    });
                } else if (isPanningRef.current) {
                    setPan(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                } else if (draggingNodeIdRef.current) {
                    const scaleFactor = 1 / scaleRef.current;
                    const dragId = draggingNodeIdRef.current;
                    const deltaX = dx * scaleFactor;
                    const deltaY = dy * scaleFactor;
                    const selectedIds = selectedNodeIdsRef.current;

                    // Ïù¥ÎèôÌï† ÎÖ∏Îìú ID ÏßëÌï©ÏùÑ ÎØ∏Î¶¨ Í≥ÑÏÇ∞ (Ï≤´ ÌîÑÎ†àÏûÑÏóêÏÑúÎßå)
                    let nodesToMove = dragOffsetRef.current.nodeIds;
                    if (nodesToMove.size === 0) {
                        nodesToMove = new Set();
                        const currentNodes = nodes;

                        // Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú Í∑∏Î£πÏùò Î™®Îì† ÏûêÏãù ÎÖ∏Îìú ÏàòÏßë
                        const collectAllChildren = (nodeId, nodesList) => {
                            nodesToMove.add(nodeId);
                            const node = nodesList.find(n => n.id === nodeId);
                            if (node?.type === 'Í∑∏Î£π' && node.data.childNodes) {
                                node.data.childNodes.forEach(childId => {
                                    if (!nodesToMove.has(childId)) {
                                        collectAllChildren(childId, nodesList);
                                    }
                                });
                            }
                        };

                        const draggedNode = currentNodes.find(n => n.id === dragId);
                        const isGroupDrag = draggedNode?.type === 'Í∑∏Î£π';

                        if (selectedIds.has(dragId) && selectedIds.size > 1) {
                            selectedIds.forEach(id => nodesToMove.add(id));
                        } else if (isGroupDrag) {
                            collectAllChildren(dragId, currentNodes);
                        } else {
                            nodesToMove.add(dragId);
                        }
                        dragOffsetRef.current.nodeIds = nodesToMove;
                    }

                    // Ïò§ÌîÑÏÖã ÎàÑÏ†Å
                    const newOffsetX = dragOffsetRef.current.x + deltaX;
                    const newOffsetY = dragOffsetRef.current.y + deltaY;
                    dragOffsetRef.current = { x: newOffsetX, y: newOffsetY, nodeIds: nodesToMove };
                    setDragOffset({ x: newOffsetX, y: newOffsetY, nodeIds: nodesToMove });
                }

                if (tempEdgeRef.current) {
                    const c = getCanvasCoords(currentX, currentY);
                    setTempEdge(prev => ({ ...prev, toX: c.x, toY: c.y }));
                }

                lastMousePos.current = { x: currentX, y: currentY };
            };

            const handleGlobalMouseUp = (e) => {
                if (activeProject.type === 'board') {
                    if (isMarqueeSelectingRef.current && marquee) {
                        const marqueeRect = { x: marquee.x, y: marquee.y, x2: marquee.x + marquee.width, y2: marquee.y + marquee.height };
                        const nodesInMarquee = nodes.filter(node => {
                            const nodeRect = { x: node.x, y: node.y, x2: node.x + CARD_W, y2: node.y + CARD_H };
                            return nodeRect.x < marqueeRect.x2 && nodeRect.x2 > marqueeRect.x && nodeRect.y < marqueeRect.y2 && nodeRect.y2 > marqueeRect.y;
                        });

                        if (e.shiftKey) {
                            setSelectedNodeIds(prev => {
                                const newSet = new Set(prev);
                                nodesInMarquee.forEach(node => newSet.add(node.id));
                                selectedNodeIdsRef.current = newSet;
                                return newSet;
                            });
                        } else {
                            const newSet = new Set(nodesInMarquee.map(n => n.id));
                            setSelectedNodeIds(newSet);
                            selectedNodeIdsRef.current = newSet;
                        }
                    }

                    isMarqueeSelectingRef.current = false;
                    setMarquee(null);

                    // ÎÖ∏Îìú ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å Ïãú ÏúÑÏπò Ï†ÄÏû• Î∞è Í∑∏Î£π ÏòÅÏó≠ Ï≤¥ÌÅ¨
                    if (draggingNodeId) {
                        const offset = dragOffsetRef.current;
                        const movedNodeIds = offset.nodeIds;

                        // Ïò§ÌîÑÏÖãÏù¥ ÏûàÏúºÎ©¥ Ïã§Ï†ú ÏúÑÏπò Ï†ÄÏû•
                        if (offset.x !== 0 || offset.y !== 0) {
                            saveHistory();
                            updateActiveProject(prevNodes => prevNodes.map(n =>
                                movedNodeIds.has(n.id) ? { ...n, x: n.x + offset.x, y: n.y + offset.y } : n
                            ));
                        }

                        // Ïò§ÌîÑÏÖã Ï¥àÍ∏∞Ìôî
                        dragOffsetRef.current = { x: 0, y: 0, nodeIds: new Set() };
                        setDragOffset({ x: 0, y: 0, nodeIds: new Set() });

                        // ÎìúÎûòÍ∑∏Îêú ÎÖ∏ÎìúÏùò ÏµúÏ¢Ö ÏúÑÏπòÎ°ú Í∑∏Î£π Ï≤¥ÌÅ¨ (Í∑∏Î£π ÎÖ∏ÎìúÎäî Îã§Î•∏ Í∑∏Î£πÏóê Ìè¨Ìï® ÏïàÎê®)
                        const draggedNode = nodes.find(n => n.id === draggingNodeId);
                        if (draggedNode && draggedNode.type !== 'Í∑∏Î£π') {
                            // ÎìúÎûòÍ∑∏Ìïú ÎÖ∏ÎìúÏùò Ï§ëÏã¨ Ï¢åÌëú (Ïò§ÌîÑÏÖã Ï†ÅÏö©)
                            const nodeW = CARD_W;
                            const nodeH = CARD_H;
                            const nodeCenterX = draggedNode.x + offset.x + nodeW / 2;
                            const nodeCenterY = draggedNode.y + offset.y + nodeH / 2;

                            // ÌòÑÏû¨ ÏÜçÌïú Í∑∏Î£π Ï∞æÍ∏∞
                            const currentParentGroup = nodes.find(n => n.type === 'Í∑∏Î£π' && n.id !== draggingNodeId && n.data.childNodes?.includes(draggingNodeId));

                            // Í∑∏Î£π ÎÖ∏ÎìúÎì§ Ï§ë Ïù¥ ÎÖ∏ÎìúÍ∞Ä ÏÜçÌï† Ïàò ÏûàÎäî Í∑∏Î£π Ï∞æÍ∏∞
                            const groupNodes = nodes.filter(n => n.type === 'Í∑∏Î£π');
                            let targetGroup = null;

                            for (const group of groupNodes) {
                                const gx = group.x + (movedNodeIds.has(group.id) ? offset.x : 0);
                                const gy = group.y + (movedNodeIds.has(group.id) ? offset.y : 0);
                                const gw = group.data.width || 400;
                                const gh = group.data.height || 300;

                                // ÎÖ∏Îìú Ï§ëÏã¨Ïù¥ Í∑∏Î£π ÏòÅÏó≠ ÏïàÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                                if (nodeCenterX >= gx && nodeCenterX <= gx + gw &&
                                    nodeCenterY >= gy && nodeCenterY <= gy + gh) {
                                    targetGroup = group;
                                    break;
                                }
                            }

                            // Í∑∏Î£π Î©§Î≤ÑÏã≠ ÏóÖÎç∞Ïù¥Ìä∏
                            updateActiveProject(prevNodes => prevNodes.map(n => {
                                // Í∏∞Ï°¥ Í∑∏Î£πÏóêÏÑú Ï†úÍ±∞ (Í∑∏Î£π Î∞ñÏúºÎ°ú ÎÇòÍ∞îÍ±∞ÎÇò Îã§Î•∏ Í∑∏Î£πÏúºÎ°ú Ïù¥Îèô)
                                if (currentParentGroup && n.id === currentParentGroup.id) {
                                    if (!targetGroup || targetGroup.id !== currentParentGroup.id) {
                                        // Í∑∏Î£π Î∞ñÏúºÎ°ú ÎÇòÍ∞ê ÎòêÎäî Îã§Î•∏ Í∑∏Î£πÏúºÎ°ú Ïù¥Îèô
                                        return { ...n, data: { ...n.data, childNodes: (n.data.childNodes || []).filter(id => id !== draggingNodeId) } };
                                    }
                                }
                                // ÏÉà Í∑∏Î£πÏóê Ï∂îÍ∞Ä (Í∏∞Ï°¥ Í∑∏Î£πÏù¥ ÏóÜÍ±∞ÎÇò Îã§Î•∏ Í∑∏Î£πÏù∏ Í≤ΩÏö∞)
                                if (targetGroup && n.id === targetGroup.id) {
                                    if (!currentParentGroup || currentParentGroup.id !== targetGroup.id) {
                                        if (!n.data.childNodes?.includes(draggingNodeId)) {
                                            return { ...n, data: { ...n.data, childNodes: [...(n.data.childNodes || []), draggingNodeId] } };
                                        }
                                    }
                                }
                                return n;
                            }));
                        }
                    }
                    if (tempEdge && !hasConnectedRef.current) {
                        const c = getCanvasCoords(e.clientX, e.clientY);
                        // ÎßàÏö∞Ïä§ ÏúÑÏπòÏóê ÏûàÎäî ÎÖ∏Îìú Ï∞æÍ∏∞ (Ï∂úÎ∞ú ÎÖ∏Îìú Ï†úÏô∏)
                        const targetNode = nodes.find(n =>
                            n.id !== tempEdge.fromId &&
                            c.x >= n.x && c.x <= n.x + CARD_W &&
                            c.y >= n.y && c.y <= n.y + CARD_H
                        );

                        if (targetNode) {
                            const edgeExists = edges.some(e =>
                                (e.from === tempEdge.fromId && e.to === targetNode.id) ||
                                (e.from === targetNode.id && e.to === tempEdge.fromId)
                            );
                            if (edgeExists) {
                            } else {
                                saveHistory();
                                const fromNode = findNode(tempEdge.fromId);
                                const edgeLabel = '';
                                updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: targetNode.id, label: edgeLabel }]);
                            }
                        } else {
                            const fromNode = findNode(tempEdge.fromId);
                            if (fromNode) {
                                saveHistory();
                                const newNodeId = generateUUID();
                                const defaultData = getDefaultNodeData(fromNode.type);
                                const edgeLabel = '';
                                updateActiveProject(prev => [...prev, { id: newNodeId, x: c.x - CARD_W/2, y: c.y - CARD_H/2, label: `ÏÉà ${fromNode.type}`, type: fromNode.type, data: defaultData }], prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: newNodeId, label: edgeLabel }]);
                            }
                        }
                    }
                    hasConnectedRef.current = false;
                    setIsPanning(false);
                    setDraggingNodeId(null);
                    setTempEdge(null);
                }
            };

            const handleDocInput = (e) => {
                const inputType = e.nativeEvent.inputType;
                let val = e.target.value;
                const pos = e.target.selectionStart;
                const lastChar = val[pos - 1];

                if (inputType === 'insertFromPaste') {
                    if (mention.active) {
                        const currentSearch = val.slice(mention.pos, pos);
                        if (/[\s\n]/.test(currentSearch)) {
                            setMention({ ...mention, active: false });
                        } else {
                            setMention({ ...mention, search: currentSearch, selectedIndex: 0 });
                        }
                    }
                    updateDocContent(val);
                    return;
                }

                if (lastChar === '#' || lastChar === '@' || lastChar === '$') {
                    const coords = getCaretCoordinates(e.target, pos);
                    const rect = e.target.getBoundingClientRect();
                    const visualY = coords.top - (e.target.scrollTop * 2);

                    let finalX, finalY;

                    if (isZenMode) {
                        finalX = Math.max(rect.left + 20, rect.left + coords.left - 610);
                        finalY = visualY + 20; 
                    } else {
                        finalX = coords.left;
                        finalY = visualY + 25;
                    }

                    const menuWidth = 600;
                    const menuHeight = 400;

                    if (finalX + menuWidth > window.innerWidth) finalX = window.innerWidth - menuWidth - 20;
                    if (!isZenMode && (finalY + menuHeight > window.innerHeight)) {
                        finalY = visualY - menuHeight - 10; 
                    }

                    setMention({ active: true, type: lastChar, search: '', x: finalX, y: finalY, pos, selectedIndex: 0 });

                } else if (mention.active) {
                    const currentSearch = val.slice(mention.pos, pos);
                    if (!lastChar || /[\s\n]/.test(lastChar) || pos < mention.pos) {
                        setMention({ ...mention, active: false });
                    } else {
                        setMention({ ...mention, search: currentSearch, selectedIndex: 0 });
                    }
                }
                
                updateDocContent(val);
            };

            const insertMention = (node) => { 
                const text = activeProject.content || ""; 
                const before = text.slice(0, mention.pos - 1); 
                const after = text.slice(mention.pos + mention.search.length); 
                const insertedText = node.label + "";
                const newText = before + insertedText + after; 
                updateDocContent(newText); 
                setMention({ ...mention, active: false }); 
                const newCursorPos = before.length + insertedText.length;
                requestAnimationFrame(() => {
                    if (textareaRef.current) {
                        textareaRef.current.focus();
                        textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);
                        if (typeof updateFocusScroll === 'function') {
                            updateFocusScroll();
                        }
                    }
                });
            };

            const handleDocKeyDown = (e) => {
                if (e.nativeEvent.isComposing) return;
                
                if (mention.active) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex + 1) % filteredMentionNodes.length }));
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex - 1 + filteredMentionNodes.length) % filteredMentionNodes.length }));
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (filteredMentionNodes[mention.selectedIndex]) insertMention(filteredMentionNodes[mention.selectedIndex]);
                    } else if (e.key === 'Escape') {
                        setMention({ ...mention, active: false });
                    }
                }
            };
            const handleDocMouseMove = (e) => { if (mention.active) return; const text = activeProject.content || ""; const pos = e.target.selectionStart; const word = getWordAtPos(text, pos); if (word.length > 0) { const found = allBoardNodes.find(n => n.label === word && (n.type === 'Ïù∏Î¨º' || n.type === 'ÏÇ¨Í±¥' || n.type === 'Î©îÎ™®')); if (found) { setHoverInfo({ visible: true, node: found, x: e.clientX, y: e.clientY }); return; } } setHoverInfo({ ...hoverInfo, visible: false }); };

            const handleAutoLayout = useCallback(() => {
                if (!activeProject || activeProject.type !== 'board') return;
                saveHistory();

                const GAP_BETWEEN_GROUPS = 400;

                const groups = {
                    'Ïù∏Î¨º': activeProject.nodes.filter(n => n.type === 'Ïù∏Î¨º'),
                    'ÏÇ¨Í±¥': activeProject.nodes.filter(n => n.type === 'ÏÇ¨Í±¥'),
                    'Î©îÎ™®': activeProject.nodes.filter(n => n.type === 'Î©îÎ™®'),
                    'Ïû•ÏÜå': activeProject.nodes.filter(n => n.type === 'Ïû•ÏÜå'),
                    'ÏïÑÏù¥ÌÖú': activeProject.nodes.filter(n => n.type === 'ÏïÑÏù¥ÌÖú'),
                    'ÏÑ∏Î†•': activeProject.nodes.filter(n => n.type === 'ÏÑ∏Î†•'),
                    'Î≥µÏÑ†': activeProject.nodes.filter(n => n.type === 'Î≥µÏÑ†'),
                    'ÌÉÄÏûÑÎùºÏù∏': activeProject.nodes.filter(n => n.type === 'ÌÉÄÏûÑÎùºÏù∏'),
                    'ÏÑ§Ï†ï': activeProject.nodes.filter(n => n.type === 'ÏÑ§Ï†ï'),
                    'ÎåÄÏÇ¨': activeProject.nodes.filter(n => n.type === 'ÎåÄÏÇ¨'),
                    'Í∞àÎì±': activeProject.nodes.filter(n => n.type === 'Í∞àÎì±'),
                    'Í∑∏Î£π': activeProject.nodes.filter(n => n.type === 'Í∑∏Î£π')
                };

                const getInternalEdges = (groupNodes) => {
                    const ids = new Set(groupNodes.map(n => n.id));
                    return activeProject.edges.filter(e => ids.has(e.from) && ids.has(e.to));
                };

                const layoutGroup = (groupNodes, groupEdges) => {
                    if (groupNodes.length === 0) return { nodes: [], width: 0, height: 0 };
                    const g = new dagre.graphlib.Graph();
                    g.setGraph({ rankdir: 'TB', ranksep: 100, nodesep: 60 });
                    g.setDefaultEdgeLabel(() => ({}));
                    groupNodes.forEach(node => g.setNode(node.id, { width: CARD_W, height: CARD_H }));
                    groupEdges.forEach(edge => g.setEdge(edge.from, edge.to));
                    dagre.layout(g);

                    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                    const positioned = groupNodes.map(node => {
                        const pos = g.node(node.id);
                        const x = pos.x - CARD_W / 2;
                        const y = pos.y - CARD_H / 2;
                        if (x < minX) minX = x;
                        if (x + CARD_W > maxX) maxX = x + CARD_W;
                        if (y < minY) minY = y;
                        if (y + CARD_H > maxY) maxY = y + CARD_H;
                        return { ...node, x, y };
                    });
                    return {
                        nodes: positioned.map(n => ({ ...n, x: n.x - minX, y: n.y - minY })),
                        width: maxX - minX,
                        height: maxY - minY
                    };
                };

                // Í∞Å ÌÉÄÏûÖÎ≥Ñ Î†àÏù¥ÏïÑÏõÉ
                const results = {};
                Object.keys(groups).forEach(type => {
                    results[type] = layoutGroup(groups[type], getInternalEdges(groups[type]));
                });

                // Row 1: Ïù∏Î¨º, ÏÇ¨Í±¥, Î©îÎ™®
                const ROW_GAP = 100;
                let row1X = 0;
                let row1Height = 0;

                const finalNodes = [];

                ['Ïù∏Î¨º', 'ÏÇ¨Í±¥', 'Î©îÎ™®'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row1X, y: n.y }));
                        row1X += results[type].width + GAP_BETWEEN_GROUPS;
                        row1Height = Math.max(row1Height, results[type].height);
                    }
                });

                // Row 2: Ïû•ÏÜå, ÏÑ∏Î†•, ÏÑ§Ï†ï
                let row2X = 0;
                let row2Y = row1Height + ROW_GAP;
                let row2Height = 0;

                ['Ïû•ÏÜå', 'ÏÑ∏Î†•', 'ÏÑ§Ï†ï'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row2X, y: n.y + row2Y }));
                        row2X += results[type].width + GAP_BETWEEN_GROUPS;
                        row2Height = Math.max(row2Height, results[type].height);
                    }
                });

                // Row 3: Î≥µÏÑ†, ÌÉÄÏûÑÎùºÏù∏, ÎåÄÏÇ¨, Í∞àÎì±
                let row3X = 0;
                let row3Y = row2Y + row2Height + ROW_GAP;
                let row3Height = 0;

                ['Î≥µÏÑ†', 'ÌÉÄÏûÑÎùºÏù∏', 'ÎåÄÏÇ¨', 'Í∞àÎì±'].forEach(type => {
                    if (results[type].nodes.length > 0) {
                        results[type].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row3X, y: n.y + row3Y }));
                        row3X += results[type].width + GAP_BETWEEN_GROUPS;
                        row3Height = Math.max(row3Height, results[type].height);
                    }
                });

                // Row 4: ÏïÑÏù¥ÌÖú
                let row4X = 0;
                let row4Y = row3Y + row3Height + ROW_GAP;

                if (results['ÏïÑÏù¥ÌÖú'].nodes.length > 0) {
                    results['ÏïÑÏù¥ÌÖú'].nodes.forEach(n => finalNodes.push({ ...n, x: n.x + row4X, y: n.y + row4Y }));
                }

                // Í∑∏Î£π ÎÖ∏ÎìúÎäî ÎåÄÍ∞ÅÏÑ†ÏúºÎ°ú Í≤πÏ≥êÏÑú Î∞∞Ïπò
                const DIAGONAL_OFFSET = 50;
                let groupX = (results['ÏïÑÏù¥ÌÖú'].width || 0) + GAP_BETWEEN_GROUPS;
                let groupY = row4Y;
                results['Í∑∏Î£π'].nodes.forEach((n, idx) => {
                    finalNodes.push({ ...n, x: groupX + idx * DIAGONAL_OFFSET, y: groupY + idx * DIAGONAL_OFFSET });
                });

                const positionMap = new Map();
                finalNodes.forEach(n => positionMap.set(n.id, { x: n.x, y: n.y }));

                // ÏûêÎèô Ï†ïÎ†¨ Ïãú Î™®Îì† Í∑∏Î£π ÎÖ∏ÎìúÏùò childNodes Ï¥àÍ∏∞Ìôî
                updateActiveProject(prevNodes =>
                    prevNodes.map(n => {
                        const newPos = positionMap.get(n.id);
                        if (n.type === 'Í∑∏Î£π') {
                            // Í∑∏Î£π ÎÖ∏ÎìúÎäî childNodes Ï¥àÍ∏∞Ìôî
                            return newPos
                                ? { ...n, x: newPos.x, y: newPos.y, data: { ...n.data, childNodes: [] } }
                                : { ...n, data: { ...n.data, childNodes: [] } };
                        }
                        return newPos ? { ...n, x: newPos.x, y: newPos.y } : n;
                    })
                );

                setTimeout(() => fitToScreen(finalNodes), 100);

            }, [activeProject, saveHistory, updateActiveProject, fitToScreen]);


            const activeNode = useMemo(() => nodes.find(n => n.id === selectedNodeId), [nodes, selectedNodeId]);
            const activeEdge = useMemo(() => edges.find(e => e.id === selectedEdgeId), [edges, selectedEdgeId]);

            // ÎìúÎûòÍ∑∏ Ï§ëÏù∏ ÎÖ∏ÎìúÏóê Ïò§ÌîÑÏÖã Ï†ÅÏö©
            const getDisplayNodes = () => {
                if (!draggingNodeId || (dragOffset.x === 0 && dragOffset.y === 0)) return nodes;
                return nodes.map(n =>
                    dragOffset.nodeIds.has(n.id)
                        ? { ...n, x: n.x + dragOffset.x, y: n.y + dragOffset.y }
                        : n
                );
            };
            const displayNodes = getDisplayNodes();

            const visibleNodes = (() => {
                if (activeProject?.type !== 'board') return [];
                if (isPanning || draggingNodeId) {
                    return displayNodes;
                }

                const viewportW = window.innerWidth;
                const viewportH = window.innerHeight;
                const buffer = 300;

                return displayNodes.filter(node => {
                    const screenX = node.x * scale + pan.x;
                    const screenY = node.y * scale + pan.y;
                    const nodeW = node.type === 'Í∑∏Î£π' ? (node.data.width || 400) : CARD_W;
                    const nodeH = node.type === 'Í∑∏Î£π' ? (node.data.height || 300) : CARD_H;
                    return (
                        screenX > -nodeW * scale - buffer &&
                        screenX < viewportW + buffer &&
                        screenY > -nodeH * scale - buffer &&
                        screenY < viewportH + buffer
                    );
                });
            })();

            const visibleGroupNodes = visibleNodes.filter(n => n.type === 'Í∑∏Î£π');
            const visibleRegularNodes = visibleNodes.filter(n => n.type !== 'Í∑∏Î£π');
            // Ïó£ÏßÄÎäî nodesÏóêÏÑú ÏßÅÏ†ë Ï∞∏Ï°∞ÌïòÏó¨ ÎèôÍ∏∞Ìôî Î¨∏Ï†ú Ìï¥Í≤∞
            const visibleEdges = (() => { if (activeProject?.type !== 'board') return []; const nodeIds = new Set(nodes.map(n => n.id)); return edges.filter(edge => nodeIds.has(edge.from) && nodeIds.has(edge.to)); })();

            const renderProjectItem = (project) => {
                const isActive = activeProjectId === project.id; const isDoc = project.type === 'doc'; const isExpanded = expandedProjects[project.id];
                const cols = project.sidebarColumns || 1;
                const containerClasses = isDoc 
                        ? `transition-all duration-200 border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 ${isActive ? 'bg-white dark:bg-zinc-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}` 
                        : `rounded-[3px] mb-1 transition-all duration-300 ${isActive 
                            ? 'bg-white shadow-md border-2 border-indigo-200 dark:bg-zinc-700 dark:border-indigo-500' 
                            : 'bg-slate-50 border border-slate-200 dark:bg-zinc-800 dark:border-zinc-700' 
                        }`;
                    
                const projectContent = (
                    <div className={containerClasses}>
                        <div onClick={() => handleSelectProject(project.id)} onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }} className={`flex items-center px-4 cursor-pointer group relative overflow-hidden ${isDoc ? 'h-[30px] py-0' : 'py-2.5'}`}>
                            {isActive && <div className={`absolute left-0 top-0 bottom-0 ${isDoc ? 'w-[3px]' : 'w-1'} bg-indigo-600 dark:bg-indigo-500`} />}
                            <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                <span onClick={(e) => !isDoc && toggleProjectFolder(project.id, e)} className={`${isDoc ? 'text-sm opacity-50' : 'text-base'} shrink-0 dark:text-zinc-300`}>{isDoc ? 'üìÑ' : (isExpanded ? 'üìÇ' : 'üìÅ')}</span>
                                {editingProjectId === project.id ? ( <input autoFocus className="w-full bg-white border border-indigo-400 rounded-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white" defaultValue={project.name} onBlur={(e) => handleProjectRename(project.id, e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)} /> ) : (
                                    <div className="flex items-center min-w-0 flex-1 justify-between">
                                            <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                            {isExpanded && !isDoc && (
                                                <div className="flex items-center gap-0.5 bg-slate-200 dark:bg-zinc-900 p-0.5 rounded-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                    {[1, 2, 3, 4].map(col => (
                                                        <button
                                                            key={col}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setSidebarCols(project.id, col);
                                                            }}
                                                            className={`w-5 h-5 flex items-center justify-center text-[10px] font-black rounded-sm transition-colors ${
                                                                cols === col
                                                                    ? 'bg-white dark:bg-zinc-700 text-indigo-600 dark:text-white shadow-sm'
                                                                    : 'text-slate-400 hover:bg-white/50 dark:text-zinc-500 dark:hover:bg-zinc-700/50'
                                                            }`}
                                                            title={`${col}Ïó¥ Î≥¥Í∏∞`}
                                                        >
                                                            {col}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="flex items-center shrink-0">
                                                {isDoc && <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] ${getStatusBadgeStyle(project.status || 'Ï¥àÍ≥†')}`}>{project.status || 'Ï¥àÍ≥†'}</span>}
                                                <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                            </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        {!isDoc && (
                            <AnimatePresence>
                                {(isExpanded && project.type === 'board') && (
                                    <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} className="overflow-hidden bg-slate-50/30 rounded-b-[3px] border-slate-100 dark:bg-zinc-800/30 dark:border-zinc-700">
                                            <div className="pb-3 px-3 space-y-3 pt-2">
                                                {(() => {
                                                    const cols = project.sidebarColumns || 1;
                                                    return ALL_NODE_TYPES.map(type => {
                                                        const filtered = (project.nodes || []).filter(n => n.type === type); if (filtered.length === 0) return null;
                                                        return (
                                                            <div key={type} className="pl-1">
                                                                <div className="text-[9px] font-black text-slate-400 mb-1.5 px-2 uppercase tracking-tighter flex items-center gap-2"><span className="w-1 h-1 bg-slate-300 rounded-[3px] dark:bg-zinc-600"></span>{type}</div>
                                                                {cols === 1 ? (
                                                                    <Reorder.Group axis="y" values={filtered} onReorder={(newOrder) => handleReorderNodes(type, newOrder)} className="space-y-1">
                                                                    {filtered.map(n => (
                                                                        <Reorder.Item
                                                                            key={n.id}
                                                                            value={n}
                                                                            initial={{ opacity: 0 }}
                                                                            animate={{ opacity: 1 }}
                                                                            exit={{ opacity: 0 }}
                                                                            layout
                                                                            layoutId={n.id}
                                                                            dragElastic={1}
                                                                            whileDrag={{ scale: 1.05, boxShadow: '0 10px 25px rgba(0,0,0,0.25)', zIndex: 100 }}
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleSelectProject(project.id);
                                                                                setSelectedNodeIds(new Set([n.id]));
                                                                                animateViewport({
                                                                                    x: -(n.x + CARD_W/2)*scale + (window.innerWidth - 320)/2,
                                                                                    y: -(n.y + CARD_H/2)*scale + window.innerHeight/2
                                                                                }, scale);
                                                                            }}
                                                                            onDoubleClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setSelectedNodeIds(new Set());
                                                                                setSelectedNodeId(n.id);
                                                                            }}
                                                                            className={`group/node py-1.5 px-3 bg-white hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-zinc-600 rounded-[3px] flex items-center justify-between gap-2 cursor-grab active:cursor-grabbing shadow-sm transition-colors border-l-4 dark:bg-zinc-700 dark:border-zinc-600 ${getSidebarItemAccent(n)} ${(selectedNodeIds.has(n.id) || selectedNodeId === n.id) ? `border-2 ${getSelectedBorderColor(n)}` : 'border-2 border-slate-200 dark:border-zinc-600'}`}
                                                                        >
                                                                            <div className="flex items-center gap-2 min-w-0 flex-1">
                                                                                <span className="text-xs shrink-0">{n.data.emoji}</span>
                                                                                <span className="text-[11px] font-bold text-slate-600 truncate dark:text-zinc-300">{n.label}</span>
                                                                            </div>
                                                                            <div className="flex items-center shrink-0">
                                                                                {n.type === 'Ïù∏Î¨º' && (
                                                                                    <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                                        {n.data.role}
                                                                                    </span>
                                                                                )}
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        if(confirm(`'${n.label}'ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) deleteNode(n.id);
                                                                                    }}
                                                                                    className="w-0 opacity-0 group-hover/node:w-5 group-hover/node:opacity-100 group-hover/node:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"
                                                                                >
                                                                                    <IconTrash className="w-3 h-3" />
                                                                                </button>
                                                                            </div>
                                                                        </Reorder.Item>
                                                                    ))}
                                                                    </Reorder.Group>
                                                                ) : (
                                                                    <div className={`grid gap-1 ${cols === 4 ? 'grid-cols-4' : cols === 3 ? 'grid-cols-3' : cols === 2 ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                                                    {filtered.map(n => (
                                                                        <div
                                                                            key={n.id}
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleSelectProject(project.id);
                                                                                setSelectedNodeIds(new Set([n.id]));
                                                                                animateViewport({
                                                                                    x: -(n.x + CARD_W/2)*scale + (window.innerWidth - 320)/2,
                                                                                    y: -(n.y + CARD_H/2)*scale + window.innerHeight/2
                                                                                }, scale);
                                                                            }}
                                                                            onDoubleClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setSelectedNodeIds(new Set());
                                                                                setSelectedNodeId(n.id);
                                                                            }}
                                                                            className={`group/node py-1.5 px-2 bg-white hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-zinc-700/80 rounded-[3px] flex items-center gap-1.5 cursor-pointer shadow-sm transition-colors border-l-4 dark:bg-zinc-800/90 dark:border-zinc-700 ${getSidebarItemAccent(n)} ${(selectedNodeIds.has(n.id) || selectedNodeId === n.id) ? `border-2 ${getSelectedBorderColor(n)}` : 'border-2 border-slate-200 dark:border-zinc-700'}`}
                                                                        >
                                                                            {cols !== 4 && <span className="text-xs shrink-0">{n.data.emoji}</span>}
                                                                            <span className={`font-bold text-slate-600 truncate dark:text-zinc-300 flex-1 min-w-0 ${cols === 4 ? 'text-[9px]' : 'text-[10px]'}`}>{n.label}</span>
                                                                            {cols === 2 && n.type === 'Ïù∏Î¨º' && n.data.role && (
                                                                                <span className={`text-[7px] font-black px-1 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>
                                                                                    {n.data.role}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                    </div>
                                                                )}
                                                        </div>
                                                    );
                                                });
                                                })()}
                                            </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        )}
                    </div>
                );

                if (isDoc) {
                    return projectContent;
                }

                return (
                    <Reorder.Item
                        key={project.id}
                        value={project}
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        layout
                        layoutId={`board-${project.id}`}
                        dragElastic={1}
                        whileDrag={{ scale: 1.05, boxShadow: '0 10px 25px rgba(0,0,0,0.25)', zIndex: 100 }}
                        transition={{ type: 'spring', stiffness: 400, damping: 30 }}
                        className="cursor-grab active:cursor-grabbing"
                    >
                        {projectContent}
                    </Reorder.Item>
                );
            };

            if (!activeProject) return null;

            return (
                <div className={`flex w-screen h-screen no-drag transition-colors duration-500 ${(activeProject.type === 'board') ? 'grid-background' : 'dot-background'} ${(isPanning || draggingNodeId) ? 'is-dragging' : ''}`} onMouseMove={handleGlobalMouseMove} onMouseUp={handleGlobalMouseUp} onContextMenu={e => e.preventDefault()}>
                    <aside className={`h-full bg-[#f5f5f5] border-r border-slate-200 z-[100] flex flex-col shadow-2xl overflow-hidden dark:bg-[#141417] dark:border-zinc-700/50 transition-all duration-500 ease-in-out ${
                        isZenMode ? 'w-0 -translate-x-full opacity-0' : 'w-80 opacity-100'
                    }`} style={{ borderRadius: 0 }}>
                        
                        <div className="w-full bg-slate-800 hover:bg-slate-700 rounded-none">
                            <div 
                                onClick={onExit} 
                                className="w-full py-2 px-5 flex items-center gap-3 group transition-all duration-300 cursor-pointer"
                            >
                                <div className="w-4 h-4 bg-white/10 flex items-center justify-center group-hover:text-slate-200 transition-all">
                                    <IconBack className="w-4 h-4 text-slate-400 group-hover:text-slate-200" />
                                </div>
                                <div className="flex flex-col items-start dark:hover:bg-zinc-800/80">
                                    <span className="text-[12px] text-slate-400 tracking-tight group-hover:text-slate-200">ÎÇ¥ ÏÑúÏû¨Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span>
                                </div>
                            </div>
                        </div>

                        <div className="px-6 pt-6 pb-5 bg-white dark:bg-[#161618] border-b border-slate-200/60 dark:border-zinc-800/60">
                            <div className="text-left">
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="text-[9px] font-black px-2 py-0.5 bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-500 rounded-[2px] tracking-widest uppercase border border-slate-200/50 dark:border-zinc-700/30">Novel project</span>
                                </div>
                                
                                {isEditingTitle ? ( 
                                    <input 
                                        ref={titleInputRef} 
                                        className="w-full text-2xl font-black text-slate-900 tracking-tighter leading-tight bg-slate-50 p-2 Galmuri14 border-b-2 border-slate-800 outline-none dark:bg-zinc-800 dark:text-white" 
                                        value={currentBook.title} 
                                        onChange={(e) => onUpdateBook({...currentBook, title: e.target.value})} 
                                        onBlur={() => setIsEditingTitle(false)} 
                                        onKeyDown={(e) => e.key === 'Enter' && setIsEditingTitle(false)} 
                                    /> 
                                ) : ( 
                                    <h1 
                                        onDoubleClick={() => setIsEditingTitle(true)} 
                                        className="text-2xl font-black text-slate-800 dark:text-zinc-100 tracking-tighter leading-tight cursor-pointer hover:text-slate-500 dark:hover:text-zinc-400 transition-colors"
                                        title="ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ Ï†úÎ™© ÏàòÏ†ï"
                                    >
                                        {currentBook.title}
                                    </h1> 
                                )}
                                
                                <div className="flex items-center gap-2 mt-2 opacity-60"> 
                                    <span className="text-[11px] font-bold text-slate-500 dark:text-zinc-400 tracking-wide">
                                        {currentBook.author || 'ÏûëÍ∞Ä ÎØ∏ÏÉÅ'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className="p-3 bg-white/50 border-b border-slate-200 flex gap-2 dark:bg-darkpanel/50 dark:border-darkborder">
                            <button onClick={createNewProject} className="flex-1 py-2.5 bg-indigo-600 text-white text-[10px] font-black rounded-[3px] hover:bg-indigo-700 transition-all shadow-md tracking-widest dark:bg-indigo-700 dark:hover:bg-indigo-600">+ ÏÉà Î≥¥Îìú</button>
                            <button onClick={createNewDoc} className="flex-1 py-2.5 bg-slate-800 text-white text-[10px] font-black rounded-[3px] hover:bg-slate-900 transition-all shadow-md tracking-widest dark:bg-zinc-700 dark:hover:bg-zinc-600">+ ÏÉà Î¨∏ÏÑú</button>
                        </div>
                        <div className="flex-1 overflow-y-auto px-3 pt-4 custom-scroll pb-10">
                            <div className="mb-5">
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2 flex items-center gap-2"><span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> ÏïÑÏù¥ÎîîÏñ¥ Î≥¥Îìú</div>
                                <Reorder.Group axis="y" values={projects.filter(p => p.type === 'board')} onReorder={handleReorderBoards} className="space-y-1">
                                    {projects.filter(p => p.type === 'board').map(project => renderProjectItem(project))}
                                </Reorder.Group>
                            </div>
                            <div className="px-2 mb-4"><hr className="border-t border-slate-200 dark:border-zinc-700" /></div>
                            <div>
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2 flex items-center gap-2"><span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> Î¨∏ÏÑúÌï®</div>
                                <Reorder.Group axis="y" values={projects.filter(p => p.type === 'doc')} onReorder={handleReorderDocs} className="space-y-0 border-t border-slate-200/50 dark:border-zinc-700/50">
                                    {projects.filter(p => p.type === 'doc').map(project => {
                                        const isActive = activeProjectId === project.id;
                                        return (
                                            <Reorder.Item
                                                key={project.id}
                                                value={project}
                                                initial={{ opacity: 0 }}
                                                animate={{ opacity: 1 }}
                                                exit={{ opacity: 0 }}
                                                layout
                                                layoutId={`doc-${project.id}`}
                                                dragElastic={1}
                                                whileDrag={{ scale: 1.05, boxShadow: '0 10px 25px rgba(0,0,0,0.25)', zIndex: 100 }}
                                                transition={{ type: 'spring', stiffness: 400, damping: 30 }}
                                                onClick={() => handleSelectProject(project.id)}
                                                onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }}
                                                className={`border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 cursor-grab active:cursor-grabbing ${isActive ? 'bg-white dark:bg-zinc-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}`}
                                            >
                                                <div className="flex items-center px-4 h-[30px] py-0 group relative overflow-hidden">
                                                    {isActive && <div className="absolute left-0 top-0 bottom-0 w-[3px] bg-indigo-600 dark:bg-indigo-500" />}
                                                    <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                                        <span className="text-sm opacity-50 shrink-0 dark:text-zinc-300">üìÑ</span>
                                                        {editingProjectId === project.id ? (
                                                            <input
                                                                autoFocus
                                                                className="w-full bg-white border border-indigo-400 rounded-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white"
                                                                defaultValue={project.name}
                                                                onBlur={(e) => handleProjectRename(project.id, e.target.value)}
                                                                onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                        ) : (
                                                            <div className="flex items-center min-w-0 flex-1 justify-between">
                                                                <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                                                <div className="flex items-center shrink-0">
                                                                    <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] ${getStatusBadgeStyle(project.status || 'Ï¥àÍ≥†')}`}>{project.status || 'Ï¥àÍ≥†'}</span>
                                                                    <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </Reorder.Item>
                                        );
                                    })}
                                </Reorder.Group>
                            </div>
                        </div>
                    </aside>

                    <main
                        className={`flex-1 relative overflow-hidden transition-all duration-500 ease-in-out ${activeProject.type === 'board' ? (isPanning || isMarqueeSelectingRef.current ? 'cursor-grabbing' : draggingNodeId ? 'cursor-grabbing' : 'cursor-grab') : ''}`}
                        ref={containerRef}
                        onMouseDown={(e) => {
                            if(activeProject.type === 'board') { 
                                if (rAF.current) { cancelAnimationFrame(rAF.current); rAF.current = null; }
                                lastMousePos.current = { x: e.clientX, y: e.clientY }; 
                                latestMousePos.current = { x: e.clientX, y: e.clientY }; 

                                if (e.shiftKey && e.button === 0) {
                                    isMarqueeSelectingRef.current = true;
                                    const startCoords = getCanvasCoords(e.clientX, e.clientY);
                                    setMarquee({ x: startCoords.x, y: startCoords.y, width: 0, height: 0, startX: startCoords.x, startY: startCoords.y });
                                } else if (e.button === 0) {
                                    setIsPanning(true);
                                    if (!e.shiftKey) {
                                        setSelectedNodeIds(new Set());
                                        setSelectedNodeId(null);
                                    }
                                }
                            } 
                        }}
                    >
                        {activeProject.type === 'board' ? (
                            <>
                                <div className="absolute top-6 left-6 z-[80] flex items-center gap-3" onMouseDown={(e) => e.stopPropagation()}>
                                    <div className="h-10 px-5 bg-white shadow-lg border border-slate-200 rounded-[3px] flex items-center gap-2 dark:bg-darkpanel dark:border-darkborder dark:text-white">
                                        <span className="w-2 h-2 bg-indigo-500 rounded-[3px] animate-pulse"></span>
                                        <span className="text-xs font-black text-slate-800 uppercase tracking-widest dark:text-zinc-200">{activeProject.name}</span>
                                    </div>
                                    <div className="flex items-center gap-1 p-1 bg-white rounded-[3px] shadow-lg border border-slate-200 h-10 dark:bg-darkpanel dark:border-darkborder">
                                            <button onClick={() => addNode('Ïù∏Î¨º')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-blue-50 text-blue-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-blue-400" title="Ïù∏Î¨º Ï∂îÍ∞Ä">
                                                <span className="text-sm">üë§</span>
                                                <span className="text-[10px] font-black hidden sm:inline">Ïù∏Î¨º</span>
                                            </button>
                                            <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                            <button onClick={() => addNode('ÏÇ¨Í±¥')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-red-50 text-red-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-red-400" title="ÏÇ¨Í±¥ Ï∂îÍ∞Ä">
                                                <span className="text-sm">üî•</span>
                                                <span className="text-[10px] font-black hidden sm:inline">ÏÇ¨Í±¥</span>
                                            </button>
                                            <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                            <button onClick={() => addNode('Î©îÎ™®')} className="flex items-center gap-2 h-full px-3 rounded-[3px] hover:bg-amber-50 text-amber-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-amber-400" title="Î©îÎ™® Ï∂îÍ∞Ä">
                                                <span className="text-sm">üí°</span>
                                                <span className="text-[10px] font-black hidden sm:inline">Î©îÎ™®</span>
                                            </button>
                                            <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                            <div className="relative" ref={nodeDropdownRef}>
                                                <button onClick={() => setShowNodeDropdown(!showNodeDropdown)} className="flex items-center gap-1 h-full px-3 rounded-[3px] hover:bg-slate-100 text-slate-600 transition-all active:scale-95 dark:hover:bg-zinc-700 dark:text-slate-400" title="Îçî ÎßéÏùÄ ÎÖ∏Îìú Ï∂îÍ∞Ä">
                                                    <span className="text-sm">‚ûï</span>
                                                    <span className="text-[10px] font-black hidden sm:inline">ÎçîÎ≥¥Í∏∞</span>
                                                    <svg className={`w-3 h-3 transition-transform ${showNodeDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                </button>
                                                {showNodeDropdown && (
                                                    <div className="absolute top-full left-0 mt-1 bg-white rounded-[3px] shadow-xl border border-slate-200 py-1 min-w-[140px] z-[200] dark:bg-darkpanel dark:border-darkborder">
                                                        <button onClick={() => { addNode('Ïû•ÏÜå'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-emerald-50 text-emerald-600 transition-all dark:hover:bg-zinc-700 dark:text-emerald-400">
                                                            <span className="text-sm">üìç</span>
                                                            <span className="text-[11px] font-bold">Ïû•ÏÜå</span>
                                                        </button>
                                                        <button onClick={() => { addNode('ÏïÑÏù¥ÌÖú'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-purple-50 text-purple-600 transition-all dark:hover:bg-zinc-700 dark:text-purple-400">
                                                            <span className="text-sm">üéÅ</span>
                                                            <span className="text-[11px] font-bold">ÏïÑÏù¥ÌÖú</span>
                                                        </button>
                                                        <button onClick={() => { addNode('ÏÑ∏Î†•'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-orange-50 text-orange-600 transition-all dark:hover:bg-zinc-700 dark:text-orange-400">
                                                            <span className="text-sm">‚öîÔ∏è</span>
                                                            <span className="text-[11px] font-bold">ÏÑ∏Î†•</span>
                                                        </button>
                                                        <button onClick={() => { addNode('Î≥µÏÑ†'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-pink-50 text-pink-600 transition-all dark:hover:bg-zinc-700 dark:text-pink-400">
                                                            <span className="text-sm">üé£</span>
                                                            <span className="text-[11px] font-bold">Î≥µÏÑ†</span>
                                                        </button>
                                                        <button onClick={() => { addNode('ÌÉÄÏûÑÎùºÏù∏'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-teal-50 text-teal-600 transition-all dark:hover:bg-zinc-700 dark:text-teal-400">
                                                            <span className="text-sm">‚è∞</span>
                                                            <span className="text-[11px] font-bold">ÌÉÄÏûÑÎùºÏù∏</span>
                                                        </button>
                                                        <button onClick={() => { addNode('ÏÑ§Ï†ï'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-indigo-50 text-indigo-600 transition-all dark:hover:bg-zinc-700 dark:text-indigo-400">
                                                            <span className="text-sm">üìö</span>
                                                            <span className="text-[11px] font-bold">ÏÑ§Ï†ï</span>
                                                        </button>
                                                        <button onClick={() => { addNode('ÎåÄÏÇ¨'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-sky-50 text-sky-600 transition-all dark:hover:bg-zinc-700 dark:text-sky-400">
                                                            <span className="text-sm">üí¨</span>
                                                            <span className="text-[11px] font-bold">ÎåÄÏÇ¨</span>
                                                        </button>
                                                        <button onClick={() => { addNode('Í∞àÎì±'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-rose-50 text-rose-600 transition-all dark:hover:bg-zinc-700 dark:text-rose-400">
                                                            <span className="text-sm">‚ö°</span>
                                                            <span className="text-[11px] font-bold">Í∞àÎì±</span>
                                                        </button>
                                                        <button onClick={() => { addNode('Í∑∏Î£π'); setShowNodeDropdown(false); }} className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-100 text-slate-600 transition-all dark:hover:bg-zinc-700 dark:text-slate-400">
                                                            <span className="text-sm">üìÅ</span>
                                                            <span className="text-[11px] font-bold">Í∑∏Î£π</span>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                </div>

                                <div
                                    onMouseDown={(e) => e.stopPropagation()}
                                    className="absolute bottom-8 right-8 z-[100] flex flex-col bg-white shadow-2xl border border-slate-200 rounded-[3px] overflow-hidden text-slate-600 font-bold dark:bg-darkpanel dark:border-darkborder dark:text-zinc-300">
                                    <button 
                                        onClick={() => handleAutoLayout()} 
                                        className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700 border-b border-slate-100 dark:border-zinc-700"
                                        title="ÏûêÎèô Ï†ïÎ†¨ (Auto Layout)"
                                    >
                                        <IconLayout className="w-5 h-5 text-slate-500 dark:text-zinc-400" />
                                    </button>
                                    <button 
                                        onClick={() => fitToScreen()} 
                                        className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700 border-b border-slate-100 dark:border-zinc-700"
                                        title="ÌôîÎ©¥ Ï§ëÏïô ÎßûÏ∂§"
                                    >
                                        {/* ÏïÑÏù¥ÏΩò SVG ÏÉùÎûµ */}
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="scale-75">
                                            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                                        </svg>
                                    </button>
                                    <button onClick={() => setScale(prev => Math.min(prev + 0.1, 3))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700">+</button>
                                    <div className="py-2 text-[9px] font-black text-slate-400 border-y border-slate-50 text-center bg-slate-50/50 dark:bg-zinc-800/50 dark:border-zinc-700">{Math.round(scale * 100)}%</div>
                                    <button onClick={() => setScale(prev => Math.max(prev - 0.1, 0.1))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700">-</button>
                                </div>

                                <div className="zoom-container w-full h-full" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}>
                                    <svg className="canvas-svg">
                                        <defs><marker id="arrow-event" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444" /></marker></defs>
                                        {visibleEdges.map(edge => {
                                            const from = findNode(edge.from); const to = findNode(edge.to); if (!from || !to) return null;
                                            let x1 = from.x + CARD_W/2, y1 = from.y + CARD_H/2, x2 = to.x + CARD_W/2, y2 = to.y + CARD_H/2;
                                            const coreTypes = ['Ïù∏Î¨º', 'ÏÇ¨Í±¥', 'Î©îÎ™®'];
                                            const isCoreType = (type) => coreTypes.includes(type);
                                            const isEventToEvent = from.type === 'ÏÇ¨Í±¥' && to.type === 'ÏÇ¨Í±¥';
                                            const isIdeaInvolved = from.type === 'Î©îÎ™®' || to.type === 'Î©îÎ™®';
                                            const isPersonToEvent = (from.type === 'Ïù∏Î¨º' && to.type === 'ÏÇ¨Í±¥') || (from.type === 'ÏÇ¨Í±¥' && to.type === 'Ïù∏Î¨º');
                                            const isPersonToPerson = from.type === 'Ïù∏Î¨º' && to.type === 'Ïù∏Î¨º';
                                            const isSameType = from.type === to.type;

                                            // ÎÖ∏Îìú ÌÉÄÏûÖÎ≥Ñ Í≥†Ïú† ÏÉâÏÉÅ (hex)
                                            const typeColors = {
                                                'Ïû•ÏÜå': '#10b981', 'ÏïÑÏù¥ÌÖú': '#a855f7', 'ÏÑ∏Î†•': '#f97316',
                                                'Î≥µÏÑ†': '#ec4899', 'ÌÉÄÏûÑÎùºÏù∏': '#14b8a6', 'ÏÑ§Ï†ï': '#6366f1',
                                                'ÎåÄÏÇ¨': '#0ea5e9', 'Í∞àÎì±': '#f43f5e', 'Í∑∏Î£π': '#64748b'
                                            };

                                            // Ïó£ÏßÄ ÏÉâÏÉÅ Í≤∞Ï†ï Î°úÏßÅ
                                            let edgeColor;
                                            if (isCoreType(from.type) && isCoreType(to.type)) {
                                                // Í∏∞Ï°¥ Ïù∏Î¨º/ÏÇ¨Í±¥/Î©îÎ™® Ïó∞Í≤∞ Î°úÏßÅ Ïú†ÏßÄ
                                                edgeColor = isIdeaInvolved ? "#facc15" : isPersonToEvent ? "#3b82f6" : isPersonToPerson ? "#93c5fd" : "#ef4444";
                                            } else if (!isCoreType(from.type) && !isCoreType(to.type)) {
                                                // Îëò Îã§ ÏÉà ÌÉÄÏûÖÏùº Í≤ΩÏö∞
                                                if (isSameType) {
                                                    edgeColor = typeColors[from.type] || "#64748b";
                                                } else {
                                                    edgeColor = "#94a3b8"; // ÌöåÏÉâ
                                                }
                                            } else {
                                                // Í∏∞Ï°¥ ÌÉÄÏûÖÍ≥º ÏÉà ÌÉÄÏûÖ Í∞Ñ Ïó∞Í≤∞
                                                edgeColor = "#94a3b8"; // ÌöåÏÉâ
                                            }

                                            let pathData = isEventToEvent ? `M ${x1} ${y1} L ${getEdgeTargetPos(from, to, 12).x} ${getEdgeTargetPos(from, to, 12).y}` : getBezierPath(x1, y1, x2, y2);
                                            const strokeWidth = edge.width || (isPersonToEvent ? 12 : isEventToEvent ? 4 : isSameType && !isCoreType(from.type) ? 3 : 2);
                                            const strokeDash = edge.style ? getStrokeDashArray(edge.style) : (isIdeaInvolved ? "8, 6" : "");
                                            const labelWidth = Math.max(70, (edge.label || "").length * 10 + 20);
                                            const showLabel = isSameType;
                                            return (
                                                <g key={edge.id}>
                                                    <path d={pathData} className="edge-hitbox" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }} onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); saveHistory(); updateActiveProject(null, prev => prev.filter(ev => ev.id !== edge.id)); }} />
                                                    <path d={pathData} stroke={edgeColor} strokeWidth={strokeWidth} markerEnd={isEventToEvent ? "url(#arrow-event)" : ""} strokeDasharray={strokeDash} className="edge-path opacity-80" />
                                                    {showLabel && edge.label && (
                                                        <g className="cursor-pointer pointer-events-auto" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }}>
                                                            <rect x={(x1+x2)/2 - labelWidth/2} y={(y1+y2)/2-16} width={labelWidth} height="32" rx="4" fill="white" stroke={edgeColor} strokeWidth="1.5" className="dark:fill-zinc-800" /><text x={(x1+x2)/2} y={(y1+y2)/2+5} textAnchor="middle" fontSize="14" fontWeight="900" fill="#334155" className="dark:fill-zinc-200">{edge.label}</text>
                                                        </g>
                                                    )}
                                                </g>
                                            );
                                        })}
                                        {tempEdge && findNode(tempEdge.fromId) && <line x1={findNode(tempEdge.fromId).x + CARD_W/2} y1={findNode(tempEdge.fromId).y + CARD_H/2} x2={tempEdge.toX} y2={tempEdge.toY} stroke="#94a3b8" strokeWidth="2" strokeDasharray="4,4" />}
                                    </svg>
                                    {marquee && (
                                        <div
                                            className="absolute border-2 border-dashed border-blue-500 bg-blue-500/10 dark:bg-blue-400/10 dark:border-blue-400 pointer-events-none"
                                            style={{
                                                left: marquee.x,
                                                top: marquee.y,
                                                width: marquee.width,
                                                height: marquee.height,
                                                zIndex: 999
                                            }}
                                        />
                                    )}

                                    {/* Í∑∏Î£π ÎÖ∏Îìú Î®ºÏ†Ä Î†åÎçîÎßÅ (Îí§Ïóê Î∞∞Ïπò) */}
                                    {visibleGroupNodes.map(node => (
                                        <GroupNode key={node.id} node={node} isSelected={selectedNodeIds.has(node.id) || selectedNodeId === node.id} isDragging={draggingNodeId && (selectedNodeIds.has(node.id) || draggingNodeId === node.id || dragOffset.nodeIds.has(node.id))} onMouseDown={(e, id) => { e.stopPropagation(); if (rAF.current) { cancelAnimationFrame(rAF.current); rAF.current = null; } lastMousePos.current = { x: e.clientX, y: e.clientY }; latestMousePos.current = { x: e.clientX, y: e.clientY }; if (e.button === 0) { if (e.shiftKey) { setSelectedNodeIds(prev => { const newSet = new Set(prev); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); selectedNodeIdsRef.current = newSet; return newSet; }); return; } if (!selectedNodeIds.has(id)) { const newSet = new Set([id]); setSelectedNodeIds(newSet); selectedNodeIdsRef.current = newSet; } setDraggingNodeId(id); } }} onDoubleClick={(id) => { setSelectedNodeIds(new Set()); setSelectedNodeId(id); }} onDelete={deleteNode} onResize={resizeGroupNode} />
                                    ))}
                                    {/* ÏùºÎ∞ò ÎÖ∏Îìú ÎÇòÏ§ëÏóê Î†åÎçîÎßÅ (ÏïûÏóê Î∞∞Ïπò) */}
                                    {visibleRegularNodes.map(node => (
                                        <NodeCard 
                                            key={node.id} 
                                            node={node} 
                                            isTop={topNodeId === node.id} 
                                            isSelected={selectedNodeIds.has(node.id) || selectedNodeId === node.id} 
                                            isDragging={draggingNodeId && (selectedNodeIds.has(node.id) || draggingNodeId === node.id || dragOffset.nodeIds.has(node.id))}
                                            onClick={(e, id) => { if(!e.shiftKey) setSelectedNodeIds(new Set([id])); }} 
                                            onMouseDown={(e, id) => { 
                                                e.stopPropagation(); 
                                                if (rAF.current) { cancelAnimationFrame(rAF.current); rAF.current = null; } 
                                                lastMousePos.current = { x: e.clientX, y: e.clientY }; 
                                                latestMousePos.current = { x: e.clientX, y: e.clientY }; 
                                                if (e.button === 0) { 
                                                    if (e.shiftKey) { 
                                                        setSelectedNodeIds(prev => { const newSet = new Set(prev); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); selectedNodeIdsRef.current = newSet; return newSet; }); 
                                                        return; 
                                                    } 
                                                    if (!selectedNodeIds.has(id)) { const newSet = new Set([id]); setSelectedNodeIds(newSet); selectedNodeIdsRef.current = newSet; } 
                                                    setDraggingNodeId(id); 
                                                    setTopNodeId(id); 
                                                } else if (e.button === 2) { 
                                                    const node = findNode(id); 
                                                    if (node) { setTempEdge({ fromId: id, toX: node.x + CARD_W/2, toY: node.y + CARD_H/2 }); } 
                                                } 
                                            }} 
                                            onMouseUp={(e, id) => { 
                                                if (tempEdge && id !== tempEdge.fromId) { 
                                                    const edgeExists = edges.some(e => (e.from === tempEdge.fromId && e.to === id) || (e.from === id && e.to === tempEdge.fromId)); 
                                                    if (!edgeExists) { 
                                                        saveHistory(); 
                                                        hasConnectedRef.current = true; 
                                                        updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: id, label: 'Í¥ÄÍ≥Ñ' }]); 
                                                    } 
                                                } 
                                            }} 
                                            onDoubleClick={(id) => { setSelectedNodeIds(new Set()); setSelectedNodeId(id); }} 
                                            onDelete={deleteNode} 
                                        />
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div className={`w-full h-full overflow-y-auto custom-scroll transition-all duration-500 ease-in-out ${isZenMode ? 'px-0' : 'px-10'}`}>
                                <div className="fixed top-6 right-10 z-[110] flex gap-2">
                                    <button onClick={() => setIsZenMode(!isZenMode)} className={`flex items-center gap-2 px-4 py-2 rounded-full text-[11px] font-black tracking-widest transition-all shadow-xl border ${isZenMode ? 'bg-indigo-600 text-white border-indigo-500 scale-110 shadow-indigo-500/20' : 'bg-white text-slate-400 border-slate-200 hover:text-indigo-600 dark:bg-zinc-800 dark:border-zinc-700'}`}>
                                        <IconZen className={`w-4 h-4 ${isZenMode ? 'animate-spin' : ''}`} style={{ animationDuration: '3s' }} />
                                        {isZenMode ? 'ÏßëÏ§ëÎ™®Îìú' : 'ÏßëÏ§ëÎ™®Îìú'}
                                    </button>
                                </div>
                                <motion.div layout className="editor-paper relative" style={{ boxShadow: isZenMode ? '0 0 0 15px rgba(0,0,0,0.05), 0 20px 50px rgba(0,0,0,0.1)' : '' }}>
                                    <div className="editor-title-container">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest"> {isZenMode ? 'Focus Mode' : 'DOC TITLE'} </span>
                                            <div className={`flex bg-slate-100 p-1 rounded-[3px] gap-1 dark:bg-zinc-700 transition-opacity ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                                {['Ï¥àÍ≥†', 'ÏàòÏ†ï', 'ÏôÑÎ£å'].map(status => ( <button key={status} onClick={() => setProjects(prev => prev.map(p => p.id === activeProject.id ? {...p, status} : p))} className={`px-3 py-1 text-[10px] font-black rounded-[3px] transition-all ${(activeProject.status || 'Ï¥àÍ≥†') === status ? (status === 'ÏôÑÎ£å' ? 'bg-emerald-600 text-white' : 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-600 dark:text-indigo-300') : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300'}`}>{status}</button> ))}
                                            </div>
                                        </div>
                                        <input className="w-full text-2xl font-black text-slate-800 outline-none border-b-2 border-slate-100 focus:border-indigo-400 pb-2 transition-all dark:text-zinc-200 dark:border-zinc-700 dark:focus:border-indigo-500 dark:bg-transparent" value={activeProject.name} onChange={(e) => handleProjectRename(activeProject.id, e.target.value)} placeholder="Î¨∏ÏÑú Ï†úÎ™©" />
                                    </div>
                                    <textarea 
                                        ref={textareaRef} 
                                        // [Ï§ëÏöî] zen-active ÌÅ¥ÎûòÏä§ Ï°∞Í±¥Î∂Ä Ï†ÅÏö©
                                        className={`editor-textarea custom-scroll ${isZenMode ? 'zen-active' : ''}`} 
                                        value={activeProject.content || ""} 
                                        onChange={(e) => {
                                            handleDocInput(e);
                                            updateFocusScroll(); // [Ï§ëÏöî] ÏûÖÎ†•Ìï† ÎïåÎßàÎã§ Î™©Ìëú Ïä§ÌÅ¨Î°§ Í∞±Ïã†
                                        }} 
                                        onKeyDown={(e) => {
                                            handleDocKeyDown(e);
                                            // ÏóîÌÑ∞ÎÇò Î∞±Ïä§ÌéòÏù¥Ïä§ ÎàÑÎ•º ÎïåÎèÑ Í∞±Ïã†
                                            if (e.key === 'Enter' || e.key === 'Backspace') requestAnimationFrame(updateFocusScroll);
                                        }}
                                        // [Ï§ëÏöî] ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò ÌÇ§Î≥¥ÎìúÎ°ú Ïª§ÏÑú Ïù¥Îèô ÏãúÏóêÎèÑ Ï§ëÏïô Ï†ïÎ†¨
                                        onClick={() => updateFocusScroll()}
                                        onKeyUp={() => updateFocusScroll()}
                                        
                                        onMouseMove={handleDocMouseMove} 
                                        onMouseOut={() => setHoverInfo({ ...hoverInfo, visible: false })} 
                                        placeholder="Ïù¥Í≥≥Ïóê ÏõπÏÜåÏÑ§ ÎÇ¥Ïö©ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî... (@Ïù∏Î¨º ÎòêÎäî #ÏÇ¨Í±¥ ÏûÖÎ†•)" 
                                    />
                                    <div className={`px-[40px] pb-10 transition-all duration-500 ${isZenMode ? 'opacity-10 hover:opacity-100' : ''}`}>
                                        <div className="mt-8 pt-4 border-t border-slate-100 flex flex-col gap-3 dark:border-zinc-700">
                                            <div className="flex justify-between items-end text-[10px] font-black tracking-tighter">
                                                <div className="flex gap-4 items-center">
                                                    <div className="flex flex-col gap-1"><span className="text-slate-400 uppercase">Statistics</span><div className="flex gap-3 text-slate-600 dark:text-zinc-400"><span>Í≥µÎ∞± Ìè¨Ìï®: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").length.toLocaleString()}</b>Ïûê</span><span>Í≥µÎ∞± Ï†úÏô∏: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").replace(/\s+/g, '').length.toLocaleString()}</b>Ïûê</span></div></div>
                                                    <div className="w-px h-6 bg-slate-100 mx-2 dark:bg-zinc-700"></div>
                                                    <div className="flex flex-col gap-1"><span className="text-indigo-400 uppercase">Achievement</span><span className="text-[14px] text-indigo-600 italic dark:text-indigo-400">{Math.min(Math.round(((activeProject.content || "").length / (activeProject.targetCount || 5000)) * 100), 100)}%</span></div>
                                                </div>
                                                <div className="flex flex-col items-end gap-1"><span className="text-slate-400 uppercase">Target Goal</span><div className="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-[3px] border border-slate-100 dark:bg-zinc-700 dark:border-zinc-600"><input type="number" className="w-16 bg-transparent outline-none text-right text-slate-700 font-bold dark:text-zinc-300" value={activeProject.targetCount || 5000} onChange={(e) => { const val = parseInt(e.target.value) || 0; setProjects(prev => prev.map(p => p.id === activeProject.id ? {...p, targetCount: val} : p)); }} /><span className="text-slate-400">Ïûê Î™©Ìëú</span></div></div>
                                            </div>
                                            <div className="w-full h-1.5 bg-slate-100 rounded-[3px] overflow-hidden dark:bg-zinc-700"><motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(((activeProject.content || "").length / (activeProject.targetCount || 5000)) * 100, 100)}%`, backgroundColor: (activeProject.content || "").length >= (activeProject.targetCount || 5000) ? "#10b981" : "#4f46e5" }} className="h-full transition-all duration-500 ease-out rounded-[3px]" /></div>
                                        </div>
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </main>

                    <AnimatePresence>
                        {hoverInfo.visible && (
                            <motion.div initial={{ opacity: 0, y: 5 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} style={{ left: hoverInfo.x, top: hoverInfo.y + 20 }} className="fixed z-[1001] bg-white dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 p-3 rounded-[3px] shadow-2xl pointer-events-none min-w-[200px]">
                                <div className="flex items-center gap-2 mb-1"> <span className="text-lg">{hoverInfo.node.data.emoji}</span> <span className="font-black text-slate-800 dark:text-zinc-100">{hoverInfo.node.label}</span> </div>
                                <div className="text-[10px] text-slate-400 font-bold uppercase mb-2">{hoverInfo.node.projectName} ¬∑ {hoverInfo.node.type}</div>
                                
                                {hoverInfo.node.type === 'ÏÇ¨Í±¥' && (
                                    <div className="mb-2 text-[11px] font-bold text-rose-500">
                                        üìç {hoverInfo.node.data.place || 'ÎØ∏Ï†ï'} ¬∑ üìÖ {hoverInfo.node.data.year || 'ÎØ∏Ï†ï'}
                                    </div>
                                )}

                                <div className="text-[11px] text-slate-600 dark:text-zinc-400 line-clamp-3 leading-relaxed">{hoverInfo.node.data.memo || "ÏûëÏÑ±Îêú Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§."}</div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {mention.active && (
                            <div className="mention-list" style={{ top: mention.y, left: mention.x }}>
                                <div className="w-[250px] flex flex-col border-r border-slate-100 dark:border-zinc-700">
                                    <div className="p-2 bg-slate-50 dark:bg-zinc-800 text-[9px] font-black text-slate-400 tracking-widest uppercase border-b border-slate-100 dark:border-zinc-700">List</div>
                                    <div className="flex-1 overflow-y-auto custom-scroll">
                                        {filteredMentionNodes.length > 0 ? filteredMentionNodes.map((node, i) => (
                                            <div key={node.id} 
                                                onClick={() => insertMention(node)} 
                                                onMouseEnter={() => setMention(prev => ({...prev, selectedIndex: i}))}
                                                className={`flex items-center px-3 h-[38px] cursor-pointer transition-colors border-l-4 ${
                                                    mention.selectedIndex === i 
                                                    ? 'mention-item-active' 
                                                    : 'hover:bg-slate-50 dark:hover:bg-zinc-800 border-l-transparent'
                                                }`}
                                            >
                                                {/* Ï¢åÏ∏°: Ïù¥Î™®ÏßÄ Î∞è Ïù¥Î¶Ñ (ÎÜíÏù¥ Í≥†Ï†ïÏúºÎ°ú Ïù∏Ìï¥ ÏÑ∏Î°ú Ï§ëÏïô ÏûêÎèô Ï†ïÎ†¨) */}
                                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                                    <span className="text-sm shrink-0 leading-none">{node.data.emoji}</span>
                                                    <div className="flex items-baseline gap-2 truncate">
                                                        <span className="font-black text-xs text-slate-800 dark:text-zinc-100 shrink-0">
                                                            {node.label}
                                                        </span>
                                                        <span className="text-[9px] text-slate-400 font-bold truncate opacity-80">
                                                            / {node.projectName}
                                                        </span>
                                                    </div>
                                                </div>

                                                {/* Ïö∞Ï∏°: Ïù∏Î¨ºÏùº Í≤ΩÏö∞ Î∞∞ÏßÄ ÌëúÏãú, ÏÇ¨Í±¥Ïùº Í≤ΩÏö∞ Îπà Í≥µÍ∞Ñ Ïú†ÏßÄ (ÎÜíÏù¥ Îí§ÌãÄÎ¶º Î∞©ÏßÄ) */}
                                                <div className="shrink-0 ml-2 flex items-center h-full">
                                                    {node.type === 'Ïù∏Î¨º' ? (
                                                        <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[2px] rounded-sm shadow-sm leading-none ${getRoleBadgeStyle(node.data.role)}`}>
                                                            {node.data.role}
                                                        </span>
                                                    ) : (
                                                        /* ÏÇ¨Í±¥Ïùº ÎïåÎäî Î∞∞ÏßÄÍ∞Ä ÏóÜÏñ¥ÎèÑ ÎÜíÏù¥Î•º Ïú†ÏßÄÌïòÎèÑÎ°ù Îπà Í≥µÍ∞Ñ ÌôïÎ≥¥ */
                                                        <div className="w-1 h-4"></div>
                                                    )}
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="p-4 text-[10px] text-slate-400 italic text-center">Í≤∞Í≥º ÏóÜÏùå</div>
                                        )}
                                    </div>
                                </div>
                                <div className="flex-1 flex flex-col bg-white dark:bg-[#1a1a1d] p-5 overflow-hidden rounded-r-[3px]">
                                    {filteredMentionNodes[mention.selectedIndex] ? (
                                        <>
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className="text-2xl">{filteredMentionNodes[mention.selectedIndex].data.emoji}</span>
                                                <div className="flex items-center gap-2">
                                                    <div className="font-black text-slate-800 dark:text-zinc-100">{filteredMentionNodes[mention.selectedIndex].label}</div>
                                                </div>
                                            </div>
                                            <div className="text-2xs text-slate-500 dark:text-zinc-400 leading-relaxed overflow-y-auto custom-scroll pr-2">
                                                {filteredMentionNodes[mention.selectedIndex].type === 'Ïù∏Î¨º' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-indigo-500">
                                                        <span>ÏÑ±Î≥Ñ: {filteredMentionNodes[mention.selectedIndex].data.gender}</span>
                                                        <span>ÎÇòÏù¥: {filteredMentionNodes[mention.selectedIndex].data.age || 'ÎØ∏Ï†ï'}</span>
                                                        <span>ÏßÅÏóÖ: {filteredMentionNodes[mention.selectedIndex].data.job || 'ÎØ∏Ï†ï'}</span>
                                                        <span>Ï¢ÖÏ°±: {filteredMentionNodes[mention.selectedIndex].data.race || 'Ïù∏Í∞Ñ'}</span>
                                                    </div>
                                                )}
                                                
                                                {filteredMentionNodes[mention.selectedIndex].type === 'ÏÇ¨Í±¥' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-rose-500">
                                                        <span>Ïû•ÏÜå: {filteredMentionNodes[mention.selectedIndex].data.place || 'ÎØ∏Ï†ï'}</span>
                                                        <span>ÏãúÍ∏∞: {filteredMentionNodes[mention.selectedIndex].data.year || 'ÎØ∏Ï†ï'}</span>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].type === 'Î©îÎ™®' && (
                                                    <div className="mb-2 pb-2 border-b border-slate-50 dark:border-zinc-800 flex flex-wrap gap-x-3 gap-y-1 text-[12px] font-bold uppercase text-amber-500">
                                                        <span>üìù Î©îÎ™®</span>
                                                    </div>
                                                )}

                                                {filteredMentionNodes[mention.selectedIndex].data.memo || "ÏûëÏÑ±Îêú Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§."}
                                            </div>
                                        </>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center text-slate-300 dark:text-zinc-700 text-xs italic">Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
                                    )}
                                </div>
                            </div>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {activeNode && (
                            <>
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="fixed inset-0 bg-black/20 z-[199]"
                                    onClick={() => { setSelectedNodeId(null); }}
                                />
                                <motion.div
                                    initial={{ x: '100%' }}
                                    animate={{ x: 0 }}
                                    exit={{ x: '100%' }}
                                    transition={{ type: 'spring', damping: 25, stiffness: 200 }}
                                    className="fixed top-0 right-0 h-full w-[420px] bg-white dark:bg-darkpanel shadow-2xl z-[200] flex flex-col border-l border-slate-200 dark:border-zinc-700"
                                >
                                    {/* Ìó§Îçî */}
                                    <div className="h-16 px-6 flex items-center justify-between border-b border-slate-200 dark:border-zinc-700 shrink-0">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl">{activeNode.data.emoji}</span>
                                            <div>
                                                <h2 className="text-sm font-black text-slate-800 dark:text-zinc-100">{activeNode.label}</h2>
                                                <span className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">{activeNode.type} Ìé∏Ïßë</span>
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedNodeId(null)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 rounded-sm transition-colors">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                        </button>
                                    </div>

                                    {/* Ïª®ÌÖêÏ∏† */}
                                    <div className="flex-1 overflow-y-auto p-6 custom-scroll">
                                        <div className="space-y-5">
                                            {/* Ïù∏Î¨º Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'Ïù∏Î¨º' && (
                                                <>
                                                    {/* 1Ïó¥: Ïù¥Î™®ÏßÄ / Ïù¥Î¶Ñ / Ï£ºÏÇ¨ÏúÑ */}
                                                    <div className="flex gap-3">
                                                        <div className="w-14">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ïù¥Î™®ÏßÄ</label>
                                                            <input className="w-full mt-1 px-2 py-2 bg-slate-50 rounded-[3px] text-center text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji || (activeNode.type === 'Í∑∏Î£π' ? 'üìÅ' : '')} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ïù¥Î¶Ñ</label>
                                                            <div className="flex gap-1">
                                                                <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} />
                                                                <button 
                                                                    onClick={() => setIsNameGenOpen(!isNameGenOpen)}
                                                                    className={`mt-1 w-[42px] h-[42px] flex items-center justify-center rounded-[3px] border transition-colors ${isNameGenOpen ? 'bg-indigo-100 border-indigo-300 text-indigo-600 dark:bg-indigo-900/50 dark:border-indigo-700 dark:text-indigo-400' : 'bg-slate-50 border-slate-200 text-slate-400 hover:text-indigo-500 hover:border-indigo-300 dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-500 dark:hover:text-zinc-300'}`}
                                                                    title="Ïù¥Î¶Ñ ÏÉùÏÑ±Í∏∞ Ïó¥Í∏∞"
                                                                >
                                                                    üé≤
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* 2Ïó¥: Ïó≠Ìï† / ÏÑ±Î≥Ñ / ÎÇòÏù¥ */}
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ïó≠Ìï†</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.role} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, role: e.target.value}} : n))}>
                                                                <option value="Ï£ºÏù∏Í≥µ">üòÅ Ï£ºÏù∏Í≥µ</option>
                                                                <option value="Ï°∞Î†•Ïûê">üòé Ï°∞Î†•Ïûê</option>
                                                                <option value="Ï†ÅÎåÄÏûê">üò° Ï†ÅÎåÄÏûê</option>
                                                                <option value="Ï°∞Ïó∞">ü§ì Ï°∞Ïó∞</option>
                                                                <option value="ÏóëÏä§Ìä∏Îùº">ü•∏ ÏóëÏä§Ìä∏Îùº</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏÑ±Î≥Ñ</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.gender} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, gender: e.target.value}} : n))}>
                                                                <option value="ÎÇ®Ïûê">ÎÇ®Ïûê</option>
                                                                <option value="Ïó¨Ïûê">Ïó¨Ïûê</option>
                                                                <option value="Ï§ëÏÑ±">Ï§ëÏÑ±</option>
                                                                <option value="ÎØ∏ÏßÄÏ†ï">ÎØ∏ÏßÄÏ†ï</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÎÇòÏù¥</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.age} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, age: e.target.value}} : n))} placeholder="ÎÇòÏù¥" />
                                                        </div>
                                                    </div>

                                                    {/* 3Ïó¥: ÏßÅÏóÖ / Ï¢ÖÏ°± */}
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏßÅÏóÖ</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.job} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, job: e.target.value}} : n))} placeholder="ÏßÅÏóÖ ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ï¢ÖÏ°±</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.race || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, race: e.target.value}} : n))} placeholder="Ï¢ÖÏ°± ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ÏÇ¨Í±¥/Î©îÎ™®: Ïù¥Î™®ÏßÄ + Ïù¥Î¶Ñ */}
                                            {activeNode.type !== 'Ïù∏Î¨º' && (
                                                <div className="flex gap-3">
                                                    <div className="w-20">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ïù¥Î™®ÏßÄ</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] text-center text-xl border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji || (activeNode.type === 'Í∑∏Î£π' ? 'üìÅ' : '')} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ïù¥Î¶Ñ</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-lg border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} />
                                                    </div>
                                                </div>
                                            )}

                                            {/* ÏÇ¨Í±¥ Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'ÏÇ¨Í±¥' && (
                                                <div className="flex gap-3">
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î∞úÏÉù Ïû•ÏÜå</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.place || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, place: e.target.value}} : n))} placeholder="Ïû•ÏÜå ÏûÖÎ†•" />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î∞úÏÉù ÏãúÍ∏∞</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.year || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, year: e.target.value}} : n))} placeholder="ÏãúÍ∏∞/Ïó∞ÎèÑ ÏûÖÎ†•" />
                                                    </div>
                                                </div>
                                            )}

                                            {/* Ïû•ÏÜå Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'Ïû•ÏÜå' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏßÄÏó≠/ÏúÑÏπò</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.region || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, region: e.target.value}} : n))} placeholder="ÏßÄÏó≠ ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Í∏∞ÌõÑ/ÌôòÍ≤Ω</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.climate || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, climate: e.target.value}} : n))} placeholder="Í∏∞ÌõÑ/ÌôòÍ≤Ω ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ïû•ÏÜå ÏÑ§Î™Ö</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.description || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, description: e.target.value}} : n))} placeholder="Ïû•ÏÜåÏóê ÎåÄÌïú Í∞ÑÎã®Ìïú ÏÑ§Î™Ö" />
                                                    </div>
                                                </>
                                            )}

                                            {/* ÏïÑÏù¥ÌÖú Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'ÏïÑÏù¥ÌÖú' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î∂ÑÎ•ò</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.category || 'ÏùºÎ∞ò'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, category: e.target.value}} : n))}>
                                                                <option value="ÏùºÎ∞ò">ÏùºÎ∞ò</option>
                                                                <option value="Î¨¥Í∏∞">Î¨¥Í∏∞</option>
                                                                <option value="Î∞©Ïñ¥Íµ¨">Î∞©Ïñ¥Íµ¨</option>
                                                                <option value="Ïû•Ïã†Íµ¨">Ïû•Ïã†Íµ¨</option>
                                                                <option value="ÏÜåÎ™®Ìíà">ÏÜåÎ™®Ìíà</option>
                                                                <option value="Ïû¨Î£å">Ïû¨Î£å</option>
                                                                <option value="Ïó¥Ïá†/ÎèÑÍµ¨">Ïó¥Ïá†/ÎèÑÍµ¨</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ìù¨Í∑ÄÎèÑ</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.rarity || 'Î≥¥ÌÜµ'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, rarity: e.target.value}} : n))}>
                                                                <option value="Î≥¥ÌÜµ">Î≥¥ÌÜµ</option>
                                                                <option value="Í≥†Í∏â">Í≥†Í∏â</option>
                                                                <option value="Ìù¨Í∑Ä">Ìù¨Í∑Ä</option>
                                                                <option value="ÏòÅÏõÖ">ÏòÅÏõÖ</option>
                                                                <option value="Ï†ÑÏÑ§">Ï†ÑÏÑ§</option>
                                                                <option value="Ïú†Ïùº">Ïú†Ïùº</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏÜåÏú†Ïûê</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.owner || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, owner: e.target.value}} : n))} placeholder="ÏÜåÏú†Ïûê ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ìö®Í≥º/Îä•Î†•</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.effect || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, effect: e.target.value}} : n))} placeholder="Ìö®Í≥º/Îä•Î†• ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ÏÑ∏Î†• Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'ÏÑ∏Î†•' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î¶¨Îçî/ÏàòÏû•</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.leader || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, leader: e.target.value}} : n))} placeholder="Î¶¨Îçî ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏòÅÏó≠/Î≥∏Í±∞ÏßÄ</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.territory || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, territory: e.target.value}} : n))} placeholder="ÏòÅÏó≠ ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ï£ºÏöî Íµ¨ÏÑ±Ïõê</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.members || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, members: e.target.value}} : n))} placeholder="Ï£ºÏöî Íµ¨ÏÑ±Ïõê ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î™©Ìëú/Ïù¥ÎÖê</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.goal || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, goal: e.target.value}} : n))} placeholder="Î™©Ìëú/Ïù¥ÎÖê ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* Î≥µÏÑ† Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'Î≥µÏÑ†' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Îì±Ïû• Ïû•/ÌöåÏ∞®</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.chapter || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, chapter: e.target.value}} : n))} placeholder="Ïû•/ÌöåÏ∞® ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏÉÅÌÉú</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.status || 'ÎØ∏ÌöåÏàò'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, status: e.target.value}} : n))}>
                                                                <option value="ÎØ∏ÌöåÏàò">üîÑ ÎØ∏ÌöåÏàò</option>
                                                                <option value="ÏßÑÌñâÏ§ë">üî• ÏßÑÌñâÏ§ë</option>
                                                                <option value="ÌöåÏàòÎê®">‚úÖ ÌöåÏàòÎê®</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÌûåÌä∏/Î≥µÏÑ† ÎÇ¥Ïö©</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.hint || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, hint: e.target.value}} : n))} placeholder="Î≥µÏÑ† ÎÇ¥Ïö© ÏûÖÎ†•" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÌöåÏàò Í≥ÑÌöç</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.reveal || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, reveal: e.target.value}} : n))} placeholder="ÌöåÏàò Í≥ÑÌöç ÏûÖÎ†•" />
                                                    </div>
                                                </>
                                            )}

                                            {/* ÌÉÄÏûÑÎùºÏù∏ Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'ÌÉÄÏûÑÎùºÏù∏' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÎÇ†Ïßú/ÏãúÏ†ê</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.date || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, date: e.target.value}} : n))} placeholder="ÎÇ†Ïßú/ÏãúÏ†ê ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏãúÎåÄ/Î∞∞Í≤Ω</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.era || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, era: e.target.value}} : n))} placeholder="ÏãúÎåÄ/Î∞∞Í≤Ω ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ï§ëÏöîÎèÑ</label>
                                                        <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.importance || 'Î≥¥ÌÜµ'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, importance: e.target.value}} : n))}>
                                                            <option value="ÎÇÆÏùå">ÎÇÆÏùå</option>
                                                            <option value="Î≥¥ÌÜµ">Î≥¥ÌÜµ</option>
                                                            <option value="Ï§ëÏöî">Ï§ëÏöî</option>
                                                            <option value="ÌïµÏã¨">ÌïµÏã¨</option>
                                                        </select>
                                                    </div>
                                                </>
                                            )}

                                            {/* ÏÑ§Ï†ï Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'ÏÑ§Ï†ï' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î∂ÑÎ•ò</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.category || 'ÏÑ∏Í≥ÑÍ¥Ä'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, category: e.target.value}} : n))}>
                                                                <option value="ÏÑ∏Í≥ÑÍ¥Ä">ÏÑ∏Í≥ÑÍ¥Ä</option>
                                                                <option value="ÎßàÎ≤ïÏ≤¥Í≥Ñ">ÎßàÎ≤ïÏ≤¥Í≥Ñ</option>
                                                                <option value="Ï¢ÖÏ°±">Ï¢ÖÏ°±</option>
                                                                <option value="Ïó≠ÏÇ¨">Ïó≠ÏÇ¨</option>
                                                                <option value="Î¨∏Ìôî">Î¨∏Ìôî</option>
                                                                <option value="Í∑úÏπô">Í∑úÏπô</option>
                                                                <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ï†ÅÏö© Î≤îÏúÑ</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.scope || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, scope: e.target.value}} : n))} placeholder="Ï†ÅÏö© Î≤îÏúÑ ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* ÎåÄÏÇ¨ Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'ÎåÄÏÇ¨' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÌôîÏûê</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.speaker || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, speaker: e.target.value}} : n))} placeholder="ÌôîÏûê ÏûÖÎ†•" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Í∞êÏ†ï/ÌÜ§</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emotion || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emotion: e.target.value}} : n))} placeholder="Í∞êÏ†ï/ÌÜ§ ÏûÖÎ†•" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏÉÅÌô©/Îß•ÎùΩ</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.situation || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, situation: e.target.value}} : n))} placeholder="ÏÉÅÌô©/Îß•ÎùΩ ÏûÖÎ†•" />
                                                    </div>
                                                </>
                                            )}

                                            {/* Í∞àÎì± Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'Í∞àÎì±' && (
                                                <>
                                                    <div className="flex gap-3">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Í∞àÎì± ÎãπÏÇ¨Ïûê</label>
                                                            <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.parties || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, parties: e.target.value}} : n))} placeholder="ÎãπÏÇ¨Ïûê ÏûÖÎ†• (Ïòà: A vs B)" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÏÉÅÌÉú</label>
                                                            <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.status || 'ÏßÑÌñâÏ§ë'} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, status: e.target.value}} : n))}>
                                                                <option value="Ïû†Ïû¨Ï†Å">üîµ Ïû†Ïû¨Ï†Å</option>
                                                                <option value="ÏßÑÌñâÏ§ë">üî• ÏßÑÌñâÏ§ë</option>
                                                                <option value="Í≤©Ìôî">üí• Í≤©Ìôî</option>
                                                                <option value="Ìï¥Í≤∞Îê®">‚úÖ Ìï¥Í≤∞Îê®</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Í∞àÎì± ÏõêÏù∏</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.cause || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, cause: e.target.value}} : n))} placeholder="Í∞àÎì± ÏõêÏù∏ ÏûÖÎ†•" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ìï¥Í≤∞ Î∞©Ïïà</label>
                                                        <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 outline-none h-[42px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.resolution || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, resolution: e.target.value}} : n))} placeholder="Ìï¥Í≤∞ Î∞©Ïïà ÏûÖÎ†•" />
                                                    </div>
                                                </>
                                            )}

                                            {/* Í∑∏Î£π Ï†ÑÏö© ÌïÑÎìú */}
                                            {activeNode.type === 'Í∑∏Î£π' && (
                                                <>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î©îÎ™®</label>
                                                        <input type="text" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.memo || ''} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, memo: e.target.value}} : n))} placeholder="Í∑∏Î£π Î©îÎ™®..." />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Í∑∏Î£π ÏÉâÏÉÅ</label>
                                                        <div className="flex gap-2 mt-2 flex-wrap">
                                                            {['#94a3b8', '#6366f1', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899'].map(color => (
                                                                <button key={color} onClick={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, color}} : n))} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${activeNode.data.color === color ? 'border-slate-800 dark:border-white scale-110' : 'border-transparent'}`} style={{ backgroundColor: color }} />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-4">
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÎÑàÎπÑ</label>
                                                            <input type="number" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.width || 400} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, width: Math.max(200, parseInt(e.target.value) || 200)}} : n))} min="200" />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ÎÜíÏù¥</label>
                                                            <input type="number" className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.height || 300} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, height: Math.max(150, parseInt(e.target.value) || 150)}} : n))} min="150" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Ìè¨Ìï®Îêú ÎÖ∏Îìú ({(activeNode.data.childNodes || []).length}Í∞ú)</label>
                                                        <div className="mt-2 max-h-70 overflow-y-auto bg-slate-50 border border-slate-200 rounded-[3px] dark:bg-zinc-800 dark:border-zinc-700">
                                                            {(activeNode.data.childNodes || []).length === 0 ? (
                                                                <div className="p-4 text-center text-slate-400 text-xs">Ìè¨Ìï®Îêú ÎÖ∏ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                                                            ) : (
                                                                <div className="divide-y divide-slate-200 dark:divide-zinc-700">
                                                                    {(activeNode.data.childNodes || []).map(childId => {
                                                                        const childNode = nodes.find(n => n.id === childId);
                                                                        if (!childNode) return null;
                                                                        return (
                                                                            <div key={childId} className="flex items-center gap-2 px-3 py-2 hover:bg-slate-100 dark:hover:bg-zinc-700 transition-colors">
                                                                                <span className="text-lg">{childNode.data.emoji || 'üìÑ'}</span>
                                                                                <span className="flex-1 text-sm font-medium text-slate-700 dark:text-zinc-300 truncate">{childNode.label}</span>
                                                                                <span className="text-[10px] px-2 py-0.5 bg-slate-200 dark:bg-zinc-600 rounded text-slate-500 dark:text-zinc-400">{childNode.type}</span>
                                                                                <button
                                                                                    onClick={() => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, childNodes: (n.data.childNodes || []).filter(id => id !== childId)}} : n))}
                                                                                    className="p-1 text-slate-400 hover:text-red-500 transition-colors"
                                                                                    title="Í∑∏Î£πÏóêÏÑú Ï†úÍ±∞"
                                                                                >
                                                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                                                                </button>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* Î©îÎ™® */}
                                            {activeNode.type !== 'Í∑∏Î£π' && (
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Î©îÎ™® Î∞è ÏÑ∏Î∂Ä ÏÑ§Ï†ï</label>
                                                    <textarea className="w-full mt-1 h-56 p-4 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all resize-none leading-relaxed dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700" value={activeNode.data.memo} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, memo: e.target.value}} : n))} placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." />
                                                    <AnimatePresence>
                                                        {activeNode.type === 'Ïù∏Î¨º' && isNameGenOpen && (
                                                            <NameGenerator
                                                                onClose={() => setIsNameGenOpen(false)}
                                                                onConfirm={(name) => {
                                                                    updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: name} : n));
                                                                }}
                                                                settings={nameGenSettings}
                                                                onSettingsChange={setNameGenSettings}
                                                            />
                                                        )}
                                                    </AnimatePresence>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="p-6 border-t border-slate-200 dark:border-zinc-700 shrink-0">
                                        <button onClick={() => { saveHistory(); setSelectedNodeId(null); showToast("ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§"); }} className="w-full py-4 bg-slate-900 text-white font-black hover:bg-indigo-600 transition-all uppercase text-xs tracking-widest rounded-[3px] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500">
                                            Ï†ÄÏû• ÌõÑ Îã´Í∏∞
                                        </button>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>

                    <AnimatePresence>
                        {activeEdge && (
                            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-8 rounded-[3px] shadow-2xl w-[420px] relative dark:bg-darkpanel border border-slate-200 dark:border-darkborder">
                                    <button onClick={() => setSelectedEdgeId(null)} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-700 dark:hover:text-zinc-200 transition-colors">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                    </button>
                                    <h2 className="text-sm font-black text-indigo-500 uppercase tracking-widest mb-8 flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> Í¥ÄÍ≥Ñ ÏÑ§Ï†ï
                                    </h2>
                                    <div className="space-y-8">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">Í¥ÄÍ≥Ñ Î©îÎ™®</label>
                                            <input 
                                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-[3px] font-bold text-sm outline-none focus:border-indigo-500 focus:bg-white transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700/50" 
                                                placeholder="Ïòà: Ïó∞Ïù∏, Ï†ÅÎåÄ Í¥ÄÍ≥Ñ, Ï°∞Î†•Ïûê Îì±"
                                                value={activeEdge.label} 
                                                onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, label: e.target.value} : ev))} 
                                            />
                                        </div>
                                        <div className="flex gap-6">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ÏÑ† Ï¢ÖÎ•ò</label>
                                                <select 
                                                    className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-[3px] font-bold text-xs outline-none cursor-pointer hover:bg-slate-100 transition-colors dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300"
                                                    value={activeEdge.style || 'solid'}
                                                    onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, style: e.target.value} : ev))}
                                                >
                                                    <option value="solid">‚îÄ Ïã§ÏÑ† (Solid)</option>
                                                    <option value="dashed">--- Ï†êÏÑ† (Dashed)</option>
                                                </select>
                                            </div>
                                            <div className="flex-[1.2]">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-tighter ml-1 mb-2 block">ÏÑ† ÍµµÍ∏∞</label>
                                                <div className="flex items-center h-[42px] bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] p-1">
                                                    {[2, 4, 6].map(w => (
                                                        <button 
                                                            key={w} 
                                                            onClick={() => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, width: w} : ev))}
                                                            className={`flex-1 h-full flex flex-col items-center justify-center rounded-[2px] transition-all ${ (activeEdge.width || 2) === w ? 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-700 dark:text-indigo-400' : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300' }`}
                                                        >
                                                            <div className="bg-current rounded-full mb-1" style={{ width: w*2, height: 2 }}></div>
                                                            <span className="text-[9px] font-black">{w}px</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => { saveHistory(); setSelectedEdgeId(null); }} 
                                        className="w-full mt-10 py-4 bg-slate-900 text-white font-black rounded-[3px] hover:bg-indigo-600 transition-all uppercase text-[11px] tracking-[0.2em] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500"
                                    >
                                        Ï†ÄÏû• ÌõÑ Îã´Í∏∞
                                    </button>
                                </motion.div>
                            </div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const Library = ({ books, onSelectBook, onCreateBook, onDeleteBook, onUpdateBook, onImport, isDarkMode, toggleDarkMode, fontMode, toggleFont }) => {
            const [modalConfig, setModalConfig] = useState({ isOpen: false, mode: 'create', targetBook: null });

            // FilePanel ÏÉÅÌÉú
            const [filePanel, setFilePanel] = useState({ isOpen: false, mode: 'save' }); // mode: 'save' | 'load'
            const [importData, setImportData] = useState(null);

            const openSavePanel = () => {
                setFilePanel({ isOpen: true, mode: 'save' });
                setImportData(null);
            };

            const openLoadPanel = () => {
                setFilePanel({ isOpen: true, mode: 'load' });
                setImportData(null);
            };

            const closeFilePanel = () => {
                setFilePanel({ isOpen: false, mode: filePanel.mode });
                setImportData(null);
            };

            const handleExportFromPanel = (filename, exportType, password) => {
                const jsonString = JSON.stringify(books);

                if (exportType === 'vel') {
                    // ÏïîÌò∏Ìôî Ï†ÄÏû•
                    const encrypted = CryptoJS.AES.encrypt(jsonString, password).toString();
                    const blob = new Blob([encrypted], { type: "text/plain;charset=utf-8" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${filename}.vel`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } else {
                    // ÏùºÎ∞ò JSON Ï†ÄÏû•
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonString);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${filename}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
            };

            const handleFileSelectFromPanel = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    let isEncrypted = false;

                    try {
                        JSON.parse(fileContent);
                        isEncrypted = false;
                    } catch (jsonError) {
                        isEncrypted = true;
                    }

                    setImportData({ content: fileContent, isEncrypted });
                };
                reader.readAsText(file);
            };

            const handleConfirmImportFromPanel = (data, shouldReplace) => {
                if (data && Array.isArray(data)) {
                    onImport(data, shouldReplace);
                } else {
                    alert("Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏùÄ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§.");
                }
            }; 

            // ... ÎÇòÎ®∏ÏßÄ ÏΩîÎìúÎäî Í∏∞Ï°¥Í≥º ÎèôÏùº ...
            const handleConfirmModal = (title, author, color) => {
                // (Í∏∞Ï°¥ ÏΩîÎìú Ïú†ÏßÄ)
                if (modalConfig.mode === 'create') {
                    const newId = generateUUID();
                    const defaultProjectId = generateUUID();
                    const newBook = {
                        id: newId, title, author, color,
                        projects: [{ id: defaultProjectId, type: 'board', name: 'ÏÉà Î≥¥Îìú', nodes: [], edges: [] }],
                        activeProjectId: defaultProjectId
                    };
                    onCreateBook(newBook);
                } else {
                    onUpdateBook({ ...modalConfig.targetBook, title, author, color });
                }
                setModalConfig({ isOpen: false, mode: 'create', targetBook: null });
            };

            return (
                <div className="w-screen h-screen flex flex-col bg-[#f1f5f9] dark:bg-darkbg transition-colors duration-300">
                    {modalConfig.isOpen && ( <BookSettingsModal initialData={modalConfig.targetBook} onClose={() => setModalConfig({ isOpen: false, mode: 'create', targetBook: null })} onConfirm={handleConfirmModal} /> )}

                    {/* FilePanel - ÎÇ¥Î∂Ä Ï∞Ω */}
                    <AnimatePresence>
                        {filePanel.isOpen && (
                            <>
                                {/* Î∞∞Í≤Ω Ïò§Î≤ÑÎ†àÏù¥ */}
                                <motion.div
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0 }}
                                    className="fixed inset-0 bg-black/20 z-[99]"
                                    onClick={closeFilePanel}
                                />
                                <FilePanel
                                    isOpen={filePanel.isOpen}
                                    mode={filePanel.mode}
                                    onClose={closeFilePanel}
                                    books={books}
                                    onExport={handleExportFromPanel}
                                    onFileSelect={handleFileSelectFromPanel}
                                    importData={importData}
                                    onConfirmImport={handleConfirmImportFromPanel}
                                />
                            </>
                        )}
                    </AnimatePresence>

                    <header className="h-16 px-8 flex items-center justify-between bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 dark:bg-darkpanel/80 dark:border-darkborder">
                        <div className="flex items-center gap-2"> <div className="w-6 h-6 bg-slate-900 dark:bg-zinc-100"></div> <span className="text-lg font-black tracking-tight text-slate-900 dark:text-zinc-100">SAGAK STUDIO</span> </div>
                        <div className="flex items-center gap-3">
                            <button onClick={toggleFont} className="p-2 text-slate-400 hover:text-slate-800 transition-colors bg-slate-100 dark:bg-zinc-800 dark:text-zinc-400" title="Ìè∞Ìä∏ Î≥ÄÍ≤Ω">
                                <IconFont className="w-4 h-4" />
                            </button>
                            <button onClick={toggleDarkMode} className="p-2 text-slate-400 hover:text-slate-800 transition-colors bg-slate-100 hover:bg-slate-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:text-zinc-100 dark:hover:bg-zinc-700" title="Îã§ÌÅ¨ Î™®Îìú ÌÜ†Í∏Ä"> {isDarkMode ? <IconSun className="w-4 h-4" /> : <IconMoon className="w-4 h-4" />} </button>
                            <div className="h-4 w-px bg-slate-300 mx-1 dark:bg-zinc-700"></div>

                            {/* Î∂àÎü¨Ïò§Í∏∞ Î≤ÑÌäº */}
                            <button onClick={openLoadPanel} className={`flex items-center gap-2 px-2 py-2 border text-[11px] font-bold transition-all shadow-sm ${filePanel.isOpen && filePanel.mode === 'load' ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-700'}`} title="ÌååÏùº Î∂àÎü¨Ïò§Í∏∞"><IconUpload className="w-3 h-3" /></button>

                            {/* Ï†ÄÏû• Î≤ÑÌäº */}
                            <button onClick={openSavePanel} className={`flex items-center gap-2 px-2 py-2 text-[11px] font-bold transition-all shadow-sm ${filePanel.isOpen && filePanel.mode === 'save' ? 'bg-indigo-600 text-white' : 'bg-slate-900 text-white hover:bg-slate-800 dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200'}`} title="Ï†ÑÏ≤¥ Ï†ÄÏû•"><IconSave className="w-3 h-3" /></button>
                        </div>
                    </header> 
                    <div className="flex-1 overflow-y-auto custom-scroll"> 
                        <div className="max-w-7xl mx-auto p-10 min-h-full flex flex-col">
                            <div className="flex-1">
                                <div className="mb-8 flex items-end justify-between"> 
                                    <div> 
                                        <h2 className="text-3xl font-black text-slate-900 mb-2 dark:text-zinc-100">ÎÇ¥ ÏÑúÏû¨</h2> 
                                        <p className="text-sm text-slate-500 font-medium dark:text-zinc-400">Ï¥ù {books.length}Í∞úÏùò ÏûëÌíàÏù¥ ÏûàÏäµÎãàÎã§.</p> 
                                    </div> 
                                </div> 
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10"> 
                                    {books.map(book => ( <BookCover key={book.id} book={book} onClick={() => onSelectBook(book.id)} onDelete={onDeleteBook} onEdit={(target) => setModalConfig({ isOpen: true, mode: 'edit', targetBook: target })} /> ))} 
                                    <button onClick={() => setModalConfig({ isOpen: true, mode: 'create', targetBook: null })} className="group flex flex-col items-center justify-center gap-4 aspect-[2/3] rounded-[3px] border-2 border-dashed border-slate-300 hover:border-indigo-400 hover:bg-indigo-50 transition-all dark:border-zinc-700 dark:hover:bg-zinc-800/50"> 
                                        <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-all dark:bg-zinc-800 dark:text-zinc-500"> <IconPlus className="w-6 h-6" /> </div> 
                                        <span className="text-sm font-bold text-slate-400 group-hover:text-indigo-600 dark:text-zinc-500 dark:group-hover:text-indigo-400">ÏÉà ÏûëÌíà Ï∂îÍ∞Ä</span> 
                                    </button> 
                                </div> 
                            </div>

                            <footer className="mt-20 pb-6 flex flex-col items-center justify-center gap-1 opacity-30 hover:opacity-100 transition-opacity duration-500">
                                <div className="flex items-center gap-1.5">
                                    <div className="w-3 h-3 bg-slate-400 Galmuri14-[1px] dark:bg-zinc-600 opacity-50"></div>
                                    <span className="text-[10px] font-black tracking-[0.2em] text-slate-500 dark:text-zinc-500 uppercase">
                                        Sagak Studio
                                    </span>
                                </div>
                                <p className="text-[10px] font-bold text-slate-400 dark:text-zinc-600 tracking-wider">
                                    Made by SWISSBUTTER
                                </p>
                            </footer>
                        </div> 
                    </div> 
                </div> 
            ); 
        };

        const App = () => { 
            const [view, setView] = useState('library'); 
            const [books, setBooks] = useState(() => { 
                const saved = localStorage.getItem('sagak_library'); 
                return saved ? JSON.parse(saved) : []; 
            }); 
            const [currentBookId, setCurrentBookId] = useState(null); 
            const [toast, setToast] = useState(null); 
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('theme') === 'dark'); 
            const [fontMode, setFontMode] = useState(() => localStorage.getItem('sagak_font') || 'maruburi');
            const saveTimerRef = useRef(null);
            
            useEffect(() => { 
                if (isDarkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } 
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } 
            }, [isDarkMode]); 
            
            const toggleDarkMode = () => setIsDarkMode(prev => !prev); 

            // Ìè∞Ìä∏ Î≥ÄÍ≤Ω Ìö®Í≥º
            useEffect(() => {
                const fonts = ['font-maruburi', 'font-Ridibatang', 'font-Galmuri14', 'font-pretendard'];
                document.body.classList.remove(...fonts);
                document.body.classList.add(`font-${fontMode}`);
                localStorage.setItem('sagak_font', fontMode);
            }, [fontMode]);

            const toggleFont = () => {
                const modes = ['maruburi', 'Ridibatang', 'Galmuri14', 'pretendard'];
                const nextIndex = (modes.indexOf(fontMode) + 1) % modes.length;
                const nextFont = modes[nextIndex];
                setFontMode(nextFont);
                showToast(`Ìè∞Ìä∏ Î≥ÄÍ≤Ω: ${nextFont.charAt(0).toUpperCase() + nextFont.slice(1)}`);
            };
            
            useEffect(() => { 
                if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
                saveTimerRef.current = setTimeout(() => {
                    localStorage.setItem('sagak_library', JSON.stringify(books)); 
                }, 1000);
                return () => { if(saveTimerRef.current) clearTimeout(saveTimerRef.current); };
            }, [books]); 
            
            const showToast = useCallback((message, type = 'success') => { 
                setToast({ message, type }); 
                setTimeout(() => setToast(null), 2000); 
            }, []); 
            
            const currentBook = useMemo(() => books.find(b => b.id === currentBookId), [books, currentBookId]); 
            
            const handleUpdateBook = useCallback((updatedBook) => { 
                setBooks(prev => prev.map(b => b.id === updatedBook.id ? updatedBook : b)); 
            }, []); 
            
            return ( 
                <div className="font-sans text-slate-900 bg-[#f1f5f9] min-h-screen dark:bg-darkbg dark:text-zinc-200"> 
                    <AnimatePresence> {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />} </AnimatePresence> 
                    {view === 'library' && ( 
                        <Library 
                            books={books} 
                            onSelectBook={(id) => { setCurrentBookId(id); setView('workspace'); }} 
                            onCreateBook={(newBook) => setBooks([...books, newBook])} 
                            onDeleteBook={(id, e) => { 
                                if (confirm("ÏûëÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.")) {
                                    setBooks(prev => prev.filter(b => b.id !== id)); 
                                    showToast("ÏûëÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                                }
                            }}
                            onUpdateBook={handleUpdateBook} 
                            // App Ïª¥Ìè¨ÎÑåÌä∏ ÎÇ¥Î∂Ä
                            onImport={(imported, shouldReplace) => { 
                                if (shouldReplace) {
                                    setBooks(imported); 
                                    showToast("ÏÑúÏû¨Î•º Ï¥àÍ∏∞ÌôîÌïòÍ≥† Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.");
                                } else {
                                    setBooks(prev => [...prev, ...imported]); 
                                    showToast("ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Ï∂îÍ∞ÄÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§.");
                                }
                            }}
                            isDarkMode={isDarkMode} 
                            toggleDarkMode={toggleDarkMode}
                            fontMode={fontMode}
                            toggleFont={toggleFont}
                        /> 
                    )} 
                    {view === 'workspace' && currentBook && ( 
                        <Workspace currentBook={currentBook} onUpdateBook={handleUpdateBook} onExit={() => setView('library')} showToast={showToast} /> 
                    )} 
                </div> 
            ); 
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
