<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ê° ìŠ¤íŠœë””ì˜¤ v2.1 (Dark Mode Adjusted)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#09090b',    // Zinc 950
                        darkpanel: '#18181b', // Zinc 900
                        darkborder: '#27272a', // Zinc 800
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #f1f5f9; overflow: hidden; user-select: none; transition: background-color 0.3s, color 0.3s; }
        
        /* ë‹¤í¬ëª¨ë“œ ì„¤ì • */
        .dark body { background: #09090b; color: #e4e4e7; }

        /* ë°°ê²½ íŒ¨í„´ */
        .grid-background {
            background-color: #f8fafc;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .dark .grid-background {
            background-color: #09090b;
            background-image: linear-gradient(#27272a 1px, transparent 1px), linear-gradient(90deg, #27272a 1px, transparent 1px);
        }

        .dot-background {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 0) !important;
            background-size: 20px 20px !important;
            background-position: 0 0;
        }
        .dark .dot-background {
            background-color: #09090b;
            background-image: radial-gradient(#27272a 1px, transparent 0) !important;
        }

        /* SVG ë° ë…¸ë“œ */
        .canvas-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible; }
        .edge-path { fill: none; transition: stroke 0.2s; stroke-linecap: round; stroke-linejoin: round; }
        .edge-hitbox { fill: none; stroke: transparent; stroke-width: 20; cursor: pointer; pointer-events: stroke; }
        
        .node-glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid #cbd5e1; border-radius: 3px; box-sizing: border-box; }
        .dark .node-glass { background: rgba(39, 39, 42, 0.95); border: 1px solid #52525b; color: #e4e4e7; }
        
        .node-postit { background-color: #fef9c3; border-radius: 3px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border: 1px solid #fde047; }
        .dark .node-postit { background-color: #422006; border: 1px solid #854d0e; color: #fef08a; }
        
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .zoom-container { transform-origin: 0 0; will-change: transform; transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1); }
        .is-dragging .zoom-container { transition: none; }
        
        /* ì£¼ì¸ê³µ ë…¸ë“œ í…Œë‘ë¦¬ íˆ¬ëª…í™” */
        .node-protagonist { outline: 8px solid rgba(37, 99, 235, 0.2); background: #d7e7fc; }
        .dark .node-protagonist { outline: 8px solid rgba(37, 99, 235, 0.2); background: #172554; }
        
        .node-antagonist { border: 1px solid #c88885; background: #fbdfde; }
        .dark .node-antagonist { border: 1px solid #7f1d1d; background: #450a0a; }

        .node-helper { border: 1px solid #7dcb97; background: #d0f7e2; }
        .dark .node-helper { border: 1px solid #059669; background: #064e3b; }

        .node-event { outline: 4px solid rgba(255, 3, 3, 0.3); }

        /* ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; transition: background 0.2s; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; }
        .dark .custom-scroll:hover::-webkit-scrollbar-thumb { background: #52525b; }

        /* ì—ë””í„° */
        .editor-paper {
            max-width: 585px; margin: 40px auto; background: white; min-height: calc(100vh - 80px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); border-radius: 3px; display: flex; flex-direction: column; position: relative; overflow: hidden;
            transition: background-color 0.3s;
        }
        .dark .editor-paper { background: #18181b; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); border: 1px solid #27272a; }

        .editor-title-container { padding: 40px 60px 10px 60px; }
        .editor-textarea { width: 100%; flex: 1; resize: none; outline: none; line-height: 2.2; font-size: 18px; color: #334155; background: transparent; border: none; padding: 20px 60px 60px 60px; }
        .dark .editor-textarea { color: #d4d4d8; }

        /* ë©˜ì…˜ ë¦¬ìŠ¤íŠ¸ */
        .mention-list {
            position: fixed; z-index: 1000; background: white; border: 1px solid #e2e8f0; border-radius: 3px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); max-height: 400px; overflow: visible; min-width: 240px;
        }
        .dark .mention-list { background: #18181b; border-color: #27272a; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .mention-item-active { background-color: #f1f5f9; border-left: 4px solid #4f46e5; }
        .dark .mention-item-active { background-color: #27272a; border-left: 4px solid #6366f1; }

        /* ì„œì¬ ì¹´ë“œ (ë‹¤í¬ëª¨ë“œ ì œì™¸) */
        .book-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform-style: preserve-3d; }
        .book-spine { background: linear-gradient(90deg, transparent 0%, transparent 20%, rgba(0,0,0,0.1) 100%); }
        .page-bg {
            background-color: #fdfbf7;
            background-image: repeating-linear-gradient(transparent, transparent 19px, #e5e7eb 20px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useMemo, useEffect, memo } = React;
        const { motion, AnimatePresence, Reorder } = window.Motion;

        const CARD_W = 250; 
        const CARD_H = 200;

        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        // Icons
        const IconPlus = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
        const IconTrash = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>);
        const IconBack = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const IconUpload = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>);
        const IconSave = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>);
        const IconSun = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>);
        const IconMoon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>);

        // Utility
        const getCaretCoordinates = (element, position) => { const div = document.createElement('div'); const style = window.getComputedStyle(element); const props = ['fontFamily', 'fontSize', 'fontWeight', 'lineHeight', 'padding', 'border', 'width', 'boxSizing', 'whiteSpace', 'wordWrap']; props.forEach(prop => div.style[prop] = style[prop]); div.style.position = 'absolute'; div.style.visibility = 'hidden'; div.textContent = element.value.substring(0, position); const span = document.createElement('span'); span.textContent = element.value.substring(position) || '.'; div.appendChild(span); document.body.appendChild(div); const rect = element.getBoundingClientRect(); const coordinates = { top: rect.top + span.offsetTop + element.scrollTop, left: rect.left + span.offsetLeft }; document.body.removeChild(div); return coordinates; };
        const getWordAtPos = (text, pos) => { if (!text) return ""; const left = text.slice(0, pos).search(/[^\s#@]*$/); const right = text.slice(pos).search(/[\s\n\r]/); const word = text.slice(left, right === -1 ? undefined : right + pos); return word.replace(/[#@]/g, '').trim(); };
        const getBezierPath = (x1, y1, x2, y2) => { const dx = x2 - x1; const dy = y2 - y1; const curvature = 0.5; const cx1 = x1 + dx * curvature; const cy1 = y1; const cx2 = x2 - dx * curvature; const cy2 = y2; return `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`; };
        const getEdgeTargetPos = (from, to, offset = 12) => { const x1 = from.x + CARD_W / 2; const y1 = from.y + CARD_H / 2; const x2 = to.x + CARD_W / 2; const y2 = to.y + CARD_H / 2; const dx = x2 - x1; const dy = y2 - y1; const angle = Math.atan2(dy, dx); const absCos = Math.abs(Math.cos(angle)); const absSin = Math.abs(Math.sin(angle)); let distance = (CARD_W * absSin <= CARD_H * absCos) ? (CARD_W / 2) / absCos : (CARD_H / 2) / absSin; return { x: x2 - Math.cos(angle) * (distance + offset), y: y2 - Math.sin(angle) * (distance + offset) }; };
        
        // [ìˆ˜ì •] ë‹¤í¬ëª¨ë“œì‹œ ì±„ë„ ì¡°ì ˆ: bg-blue-600 -> dark:bg-blue-800 ë“±
        const getRoleBadgeStyle = (role) => { switch(role) { case 'ì£¼ì¸ê³µ': return 'bg-blue-600 dark:bg-blue-800 text-white'; case 'ì ëŒ€ì': return 'bg-red-600 dark:bg-red-800 text-white'; case 'ì¡°ë ¥ì': return 'bg-emerald-600 dark:bg-emerald-800 text-white'; case 'ì¡°ì—°': return 'bg-slate-500 text-white'; case 'ì—‘ìŠ¤íŠ¸ë¼': return 'bg-slate-300 text-slate-600'; default: return 'bg-slate-100 text-slate-500 border border-slate-200'; } };
        
        const getStatusBadgeStyle = (status) => { switch(status) { case 'ì´ˆê³ ': return 'bg-slate-200 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300'; case 'ìˆ˜ì •': return 'bg-amber-100 text-amber-600 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800'; case 'ì™„ë£Œ': return 'bg-emerald-600 text-white'; default: return 'bg-slate-100 text-slate-400'; } };
        const getSidebarItemAccent = (node) => { if (node.type !== 'ì¸ë¬¼') return 'border-l-transparent'; switch(node.data.role) { case 'ì£¼ì¸ê³µ': return 'border-l-blue-500'; case 'ì ëŒ€ì': return 'border-l-red-500'; case 'ì¡°ë ¥ì': return 'border-l-emerald-500'; default: return 'border-l-slate-300 dark:border-l-zinc-600'; } };
        const getStrokeDashArray = (style) => { switch(style) { case 'dashed': return "4, 8"; default: return ""; } };
        
        const BOOK_COLORS = ['#18181b', '#3c3c3c', '#881337', '#7c2d12', '#424034', '#73734e', '#2e3b36', '#134e4a', '#1e3a8a', '#33272c', '#4c1d95', '#451a03'];
        const getRandomColor = () => BOOK_COLORS[Math.floor(Math.random() * BOOK_COLORS.length)];

        // Toast
        const Toast = ({ message, type, onClose }) => (
            <motion.div initial={{ y: 50, opacity: 0, scale: 0.9 }} animate={{ y: 0, opacity: 1, scale: 1 }} exit={{ y: 50, opacity: 0, scale: 0.9 }} className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] flex items-center gap-3 bg-zinc-800 dark:bg-zinc-100 text-white dark:text-zinc-900 px-6 py-3 rounded-full shadow-2xl">
                <span className="text-sm font-bold">{message}</span>
            </motion.div>
        );

        // NodeCard
        const NodeCard = memo(({ node, isTop, onNodeDragStart, onMouseDown, onMouseUp, onDoubleClick, onDelete }) => {
            const isIdea = node.type === 'ë©”ëª¨';
            let styleClass = isIdea ? "node-postit" : "node-glass";
            if (node.type === 'ì¸ë¬¼') {
                if (node.data.role === 'ì£¼ì¸ê³µ') styleClass += " node-protagonist";
                else if (node.data.role === 'ì ëŒ€ì') styleClass += " node-antagonist";
                else if (node.data.role === 'ì¡°ë ¥ì') styleClass += " node-helper";
            } else if (node.type === 'ì‚¬ê±´') styleClass += " node-event";

            return (
                <div onMouseDown={(e) => { if (e.button === 0) onNodeDragStart(e, node.id); onMouseDown(e, node.id); }} onMouseUp={(e) => onMouseUp(e, node.id)} onDoubleClick={() => onDoubleClick(node.id)} style={{ zIndex: isTop ? 50 : 10, width: CARD_W, height: CARD_H, transform: `translate(${node.x}px, ${node.y}px)`, position: 'absolute', top: 0, left: 0 }} className={`flex flex-col cursor-grab active:cursor-grabbing shadow-lg hover:shadow-xl transition-shadow group relative ${styleClass}`}>
                    <button onClick={(e) => { e.stopPropagation(); if(confirm("ì´ ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) onDelete(node.id); }} className="absolute top-0 right-0 z-[100] w-6 h-6 flex items-center justify-center bg-white hover:bg-red-500 hover:text-white text-slate-400 border border-slate-200 rounded-[3px] shadow-md opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-1/2 -translate-y-1/2 dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-300"><IconTrash className="w-3 h-3" /></button>
                    <div className="w-full h-full flex flex-col overflow-hidden rounded-[inherit]">
                        {/* [ìˆ˜ì •] ë…¸ë“œ ìƒë‹¨ ì»¬ëŸ¬ë°”: ë‹¤í¬ëª¨ë“œ ì‹œ ì±„ë„ ê°ì†Œ(800ë²ˆëŒ€) */}
                        {!isIdea && <div className={`h-1.5 w-[calc(100%+4px)] -ml-[2px] -mt-[2px] shrink-0 ${node.type === 'ì¸ë¬¼' ? 'bg-blue-600 dark:bg-blue-800' : node.type === 'ì‚¬ê±´' ? 'bg-red-600 dark:bg-red-800' : 'bg-amber-500 dark:bg-amber-700'}`} />}
                        <div className="flex-1 flex flex-col p-4 overflow-hidden pointer-events-none">
                            <div className="flex items-center justify-between mb-2">
                                <span className={`text-[10px] font-black uppercase tracking-widest ${isIdea ? 'text-yellow-800 dark:text-yellow-100' : 'text-slate-400 dark:text-zinc-500'}`}>{node.type}</span>
                                {node.type === 'ì¸ë¬¼' && <span className={`text-[9px] font-bold px-2 py-0.5 rounded-[3px] ${getRoleBadgeStyle(node.data.role)}`}>{node.data.role}</span>}
                            </div>
                            <div className={`text-base font-black truncate mb-1 ${isIdea ? 'text-slate-900 dark:text-yellow-50' : 'text-slate-800 dark:text-zinc-200'}`}><span className="mr-1.5">{node.data.emoji || (node.type === 'ì¸ë¬¼' ? 'ğŸ‘¤' : node.type === 'ì‚¬ê±´' ? 'ğŸ”¥' : 'ğŸ’¡')}</span>{node.label}</div>
                            {node.type === 'ì¸ë¬¼' && <div className="text-[11px] text-slate-500 dark:text-zinc-400 font-bold mb-2">{node.data.gender} Â· {node.data.age ? `${node.data.age}ì„¸` : 'ë‚˜ì´ ë¯¸ìƒ'} Â· {node.data.job || 'ì§ì—… ì—†ìŒ'}</div>}
                            <div className={`text-[12px] font-medium leading-tight line-clamp-3 grow ${isIdea ? 'text-slate-700 dark:text-yellow-100/80' : 'text-slate-500 bg-slate-50 p-2 rounded-[3px] border border-slate-100 italic dark:bg-zinc-800/50 dark:border-zinc-700 dark:text-zinc-400'}`}>{node.data.memo || "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}</div>
                        </div>
                    </div>
                </div>
            );
        });

        // BookCover
        const BookCover = memo(({ book, onClick, onDelete, onRename, onClearAutoEdit }) => {
            const [isEditing, setIsEditing] = useState(false);
            const inputRef = useRef(null);

            useEffect(() => {
                if (book.autoEdit) {
                    setIsEditing(true);
                    onClearAutoEdit(book.id);
                }
            }, [book.autoEdit, book.id, onClearAutoEdit]);

            useEffect(() => {
                if (isEditing && inputRef.current) {
                    inputRef.current.focus();
                    inputRef.current.select();
                }
            }, [isEditing]);

            const handleRename = (e) => {
                if (e.key === 'Enter') setIsEditing(false);
            };

            const handleBlur = () => setIsEditing(false);

            return (
                <div className="group perspective-1000 relative" style={{ perspective: '1200px' }} onClick={onClick}>
                    <div className="absolute top-[8px] bottom-[8px] left-0 w-full bg-white rounded-r-[3px] shadow-sm transform translate-x-[9px] z-[1] border border-slate-200 opacity-40"></div>
                    <div className="absolute top-[6px] bottom-[6px] left-0 w-full bg-white rounded-r-[3px] shadow-sm transform translate-x-[6px] z-[2] border border-slate-200 opacity-70"></div>
                    <div className="absolute top-[4px] bottom-[4px] left-0 w-full bg-white rounded-r-[3px] shadow-sm transform translate-x-[3px] z-[3] border border-slate-200 opacity-90"></div>
                    <div className="absolute top-[2px] bottom-[2px] left-[-1px] w-full page-bg rounded-r-[3px] shadow-sm transform translate-x-[1px] z-[4] border-l border-slate-200"></div>
                    
                    <motion.div initial={{ rotateY: 0 }} whileHover={{ rotateY: -20 }} transition={{ type: "spring", stiffness: 200, damping: 15 }} className="book-card relative rounded-[3px] shadow-lg cursor-pointer flex flex-col overflow-hidden origin-left z-10 h-full" style={{ backgroundColor: book.color || '#475569', aspectRatio: '2 / 3' }} onDoubleClick={(e) => { e.stopPropagation(); setIsEditing(true); }}>
                        <div className="absolute inset-0 book-spine pointer-events-none z-10"></div>
                        <div className="absolute left-0 top-0 bottom-0 w-[15px] bg-black/10 z-10"></div>
                        <div className="flex-1 p-8 flex flex-col relative z-20 text-white">
                            <div className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-4 border-b border-white/20 pb-2">NOVEL PROJECT</div>
                            {isEditing ? ( <textarea ref={inputRef} className="w-full bg-black/20 text-white text-2xl font-black rounded-[3px] p-2 outline-none resize-none overflow-hidden" value={book.title} onChange={(e) => onRename(book.id, e.target.value)} onKeyDown={handleRename} onBlur={handleBlur} onClick={(e) => e.stopPropagation()} rows={3} /> ) : ( <h3 className="text-2xl font-black leading-tight tracking-tight break-keep drop-shadow-md">{book.title}</h3> )}
                            <div className="mt-auto pt-4 space-y-1">
                                <div className="flex items-center gap-2 text-[11px] font-bold opacity-80">
                                    <span className="opacity-60">ë³´ë“œ</span> {book.projects.filter(p => p.type === 'board').length}
                                    <span className="mx-1 opacity-40">|</span>
                                    <span className="opacity-60">ë¬¸ì„œ</span> {book.projects.filter(p => p.type === 'doc').length}
                                </div>
                                <div className="text-[10px] font-medium opacity-50">Last edited: {new Date().toLocaleDateString()}</div>
                            </div>
                        </div>
                        <button onClick={(e) => onDelete(book.id, e)} className="absolute bottom-4 right-4 z-30 p-2 text-white/40 hover:text-white hover:bg-white/20 rounded-[3px] transition-all opacity-0 group-hover:opacity-100" title="ì‚­ì œ"><IconTrash className="w-4 h-4" /></button>
                    </motion.div>
                </div>
            );
        });

        // Workspace
        const Workspace = ({ currentBook, onUpdateBook, onExit, showToast }) => {
            const [projects, setProjects] = useState(currentBook.projects || []);
            const [activeProjectId, setActiveProjectId] = useState(currentBook.activeProjectId || (currentBook.projects[0] ? currentBook.projects[0].id : 'default'));
            const [expandedProjects, setExpandedProjects] = useState(currentBook.expandedProjects || (currentBook.projects[0] ? { [currentBook.projects[0].id]: true } : {}));
            const [scale, setScale] = useState(currentBook.scale || 1);
            const [pan, setPan] = useState(currentBook.pan || { x: 0, y: 0 });
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const titleInputRef = useRef(null);

            useEffect(() => { if (isEditingTitle && titleInputRef.current) titleInputRef.current.focus(); }, [isEditingTitle]);
            useEffect(() => { const timer = setTimeout(() => { onUpdateBook({ ...currentBook, projects, activeProjectId, expandedProjects, scale, pan }); }, 300); return () => clearTimeout(timer); }, [projects, activeProjectId, expandedProjects, scale, pan]);

            const [editingProjectId, setEditingProjectId] = useState(null);
            const [mention, setMention] = useState({ active: false, type: '', search: '', x: 0, y: 0, pos: 0, selectedIndex: 0 });
            const [hoverInfo, setHoverInfo] = useState({ visible: false, node: null, x: 0, y: 0 });
            const textareaRef = useRef(null);
            const containerRef = useRef(null);

            const activeProject = useMemo(() => projects.find(p => p.id === activeProjectId) || projects[0], [projects, activeProjectId]);
            
            // --- ì•ˆì „ ì¥ì¹˜: í”„ë¡œì íŠ¸ê°€ ì—†ëŠ” ê²½ìš° ---
            if (!activeProject) {
                return (
                    <div className="flex w-screen h-screen items-center justify-center bg-[#f1f5f9] dark:bg-darkbg text-slate-400 dark:text-zinc-500">
                        <div className="text-center">
                            <p className="mb-4 text-lg font-bold">í”„ë¡œì íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                            <button onClick={onExit} className="px-4 py-2 bg-indigo-600 text-white rounded-[3px] text-sm font-bold">ë‚˜ê°€ê¸°</button>
                        </div>
                    </div>
                );
            }

            const nodes = activeProject.nodes || [];
            const edges = activeProject.edges || [];
            const allBoardNodes = useMemo(() => projects.filter(p => p.type === 'board').flatMap(p => (p.nodes || []).map(node => ({ ...node, projectName: p.name }))), [projects]);
            const filteredMentionNodes = useMemo(() => { if (!mention.active) return []; return allBoardNodes.filter(n => n.type === (mention.type === '@' ? 'ì¸ë¬¼' : 'ì‚¬ê±´') && (n.label.includes(mention.search) || mention.search === "")); }, [allBoardNodes, mention]);

            const handleSelectProject = (id) => setActiveProjectId(id);
            const toggleProjectFolder = (id, e) => { if (e) e.stopPropagation(); setExpandedProjects(prev => ({ ...prev, [id]: !prev[id] })); };
            
            const updateActiveProject = useCallback((nodeUpdater, edgeUpdater) => {
                setProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    return {
                        ...p,
                        nodes: nodeUpdater ? nodeUpdater(p.nodes || []) : (p.nodes || []),
                        edges: edgeUpdater ? edgeUpdater(p.edges || []) : (p.edges || [])
                    };
                }));
            }, [activeProjectId]);

            const updateDocContent = (content) => { setProjects(prev => prev.map(p => p.id === activeProjectId ? { ...p, content } : p)); };

            const [history, setHistory] = useState({ past: [], future: [] });
            const [isPanning, setIsPanning] = useState(false);
            const [draggingNodeId, setDraggingNodeId] = useState(null);
            const [tempEdge, setTempEdge] = useState(null);
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [selectedEdgeId, setSelectedEdgeId] = useState(null);
            const [topNodeId, setTopNodeId] = useState(null);
            const lastMousePos = useRef({ x: 0, y: 0 });
            const hasConnectedRef = useRef(false);

            const saveHistory = useCallback(() => { setHistory(prev => ({ past: [...prev.past.slice(-19), { projects }], future: [] })); }, [projects]);
            const undo = useCallback(() => { setHistory(prev => { if (prev.past.length === 0) return prev; const previous = prev.past[prev.past.length - 1]; const newPast = prev.past.slice(0, prev.past.length - 1); setProjects(previous.projects); showToast("ì‹¤í–‰ ì·¨ì†Œë¨"); return { past: newPast, future: [{ projects }, ...prev.future] }; }); }, [projects]);
            useEffect(() => { const handleKeyDown = (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); } }; window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown); }, [undo]);
            
            useEffect(() => { const handleWheel = (e) => { if (e.target.closest('aside') || activeProject?.type === 'doc') return; e.preventDefault(); const rect = containerRef.current.getBoundingClientRect(); const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top; const delta = -e.deltaY * 0.0012; const newScale = Math.min(Math.max(0.1, scale + delta), 3); const scaleRatio = newScale / scale; setPan(prev => ({ x: mouseX - (mouseX - prev.x) * scaleRatio, y: mouseY - (mouseY - prev.y) * scaleRatio })); setScale(newScale); }; const div = containerRef.current; if(div) { div.addEventListener('wheel', handleWheel, { passive: false }); return () => div.removeEventListener('wheel', handleWheel); } }, [scale, activeProject]);

            const getCanvasCoords = (clientX, clientY) => { const rect = containerRef.current.getBoundingClientRect(); return { x: (clientX - rect.left - pan.x) / scale, y: (clientY - rect.top - pan.y) / scale }; };
            const findNode = (id) => nodes.find(n => n.id === id);
            
            const createNewProject = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'board', name: 'ìƒˆ í”„ë¡œì íŠ¸', nodes: [], edges: [] }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); setPan({ x: 0, y: 0 }); setScale(1); };
            const createNewDoc = () => { const newId = generateUUID(); saveHistory(); setProjects(prev => [...prev, { id: newId, type: 'doc', name: 'ìƒˆ ë¬¸ì„œ', content: "ã€€", status: 'ì´ˆê³ ', targetCount: 5000 }]); setActiveProjectId(newId); setExpandedProjects(prev => ({ ...prev, [newId]: true })); setEditingProjectId(newId); };
            const deleteProject = (id, e) => { if (e) e.stopPropagation(); if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { saveHistory(); let newProjects = projects.filter(p => p.id !== id); if (newProjects.length === 0) { const dummyId = generateUUID(); newProjects = [{ id: dummyId, type: 'board', name: 'ìƒˆ í”„ë¡œì íŠ¸', nodes: [], edges: [] }]; handleSelectProject(dummyId); } else if (activeProjectId === id) handleSelectProject(newProjects[0].id); setProjects(newProjects); } };
            const handleProjectRename = (id, newName) => { saveHistory(); setProjects(prev => prev.map(p => p.id === id ? { ...p, name: newName } : p)); setEditingProjectId(null); };
            
            const addNode = (type) => { saveHistory(); const id = generateUUID(); const rect = containerRef.current.getBoundingClientRect(); const center = getCanvasCoords(rect.left + rect.width / 2, rect.top + rect.height / 2); const defaultData = type === 'ì¸ë¬¼' ? { emoji: 'ğŸ‘¤', age: '', gender: 'ë¯¸ì§€ì •', job: '', role: 'ì¡°ì—°', memo: '' } : (type === 'ì‚¬ê±´' ? { emoji: 'ğŸ“®', memo: '' } : { emoji: 'ğŸ’¡', memo: '' }); updateActiveProject(prev => [...prev, { id, x: center.x - CARD_W / 2, y: center.y - CARD_H / 2, label: `ìƒˆ ${type}`, type, data: defaultData }]); setTopNodeId(id); };
            const deleteNode = (id) => { saveHistory(); updateActiveProject(prev => prev.filter(n => n.id !== id), prev => prev.filter(e => e.from !== id && e.to !== id)); if (selectedNodeId === id) setSelectedNodeId(null); };
            
            const handleReorderNodes = (type, newOrderedNodesOfType) => {
                saveHistory();
                updateActiveProject(allNodes => {
                    const safeNodes = allNodes || [];
                    const otherTypes = safeNodes.filter(n => n.type !== type);
                    return [...otherTypes, ...newOrderedNodesOfType];
                });
            };

            const handleGlobalMouseMove = (e) => { if (activeProject.type === 'doc') return; const dx = e.clientX - lastMousePos.current.x, dy = e.clientY - lastMousePos.current.y; if (isPanning) setPan(prev => ({ x: prev.x + dx, y: prev.y + dy })); else if (draggingNodeId) { updateActiveProject(prev => prev.map(n => n.id === draggingNodeId ? { ...n, x: n.x + (dx / scale), y: n.y + (dy / scale) } : n)); } if (tempEdge) { const c = getCanvasCoords(e.clientX, e.clientY); setTempEdge(prev => ({ ...prev, toX: c.x, toY: c.y })); } lastMousePos.current = { x: e.clientX, y: e.clientY }; };
            const handleGlobalMouseUp = (e) => { if (activeProject.type === 'doc') return; if (draggingNodeId) saveHistory(); if (tempEdge && !hasConnectedRef.current) { saveHistory(); const c = getCanvasCoords(e.clientX, e.clientY); const fromNode = findNode(tempEdge.fromId); const newNodeId = generateUUID(); const defaultData = fromNode.type === 'ì¸ë¬¼' ? { emoji: 'ğŸ‘¤', age: '', gender: 'ë¯¸ì§€ì •', job: '', role: 'ì¡°ì—°', memo: '' } : (fromNode.type === 'ì‚¬ê±´' ? { emoji: 'ğŸ“®', memo: '' } : { emoji: 'ğŸ’¡', memo: '' }); updateActiveProject(prev => [...prev, { id: newNodeId, x: c.x - CARD_W/2, y: c.y - CARD_H/2, label: `ìƒˆ ${fromNode.type}`, type: fromNode.type, data: defaultData }], prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: newNodeId, label: 'ê´€ê³„' }]); } hasConnectedRef.current = false; setIsPanning(false); setDraggingNodeId(null); setTempEdge(null); };

            const handleDocInput = (e) => { let val = e.target.value; const pos = e.target.selectionStart; if (val === "") { updateDocContent("ã€€"); return; } if (val.length >= 1 && val[0] !== "ã€€" && !e.nativeEvent.isComposing) { val = "ã€€" + val; updateDocContent(val); setTimeout(() => { if(textareaRef.current) textareaRef.current.setSelectionRange(pos + 1, pos + 1); }, 0); return; } const lastChar = val[pos - 1]; if (lastChar === '#' || lastChar === '@') { const coords = getCaretCoordinates(e.target, pos); const totalWidth = 540; const totalHeight = 350; let finalX = coords.left; let finalY = coords.top + 25; if (finalX + totalWidth > window.innerWidth) finalX = window.innerWidth - totalWidth - 20; if (finalY + totalHeight > window.innerHeight) finalY = coords.top - totalHeight - 10; setMention({ active: true, type: lastChar, search: '', x: finalX, y: finalY, pos, selectedIndex: 0 }); } else if (mention.active) { if (lastChar === ' ' || !lastChar || lastChar === '\n') setMention({ ...mention, active: false }); else setMention({ ...mention, search: val.slice(mention.pos, pos), selectedIndex: 0 }); } updateDocContent(val); };
            const insertMention = (node) => { const text = activeProject.content || ""; const before = text.slice(0, mention.pos - 1); const after = text.slice(mention.pos + mention.search.length); const newText = before + node.label + " " + after; updateDocContent(newText); setMention({ ...mention, active: false }); setTimeout(() => textareaRef.current.focus(), 10); };
            const handleDocKeyDown = (e) => { if (e.nativeEvent.isComposing) return; if (mention.active) { if (e.key === 'ArrowDown') { e.preventDefault(); setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex + 1) % filteredMentionNodes.length })); } else if (e.key === 'ArrowUp') { e.preventDefault(); setMention(prev => ({ ...prev, selectedIndex: (prev.selectedIndex - 1 + filteredMentionNodes.length) % filteredMentionNodes.length })); } else if (e.key === 'Enter') { e.preventDefault(); if (filteredMentionNodes[mention.selectedIndex]) insertMention(filteredMentionNodes[mention.selectedIndex]); } else if (e.key === 'Escape') setMention({ ...mention, active: false }); } else if (e.key === 'Enter') { e.preventDefault(); const start = e.target.selectionStart; const end = e.target.selectionEnd; const value = e.target.value; const newValue = value.substring(0, start) + "\nã€€" + value.substring(end); updateDocContent(newValue); setTimeout(() => { e.target.selectionStart = e.target.selectionEnd = start + 2; }, 0); } };
            const handleDocMouseMove = (e) => { if (mention.active) return; const text = activeProject.content || ""; const pos = e.target.selectionStart; const word = getWordAtPos(text, pos); if (word.length > 0) { const found = allBoardNodes.find(n => n.label === word && (n.type === 'ì¸ë¬¼' || n.type === 'ì‚¬ê±´')); if (found) { setHoverInfo({ visible: true, node: found, x: e.clientX, y: e.clientY }); return; } } setHoverInfo({ ...hoverInfo, visible: false }); };

            const activeNode = useMemo(() => (activeProject.nodes || []).find(n => n.id === selectedNodeId), [activeProject, selectedNodeId]);
            const activeEdge = useMemo(() => (activeProject.edges || []).find(e => e.id === selectedEdgeId), [activeProject, selectedEdgeId]);
            const visibleNodes = useMemo(() => { if (activeProject.type !== 'board') return []; const viewportW = window.innerWidth; const viewportH = window.innerHeight; const buffer = 300; return nodes.filter(node => { const screenX = node.x * scale + pan.x; const screenY = node.y * scale + pan.y; const screenW = CARD_W * scale; const screenH = CARD_H * scale; return (screenX + screenW + buffer > 0 && screenX - buffer < viewportW && screenY + screenH + buffer > 0 && screenY - buffer < viewportH); }); }, [nodes, scale, pan, activeProject.type]);
            const visibleEdges = useMemo(() => { if (activeProject.type !== 'board') return []; const visibleIds = new Set(visibleNodes.map(n => n.id)); return edges.filter(edge => visibleIds.has(edge.from) || visibleIds.has(edge.to)); }, [edges, visibleNodes, activeProject.type]);
            const fitToScreen = useCallback((targetNodes = nodes) => { if (!targetNodes || targetNodes.length === 0) return; const minX = Math.min(...targetNodes.map(n => n.x)); const minY = Math.min(...targetNodes.map(n => n.y)); const maxX = Math.max(...targetNodes.map(n => n.x)) + CARD_W; const maxY = Math.max(...targetNodes.map(n => n.y)) + CARD_H; const viewportW = containerRef.current.clientWidth; const viewportH = containerRef.current.clientHeight; const padding = 100; const scaleX = (viewportW - padding * 2) / (maxX - minX); const scaleY = (viewportH - padding * 2) / (maxY - minY); let newScale = Math.min(Math.max(Math.min(scaleX, scaleY), 0.2), 1.5); setPan({ x: (viewportW / 2) - ((minX + maxX) / 2 * newScale), y: (viewportH / 2) - ((minY + maxY) / 2 * newScale) }); setScale(newScale); }, [nodes]);

            const renderProjectItem = (project) => {
                const isActive = activeProjectId === project.id; const isDoc = project.type === 'doc'; const isExpanded = expandedProjects[project.id];
                const containerClasses = isDoc ? `transition-all duration-200 border-b border-slate-200/50 dark:border-zinc-700/50 last:border-0 ${isActive ? 'bg-white dark:bg-zinc-700' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700/50'}` : `rounded-[3px] mb-2 transition-all duration-300 ${isActive ? 'bg-white shadow-md border-2 border-indigo-200 dark:bg-zinc-700 dark:border-indigo-500' : 'bg-slate-50 border border-transparent dark:bg-zinc-800'}`;
                return (
                    <div key={project.id} className={containerClasses}>
                        <div onClick={() => handleSelectProject(project.id)} onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }} className={`flex items-center px-4 cursor-pointer group relative overflow-hidden ${isDoc ? 'h-[30px] py-0' : 'py-2.5'}`}>
                            {/* [ìˆ˜ì •] ì‚¬ì´ë“œë°” í™œì„± ë¼ì¸: bg-indigo-600 -> dark:bg-indigo-500 (ì±„ë„ ë‚®ì¶¤) */}
                            {isActive && <div className={`absolute left-0 top-0 bottom-0 ${isDoc ? 'w-[3px]' : 'w-1'} bg-indigo-600 dark:bg-indigo-500`} />}
                            <div className="flex items-center gap-2.5 min-w-0 flex-1 z-10">
                                <span onClick={(e) => !isDoc && toggleProjectFolder(project.id, e)} className={`${isDoc ? 'text-sm opacity-50' : 'text-base'} shrink-0 dark:text-zinc-300`}>{isDoc ? 'ğŸ“„' : (isExpanded ? 'ğŸ“‚' : 'ğŸ“')}</span>
                                {editingProjectId === project.id ? ( <input autoFocus className="w-full bg-white border border-indigo-400 rounded-[3px] px-1 text-[12px] font-bold outline-none dark:bg-zinc-700 dark:text-white" defaultValue={project.name} onBlur={(e) => handleProjectRename(project.id, e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleProjectRename(project.id, e.target.value)} /> ) : (
                                    <div className="flex items-center min-w-0 flex-1 justify-between">
                                        <span className={`text-[12px] truncate flex-1 mr-2 ${isActive ? 'text-slate-900 font-black dark:text-white' : 'text-slate-500 font-semibold dark:text-zinc-400'}`}>{project.name}</span>
                                        <div className="flex items-center shrink-0">
                                            {isDoc && <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] ${getStatusBadgeStyle(project.status || 'ì´ˆê³ ')}`}>{project.status || 'ì´ˆê³ '}</span>}
                                            <button onClick={(e) => deleteProject(project.id, e)} className="w-0 opacity-0 group-hover:w-5 group-hover:opacity-100 group-hover:ml-1.5 overflow-hidden flex items-center justify-center text-slate-400 hover:text-red-500 transition-all duration-300 scale-90 dark:text-zinc-500 dark:hover:text-red-400"><IconTrash className="w-3 h-3" /></button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        {!isDoc && (
                            <AnimatePresence>
                                {(isExpanded && project.type === 'board') && (
                                    <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }} className="overflow-hidden bg-slate-50/30 rounded-b-[3px] border-slate-100 dark:bg-zinc-800/30 dark:border-zinc-700">
                                            <div className="pb-3 px-3 space-y-3 pt-2">
                                                {['ì¸ë¬¼', 'ì‚¬ê±´', 'ë©”ëª¨'].map(type => {
                                                    const filtered = (project.nodes || []).filter(n => n.type === type); if (filtered.length === 0) return null;
                                                    return (
                                                        <div key={type} className="pl-1">
                                                            <div className="text-[9px] font-black text-slate-400 mb-1.5 px-2 uppercase tracking-tighter flex items-center gap-2"><span className="w-1 h-1 bg-slate-300 rounded-[3px] dark:bg-zinc-600"></span>{type}</div>
                                                            <Reorder.Group axis="y" values={filtered} onReorder={(newOrder) => handleReorderNodes(type, newOrder)} className="space-y-1">
                                                                {filtered.map(n => (
                                                                    <Reorder.Item key={n.id} value={n} onClick={(e) => { e.stopPropagation(); handleSelectProject(project.id); setPan({ x: -(n.x + CARD_W/2)*scale + (window.innerWidth - 320)/2, y: -(n.y + CARD_H/2)*scale + window.innerHeight/2 }); }} className={`py-1.5 px-3 bg-white hover:border-indigo-300 border border-slate-200 rounded-[3px] flex items-center justify-between gap-2 cursor-pointer shadow-sm transition-all border-l-4 dark:bg-zinc-700 dark:border-zinc-600 ${getSidebarItemAccent(n)}`}>
                                                                            <div className="flex items-center gap-2 min-w-0"><span className="text-xs shrink-0">{n.data.emoji}</span><span className="text-[11px] font-bold text-slate-600 truncate dark:text-zinc-300">{n.label}</span></div>
                                                                            {n.type === 'ì¸ë¬¼' && <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role)}`}>{n.data.role}</span>}
                                                                    </Reorder.Item>
                                                                ))}
                                                            </Reorder.Group>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        )}
                    </div>
                );
            };

            return (
                <div className={`flex w-screen h-screen no-drag ${(activeProject.type === 'board') ? 'grid-background' : 'dot-background'} ${(isPanning || draggingNodeId) ? 'is-dragging' : ''}`} onMouseMove={handleGlobalMouseMove} onMouseUp={handleGlobalMouseUp} onContextMenu={e => e.preventDefault()}>
                    <aside className="w-80 h-full bg-slate-100 border-r border-slate-200 z-[100] flex flex-col shadow-2xl overflow-hidden dark:bg-darkpanel dark:border-darkborder transition-colors">
                        <div className="px-5 pt-5 pb-4 bg-white border-b border-slate-200 dark:bg-darkpanel dark:border-darkborder">
                            <div className="flex items-center justify-between mb-2">
                                <button onClick={onExit} className="flex items-center gap-1 text-[10px] font-bold text-slate-500 hover:text-indigo-600 transition-colors uppercase tracking-widest dark:text-zinc-400 dark:hover:text-indigo-400"><IconBack className="w-3 h-3" /> ë‚´ ì„œì¬ë¡œ ëŒì•„ê°€ê¸°</button>
                            </div>
                            <div className="text-left mt-8">
                                {isEditingTitle ? ( <input ref={titleInputRef} className="w-full text-[25px] font-black text-slate-900 tracking-tighter leading-none bg-slate-100 outline-none border-b-2 border-indigo-500 dark:bg-darkpanel dark:text-white" value={currentBook.title} onChange={(e) => onUpdateBook({...currentBook, title: e.target.value})} onBlur={() => setIsEditingTitle(false)} onKeyDown={(e) => e.key === 'Enter' && setIsEditingTitle(false)} /> ) : ( <h1 onDoubleClick={() => setIsEditingTitle(true)} className="text-[25px] font-black text-slate-900 tracking-tighter leading-none cursor-pointer hover:text-indigo-600 transition-colors dark:text-white" title="ë”ë¸”í´ë¦­í•˜ì—¬ ì œëª© ìˆ˜ì •">{currentBook.title}</h1> )}
                                <span className="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-widest block dark:text-zinc-500">Novel Project</span>
                            </div>
                        </div>
                        <div className="p-3 bg-white/50 border-b border-slate-200 flex gap-2 dark:bg-darkpanel/50 dark:border-darkborder">
                            {/* [ìˆ˜ì •] ë²„íŠ¼ ìƒ‰ìƒ: bg-indigo-600 -> dark:bg-indigo-700 */}
                            <button onClick={createNewProject} className="flex-1 py-2.5 bg-indigo-600 text-white text-[10px] font-black rounded-[3px] hover:bg-indigo-700 transition-all shadow-md tracking-widest dark:bg-indigo-700 dark:hover:bg-indigo-600">+ ìƒˆ ë³´ë“œ</button>
                            <button onClick={createNewDoc} className="flex-1 py-2.5 bg-slate-800 text-white text-[10px] font-black rounded-[3px] hover:bg-slate-900 transition-all shadow-md tracking-widest dark:bg-zinc-700 dark:hover:bg-zinc-600">+ ìƒˆ ë¬¸ì„œ</button>
                        </div>
                        <div className="flex-1 overflow-y-auto px-3 pt-4 custom-scroll pb-10">
                            <div className="mb-8">
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2 flex items-center gap-2"><span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> ì•„ì´ë””ì–´ ë³´ë“œ</div>
                                <div className="space-y-3">{projects.filter(p => p.type === 'board').map(project => renderProjectItem(project))}</div>
                            </div>
                            <div className="px-2 mb-4"><hr className="border-t border-slate-200 dark:border-zinc-700" /></div>
                            <div>
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2 flex items-center gap-2"><span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> ë¬¸ì„œí•¨</div>
                                <div className="space-y-0 border-t border-slate-200/50 dark:border-zinc-700/50">{projects.filter(p => p.type === 'doc').map(project => renderProjectItem(project))}</div>
                            </div>
                        </div>
                    </aside>
                    <main className={`flex-1 relative overflow-hidden ${activeProject.type === 'board' ? (isPanning ? 'cursor-grabbing' : draggingNodeId ? 'cursor-grabbing' : 'cursor-grab') : 'dot-background'}`} ref={containerRef} onMouseDown={(e) => { if(activeProject.type === 'board') { lastMousePos.current = { x: e.clientX, y: e.clientY }; if (e.button === 0) setIsPanning(true); } }}>
                        {activeProject.type === 'board' ? (
                            <>
                                <div className="absolute top-6 left-6 z-[80] flex items-center gap-3">
                                    <div className="h-10 px-5 bg-white shadow-lg border border-slate-200 rounded-[3px] flex items-center gap-2 dark:bg-darkpanel dark:border-darkborder dark:text-white"><span className="w-2 h-2 bg-indigo-500 rounded-[3px] animate-pulse"></span><span className="text-xs font-black text-slate-800 uppercase tracking-widest dark:text-zinc-200">{activeProject.name}</span></div>
                                    <div className="flex items-center gap-1 p-1 bg-white rounded-[3px] shadow-lg border border-slate-200 h-10 dark:bg-darkpanel dark:border-darkborder">
                                        <button onClick={() => addNode('ì¸ë¬¼')} className="flex items-center gap-2 h-full px-4 rounded-[3px] hover:bg-indigo-50 text-indigo-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-indigo-400"><div className="w-5 h-5 flex items-center justify-center bg-indigo-500 rounded-[3px] text-white group-hover:scale-110 transition-transform"><IconPlus className="w-3 h-3" /></div><span className="text-[11px] font-black">ì¸ë¬¼</span></button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('ì‚¬ê±´')} className="flex items-center gap-2 h-full px-4 rounded-[3px] hover:bg-rose-50 text-rose-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-rose-400"><div className="w-5 h-5 flex items-center justify-center bg-rose-500 rounded-[3px] text-white group-hover:scale-110 transition-transform"><IconPlus className="w-3 h-3" /></div><span className="text-[11px] font-black">ì‚¬ê±´</span></button>
                                        <div className="w-px h-4 bg-slate-200 mx-0.5 dark:bg-zinc-600"></div>
                                        <button onClick={() => addNode('ë©”ëª¨')} className="flex items-center gap-2 h-full px-4 rounded-[3px] hover:bg-amber-50 text-amber-600 transition-all active:scale-95 group dark:hover:bg-zinc-700 dark:text-amber-400"><div className="w-5 h-5 flex items-center justify-center bg-amber-500 rounded-[3px] text-white group-hover:scale-110 transition-transform"><IconPlus className="w-3 h-3" /></div><span className="text-[11px] font-black">ë©”ëª¨</span></button>
                                    </div>
                                </div>
                                <div className="absolute bottom-8 right-8 z-[100] flex flex-col bg-white shadow-2xl border border-slate-200 rounded-[3px] overflow-hidden text-slate-600 font-bold dark:bg-darkpanel dark:border-darkborder dark:text-zinc-300">
                                    <button onClick={() => fitToScreen()} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 border-b border-slate-100 dark:hover:bg-zinc-700 dark:border-zinc-700"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" className="scale-75"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></svg></button>
                                    <button onClick={() => setScale(prev => Math.min(prev + 0.1, 3))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700">+</button>
                                    <div className="py-2 text-[9px] font-black text-slate-400 border-y border-slate-50 text-center bg-slate-50/50 dark:bg-zinc-800/50 dark:border-zinc-700">{Math.round(scale * 100)}%</div>
                                    <button onClick={() => setScale(prev => Math.max(prev - 0.1, 0.1))} className="w-11 h-11 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-zinc-700">-</button>
                                </div>
                                <div className="zoom-container w-full h-full" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }}>
                                    <svg className="canvas-svg">
                                        <defs><marker id="arrow-event" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 L 2 5 z" fill="#ef4444" /></marker></defs>
                                        {visibleEdges.map(edge => {
                                            const from = findNode(edge.from); const to = findNode(edge.to); if (!from || !to) return null;
                                            let x1 = from.x + CARD_W/2, y1 = from.y + CARD_H/2, x2 = to.x + CARD_W/2, y2 = to.y + CARD_H/2;
                                            const isEventToEvent = from.type === 'ì‚¬ê±´' && to.type === 'ì‚¬ê±´'; 
                                            const isIdeaInvolved = from.type === 'ë©”ëª¨' || to.type === 'ë©”ëª¨';
                                            const isPersonToEvent = (from.type === 'ì¸ë¬¼' && to.type === 'ì‚¬ê±´') || (from.type === 'ì‚¬ê±´' && to.type === 'ì¸ë¬¼');
                                            const isPersonToPerson = from.type === 'ì¸ë¬¼' && to.type === 'ì¸ë¬¼';
                                            let pathData = isEventToEvent ? `M ${x1} ${y1} L ${getEdgeTargetPos(from, to, 12).x} ${getEdgeTargetPos(from, to, 12).y}` : getBezierPath(x1, y1, x2, y2);
                                            let edgeColor = isIdeaInvolved ? "#facc15" : isPersonToEvent ? "#3b82f6" : isPersonToPerson ? "#93c5fd" : "#ef4444";
                                            const strokeWidth = edge.width || (isPersonToEvent ? 12 : isEventToEvent ? 4 : 2);
                                            const strokeDash = edge.style ? getStrokeDashArray(edge.style) : (isIdeaInvolved ? "8, 6" : "");
                                            const labelWidth = Math.max(70, (edge.label || "").length * 10 + 20);
                                            return (
                                                <g key={edge.id}>
                                                    <path d={pathData} className="edge-hitbox" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }} onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); saveHistory(); updateActiveProject(null, prev => prev.filter(ev => ev.id !== edge.id)); }} />
                                                    <path d={pathData} stroke={edgeColor} strokeWidth={strokeWidth} markerEnd={isEventToEvent ? "url(#arrow-event)" : ""} strokeDasharray={strokeDash} className="edge-path opacity-80" />
                                                    {isPersonToPerson && (
                                                        <g className="cursor-pointer pointer-events-auto" onDoubleClick={(e) => { e.stopPropagation(); setSelectedEdgeId(edge.id); }}>
                                                            <rect x={(x1+x2)/2 - labelWidth/2} y={(y1+y2)/2-12} width={labelWidth} height="24" rx="3" fill="white" stroke={edgeColor} strokeWidth="1.5" className="dark:fill-zinc-800" /><text x={(x1+x2)/2} y={(y1+y2)/2+4} textAnchor="middle" fontSize="11" fontWeight="900" fill="#334155" className="dark:fill-zinc-200">{edge.label}</text>
                                                        </g>
                                                    )}
                                                </g>
                                            );
                                        })}
                                        {tempEdge && <line x1={findNode(tempEdge.fromId).x + CARD_W/2} y1={findNode(tempEdge.fromId).y + CARD_H/2} x2={tempEdge.toX} y2={tempEdge.toY} stroke="#94a3b8" strokeWidth="2" strokeDasharray="4,4" />}
                                    </svg>
                                    {visibleNodes.map(node => (
                                        <NodeCard key={node.id} node={node} isTop={topNodeId === node.id} onNodeDragStart={(e, id) => { e.stopPropagation(); setDraggingNodeId(id); setTopNodeId(id); }} onMouseDown={(e, id) => { if (e.button === 2) { const c = getCanvasCoords(e.clientX, e.clientY); setTempEdge({ fromId: id, toX: c.x, toY: c.y }); } }} onMouseUp={(e, id) => { if (tempEdge && id !== tempEdge.fromId) { saveHistory(); hasConnectedRef.current = true; updateActiveProject(null, prev => [...prev, { id: generateUUID(), from: tempEdge.fromId, to: id, label: 'ê´€ê³„' }]); } }} onDoubleClick={setSelectedNodeId} onDelete={deleteNode} />
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div className="w-full h-full overflow-y-auto custom-scroll px-10">
                                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="editor-paper relative">
                                    <div className="editor-title-container">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">DOC TITLE</span>
                                            <div className="flex bg-slate-100 p-1 rounded-[3px] gap-1 dark:bg-zinc-700">
                                                {['ì´ˆê³ ', 'ìˆ˜ì •', 'ì™„ë£Œ'].map(status => (
                                                    <button key={status} onClick={() => setProjects(prev => prev.map(p => p.id === activeProject.id ? {...p, status} : p))} className={`px-3 py-1 text-[10px] font-black rounded-[3px] transition-all ${(activeProject.status || 'ì´ˆê³ ') === status ? (status === 'ì™„ë£Œ' ? 'bg-emerald-600 text-white' : 'bg-white shadow-sm text-indigo-600 dark:bg-zinc-600 dark:text-indigo-300') : 'text-slate-400 hover:text-slate-600 dark:text-zinc-500 dark:hover:text-zinc-300'}`}>{status}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <input className="w-full text-3xl font-black text-slate-800 outline-none border-b-2 border-slate-100 focus:border-indigo-400 pb-2 transition-all dark:text-zinc-200 dark:border-zinc-700 dark:focus:border-indigo-500 dark:bg-transparent" value={activeProject.name} onChange={(e) => handleProjectRename(activeProject.id, e.target.value)} placeholder="ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                                    </div>
                                    <textarea ref={textareaRef} className="editor-textarea custom-scroll" value={activeProject.content || ""} onChange={handleDocInput} onKeyDown={handleDocKeyDown} onMouseMove={handleDocMouseMove} onMouseOut={() => setHoverInfo({ ...hoverInfo, visible: false })} placeholder="ì´ê³³ì— ì›¹ì†Œì„¤ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”... (@ì¸ë¬¼ ë˜ëŠ” #ì‚¬ê±´ ì…ë ¥)" />
                                    <AnimatePresence>
                                        {mention.active && (
                                            <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0 }} className="mention-list flex" style={{ left: mention.x, top: mention.y }}>
                                                <div className="w-[240px] flex flex-col bg-white rounded-l-[3px] overflow-hidden border-r dark:bg-zinc-800 dark:border-zinc-700">
                                                    <div className="bg-slate-900 px-3 py-1.5 text-[10px] font-black text-white uppercase tracking-widest border-b dark:bg-zinc-950 dark:border-zinc-700">{mention.type === '@' ? 'ì¸ë¬¼' : 'ì‚¬ê±´'} ë¦¬ìŠ¤íŠ¸</div>
                                                    <div className="flex-1 max-h-[350px] overflow-y-auto custom-scroll">
                                                        {filteredMentionNodes.map((n, idx) => (
                                                            <div key={n.id} onMouseEnter={() => setMention({...mention, selectedIndex: idx})} onClick={() => insertMention(n)} className={`px-4 py-3 hover:bg-indigo-50 cursor-pointer flex items-center justify-between gap-3 border-b border-slate-50 last:border-0 transition-all dark:border-zinc-700 dark:hover:bg-zinc-700 ${mention.selectedIndex === idx ? 'mention-item-active' : ''}`}>
                                                                <div className="flex items-center gap-3 min-w-0 flex-1">
                                                                    <span className="text-sm shrink-0">{n.data.emoji}</span><span className="text-[13px] font-bold text-slate-700 truncate dark:text-zinc-300">{n.label}</span>
                                                                    <span className="text-[9px] text-slate-400 font-medium px-1.5 py-0.5 bg-slate-100 rounded-[3px] truncate max-w-[80px] dark:bg-zinc-700 dark:text-zinc-500">{n.projectName}</span>
                                                                </div>
                                                                <span className={`text-[8px] font-black px-1.5 py-0.5 rounded-[3px] shrink-0 ${getRoleBadgeStyle(n.data.role || n.type)}`}>{n.data.role || n.type}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                {filteredMentionNodes[mention.selectedIndex] && (
                                                    <motion.div initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} className="w-[320px] p-6 bg-slate-50 flex flex-col rounded-r-[3px] shadow-inner border-l border-slate-200 dark:bg-zinc-800 dark:border-zinc-700">
                                                        <div className="text-[10px] font-black text-indigo-500 uppercase mb-4 tracking-widest flex items-center gap-2"><span className="w-2 h-2 bg-indigo-500 rounded-full"></span> Detail Information</div>
                                                        <div className="flex items-center gap-4 mb-6"><span className="text-4xl drop-shadow-md bg-white p-2 rounded-[3px] border border-slate-100 dark:bg-zinc-700 dark:border-zinc-600">{filteredMentionNodes[mention.selectedIndex].data.emoji}</span><div className="flex flex-col min-w-0"><span className="text-[18px] font-black text-slate-800 leading-tight truncate dark:text-zinc-200">{filteredMentionNodes[mention.selectedIndex].label}</span><span className={`text-[10px] font-black px-2 py-0.5 rounded-[3px] mt-1 w-fit ${getRoleBadgeStyle(filteredMentionNodes[mention.selectedIndex].data.role)}`}>{filteredMentionNodes[mention.selectedIndex].data.role || filteredMentionNodes[mention.selectedIndex].type}</span></div></div>
                                                        {filteredMentionNodes[mention.selectedIndex].type === 'ì¸ë¬¼' && (
                                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                                <div className="bg-white p-2 rounded-[3px] border border-slate-200 shadow-sm dark:bg-zinc-700 dark:border-zinc-600">
                                                                    <span className="text-[8px] font-bold text-slate-400 block uppercase mb-0.5">ì„±ë³„</span>
                                                                    <span className="text-[11px] font-black text-slate-700 dark:text-zinc-200">{filteredMentionNodes[mention.selectedIndex].data.gender || '-'}</span>
                                                                </div>
                                                                <div className="bg-white p-2 rounded-[3px] border border-slate-200 shadow-sm dark:bg-zinc-700 dark:border-zinc-600">
                                                                    <span className="text-[8px] font-bold text-slate-400 block uppercase mb-0.5">ë‚˜ì´</span>
                                                                    <span className="text-[11px] font-black text-slate-700 dark:text-zinc-200">{filteredMentionNodes[mention.selectedIndex].data.age ? `${filteredMentionNodes[mention.selectedIndex].data.age}ì„¸` : '-'}</span>
                                                                </div>
                                                                <div className="bg-white p-2 rounded-[3px] border border-slate-200 shadow-sm col-span-2 dark:bg-zinc-700 dark:border-zinc-600">
                                                                    <span className="text-[8px] font-bold text-slate-400 block uppercase mb-0.5">ì§ì—… / ì¢…ì¡±</span>
                                                                    <span className="text-[11px] font-black text-slate-700 dark:text-zinc-200">{filteredMentionNodes[mention.selectedIndex].data.job || 'ê¸°ë¡ ì—†ìŒ'}</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div className="flex-1 flex flex-col min-h-0"><span className="text-[8px] font-bold text-slate-400 mb-1 ml-1 uppercase">Description / Memo</span><div className="flex-1 text-[12px] font-medium text-slate-600 bg-white p-4 border border-slate-200 rounded-[3px] shadow-sm overflow-y-auto custom-scroll dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-300">{filteredMentionNodes[mention.selectedIndex].data.memo || "ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}</div></div>
                                                    </motion.div>
                                                )}
                                            </motion.div>
                                        )}
                                    </AnimatePresence>
                                    <div className="px-[40px] pb-10">
                                        <div className="mt-8 pt-4 border-t border-slate-100 flex flex-col gap-3 dark:border-zinc-700">
                                            <div className="flex justify-between items-end text-[10px] font-black tracking-tighter">
                                                <div className="flex gap-4 items-center">
                                                    <div className="flex flex-col gap-1"><span className="text-slate-400 uppercase">Statistics</span><div className="flex gap-3 text-slate-600 dark:text-zinc-400"><span>ê³µë°± í¬í•¨: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").length.toLocaleString()}</b>ì</span><span>ê³µë°± ì œì™¸: <b className="text-slate-900 dark:text-zinc-200">{(activeProject.content || "").replace(/\s+/g, '').length.toLocaleString()}</b>ì</span></div></div>
                                                    <div className="w-px h-6 bg-slate-100 mx-2 dark:bg-zinc-700"></div>
                                                    <div className="flex flex-col gap-1"><span className="text-indigo-400 uppercase">Achievement</span><span className="text-[14px] text-indigo-600 italic dark:text-indigo-400">{Math.min(Math.round(((activeProject.content || "").length / (activeProject.targetCount || 5000)) * 100), 100)}%</span></div>
                                                </div>
                                                <div className="flex flex-col items-end gap-1"><span className="text-slate-400 uppercase">Target Goal</span><div className="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-[3px] border border-slate-100 dark:bg-zinc-700 dark:border-zinc-600"><input type="number" className="w-16 bg-transparent outline-none text-right text-slate-700 font-bold dark:text-zinc-300" value={activeProject.targetCount || 5000} onChange={(e) => { const val = parseInt(e.target.value) || 0; setProjects(prev => prev.map(p => p.id === activeProject.id ? {...p, targetCount: val} : p)); }} /><span className="text-slate-400">ì ëª©í‘œ</span></div></div>
                                            </div>
                                            <div className="w-full h-1.5 bg-slate-100 rounded-[3px] overflow-hidden dark:bg-zinc-700"><motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(((activeProject.content || "").length / (activeProject.targetCount || 5000)) * 100, 100)}%`, backgroundColor: (activeProject.content || "").length >= (activeProject.targetCount || 5000) ? "#10b981" : "#4f46e5" }} className="h-full transition-all duration-500 ease-out rounded-[3px]" /></div>
                                        </div>
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </main>
                    <AnimatePresence>
                        {(activeNode || activeEdge) && (
                            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                                {activeNode && (
                                    <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-8 rounded-[3px] shadow-2xl w-[600px] relative max-h-[90vh] overflow-y-auto custom-scroll dark:bg-darkpanel">
                                            <button onClick={() => setSelectedNodeId(null)} className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-[3px] transition-colors dark:hover:bg-zinc-700 dark:hover:text-zinc-200"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                                            <div className="mb-6"><h2 className="text-sm font-black text-indigo-500 uppercase tracking-widest mb-1">{activeNode.type} ì‹œíŠ¸ í¸ì§‘</h2><div className="h-1 w-12 bg-indigo-500"></div></div>
                                            <div className="space-y-6">
                                                {activeNode.type === 'ì¸ë¬¼' ? ( 
                                                    <>
                                                        <div className="flex items-end gap-3">
                                                            <div className="flex-[0.5]"><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì—­í• </label><select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-sm border border-slate-200 outline-none h-[40px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.role} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, role: e.target.value}} : n))}><option value="ì£¼ì¸ê³µ">ğŸ˜ ì£¼ì¸ê³µ</option><option value="ì¡°ë ¥ì">ğŸ˜ ì¡°ë ¥ì</option><option value="ì ëŒ€ì">ğŸ˜¡ ì ëŒ€ì</option><option value="ì¡°ì—°">ğŸ¤“ ì¡°ì—°</option><option value="ì—‘ìŠ¤íŠ¸ë¼">ğŸ¥¸ ì—‘ìŠ¤íŠ¸ë¼</option></select></div>
                                                            <div className="flex-[0.3]"><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ëª¨ì§€</label><input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] text-center text-xl border border-slate-200 outline-none h-[40px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} /></div>
                                                            <div className="flex-[1.5]"><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì´ë¦„</label><input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-black text-lg border border-slate-200 outline-none h-[40px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} /></div>
                                                        </div>
                                                        <div className="flex items-end gap-3">
                                                            <div className="flex-[0.5]">
                                                                <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì„±ë³„</label>
                                                                <select className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 h-[40px] outline-none dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.gender} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, gender: e.target.value}} : n))}>
                                                                    <option value="ë¯¸ì§€ì •">ë¯¸ì§€ì •</option>
                                                                    <option value="ë‚¨ì">ë‚¨ì</option>
                                                                    <option value="ì—¬ì">ì—¬ì</option>
                                                                </select>
                                                            </div>
                                                            <div className="flex-[0.3]">
                                                                <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë‚˜ì´</label>
                                                                <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 h-[40px] outline-none dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.age} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, age: e.target.value}} : n))} />
                                                            </div>
                                                            <div className="flex-1">
                                                                <label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ì§ì—…/ì¢…ì¡±</label>
                                                                <input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-sm border border-slate-200 h-[40px] outline-none dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.job} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, job: e.target.value}} : n))} />
                                                            </div>
                                                        </div>
                                                    </>
                                                ) : ( <div className="flex items-end gap-3"><div className="w-20 shrink-0"><label className="text-[10px] font-bold text-slate-400 ml-1">ì´ëª¨ì§€</label><input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] text-center text-xl border border-slate-200 h-[40px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.data.emoji} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, emoji: e.target.value}} : n))} /></div><div className="flex-1"><label className="text-[10px] font-bold text-slate-400 ml-1">ì´ë¦„/ë¼ë²¨</label><input className="w-full mt-1 px-3 py-2 bg-slate-50 rounded-[3px] font-bold text-lg border border-slate-200 h-[40px] dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeNode.label} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, label: e.target.value} : n))} /></div></div> )}
                                                <div className="flex flex-col gap-1"><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">ë©”ëª¨ ë° ì„¸ë¶€ ì„¤ì •</label><textarea className="w-full h-48 p-4 bg-slate-50 border border-slate-200 text-sm outline-none focus:bg-white transition-all resize-none leading-relaxed dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700" value={activeNode.data.memo} onChange={e => updateActiveProject(prev => prev.map(n => n.id === activeNode.id ? {...n, data: {...n.data, memo: e.target.value}} : n))} /></div>
                                            </div>
                                            <div className="flex mt-8 gap-3"><button onClick={() => { saveHistory(); setSelectedNodeId(null); showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"); }} className="flex-1 py-4 bg-slate-900 text-white font-black hover:bg-indigo-600 transition-all uppercase text-xs tracking-widest rounded-[3px] shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500">ì„¤ì • ì €ì¥í•˜ê¸°</button></div>
                                    </motion.div>
                                )}
                                {activeEdge && (
                                    <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="bg-white p-6 rounded-[3px] w-[340px] shadow-2xl border border-slate-200 relative flex flex-col gap-4 dark:bg-darkpanel dark:border-zinc-700">
                                            <div className="flex items-center justify-between border-b border-slate-100 pb-3 dark:border-zinc-700"><div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">ê´€ê³„ í¸ì§‘</div><button onClick={() => setSelectedEdgeId(null)} className="text-slate-400 hover:text-slate-600 dark:hover:text-zinc-200"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div><label className="text-[10px] font-bold text-slate-400 ml-1 block mb-1">ë¼ë²¨</label><input className="w-full p-2.5 bg-slate-50 border border-slate-200 font-bold text-sm text-slate-700 outline-none rounded-[3px] focus:bg-white focus:border-indigo-300 transition-all dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:focus:bg-zinc-700" value={activeEdge.label} onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, label: e.target.value} : ev))} placeholder="ê´€ê³„ ì´ë¦„ (ì˜ˆ: ì¹œêµ¬, ì )" autoFocus /></div>
                                            <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-400 ml-1 block mb-1">ì„  ì¢…ë¥˜</label><select className="w-full p-2 bg-slate-50 border border-slate-200 text-xs font-bold text-slate-700 rounded-[3px] outline-none dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" value={activeEdge.style || 'solid'} onChange={e => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, style: e.target.value} : ev))}><option value="solid">ì§ì„  (Solid)</option><option value="dashed">ì ì„  (Dashed)</option></select></div><div><label className="text-[10px] font-bold text-slate-400 ml-1 block mb-1">ì„  ë‘ê»˜</label><div className="flex bg-slate-50 rounded-[3px] p-1 border border-slate-200 dark:bg-zinc-800 dark:border-zinc-700">{[2, 4, 6].map(w => ( <button key={w} onClick={() => updateActiveProject(null, prev => prev.map(ev => ev.id === activeEdge.id ? {...ev, width: w} : ev))} className={`flex-1 h-6 flex items-center justify-center rounded-[2px] transition-all ${(activeEdge.width || 2) === w ? 'bg-white shadow-sm border border-slate-100 dark:bg-zinc-600 dark:border-zinc-500' : 'hover:bg-slate-200/50 dark:hover:bg-zinc-700'}`}><div className="bg-slate-800 rounded-full dark:bg-zinc-300" style={{ width: w*2, height: w*2 }}></div></button> ))}</div></div></div>
                                            <button onClick={() => { saveHistory(); setSelectedEdgeId(null); showToast("ê´€ê³„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"); }} className="w-full py-3 bg-slate-900 text-white font-black text-xs rounded-[3px] hover:bg-indigo-600 transition-all mt-2 shadow-lg dark:bg-indigo-600 dark:hover:bg-indigo-500">ì €ì¥</button>
                                    </motion.div>
                                )}
                            </div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const CreateBookModal = ({ onClose, onCreate }) => { const [title, setTitle] = useState('ìƒˆ ì‘í’ˆ'); const [selectedColor, setSelectedColor] = useState(BOOK_COLORS[0]); const handleSubmit = () => { if (!title.trim()) { alert("ì‘í’ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } onCreate(title, selectedColor); }; const handleKeyDown = (e) => { if (e.key === 'Enter') handleSubmit(); if (e.key === 'Escape') onClose(); }; return ( <div className="fixed inset-0 z-[999] flex items-center justify-center bg-black/60 backdrop-blur-sm" onClick={onClose}> <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} className="bg-white dark:bg-darkpanel p-8 rounded-[3px] shadow-2xl w-[400px] border border-slate-200 dark:border-zinc-700" onClick={e => e.stopPropagation()}> <h2 className="text-lg font-black text-slate-800 dark:text-zinc-100 mb-6">ìƒˆ ì‘í’ˆ ë§Œë“¤ê¸°</h2> <div className="mb-6"> <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-2 uppercase tracking-wide">ì‘í’ˆ ì œëª©</label> <input autoFocus type="text" value={title} onChange={(e) => setTitle(e.target.value)} onKeyDown={handleKeyDown} className="w-full p-3 bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-[3px] text-slate-900 dark:text-zinc-100 font-bold focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ì‘í’ˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" /> </div> <div className="mb-8"> <label className="block text-xs font-bold text-slate-500 dark:text-zinc-400 mb-3 uppercase tracking-wide">í‘œì§€ ìƒ‰ìƒ</label> <div className="flex flex-wrap gap-2"> {BOOK_COLORS.map(color => ( <button key={color} onClick={() => setSelectedColor(color)} className={`w-8 h-8 rounded-full shadow-sm transition-transform hover:scale-110 flex items-center justify-center ${selectedColor === color ? 'ring-2 ring-offset-2 ring-indigo-500 dark:ring-offset-darkpanel' : ''}`} style={{ backgroundColor: color }}> {selectedColor === color && <svg className="w-4 h-4 text-white/80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>} </button> ))} </div> </div> <div className="flex gap-2"> <button onClick={onClose} className="flex-1 py-3 text-xs font-bold text-slate-500 dark:text-zinc-400 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-[3px] transition-colors">ì·¨ì†Œ</button> <button onClick={handleSubmit} className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black rounded-[3px] shadow-md transition-colors dark:bg-indigo-700 dark:hover:bg-indigo-600">ë§Œë“¤ê¸°</button> </div> </motion.div> </div> ); };
        const Library = ({ books, onSelectBook, onCreateBook, onDeleteBook, onUpdateBook, onImport, isDarkMode, toggleDarkMode }) => { const fileInputRef = useRef(null); const [isCreateModalOpen, setIsCreateModalOpen] = useState(false); const handleExport = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(books)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "sagak_library.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }; const handleFileChange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedBooks = JSON.parse(e.target.result); if (Array.isArray(importedBooks)) onImport(importedBooks); else alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤."); } catch (err) { alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } }; reader.readAsText(file); }; const [autoEditId, setAutoEditId] = useState(null); const handleConfirmCreate = (title, color) => { const newId = generateUUID(); const defaultProjectId = generateUUID(); const newBook = { id: newId, title: title, color: color, projects: [{ id: defaultProjectId, type: 'board', name: 'ì•„ì´ë””ì–´ ë³´ë“œ', nodes: [], edges: [] }], activeProjectId: defaultProjectId, autoEdit: false }; onCreateBook(newBook); setIsCreateModalOpen(false); }; const clearAutoEdit = useCallback((id) => { onUpdateBook({ ...books.find(b => b.id === id), autoEdit: false }); }, [books, onUpdateBook]); return ( <div className="w-screen h-screen flex flex-col bg-[#f1f5f9] dark:bg-darkbg transition-colors duration-300"> {isCreateModalOpen && ( <CreateBookModal onClose={() => setIsCreateModalOpen(false)} onCreate={handleConfirmCreate} /> )} <header className="h-16 px-8 flex items-center justify-between bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 dark:bg-darkpanel/80 dark:border-darkborder"> <div className="flex items-center gap-2"> <div className="w-6 h-6 bg-slate-900 rounded-[3px] dark:bg-zinc-100"></div> <span className="text-lg font-black tracking-tight text-slate-900 dark:text-zinc-100">SAGAK STUDIO</span> </div> <div className="flex items-center gap-3"> <button onClick={toggleDarkMode} className="p-2 text-slate-400 hover:text-slate-800 transition-colors bg-slate-100 rounded-[3px] hover:bg-slate-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:text-zinc-100 dark:hover:bg-zinc-700" title="ë‹¤í¬ ëª¨ë“œ í† ê¸€"> {isDarkMode ? <IconSun className="w-4 h-4" /> : <IconMoon className="w-4 h-4" />} </button> <div className="h-4 w-px bg-slate-300 mx-1 dark:bg-zinc-700"></div> <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-2 py-2 bg-white border border-slate-200 text-slate-600 text-[11px] font-bold rounded-[3px] hover:bg-slate-50 transition-all shadow-sm dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-700"><IconUpload className="w-3 h-3" /></button> <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" /> <button onClick={handleExport} className="flex items-center gap-2 px-2 py-2 bg-slate-900 text-white text-[11px] font-bold rounded-[3px] hover:bg-slate-800 transition-all shadow-sm dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200"><IconSave className="w-3 h-3" /></button> </div> </header> <div className="flex-1 overflow-y-auto custom-scroll p-10"> <div className="max-w-7xl mx-auto"> <div className="mb-8 flex items-end justify-between"> <div> <h2 className="text-3xl font-black text-slate-900 mb-2 dark:text-zinc-100">ë‚´ ì„œì¬</h2> <p className="text-sm text-slate-500 font-medium dark:text-zinc-400">ì´ {books.length}ê°œì˜ ì‘í’ˆì´ ìˆìŠµë‹ˆë‹¤.</p> </div> </div> <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-10"> {books.map(book => ( <BookCover key={book.id} book={book} onClick={() => onSelectBook(book.id)} onDelete={onDeleteBook} onRename={(id, title) => onUpdateBook({ ...book, title })} onClearAutoEdit={clearAutoEdit} /> ))} <button onClick={() => setIsCreateModalOpen(true)} className="group flex flex-col items-center justify-center gap-4 aspect-[2/3] rounded-[3px] border-2 border-dashed border-slate-300 hover:border-indigo-400 hover:bg-indigo-50 transition-all dark:border-zinc-700 dark:hover:border-indigo-500 dark:hover:bg-zinc-800/50"> <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-all dark:bg-zinc-800 dark:text-zinc-500"> <IconPlus className="w-6 h-6" /> </div> <span className="text-sm font-bold text-slate-400 group-hover:text-indigo-600 dark:text-zinc-500 dark:group-hover:text-indigo-400">ìƒˆ ì‘í’ˆ ì¶”ê°€</span> </button> </div> </div> </div> </div> ); };
        const App = () => { const [view, setView] = useState('library'); const [books, setBooks] = useState(() => { const saved = localStorage.getItem('sagak_library'); return saved ? JSON.parse(saved) : []; }); const [currentBookId, setCurrentBookId] = useState(null); const [toast, setToast] = useState(null); const [isDarkMode, setIsDarkMode] = useState(() => { return localStorage.getItem('theme') === 'dark'; }); useEffect(() => { if (isDarkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } }, [isDarkMode]); const toggleDarkMode = () => setIsDarkMode(prev => !prev); useEffect(() => { localStorage.setItem('sagak_library', JSON.stringify(books)); }, [books]); const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 2000); }; const currentBook = useMemo(() => books.find(b => b.id === currentBookId), [books, currentBookId]); const handleUpdateBook = (updatedBook) => { setBooks(prev => prev.map(b => b.id === updatedBook.id ? updatedBook : b)); }; return ( <div className="font-sans text-slate-900 bg-[#f1f5f9] min-h-screen dark:bg-darkbg dark:text-zinc-200"> <AnimatePresence> {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />} </AnimatePresence> {view === 'library' && ( <Library books={books} onSelectBook={(id) => { setCurrentBookId(id); setView('workspace'); }} onCreateBook={(newBook) => setBooks([...books, newBook])} onDeleteBook={(id, e) => { e.stopPropagation(); if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setBooks(books.filter(b => b.id !== id)); }} onUpdateBook={handleUpdateBook} onImport={(imported) => { setBooks([...books, ...imported]); showToast("ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤"); }} isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} /> )} {view === 'workspace' && currentBook && ( <Workspace currentBook={currentBook} onUpdateBook={handleUpdateBook} onExit={() => setView('library')} showToast={showToast} /> )} </div> ); };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
